<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ansible☞模板"><meta name="keywords" content="ansible"><meta name="author" content="zyh"><meta name="copyright" content="zyh"><title>ansible☞模板 | zyh</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模块-template"><span class="toc-number">2.</span> <span class="toc-text">模块 template</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模板分隔符"><span class="toc-number">3.</span> <span class="toc-text">模板分隔符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#分隔符1"><span class="toc-number">3.1.</span> <span class="toc-text">分隔符1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分隔符2"><span class="toc-number">3.2.</span> <span class="toc-text">分隔符2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#条件控制语句-if"><span class="toc-number">3.2.1.</span> <span class="toc-text">条件控制语句 if</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#循环语句-for"><span class="toc-number">3.2.2.</span> <span class="toc-text">循环语句 for</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#条件和循环组合语句"><span class="toc-number">3.2.3.</span> <span class="toc-text">条件和循环组合语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#宏-macro"><span class="toc-number">3.2.4.</span> <span class="toc-text">宏 macro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#call-方法"><span class="toc-number">3.2.5.</span> <span class="toc-text">call 方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展"><span class="toc-number">4.</span> <span class="toc-text">扩展</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://spinestars.github.io/assets.github.io/niu.png"></div><div class="author-info__name text-center">zyh</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">50</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">33</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">9</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">zyh</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">ansible☞模板</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-20</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96/">自动化</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当你用ansible进行多机器的配置调整，且调整的东西都一模一样，此时你不会拒绝模板的诱惑。</p>
<p>ansible的模板是jinja2，所以jinja2的特性，在这里都可以用。</p>
<blockquote>
<p>模板中，不要出现任何你觉得模板会忽略的东西，包括但不限于空格</p>
</blockquote>
<h2 id="模块-template"><a href="#模块-template" class="headerlink" title="模块 template"></a>模块 template</h2><p>参数：</p>
<ul>
<li>src 模板文件路径</li>
<li>dest 目的文件路径</li>
</ul>
<p>牵扯到目的路径，必然有权限参数</p>
<ul>
<li>owner 目的属主</li>
<li>group 目的属组</li>
<li>mode 目的权限</li>
</ul>
<p>覆盖与备份</p>
<ul>
<li>force 覆盖，yes / no</li>
<li>backup 备份， yes / no ， 若为 yes ，则目的重名文件会先改名</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">~/test.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">~/test.info</span></span><br></pre></td></tr></table></figure>

<h2 id="模板分隔符"><a href="#模板分隔符" class="headerlink" title="模板分隔符"></a>模板分隔符</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;&#123; &#125;&#125; 一般用来填充变量，可以是过滤器，也可以填充表达式，从而返回相应的值，例如 &#123;&#123; 1==1 &#125;&#125; 返回 True</span><br><span class="line">&#123;% %&#125; 一般用来填充控制语句</span><br><span class="line">&#123;<span class="comment"># #&#125; 模板注释语句，并非渲染后会出现</span></span><br><span class="line"><span class="comment">#  ... ## 这一种 ansible 貌似不支持，所以可以忽略</span></span><br></pre></td></tr></table></figure>

<h3 id="分隔符1"><a href="#分隔符1" class="headerlink" title="分隔符1"></a>分隔符1</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#123;&#123; &#125;&#125;</span><br><span class="line">&#123;# 普通变量 #&#125;</span><br><span class="line">&#123;&#123; foo.bar &#125;&#125;</span><br><span class="line">&#123;&#123; foo[&#39;bar&#39;] &#125;&#125;</span><br><span class="line">&#123;# 以过滤器 lookup 为例 #&#125;</span><br><span class="line">&#123;&#123; lookup(&#39;file&#39;, &#39;~&#x2F;test.file&#39;) &#125;&#125;</span><br><span class="line">&#123;&#123; lookup(&#39;env&#39;, &#39;PATH&#39; )&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>最终目的文件，会输出<code>~/test.file</code> 内容和 <code>$PATH</code> 内容</p>
<blockquote>
<p>字符串拼接需要使用<code>~</code>，例如 <code>&quot;name:&quot;~name</code></p>
</blockquote>
<h3 id="分隔符2"><a href="#分隔符2" class="headerlink" title="分隔符2"></a>分隔符2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># &#123;% %&#125;</span></span><br><span class="line"><span class="comment"># 官网所有的控制列表</span></span><br><span class="line">https://jinja.palletsprojects.com/en/master/templates/<span class="comment">#list-of-control-structures</span></span><br></pre></td></tr></table></figure>

<h4 id="条件控制语句-if"><a href="#条件控制语句-if" class="headerlink" title="条件控制语句 if"></a>条件控制语句 if</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% if 条件1 %&#125;</span><br><span class="line">  pass</span><br><span class="line">&#123;% elif 条件2 %&#125;</span><br><span class="line">  pass</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">  pass </span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h4 id="循环语句-for"><a href="#循环语句-for" class="headerlink" title="循环语句 for"></a>循环语句 for</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in 可迭代对象 %&#125;</span><br><span class="line">  &#123;&#123; i &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认循环后，每一个循环单体独占一行，如果需要删除独占，则需要给第二个%}和第三个控制符{%加减号，最终变为-%}和{%-。</p>
</blockquote>
<p>关于字典类型，可以使用 iteritems() 函数，从而方便的获取到字典的 k 和 v。例如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for k,v in &#123;&#39;name&#39;:&#39;zhangsan&#39;, &#39;gender&#39;:&#39;male&#39;&#125;.iteritems() %&#125;</span><br><span class="line">  &#123;&#123; k &#125;&#125;:&#123;&#123; v &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 渲染后</span></span><br><span class="line">name:zhangsan</span><br><span class="line">gender:male</span><br></pre></td></tr></table></figure>

<h4 id="条件和循环组合语句"><a href="#条件和循环组合语句" class="headerlink" title="条件和循环组合语句"></a>条件和循环组合语句</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in 可迭代对象 if 条件 %&#125;</span><br><span class="line">  满足条件语句</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">  不满足条件语句</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>例如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in [1,2,3,4] if i&gt;2 %&#125;</span><br><span class="line">&#123;&#123; i &#125;&#125;&#39;s index is &#123;&#123; loop.index &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 渲染后</span></span><br><span class="line">3<span class="string">'s index is 1</span></span><br><span class="line"><span class="string">4'</span>s index is 2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>loop.index 是循环体索引，这里可能会有个疑问。</p>
<p>正常情况下，3和4的索引应该就是3和4，之所以是1和2，原因在于当条件控制和循环控制位于同一行的时候，先行运算的是 <code>[1,2,3,4] if i&gt;2</code>，之后才开始走<code>for</code>循环。</p>
<p>如果你想输出原始循环体，则需要将条件控制语句另起一行，放在<code>for</code>循环内部</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in [1,2,3,4] %&#125;</span><br><span class="line">&#123;% if i&gt;2 %&#125;</span><br><span class="line">&#123;&#123; i &#125;&#125;&#39;s index is &#123;&#123; loop.index &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 渲染后</span></span><br><span class="line">3<span class="string">'s index is 3</span></span><br><span class="line"><span class="string">4'</span>s index is 4</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述的 loop.index 只是jinja2的一种使用方式，其它方式具体可见官网文档</p>
<p><a href="https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures" target="_blank" rel="noopener">https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures</a></p>
</blockquote>
<h4 id="宏-macro"><a href="#宏-macro" class="headerlink" title="宏 macro"></a>宏 macro</h4><p>宏就是类似于函数的一个东西。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;# 编写宏 #&#125;</span><br><span class="line">&#123;% macro func() %&#125;</span><br><span class="line">函数体</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;# 调用宏 #&#125;</span><br><span class="line">&#123;&#123; func() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% macro func(a,b,c&#x3D;3,d&#x3D;4) %&#125;</span><br><span class="line">&#123;# 宏编写的时候，宏参数，要遵循默认参数在后</span><br><span class="line">&#123;&#123; a &#125;&#125;</span><br><span class="line">&#123;&#123; b &#125;&#125;</span><br><span class="line">&#123;&#123; c &#125;&#125;</span><br><span class="line">&#123;&#123; d &#125;&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;&#123; func(1,2,5) &#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 渲染后</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">5</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当给出参数超出了宏所定义的参数时，根据情况，宏会将多余的参数存在变量中，即：</p>
<p>超出的为非关键字参数，则存放在一个叫<code>varargs</code>的元组中</p>
<p>超出的为关键字参数，则存放在一个叫<code>kwargs</code>的字典中</p>
</blockquote>
<h4 id="call-方法"><a href="#call-方法" class="headerlink" title="call 方法"></a>call 方法</h4><p>如同当前函数的装饰器，可以扩展当前宏的功能</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;# 编写宏 func，并调用 caller #&#125;</span><br><span class="line">&#123;% macro func(a) %&#125;</span><br><span class="line">我有一个&#123;&#123; a &#125;&#125;。</span><br><span class="line">&#123;&#123; caller(a) &#125;&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;# 编写宏 func_ext #&#125;</span><br><span class="line">&#123;% macro func_ext(a,b) %&#125;</span><br><span class="line">但&#123;&#123; b &#125;&#125;比&#123;&#123; a &#125;&#125;好吃。</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;# 通过 call 关联 func，加载 func_ext #&#125;</span><br><span class="line">&#123;% call(a) func(&#39;汉堡&#39;) %&#125;</span><br><span class="line">&#123;&#123; func_ext(a,&#39;三明治&#39;) &#125;&#125;</span><br><span class="line">&#123;% endcall %&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>caller是call的对象，因此caller也是可以给call传参</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 渲染后</span></span><br><span class="line">我有一个汉堡。</span><br><span class="line">但三明治比汉堡好吃</span><br></pre></td></tr></table></figure>

<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><blockquote>
<p> 扩展官方文档，可见 <a href="https://jinja.palletsprojects.com/en/master/extensions/" target="_blank" rel="noopener">https://jinja.palletsprojects.com/en/master/extensions/</a></p>
</blockquote>
<p>这里我只简单的说一下如何启动 <code>for</code> 循环中的 <code>break</code> 和 <code>continue</code>。</p>
<p><code>ansible</code> 中添加 <code>jinja2</code> 扩展，需要修改主配置文件 <code>/etc/ansible/ansible.cfg</code>，找到 <code>jinja2_extensions</code>，在后面追加扩展配置即可，每一个扩展用逗号<code>,</code>分割。</p>
<p><code>break</code>和<code>continue</code> 的扩展名叫：<code>jinja2.ext.loopcontrols</code></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zyh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zyh.cool/2020/05/20/ansible%E2%98%9E%E6%A8%A1%E6%9D%BF/">https://zyh.cool/2020/05/20/ansible%E2%98%9E%E6%A8%A1%E6%9D%BF/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zyh.cool">zyh</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ansible/">ansible</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5ebcbd4086e8aa2b" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/05/21/ansible%E2%98%9E%E8%A7%92%E8%89%B2/"><i class="fa fa-chevron-left">  </i><span>ansible☞角色</span></a></div><div class="next-post pull-right"><a href="/2020/05/18/ansible%E2%98%9Eplaybook-lookup%E6%8F%92%E4%BB%B6/"><span>ansible☞playbook-lookup插件</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '5d6fb59b1508af7318d7',
  clientSecret: 'bca058cc7e0b4b62ce5d43b046bb18d9484e5163',
  repo: 'zyh.github.io',
  owner: 'Spinestars',
  admin: 'Spinestars',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By zyh</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to <a href="https://zyh.cool">zyh.cool</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>