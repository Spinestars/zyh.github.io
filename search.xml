<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>pgsql-åŸºç¡€å‘½ä»¤</title>
      <link href="posts/684ab210/"/>
      <url>posts/684ab210/</url>
      
        <content type="html"><![CDATA[<h1>æˆæƒå‘½ä»¤</h1><pre><code class="language-bash"># æˆæƒåªè¯»grant select on all tables in schema &lt;schema_name&gt; to &lt;username&gt;;grant usage on schema &lt;schema_name&gt; to &lt;username&gt;;alter default privileges in schema &lt;schema_name&gt; grant select on tables to &lt;username&gt;;# æˆæƒè¯»å†™grant all on all tables in schema &lt;schema_name&gt; to &lt;username&gt;;grant all on schema &lt;schema_name&gt; to &lt;username&gt;;alter default privileges in schema &lt;schema_name&gt; grant all on tables to &lt;username&gt;;</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> pgsql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pgsql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œ-SNATå’ŒDNAT[è½¬]</title>
      <link href="posts/40d986c3/"/>
      <url>posts/40d986c3/</url>
      
        <content type="html"><![CDATA[<p>DNATï¼ˆDestination Network Address Translation,ç›®çš„åœ°å€è½¬æ¢) é€šå¸¸è¢«å«åšç›®çš„æ˜ è°¢ã€‚</p><p>è€ŒSNATï¼ˆSource Network Address Translationï¼Œæºåœ°å€è½¬æ¢ï¼‰é€šå¸¸è¢«å«åšæºæ˜ è°¢ã€‚</p><p>è¿™æ˜¯æˆ‘ä»¬åœ¨è®¾ç½®Linuxç½‘å…³æˆ–è€…é˜²ç«å¢™æ—¶ç»å¸¸è¦ç”¨æ¥çš„ä¸¤ç§æ–¹å¼ã€‚</p><h1>IPåŒ…çš„ç»“æ„</h1><p><img src="/posts/40d986c3/image-20211226154016611.png" alt="image-20211226154016611"></p><p>åœ¨ä»»ä½•ä¸€ä¸ªIPæ•°æ®åŒ…ä¸­ï¼Œéƒ½ä¼šæœ‰Source IP Addressä¸Destination IP Addressè¿™ä¸¤ä¸ªå­—æ®µï¼Œæ•°æ®åŒ…æ‰€ç»è¿‡çš„è·¯ç”±å™¨ä¹Ÿæ˜¯æ ¹æ®è¿™ä¸¤ä¸ªå­—æ®µæ˜¯åˆ¤å®šæ•°æ®åŒ…æ˜¯ç”±ä»€ä¹ˆåœ°æ–¹å‘è¿‡æ¥çš„ï¼Œå®ƒè¦å°†æ•°æ®åŒ…å‘åˆ°ä»€ä¹ˆåœ°æ–¹å»ã€‚è€Œiptablesçš„DNATä¸SNATå°±æ˜¯æ ¹æ®è¿™ä¸ªåŸç†ï¼Œå¯¹Source IP Addressä¸Destination IP Addressè¿›è¡Œä¿®æ”¹ã€‚</p><h1>iptablesæ•°æ®æµ</h1><p><img src="/posts/40d986c3/image-20211226154032075.png" alt="image-20211226154032075"></p><p>æ­£è±å½¢çš„åŒºåŸŸæ˜¯å¯¹æ•°æ®åŒ…è¿›è¡Œåˆ¤å®šè½¬å‘çš„åœ°æ–¹ã€‚åœ¨è¿™é‡Œï¼Œç³»ç»Ÿä¼šæ ¹æ®IPæ•°æ®åŒ…ä¸­çš„DIPå¯¹æ•°æ®åŒ…è¿›è¡Œåˆ†å‘ã€‚å¦‚æœdestination ip adressæ˜¯æœ¬æœºåœ°å€ï¼Œæ•°æ®å°†ä¼šè¢«è½¬äº¤ç»™INPUTé“¾ã€‚å¦‚æœä¸æ˜¯æœ¬æœºåœ°å€ï¼Œåˆ™äº¤ç»™FORWARDé“¾æ£€æµ‹ã€‚</p><p>âœ¨ã€DNATã€‘æ˜¯åœ¨ã€PREROUTINGé“¾ã€‘ä¸­è¿›è¡Œã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬è¦æŠŠè®¿é—®202.103.96.112çš„è®¿é—®è½¬å‘åˆ°192.168.0.112ä¸Šï¼š</p><pre><code class="language-bash">iptables -t nat -A PREROUTING -d 202.103.96.112 -j DNAT --to-destination 192.168.0.112</code></pre><p>å…¶å®å°±æ˜¯å°†å·²ç»è¾¾åˆ°è¿™å°Linuxç½‘å…³ä¸Šçš„æ•°æ®åŒ…ä¸Šçš„ DIPï¼š202.103.96.112 ä¿®æ”¹ä¸º SERVER_IPï¼š192.168.0.112 ç„¶åäº¤ç»™ç³»ç»Ÿè·¯ç”±è¿›è¡Œè½¬å‘ã€‚</p><p>âœ¨ã€SNATã€‘æ˜¯åœ¨ã€POSTROUTINGé“¾ã€‘ä¸­è¿›è¡Œã€‚</p><pre><code class="language-bash">iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT --to-source 58.20.51.66</code></pre><p>è¿™ä¸ªè¯­å¥å°±æ˜¯å‘Šè¯‰ç³»ç»ŸæŠŠå³å°†è¦æµå‡ºæœ¬æœºçš„æ•°æ®çš„SIPä¿®æ”¹æˆä¸º58.20.51.66ã€‚è¿™æ ·ï¼Œæ•°æ®åŒ…åœ¨è¾¾åˆ°ç›®çš„æœºå™¨ä»¥åï¼Œç›®çš„æœºå™¨ä¼šå°†åŒ…è¿”å›åˆ°58.20.51.66ä¹Ÿå°±æ˜¯æœ¬æœºã€‚å¦‚æœä¸åšè¿™ä¸ªæ“ä½œï¼Œé‚£ä¹ˆä½ çš„æ•°æ®åŒ…åœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­ï¼Œreplyçš„åŒ…è‚¯å®šä¼šä¸¢å¤±ã€‚</p><p>æ³¨æ„ï¼ŒDNAT targetåªèƒ½ç”¨åœ¨natè¡¨çš„PREOUTING å’Œ OUTPUT é“¾ä¸­ï¼Œæˆ–è€…æ˜¯è¢«è¿™ä¸¤æ¡é“¾è°ƒç”¨çš„é“¾é‡Œã€‚ä½†è¿˜è¦æ³¨æ„çš„æ˜¯ï¼ŒåŒ…å«DNAT targetçš„è¿ä¸èƒ½è¢«é™¤æ­¤ä¹‹å¤–çš„å…¶ä»–é“¾è°ƒç”¨ï¼Œå¦‚POSTROUTINGã€‚</p><pre><code class="language-bash">iptables -t nat -A PREROUTING -p tcp -d 15.45.23.67 --dport 80 -j DNAT --to-destination 192.168.1.1-192.168.1.10</code></pre><p>ExplanationæŒ‡å®šè¦å†™å…¥IPå¤´çš„åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯åŒ…è¦è¢«è½¬å‘åˆ°çš„åœ°æ–¹ã€‚ä¸Šé¢çš„ä¾‹å­å°±æ˜¯æŠŠæ‰€æœ‰å‘å¾€åœ°å€15.45.23.67çš„åŒ…éƒ½è½¬å‘åˆ°ä¸€æ®µLANä½¿ç”¨çš„ç§æœ‰åœ°å€ä¸­ï¼Œå³192.168.1.1åˆ°192.168.1.10ã€‚å¦‚å‰æ‰€è¿°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæµéƒ½ä¼šè¢«éšæœºåˆ†é…ä¸€ä¸ªè¦è½¬å‘åˆ°çš„åœ°å€ï¼Œä½†åŒä¸€ä¸ªæµæ€»æ˜¯ä½¿ç”¨åŒä¸€ä¸ªåœ°å€ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åªæŒ‡å®šä¸€ä¸ªIPåœ°å€ä½œä¸ºå‚æ•°ï¼Œè¿™æ ·æ‰€æœ‰åŒ…éƒ½è¢«è½¬å‘åˆ°åŒä¸€å°æœºå­ã€‚æˆ‘ä»¬è¿˜å¯ä»¥åœ¨åœ°å€åæŒ‡å®šä¸€ä¸ªæˆ–ä¸€ä¸ªèŒƒå›´çš„ç«¯å£ã€‚æ¯”å¦‚ï¼šâ€“to-destination 192.168.1.1:80æˆ–192.168.1.1:80-100ã€‚SNATçš„è¯­æ³•å’Œè¿™ä¸ªtargetçš„ä¸€æ ·ï¼Œåªæ˜¯ç›®çš„ä¸åŒç½¢äº†ã€‚è¦æ³¨æ„ï¼Œåªæœ‰å…ˆç”¨â€“protocolæŒ‡å®šäº†TCPæˆ–UDPåè®®ï¼Œæ‰èƒ½ä½¿ç”¨ç«¯å£ã€‚</p><h1>DNATçš„åº”ç”¨ï¼šç½‘ç«™å‘å¸ƒ</h1><p>é˜²ç«å¢™ï¼š</p><ul><li><p>å¯¹å¤–çš„IPï¼š$GW_WAN_IPã€‚</p></li><li><p>å†…ç½‘çš„IPï¼š$GW_LAN_IPã€‚</p></li></ul><p>WEBæœåŠ¡å™¨ï¼š</p><ul><li>å†…ç½‘çš„IPï¼š$HTTP_LAN_IP</li></ul><p>NATè¡¨çš„PREROUTINGé“¾ä¸­æ·»åŠ DNATè§„åˆ™ï¼š</p><pre><code class="language-bash">iptables -t nat -A PREROUTING --dst$GW_INET_IP -p tcp --dport 80 -j DNAT / --to-destination $HTTP_LAN_IP</code></pre><p>ä»¥ä¸Šè§„åˆ™å¯ä»¥æ»¡è¶³ï¼Œå¤–ç½‘å®¢æˆ·ç«¯é€šè¿‡$GW_WAN_IPè®¿é—®å†…ç½‘WEBæœåŠ¡å™¨ï¼Œä½†å†…ç½‘å®¢æˆ·ç«¯æ— æ³•é€šè¿‡$GW_WAN_IPè®¿é—®WEBæœåŠ¡å™¨ã€‚</p><h1>å¤–ç½‘å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡$GW_WAN_IPè®¿é—®çš„åŸå› </h1><p>å¤–ç½‘ä¸Šè®¿é—®æˆ‘ä»¬æœåŠ¡å™¨çš„é‚£å°æœºå­çš„IPåœ°å€è®°ä¸º$EXT_CLIENTï¼š</p><ol><li><p>åŒ…ä»åœ°å€ä¸º$EXT_CLIENTçš„æœºå­å‡ºå‘ï¼Œå»å¾€åœ°å€ä¸º$GW_WAN_IPçš„æœºå­ã€‚</p></li><li><p>åŒ…åˆ°è¾¾é˜²ç«å¢™ã€‚é˜²ç«å¢™DNATï¼ˆä¹Ÿå°±æ˜¯è½¬å‘ï¼‰è¿™ä¸ªåŒ…ï¼Œè€Œä¸”åŒ…ä¼šç»è¿‡å¾ˆå¤šå…¶ä»–çš„é“¾æ£€éªŒåŠå¤„ç†ã€‚</p></li><li><p>åŒ…ç¦»å¼€é˜²ç«å¢™å‘$HTTP_LAN_IPå‰è¿›ã€‚åŒ…åˆ°è¾¾HTTPæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å°±ä¼šé€šè¿‡é˜²ç«å¢™ç»™ä»¥å›åº”ï¼Œå½“ç„¶ï¼Œè¿™è¦æ±‚æŠŠé˜²ç«å¢™ä½œä¸ºHTTPåˆ°è¾¾$EXT_CLIENTçš„ç½‘å…³ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé˜²ç«å¢™å°±æ˜¯HTTPæœåŠ¡å™¨çš„ç¼ºçœç½‘å…³ã€‚</p></li><li><p>é˜²ç«å¢™å†å¯¹è¿”å›åŒ…åšUn-DNATï¼ˆå°±æ˜¯ç…§ç€DNATçš„æ­¥éª¤åè¿‡æ¥åšä¸€éï¼‰ï¼Œè¿™æ ·å°±å¥½åƒæ˜¯é˜²ç«å¢™è‡ªå·±å›å¤äº†é‚£ä¸ªæ¥è‡ªå¤–ç½‘çš„è¯·æ±‚åŒ…ã€‚è¿”å›åŒ…å›åˆ°$EXT_CLIENTã€‚</p></li></ol><h1>å†…ç½‘å®¢æˆ·ç«¯æ— æ³•é€šè¿‡$GW_WAN_IPè®¿é—®çš„åŸå› </h1><p>å‡è®¾å®¢æˆ·æœºçš„IPä¸º$LAN_CLIENTï¼Œå…¶ä»–è®¾ç½®åŒä¸Šï¼š</p><ol><li><p>åŒ…ç¦»å¼€$LAN_CLIENTï¼Œå»å¾€$GW_WAN_IPã€‚</p></li><li><p>åŒ…åˆ°è¾¾é˜²ç«å¢™ã€‚åŒ…è¢«DNATï¼Œè€Œä¸”è¿˜ä¼šç»è¿‡å…¶ä»–çš„å¤„ç†ã€‚æ­¤æ—¶æ•°æ®åŒ…SIPæ˜¯ï¼š$LAN_CLIENTï¼ŒDIPæ˜¯ï¼š$HTTP_LAN_IP</p></li><li><p>åŒ…ç¦»å¼€é˜²ç«å¢™ï¼Œåˆ°è¾¾HTTPæœåŠ¡å™¨ã€‚HTTPæœåŠ¡å™¨è¯•å›¾å›å¤è¿™ä¸ªåŒ…ï¼Œå®ƒåœ¨çœ‹åˆ°åŒ…æ˜¯æ¥è‡ªåŒä¸€ä¸ªç½‘ç»œçš„ä¸€å°æœºå­ï¼Œå› æ­¤å®ƒä¼šæŠŠå›å¤åŒ…ç›´æ¥å‘é€åˆ°$LAN_CLIENTã€‚æ­¤æ—¶å›å¤åŒ…SIPæ˜¯ï¼š$GW_WAN_IPï¼ŒDIPæ˜¯ï¼š$HTTP_LAN_IP</p></li><li><p>å›å¤åŒ…åˆ°è¾¾å®¢æˆ·æœºï¼Œä½†å®¢æˆ·ç«¯å‘ç°æ¢å¤åŒ…çš„SIPä¸æ˜¯å½“åˆè¯·æ±‚çš„$GW_WAN_IPã€‚è¿™æ ·ï¼Œå®ƒå°±ä¼šæŠŠè¿™ä¸ªåŒ…æ‰”æ‰è€Œå»ç­‰å¾…â€œçœŸæ­£â€çš„å›å¤åŒ…ã€‚</p></li></ol><h1>å†…ç½‘å®¢æˆ·ç«¯æ— æ³•é€šè¿‡$GW_WAN_IPè®¿é—®çš„è§£å†³åŠæ³•</h1><h2 id="é’ˆå¯¹è¯·æ±‚åŒ…æ·»åŠ SNATè§„åˆ™">é’ˆå¯¹è¯·æ±‚åŒ…æ·»åŠ SNATè§„åˆ™</h2><pre><code class="language-bash">iptables -t -nat -A POSTROUTING -p tcp --dst$HTTP_LAN_IP --dport 80 -j SNAT / --to-source $GW_LAN_IP</code></pre><p>âœ¨æŒ‰è¿è¡Œçš„é¡ºåºPOSTROUTINGé“¾æ˜¯æ‰€æœ‰é“¾ä¸­æœ€åä¸€ä¸ªï¼Œå› æ­¤åŒ…åˆ°è¾¾è¿™æ¡é“¾æ—¶ï¼Œå·²ç»è¢«åšè¿‡DNATæ“ä½œäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è§„åˆ™é‡Œè¦åŸºäºå†…ç½‘çš„åœ°å€$HTTP_LAN_IPï¼ˆåŒ…çš„ç›®çš„åœ°ï¼‰æ¥åŒ¹é…åŒ…ã€‚</p><p>â˜£ è¿™ç§æ–¹å¼ï¼Œä¼šå¯¼è‡´WEBæœåŠ¡å™¨çš„è¯·æ±‚æ—¥å¿—çš„æºIPéƒ½æ˜¯$GW_LAN_IPã€‚å› ä¸ºæ¥è‡ªInternetåŒ…åœ¨é˜²ç«å¢™å†…å…ˆåç»è¿‡äº†DNATå’ŒSNATå¤„ç†ï¼Œæ‰èƒ½åˆ°è¾¾HTTPæœåŠ¡å™¨ï¼Œæ‰€ä»¥HTTPæœåŠ¡å™¨å°±è®¤ä¸ºåŒ…æ˜¯é˜²ç«å¢™å‘æ¥çš„ï¼Œè€Œä¸çŸ¥é“çœŸæ­£çš„æºå¤´æ˜¯å…¶ä»–çš„IPã€‚</p><h2 id="DNSæœåŠ¡">DNSæœåŠ¡</h2><p>é€šè¿‡å•ç‹¬çš„DNSæœåŠ¡å™¨ï¼Œå†…ç½‘å®¢æˆ·ä½¿ç”¨ç½‘ç«™åŸŸåè®¿é—®HTTPæœåŠ¡å™¨æ—¶ï¼ŒDNSå°†åŸŸåè§£ææˆå†…ç½‘åœ°å€ã€‚å®¢æˆ·æœºå°±å¯ä»¥ç›´æ¥å»è®¿é—®HTTPæœåŠ¡å™¨çš„å†…ç½‘åœ°å€äº†ï¼Œä»è€Œé¿å…äº†é€šè¿‡é˜²ç«å¢™çš„æ“ä½œã€‚</p><h2 id="DMZåŒºåŸŸ">DMZåŒºåŸŸ</h2><p>é€šè¿‡æ„å»ºDMZåŒºåŸŸï¼Œå°†WEBæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å†…ç½‘è¿›è¡Œåˆ†ç¦»ã€‚</p><h1>é˜²ç«å¢™é€šè¿‡$GW_WAN_IPè®¿é—®</h1><p>ä»é˜²ç«å¢™å‘å‡ºçš„è¯·æ±‚åŒ…ä¸ä¼šç»è¿‡PREROUTINGå’ŒPOSTROUTINGï¼Œè€Œæ˜¯ç»è¿‡OUTPUTã€‚ æˆ‘ä»¬è¦åœ¨natè¡¨çš„OUTPUTé“¾ä¸­æ·»åŠ ä¸‹é¢çš„è§„åˆ™ï¼š</p><pre><code class="language-bash">iptables -t nat -A OUTPUT --dst $GW_INET_IP -p tcp --dport 80 -j DNAT / --to-destination $HTTP_LAN_IP</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go-013æ–‡ä»¶å…ˆè¯»å†è¦†ç›–å†™</title>
      <link href="posts/38c126f9/"/>
      <url>posts/38c126f9/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¶‰åŠæ¨¡å—">æ¶‰åŠæ¨¡å—</h2><ul><li>os</li><li>fmt</li><li>io/ioutil</li></ul><h2 id="ä»£ç ">ä»£ç </h2><pre><code class="language-go">package mainimport (    &quot;fmt&quot;    &quot;os&quot;    &quot;io/ioutil&quot;)func main()&#123;    filePath := &quot;/home/zyh/test&quot;    if fd, err := os.OpenFile(filePath, os.O_RDWR|os.O_CREATE, 0644); err != nil &#123;        fmt.Printf(&quot;æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼š%s\n&quot;,filePath)    &#125; else &#123;        fdbyte, _ := ioutil.ReadAll(fd)        fmt.Printf(&quot;åŸå§‹å†…å®¹ï¼š%s\n&quot;, fdbyte)        fd.Truncate(0)        fd.Seek(0,0)        fd.WriteString(&quot;456!&quot;)        fd.Close()    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shellâ˜readåµŒå¥—</title>
      <link href="posts/b06f599c/"/>
      <url>posts/b06f599c/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>ä»Šå¤©ç¢°åˆ°ä¸€ä¸ªç¾¤å‹å’¨è¯¢ä¸€ä¸ªé—®é¢˜ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-bash">cat xxx | while read line;do    read -p &quot;y|n:&quot; yn    echo $yn    echo $linedone</code></pre><p>ä»–çš„ç›®æ ‡é¢„æœŸæ˜¯ï¼Œå¾ªç¯ä½“é‡Œçš„<code>read</code>å¯ä»¥æ¥æ”¶æ¥è‡ªé”®ç›˜çš„è¾“å…¥ã€‚</p><p>ä½†æ˜¯ï¼Œå®é™…æƒ…å†µæ˜¯ï¼Œå¾ªç¯ä½“é‡Œçš„<code>read</code>è‡ªåŠ¨æ¥æ”¶äº†<code>xxx</code>çš„æ•°æ®ã€‚</p><h1>åŸå› </h1><p><code>read</code>é»˜è®¤æ˜¯ä»æ ‡å‡†è¾“å…¥é‡Œæ¥æ”¶æ•°æ®ï¼Œå› æ­¤ä¸¤ä¸ª<code>read</code>å‡é‡‡ç”¨äº†é»˜è®¤è¡Œä¸ºã€‚</p><h1>è§£å†³</h1><p>ä¿®æ”¹å¾ªç¯ä½“å¤–<code>read</code>çš„é»˜è®¤è¾“å…¥æºï¼Œå˜æ›´ä¸ºå…¶å®ƒæ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-bash">while read -u 6 line;do    read -p &quot;y|n:&quot; yn    echo $yn    echo $linedone 6&lt;xxx </code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows-wslé—®é¢˜ç‚¹</title>
      <link href="posts/348cba53/"/>
      <url>posts/348cba53/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>è®°å½• wsl ä½¿ç”¨æœŸé—´é‡åˆ°çš„é—®é¢˜</p><h1>åˆ—è¡¨</h1><h2 id="1-å‘è¡Œç‰ˆå®‰è£…ä¹‹åï¼Œwslæ— æ³•å¯åŠ¨">1. å‘è¡Œç‰ˆå®‰è£…ä¹‹åï¼Œwslæ— æ³•å¯åŠ¨</h2><p>éœ€å‡çº§wslã€‚</p><pre><code class="language-powershell">wsl --update</code></pre><h2 id="2-wslé‡Œæ— æ³•æ­£å¸¸è§£æ">2. wslé‡Œæ— æ³•æ­£å¸¸è§£æ</h2><p>wslçš„ubuntuç³»ç»Ÿä¸­ï¼Œé»˜è®¤<code>/etc/resolv.conf</code>é€šè¿‡<code>/etc/wsl.conf</code>æ§åˆ¶ï¼Œå…¶wslçš„ç³»ç»Ÿé€šè¿‡windowsçš„dnsæ¥è§£æ</p><p>å¦‚æœä½ å‘ç°ç”Ÿæˆæ­£å¸¸ï¼Œä½†æ˜¯å°±æ˜¯æ— æ³•è§£æï¼Œå°è¯•åœ¨windowsä¸­é‡ç½®ä¸€ä¸‹ç½‘ç»œ</p><pre><code class="language-powershell">netsh winsock resetnetsh int ip reset allnetsh winhttp reset proxyipconfig /flushdns</code></pre><p>ä¸Šè¿°æ“ä½œå®Œæ¯•åï¼Œé‡å¯windowsç³»ç»Ÿã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows </tag>
            
            <tag> wsl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜location</title>
      <link href="posts/4c513678/"/>
      <url>posts/4c513678/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å¼€å‘æœ‰ä¸ªå°éœ€æ±‚ï¼Œå› æ­¤éœ€è¦æ·»åŠ ä¸€ä¸ªé¢å¤–çš„location</p><pre><code class="language-bash">location /game_log/v1/  ##æ–°åŠ çš„é¢å¤–locationlocation ~* /v1/(.*)</code></pre><p>é…ç½®å®Œåï¼Œå‘ç°ä¸ç”Ÿæ•ˆï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°åŒ¹é…åˆ°äº†ç¬¬äºŒä¸ªlocationã€‚</p><h2 id="locationå†™æ³•">locationå†™æ³•</h2><p>ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åºï¼š</p><p>location =  /path  ç²¾ç¡®åŒ¹é…<code>/path</code></p><p>location ^~ /path  åŒ¹é…<code>/path</code>å¼€å¤´çš„</p><p>location ~  /path  åŒ¹é…æ­£åˆ™<code>/path</code>ï¼ŒåŒºåˆ†å¤§å°å†™</p><p>location ~* /path  åŒ¹é…æ­£åˆ™<code>/path</code>ï¼Œä¸åŒºåˆ†å¤§å°å†™</p><p>location    /path  åŒ¹é…<code>/path</code>å¼€å¤´çš„</p><p>location    /      åŒ¹é…æ‰€æœ‰</p><h2 id="åŸå› ">åŸå› </h2><ol><li>ä¼˜å…ˆçº§</li></ol><p>å› ä¸º <code>~*</code>ä¼˜å…ˆçº§å¤§äº<code>ç©º</code>ï¼Œå› æ­¤å…ˆåŒ¹é… <code>location ~* /v1/(.*)</code></p><ol start="2"><li>æ­£åˆ™</li></ol><p><code>/v1/(.*)</code> å¹¶ä¸æ˜¯åŒ¹é…ä»¥<code>/v1/</code>å¼€å¤´çš„ï¼Œè€Œæ˜¯åªè¦åŒ…å«<code>/v1/</code>å³å¯åŒ¹é…</p><p>å› <code>/game_log/v1/</code>åŒ…å«<code>v1</code>ï¼Œæ‰€ä»¥è¢« <code>location ~* /v1/(.*)</code>æ•è·</p><h2 id="è§£å†³">è§£å†³</h2><p>æ–¹æ³•1:</p><p>å°†<code>location /game_log/v1/</code>æ”¹ä¸º<code>location ^~ /game_log/v1/</code></p><p>æ–¹æ³•2:</p><p>å°†<code>location ~* /v1/(.*)</code>æ”¹ä¸º<code>location ~* ^/v1/(.*)</code></p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜20ç½‘ç»œcni</title>
      <link href="posts/68c615a7/"/>
      <url>posts/68c615a7/</url>
      
        <content type="html"><![CDATA[<h1>IP</h1><p>kubernetes ä¸­çš„ ip ä»¥ pod ä¸ºå•ä½åˆ†é…ï¼Œä¸€ä¸ª pod å†…éƒ¨æ‰€æœ‰çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€‚</p><h1>CNI</h1><p>cni æä¾›äº†å®¹å™¨çš„æ’ä»¶åŒ–ç½‘ç»œæ–¹æ¡ˆï¼Œå³å®šä¹‰å®¹å™¨ç½‘ç»œæ“ä½œå’Œé…ç½®çš„è§„èŒƒï¼Œå¹¶é€šè¿‡æ’ä»¶å®ç°è§„èŒƒã€‚</p><p>cni è‡ªèº«ä»…å…³æ³¨å®¹å™¨å’Œç½‘ç»œå¯¹è±¡ã€‚å½“å®¹å™¨åˆ›å»ºçš„æ—¶å€™ï¼Œcniå°±ä¼šåˆ›å»ºç½‘ç»œï¼Œå½“å®¹å™¨é”€æ¯çš„æ—¶å€™ï¼Œcniå°±ä¼šåˆ é™¤ç½‘ç»œã€‚</p><p>cni æ’ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li>cniæ’ä»¶ï¼šè´Ÿè´£é…ç½®ç½‘ç»œ</li><li>ipamæ’ä»¶ï¼šè´Ÿè´£åˆ†é…IPåœ°å€</li></ul><h1>ç½‘ç»œç­–ç•¥</h1><p>network policy å¯ä»¥å¯¹ pod é—´çš„ç½‘ç»œé€šä¿¡è¿›è¡Œé™åˆ¶ä»¥åŠå‡†å…¥æ§åˆ¶ï¼Œä»è€Œæ§åˆ¶å¯ä»¥è®¿é—® pod çš„å®¢æˆ·ç«¯ã€‚</p><p>network controller é€šè¿‡ cni æ’ä»¶å®ç°ç”¨æˆ·å®šä¹‰çš„ network policyã€‚</p><h1>å¾…ç»­</h1>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜19æ—¥å¿—ç³»ç»ŸEFK</title>
      <link href="posts/ce23a4a1/"/>
      <url>posts/ce23a4a1/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch#running-efk-stack-in-production">kubernetes/cluster/addons/fluentd-elasticsearch at master Â· kubernetes/kubernetes (github.com)</a></p><p>EFKåŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼š</p><ol><li>fluentd é‡‡é›†å™¨ã€‚é‡‡é›†æ—¥å¿—</li><li>elasticsearch æœç´¢å¼•æ“ã€‚å¤„ç†æ—¥å¿—</li><li>kibana å±•ç¤ºã€‚å±•ç¤ºæ—¥å¿—</li></ol><h2 id="æ•°æ®è¿‡ç¨‹">æ•°æ®è¿‡ç¨‹:</h2><p>Podæ—¥å¿— â˜ fluentd â˜ Elasticsearch â˜ Kibana</p><h2 id="ç»“æ„">ç»“æ„</h2><p>é›†ç¾¤æ¨¡å¼ï¼ŒèŠ‚ç‚¹çº§æ”¶é›†å™¨æ”¶é›†æ—¥å¿—ã€‚</p><p>å…¶ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/posts/ce23a4a1/image-20210813111558385.png" alt="image-20210813111558385"></p><h2 id="å®‰è£…æ­¥éª¤">å®‰è£…æ­¥éª¤</h2><p>æˆ‘ä»¬é€šè¿‡ helm åŒ…ç®¡ç†å™¨è¿›è¡Œå®‰è£…ã€‚å…¶åœ°å€ä¸ºï¼š<a href="https://artifacthub.io/">Artifact Hub</a></p><p>âš ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œelasticsearchå’Œkibanaç‰ˆæœ¬è¦ä¿æŒä¸€è‡´</p><h3 id="elasticsearch">elasticsearch</h3><p><a href="https://artifacthub.io/packages/helm/elastic/elasticsearch">https://artifacthub.io/packages/helm/elastic/elasticsearch</a></p><p>ä¸‹è½½chartåŒ…åˆ°æœ¬åœ°ï¼Œå¹¶è§£å‹</p><pre><code class="language-bash">mkdir kube-efk &amp;&amp; cd kube-efkhelm repo add elastic https://helm.elastic.cohelm fetch elastic/elasticsearchtar xf elasticsearch*.tgz &amp;&amp; cd elasticsearch</code></pre><p>ç¼–è¾‘ values.yamlï¼Œè‡ªå®šä¹‰é…ç½®</p><p><a href="https://artifacthub.io/packages/helm/elastic/elasticsearch#configuration">https://artifacthub.io/packages/helm/elastic/elasticsearch#configuration</a></p><ul><li>ç¡®è®¤è¦å®‰è£…çš„åº”ç”¨è§’è‰²ï¼Œé»˜è®¤å¼€å¯äº†ä¸‹åˆ—è§’è‰²</li></ul><blockquote><p>å…³äºè§’è‰²çš„ä»‹ç»ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles">Node | Elasticsearch Guide | Elastic</a></p></blockquote><pre><code class="language-yaml">roles:  master: &quot;true&quot;  ingest: &quot;true&quot;  data: &quot;true&quot;  remote_cluster_client: &quot;true&quot;</code></pre><ul><li>æ·»åŠ å­˜å‚¨ç±»ï¼Œæ„å»ºæ°¸ä¹…æ€§å­˜å‚¨</li></ul><pre><code class="language-yaml">volumeClaimTemplate:  storageClassName: nfs-client  accessModes: [&quot;ReadWriteOnce&quot;]  resources:    requests:      storage: 30Gipersistence:  enabled: true</code></pre><ul><li>æ·»åŠ æ±¡ç‚¹å®¹å¿ï¼Œå…è®¸è°ƒåº¦åˆ°masterèŠ‚ç‚¹ä¸Šã€‚</li></ul><blockquote><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½ ä¸åº”è¯¥è®©å…¶è°ƒåº¦åˆ°masterèŠ‚ç‚¹ä¸Šã€‚</p></blockquote><pre><code class="language-yaml">tolerations:  - key: &quot;role.kubernetes.io/master&quot;    operator: &quot;Exists&quot;    effect: &quot;NoSchedule&quot;</code></pre><ul><li>ingress</li></ul><p>é»˜è®¤æ˜¯å…³é—­çŠ¶æ€ã€‚</p><ul><li>è°ƒæ•´jvmå’ŒPodèµ„æºé™åˆ¶</li></ul><pre><code class="language-yaml">esJavaOpts: &quot;&quot; # example: &quot;-Xmx1g -Xms1g&quot;resources:  requests:    cpu: &quot;1000m&quot;    memory: &quot;2Gi&quot;  limits:    cpu: &quot;1000m&quot;    memory: &quot;2Gi&quot;</code></pre><ul><li>å¼€å§‹å®‰è£…</li></ul><pre><code class="language-bash">kubectl create ns efkhelm install elasticsearch elastic/elasticsearch --version 7.16.2 --namespace efk -f values.yaml</code></pre><h3 id="fluentd-elasticsearch"><a href="https://artifacthub.io/packages/helm/kokuwa/fluentd-elasticsearch">fluentd-elasticsearch</a></h3><p>ä¸‹è½½chartåŒ…åˆ°æœ¬åœ°ï¼Œå¹¶è§£å‹</p><pre><code class="language-bash">cd kube-efkhelm repo add kokuwa https://kokuwaio.github.io/helm-chartshelm fatch kokuwa/fluentd-elasticsearchtar xf fluentd-elasticsearch*.tgz &amp;&amp; cd fluentd-elasticsearch</code></pre><p>ç¼–è¾‘ values.yamlï¼Œè‡ªå®šä¹‰é…ç½®</p><p>ä¿®æ”¹å®¹å™¨çš„æ•°æ®ç›®å½•ï¼ˆå¦‚æœä½ ä¸æ˜¯é»˜è®¤è·¯å¾„çš„è¯ï¼‰</p><pre><code class="language-yaml">hostLogDir:  varLog: /var/log  #dockerContainers: /var/lib/docker/containers  dockerContainers: /export/docker-data-root/containers  libSystemdDir: /usr/lib64</code></pre><p>ä¿®æ”¹elasticsearchçš„è·¯å¾„</p><pre><code class="language-yaml">elasticsearch:  auth:    enabled: false    user: null    password: null    existingSecret:      name: null      key: null  includeTagKey: true  setOutputHostEnvVar: true  # If setOutputHostEnvVar is false this value is ignored  #hosts: [&quot;elasticsearch-client:9200&quot;]  hosts: [&quot;elasticsearch-master.efk.svc.cluster.local:9200&quot;]</code></pre><blockquote><p>elasticsearch-master æ˜¯esåˆ›å»ºå®Œæ¯•åçš„service_name</p></blockquote><p>æ·»åŠ masterèŠ‚ç‚¹çš„å®¹å¿</p><pre><code class="language-yaml">tolerations:  - key: node-role.kubernetes.io/master    operator: Exists    effect: NoSchedule</code></pre><p>å¼€å§‹å®‰è£…</p><pre><code class="language-bash">helm install myflu kokuwa/fluentd-elasticsearch -f values.yaml</code></pre><h3 id="æ ¡éªŒ-elasticsearch">æ ¡éªŒ elasticsearch</h3><p>ç¡®è®¤ elasticsearch æ˜¯å¦æ¥æ”¶åˆ°æ¥è‡ª fluentd-elasticsearch å‘é€çš„æ•°æ®</p><pre><code class="language-bash">kubectl run cirros-$RANDOM --image=cirros --rm -it -- /bin/shcurl elasticsearch-master.efk.svc.cluster.local:9200/_cat/indices===green open logstash-2021.07.03             YeQF97-WQZKvg6lieiXxRw 1 1  31045      0   6.7mb  3.4mbgreen open logstash-2021.07.02             qQAZg0rnSAW8FWxrNgwWhQ 1 1  42034      0   7.4mb  3.6mbgreen open logstash-2021.07.01             lJh5YdtySqukuITYrCmWcQ 1 1  30655      0   6.5mb  3.5mbgreen open logstash-2021.06.30             0vw7wc2tT9aNZJfXU2KLtw 1 1  27922      0   5.9mb  3.2mbgreen open logstash-2021.06.29             TiUBVT_MTC-mdP_fRbHoTQ 1 1  27914      0   5.9mb    3mbgreen open logstash-2021.06.28             54MQznz6Sr27Xn8JjSclsg 1 1  27921      0   5.9mb  3.1mbgreen open logstash-2021.06.27             VYcSLdq7QVO-p1rFdoZYRg 1 1  27920      0     6mb  3.1mbgreen open logstash-2021.06.26             C4HUoKhoTf67vcZJXW4H1A 1 1  44168      0   9.3mb  4.7mbgreen open logstash-2021.06.25             2TLEHI3TSiyEEALSWH3j3g 1 1  24310      0   5.4mb  2.8mbgreen open logstash-2021.06.24             Q8kF51zITB-G4xLGjveXEg 1 1  27338      0   6.1mb  2.9mb</code></pre><h3 id="kibana"><a href="https://artifacthub.io/packages/helm/elastic/kibana/7.14.0">kibana</a></h3><p>ä¸‹è½½chartåŒ…åˆ°æœ¬åœ°ï¼Œå¹¶è§£å‹</p><pre><code class="language-bash">cd kube-efkhelm fatch elastic/kibanatar xf kibana*.tgz &amp;&amp; cd kibana</code></pre><p>ç¼–è¾‘ values.yamlï¼Œè‡ªå®šä¹‰é…ç½®</p><p>ä¿®æ”¹elasticsearchåœ°å€ï¼Œå…¶å®ä¸ç”¨ä¿®æ”¹ï¼Œå› ä¸ºè¿™ä¸ªchartå’Œelasticsearchéƒ½æ˜¯elasticå‡ºçš„ï¼Œé»˜è®¤å€¼å°±æ²¡é—®é¢˜</p><pre><code class="language-yaml">elasticsearchHosts: &quot;http://elasticsearch-master:9200&quot; </code></pre><p>ä¿®æ”¹kibanaçš„serviceç±»å‹ï¼Œä»é›†ç¾¤å¤–è®¿é—®</p><pre><code class="language-yaml">service:  type: LoadBalancer  loadBalancerIP: &quot;&quot;  port: 5601  nodePort: &quot;&quot;  labels: &#123;&#125;  annotations:    &#123;&#125;    # cloud.google.com/load-balancer-type: &quot;Internal&quot;    # service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0    #service.beta.kubernetes.io/azure-load-balancer-internal: &quot;true&quot;    # service.beta.kubernetes.io/openstack-internal-load-balancer: &quot;true&quot;    # service.beta.kubernetes.io/cce-load-balancer-internal-vpc: &quot;true&quot;</code></pre><blockquote><p>æ ¹æ®ä½ çš„ç¯å¢ƒä¿®æ”¹ï¼Œæˆ‘è¿™é‡Œç¯å¢ƒç”¨äº†metallbç»„ä»¶ï¼Œç”¨æ¥æ¨¡æ‹ŸLBï¼Œæ‰€ä»¥annotationsä¸éœ€è¦æ·»åŠ ä»»ä½•æ³¨é‡Š</p></blockquote><h3 id="é…ç½®kibana">é…ç½®kibana</h3><p>æ·»åŠ æ¨¡å¼åˆ†åŒº</p><p>è·¯å¾„ï¼šStack Management-&gt;Index patterns</p><p>Index pattern name: <code>logstash*</code></p><p>Time field: <code>@timestamp</code></p><p>é…ç½®ä¸€ä¸ªå±•ç¤ºk8s erroré”™è¯¯çš„å›¾æ ‡</p><p><img src="/posts/ce23a4a1/image-20210814122316905.png" alt="image-20210814122316905"></p><p><img src="/posts/ce23a4a1/image-20210814122130824.png" alt="image-20210814122130824"></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> k8s </tag>
            
            <tag> EFK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker-å¸¸ç”¨çš„æŒ‡ä»¤</title>
      <link href="posts/634b48fb/"/>
      <url>posts/634b48fb/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>è®°å½•ä¸€äº›å¸¸ç”¨çš„æŒ‡ä»¤</p><h1>åˆ—è¡¨</h1><h2 id="1-æŸ¥çœ‹é•œåƒç¯å¢ƒå˜é‡">1. æŸ¥çœ‹é•œåƒç¯å¢ƒå˜é‡</h2><pre><code>docker run -it --rm [image_name] env</code></pre><h2 id="2-åˆ é™¤">2. åˆ é™¤</h2><h3 id="åˆ é™¤æ‰€æœ‰danglingçš„é•œåƒ">åˆ é™¤æ‰€æœ‰danglingçš„é•œåƒ</h3><pre><code class="language-bash">docker image prune</code></pre><h3 id="åˆ é™¤æ‰€æœ‰æ²¡æœ‰è¢«å¼•ç”¨çš„æœ¬åœ°å·">åˆ é™¤æ‰€æœ‰æ²¡æœ‰è¢«å¼•ç”¨çš„æœ¬åœ°å·</h3><pre><code class="language-bash">docker volume prune</code></pre><h3 id="åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨">åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨</h3><pre><code class="language-bash">docker container prune</code></pre><h3 id="æ¸…ç©ºæ‰€æœ‰-æœªä½¿ç”¨-æœªè¿è¡Œ-çš„dockerèµ„æºå¯¹è±¡ï¼ŒåŒ…æ‹¬å®¹å™¨ã€å·ã€ç½‘ç»œã€é•œåƒ">æ¸…ç©ºæ‰€æœ‰[æœªä½¿ç”¨/æœªè¿è¡Œ]çš„dockerèµ„æºå¯¹è±¡ï¼ŒåŒ…æ‹¬å®¹å™¨ã€å·ã€ç½‘ç»œã€é•œåƒ</h3><pre><code class="language-bash">docker system prune --all --force --volumes</code></pre><h3 id="æ¸…ç©ºæ‰€æœ‰çš„dockerèµ„æºå¯¹è±¡ï¼ŒåŒ…æ‹¬å®¹å™¨ã€å·ã€ç½‘ç»œã€é•œåƒ">æ¸…ç©ºæ‰€æœ‰çš„dockerèµ„æºå¯¹è±¡ï¼ŒåŒ…æ‹¬å®¹å™¨ã€å·ã€ç½‘ç»œã€é•œåƒ</h3><p>ğŸ‘»è¿™æ˜¯æåº¦å¯æ€•çš„æŒ‡ä»¤ï¼Œä»…å½“ä½ è¦åˆå§‹åŒ–dockerçš„æ—¶å€™æ‰åº”è¯¥ä½¿ç”¨ã€‚</p><pre><code class="language-bash">docker container stop $(docker container ls -a -q) &amp;&amp; docker system prune --all --force --volumes</code></pre><h2 id="3-it-rmå¯åŠ¨çš„å®¹å™¨ï¼Œå¦‚ä½•ä¸´æ—¶é€€å‡º">3. <code>-it --rm</code>å¯åŠ¨çš„å®¹å™¨ï¼Œå¦‚ä½•ä¸´æ—¶é€€å‡º</h2><p>ä¸‹è¿°æŒ‡ä»¤å¯ä»¥è®©ä½ ä¸´æ—¶é€€å‡ºå®¹å™¨ï¼Œè€Œä¸ä¼šè§¦å‘<code>--rm</code></p><pre><code class="language-bash">ctrl+P+q</code></pre><p>ä½ å¯ä»¥é€šè¿‡ exec ä»æ–°è¿›å…¥å®¹å™¨ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹åï¼Œä½ é€šè¿‡exité€€å‡ºå®¹å™¨ï¼Œä¹Ÿä¸ä¼šè§¦å‘<code>--rm</code></p><p>åªæœ‰æ‰§è¡Œ<code>docker stop [container_name]</code>æ‰ä¼šè§¦å‘åˆ é™¤æ“ä½œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerâ˜érootç”¨æˆ·æ‰§è¡Œç¨‹åº</title>
      <link href="posts/604e367f/"/>
      <url>posts/604e367f/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å®¹å™¨å†…ä»¥rootç”¨æˆ·è¿è¡Œï¼Œåˆ™å°±å¯ä»¥çœ‹åˆ°æŒ‚è½½ç‚¹å†…rootç”¨æˆ·çš„æ–‡ä»¶ï¼Œè¿™å¹¶ä¸å®‰å…¨ã€‚</p><p>ä½†åŒæ—¶ï¼Œå®¹å™¨é‡Œçš„ç”¨æˆ·éœ€è¦ä¸å®¿ä¸»æœºé‡Œçš„ç”¨æˆ·ï¼Œæ‹¥æœ‰ç›¸åŒçš„IDï¼Œå¦åˆ™å®¹å™¨é‡Œçš„ç”¨æˆ·æ— æ³•æ‹¥æœ‰è¶³å¤Ÿçš„æƒé™è®¿é—®æŒ‚è½½ç‚¹</p><h2 id="åˆ›å»ºå®¿ä¸»æœºç”¨æˆ·">åˆ›å»ºå®¿ä¸»æœºç”¨æˆ·</h2><p>å¯¹åº”å®¹å™¨é‡Œçš„ç”¨æˆ·</p><pre><code class="language-bash">groupadd --gid 60000 testuseradd --uid 60000 -g test --no-create-home test</code></pre><h2 id="å®¹å™¨ä½¿ç”¨æ–¹å¼">å®¹å™¨ä½¿ç”¨æ–¹å¼</h2><pre><code class="language-bash">FROM busybox:latestADD 1.txt /app/WORKDIR /appRUN addgroup --gid 60000 test &amp;&amp; adduser -u 60000 -G test -D -H testUSER testï¼›ï¼›</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>harborâ˜å®‰è£…</title>
      <link href="posts/9573a87d/"/>
      <url>posts/9573a87d/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¡¬ä»¶å’Œä¾èµ–è½¯ä»¶">ç¡¬ä»¶å’Œä¾èµ–è½¯ä»¶</h2><p><a href="https://goharbor.io/docs/2.3.0/install-config/installation-prereqs/">Harbor docs | Harbor Installation Prerequisites (goharbor.io)</a></p><h3 id="ç¡¬ä»¶ä¾èµ–">ç¡¬ä»¶ä¾èµ–</h3><table><thead><tr><th style="text-align:left">Resource</th><th style="text-align:left">Minimum</th><th style="text-align:left">Recommended</th></tr></thead><tbody><tr><td style="text-align:left">CPU</td><td style="text-align:left">2 CPU</td><td style="text-align:left">4 CPU</td></tr><tr><td style="text-align:left">Mem</td><td style="text-align:left">4 GB</td><td style="text-align:left">8 GB</td></tr><tr><td style="text-align:left">Disk</td><td style="text-align:left">40 GB</td><td style="text-align:left">160 GB</td></tr></tbody></table><h3 id="è½¯ä»¶ä¾èµ–">è½¯ä»¶ä¾èµ–</h3><table><thead><tr><th style="text-align:left">Software</th><th style="text-align:left">Version</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left">Docker engine</td><td style="text-align:left">Version 17.06.0-ce+ or higher</td><td style="text-align:left">For installation instructions, see <a href="https://docs.docker.com/engine/installation/">Docker Engine documentation</a></td></tr><tr><td style="text-align:left">Docker Compose</td><td style="text-align:left">Version 1.18.0 or higher</td><td style="text-align:left">For installation instructions, see <a href="https://docs.docker.com/compose/install/">Docker Compose documentation</a></td></tr><tr><td style="text-align:left">Openssl</td><td style="text-align:left">Latest is preferred</td><td style="text-align:left">Used to generate certificate and keys for Harbor</td></tr></tbody></table><blockquote><p><a href="https://github.com/Spinestars/shell/blob/main/install/centos7_init.sh">shell/centos7_init.sh at main Â· Spinestars/shell (github.com)</a></p></blockquote><h3 id="ç½‘ç»œä¾èµ–">ç½‘ç»œä¾èµ–</h3><table><thead><tr><th style="text-align:left">Port</th><th style="text-align:left">Protocol</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left">443</td><td style="text-align:left">HTTPS</td><td style="text-align:left">Harbor portal and core API accept HTTPS requests on this port. You can change this port in the configuration file.</td></tr><tr><td style="text-align:left">4443</td><td style="text-align:left">HTTPS</td><td style="text-align:left">Connections to the Docker Content Trust service for Harbor. Only required if Notary is enabled. You can change this port in the configuration file.</td></tr><tr><td style="text-align:left">80</td><td style="text-align:left">HTTP</td><td style="text-align:left">Harbor portal and core API accept HTTP requests on this port. You can change this port in the configuration file.</td></tr></tbody></table><h2 id="ä¸‹è½½-é…ç½®">ä¸‹è½½/é…ç½®</h2><ul><li>ä¸‹è½½åœ¨çº¿å®‰è£…åŒ…å¹¶è§£å‹</li></ul><p><a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p><ul><li>ä¿®æ”¹è§£å‹åçš„é…ç½®æ–‡ä»¶</li></ul><pre><code class="language-bash">cp harbor.yml.tmpl harbor.ymlmkdir -p /export/docker-data-harbor/log</code></pre><p>ä¸»è¦çš„ä¿®æ”¹å¦‚ä¸‹</p><blockquote><p>è¿™é‡Œçš„é…ç½®å¹¶é harbor å„ç»„ä»¶ç›´æ¥è°ƒç”¨çš„é…ç½®ï¼Œè€Œæ˜¯ harbor å®‰è£…è„šæœ¬æ‰€éœ€çš„é…ç½®ï¼Œå®‰è£…è„šæœ¬ä¼šæ ¹æ®è¿™ä¸ªé…ç½®ï¼ŒåŠ¨æ€çš„ç”Ÿæˆä¹‹å harbor æ‰€éœ€å„é¡¹è½¯ä»¶é…ç½®å’Œæ•°æ®</p></blockquote><pre><code class="language-yaml"># The IP address or hostname to access admin UI and registry service.# DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.# &lt;åŸŸå&gt;hostname: &lt;åŸŸå&gt;# http related confighttp:  # port for http, default is 80. If https enabled, this port will redirect to https port  port: 10080# https related confighttps:  # https port for harbor, default is 443  port: 10443  # The path of cert and key files for nginx &lt;å®¿ä¸»æœºè·¯å¾„,ä¸èƒ½æ˜¯è½¯é“¾æ¥&gt;  certificate:   private_key:   ...harbor_admin_password: &lt;webç•Œé¢ç®¡ç†å‘˜å¯†ç &gt;# Harbor DB configurationdatabase:  # The password for the root user of Harbor DB. Change this before any production use.  password: &lt;æ•°æ®åº“å¯†ç &gt;  # The maximum number of connections in the idle connection pool. If it &lt;=0, no idle connections are retained.  max_idle_conns: 100  # The maximum number of open connections to the database. If it &lt;= 0, then there is no limit on the number of open connections.  # Note: the default number of connections is 1024 for postgres of harbor.  max_open_conns: 900# The default data volume, default: /data  &lt;å®¿ä¸»æœºè·¯å¾„ï¼Œæ‰€æœ‰è½¯ä»¶çš„æ•°æ®ç›®å½•çš„æ ¹ç›®å½•&gt;data_volume: /export/docker-data-harbor...# Log configurationslog:  # options are debug, info, warning, error, fatal  level: info  # configs for logs in local storage  local:    # Log files are rotated log_rotate_count times before being removed. If count is 0, old versions are removed rather than rotated.    rotate_count: 50    # Log files are rotated only if they grow bigger than log_rotate_size bytes. If size is followed by k, the size is assumed to be in kilobytes.    # If the M is used, the size is in megabytes, and if G is used, the size is in gigabytes. So size 100, size 100k, size 100M and size 100G    # are all valid.    rotate_size: 200M    # The directory on your host that store log,     location: /export/docker-data-harbor/log</code></pre><h3 id="httpsçš„é…ç½®">httpsçš„é…ç½®</h3><p>è¯ä¹¦é…ç½®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯nginxçš„ï¼Œä¸€ä¸ªæ˜¯dockerçš„ï¼Œä¸¤åœ°è¯ä¹¦ä¸€æ ·ï¼Œåªä¸è¿‡dockeréœ€è¦é¢å¤–çš„<code>ca.cert</code></p><ul><li>dockerä½ç½®(å¯ç”¨è½¯è¿æ¥)</li></ul><pre><code class="language-bash">cp yourdomain.com.cert /etc/docker/certs.d/yourdomain.com/  # å¦‚æœä½ æ›´æ¢äº†é»˜è®¤ç«¯å£ï¼Œåˆ™å¤åˆ¶åˆ° /etc/docker/certs.d/yourdomain.com:port/cp yourdomain.com.key /etc/docker/certs.d/yourdomain.com/cp ca.crt /etc/docker/certs.d/yourdomain.com/</code></pre><ul><li>nginxä½ç½®(ä¸å¯ç”¨è½¯è¿æ¥)</li></ul><p>nginxçš„è¯ä¹¦ä¼šä»<code>harbor.yml</code>ä¸­çš„<code>https.certificate</code> <code>https.private_key</code>å¤„å¤åˆ¶åˆ° <code>&lt;path_to_data_volume&gt;/secret/cert/ </code></p><h2 id="å®‰è£…-å¯åŠ¨-å…³é—­">å®‰è£…/å¯åŠ¨/å…³é—­</h2><h3 id="é¢„å®‰è£…ï¼Œå¹¶å¯åŠ¨">é¢„å®‰è£…ï¼Œå¹¶å¯åŠ¨</h3><p>ç”Ÿæˆ docker-compose é…ç½®ï¼Œå¹¶åˆ›å»ºç›¸å…³æ•°æ®ç›®å½•ï¼Œä»¥åŠå®¹å™¨æ‰€éœ€çš„ä¾èµ–æ•°æ®</p><pre><code>./prepare &amp;&amp; docker-compose up -d</code></pre><h3 id="ç›´æ¥å®‰è£…ï¼Œå¹¶å¯åŠ¨">ç›´æ¥å®‰è£…ï¼Œå¹¶å¯åŠ¨</h3><pre><code>./install.sh</code></pre><h3 id="å…³é—­">å…³é—­</h3><pre><code class="language-bash">docker-compose down</code></pre><h2 id="å…¶å®ƒ">å…¶å®ƒ</h2><h3 id="è¯ä¹¦æ›´æ¢">è¯ä¹¦æ›´æ¢</h3><p>nginxéœ€è¦æ›´æ¢ &lt;path_to_data_volume&gt;/secret/cert/ ä¸‹çš„æ–‡ä»¶ï¼Œå¹¶é‡å¯nginxå®¹å™¨</p><p>dockeréœ€è¦æ›´æ¢ /etc/docker/certs.d/yourdomain.com/ ä¸‹çš„æ–‡ä»¶ï¼Œåº”è¯¥æ— éœ€é‡å¯</p><h2 id="webé…ç½®-ç­–ç•¥">webé…ç½®-ç­–ç•¥</h2><p>åˆ é™¤ç­–ç•¥çš„å…·ä½“éœ€æ±‚ï¼š</p><ol><li>ç­–ç•¥æ‰§è¡Œæ—¶ï¼Œåˆ é™¤æ‰€æœ‰çš„å«æœ‰ untag é•œåƒ</li><li>ç­–ç•¥æ‰§è¡Œæ—¶ï¼Œä¿ç•™æœ€è¿‘7å¤©å«æœ‰ tag é•œåƒ</li></ol><p><img src="/posts/9573a87d/image-20210823180632775.png" alt="image-20210823180632775"></p><p>ç­–ç•¥çš„æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡ã€æ¨¡æ‹Ÿè¿è¡Œã€‘+è¿è¡Œåçš„ã€æ—¥å¿—ã€‘æ¥ç¡®å®šç­–ç•¥æ˜¯å¦æ»¡è¶³æœŸæœ›ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> harbor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vcsaâ˜å­˜å‚¨è®¾å¤‡æœ‰vmfsåˆ†åŒºï¼Œä½†æ•°æ®å­˜å‚¨ä¸¢å¤±</title>
      <link href="posts/eab024cf/"/>
      <url>posts/eab024cf/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¸€ä¸ªesxiè€æ˜¯æ–­è¿ï¼Œæ ¹æ®æ—¥å¿—åˆ¤æ–­æ˜¯ä¸»æ¿ç¡¬ç›˜æ¥å£æœ‰ç‚¹é—®é¢˜ï¼Œæ‰€ä»¥å°†ç¡¬ç›˜æ¢åˆ°äº†å¦ä¸€ä¸ªä¸»æœºã€‚ç»“æœä¸»æœºå¯åŠ¨èµ·æ¥ä¹‹åï¼Œvcsaé‡Œå¯ä»¥çœ‹åˆ°å­˜å‚¨è®¾å¤‡ï¼Œå°±æ˜¯æ•°æ®å­˜å‚¨ä¸å¯è®¿é—®ï¼Œåˆ é™¤ä¹‹åï¼Œå†æ‰«æä¹Ÿæ‰¾ä¸åˆ°ã€‚</p><h2 id="è¿‡ç¨‹">è¿‡ç¨‹</h2><p>å¼€å¯esxiçš„sshæœåŠ¡ï¼Œè¿›å…¥ä¹‹åï¼Œå‘ç°åˆ†åŒºå•¥çš„éƒ½è¿˜åœ¨ï¼Œçœ‹èµ·æ¥æ˜¯æ²¡æœ‰æŒ‚è½½æˆåŠŸã€‚</p><h3 id="æ£€æŸ¥åˆ†åŒº">æ£€æŸ¥åˆ†åŒº</h3><p>å‘ç°åºå·8å°±æ˜¯æ²¡æœ‰æŒ‚è½½ä¸Šçš„vmfsåˆ†åŒºï¼Œä¸”æ£€æŸ¥æ²¡æœ‰é”™è¯¯</p><p>voma -m vmfs -f check -d &lt;åˆ†åŒºæ–‡ä»¶&gt;</p><pre><code>voma -m vmfs -f check -d /vmfs/devices/disks/naa.50014ee213cfd76d:8===Running VMFS Checker version 2.1 in check modeInitializing LVM metadata, Basic Checks will be doneChecking for filesystem activityPerforming filesystem liveness check..\Scanning for VMFS-6 host activity (4096 bytes/HB, 1024 HBs).         Scsi 2 reservation successfulPhase 1: Checking VMFS header and resource files   Detected VMFS-6 file system (labeled:'10-200-16-4-hdd') with UUID:60a7b864-03293672-7e51-8cdcd42142e2, Version 6:82Phase 2: Checking VMFS heartbeat regionMarking Journal addr (0, 0) in usePhase 3: Checking all file descriptors.   Found stale lock [type 10c00001 offset 7561216 v 24, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 1109         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7577600 v 30, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 1119         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7585792 v 87, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 999         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7602176 v 42, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 1114         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7733248 v 47, hb offset 3899392         gen 77, mode 1, owner 60cb1a4b-1ed0702e-cebf-8cdcd42142e2 mtime 664         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7749632 v 49, hb offset 3899392         gen 77, mode 1, owner 60cb1a4b-1ed0702e-cebf-8cdcd42142e2 mtime 699         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7856128 v 70, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 986         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7864320 v 71, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 993         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7872512 v 72, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 1004         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7880704 v 73, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 1028         num 0 gblnum 0 gblgen 0 gblbrk 0]   Found stale lock [type 10c00001 offset 7888896 v 74, hb offset 3899392         gen 163, mode 1, owner 60d05066-92815c9b-65fa-8cdcd42142e2 mtime 1046         num 0 gblnum 0 gblgen 0 gblbrk 0]Phase 4: Checking pathname and connectivity.Phase 5: Checking resource reference counts.Total Errors Found:           0</code></pre><blockquote><p>è¾“å‡ºä¿¡æ¯é‡Œ Phase 1: éƒ¨åˆ†æ˜¾ç¤ºäº†vmfsåˆ†åŒºçš„labelå’ŒUUID</p></blockquote><h3 id="æŒ‚è½½vmfsåˆ†åŒºï¼Œå¹¶åŠ å…¥å¼€æœºå¯åŠ¨">æŒ‚è½½vmfsåˆ†åŒºï¼Œå¹¶åŠ å…¥å¼€æœºå¯åŠ¨</h3><p>esxcfg-volume -M &lt;åˆ†åŒºUUID&gt;</p><pre><code class="language-bash">esxcfg-volume -M 60a7b864-03293672-7e51-8cdcd42142e2===Mounting volume 60a7b864-03293672-7e51-8cdcd42142e2</code></pre>]]></content>
      
      
      <categories>
          
          <category> è™šæ‹ŸåŒ– </category>
          
          <category> vmware </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vmware </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitâ˜å¸¸ç”¨å‘½ä»¤</title>
      <link href="posts/f0c6f6c3/"/>
      <url>posts/f0c6f6c3/</url>
      
        <content type="html"><![CDATA[<h2 id="ç‰ˆæœ¬">ç‰ˆæœ¬</h2><pre><code class="language-bash"># æŸ¥çœ‹å½“å‰ commit idgit rev-parse HEAD# æ”¾å¼ƒå½“å‰ commit id ä¹‹åçš„ä¿®æ”¹git reset --hard</code></pre><h2 id="æš‚å­˜">æš‚å­˜</h2><pre><code># ä¸´æ—¶å°†ä¿®æ”¹æš‚å­˜åˆ°å †æ ˆåˆ—ï¼Œå¹¶åˆå§‹åŒ–åˆ°æœ€åä¸€ä¸ª commit id## å½“å­˜åœ¨å¤šä¸ªæš‚å­˜çš„æ—¶å€™ï¼Œä½ éœ€è¦è‡ªå®šä¹‰ messagegit stash save &lt;message&gt;# å–å‡ºå †æ ˆåˆ—ç›¸åº”çš„æš‚å­˜ï¼Œå¹¶åº”ç”¨åˆ°æš‚å­˜å¯¹åº”çš„ commit id git stash apply stash@&#123;X&#125;# åˆ é™¤å †æ ˆåˆ—ç›¸åº”çš„æš‚å­˜git stash drop stash@&#123;X&#125;# ä¸´æ—¶å°†ä¿®æ”¹æš‚å­˜åˆ°å †æ ˆåˆ—ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤åï¼Œå¹¶åˆå§‹åŒ–åˆ°æœ€åä¸€ä¸ª commit id## å‘½åè§„èŒƒï¼šstash@&#123;num&#125;: WIP on &lt;branch_name&gt; ï¼š &lt;latest_commit_id&gt; &lt;latest_commit_message&gt;git stash# å–å‡ºå †æ ˆåˆ—æœ€ä¸Šå±‚çš„æš‚å­˜ï¼Œå¹¶åº”ç”¨åˆ°æš‚å­˜å¯¹åº”çš„ commit idï¼ŒåŒæ—¶åˆ é™¤æš‚å­˜git stash pop</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜17-2è°ƒåº¦ä¹‹äº²å’Œæ€§å’Œåäº²å’Œæ€§</title>
      <link href="posts/4d69fc4a/"/>
      <url>posts/4d69fc4a/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>æœ€ç®€å•çš„è°ƒåº¦æ–¹å¼<code>nodeSelector </code>æ–¹å¼ï¼Œä»…éœ€ç»™Podæä¾›ï¼Œå°±å¯ä»¥è®©Podè°ƒåº¦åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šã€‚ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: nginx  labels:    env: testspec:  containers:  - name: nginx    image: nginx    imagePullPolicy: IfNotPresent  nodeSelector:    disktype: ssd</code></pre><p>ä¸Šè¿°æ–¹å¼å¤ªæ­»æ¿ï¼Œä¸‡ä¸€æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™ä¼šPodä¼šå¡ä½æ— æ³•è°ƒåº¦ã€‚</p><hr><p>å› æ­¤å°±æœ‰äº†äº²å’Œæ€§å’Œåäº²å’Œæ€§ç­–ç•¥ã€‚</p><p>é’ˆå¯¹nodeçš„äº²å’Œæ€§æ˜¯ï¼šnodeAffinityã€‚å…¶æ„æ€æ˜¯å¦‚æœæœ‰ç¬¦åˆæ¡ä»¶çš„nodeï¼Œå°±å°†podè°ƒåº¦åˆ°è¿™ä¸ªnodeä¸Šã€‚</p><p>é’ˆå¯¹podçš„äº²å’Œæ€§å’Œåäº²å’Œæ€§åˆ†åˆ«æ˜¯ï¼špodAffinityå’ŒpodAntiAffinityã€‚å…¶æ„æ€æ˜¯å¦‚æœnodeä¸Šå·²ç»æœ‰ç¬¦åˆæ¡ä»¶çš„podï¼Œå°±å°†podè°ƒåº¦ï¼ˆåäº²å’Œï¼šä¸è°ƒåº¦ï¼‰åˆ°è¿™ä¸ªnodeä¸Šã€‚</p><p>å¯¹äºPodçš„äº²å’Œæ€§å’Œåäº²å’Œæ€§ï¼Œæ‹¥æœ‰ä¸€ä¸ªç§°ä¹‹ä¸º``topologyKey<code>çš„æ¦‚å¿µã€‚é€šè¿‡</code>topologyKey`ï¼Œå¯ä»¥å°†èŠ‚ç‚¹åˆ’åˆ†ä¸ºè‹¥å¹²æ‹“æ‰‘ç½‘æ ¼ã€‚å…¶æ„æ€æ˜¯ï¼š</p><p>äº²å’Œæ€§ï¼šåœ¨åˆ’åˆ†çš„æ¯ä¸€ä¸ªæ‹“æ‰‘å†…ï¼Œè‹¥å·²ç»æœ‰ç¬¦åˆæ¡ä»¶çš„podï¼Œåˆ™å°†podè°ƒåº¦åˆ°<code>topologyKey</code>å†…</p><p>åäº²å’Œæ€§ï¼šåœ¨åˆ’åˆ†çš„æ¯ä¸€ä¸ªæ‹“æ‰‘å†…ï¼Œè‹¥å·²ç»æœ‰ç¬¦åˆæ¡ä»¶çš„podï¼Œåˆ™ä¸å¯è°ƒåº¦åˆ°<code>topologyKey</code>å†…</p><h1>ä¸€ä¸ªä¾‹å­</h1><p>å®ç°ç›®æ ‡ï¼š</p><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆtopologyKeyï¼‰ä¸Šï¼Œå‡åªæœ‰ä¸€ä¸ªweb-serverå’Œä¸€ä¸ªredis</p><p>redisçš„é…ç½®</p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: redis-cachespec:  selector:    matchLabels:      app: store  replicas: 3  template:    metadata:      labels:        app: store    spec:      affinity:        podAntiAffinity: # åäº²å’Œæ€§ï¼šä»¥èŠ‚ç‚¹ååˆ’åˆ†æ‹“æ‰‘åŸŸï¼Œè‹¥æ‹“æ‰‘åŸŸå†…å·²æœ‰app=storeçš„Podï¼Œåˆ™ä¸å¯å†å°†æœ¬Podè°ƒåº¦è¿›æ­¤æ‹“æ‰‘åŸŸ          requiredDuringSchedulingIgnoredDuringExecution:          - labelSelector:              matchExpressions:              - key: app                operator: In                values:                - store            topologyKey: &quot;kubernetes.io/hostname&quot;      containers:      - name: redis-server        image: redis:3.2-alpine</code></pre><p>web-serverçš„é…ç½®</p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: web-serverspec:  selector:    matchLabels:      app: web-store  replicas: 3  template:    metadata:      labels:        app: web-store    spec:      affinity:        podAntiAffinity: # åäº²å’Œæ€§ï¼šä»¥èŠ‚ç‚¹ååˆ’åˆ†æ‹“æ‰‘åŸŸï¼Œè‹¥æ‹“æ‰‘åŸŸå†…å·²æœ‰app=web-storeçš„Podï¼Œåˆ™ä¸å¯å†å°†æœ¬Podè°ƒåº¦è¿›æ­¤æ‹“æ‰‘åŸŸ          requiredDuringSchedulingIgnoredDuringExecution:          - labelSelector:              matchExpressions:              - key: app                operator: In                values:                - web-store            topologyKey: &quot;kubernetes.io/hostname&quot;        podAffinity: # äº²å’Œæ€§ï¼šä»¥èŠ‚ç‚¹ååˆ’åˆ†æ‹“æ‰‘åŸŸï¼Œè‹¥æ‹“æ‰‘åŸŸå†…å·²æœ‰app=storeçš„pod,åˆ™å¯å°†æœ¬Podè°ƒåº¦è¿›æ­¤æ‹“æ‰‘åŸŸ          requiredDuringSchedulingIgnoredDuringExecution:          - labelSelector:              matchExpressions:              - key: app                operator: In                values:                - store            topologyKey: &quot;kubernetes.io/hostname&quot;      containers:      - name: web-app        image: nginx:1.12-alpine</code></pre><p>ğŸ’›å¦‚æœè¦å°†è¶…å‡ºèŠ‚ç‚¹æ•°çš„Podå°½å¯èƒ½çš„å‡è¡¡è´Ÿè½½ï¼Œåˆ™Podåäº²å’Œåº”è¯¥ä½¿ç”¨<code>preferredDuringSchedulingIgnoredDuringExecution</code>ï¼Œè¿™å¯ä»¥ç¡®ä¿åœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½éƒ¨ç½²Podåï¼Œä¾ç„¶å¯ä»¥å°†Podéƒ¨ç½²è¿›å»ã€‚</p><pre><code class="language-yaml">    spec:      affinity:        podAntiAffinity:          preferredDuringSchedulingIgnoredDuringExecution:          - weight: 1            podAffinityTerm:              labelSelector:                matchExpressions:                - key: app                  operator: In                  values:                  - web-store              topologyKey: &quot;kubernetes.io/hostname&quot;</code></pre><h1>å››å¤§è°ƒåº¦ç­–ç•¥ç±»å‹</h1><h2 id="æ”¯æŒnodeAffinityã€podAffinityã€podAntiAffinityçš„ç­–ç•¥">æ”¯æŒnodeAffinityã€podAffinityã€podAntiAffinityçš„ç­–ç•¥</h2><ul><li><p>requiredDuringScheduling<strong>IgnoredDuringExecution</strong> è°ƒåº¦å¿…é¡»æ»¡è¶³æ¡ä»¶+å¿½ç•¥æ‰§è¡ŒæœŸé—´æ¡ä»¶å˜åŒ–</p><p>è¡¨ç¤ºã€å¿…é¡»ã€‘æ»¡è¶³è®¾å®šçš„æ¡ä»¶æ‰å¯ä»¥è°ƒåº¦ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²åè¿è¡ŒæœŸé—´ï¼Œå¦‚æœä¸å†æ»¡è¶³è®¾å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p></li><li><p>preferredDuringScheduling<strong>IgnoredDuringExecution</strong> è°ƒåº¦å°½å¯èƒ½æ»¡è¶³æ¡ä»¶+å¿½ç•¥æ‰§è¡ŒæœŸé—´æ¡ä»¶å˜åŒ–</p><p>è¡¨ç¤ºã€å°½å¯èƒ½ã€‘æ»¡è¶³è®¾å®šçš„æ¡ä»¶æ‰å¯ä»¥è°ƒåº¦ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœä¸å†æ»¡è¶³è®¾å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p></li></ul><p>ğŸ’–ç­–ç•¥å¯ä»¥ç»„åˆä½¿ç”¨</p><h2 id="æœªæ¥å¯èƒ½æ”¯æŒçš„ç­–ç•¥">æœªæ¥å¯èƒ½æ”¯æŒçš„ç­–ç•¥</h2><ul><li><p>requiredDuringScheduling<strong>RequiredDuringExecution</strong> è°ƒåº¦å¿…é¡»æ»¡è¶³æ¡ä»¶+ä¸å¯å¿½ç•¥æ‰§è¡ŒæœŸé—´æ¡ä»¶å˜åŒ–<br>è¡¨ç¤ºã€å¿…é¡»ã€‘æ»¡è¶³è®¾å®šçš„æ¡ä»¶æ‰å¯ä»¥è°ƒåº¦ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²åè¿è¡ŒæœŸé—´ï¼Œå¦‚æœä¸å†æ»¡è¶³è®¾å®šçš„æ¡ä»¶ï¼Œåˆ™è¢«é©±é€é‡æ–°è°ƒåº¦ã€‚</p></li><li><p>preferredDuringScheduling<strong>RequiredDuringExecution</strong> è°ƒåº¦å°½å¯èƒ½æ»¡è¶³æ¡ä»¶+ä¸å¯å¿½ç•¥æ‰§è¡ŒæœŸé—´æ¡ä»¶å˜åŒ–<br>è¡¨ç¤ºã€å°½å¯èƒ½ã€‘æ»¡è¶³è®¾å®šçš„æ¡ä»¶æ‰å¯ä»¥è°ƒåº¦ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœä¸å†æ»¡è¶³è®¾å®šçš„æ¡ä»¶ï¼Œåˆ™è¢«é©±é€é‡æ–°è°ƒåº¦ã€‚</p></li></ul><h1>æ¡ˆä¾‹</h1><h2 id="çº¿ä¸ŠæœåŠ¡å™¨ç»„ä¸“ç”¨èŠ‚ç‚¹">çº¿ä¸ŠæœåŠ¡å™¨ç»„ä¸“ç”¨èŠ‚ç‚¹</h2><pre><code class="language-bash"># æ·»åŠ æ±¡ç‚¹ï¼ŒéprodæœåŠ¡ä¸å¯è°ƒåº¦åˆ°æ­¤èŠ‚ç‚¹kubectl taint nodes k8s001 dedicated=prod:NoSchedule# æ·»åŠ æ ‡ç­¾kubectl label nodes k8s001 dedicated=prod</code></pre><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: nginx  labels:    dedicated: prodspec:  affinity:    nodeAffinity:      requiredDuringSchedulingRequiredDuringExecution:        nodeSelectorTerms:        - matchExpressions:          - key: dedicated            operator: In            values:             - prod  tolerations:  - key: &quot;dedicated&quot;    operator: &quot;Equal&quot;    value: &quot;prod&quot;    effect: &quot;NoSchedule&quot;  containers:  - name: nginx    image: nginx    imagePullPolicy: IfNotPresent</code></pre><p>tolerations ç¡®ä¿äº† nginx pod å¯ä»¥è°ƒåº¦åˆ°æ‹¥æœ‰ dedicated=prod:NoSchedule æ±¡ç‚¹çš„èŠ‚ç‚¹ï¼Œè€Œ k8s001 æ‹¥æœ‰æ­¤æ±¡ç‚¹ã€‚</p><p>affinity.nodeAffinity èŠ‚ç‚¹äº²å’Œç¡®ä¿äº†å¿…é¡»è°ƒåº¦åˆ°æ‹¥æœ‰ dedicated=prod æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œè€Œ k8s001 æ‹¥æœ‰æ­¤æ ‡ç­¾ã€‚å¹¶ä¸”ï¼Œå½“èŠ‚ç‚¹çš„dedicated != prodçš„æ—¶å€™ï¼ŒPodå°†ä¼šé‡æ–°è°ƒåº¦åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>helmâ˜01å…¥é—¨</title>
      <link href="posts/51015304/"/>
      <url>posts/51015304/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>helmï¼š k8sçš„åŒ…ç®¡ç†å™¨ï¼Œè¿™é‡Œæ˜¯v3ç‰ˆæœ¬</p><p>å¤§è‡´æµç¨‹ï¼šChartä»“åº“&lt;-helm-&gt;å­˜å‚¨åˆ°helmå®¢æˆ·ç«¯æœ¬åœ°-&gt;config-&gt;kubeconfig-&gt;Kube Apiserver-&gt;Release</p><p>chartä»“åº“ï¼šå­˜å‚¨chartç¨‹åºåŒ…ï¼Œä¸åŒ…å«ç¨‹åºï¼Œæ˜¯ä¸€ä¸ªèµ„æºæè¿°/æ¨¡æ¿ ï¼Œæ˜¯ä¸€ä¸ªhttpæœåŠ¡å™¨ã€‚</p><p>helmï¼šæœ¬åœ°å®¢æˆ·ç«¯</p><p>configï¼šæä¾›chartåŒ…æ‰€éœ€çš„å˜é‡ï¼Œæ„å»ºç‰¹å®šçš„chartåŒ…é…ç½®ï¼Œå¯¹åº”chartåŒ…é‡Œçš„values.yamlæ–‡ä»¶</p><p>Releaseï¼šç‰¹å®šçš„chartåŒ…çš„æœ¬åœ°å®ä¾‹åŒ–å¯¹è±¡ï¼Œéƒ¨ç½²äºç›®æ ‡é›†ç¾¤ä¸Šçš„ä¸€ä¸ªå®ä¾‹</p><p>å½“chartæ›´æ–°åï¼Œhelmå¯ä»¥æ»šåŠ¨æ›´æ–°å¯¹åº”çš„Releaseå®ä¾‹</p><h2 id="éƒ¨ç½²">éƒ¨ç½²</h2><h3 id="ä¸‹è½½HelmåŒ…">ä¸‹è½½HelmåŒ…</h3><p><a href="https://helm.sh/zh/docs/intro/install/">Helm | å®‰è£…Helm</a></p><p><a href="https://github.com/helm/helm/releases">Releases Â· helm/helm (github.com)</a></p><p>HelmåŒ…æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºï¼Œç›´æ¥è§£å‹å°±å¯ä»¥ç”¨ï¼Œå°†è§£å‹åçš„ helm æ–‡ä»¶æ”¾ç½®åœ¨ /usr/bin/ ä¸‹å³å¯</p><p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬ä¸€é”®å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„helm: <code>curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</code></p><h2 id="æ·»åŠ æº">æ·»åŠ æº</h2><p>æ·»åŠ å¾®è½¯å®¶çš„æºï¼Œå¹¶å‘½åä¸º stable</p><pre><code class="language-bash">helm repo add stable http://mirror.azure.cn/kubernetes/charts/</code></pre><p>åˆ—å‡ºå·²æœ‰çš„æº</p><pre><code class="language-bash">helm repo list</code></pre><p>æŸ¥è¯¢stableæºåŒ…å«çš„åŒ…</p><pre><code class="language-bash">helm search repo stable</code></pre><h2 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h2><h3 id="releaseå‘½ä»¤-v3ç‰ˆæœ¬">releaseå‘½ä»¤(v3ç‰ˆæœ¬)</h3><ul><li><p>install</p><ul><li><code>helm install &lt;release_name&gt; &lt;chart_name&gt; &lt;flag&gt;</code></li><li><code>helm install myelk elastic/elasticsearch --namespace elk -f values.yaml</code></li></ul><blockquote><p>ç›¸åŒçš„åŒ…ï¼Œä¸åŒçš„å®ä¾‹ï¼Œä¹‹é—´æ˜¯ä¸ç›¸å¹²ç‹¬ç«‹ç®¡ç†çš„ã€‚</p></blockquote></li><li><p>delete</p><ul><li><pre><code class="language-bash">helm uninstall &lt;release_name&gt; &lt;flag&gt;</code></pre></li></ul><blockquote><p>flag å¦‚æœæŒ‡å®šâ€“keep-historyï¼Œåˆ™å±äºæ ‡è®°åˆ é™¤ï¼Œä¾ç„¶å¯ä»¥æŸ¥åˆ°çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡ helm rollback æ¢å¤</p></blockquote></li><li><p>upgradeï¼šæ›´æ–°releaseç‰ˆæœ¬ï¼Œæ›´æ–°releaseé…ç½®</p><ul><li><code>helm upgrade &lt;release_name&gt; &lt;chart_name&gt; &lt;flag&gt;</code></li><li>chart_name é€šè¿‡searchå‘½ä»¤æŸ¥æ‰¾</li><li>flag:<ul><li>â€“recreate-pods é‡å»ºæ‰€æœ‰Pod.</li></ul></li></ul></li><li><p>rollbackï¼šå›æ»šreleaseç‰ˆæœ¬</p></li><li><p>list</p></li><li><p>historyï¼šè·å–releaseå†å²ç‰ˆæœ¬</p></li><li><p>statusï¼šè·å–releaseçŠ¶æ€ä¿¡æ¯</p></li><li><p>getï¼šè·å–releaseå·²è®¾ç½®çš„å€¼ã€‚</p><ul><li><pre><code class="language-bash">helm get values &lt;release-name&gt;</code></pre></li></ul></li></ul><h3 id="chartå‘½ä»¤-v3ç‰ˆæœ¬">chartå‘½ä»¤(v3ç‰ˆæœ¬)</h3><ul><li><p>search é€šè¿‡ä¸€ä¸ªå…³é”®è¯æŸ¥æ‰¾ä¸€ä¸ªchatã€‚</p><ul><li><code>helm search repo metallb</code></li></ul></li><li><p>create åˆ›å»ºä¸€ä¸ªchartï¼Œå°†åŒ…å«ä¸€äº›å¿…è¦çš„æ–‡ä»¶</p></li><li><p>fetch ä¸‹è½½å‹ç¼©åŒ…ä½†ä¸å®‰è£…ã€‚å¸¸ç”¨æ¥å®‰è£…å‰è‡ªå®šä¹‰é…ç½®ï¼Œä¾‹å¦‚values.yaml</p></li><li><p>get ä¸‹è½½</p></li><li><p>inspect</p></li><li><p>package æ‰“åŒ…ä¸€ä¸ªchart</p><ul><li><code>helm package &lt;chartæ ¹ç›®å½•&gt;</code></li></ul></li><li><p>verify éªŒè¯ä¸€ä¸ªchart</p></li></ul><h2 id="å®šåˆ¶åŒ–">å®šåˆ¶åŒ–</h2><p>å°±æ˜¯é€šè¿‡å®šåˆ¶åŒ–åŒ…çš„<code>values.yaml</code></p><p>é€šè¿‡ä¸‹åˆ—å‘½ä»¤å¯¼å‡ºåŒ…æ‰€æ”¯æŒçš„æ‰€æœ‰å‚æ•°:</p><pre><code class="language-bash">helm show value &lt;pkg.name&gt;</code></pre><pre><code class="language-bash">âœ   helm show values apphub/nginx  | grep -v '#' | grep -v '^$'image:  registry: docker.io  repository: bitnami/nginx  tag: 1.16.1-debian-10-r0  pullPolicy: IfNotPresentreplicaCount: 1podAnnotations: &#123;&#125;affinity: &#123;&#125;nodeSelector: &#123;&#125;tolerations: &#123;&#125;resources:  limits: &#123;&#125;  requests: &#123;&#125;livenessProbe:  httpGet:    path: /    port: http  initialDelaySeconds: 30  timeoutSeconds: 5  failureThreshold: 6readinessProbe:  httpGet:    path: /    port: http  initialDelaySeconds: 5  timeoutSeconds: 3  periodSeconds: 5service:  type: LoadBalancer  port: 80  httpsPort: 443  nodePorts:    http: &quot;&quot;    https: &quot;&quot;  annotations: &#123;&#125;  externalTrafficPolicy: Clusteringress:  enabled: false  certManager: false  hostname: example.local  annotations: &#123;&#125;  tls:    - hosts:        - example.local      secretName: example.local-tls  secrets:metrics:  enabled: false  image:    registry: docker.io    repository: bitnami/nginx-exporter    tag: 0.5.0-debian-10-r0    pullPolicy: IfNotPresent  podAnnotations:    prometheus.io/scrape: &quot;true&quot;    prometheus.io/port: &quot;9113&quot;  service:    port: 9113    annotations:      prometheus.io/scrape: &quot;true&quot;      prometheus.io/port: &quot;&#123;&#123; .Values.metrics.service.port &#125;&#125;&quot;  resources:    limits: &#123;&#125;    requests: &#123;&#125;  serviceMonitor:    enabled: false</code></pre><p>å¯ä»¥çœ‹åˆ°é…ç½®å¹¶éæ˜¯k8sçš„æ ‡å‡†æ ¼å¼ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> helm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> helm </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>helmâ˜02chart</title>
      <link href="posts/710e3e49/"/>
      <url>posts/710e3e49/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://helm.sh/docs/chart_template_guide/getting_started/">Helm | Getting Started</a></p><p>chartåŒ…ç›®å½•ç»“æ„ï¼š</p><pre><code class="language-bash">wordpress/  Chart.yaml          # å¿…é€‰ï¼šåŒ…å«å½“å‰ chart ä¿¡æ¯çš„ YAML æ–‡ä»¶  values.yaml         # å¿…é€‰ï¼šchart çš„é»˜è®¤é…ç½® values  charts/             # å¿…é€‰ï¼šåŒ…å«è¯¥ chart ä¾èµ–çš„æ‰€æœ‰ chart çš„ç›®å½•  crds/               # å¿…é€‰ï¼šCustom Resource Definitions  templates/          # å¿…é€‰ï¼šæ¨¡æ¿ç›®å½•ï¼Œä¸ values ç»“åˆä½¿ç”¨æ—¶ï¼Œå°†æ¸²æŸ“ç”Ÿæˆ Kubernetes èµ„æºæ¸…å•æ–‡ä»¶  LICENSE             # å¯é€‰ï¼šåŒ…å« chart çš„ license çš„æ–‡æœ¬æ–‡ä»¶  README.md           # å¯é€‰ï¼šä¸€ä¸ªå¯è¯»æ€§é«˜çš„ README æ–‡ä»¶  values.schema.json  # å¯é€‰: ä¸€ä¸ªä½œç”¨åœ¨ values.yaml æ–‡ä»¶ä¸Šçš„ JSON æ¨¡å¼  templates/NOTES.txt # å¯é€‰: åŒ…å«ç®€çŸ­ä½¿ç”¨çš„æ–‡æœ¬æ–‡ä»¶</code></pre><h2 id="åˆ›å»ºæ¡†æ¶">åˆ›å»ºæ¡†æ¶</h2><p>helm create &lt;chartåŒ…å&gt;</p><h2 id="å¿…è¦æ–‡ä»¶">å¿…è¦æ–‡ä»¶</h2><h3 id="Chart-yaml">Chart.yaml</h3><p>Chart.yaml æ–‡ä»¶åŒ…å«chartçš„æè¿°ã€‚æ‚¨å¯ä»¥ä»æ¨¡æ¿ä¸­è®¿é—®å®ƒã€‚ charts/ ç›®å½•å¯èƒ½åŒ…å«å…¶ä»–chartï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºsubchartsï¼‰</p><p>ä¸€ä»½nginxçš„Chat.yamlç¤ºä¾‹ï¼š</p><pre><code class="language-bash">apiVersion: v1                                                                                         appVersion: 1.16.1description: Chart for the nginx serverengine: gotplhome: http://www.nginx.orgicon: https://bitnami.com/assets/stacks/nginx/img/nginx-stack-220x234.pngkeywords:- nginx- http- web- www- reverse proxymaintainers:- email: containers@bitnami.com  name: Bitnaminame: nginxsources:- https://github.com/bitnami/bitnami-docker-nginxversion: 5.1.5</code></pre><h3 id="Templatesç›®å½•">Templatesç›®å½•</h3><p>åŒ…å«ä»¥<code>.yaml</code>ç»“å°¾çš„æ¨¡æ¿æ–‡ä»¶å’Œä»¥<code>.txt</code>ç»“å°¾çš„NOTES.txtæ–‡ä»¶</p><h4 id="NOTES-txt">NOTES.txt</h4><p>Releaseå®‰è£…è¿‡ç¨‹ä¸­çš„è¾“å‡ºæ–‡æœ¬</p><p>Releaseå‘½ä»¤<code>helm status</code>ä¿¡æ¯</p><h4 id="æ¨¡æ¿æ–‡ä»¶">æ¨¡æ¿æ–‡ä»¶</h4><blockquote><p>goæ¨¡æ¿è¯­æ³•</p></blockquote><p><code>&#123;&#123; template "myapp.fullname" &#125;&#125;</code> å¼•ç”¨æ¨¡æ¿ä¿¡æ¯ï¼Œè¿™é‡Œçš„<code>myapp.fullname</code>å³chartçš„å</p><p><code>&#123;&#123; .Values.replicaCount &#125;&#125;</code> è¡¨ç¤º Values.yaml æ–‡ä»¶é‡Œçš„é¡¶çº§ key: replicaCount</p><h2 id="éªŒè¯">éªŒè¯</h2><pre><code class="language-bash"># chart æ ¹è·¯å¾„helm lint .</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> helm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> helm </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜17-1è°ƒåº¦ä¹‹nodeæ±¡æŸ“å’Œpodå®¹å¿</title>
      <link href="posts/932d1f08/"/>
      <url>posts/932d1f08/</url>
      
        <content type="html"><![CDATA[<h1>å¼•ç”¨</h1><p>æ¦‚å¿µæ–‡æ¡£ï¼š<a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/">æ±¡ç‚¹å’Œå®¹å¿åº¦ | Kubernetes</a></p><p>å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#taint">Kubectl Reference Docs (kubernetes.io)</a></p><h1>æ±¡ç‚¹/å®¹å¿æ¦‚å¿µ</h1><p>Nodeä¸Šçš„æ±¡ç‚¹è§„åˆ™ï¼Œå³Nodeå‘ŠçŸ¥è°ƒåº¦å™¨åªæœ‰å¯ä»¥å®¹å¿æ±¡ç‚¹è§„åˆ™çš„Podæ‰å¯ä»¥è°ƒåº¦è¿‡æ¥ã€‚</p><p>Nodeçš„æ±¡ç‚¹è§„åˆ™ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šæ±¡ç‚¹:æ±¡ç‚¹æ•ˆæœã€‚</p><ul><li><p>æ±¡ç‚¹å°±æ˜¯é”®å€¼å¯¹ï¼Œç”¨æ¥æè¿°ä¸€ç§åœºæ™¯ã€‚ä¾‹å¦‚ç½‘ç»œä¸é€šã€ç¡¬ä»¶æ ‡è¯†ï¼ˆä½æ€§èƒ½HDDç£ç›˜ï¼‰ã€ç¯å¢ƒï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰</p></li><li><p>æ±¡ç‚¹æ•ˆæœæ˜¯åˆ¤å®šè§„åˆ™ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šã€‚</p></li></ul><p>Podä¸Šçš„å®¹å¿è§„åˆ™ï¼Œå³Podå‘ŠçŸ¥è°ƒåº¦å™¨å¯ä»¥å®¹å¿Nodeä¸Šè®¾å®šçš„æ±¡ç‚¹è§„åˆ™ã€‚</p><p>ğŸ–å®¹å¿è§„åˆ™å’Œæ±¡ç‚¹è§„åˆ™éƒ½å¯ä»¥æ·»åŠ å¤šä¸ªã€‚</p><h1>æ±¡ç‚¹/å®¹å¿å‘½ä»¤</h1><p>Nodeçš„æ±¡ç‚¹è§„åˆ™ï¼š</p><pre><code class="language-bash"># æ·»åŠ æ±¡ç‚¹## æ ‡ç­¾å¯¹:æ±¡æŸ“å…³é”®è¯kubectl taint nodes &lt;node.name&gt; KEY_1=VAL_1:TAINT_EFFECT_1 KEY_N=VAL_N:TAINT_EFFECT_N# ç§»é™¤æ±¡ç‚¹kubectl taint nodes &lt;node.name&gt; KEY_1-# æŸ¥çœ‹èŠ‚ç‚¹æ±¡æŸ“ä¿¡æ¯ï¼Œè‹¥æ— æ±¡æŸ“åˆ™ä¸º nonekubectl describe nodes &lt;node.name&gt; | grep TaintsTaints:             node-role.kubernetes.io/master:NoSchedule</code></pre><p>Podå®¹å¿è§„åˆ™ï¼š</p><pre><code class="language-yaml">tolerations:- key: &quot;key1&quot;  operator: &quot;Equal&quot;  value: &quot;value1&quot;  effect: &quot;NoSchedule&quot;</code></pre><p>operator å¯ä»¥æ˜¯Equalç­‰äºæˆ–è€…Existså­˜åœ¨ã€‚</p><h1>è°ƒåº¦é€»è¾‘</h1><p>é¦–å…ˆï¼ŒPodçš„å®¹å¿è§„åˆ™éœ€è¦å®Œå…¨ç­‰åŒäºæ±¡ç‚¹è§„åˆ™ï¼Œå³æ±¡ç‚¹å’Œæ±¡ç‚¹æ•ˆæœéƒ½ä¸€è‡´æ‰ç®—æ˜¯åŒ¹é…æˆåŠŸã€‚ä½†å­˜åœ¨ç‰¹æ®Šæƒ…å†µï¼š</p><ul><li>ä»…å®šä¹‰äº†<code>operator:Exists</code>ï¼Œåˆ™è¡¨ç¤ºåŒ¹é…ä»»æ„æ±¡ç‚¹è§„åˆ™ã€‚</li><li>ä»…å®šä¹‰äº†æ±¡ç‚¹ï¼Œæ²¡æœ‰å®šä¹‰æ±¡ç‚¹æ•ˆæœï¼Œåˆ™è¡¨ç¤ºåŒ¹é…è¿™ä¸ªæ±¡ç‚¹çš„æ‰€æœ‰æ•ˆæœã€‚</li></ul><p>å…¶æ¬¡ï¼Œå½“Nodeçš„æ±¡ç‚¹è§„åˆ™æœ‰å¤šä¸ªçš„æ—¶å€™ï¼Œè°ƒåº¦å™¨ä¼šå°†Podçš„å®¹å¿è§„åˆ™ä¸ä¹‹ä¸€ä¸€åŒ¹é…ã€‚å°±å¦‚åŒå°å­¦é¢˜é‡Œé‚£ç§è¿çº¿é¢˜ä¸€æ ·ã€‚</p><p>æœ€åï¼Œè‹¥éƒ½å¯ä»¥åŒ¹é…ï¼Œåˆ™Podå¯ä»¥è°ƒåº¦è¿›å»ã€‚ä½†åªè¦å­˜åœ¨ä¸€ä¸ªä¸åŒ¹é…çš„æ±¡ç‚¹è§„åˆ™ï¼Œé‚£ä¹ˆè°ƒåº¦å™¨å°±éœ€è¦ä¾æ®è¿™ä¸ªæ±¡ç‚¹è§„åˆ™çš„æ±¡ç‚¹æ•ˆæœæ¥åˆ¤æ–­Podçš„è¿›/é€€ï¼š</p><ul><li>è¿›ï¼šé’ˆå¯¹è¿˜æœªåˆ›å»ºçš„Podï¼Œæ˜¯å¦å°†Podè°ƒåº¦è¿›å»ã€‚</li><li>é€€ï¼šé’ˆå¯¹å·²ç»åˆ›å»ºçš„Podï¼Œæ˜¯å¦å°†Podé©±é€æ»šè›‹ã€‚</li></ul><h1>æ±¡ç‚¹æ•ˆæœ</h1><p>ä¸€èˆ¬æƒ…å†µï¼Œè‹¥Nodeå­˜åœ¨ä¸‹åˆ—æ±¡ç‚¹æ•ˆæœï¼Œè°ƒåº¦å™¨çš„é€»è¾‘æ˜¯ï¼š</p><p><code>NoSchedule</code> è¡¨ç¤ºè°ƒåº¦å™¨ä¸å¯è°ƒåº¦ã€è¿˜æœªåˆ›å»ºçš„ã€‘Podåˆ°æ­¤èŠ‚ç‚¹ã€‚</p><p><code>PreferNoSchedule</code>è¡¨ç¤ºå°½é‡ä¸è¦è°ƒåº¦ã€è¿˜æœªåˆ›å»ºçš„ã€‘Podåˆ°æ­¤èŠ‚ç‚¹ã€‚</p><p><code>NoExecute</code> è¡¨ç¤ºç»ä¸å…è®¸è°ƒåº¦Podåˆ°æ­¤èŠ‚ç‚¹ï¼Œå“ªæ€•Podã€å·²ç»åˆ›å»ºã€‘éƒ½ä¼šè¢«é©±é€ã€‚</p><p>é’ˆå¯¹ã€NoExecuteã€‘ï¼Œè‹¥å¯ä»¥ã€åŒ¹é…NoExecuteã€‘çš„Podé‡ŒåŒ…å«äº†é¢å¤–çš„å®½æ•æœŸè§„åˆ™<code>tolerationSeconds</code>ï¼Œåˆ™Podã€ä»…å¯ä»¥ã€‘åœ¨<code>tolerationSeconds</code>å®½æ•æœŸä¹‹å†…è¿è¡Œã€‚</p><p>ğŸ¤¦â€â™‚ï¸ç»æµ‹è¯•ï¼Œå³ä½¿æ˜¯æ±¡ç‚¹è§„åˆ™æ·»åŠ ä¹‹åçš„Podï¼Œä¹Ÿåªå¯ä»¥åœ¨<code>tolerationSeconds</code>å†…è¿è¡Œã€‚å› æ­¤è¿™ä¸ªå®½æ•æœŸä¸å¦‚ç§°ä¹‹ä¸ºã€å¯è¿è¡Œæ—¶é—´ã€‘ã€‚</p><p><a href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/#taint-based-evictions">https://kubernetes.io/zh/docs/concepts/scheduling-eviction/taint-and-toleration/#taint-based-evictions</a></p><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: nginx  labels:    env: testspec:  containers:  - name: nginx    image: nginx    imagePullPolicy: IfNotPresent  tolerations:  - key: &quot;example-key&quot;    operator: &quot;Exists&quot;    effect: &quot;NoExecute&quot;    tolerationSeconds: 3600</code></pre><p>ä¸Šè¿°é…ç½®è¡¨ç¤ºï¼Œå½“ pod æ‰€åœ¨èŠ‚ç‚¹è¢«æ·»åŠ äº†ä¸€ä¸ª<code>example-key:NoExecute</code> æ±¡ç‚¹çš„æ—¶å€™ï¼Œpod å°†ä¸ä¼šè¢«é©±é€ï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­å­˜æ´»3600ç§’ï¼Œå¦‚æœè¿˜æœªåˆ°3600ç§’ï¼Œæ±¡ç‚¹å°±è¢«ç§»é™¤ï¼Œåˆ™ pod é©±é€ä¹Ÿä¼šåœæ­¢ã€‚</p><h1>è‡ªåŠ¨æ±¡ç‚¹è§„åˆ™</h1><p>å½“æŸç§æ¡ä»¶ä¸ºçœŸæ—¶ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨ä¼šè‡ªåŠ¨ç»™èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹ã€‚å½“å‰å†…ç½®çš„æ±¡ç‚¹åŒ…æ‹¬ï¼š</p><ul><li><code>node.kubernetes.io/not-ready:NoExecute</code>ï¼šèŠ‚ç‚¹æœªå‡†å¤‡å¥½ã€‚è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶æ€ <code>Ready</code> çš„å€¼ä¸º â€œ<code>False</code>â€ã€‚</li><li><code>node.kubernetes.io/unreachable:NoExecute</code>ï¼šèŠ‚ç‚¹æ§åˆ¶å™¨è®¿é—®ä¸åˆ°èŠ‚ç‚¹. è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶æ€ <code>Ready</code> çš„å€¼ä¸º â€œ<code>Unknown</code>â€ã€‚</li><li><code>node.kubernetes.io/memory-pressure:NoSchedule</code>ï¼šèŠ‚ç‚¹å­˜åœ¨å†…å­˜å‹åŠ›ã€‚</li><li><code>node.kubernetes.io/disk-pressure:NoSchedule</code>ï¼šèŠ‚ç‚¹å­˜åœ¨ç£ç›˜å‹åŠ›ã€‚</li><li><code>node.kubernetes.io/pid-pressure:NoSchedule</code>: èŠ‚ç‚¹çš„ PID å‹åŠ›ã€‚</li><li><code>node.kubernetes.io/network-unavailable:NoSchedule</code>ï¼šèŠ‚ç‚¹ç½‘ç»œä¸å¯ç”¨ã€‚</li><li><code>node.kubernetes.io/unschedulable:NoSchedule</code>: èŠ‚ç‚¹ä¸å¯è°ƒåº¦ã€‚</li><li><code>node.cloudprovider.kubernetes.io/uninitialized</code>ï¼šå¦‚æœ kubelet å¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ª â€œå¤–éƒ¨â€ äº‘å¹³å°é©±åŠ¨ï¼Œ å®ƒå°†ç»™å½“å‰èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹å°†å…¶æ ‡å¿—ä¸ºä¸å¯ç”¨ã€‚åœ¨ cloud-controller-manager çš„ä¸€ä¸ªæ§åˆ¶å™¨åˆå§‹åŒ–è¿™ä¸ªèŠ‚ç‚¹åï¼Œkubelet å°†åˆ é™¤è¿™ä¸ªæ±¡ç‚¹ã€‚</li></ul><p>åœ¨èŠ‚ç‚¹è¢«é©±é€çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨æˆ–è€… kubelet ä¼šæ·»åŠ å¸¦æœ‰ <code>NoExecute</code> æ±¡ç‚¹æ•ˆæœçš„ç›¸å…³å†…ç½®æ±¡ç‚¹ã€‚å¼‚å¸¸æ¢å¤çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç§»é™¤æ±¡ç‚¹ã€‚</p><blockquote><p>ğŸ¤·â€â™‚ï¸å…³äºç”¨<code>kubectl drain</code>æ‰§è¡Œé©±é€çš„æ—¶å€™ï¼Œ<a href="http://xn--nodenode-309lrnu35cx15cpfcfz3aulp50vcrk.kubernetes.io/unschedulable:NoSchedule%E3%80%82%E4%BD%86%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C%E6%98%AF">nodeæ˜¾ç¤ºçš„æ±¡ç‚¹åªæœ‰ä¸€ä¸ªnode.kubernetes.io/unschedulable:NoScheduleã€‚ä½†å®é™…æ•ˆæœæ˜¯</a><code>node.kubernetes.io/unschedulable:NoExecute</code>ã€‚å³é©±é€å‘½ä»¤ä¼šé©±é€æ‰å·²å­˜åœ¨çš„Podã€‚å¯èƒ½<code>kubectl drain</code>ä¼šæ·»åŠ å†…ç½®çš„ç‰¹æ®Šæ±¡ç‚¹æ•ˆæœã€‚</p><pre><code class="language-bash">âœ   kubectl drain k8s03 --ignore-daemonsets --delete-emptydir-dataâœ   kubectl describe node k8s03 | grep TaintsTaints:             node.kubernetes.io/unschedulable:NoSchedule</code></pre></blockquote><p>å¦‚æœä½ æƒ³è®©æŸä¸ªpodåœ¨èŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼ˆä¾‹å¦‚èŠ‚ç‚¹ç½‘ç»œæ•…éšœï¼‰åï¼Œä¾ç„¶è¢«è°ƒåº¦åœ¨å½“å‰èŠ‚ç‚¹ä¿æŒ1å°æ—¶ï¼Œé‚£ä¹ˆä½ å¯ä»¥æ·»åŠ ä¸‹åˆ—å®¹å¿è§„åˆ™ï¼š</p><pre><code class="language-yaml">tolerations:- key: &quot;node.kubernetes.io/network-unavailable&quot;  operator: &quot;Exists&quot;  effect: &quot;NoExecute&quot;  tolerationSeconds: 3600</code></pre><h1>è‡ªåŠ¨å®¹å¿è§„åˆ™</h1><p>Kubernetes ä¼šè‡ªåŠ¨ç»™ Pod æ·»åŠ å†…ç½®æ±¡ç‚¹ <code>node.kubernetes.io/not-ready:NoExecute</code> çš„å®¹å¿åº¦å¹¶é…ç½® <code>tolerationSeconds=300</code>ï¼Œé™¤éç”¨æˆ·æä¾›çš„ Pod é…ç½®ä¸­å·²ç»å·²å­˜åœ¨äº† key ä¸º <code>node.kubernetes.io/not-ready</code> çš„å®¹å¿åº¦ã€‚</p><p>Kubernetes ä¼šè‡ªåŠ¨ç»™ Pod æ·»åŠ å†…ç½®æ±¡ç‚¹ <code>node.kubernetes.io/unreachable:NoExecute</code> çš„å®¹å¿åº¦å¹¶é…ç½® <code>tolerationSeconds=300</code>ï¼Œé™¤éç”¨æˆ·æä¾›çš„ Pod é…ç½®ä¸­å·²ç»å·²å­˜åœ¨äº† key ä¸º <code>node.kubernetes.io/unreachable</code> çš„å®¹å¿åº¦ã€‚</p><p>è¿™æ„å‘³ç€åœ¨å…¶ä¸­ä¸€ç§é—®é¢˜è¢«æ£€æµ‹åˆ°æ—¶ Pod é»˜è®¤èƒ½å¤Ÿç»§ç»­åœç•™åœ¨å½“å‰èŠ‚ç‚¹è¿è¡Œ 5 åˆ†é’Ÿã€‚</p><p>ä½†æ˜¯ï¼Œå¯¹äºDaemonSetçš„Podï¼Œåˆ™ä¸ä¼šé…ç½®<code>tolerationSeconds</code>ã€‚è¿™æ„å‘³ç€ï¼ŒNodeå‡ºç°ä¸Šè¿°é—®é¢˜åï¼Œè¿™ç±»Podå°†æ°¸ä¹…è¿è¡Œä¸è¢«é©±é€ã€‚</p><p>DaemonSetçš„è‡ªåŠ¨é™„åŠ å®¹å¿åº¦ï¼š</p><pre><code class="language-yaml">node.kubernetes.io/disk-pressure:NoSchedule op=Existsnode.kubernetes.io/memory-pressure:NoSchedule op=Existsnode.kubernetes.io/network-unavailable:NoSchedule op=Existsnode.kubernetes.io/pid-pressure:NoSchedule op=Existsnode.kubernetes.io/unschedulable:NoSchedule op=Existsnode.kubernetes.io/not-ready:NoExecute op=Existsnode.kubernetes.io/unreachable:NoExecute op=Exists</code></pre><p>ğŸ–DaemonSetä¸­é™¤äº†ä¸Šè¿°è‡ªåŠ¨å®¹å¿åº¦ï¼Œè¿˜ç»å¸¸è§åˆ°ä¸‡èƒ½å®¹å¿åº¦<code>:NoSchedule op=Exists æˆ–è€… op=Exists</code>ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜18æ—¥å¿—ç³»ç»Ÿ</title>
      <link href="posts/451721ed/"/>
      <url>posts/451721ed/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>k8sçš„é›†ç¾¤æ—¥å¿—æ”¶é›†ç»“æ„ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸‹é¢å‡ ç§ï¼š</p><ol><li>é›†ç¾¤æ¨¡å¼ï¼ŒèŠ‚ç‚¹çº§æ”¶é›†å™¨ï¼ŒèŠ‚ç‚¹çº§æ”¶é›†å™¨æ”¶é›†</li><li>è¾¹è½¦å®¹å™¨æ¨¡å¼ï¼Œè¾¹è½¦å®¹å™¨åªè´Ÿè´£å°†æ—¥å¿—æµå¼ä¼ è¾“åˆ°stdoutå’Œstderrï¼ŒèŠ‚ç‚¹çº§æ”¶é›†å™¨è¿›è¡Œæ”¶é›†</li><li>è¾¹è½¦å®¹å™¨æ¨¡å¼ï¼Œè¾¹è½¦å®¹å™¨ç›´æ¥ä»åº”ç”¨ç¨‹åºé‚£æ”¶é›†æ—¥å¿—ï¼Œè¾¹è½¦çº§æ”¶é›†å™¨è¿›è¡Œæ”¶é›†</li></ol>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusâ˜04mysqlç›‘æ§</title>
      <link href="posts/6178b477/"/>
      <url>posts/6178b477/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://awesome-prometheus-alerts.grep.to/rules#mysql">Awesome Prometheus alerts | Collection of alerting rules (grep.to)</a></p><p><a href="https://github.com/prometheus/mysqld_exporter">prometheus/mysqld_exporter: Exporter for MySQL server metrics (github.com)</a></p><p><a href="https://registry.hub.docker.com/r/prom/mysqld-exporter/">prom/mysqld-exporter (docker.com)</a></p><h2 id="å®‰è£…">å®‰è£…</h2><h3 id="æ·»åŠ mysqlè´¦æˆ·">æ·»åŠ mysqlè´¦æˆ·</h3><pre><code class="language-bash">CREATE USER 'exporter'@'&lt;å±€åŸŸç½‘æˆä¿¡IP&gt;' IDENTIFIED BY 'exporter@123';GRANT PROCESS, REPLICATION CLIENT ON *.* TO 'exporter'@'&lt;å±€åŸŸç½‘æˆä¿¡IP&gt;';GRANT SELECT ON performance_schema.* TO 'exporter'@'&lt;å±€åŸŸç½‘æˆä¿¡IP&gt;';</code></pre><pre><code class="language-bash">docker run -d --net promsnet --name mysqld-exporter -p 9104:9104 --link=my_mysql_container:&lt;è¢«ç›‘æ§çš„mysqlå®¹å™¨å&gt;  \  -e DATA_SOURCE_NAME=&quot;exporter:exporter@123@(&lt;è¢«ç›‘æ§çš„mysqlå®¹å™¨å or è¢«ç›‘æ§çš„mysqlå®ä¾‹åœ°å€&gt;:3306)/&quot; prom/mysqld-exporter</code></pre><blockquote><p>â€“link å¯é€‰ï¼Œå…³è”è¢«ç›‘æ§çš„å®¹å™¨æ•°æ®åº“</p></blockquote><h2 id="prometheus-ä¸»é…ç½®">prometheus ä¸»é…ç½®</h2><pre><code class="language-yaml">scrape_configs:  - job_name: 'mysql-001'    static_configs:      - targets: ['mysqld-exporter:9104'] # mysqld-exporter é‡‡é›†å™¨åœ°å€        labels:          instance: &lt;mysql_server_path&gt;:3306 # å˜æ›´é‡‡é›†åçš„æ ‡ç­¾instanceä¸ºmysqlå®ä¾‹åœ°å€</code></pre><h2 id="prometheus-å‘Šè­¦é…ç½®">prometheus å‘Šè­¦é…ç½®</h2><pre><code class="language-yaml">groups:  - name: mysql-alert    rules:    - alert: MysqlDown      expr: mysql_up == 0      for: 0m      labels:        severity: critical      annotations:        summary: MySQL down (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;MySQL instance is down on &#123;&#123; $labels.instance &#125;&#125;\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: MysqlTooManyConnections(&gt;80%)      expr: avg by (instance) (rate(mysql_global_status_threads_connected[1m])) / avg by (instance) (mysql_global_variables_max_connections) * 100 &gt; 80      for: 2m      labels:        severity: warning      annotations:        summary: MySQL too many connections (&gt; 80%) (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;More than 80% of MySQL connections are in use on &#123;&#123; $labels.instance &#125;&#125;\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: MysqlRestarted      expr: mysql_global_status_uptime &lt; 60      for: 0m      labels:        severity: info      annotations:        summary: MySQL restarted (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;MySQL has just been restarted, less than one minute ago on &#123;&#123; $labels.instance &#125;&#125;.\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: MysqlHighThreadsRunning      expr: avg by (instance) (rate(mysql_global_status_threads_running[1m])) / avg by (instance) (mysql_global_variables_max_connections) * 100 &gt; 60      for: 2m      labels:        severity: warning      annotations:        summary: MySQL high threads running (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;More than 60% of MySQL connections are in running state on &#123;&#123; $labels.instance &#125;&#125;\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;</code></pre><h2 id="grafana">grafana</h2><p><a href="https://grafana.com/grafana/dashboards/7362">https://grafana.com/grafana/dashboards/7362</a></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusâ˜04redisç›‘æ§</title>
      <link href="posts/978d0c1d/"/>
      <url>posts/978d0c1d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://awesome-prometheus-alerts.grep.to/rules#redis">Awesome Prometheus alerts | Collection of alerting rules (grep.to)</a></p><p><a href="https://github.com/oliver006/redis_exporter">oliver006/redis_exporter: Prometheus Exporter for Redis Metrics. Supports Redis 2.x, 3.x, 4.x, 5.x and 6.x (github.com)</a></p><p><a href="https://hub.docker.com/r/oliver006/redis_exporter/">oliver006/redis_exporter (docker.com)</a></p><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash">docker run -d --net promsnet --name redis_exporter -p 9121:9121 oliver006/redis_exporter -web.listen-address 0.0.0.0:9121 --redis.addr=</code></pre><blockquote><p>å¦‚æœä¸æ·»åŠ  --redis.addr=ï¼Œåˆ™ redis_exporter ä¼šè‡ªåŠ¨æ·»åŠ  redis://localhost:6379ï¼Œå¦‚æœ redis_exporter éƒ¨ç½²çš„å®¿ä¸»æœºæ— æ³•è®¿é—® redis://localhost:6379ï¼Œåˆ™ä¼šå¯¼è‡´ proms æŠ¥ä¸€ä¸ªå®ä¾‹ down æ‰ã€‚</p></blockquote><h2 id="prometheus-ä¸»é…ç½®">prometheus ä¸»é…ç½®</h2><pre><code class="language-yaml">scrape_configs:  - job_name: 'redis'    metrics_path: /scrape    relabel_configs:    - source_labels: [__address__]      target_label: __param_target    - source_labels: [__param_target]      target_label: instance    - target_label: __address__      replacement: &lt;redis_exporteråœ°å€&gt;:9121    static_configs:    - targets:      - redis://&lt;è¢«ç›‘æ§çš„redisåœ°å€01&gt;:6379      - redis://&lt;è¢«ç›‘æ§çš„redisåœ°å€02&gt;:6379  - job_name: 'redis_exporter'    static_configs:      - targets:        - redis_exporter:9121</code></pre><h2 id="prometheus-å‘Šè­¦é…ç½®">prometheus å‘Šè­¦é…ç½®</h2><pre><code class="language-yaml">groups:  - name: redis-alert    rules:    - alert: RedisDown      expr: redis_up == 0      for: 0m      labels:        severity: critical      annotations:        summary: Redis down (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;Redis instance is down\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: RedisOutOfSystemMemory      expr: redis_memory_used_bytes / redis_total_system_memory_bytes * 100 &gt; 90      for: 2m      labels:        severity: warning      annotations:        summary: Redis out of system memory (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;Redis is running out of system memory (&gt; 90%)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: RedisOutOfConfiguredMaxmemory      expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 &gt; 90      for: 2m      labels:        severity: warning      annotations:        summary: Redis out of configured maxmemory (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;Redis is running out of configured maxmemory (&gt; 90%)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: RedisTooManyConnections      expr: redis_connected_clients &gt; 100      for: 2m      labels:        severity: warning      annotations:        summary: Redis too many connections (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;Redis instance has too many connections\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: RedisNotEnoughConnections      expr: redis_connected_clients &lt; 5      for: 2m      labels:        severity: warning      annotations:        summary: Redis not enough connections (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;Redis instance should have more connections (&gt; 5)\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;    - alert: RedisRejectedConnections      expr: increase(redis_rejected_connections_total[1m]) &gt; 0      for: 0m      labels:        severity: critical      annotations:        summary: Redis rejected connections (instance &#123;&#123; $labels.instance &#125;&#125;)        description: &quot;Some connections to Redis has been rejected\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;</code></pre><h2 id="grafana">grafana</h2><p><a href="http://www.eryajf.net/go?url=https://grafana.com/dashboards/763">https://grafana.com/dashboards/763</a></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusâ˜06rabbitmqç›‘æ§</title>
      <link href="posts/7fd13722/"/>
      <url>posts/7fd13722/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://awesome-prometheus-alerts.grep.to/rules#rabbitmq">Awesome Prometheus alerts | Collection of alerting rules (grep.to)</a></p><p><a href="https://www.rabbitmq.com/prometheus.html">Monitoring with Prometheus &amp; Grafana â€” RabbitMQ</a></p><p><a href="https://grafana.com/grafana/dashboards/10991">RabbitMQ-Overview dashboard for Grafana | Grafana Labs</a></p><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash">rabbitmq-plugins enable rabbitmq_prometheusrabbitmqctl -q set_cluster_name test@rabbitmq</code></pre><p>15692 ç«¯å£æ˜¯ prometheus é‡‡é›†å™¨çš„æš´éœ²ç«¯å£ï¼Œdockeræ–¹å¼é»˜è®¤é‡‡é›†æ’ä»¶å·²ç»å¼€å¯ã€‚</p><p>å®¿ä¸»æœºé‡Œæ‰§è¡Œ <code>curl -s localhost:15692/metrics | head -n 3</code>ç¡®ä¿å¯ä»¥è¿”å›é‡‡é›†å™¨æ•°æ®ã€‚</p><h2 id="prometheus-ä¸»é…ç½®">prometheus ä¸»é…ç½®</h2><pre><code class="language-yaml">scrape_configs:  - job_name: 'rabbitmq-001'    static_configs:      - targets: ['&lt;rabbitmqåœ°å€&gt;:15692'] </code></pre><h2 id="prometheus-å‘Šè­¦é…ç½®">prometheus å‘Šè­¦é…ç½®</h2><pre><code class="language-yaml">groups:  - name: mysql-alert    rules:      - alert: RabbitmqNodeDown        expr: sum(rabbitmq_build_info) &lt; 3        for: 0m        labels:          severity: critical        annotations:          summary: Rabbitmq node down (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;Less than 3 nodes running in RabbitMQ cluster\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqNodeNotDistributed        expr: erlang_vm_dist_node_state &lt; 3        for: 0m        labels:          severity: critical        annotations:          summary: Rabbitmq node not distributed (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;Distribution link state is not 'up'\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqInstancesDifferentVersions        expr: count(count(rabbitmq_build_info) by (rabbitmq_version)) &gt; 1        for: 1h        labels:          severity: warning        annotations:          summary: Rabbitmq instances different versions (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;Running different version of Rabbitmq in the same cluster, can lead to failure.\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqMemoryHigh        expr: rabbitmq_process_resident_memory_bytes / rabbitmq_resident_memory_limit_bytes * 100 &gt; 90        for: 2m        labels:          severity: warning        annotations:          summary: Rabbitmq memory high (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;A node use more than 90% of allocated RAM\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqFileDescriptorsUsage        expr: rabbitmq_process_open_fds / rabbitmq_process_max_fds * 100 &gt; 90        for: 2m        labels:          severity: warning        annotations:          summary: Rabbitmq file descriptors usage (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;A node use more than 90% of file descriptors\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqTooMuchUnack        expr: sum(rabbitmq_queue_messages_unacked) BY (queue) &gt; 1000        for: 1m        labels:          severity: warning        annotations:          summary: Rabbitmq too much unack (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;Too much unacknowledged messages\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqTooMuchConnections        expr: rabbitmq_connections &gt; 1000        for: 2m        labels:          severity: warning        annotations:          summary: Rabbitmq too much connections (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;The total connections of a node is too high\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqNoQueueConsumer        expr: rabbitmq_queue_consumers &lt; 1        for: 1m        labels:          severity: warning        annotations:          summary: Rabbitmq no queue consumer (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;A queue has less than 1 consumer\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;      - alert: RabbitmqUnroutableMessages        expr: increase(rabbitmq_channel_messages_unroutable_returned_total[1m]) &gt; 0 or increase(rabbitmq_channel_messages_unroutable_dropped_total[1m]) &gt; 0        for: 2m        labels:          severity: warning        annotations:          summary: Rabbitmq unroutable messages (instance &#123;&#123; $labels.instance &#125;&#125;)          description: &quot;A queue has unroutable messages\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;</code></pre><h2 id="grafana">grafana</h2><p><a href="https://grafana.com/grafana/dashboards/10991">https://grafana.com/grafana/dashboards/10991</a></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> prometheus </tag>
            
            <tag> rabbitmq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>aliyuncliâ˜å®‰è£…å’ŒåŸºæœ¬è°ƒç”¨</title>
      <link href="posts/6df9bb76/"/>
      <url>posts/6df9bb76/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>aliyun cliæŒ‡ä»¤è¿˜ä¸æ˜¯å¤ªå®Œå–„ï¼Œå¹¶ä¸æ˜¯å®Œå…¨æ”¯æŒæ‰€æœ‰çš„é˜¿é‡Œäº‘äº§å“ï¼Œå¯¹æ ‡çš„æ˜¯awscli</p><p>å› æ­¤ï¼Œå»ºè®®æ—¶åˆ»å…³æ³¨ <a href="https://github.com/aliyun/aliyun-cli/releases">https://github.com/aliyun/aliyun-cli/releases</a> äº§å“å˜åŒ–é¡µé¢ã€‚</p><h1>å®‰è£…</h1><pre><code class="language-bash">wget 'https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz'tar xf aliyun-cli-linux-latest-amd64.tgz</code></pre><p>ğŸ’è¿‘æœŸçš„é‡è¦å˜åŒ–</p><p>3.0.40 - 3.0.42ç‰ˆæœ¬åŠ å…¥é…ç½®å˜é‡</p><p><code>ALIBABACLOUD_ACCESS_KEY_ID</code>, <code>ALICLOUD_ACCESS_KEY_ID</code></p><p><code>ALIBABACLOUD_ACCESS_KEY_SECRET</code>, <code>ALICLOUD_ACCESS_KEY_SECRET</code></p><p><code>ALIBABACLOUD_REGION_ID</code>, <code>ALICLOUD_REGION_ID</code></p><h1>å•ç”¨æˆ·æˆæƒé…ç½®</h1><pre><code class="language-bash"># æŸ¥çœ‹å½“å‰é…ç½®aliyun configure listProfile             | Credential         | Valid   | Region           | Language---------           | ------------------ | ------- | ---------------- | --------default             | AK:***             | Invalid |                  | enecsRamRoleProfile * | EcsRamRole:gitlab  | Valid   | cn-zhangjiakou   | en# åˆ‡æ¢é…ç½®aliyun configure set --profile &lt;profile_name&gt;# æ·»åŠ é…ç½®ï¼Œä¾‹å¦‚ ecsramrole æ¨¡å¼# https://help.aliyun.com/document_detail/121193.html?spm=a2c4g.11186623.3.4.35af3ae51h8w8Maliyun configure set \   --profile ecsRamRoleProfile \  --mode EcsRamRole \  --ram-role-name RoleName \  --region cn-hangzhou</code></pre><h1>å…¨å±€ç”¨æˆ·æˆæƒé…ç½®ï¼ˆroleæ¨¡å¼ï¼‰</h1><pre><code class="language-bash">cat &lt;&lt; 'EOF'| sudo tee /etc/profile.d/ecs_role.shRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`ramRoleName=`curl -sq http://100.100.100.200/latest/meta-data/ram/security-credentials/`aliyun configure set --profile ecsRamRoleProfile  --mode EcsRamRole --ram-role-name $&#123;ramRoleName&#125; --region $&#123;Region&#125;EOF</code></pre><h1>kubernetesä¸­é…ç½®EcsRamRole</h1><pre><code class="language-yaml">      annotations:        k8s.aliyun.com/eci-ram-role-name: role_name</code></pre><h1>alpine Dockerä¸­è°ƒç”¨aliyunå‘½ä»¤</h1><pre><code class="language-bash">apk add --no-cache libc6-compat musl</code></pre><h1>åŸºæœ¬ä½¿ç”¨</h1><p>ä»¥ oss ä¸ºä¾‹ï¼š</p><pre><code class="language-bash">## è®¾å®š oss çš„endpoint åœ°å€ï¼Œè¿™é‡Œä»¥å†…ç½‘åœ°å€ä¸ºä¾‹Endpoint=&quot;http://oss-$&#123;Region&#125;-internal.aliyuncs.com&quot;##æŸ¥è¯¢## é»˜è®¤æŸ¥è¯¢æ˜¯é€’å½’æŸ¥è¯¢ï¼Œ-d åªæŸ¥è¯¢ä¸€å±‚aliyun oss ls oss://test/ -d -e $&#123;Endpoint&#125;##åŸºæœ¬çš„ä¸Šä¼ æˆ–ä¸‹è½½##ä¸Šä¼ æ–‡ä»¶ a.file åˆ° oss://test/ aliyun oss cp a.file oss://test/ -e $&#123;Endpoint&#125;##åŸºæœ¬çš„é€’å½’ä¸Šä¼ ##ä¸Šä¼ ç›®å½• abc ä¸‹çš„æ–‡ä»¶åˆ° oss://test/ ä¸‹ï¼Œå¦‚æœæœ‰é‡å¤å†…å®¹ï¼Œåˆ™éœ€è¦åŠ å…¥ --forcealiyun oss cp abc oss://test/ --recursive -e $&#123;Endpoint&#125;##å¤æ‚çš„é€’å½’ä¸Šä¼ ##ä¸Šä¼ ç›®å½• abc ä¸‹çš„ .lzo ç»“å°¾çš„æ–‡ä»¶åˆ° oss://test/ ä¸‹.##ä¸¥ç¦åœ¨æºç›®å½•é‡Œæ‰§è¡Œ --recursive å‚æ•°.##å³ç¦æ­¢æ‰§è¡Œ aliyun oss cp . oss://test/ --recursive aliyun oss cp abc/ oss://test/ --include='*.lzo' --update --recursive -e $&#123;Endpoint&#125; --checkpoint-dir=/tmp/ossutil_checkpoint --output-dir=/tmp/ossutil_output##åŒæ­¥ç›®å½• sync æŒ‡ä»¤å˜æ›´##åŒæ­¥ç›®å½• abc ä¸‹çš„æ–‡ä»¶åˆ° oss://test/ ä¸‹ï¼Œå¦‚æœ‰é‡å¤ï¼Œåˆ™å¿½ç•¥;åŒæ—¶åˆ é™¤ç›®æ ‡ç›®å½•ä¸‹æœ¬åœ°æ²¡æœ‰çš„æ–‡ä»¶aliyun oss sync abc/ oss://test/ --update --delete --force -e $&#123;Endpoint&#125; --checkpoint-dir=/tmp/ossutil_checkpoint --output-dir=/tmp/ossutil_output</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aliyun </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aliyun </tag>
            
            <tag> cli </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cssâ˜èƒŒæ™¯å›¾å±…ä¸­æ‹‰ä¼¸å¹³é“º</title>
      <link href="posts/fa5680b3/"/>
      <url>posts/fa5680b3/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-css">background: url('backend.jpg') center center no-repeat;background-attachment: fixed;  background-size: cover;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> css </category>
          
      </categories>
      
      
        <tags>
            
            <tag> css </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œâ˜é“¾è·¯èšåˆ</title>
      <link href="posts/6f53a6b8/"/>
      <url>posts/6f53a6b8/</url>
      
        <content type="html"><![CDATA[<h2 id="ç›®çš„">ç›®çš„</h2><p>æ‰©å®½ç½‘ç»œï¼Œçªç ´å•è·¯</p><p>ä¾‹å¦‚åŸæœ¬æ˜¯å•è·¯åƒå…†ï¼Œæ‰©æˆåŒè·¯å¹¶å‘åƒå…†</p><p>æ–‡æ¡£é‡Œçš„èšåˆç±»å‹å‡ä¸ºåŠ¨æ€èšåˆ</p><h2 id="H3Cäº¤æ¢æœº-å‰¯-å…¶å®ƒäº¤æ¢æœº">H3Cäº¤æ¢æœº(å‰¯) - å…¶å®ƒäº¤æ¢æœº</h2><pre><code class="language-bash"># åˆ›å»ºè¿æ¥å…¶å®ƒäº¤æ¢æœºçš„èšåˆæ¥å£# èšåˆæ¥å£åºå· 1# èšåˆæ¥å£è®¾ç½®ä¸º trunk æ¨¡å¼ï¼Œ å¹¶å…è®¸æ‰€æœ‰ vlan é€šè¿‡# èšåˆæ¥å£æ¨¡å¼è®¾ç½®ä¸ºåŠ¨æ€èšåˆinterface Bridge-Aggregation 1 port link-type trunk port trunk permit vlan all link-aggregation mode dynamic # æ·»åŠ æ™®é€šç«¯å£ 1-4 åˆ°èšåˆæ¥å£# è®¾ç½®æ™®é€šç«¯å£ä¸º trunk æ¨¡å¼ï¼Œå¹¶å…è®¸æ‰€æœ‰ vlan é€šè¿‡interface range GigabitEthernet1/0/1 to GigabitEthernet1/0/4 port link-type trunk port trunk permit vlan all port link-aggregation group 1</code></pre><blockquote><p>å…³äºæ™®é€šç«¯å£æ˜¯å¦è®¾ç½® link-typeï¼Œå¾ˆå¤šæ–‡æ¡£é‡Œæ²¡æœ‰æåŠï¼Œä½†æ˜¯æˆ‘é…ç½®ä¸­ï¼Œä¸è®¾ç½®ç½‘ç»œå°±ä¸é€š</p><p>è‹¥ H3C è¿æ¥çš„æ˜¯ç»ˆç«¯ï¼Œåˆ™å°†ç«¯å£æ¨¡å¼æ”¹ä¸º accessï¼Œå¹¶è®¾ç½®ä»…å…è®¸é€šè¿‡çš„ vlan</p></blockquote><h2 id="åä¸ºäº¤æ¢æœº-ä¸»-å…¶å®ƒäº¤æ¢æœº">åä¸ºäº¤æ¢æœº(ä¸») - å…¶å®ƒäº¤æ¢æœº</h2><pre><code class="language-bash"># åˆ›å»ºè¿æ¥å…¶å®ƒäº¤æ¢æœºçš„èšåˆæ¥å£# èšåˆæ¥å£åºå·1# èšåˆæ¥å£è®¾ç½®ä¸º trunk æ¨¡å¼ï¼Œ å¹¶å…è®¸æ‰€æœ‰ vlan é€šè¿‡# èšåˆæ¥å£æ¨¡å¼è®¾ç½®ä¸ºåŠ¨æ€èšåˆinterface Eth-Trunk 1 port link-type trunk port trunk allow-pass vlan 2 to 4094 mode lacp# æ·»åŠ æ™®é€šç«¯å£ 1-4 åˆ°èšåˆæ¥å£# è®¾ç½®æ™®é€šç«¯å£çš„æ´»åŠ¨ä¼˜å…ˆçº§ä¸º 100ï¼Œé»˜è®¤ç«¯å£ä¼˜å…ˆçº§æ˜¯30000+, ä¼˜å…ˆçº§æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜interface GigabitEthernet0/0/1 eth-trunk 1 lacp priority 100interface GigabitEthernet0/0/2 eth-trunk 1 lacp priority 100interface GigabitEthernet0/0/3 eth-trunk 1 lacp priority 100interface GigabitEthernet0/0/4 eth-trunk 1 lacp priority 100</code></pre><blockquote><p>è‹¥åä¸ºè¿æ¥çš„æ˜¯ç»ˆç«¯ï¼Œåˆ™å°†ç«¯å£æ¨¡å¼æ”¹ä¸º accessï¼Œå¹¶è®¾ç½®ä»…å…è®¸é€šè¿‡çš„ vlan</p></blockquote><h2 id="ç¾¤è¾‰">ç¾¤è¾‰</h2><p>å‰æï¼š</p><p>äº¤æ¢æœºä¸€ä¾§å·²ç»é…ç½®å¥½äº†åŠ¨æ€èšåˆ</p><p>æ§åˆ¶é¢æ¿-ç½‘ç»œ-ç½‘ç»œç•Œé¢-æ–°å¢-åˆ›å»º Bond</p><ol><li>è®¾ç½®èšåˆæ–¹å¼ï¼Œé€‰<code>IEEE 802.3ad åŠ¨æ€ Link Aggregationl</code></li><li>é€‰æ‹©å‚ä¸èšåˆçš„ç½‘ç»œç«¯å£</li><li>è®¾å®šèšåˆæ¥å£çš„ipåœ°å€</li></ol><p>ä¿å­˜è®¾ç½®åï¼Œç¾¤è¾‰ä¼šé‡è½½ã€‚</p><p>å¦‚æœä¸å¹¸å› é…ç½®æ•…éšœï¼Œå¯¼è‡´ç¾¤è¾‰æ— æ³•è®¿é—®ï¼Œé‚£ä¹ˆä½ å¯ä»¥é€šè¿‡ç¾¤è¾‰ç¡¬ä»¶ä¸Šçš„ reset æŒ‰é’®è¿›è¡Œç®¡ç†å‘˜è´¦æˆ·å’Œç½‘ç»œé…ç½®é‡ç½®ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»…å¯æŒ‰ä¸‹4ç§’ï¼Œåœ¨ç¬¬ä¸€æ¬¡å¬åˆ°æ»´å£°åï¼Œå°±ç«‹é©¬æ¾å¼€ã€‚</p><h2 id="vsphere-vcenter">vsphere vcenter</h2><p>å…ˆçœ‹ä¸€ä¸ªè®¾ç½®çš„æ‹“æ‰‘ï¼Œå·¦è¾¹è™šæ‹Ÿæœº16.50ï¼Œé»˜è®¤åªæœ‰ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå³è¾¹lag1æ˜¯ä¸€ä¸ªä¸Šè¡Œèšåˆç»„</p><p><img src="/posts/6f53a6b8/image-20210527180252600.png" alt="image-20210527180252600"></p><p>ç™»å½• vsphere ç½‘ç»œæ§åˆ¶å°ï¼Œç‚¹å‡»<code>ç½‘ç»œ</code>ï¼Œæ–°å»ºä¸€ä¸ªåˆ†å¸ƒå¼è™šæ‹Ÿäº¤æ¢æœºï¼ŒæœŸé—´æ‰€æœ‰å±æ€§å…¨é»˜è®¤ï¼ˆåå­—ä½ å¯ä»¥è‡ªå·±èµ·ï¼Œå…¶å®ƒä¿æŒå…¨é»˜è®¤å°±è¡Œï¼‰</p><p><img src="/posts/6f53a6b8/image-20210525145742419.png" alt="image-20210525145742419"></p><p>æ—¢ç„¶æ˜¯ä¸€ä¸ªè™šæ‹Ÿäº¤æ¢æœºï¼Œé‚£ä¹ˆè‚¯å®šéœ€è¦é…ç½®ä¸€ä¸ªä¸Šè”è‡³ç‰©ç†äº¤æ¢æœºçš„èšåˆtrunké“¾è·¯ï¼ˆlag1ï¼‰å’Œä¸‹è”è™šæ‹Ÿæœºçš„èšåˆaccessé“¾è·¯ï¼ˆDportGroup-vlan2016ï¼‰</p><h3 id="åˆ›å»ºä¸Šè”è‡³ç‰©ç†äº¤æ¢æœºçš„èšåˆtrunké“¾è·¯">åˆ›å»ºä¸Šè”è‡³ç‰©ç†äº¤æ¢æœºçš„èšåˆtrunké“¾è·¯</h3><p>é€‰ä¸­æ‰€å»ºç«‹çš„ DSwitch - é…ç½® - LACP - æ–°å»ºï¼Œåˆ›å»ºè™šæ‹Ÿäº¤æ¢æœºä¸‹çš„ä¸Šè”èšåˆæ¥å£lag1ï¼Œlag1æœ‰4ä¸ªç«¯å£ï¼Œå¹¶ä¸”è¿™4ä¸ªç«¯å£å¯¹åº”4ä¸ªå®¿ä¸»æœºç½‘å¡ï¼Œè´Ÿè½½å¹³è¡¡æ¨¡å¼éœ€è¦å’Œç‰©ç†äº¤æ¢æœºèšåˆæ¥å£è®¾ç½®çš„è´Ÿè½½åè®®ä¸€è‡´</p><p>å‡è®¾è¿™é‡Œéƒ½é€‰æ‹© src-dst-ipï¼Œå³æºå’Œç›®æ ‡ipåœ°å€ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåä¸ºäº¤æ¢æœºæ™®é€šå‹å·ä¸æ”¯æŒå¢å¼ºè´Ÿè½½æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯ä¸æ”¯æŒsportå’Œdspotè´Ÿè½½ã€‚ä¾‹å¦‚S5700EIå°±ä¸æ”¯æŒã€‚</p></blockquote><p>VLANä¸­ç»§èŒƒå›´ï¼Œæˆ‘ä»¬é€‰æ‹©ä¸­ç»§æ‰€æœ‰ï¼Œè¿™ä¸ªå’Œç‰©ç†äº¤æ¢æœºèšåˆæ¥å£è®¾ç½®ä¿æŒä¸€è‡´å³å¯ã€‚</p><p><img src="/posts/6f53a6b8/image-20210525151556021.png" alt="image-20210525151556021"></p><p>æŒ‰ç…§webé¡µé¢çš„æç¤º</p><p><img src="/posts/6f53a6b8/image-20210525155005563.png" alt="image-20210525155005563"></p><h3 id="åˆ›å»ºä¸€ä¸ªä¸‹è¡Œç«¯å£ç»„ï¼Œç”¨äºå…³è”è™šæ‹Ÿæœºçš„ç½‘å¡">åˆ›å»ºä¸€ä¸ªä¸‹è¡Œç«¯å£ç»„ï¼Œç”¨äºå…³è”è™šæ‹Ÿæœºçš„ç½‘å¡</h3><p>ä½ æœ‰å‡ ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå°±å¼€å‡ ä¸ªç«¯å£æ•°ï¼Œä¹Ÿå¯ä»¥å¤šå¼€ï¼Œç”¨ä¸ç”¨çœ‹ä½ è‡ªå·±ã€‚</p><p>VLAN IDå°±æ˜¯æŒ‡è¿™ä¸ªä¸‹è¡Œç«¯å£ç»„å…è®¸é€šè¿‡çš„VLANã€‚</p><p><img src="/posts/6f53a6b8/image-20210527182054562.png" alt="image-20210527182054562"></p><h3 id="å°†exsiç‰©ç†ä¸»æœºåŠ å…¥åˆ°DSwitchï¼Œå¹¶å°†DSwitchçš„èšåˆæ¥å£é‡Œçš„ç«¯å£ä¸exsiç‰©ç†ç½‘å¡ç»‘å®š">å°†exsiç‰©ç†ä¸»æœºåŠ å…¥åˆ°DSwitchï¼Œå¹¶å°†DSwitchçš„èšåˆæ¥å£é‡Œçš„ç«¯å£ä¸exsiç‰©ç†ç½‘å¡ç»‘å®š</h3><p><img src="/posts/6f53a6b8/image-20210527175600067.png" alt="image-20210527175600067"></p><p>é€‰ä¸­æ‰€å»ºç«‹çš„ DSwitch - å³é”® - æ·»åŠ å’Œç®¡ç†ä¸»æœº - æ·»åŠ ä¸»æœº</p><p>åœ¨æ·»åŠ å’Œç®¡ç†ä¸»æœº-ç®¡ç†ç‰©ç†é€‚é…å™¨ä¸­ï¼Œé€‰æ‹©ç‰©ç†ç½‘å¡å¹¶ç»‘å®šåˆ°è™šæ‹Ÿäº¤æ¢æœºçš„ä¸Šè”é“¾è·¯èšåˆç»„ige1é‡Œçš„è™šæ‹Ÿç«¯å£ï¼Œéšä½ æ€ä¹ˆç»‘å®šï¼Œåæ­£æŠŠä½ çš„ç‰©ç†ç½‘å¡éƒ½ç»‘å®šä¸Šå³å¯ã€‚</p><p>å…¶ä½™çš„è¿ç§»è™šæ‹Ÿæœºç½‘ç»œä¹‹ç±»çš„å¯ä»¥å…ˆä¸åšã€‚</p><p>åˆ°æ­¤ï¼ŒDSwitchå’Œç‰©ç†äº¤æ¢æœºä¹‹é—´çš„èšåˆåº”è¯¥å·²ç»æ‰“é€šäº†ã€‚</p><p>åœ¨ç‰©ç†äº¤æ¢æœºé‚£è¾¹æŸ¥çœ‹èšåˆæ¥å£ï¼Œç¡®ä¿æ‰€æœ‰å‚ä¸èšåˆçš„ç«¯å£éƒ½æ˜¯ selected çŠ¶æ€ã€‚</p><h3 id="å°†è™šæ‹Ÿæœºç½‘å¡å…³è”åˆ°è™šæ‹Ÿäº¤æ¢æœºDSwitchçš„ä¸‹è¡Œç«¯å£ç»„">å°†è™šæ‹Ÿæœºç½‘å¡å…³è”åˆ°è™šæ‹Ÿäº¤æ¢æœºDSwitchçš„ä¸‹è¡Œç«¯å£ç»„</h3><p>åœ¨æœ¬æ–‡æ¡£ä¸­ï¼Œå³å°†ç½‘ç»œé€‚é…å™¨å…³è”åˆ° DportGroup-vlan2016ã€‚</p><p>æœ€åï¼Œåœ¨è™šæ‹Ÿæœºç½‘å¡é…ç½®ä¸­ï¼Œå°†ç½‘ç»œé€‚é…å™¨ä»VM Networkæ”¹ä¸ºä¸‹è¡Œç«¯å£ç»„</p><p><img src="/posts/6f53a6b8/image-20210525160148265.png" alt="image-20210525160148265"></p><p>æˆ–è€…å°†è™šæ‹Ÿæœºä» VM Networkäº¤æ¢æœºè¿å‡ºåˆ° DSwitch äº¤æ¢æœº</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ–¹å¼ä¼šå°†è™šæ‹Ÿæœºä¸‹æ‰€æœ‰è™šæ‹Ÿç½‘å¡å…¨éƒ¨è¿ç§»ã€‚</p></blockquote><p><img src="/posts/6f53a6b8/image-20210525160429071.png" alt="image-20210525160429071"></p><h3 id="æµ‹è¯•è™šæ‹Ÿæœºçš„ç½‘å¡é€Ÿåº¦">æµ‹è¯•è™šæ‹Ÿæœºçš„ç½‘å¡é€Ÿåº¦</h3><p>å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»çªç ´äº†100MBpsï¼ˆèšåˆå‰ï¼Œexsiå®¿ä¸»æœºåˆ°ç‰©ç†äº¤æ¢æœºä¹‹å‰æ˜¯100MBpsï¼‰</p><p><img src="/posts/6f53a6b8/image-20210527181349144.png" alt="image-20210527181349144"></p>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é“¾è·¯èšåˆ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusâ˜k8så†…ç½®éƒ¨ç½²</title>
      <link href="posts/bced4977/"/>
      <url>posts/bced4977/</url>
      
        <content type="html"><![CDATA[<h2 id="éƒ¨ç½²æ–‡æ¡£">éƒ¨ç½²æ–‡æ¡£</h2><p><a href="https://prometheus-operator.dev/docs/prologue/quick-start/">https://prometheus-operator.dev/docs/prologue/quick-start/</a></p><p>å¦‚æœé‡‡ç”¨çš„æ˜¯kubeadmå®‰è£…çš„k8sï¼Œæˆ–è®¸ä¼šç”¨åˆ°</p><p><a href="https://prometheus-operator.dev/docs/kube-prometheus-on-kubeadm/#kubeadm-pre-requisites">https://prometheus-operator.dev/docs/kube-prometheus-on-kubeadm/#kubeadm-pre-requisites</a></p><p>æåˆ°çš„ä¿¡æ¯ã€‚</p><h2 id="æ¶æ„å›¾">æ¶æ„å›¾</h2><p><img src="https://www.qikqiak.com/img/posts/prometheus-operator.png" alt="promtheus opeator"></p><p>è¿™é‡Œçš„ servicemonitor èµ„æºå¯¹è±¡å¾ˆå…³é”®</p><h2 id="ç›‘æ§çš„ä¸œè¥¿">ç›‘æ§çš„ä¸œè¥¿</h2><ul><li>cluster state via kube-state-metrics</li><li>nodes via the node_exporter</li><li>kubelets</li><li>apiserver</li><li>kube-scheduler</li><li>kube-controller-manager</li></ul><h2 id="åŸºæœ¬æ­¥éª¤">åŸºæœ¬æ­¥éª¤</h2><h3 id="æ‹‰å–ä»£ç ">æ‹‰å–ä»£ç </h3><pre><code class="language-shell">git clone https://github.com/prometheus-operator/kube-prometheus.git</code></pre><h3 id="éƒ¨ç½²åˆ°k8s">éƒ¨ç½²åˆ°k8s</h3><p>â„¹ï¸èµ„æºä¼šéƒ¨ç½²åœ¨monitoringå‘½åç©ºé—´ä¸­</p><pre><code class="language-shell">kubectl create -f manifests/setup# ç­‰å¾…ä¸Šè¿°å‘½ä»¤èµ„æºè·‘å®Œkubectl create -f manifests/# ç­‰å¾…æ‰€æœ‰ pod åˆ›å»ºå®Œæ¯•kubectl get pod -n monitoring</code></pre><h3 id="æ·»åŠ ingressé…ç½®">æ·»åŠ ingressé…ç½®</h3><p>â„¹ï¸éœ€å…ˆéƒ¨ç½²å®Œ ingressï¼Œä¾‹å¦‚</p><pre><code class="language-bash">kubectl get svc -n ingress-nginx===NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                      AGEingress-nginx-controller             LoadBalancer   10.96.210.139   10.200.16.11   80:32489/TCP,443:30936/TCP   88mingress-nginx-controller-admission   ClusterIP      10.96.128.101   &lt;none&gt;         443/TCP                      88m</code></pre><p>ä¸Šè¿° ingress-nginx-controller å·²ç»åˆ†åˆ°äº† EXTERNAL-IPï¼š10.200.16.11</p><p>éƒ¨ç½²ä¸‹é¢çš„ ingress é…ç½®</p><pre><code class="language-yaml">kind: IngressapiVersion: networking.k8s.io/v1metadata:  name: prometheus-ingress  namespace: monitoring  annotations:    kubernetes.io/ingress.class: &quot;nginx&quot;spec:  rules:  - host: grafana.it.local    http:      paths:      - path: /        pathType: Prefix        backend:          service:            name: grafana            port:              number: 3000  - host: proms.it.local    http:      paths:      - path: /        pathType: Prefix        backend:          service:            name: prometheus-k8s            port:              number: 9090  - host: alert.it.local    http:      paths:      - path: /        pathType: Prefix        backend:          service:            name: alertmanager-main            port:              number: 9093    </code></pre><p>è§£æ grafana.it.local å’Œ proms.it.local åˆ° svc å¯¹è±¡ ingress-nginx-controller å…³è”çš„ EXTERNAL-IP.</p><p>æœ€åé€šè¿‡ <a href="http://grafana.it.local">http://grafana.it.local</a> å’Œ <a href="http://proms.it.local">http://proms.it.local</a> è®¿é—®</p><p>å…¶ä¸­ grafana çš„é»˜è®¤è´¦æˆ·å¯†ç éƒ½æ˜¯ adminï¼Œæ•ˆæœå¦‚å›¾ï¼š</p><p><img src="/posts/bced4977/image-20210319171647029.png" alt="image-20210319171647029"></p><p>å…¶ä¸­ prometheus çš„æ•ˆæœå¦‚å›¾ï¼š</p><p><img src="/posts/bced4977/image-20210319171728505.png" alt="image-20210319171728505"></p><h3 id="æ·»åŠ å‘Šè­¦">æ·»åŠ å‘Šè­¦</h3><p>é…ç½®ç›¸å…³å¯ä»¥åœ¨ kube-prometheus/manifests/alertmanager-secret.yaml ä¸­æ‰¾åˆ°</p><pre><code class="language-bash">apiVersion: v1kind: Secretmetadata:  labels:    alertmanager: main    app.kubernetes.io/component: alert-router    app.kubernetes.io/name: alertmanager    app.kubernetes.io/part-of: kube-prometheus    app.kubernetes.io/version: 0.21.0  name: alertmanager-main  namespace: monitoringstringData:  alertmanager.yaml: |-    global:      resolve_timeout: 5m      http_config: &#123;&#125;      smtp_hello: localhost      smtp_require_tls: true      pagerduty_url: https://events.pagerduty.com/v2/enqueue      opsgenie_api_url: https://api.opsgenie.com/      wechat_api_url: https://qyapi.weixin.qq.com/cgi-bin/      victorops_api_url: https://alert.victorops.com/integrations/generic/20131114/alert/    route:      receiver: Default      group_by:      - namespace      routes:      - receiver: Watchdog        match:          alertname: Watchdog      - receiver: Critical        match:          severity: critical      group_wait: 30s      group_interval: 5m      repeat_interval: 12h    inhibit_rules:    - source_match:        severity: critical      target_match_re:        severity: warning|info      equal:      - namespace      - alertname    - source_match:        severity: warning      target_match_re:        severity: info      equal:      - namespace      - alertname    receivers:    - name: Default      webhook_configs:      - url: &quot;...&quot;    - name: Critical      webhook_configs:      - url: &quot;...&quot;    - name: Watchdog    templates: []type: Opaque</code></pre><p>å¦‚ä¸Šå‘½ä»¤æ‰€ç¤ºï¼Œæ·»åŠ  receivers ï¼Œè¿™é‡Œå‡é‡‡ç”¨ webhook æ–¹å¼</p><p>éƒ¨ç½²æ–°é…ç½®ï¼Œå¹¶reload alertmanager</p><pre><code class="language-bash">kubectl apply -f alertmanager-secret.yaml curl -X POST http://&lt;alertmanager_addr&gt;/-/reload</code></pre><h3 id="ä¿®æ”¹é»˜è®¤çš„prometheusè§„åˆ™">ä¿®æ”¹é»˜è®¤çš„prometheusè§„åˆ™</h3><p>é»˜è®¤çš„è§„åˆ™ä½äº prometheusrule èµ„æºå¯¹è±¡ä¸­</p><pre><code class="language-bash">kubectl get prometheusrule -n monitoringNAME                              AGEalertmanager-main-rules           6d22hkube-prometheus-rules             6d22hkube-state-metrics-rules          6d22hkubernetes-monitoring-rules       6d22hnode-exporter-rules               6d22hprometheus-k8s-prometheus-rules   6d22hprometheus-operator-rules         6d22h</code></pre><p>é€šè¿‡ kubectl edit ä¿®æ”¹å³å¯</p><h3 id="ä¿®æ­£é—®é¢˜">ä¿®æ­£é—®é¢˜</h3><p>prometheusé¡µé¢ä¸­å¯èƒ½ä¼šçœ‹åˆ°æœ‰ä¸€äº›é”™è¯¯ï¼Œä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶kube-controller-managerå’Œkube-scheduleræ˜¯down</p><p><img src="/posts/bced4977/image-20210319174713804.png" alt="image-20210319174713804"></p><p>å…¶åŸå› åœ¨äºï¼Œprometheus-operatorçš„ServiceMonitorèµ„æºå¯¹è±¡æŒ‡å®šçš„svcä¸å­˜åœ¨</p><pre><code class="language-bash">[root@k8s01 my-yaml]# kubectl get servicemonitor -n monitoringNAME                      AGEalertmanager              2d19hblackbox-exporter         2d19hcoredns                   2d19hgrafana                   2d19hkube-apiserver            2d19hkube-controller-manager   2d19hkube-scheduler            2d19hkube-state-metrics        2d19hkubelet                   2d19hnode-exporter             2d19hprometheus-adapter        2d19hprometheus-k8s            2d19hprometheus-operator       2d19h</code></pre><p>ä»¥kube-schedulerä¸ºä¾‹</p><pre><code class="language-bash">[root@k8s01 my-yaml]# kubectl get servicemonitor kube-scheduler -n monitoring -o yamlapiVersion: monitoring.coreos.com/v1kind: ServiceMonitormetadata:......spec:  endpoints:  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token    interval: 30s    port: https-metrics    scheme: https    tlsConfig:      insecureSkipVerify: true  jobLabel: app.kubernetes.io/name  namespaceSelector:    matchNames:    - kube-system  selector:    matchLabels:      app.kubernetes.io/name: kube-scheduler</code></pre><p>å¯ä»¥çœ‹åˆ° <code>kube-scheduler</code> çš„ <code>servicemonitor</code> æŒ‡å‘æ‹¥æœ‰ <code>app.kubernetes.io/name: kube-scheduler</code> å’Œ <code>ports.name: https-metrics</code> çš„ svc</p><h4 id="å»ºç«‹servicemonitoræ‰€éœ€çš„svc">å»ºç«‹servicemonitoræ‰€éœ€çš„svc</h4><p>æŸ¥çœ‹æœåŠ¡podçš„æ ‡ç­¾</p><pre><code class="language-bash">[root@k8s01 my-yaml]# kubectl get pod -n kube-system | grep kube-schedulerkube-scheduler-k8s01            1/1     Running   0          36mkube-scheduler-k8s02            1/1     Running   0          18mkube-scheduler-k8s03            1/1     Running   0          16m[root@k8s01 my-yaml]# kubectl get pod kube-scheduler-k8s01  -n kube-system -o yaml | grep -A 2 labels  labels:    component: kube-scheduler    tier: control-plane--        f:labels:          .: &#123;&#125;          f:component: &#123;&#125;</code></pre><p>å¦‚ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œåœ¨kubeadmå®‰è£…çš„k8sä¸­ï¼Œkube-schedulerçš„ labels æ˜¯ component: kube-schedulerã€‚</p><p>æœ€åç”Ÿæˆsvcé…ç½®</p><pre><code class="language-bash">apiVersion: v1kind: Servicemetadata:  namespace: kube-system  name: kube-scheduler-prometheus  labels:    app.kubernetes.io/name: kube-scheduler  # å…³é”®spec:  selector:    component: kube-scheduler  # å…³é”®  ports:  - name: https-metrics  # å…³é”®    port: 10259  # å…³é”®    targetPort: 10259  # å…³é”®    protocol: TCP---apiVersion: v1kind: Servicemetadata:  namespace: kube-system  name: kube-controller-manager-prometheus  labels:    app.kubernetes.io/name: kube-controller-managerspec:  selector:    component: kube-controller-manager  ports:  - name: https-metrics    port: 10257    targetPort: 10257    protocol: TCP</code></pre><h4 id="ä¿®æ”¹æœåŠ¡ç›‘å¬åœ°å€">ä¿®æ”¹æœåŠ¡ç›‘å¬åœ°å€</h4><p>é»˜è®¤kubeadmå®‰è£…çš„kube-controller-managerå’Œkube-schedulerç›‘å¬åœ°å€éƒ½æ˜¯127.0.0.1ï¼Œè¿™å¯¼è‡´æ— æ³•è¢«é‡‡é›†ï¼Œå› æ­¤éœ€è¦æ”¹æˆ0.0.0.0ã€‚</p><p>ä¿®æ”¹ static pod é…ç½®å³å¯ã€‚</p><pre><code class="language-bash">sed -e &quot;s/- --address=127.0.0.1/- --address=0.0.0.0/&quot; -i /etc/kubernetes/manifests/kube-controller-manager.yamlsed -e &quot;s/- --address=127.0.0.1/- --address=0.0.0.0/&quot; -i /etc/kubernetes/manifests/kube-scheduler.yaml</code></pre><p>ä¿®æ”¹å®Œï¼Œk8sä¼šè‡ªåŠ¨é‡å»ºç›¸åº”çš„podã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜showdocéƒ¨ç½²</title>
      <link href="posts/9a7bc037/"/>
      <url>posts/9a7bc037/</url>
      
        <content type="html"><![CDATA[<p>â„¹ï¸ é…ç½®å¼•ç”¨çš„å­˜å‚¨æ˜¯ nfs</p><pre><code class="language-yaml">kind: IngressapiVersion: networking.k8s.io/v1metadata:  name: showdoc-ingress  namespace: it  annotations:    kubernetes.io/ingress.class: &quot;nginx&quot;spec:  rules:  - host: showdoc.xxx.com    http:      paths:      - path: /        pathType: Prefix        backend:          service:            name: showdoc-nginx-svc            port:              number: 80---kind: ServiceapiVersion: v1metadata:  name: showdoc-nginx-svc  namespace: itspec:  selector:    app: showdoc-nginx-pod  ports:  - protocol: TCP    port: 80    targetPort: 80    name: showdoc-nginx-svc---kind: DeploymentapiVersion: apps/v1metadata:  name: showdoc-nginx-dep  namespace: itspec:  replicas: 1  selector:    matchLabels:      app: showdoc-nginx-pod  template:    metadata:      labels:        app: showdoc-nginx-pod    spec:      containers:      - name: showdoc-nginx-pod        image: nginx        ports:        - containerPort: 80        resources:          requests:            memory: &quot;128Mi&quot;            cpu: &quot;125m&quot;          limits:            memory: &quot;512Mi&quot;            cpu: &quot;250m&quot;        volumeMounts:        - name: showdoc-vol          subPath: showdoc.xxx.com/data          mountPath: /app        - name: showdoc-vc          subPath: nginx.conf          mountPath: /etc/nginx/nginx.conf        - name: showdoc-vc          subPath: showdoc.xxx.com.conf          mountPath: /etc/nginx/conf.d/showdoc.xxx.com.conf        - name: showdoc-vc          subPath: fastcgi.conf          mountPath: /etc/nginx/fastcgi.conf      volumes:      - name: showdoc-vol        persistentVolumeClaim:          claimName: showdoc-pvc      - name: showdoc-vc        configMap:          name: showdoc-cm---kind: ServiceapiVersion: v1metadata:  name: showdoc-php-svc  namespace: itspec:  selector:    app: showdoc-php-pod  ports:  - protocol: TCP    port: 9000    targetPort: 9000    name: showdoc-php-svc---kind: DeploymentapiVersion: apps/v1metadata:  name: showdoc-php-dep  namespace: itspec:  replicas: 1  selector:    matchLabels:      app: showdoc-php-pod  template:    metadata:      labels:        app: showdoc-php-pod    spec:      containers:      - name: showdoc-php-pod        #image: php:7.2-fpm        image: bitnami/php-fpm        ports:        - containerPort: 9000        resources:          requests:            memory: &quot;128Mi&quot;            cpu: &quot;125m&quot;          limits:            memory: &quot;512Mi&quot;            cpu: &quot;250m&quot;        volumeMounts:        - name: showdoc-vol          subPath: showdoc.xxx.com/data          mountPath: /app      volumes:      - name: showdoc-vol        persistentVolumeClaim:          claimName: showdoc-pvc---kind: ConfigMapapiVersion: v1metadata:  name: showdoc-cm  namespace: itdata:  nginx.conf: |    user nginx;    worker_processes auto;    error_log /dev/stderr;    pid /run/nginx.pid;    include /usr/share/nginx/modules/*.conf;    events &#123;        worker_connections 1024;    &#125;    http &#123;        log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '                          '$status $body_bytes_sent &quot;$http_referer&quot; '                          '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';        access_log  /dev/stdout  main;        sendfile            on;        tcp_nopush          on;        tcp_nodelay         on;        keepalive_timeout   65;        types_hash_max_size 2048;        include             /etc/nginx/mime.types;        default_type        application/octet-stream;        include /etc/nginx/conf.d/*.conf;    &#125;  showdoc.xxx.com.conf: |    server        &#123;            listen 80;            server_name showdoc.xxx.com;            index index.html index.php;            root /app;            location ~ [^/]\.php(/|$)            &#123;                try_files $uri =404;                fastcgi_pass  showdoc-php-svc:9000;                fastcgi_index index.php;                include fastcgi.conf;            &#125;            location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$            &#123;                expires      1d;            &#125;            location ~ .*\.(js|css)?$            &#123;                expires      12h;            &#125;            location ~ /.well-known &#123;                allow all;            &#125;            location ~ /\.            &#123;                deny all;            &#125;        &#125;  fastcgi.conf: |    fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;    fastcgi_param  QUERY_STRING       $query_string;    fastcgi_param  REQUEST_METHOD     $request_method;    fastcgi_param  CONTENT_TYPE       $content_type;    fastcgi_param  CONTENT_LENGTH     $content_length;    fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;    fastcgi_param  REQUEST_URI        $request_uri;    fastcgi_param  DOCUMENT_URI       $document_uri;    fastcgi_param  DOCUMENT_ROOT      $document_root;    fastcgi_param  SERVER_PROTOCOL    $server_protocol;    fastcgi_param  REQUEST_SCHEME     $scheme;    fastcgi_param  HTTPS              $https if_not_empty;    fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;    fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;    fastcgi_param  REMOTE_ADDR        $remote_addr;    fastcgi_param  REMOTE_PORT        $remote_port;    fastcgi_param  SERVER_ADDR        $server_addr;    fastcgi_param  SERVER_PORT        $server_port;    fastcgi_param  SERVER_NAME        $server_name;    fastcgi_param  REDIRECT_STATUS    200;---kind: PersistentVolumeapiVersion: v1metadata:  name:  showdoc-pv  # å®šä¹‰ pv åå­—, ä¼šè¢« pvc å¼•ç”¨  namespace: itspec:  claimRef:    name: showdoc-pvc    namespace: it  capacity:    storage: 10Gi  # å®šä¹‰å¤§å°  accessModes:  - ReadWriteMany   # å®šä¹‰è®¿é—®æ¨¡å¼  persistentVolumeReclaimPolicy: Retain   # å®šä¹‰pvcåˆ é™¤åçš„ç­–ç•¥  nfs:    path: /mnt/data001/nfs-k8s   # å®šä¹‰ nfs å…±äº«è·¯å¾„    server: 10.200.16.250        # å®šä¹‰ nfs æœåŠ¡å™¨åœ°å€---kind: PersistentVolumeClaimapiVersion: v1metadata:  name: showdoc-pvc  namespace: itspec:  accessModes:    - ReadWriteMany  resources:    requests:      storage: 10Gi  volumeName: showdoc-pv</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> showdoc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windowsâ˜win10è¿ç§»æ•°æ®</title>
      <link href="posts/88eb7b6/"/>
      <url>posts/88eb7b6/</url>
      
        <content type="html"><![CDATA[<ol><li><p>æ¡Œé¢æ–‡ä»¶å¤‡ä»½</p></li><li><p>å­ç³»ç»Ÿå¤‡ä»½</p><p>å¦‚æœç”¨çš„å­ç³»ç»Ÿæ˜¯Ubuntuï¼Œé‚£ä¹ˆç›®å½•æ˜¯</p><p>C:\Users\&lt;å®¶ç›®å½•&gt;\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu***</p><p>å°†æ•´ä¸ªæ–‡ä»¶å¤¹å¤‡ä»½</p></li><li><p>å…¶å®ƒåˆ†åŒºæ•°æ®å¤‡ä»½</p></li></ol><p>å¦‚æœæœ‰å¿…è¦ï¼Œåˆ™æ¸…ç†å½“å‰ç”µè„‘çš„æ— ç”¨èµ„æºï¼Œç›´æ¥æ•´ä¸ªç³»ç»Ÿç›˜è¿›è¡ŒGhostå…‹éš†è¿˜åŸä¹Ÿæ˜¯å¯ä»¥çš„</p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
            <tag> windows10 </tag>
            
            <tag> ç³»ç»Ÿ </tag>
            
            <tag> è¿ç§» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusâ˜02å¤–ç½®prometheusç›‘æ§k8s</title>
      <link href="posts/e172b6e2/"/>
      <url>posts/e172b6e2/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>prometheus è·å– k8s æŒ‡æ ‡ï¼Œéœ€è¦ä»ä¸‰ä¸ªæ–¹é¢è·å–ï¼š</p><ul><li>kubelet å†…ç½®çš„ cadvisor</li><li>kubernetes-apiserver è‡ªèº«</li><li>kube-state-metrics (ç¬¬ä¸‰æ–¹APPï¼Œéœ€è¦æå‰è‡ªè¡Œå®‰è£…)</li></ul><p>è€Œä¸Šè¿°ä¸‰ä¸ªæ–¹é¢ï¼Œå‡éœ€è¦ prometheus å»è®¿é—® k8s apiserverã€‚è¿™é‡Œéœ€è¦æå‰åˆ›å»ºæˆæƒtoken.</p><h1>æˆæƒè®¤è¯</h1><h2 id="kube-apiserver-clientè®¿é—®è¯ä¹¦">kube-apiserver-clientè®¿é—®è¯ä¹¦</h2><p>ğŸ’¥å¦‚æœprometheusé…ç½®äº†<code>kubernetes_sd_configs.tls_config.insecure_skip_verify: true</code>ï¼Œå³ç¦ç”¨æœåŠ¡å™¨è¯ä¹¦è®¤è¯ï¼Œåˆ™æ— éœ€è¿™ä¸ªæ­¥éª¤ã€‚</p><pre><code class="language-bash">openssl genrsa -out prometheus.key 2048openssl req -new -key prometheus.key -out prometheus.csr -subj &quot;/CN=prometheus/O=it&quot;RequestStr=`cat prometheus.csr | base64 | tr -d &quot;\n&quot;`# æäº¤ç”³è¯·åˆ°k8scat &lt;&lt;EOF | kubectl apply -f -apiVersion: certificates.k8s.io/v1beta1kind: CertificateSigningRequestmetadata:  name: prometheusspec:  groups:  - system:authenticated  request: $&#123;RequestStr&#125;  signerName: kubernetes.io/kube-apiserver-client  usages:  - client authEOF# å¦‚æœä¸å‡ºé”™ï¼Œå¯ä»¥å®¡æ‰¹kubectl certificate approve prometheus# å¯¼å‡ºè¯ä¹¦kubectl get csr prometheus -o jsonpath='&#123;.status.certificate&#125;' | base64 --decode &gt; prometheus.crt# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸopenssl x509 -in prometheus.crt -noout -dates</code></pre><blockquote><p>ä¿å­˜å¥½è¯ä¹¦æ–‡ä»¶ prometheus.crtï¼Œprometheusé…ç½®æ‰€éœ€</p></blockquote><h2 id="åˆ›å»ºæœåŠ¡è´¦æˆ·-é›†ç¾¤è§’è‰²-é›†ç¾¤è§’è‰²ç»‘å®šå¯¹è±¡">åˆ›å»ºæœåŠ¡è´¦æˆ·/é›†ç¾¤è§’è‰²/é›†ç¾¤è§’è‰²ç»‘å®šå¯¹è±¡</h2><p>ç”¨äºæŸ¥è¯¢k8sèµ„æºã€‚</p><pre><code class="language-bash">kubectl create ns monitor</code></pre><p>prometheus-rabc.yaml</p><pre><code class="language-yaml">apiVersion: v1kind: ServiceAccountmetadata:  name: prometheus  namespace: monitor---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata:  name: prometheusrules:- apiGroups:  - &quot;&quot;  resources:  - nodes  - services  - endpoints  - pods  - nodes/proxy  verbs:  - get  - list  - watch- apiGroups:  - &quot;extensions&quot;  resources:    - ingresses  verbs:  - get  - list  - watch- apiGroups:  - &quot;&quot;  resources:  - configmaps  - nodes/metrics  verbs:  - get- nonResourceURLs:  - /metrics  verbs:  - get---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:  name: prometheusroleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: prometheussubjects:- kind: ServiceAccount  name: prometheus  namespace: monitor</code></pre><p>å› prometheusè®¿é—®k8séœ€è¦æ‹¿åˆ°bearer_tokenï¼Œå› æ­¤è¿˜éœ€è¦è·å–æœåŠ¡è´¦æˆ·prometheusçš„Tokensã€‚</p><p>è·å–æœåŠ¡è´¦æˆ·prometheuså­˜å‚¨Tokençš„secretå¯¹è±¡å</p><pre><code class="language-bash">âœ   kubectl get sa prometheus -n monitor -o jsonpath=&#123;'.secrets[0].name'&#125; | moreprometheus-token-2gljj</code></pre><p>å°†Tokenè¿›è¡Œè§£å¯†</p><pre><code class="language-bash">âœ   kubectl get secret prometheus-token-2gljj -n monitor -o jsonpath=&#123;'.data.token'&#125; | base64 -d &gt; prometheus.bearer_token</code></pre><blockquote><p>ä¿å­˜å¥½è§£å¯†åçš„ prometheus.bearer_tokenï¼Œprometheusé…ç½®æ‰€éœ€</p></blockquote><h1>å®‰è£…kube-state-metrics</h1><p>éƒ¨ç½²æ–¹å¼ï¼š<a href="https://github.com/kubernetes/kube-state-metrics/tree/master/examples/standard">ç‚¹æˆ‘</a></p><p>æŒ‡æ ‡æ–‡æ¡£ï¼š<a href="https://github.com/kubernetes/kube-state-metrics/tree/master/docs">https://github.com/kubernetes/kube-state-metrics/tree/master/docs</a></p><pre><code class="language-bash">âœ  standard git:(master) âœ— ls -ltotal 20-rw-r--r-- 1 zyh zyh  381 Mar 12 12:07 cluster-role-binding.yaml-rw-r--r-- 1 zyh zyh 1744 Mar 12 12:07 cluster-role.yaml-rw-r--r-- 1 zyh zyh 1134 Mar 12 17:29 deployment.yaml-rw-r--r-- 1 zyh zyh  197 Mar 12 12:07 service-account.yaml-rw-r--r-- 1 zyh zyh  410 Mar 12 12:07 service.yaml</code></pre><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<a href="http://deployment.xn--yamlkube-state-metricsk8s-3b63b637k9tejna412ib11erhyf.gcr.io/kube-state-metrics/kube-state-metrics%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%9C%B0%E5%9D%80%E5%9B%BD%E5%86%85%E6%B2%A1%E6%B3%95%E8%AE%BF%E9%97%AE%E3%80%82%E5%9B%A0%E6%AD%A4%E9%9C%80%E8%A6%81%E6%9B%BF%E6%8D%A2%E4%B8%BA%E5%85%B6%E5%AE%83%E5%9C%B0%E5%9D%80%E3%80%82">deployment.yamlä¸­kube-state-metricsçš„å®¹å™¨åœ°å€æ˜¯k8s.gcr.io/kube-state-metrics/kube-state-metricsï¼Œè¿™ä¸ªåœ°å€å›½å†…æ²¡æ³•è®¿é—®ã€‚å› æ­¤éœ€è¦æ›¿æ¢ä¸ºå…¶å®ƒåœ°å€ã€‚</a></p></blockquote><p>å¯ä»¥å°†é¡¹ç›®cloneä¸‹æ¥ï¼Œç„¶åæ ¹æ®é¡¹ç›®æºä»£ç é‡Œçš„Dockerfileæ¥ï¼Œè‡ªè¡Œbuildä¸€ä¸ªé•œåƒã€‚</p><pre><code class="language-dockerfile">ARG GOVERSION=1.17ARG GOARCH=amd64FROM golang:$&#123;GOVERSION&#125; as builderARG GOARCHENV GOARCH=$&#123;GOARCH&#125;WORKDIR /go/src/k8s.io/kube-state-metrics/COPY . /go/src/k8s.io/kube-state-metrics/RUN make build-localFROM gcr.io/distroless/static:latest-$&#123;GOARCH&#125;COPY --from=builder /go/src/k8s.io/kube-state-metrics/kube-state-metrics /USER nobodyENTRYPOINT [&quot;/kube-state-metrics&quot;, &quot;--port=8080&quot;, &quot;--telemetry-port=8081&quot;]EXPOSE 8080 8081</code></pre><p><code>GOARCH</code>æŒ‡å®šç¯å¢ƒï¼Œå…¶ä½™æ— éœ€ä¿®æ”¹ã€‚</p><h2 id="æ ¹æ®æƒ…å†µä¿®æ”¹-service-å¯¹è±¡">æ ¹æ®æƒ…å†µä¿®æ”¹ service å¯¹è±¡</h2><p>é›†ç¾¤å¤–çš„prometheusæ— æ³•ç›´æ¥è®¿é—®é›†ç¾¤å†…çš„kube-state-metricsæœåŠ¡ï¼Œå› æ­¤éœ€è¦æš´æ¼kube-state-metricsã€‚</p><p>é»˜è®¤é…ç½®é‡Œï¼Œserviceå¯¹è±¡æ˜¯ClusterIPï¼Œä»…é’ˆå¯¹äº†é›†ç¾¤å†…éƒ¨ã€‚</p><ul><li>prometheus + é˜¿é‡Œäº‘ ASK</li></ul><p>é€šè¿‡å†…ç½‘è´Ÿè½½å‡è¡¡å™¨æä¾›ã€‚</p><pre><code class="language-yaml">apiVersion: v1kind: Servicemetadata:  labels:    app.kubernetes.io/component: exporter    app.kubernetes.io/name: kube-state-metrics    app.kubernetes.io/version: 2.3.0  name: kube-state-metrics  namespace: kube-system  annotations:    service.beta.kubernetes.io/alibaba-cloud-loadbalancer-spec: slb.s1.small    service.beta.kubernetes.io/alicloud-loadbalancer-address-type: intranet    service.beta.kubernetes.io/alibaba-cloud-loadbalancer-additional-resource-tags: &quot;project=cms-saas&quot;spec:  type: LoadBalancer  ports:  - name: http-metrics    port: 8080    targetPort: http-metrics  - name: telemetry    port: 8081    targetPort: telemetry  selector:    app.kubernetes.io/name: kube-state-metrics</code></pre><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash">âœkubectl apply -f .</code></pre><h2 id="æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸">æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸</h2><pre><code class="language-bash">curl ip:8080/metrics</code></pre><h2 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h2><p>æ€§èƒ½ä¸å¤Ÿï¼ˆ250m/512Miï¼Œé’ˆå¯¹3000+ Jobå¯¹è±¡)ï¼Œå¯¼è‡´æ¥å£æ•°æ®è¿”å›è¿‡æ…¢ï¼Œå¼•å‘prometheusæ•°æ®é‡‡é›†å¤±è´¥ã€‚</p><h1>é…ç½®Prometheus</h1><p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</a></p><p>é€šè¿‡<code>role: node</code>å‘ç° kubernetes çš„èŠ‚ç‚¹ä¸Šçš„kubeletåœ°å€ï¼Œå¹¶å°†å…¶ä½œä¸ºåˆ®å–æ•°æ®æº</p><p>é€šè¿‡<code>role: endpoints</code>å‘ç° kubernetes service å¯¹è±¡çš„ endpoint åœ°å€ï¼Œä»è€Œæ‰¾åˆ° kube-state-metrics çš„å¤–éƒ¨ç«¯ç‚¹åœ°å€ã€‚</p><pre><code class="language-yaml">  - job_name: 'k8s-cadvisor' # æŠ“å®¹å™¨, cadvisorè¢«æ•´åˆåœ¨kubeletä¸­    scheme: https    metrics_path: /metrics    tls_config:      #ca_file: /etc/prometheus/conf/prometheus.crt      insecure_skip_verify: true    bearer_token_file: /etc/prometheus/conf/prometheus.bearer_token    kubernetes_sd_configs:    - role: node      api_server: &quot;https://&lt;api_server_ip&gt;:6443&quot;      tls_config:        #ca_file: /etc/prometheus/conf/prometheus.crt        insecure_skip_verify: true      bearer_token_file: /etc/prometheus/conf/prometheus.bearer_token    relabel_configs:    - action: labelmap # æ ‡ç­¾æ˜ å°„ï¼šæŠ“å–regexæ­£åˆ™åŒ¹é…çš„æ ‡ç­¾åï¼Œå¤åˆ¶ä¸ºreplacementï¼ŒæœŸé—´æ ‡ç­¾å€¼ä¸å˜ï¼ˆreplacementä¸º$1æ—¶å¯ä»¥ä¸å†™ï¼‰      regex: __meta_kubernetes_node_label_(.+)      replacement: $1    metric_relabel_configs:    - source_labels: [instance]      separator: ;      regex: (.+)      target_label: node      replacement: $1      action: replace    - source_labels: [pod_name] # å…¼å®¹è€é›†ç¾¤ï¼Œè€é›†ç¾¤æ›¾ç”¨æ ‡ç­¾ pod_name      separator: ;      regex: (.+)      target_label: pod      replacement: $1      action: replace    - source_labels: [container_name] # å…¼å®¹è€é›†ç¾¤ï¼Œè€é›†ç¾¤æ›¾ç”¨æ ‡ç­¾ container_name      separator: ;      regex: (.+)      target_label: container      replacement: $1      action: replace        - job_name: 'kubernetes-apiservers'    scheme: https    tls_config:      #ca_file: /etc/prometheus/conf/prometheus.crt      insecure_skip_verify: true    bearer_token_file: /etc/prometheus/conf/prometheus.bearer_token    kubernetes_sd_configs:    - role: endpoints      api_server: &quot;https://&lt;api_server_ip&gt;:6443&quot;      tls_config:        #ca_file: /etc/prometheus/conf/prometheus.crt        insecure_skip_verify: true      bearer_token_file: /etc/prometheus/conf/prometheus.bearer_token    relabel_configs:    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]      action: keep      regex: default;kubernetes;https  - job_name: &quot;kubernetes-state-metrics&quot; # æŠ“å·¥ä½œè´Ÿè½½èµ„æº    scheme: http    tls_config:      #ca_file: /etc/prometheus/conf/prometheus.crt      insecure_skip_verify: true    bearer_token_file: /etc/prometheus/conf/prometheus.bearer_token    kubernetes_sd_configs:    - role: endpoints      api_server: &quot;https://&lt;api_server_ip&gt;:6443&quot;      tls_config:        #ca_file: /etc/prometheus/conf/prometheus.crt        insecure_skip_verify: true      bearer_token_file: /etc/prometheus/conf/prometheus.bearer_token    relabel_configs:    - source_labels: [__meta_kubernetes_service_name] # å°†è‡ªåŠ¨å‘ç°çš„endpointåªä¿ç•™kube-state-metrics      regex: kube-state-metrics      replacement: $1      action: keep    metric_relabel_configs: # æ’é™¤éƒ¨åˆ†kube-state-metricsé‡‡é›†é¡¹ç›®    - source_labels: [__name__]      regex: &quot;^go_.*|^kube_job_.*&quot;  # å¦‚æœåˆ é™¤ job ä¼šå¯¼è‡´ job å¯¹è±¡ç›‘æ§å¤±è´¥.      action: drop    - source_labels: [pod]      regex: &quot;^æ— éœ€ç›‘æ§çš„Podåç§°å‰ç¼€-.*&quot;      action: drop</code></pre><h1>æ·»åŠ grafanaæ¨¡æ¿</h1><p><a href="https://grafana.com/grafana/dashboards/13105">https://grafana.com/grafana/dashboards/13105</a></p><p><img src="/posts/e172b6e2/image-20210313180815651.png" alt="image-20210313180815651"></p><p>ä¸Šå›¾æ˜¯æˆ‘åœ¨é˜¿é‡Œäº‘ASKä¸­æµ‹è¯•çš„æœ€ç»ˆæ•ˆæœå›¾</p><h2 id="è°ƒæ•´æ¨¡æ¿">è°ƒæ•´æ¨¡æ¿</h2><p>å¦‚æœä½ å‘ç°æ¨¡æ¿ä¸­ï¼Œã€ç½‘ç»œå¸¦å®½ã€‘ä¹‹ç±»çš„æ²¡æœ‰æ•°æ®ï¼Œåˆ™éœ€è¦çœ‹ä¸‹æ­¤æ¿å—SQLé‡Œçš„æ ‡ç­¾è¿‡æ»¤æ˜¯å¦æœ‰è¯¯ã€‚</p><p>åœ¨æˆ‘çš„ç¯å¢ƒé‡Œï¼Œæ¨¡æ¿ä¸­è¿‡æ»¤çš„ name=â€˜^k8s_.*â€™ æ— æ³•åŒ¹é…åˆ°Podã€‚å› æ­¤åˆ é™¤SQLé‡Œçš„è¿™ä¸ªè¿‡æ»¤å³å¯ã€‚</p><h1>æ·»åŠ é¢„è­¦</h1><p>éœ€è¦æ˜ç¡®ï¼Œæˆ‘ä»¬éœ€è¦ç›‘æ§ä»€ä¹ˆ</p><ol><li>k8sæœ¬èº«å„ç»„ä»¶çŠ¶æ€</li><li>è°ƒåº¦äº†å¤šå°‘ä¸ªreplicasï¼Ÿç°åœ¨å¯ç”¨çš„æœ‰å‡ ä¸ªï¼Ÿ</li><li>Podæ˜¯å¦å¯åŠ¨æˆåŠŸ</li><li>Podé‡å¯é€Ÿç‡ï¼Ÿ</li></ol><pre><code class="language-yaml">groups:- name: kubernetes  rules:  - alert: kube endpoint down    expr: (up&#123;job=&quot;kube-state-metrics&quot;&#125; or up&#123;job=&quot;kubernetes-apiservers&quot;&#125;) != 1  #0ä¸æ­£å¸¸ï¼Œ1æ­£å¸¸    for: 5m  #æŒç»­æ—¶é—´ ï¼Œè¡¨ç¤ºæŒç»­5åˆ†é’Ÿè·å–ä¸åˆ°ä¿¡æ¯ï¼Œåˆ™è§¦å‘æŠ¥è­¦    labels:      severity: error      cluster: k8s    annotations:      summary: &quot;Instance:&#123;&#123; $labels.instance &#125;&#125;, Job &#123;&#123; $labels.job &#125;&#125; stop &quot;      sourcedata: '&#123;&#123; $labels.job &#125;&#125;'  - alert: JobFailed    expr: kube_job_status_failed == 1    for: 5m    labels:      severity: error      cluster: k8s    annotations:      summary: 'Namespace: &#123;&#123; $labels.namespace &#125;&#125;, Job: &#123;&#123; $labels.job &#125;&#125; run failed.'      sourcedata: '&#123;&#123; $labels.job &#125;&#125;'  - alert: PodReady    expr: kube_pod_container_status_ready != 1    for: 5m   #ReadyæŒç»­5åˆ†é’Ÿï¼Œè¯´æ˜å¯åŠ¨æœ‰é—®é¢˜    labels:      severity: warning      cluster: k8s    annotations:      summary: 'Namespace: &#123;&#123; $labels.namespace &#125;&#125;, Pod: &#123;&#123; $labels.pod &#125;&#125; not ready for 5m'      sourcedata: '&#123;&#123; $labels.job &#125;&#125;'  - alert: PodRestart    expr: kube_pod_container_status_last_terminated_reason == 1 and on(container) rate(kube_pod_container_status_restarts_total[5m]) * 300 &gt; 1    for: 5s    labels:      severity: error      cluster: k8s    annotations:      summary: 'namespace: &#123;&#123; $labels.namespace &#125;&#125;, pod: &#123;&#123; $labels.pod &#125;&#125; restart rate &gt; &#123;&#123; $value &#125;&#125;'      sourcedata: '&#123;&#123; $labels.job &#125;&#125;'  - alert: Deployment_replicas_available_num_low    expr: kube_deployment_status_replicas - kube_deployment_status_replicas_available &gt; 0    for: 1m    labels:      severity: warning      cluster: k8s    annotations:      summary: 'namespace: &#123;&#123; $labels.namespace &#125;&#125;, deployment: &#123;&#123; $labels.deployment &#125;&#125; available low'      sourcedata: '&#123;&#123; $labels.job &#125;&#125;'  - alert: Deployment_replicas_unavailable    expr: kube_deployment_status_replicas &gt; 0 and kube_deployment_status_replicas_available == 0    for: 1m    labels:      severity: error      cluster: k8s    annotations:      summary: 'namespace: &#123;&#123; $labels.namespace &#125;&#125;, deployment: &#123;&#123; $labels.deployment &#125;&#125; unavailable'      sourcedata: '&#123;&#123; $labels.job &#125;&#125;'</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> prometheus </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜åˆ©ç”¨acme.shç®¡ç†å…è´¹çš„sslè¯ä¹¦ç”³è¯·</title>
      <link href="posts/d2fed0bf/"/>
      <url>posts/d2fed0bf/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ç”³è¯·å…è´¹çš„sslè¯ä¹¦é€”å¾„æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚é˜¿é‡Œäº‘çš„1å¹´æœŸï¼Œæˆ–è€…freesslè¿™ç§ç«™ç‚¹ã€‚</p><p>å¦‚æœä½ æƒ³è‡ªå·±éƒ¨ç½²ä¸€ä¸ªæœåŠ¡æ¥ç®¡ç†å¹¶è‡ªåŠ¨æ›´æ–°ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <a href="http://acme.sh">acme.sh</a></p><p><a href="http://acme.sh">acme.sh</a> æ˜¯ä¸€ä¸ªå¼€æºç¨‹åºï¼Œæ‰˜ç®¡åœ¨githubä¸Šã€‚</p><h2 id="å®‰è£…">å®‰è£…</h2><p><a href="https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E#1-%E5%AE%89%E8%A3%85-acmesh">https://github.com/acmesh-official/acme.sh/wiki/è¯´æ˜#1-å®‰è£…-acmesh</a></p><p>å‚è€ƒå®˜æ–¹æ–‡æ¡£å³å¯ï¼Œå¾ˆç®€å•ï¼Œä¸è¿‡å›½å†…ç»å¸¸å—é™äºç½‘ç»œé—®é¢˜å¯¼è‡´æ— æ³•ä¸‹è½½ï¼Œå› æ­¤ä½ å¯ä»¥åœ¨ gitee ä¸Šä¸‹è½½</p><p><a href="https://gitee.com/neilpang/acme.sh?_from=gitee_search#https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E">https://gitee.com/neilpang/acme.sh?_from=gitee_search#https://github.com/acmesh-official/acme.sh/wiki/è¯´æ˜</a></p><p>ä¸è¿‡ gitee ä¸Šçœ‹èµ·æ¥å¹¶ä¸æ˜¯æœ€æ–°çš„</p><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><h3 id="ç”³è¯·-ssl">ç”³è¯· ssl</h3><p>ä»¥é˜¿é‡Œäº‘çš„dnsæ‰˜ç®¡è§£æä¸ºä¾‹ï¼Œç»™abc.comåˆ›å»ºå…è´¹sslè¯ä¹¦ <a href="https://letsencrypt.org/zh-cn/">Letâ€™s Encrypt</a></p><p>åˆ›å»ºè®¿é—®é˜¿é‡Œäº‘dnsè§£ææ‰€éœ€çš„ramç­–ç•¥ï¼Œè¯·ç›´æ¥ä½¿ç”¨ç®¡ç†å‘˜ç­–ç•¥ï¼Œä½†æ˜¯å¯ä»¥é™„åŠ æºipé™åˆ¶</p><p>ğŸ’è¯´å®è¯æˆ‘å•ç‹¬æˆæƒäº‘è§£æç­–ç•¥å°±æ˜¯ä¸è¡Œï¼Œè‡³äºåŸå› æ²¡æœ‰å…·ä½“å»éªŒè¯ã€‚æ‰€ä»¥å¦‚æœä½ æˆæƒäº†ç®¡ç†å‘˜ç­–ç•¥ï¼ŒåŠ¡å¿…æ·»åŠ æºipé™åˆ¶</p><pre><code class="language-bash">DnsAccessKey=DnsAccessSecret=export  Ali_Key=$&#123;DnsAccessKey&#125;export  Ali_Secret=$&#123;DnsAccessSecret&#125;D1=abc.comDnsMode=dns_aliacme.sh --issue --dns $&#123;DnsMode&#125; -d $&#123;D1&#125; -d *.$&#123;D1&#125; </code></pre><blockquote><p>â€“dns æŒ‡å®šåŸŸåæ‰€åœ¨çš„æ‰˜ç®¡è§£æå•†</p><p>-d è¯ä¹¦å…³è”çš„åŸŸå</p></blockquote><p>è¿™ä¸ªæ­¥éª¤ä¼šç»™åŸŸåæ·»åŠ æ–°çš„txtè®°å½•ï¼Œç”¨æ¥æ ¡éªŒåŸŸåæ˜¯å¦å½’ä½ æ‰€æœ‰</p><p>ä½†æ˜¯åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæœ‰æ–°çš„é—®é¢˜å‡ºç°ï¼Œå°±æ˜¯acme.shé»˜è®¤è°ƒç”¨cloudflareå’Œgoogleçš„dnså»éªŒè¯æ·»åŠ çš„è®°å½•æ˜¯å¦å·²ç”Ÿæ•ˆï¼Œè€Œå›½å†…ä¸€äº›æœåŠ¡å•†è®¿é—®å›½é™…æ¥å£é‚£æ˜¯ä¸€ä¸ªç¨€çƒ‚ğŸ¤• æ‰€ä»¥å¯èƒ½ä¼šæ— é™çš„å¡åœ¨æ ¡éªŒè¿™é‡Œã€‚</p><p>æ ¹æ®<a href="https://github.com/acmesh-official/acme.sh/wiki/dnscheck">å®˜æ–¹æ–‡æ¡£</a>ï¼Œä½ å¯ä»¥æ·»åŠ  --dnssleep 300 å»å¿½ç•¥æ‰ã€‚</p><h3 id="éƒ¨ç½²ssl">éƒ¨ç½²ssl</h3><p>å°†ç”Ÿæˆçš„å¯†é’¥å’Œè¯ä¹¦æ”¾åœ¨æŒ‡å®šä½ç½®ï¼Œè¿™é‡Œçš„keyå’Œceråˆ†åˆ«å¯¹åº”nginxæ‰€éœ€çš„keyå’Œcert</p><pre><code class="language-bash">acme.sh  --installcert  -d $&#123;D1&#125; --key-file $&#123;D1_DIR&#125;/$&#123;D1&#125;.key --fullchain-file $&#123;D1_DIR&#125;/fullchain.cer</code></pre><h3 id="æ›´æ–°">æ›´æ–°</h3><p><a href="http://acme.sh">acme.sh</a> ä¼šåœ¨ç”¨æˆ·çº§åˆ«çš„crontabä¸­æ·»åŠ è‡ªåŠ¨æ›´æ–°æŒ‡ä»¤ã€‚é€šè¿‡<code>crontab -l</code>å¯ä»¥çœ‹åˆ°ã€‚</p><p>å¦‚æœä½ éœ€è¦æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–°ï¼Œåˆ™å¯ä»¥æ‰§è¡Œ</p><pre><code class="language-bash"> acme.sh --renew -d $&#123;D1&#125; -d *.$&#123;D1&#125;</code></pre><h3 id="é…ç½®">é…ç½®</h3><p><a href="http://acme.sh">acme.sh</a> çš„é…ç½®æ–‡ä»¶é»˜è®¤æ”¾åœ¨ ~/.acme.sh/account.conf ä¸­ï¼Œä¸€èˆ¬æ¥è¯´éœ€è¦ç”¨æˆ·æä¾›çš„ç¯å¢ƒå˜é‡ï¼Œéƒ½ä¼šä»¥ <code>SAVED_</code>å¼€å¤´ã€‚</p><h3 id="é€šå‘Š">é€šå‘Š</h3><p>å¦‚æœä½ æƒ³æ¥æ”¶ <a href="http://acme.sh">acme.sh</a> å¤„ç†åçš„æ¶ˆæ¯ï¼Œåˆ™éœ€è¦é…ç½®ï¼Œä¸åŒçš„æ¶ˆæ¯ä½“å¯ä»¥çœ‹<a href="https://github.com/acmesh-official/acme.sh/wiki/notify">å®˜æ–¹æ–‡æ¡£</a></p><p>ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>æ¶ˆæ¯çº§åˆ«</li><li>æ¶ˆæ¯æ¨¡å¼</li><li>æ¶ˆæ¯é’©å­</li></ul><p>ä»¥è‡ªå®šä¹‰çš„ smtp ä¸ºä¾‹ï¼Œä½ éœ€è¦æä¾›ä»¥ä¸‹å˜é‡</p><pre><code class="language-bash">export SMTP_FROM=export SMTP_TO=export SMTP_HOST=&quot;smtp.feishu.cn&quot;export SMTP_SECURE=&quot;tls&quot;export SMTP_PORT=&quot;587&quot;export SMTP_USERNAME=export SMTP_PASSWORD=# export SMTP_BIN=&quot;/path/to/python_or_curl&quot;export SMTP_TIMEOUT=&quot;30&quot;</code></pre><p>å¹¶æ‰§è¡Œ</p><pre><code class="language-bash">acme.sh --set-notify --notify-level 3 --notify-mode 0 --notify-hook smtp --accountconf ~/.acme.sh/account.conf</code></pre><p>å¦‚æ­¤ä»¥æ¥ï¼Œ<a href="http://acme.sh">acme.sh</a> ä¼šå°†ä½ é…ç½®çš„ç¯å¢ƒå˜é‡è¿½åŠ å­˜å…¥ account.conf</p><h2 id="å…¶å®ƒé—®é¢˜">å…¶å®ƒé—®é¢˜</h2><h3 id="å•ä¸€æ‰˜ç®¡å•†å¤šè´¦æˆ·çš„é—®é¢˜">å•ä¸€æ‰˜ç®¡å•†å¤šè´¦æˆ·çš„é—®é¢˜</h3><p>åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œ<a href="http://acme.sh">acme.sh</a> å½“å‰å¹¶ä¸æ”¯æŒï¼ˆ19å¹´ä½œè€…æå‡ºæœ‰æ—¶é—´ä¼šæ ğŸ¤º ï¼‰ï¼Œä½†æ˜¯ä½ å¯ä»¥é€šè¿‡é…ç½®å¤šä¸ª account.confï¼Œå¹¶åœ¨è®¡åˆ’ä»»åŠ¡ä¸­ä½¿ç”¨ --accountconf æ¥å†™å…¥å¤šæ¡æ›´æ–°è®¡åˆ’å‘½ä»¤æ¥å®ç°é…ç½®æ–‡ä»¶çº§åˆ«çš„è½®è¯¢å¤„ç†ã€‚å°±åƒä¸‹é¢è¿™æ ·:</p><pre><code class="language-bash">34 0 * * * &quot;/home/it/.acme.sh&quot;/acme.sh --cron --home &quot;/home/it/.acme.sh&quot; --accountconf /home/it/.acme.sh/account.conf.aliyun34 1 * * * &quot;/home/it/.acme.sh&quot;/acme.sh --cron --home &quot;/home/it/.acme.sh&quot; --accountconf /home/it/.acme.sh/account.conf.aws34 2 * * * &quot;/home/it/.acme.sh&quot;/acme.sh --cron --home &quot;/home/it/.acme.sh&quot; --accountconf /home/it/.acme.sh/account.conf.godaddy</code></pre><p>å½“ç„¶å› ä¸ºåŸŸååœ¨ç”Ÿæˆsslè¯ä¹¦çš„æ—¶å€™ï¼Œacme.shå¹¶æ²¡æœ‰ç»™åŸŸåå…³è”æŸä¸ªé…ç½®çš„è®°å½•ã€‚å› æ­¤æ¯ä¸€æ¡æ›´æ–°è®¡åˆ’ä»»åŠ¡å‡ä¼šå¤„ç†æ‰€æœ‰çš„åŸŸåï¼Œè¿™å¿…ç„¶ä¼šäº§ç”Ÿä¸€äº›é”™è¯¯ä¿¡æ¯ï¼ˆå³ï¼šxxxæ‰˜ç®¡å•†æ‰¾ä¸åˆ°xxxåŸŸåï¼‰ï¼Œä¸è¿‡è¿™æ— å…³ç´§è¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> acme.sh </tag>
            
            <tag> ssl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜ä½¿ç”¨expectè‡ªåŠ¨ç™»å½•sshåè¿œç¨‹ä¼šè¯ä¸ä¼šè·Ÿéšæœ¬åœ°ä¼šè¯ç¼©æ”¾çš„é—®é¢˜</title>
      <link href="posts/7b3cf3d8/"/>
      <url>posts/7b3cf3d8/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸå› ">åŸå› </h2><p>expect æ‰§è¡Œçš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå°†çª—å£å¤§å°æ”¹å˜çš„ä¿¡å·ä¼ é€’ç»™è¿œç¨‹ä¼šè¯ã€‚æ‰€ä»¥åœ¨è„šæœ¬ä¸­æ·»åŠ å³å¯ã€‚</p><h2 id="è§£å†³">è§£å†³</h2><pre><code class="language-bash">#!/usr/bin/env expect #trap sigwinch spawnedtrap &#123; set rows [stty rows] set cols [stty columns] stty rows $rows columns $cols &lt; $spawn_out(slave,name)&#125; WINCH</code></pre><blockquote><p>åœ¨è„šæœ¬å¼€å¤´åŠ å…¥ trap</p></blockquote><h2 id="æ¥æº">æ¥æº</h2><p><a href="http://blog.sina.com.cn/s/blog_a73a649601018sgl.html">http://blog.sina.com.cn/s/blog_a73a649601018sgl.html</a></p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> ssh </tag>
            
            <tag> expect </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>aliyunâ˜å¸¸è§é—®é¢˜</title>
      <link href="posts/4cc38acc/"/>
      <url>posts/4cc38acc/</url>
      
        <content type="html"><![CDATA[<h1>adb for mysql</h1><h2 id="adb-è®¿é—®-oss-æ–‡ä»¶ä¸å­˜åœ¨">adb è®¿é—® oss æ–‡ä»¶ä¸å­˜åœ¨</h2><p>adb æ˜¯åˆ†å¸ƒå¼é›†ç¾¤ï¼Œè°ƒç”¨ossçš„æ—¶å€™ï¼Œæºipå¹¶ä¸æ˜¯adbå®ä¾‹åœ°å€æ‰€è§£æçš„vpc ipã€‚å› æ­¤ramçš„æƒé™ä¸èƒ½æ·»åŠ æºipé™åˆ¶ã€‚</p><h1>emr</h1><h2 id="hive-å…ƒæ•°æ®ä½¿ç”¨å¤–éƒ¨rdsçš„æ—¶å€™ï¼Œæ„å»ºè¡¨å‡ºé”™">hive å…ƒæ•°æ®ä½¿ç”¨å¤–éƒ¨rdsçš„æ—¶å€™ï¼Œæ„å»ºè¡¨å‡ºé”™</h2><p>å¦‚æœç¼–ç æ˜¯utf8ï¼Œå˜æ›´ä¸ºlatin1</p><h2 id="hiveåˆ é™¤è¡¨å¡ä½ï¼Œhiveæ—¥å¿—çœ‹ä¸å‡ºå¼‚å¸¸">hiveåˆ é™¤è¡¨å¡ä½ï¼Œhiveæ—¥å¿—çœ‹ä¸å‡ºå¼‚å¸¸</h2><p>ä½¿ç”¨mysql8.0çš„æ—¶å€™å‡ºç°ï¼Œæœ€ç»ˆæ¢æˆå®˜æ–¹å»ºè®®çš„5.7åï¼Œæ­£å¸¸</p><h2 id="æœ€æ–°ç‰ˆemré‡‡ç”¨roleæˆæƒæ–¹å¼çš„æ—¶å€™ï¼Œecs-èŠ‚ç‚¹æƒé™å¼‚å¸¸">æœ€æ–°ç‰ˆemré‡‡ç”¨roleæˆæƒæ–¹å¼çš„æ—¶å€™ï¼Œecs èŠ‚ç‚¹æƒé™å¼‚å¸¸</h2><p>roleçš„è§„åˆ™å¿…é¡»æ˜¯å®˜æ–¹é»˜è®¤è§„åˆ™ï¼Œä»»ä½•ç¼©å°æƒé™èŒƒå›´çš„è§„åˆ™éƒ½ä¼šå¼‚å¸¸ã€‚æš‚ä¸çŸ¥åŸå› ã€‚</p><blockquote><p>è¯´å®è¯ï¼Œå®˜æ–¹é»˜è®¤çš„è§„åˆ™æƒé™å¥½å¤§</p></blockquote><h2 id="HUE-æœåŠ¡ä¸å¤ªæ­£å¸¸">HUE æœåŠ¡ä¸å¤ªæ­£å¸¸</h2><p>ç¡®è®¤zookeeperæ˜¯å¦å®‰è£…</p><h1>CDN</h1><h2 id="éç®€å•è·¨åŸŸ-OPTIONS-æ— æ³•é€šè¿‡">éç®€å•è·¨åŸŸ OPTIONS æ— æ³•é€šè¿‡</h2><p>äº§ç”ŸOPTIONSçš„åŸå› æ˜¯å®¢æˆ·ç«¯è¯·æ±‚å­˜åœ¨è‡ªå®šä¹‰headerï¼Œå› æ­¤è·¨åŸŸçš„é…ç½®éœ€è¦å…è®¸é¢å¤–çš„è‡ªå®šä¹‰header</p><pre><code class="language-bash">Access-Control-Allow-Origin=&lt;å…è®¸çš„åŸŸ&gt;Access-Control-Allow-Methods=GET,POST,PUT,OPTIONSAccess-Control-Allow-Headers=&lt;å…è®¸çš„è‡ªå®šä¹‰header&gt;</code></pre><h1>ASK</h1><h2 id="ä¸åˆ›å»ºnatç½‘å…³ï¼Œè®©podå¯è®¿é—®å¤–ç½‘">ä¸åˆ›å»ºnatç½‘å…³ï¼Œè®©podå¯è®¿é—®å¤–ç½‘</h2><p>Pod.metadata</p><pre><code class="language-yaml">  annotations:    k8s.aliyun.com/eci-with-eip: &quot;true&quot; # æ¯ä¸€ä¸ªPodéƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„EIP    k8s.aliyun.com/eip-bandwidth: &quot;200&quot; # 200Mbpså¸¦å®½</code></pre><blockquote><p><a href="https://help.aliyun.com/document_detail/128506.html">https://help.aliyun.com/document_detail/128506.html</a></p><p><a href="https://help.aliyun.com/document_detail/119199.html">https://help.aliyun.com/document_detail/119199.html</a></p></blockquote><h1>DTS</h1>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aliyun </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aliyun </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rabbitmqâ˜å®‰è£…</title>
      <link href="posts/b43013ef/"/>
      <url>posts/b43013ef/</url>
      
        <content type="html"><![CDATA[<h3 id="dockeræ–¹å¼">dockeræ–¹å¼</h3><pre><code class="language-bash">mkdir -p /export/docker-data-rabbitmq/&#123;data,log,conf.d&#125;chown -R 999:999 /export/docker-data-rabbitmq/&#123;data,log,conf.d&#125;</code></pre><p>âš ï¸<code>999</code>æ˜¯rabbitmqå®˜æ–¹é•œåƒé‡Œçš„<code>rabbitmq</code>çš„<code>uid</code></p><h4 id="æ·»åŠ é¢å¤–çš„æ—¥å¿—é…ç½®">æ·»åŠ é¢å¤–çš„æ—¥å¿—é…ç½®</h4><p>/export/docker-data-rabbitmq/conf.d/log.conf</p><pre><code>#log.file = rabbit.loglog.dir = /var/log/rabbitmqlog.file.level = info# rotate every night at midnightlog.file.rotation.date = $D0# keep up to 5 archived log files in addition to the current onelog.file.rotation.count = 5</code></pre><pre><code class="language-bash"># https://hub.docker.com/_/rabbitmq, ç„¶åæœç´¢ management ç‰ˆæœ¬ [docker pull rabbitmq:management]pwd=`cat /proc/sys/kernel/random/uuid | cut -d'-' -f1`echo mq@$&#123;pwd&#125;;container_name=rabbitmqnetwork=cmsdocker run --name $&#123;container_name&#125; \--hostname $&#123;container_name&#125; \--network $&#123;network&#125; \--restart always \-p 5672:5672 -p 15672:15672 -p 15692:15692 \--cpus=1 \--memory=1G --memory-swap=1G \--ulimit nofile=204800 \--mount &quot;type=bind,src=/export/docker-data-rabbitmq/data,dst=/var/lib/rabbitmq&quot; \--mount &quot;type=bind,src=/export/docker-data-rabbitmq/conf.d,dst=/etc/rabbitmq/conf.d&quot; \--mount &quot;type=bind,src=/export/docker-data-rabbitmq/log,dst=/var/log/rabbitmq&quot; \-e RABBITMQ_DEFAULT_VHOST=rabbitmq \-e RABBITMQ_DEFAULT_USER=admin \-e RABBITMQ_DEFAULT_PASS=mq@$&#123;pwd&#125; \-e RABBITMQ_LOGS=rabbitmq.log \-d rabbitmq:3.8.13-management</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdockeræ–¹å¼ï¼Œ<code>RABBITMQ_LOGS</code>é»˜è®¤å€¼æ˜¯<code>-</code>ä¹Ÿå°±æ˜¯è¾“å‡ºåˆ°<code>stdout</code>, è¿™é‡Œæˆ‘æ”¹æˆäº†å…·ä½“æ–‡ä»¶</p><p>âš ï¸ ä»»ä½•é…ç½®ï¼Œç¯å¢ƒå˜é‡çš„ä¼˜å…ˆçº§å¤§äºæ–‡æœ¬é…ç½®</p><p>å®‰è£…logrotateï¼Œrabbitmqçš„æ—¥å¿—è½®è½¬ä¾æ‰˜å®ƒ</p><pre><code class="language-bash">docker exec -it rabbitmq /bin/bashapt updateapt install logrotateexit</code></pre><p>é‡å¯ rabbitmq</p><pre><code class="language-bash">docker restart rabbitmq</code></pre><h4 id="Prometheus-ç›‘æ§">Prometheus ç›‘æ§</h4><p>15692 ç«¯å£æ˜¯ prometheus é‡‡é›†å™¨çš„æš´éœ²ç«¯å£ï¼Œdockeræ–¹å¼é»˜è®¤é‡‡é›†æ’ä»¶å·²ç»å¼€å¯ã€‚</p><p>è‹¥ prometheus é‡‡é›†å™¨æ’ä»¶æ²¡æœ‰å¯åŠ¨ï¼Œå¯ä»¥è¿›å®¹å™¨é‡Œé€šè¿‡ rabbitmq-plugins enable rabbitmq_prometheus å¯åŠ¨</p><p>å®¿ä¸»æœºé‡Œæ‰§è¡Œ <code>curl -s localhost:15692/metrics | head -n 3</code>ç¡®ä¿å¯ä»¥è¿”å›é‡‡é›†å™¨æ•°æ®ã€‚</p><p>prometheusçš„å‘Šè­¦è§„åˆ™ï¼Œå¯ä»¥è®¿é—® <a href="https://awesome-prometheus-alerts.grep.to/rules#rabbitmq">Awesome Prometheus alerts | Collection of alerting rules (grep.to)</a> è·å–</p><p>grafanaçš„æ¨¡æ¿ï¼Œå¯ä»¥è®¿é—® <a href="https://grafana.com/grafana/dashboards/10991">RabbitMQ-Overview dashboard for Grafana | Grafana Labs</a></p><h3 id="rpmæ–¹å¼-è¿‡æ—¶">rpmæ–¹å¼(è¿‡æ—¶)</h3><pre><code># å®‰è£… erlang çš„ rabbitmq å…¼å®¹ç‰ˆæ–¹å¼ (å¸è½½å‘½ä»¤ yum erase erlang-*)yum install -y https://github.com/rabbitmq/erlang-rpm/releases/download/v22.0.7/erlang-22.0.7-1.el6.x86_64.rpm# å®‰è£… rabbitmq-serveryum install -y https://dl.bintray.com/rabbitmq/all/rabbitmq-server/3.7.15/rabbitmq-server-3.7.15-1.el6.noarch.rpm;## å¼€å¯ç®¡ç†rabbitmq-plugins enable rabbitmq_management;# ä¿®æ”¹ä¸€äº›å°é…ç½®vim /etc/rabbitmq/rabbitmq.conflog.file.level = warninglog.file = rabbitmq.logvim /etc/rabbitmq/rabbitmq-env.confRABBITMQ_LOG_BASE=/export/rabbitmq/logsmkdir -p /export/rabbitmq/logs &amp;&amp; chown rabbitmq:rabbitmq /export/rabbitmq/logschown rabbitmq.rabbitmq /var/lib/rabbitmq/.erlang.cookie;echo '* soft nofile 202400' &gt;&gt; /etc/security/limits.confecho '* hard nofile 202400' &gt;&gt; /etc/security/limits.conf/etc/init.d/rabbitmq-server restart;</code></pre><h3 id="æ·»åŠ ç”¨æˆ·å’Œè™šæ‹Ÿä¸»æœº">æ·»åŠ ç”¨æˆ·å’Œè™šæ‹Ÿä¸»æœº</h3><pre><code class="language-bash">#è¾“å…¥http://ip:15672å¯ä»¥ç™»å½•ç®¡ç†ç•Œé¢,# rpm å®‰è£…åï¼Œåªæœ‰é»˜è®¤è´¦æˆ·guest/guest.# docker å®‰è£…åï¼Œæœ‰ admin/admin ç”¨æˆ·# æ·»åŠ ä¸€ä¸ª vhostpro_vhost=rabbitmqctl add_vhost $&#123;pro_vhost&#125;# æ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·user_name=pwd=`cat /proc/sys/kernel/random/uuid | cut -d'-' -f1`rabbitmqctl add_user $&#123;user_name&#125; mq@$&#123;pwd&#125;;echo &quot;$&#123;user_name&#125;ç”¨æˆ·å¯†ç æ˜¯ï¼šmq@$&#123;pwd&#125;&quot;#è¯¥å‘½ä»¤ä½¿ç”¨æˆ· user_name å…·æœ‰ pro_vhost ä¸­æ‰€æœ‰èµ„æºçš„é…ç½®ã€å†™ã€è¯»æƒé™ä»¥ä¾¿ç®¡ç†å…¶ä¸­çš„èµ„æº# rabbitmqctl set_permissions -p vhost User ConfP WriteP ReadPrabbitmqctl set_permissions -p $&#123;pro_vhost&#125; $&#123;user_name&#125; &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;; # ç”¨æˆ·ç»‘å®š tags# tagså†³å®šäº†ç”¨æˆ·æ›´é«˜çº§çš„æƒé™ï¼Œ## è¶…çº§ç®¡ç†å‘˜(administrator)ï¼šå¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹)ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥å¯¹ç”¨æˆ·ï¼Œç­–ç•¥(policy)è¿›è¡Œæ“ä½œã€‚## ç›‘æ§è€…(monitoring)ï¼šå¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹)ï¼ŒåŒæ—¶å¯ä»¥æŸ¥çœ‹rabbitmqèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(è¿›ç¨‹æ•°ï¼Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µç­‰)## ç­–ç•¥åˆ¶å®šè€…(policymaker)ï¼šå¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹), åŒæ—¶å¯ä»¥å¯¹policyè¿›è¡Œç®¡ç†ã€‚ä½†æ— æ³•æŸ¥çœ‹èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(ä¸Šå›¾çº¢æ¡†æ ‡è¯†çš„éƒ¨åˆ†)## æ™®é€šç®¡ç†è€…(management)ï¼šä»…å¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹)ï¼Œæ— æ³•çœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•å¯¹ç­–ç•¥è¿›è¡Œç®¡ç†ã€‚## å…¶ä»–(other)ï¼šæ— æ³•ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œé€šå¸¸å°±æ˜¯æ™®é€šçš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚user_tag=administratorrabbitmqctl set_user_tags $&#123;user_name&#125; $&#123;user_tag&#125;;#æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·rabbitmqctl list_users;</code></pre><h3 id="çŠ¶æ€">çŠ¶æ€</h3><pre><code class="language-bash">rabbitmqctl statusrabbitmqctl list_queues -p &lt;vhost_name&gt;</code></pre><h3 id="é˜Ÿåˆ—">é˜Ÿåˆ—</h3><pre><code class="language-bash">rabbitmqctl list_queues --vhost &lt;&gt;</code></pre><h2 id="php-è¯­è¨€ä½¿ç”¨">php è¯­è¨€ä½¿ç”¨</h2><pre><code class="language-bash">wget https://github.com/alanxz/rabbitmq-c/releases/download/v0.7.1/rabbitmq-c-0.7.1.tar.gz;tar xf rabbitmq-c-0.7.1.tar.gz;cd rabbitmq-c-0.7.1;./configure --prefix=/usr/local/rabbitmq-c-0.7.1;make &amp;&amp; make install;cd ..;wget https://pecl.php.net/get/amqp-1.9.3.tgz;tar xf amqp-1.9.3.tgz;cd amqp-1.9.3;/usr/local/php/bin/phpize;./configure --with-php-config=/usr/local/php/bin/php-config --with-amqp --with-librabbitmq-dir=/usr/local/rabbitmq-c-0.7.1;make &amp;&amp; make install;php.inié‡Œæ·»åŠ ç”Ÿæˆçš„amqp.soçš„è·¯å¾„ä¿¡æ¯extension = /usr/local/php/lib/php/extensions/no-debug-non-zts-20160303/amqp.so</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> rabbitmq </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> rabbitmq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜21è¯ä¹¦ç®¡ç†</title>
      <link href="posts/e902d670/"/>
      <url>posts/e902d670/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><ul><li>å®‰è£…æ–‡æ¡£</li></ul><p><a href="https://cert-manager.io/docs/installation/helm/#installing-with-helm">https://cert-manager.io/docs/installation/helm/#installing-with-helm</a></p><ul><li>å¸è½½æ–‡æ¡£</li></ul><p><a href="https://cert-manager.io/docs/installation/helm/#uninstalling">https://cert-manager.io/docs/installation/helm/#uninstalling</a></p><ul><li>helm repoæ–‡æ¡£</li></ul><p><a href="https://artifacthub.io/packages/helm/cert-manager/cert-manager">https://artifacthub.io/packages/helm/cert-manager/cert-manager</a></p><h2 id="ä¸»è¦å¯¹è±¡">ä¸»è¦å¯¹è±¡</h2><ul><li><p>Issuer å‘½åç©ºé—´çº§åˆ«çš„å‘è¡Œè€…ï¼Œç”¨æˆ·è‡ªå»º</p></li><li><p>ClusterIssuer é›†ç¾¤çº§åˆ«çš„å‘è¡Œè€…ï¼Œç”¨æˆ·è‡ªå»º</p></li><li><p>Certificate è¯ä¹¦å¯¹è±¡ï¼Œç”¨æˆ·è‡ªå»º</p></li><li><p>CertificateRequests å¯¹è±¡è¯·æ±‚å¯¹è±¡ï¼Œæ ¹æ®Certificateåˆ›å»º</p></li><li><p>Orders è®¢å•ï¼Œæ ¹æ®Certificateåˆ›å»º</p></li><li><p>Challenges æŒ‘æˆ˜æ ¡éªŒæ‰€æœ‰æƒå¯¹è±¡ï¼Œæ ¹æ®Certificateåˆ›å»ºã€‚è‹¥è¯ä¹¦è¯·æ±‚æˆåŠŸï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ é™¤ã€‚</p><blockquote><p>Certificateså¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªdnsNameéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªï¼Œå¹¶ä¸”Challengeså¯¹è±¡æ˜¯ä¸²è¡Œæ ¡éªŒã€‚å¦‚æœç½‘ç»œä¸å¥½ï¼Œå¯èƒ½ä¼šè€—æ—¶æ¯”è¾ƒä¹…ã€‚â˜ Challenges æ˜¯æœ€æœ‰å¯èƒ½å‡ºé”™çš„å¯¹è±¡ï¼Œéœ€è¦æŒç»­å…³æ³¨ã€‚ä¾‹å¦‚ dns token é…ç½®é”™è¯¯ï¼Œæˆ–è€…ç½‘ç»œé”™è¯¯ï¼Œæˆ–è€… webhook bug å¯¼è‡´æ— æ³•æ­£ç¡®è¯·æ±‚ dns apiã€‚</p></blockquote></li></ul><h1>å®‰è£…</h1><h2 id="åˆ›å»ºCRD">åˆ›å»ºCRD</h2><pre><code class="language-bash">âœ kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.6.1/cert-manager.crds.yaml</code></pre><h2 id="æ·»åŠ Repo">æ·»åŠ Repo</h2><pre><code class="language-bash">âœ helm repo add jetstack https://charts.jetstack.io</code></pre><h2 id="å®‰è£…cert-manager">å®‰è£…cert-manager</h2><pre><code class="language-bash">âœ helm install cert-manager jetstack/cert-manager \--namespace cert-manager \--version v1.6.1 \--create-namespace \--set prometheus.enabled=true \--set webhook.timeoutSeconds=4</code></pre><h1>åŸºæœ¬è‡ªæµ‹</h1><p>åŸºæœ¬è‡ªæµ‹ï¼Œä¸ç‰µæ‰¯åˆ°çœŸæ­£çš„å‘è¡Œæ–¹ä»¥åŠç¬¬ä¸‰æ–¹webhookã€‚æ‰€ä»¥ä»…èƒ½ä¿è¯cert-managerçš„åŸºæœ¬æ­£å¸¸ã€‚</p><pre><code class="language-yaml">âœ cat &lt;&lt; EOF | tee test-selfsigned.yamlapiVersion: v1kind: Namespacemetadata:  name: cert-manager-test---apiVersion: cert-manager.io/v1kind: Issuermetadata:  name: test-selfsigned  namespace: cert-manager-testspec:  selfSigned: &#123;&#125;---apiVersion: cert-manager.io/v1kind: Certificatemetadata:  name: selfsigned-cert  namespace: cert-manager-testspec:  commonName: example.com  secretName: selfsigned-cert-tls  issuerRef:    name: test-selfsignedEOFâœ kubectl apply -f test-selfsigned.yamlâœ kubectl get Issuers,ClusterIssuers,Certificates,CertificateRequests,Orders,Challenges -n cert-manager-test -o wideNAME                                     READY   STATUS   AGEissuer.cert-manager.io/test-selfsigned   True             49sNAME                                          READY   SECRET                ISSUER            STATUS                                          AGEcertificate.cert-manager.io/selfsigned-cert   True    selfsigned-cert-tls   test-selfsigned   Certificate is up to date and has not expired   49sNAME                                                       APPROVED   DENIED   READY   ISSUER            REQUESTOR                                         STATUS                                         AGEcertificaterequest.cert-manager.io/selfsigned-cert-dwtdj   True                True    test-selfsigned   system:serviceaccount:cert-manager:cert-manager   Certificate fetched from issuer successfully   49s</code></pre><blockquote><p>è¾“å‡º Certificate is up to date and has not expiredå’ŒCertificate fetched from issuer successfully å³è¡¨ç¤ºæ­£å¸¸ã€‚</p></blockquote><p>å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œåˆ™æ£€æŸ¥å„å¯¹è±¡çŠ¶æ€æ˜¯å¦ä¸ºTrueï¼Œå‡ºç°Falseçš„ä¸€ä¸€æ’æŸ¥</p><pre><code class="language-bash">âœ kubectl describe issuer -n cert-manager-testâœ kubectl describe certificaterequests -n cert-manager-test</code></pre><h1>è¯ä¹¦ç”³è¯·</h1><p>ç”³è¯·è¯ä¹¦ï¼Œéœ€è¦é€‰ç”¨å‘è¡Œæ–¹ï¼ˆissuerï¼‰å’ŒåŸŸåæ‰€æœ‰æƒæ ¡éªŒï¼ˆChallenges ï¼‰æ–¹æ³•ã€‚è¿™é‡Œä»¥ACME+DNSæ–¹å¼æ¥é…ç½®ã€‚</p><p>è¯ä¹¦ç”³è¯·å¯¹è±¡æµç¨‹ï¼š</p><p>orderè®¢å•å¯¹è±¡-&gt;</p><p>æ–‡æ¡£ï¼š</p><p><a href="https://cert-manager.io/docs/configuration/acme/dns01/">https://cert-manager.io/docs/configuration/acme/dns01/</a></p><p><a href="https://cert-manager.io/docs/configuration/acme/dns01/#webhook">https://cert-manager.io/docs/configuration/acme/dns01/#webhook</a></p><p>ä»¥aliyun dnsä¸ºä¾‹ã€‚</p><h2 id="å®‰è£…dns-webhook">å®‰è£…dns webhook</h2><p>é€šè¿‡webhookï¼Œè®©cert-managerå¯ä»¥æ”¯æŒaliyun dnsåŸŸåæ ¡éªŒ</p><pre><code class="language-bash">âœ helm repo add cert-manager-alidns-webhook https://devmachine-fr.github.io/cert-manager-alidns-webhookâœ helm repo updateâœ helm install cert-manager-alidns-webhook cert-manager-alidns-webhook/alidns-webhook -n cert-manager --set groupName=zyh</code></pre><p>ğŸ˜’groupNameå¿…é¡»å’Œåé¢ClusterIssuerå¯¹è±¡é‡Œçš„groupNameä¿æŒä¸€è‡´ã€‚<a href="https://github.com/DEVmachine-fr/cert-manager-alidns-webhook/issues/11">https://github.com/DEVmachine-fr/cert-manager-alidns-webhook/issues/11</a></p><h2 id="æ„å»ºåŸŸåè§£ææœåŠ¡å•†token">æ„å»ºåŸŸåè§£ææœåŠ¡å•†token</h2><p>ä»¥é˜¿é‡Œäº‘dnsè§£ææœåŠ¡ä¸ºä¾‹</p><pre><code class="language-yaml">âœ kubectl create secret generic alidns-secrets --from-literal=&quot;access-token=&quot; --from-literal=&quot;secret-key=&quot; -n cert-manager</code></pre><blockquote><p>ç¡®ä¿ram akæ‹¥æœ‰dnsè§£ææœåŠ¡çš„è¯»å†™æƒé™</p></blockquote><h2 id="æ„å»ºå‘è¡Œæ–¹ClusterIssuer">æ„å»ºå‘è¡Œæ–¹ClusterIssuer</h2><p>ClusterIssuer å¯¹è±¡ç”¨æ¥æŒ‡æ˜ä½ è¦ç”¨çš„è¯ä¹¦å‘è¡Œæ–¹ï¼ˆé›†ç¾¤çº§åˆ«ï¼‰ã€‚ä»¥ACMEå‘è¡Œæ–¹ï¼Œå¹¶é‡‡ç”¨dnséªŒè¯åŸŸåæ‰€æœ‰æƒã€‚</p><p><a href="https://cert-manager.io/docs/configuration/acme/">https://cert-manager.io/docs/configuration/acme/</a></p><pre><code class="language-yaml"># æµ‹è¯•ç‰ˆæœ¬çš„å‘è¡Œæ–¹âœ   cat &lt;&lt; EOF | tee clusterissuer-letsencrypt-staging-ali.yamlapiVersion: cert-manager.io/v1kind: ClusterIssuermetadata:  name: letsencrypt-staging-alispec:  acme:    email:     server: https://acme-staging-v02.api.letsencrypt.org/directory    privateKeySecretRef:      name: letsencrypt-staging-ali    solvers:    - dns01:        webhook:          config:            regionId: cn-beijing            accessTokenSecretRef:              key: access-token              name: alidns-secrets            secretKeySecretRef:              key: secret-key              name: alidns-secrets          groupName: zyh          solverName: alidns-solverEOF# æ­£å¼ç‰ˆæœ¬çš„å‘è¡Œæ–¹âœ   cat &lt;&lt; EOF | tee clusterissuer-letsencrypt-prod-ali.yamlapiVersion: cert-manager.io/v1kind: ClusterIssuermetadata:  name: letsencrypt-prod-alispec:  acme:    email:     server: https://acme-v02.api.letsencrypt.org/directory    privateKeySecretRef:      name: letsencrypt-prod-ali    solvers:    - dns01:        webhook:          config:            regionId: cn-beijing            accessTokenSecretRef:              key: access-token              name: alidns-secrets            secretKeySecretRef:              key: secret-key              name: alidns-secrets          groupName: zyh          solverName: alidns-solverEOF</code></pre><blockquote><p>acme.server  å®šä¹‰ACMEæœåŠ¡ç«¯</p><ul><li><a href="https://acme-staging-v02.api.letsencrypt.org/directory">https://acme-staging-v02.api.letsencrypt.org/directory</a>  æµ‹è¯•æœåŠ¡å™¨</li><li><a href="https://acme-v02.api.letsencrypt.org/directory">https://acme-v02.api.letsencrypt.org/directory</a>  çº¿ä¸ŠæœåŠ¡å™¨</li></ul><p>acme.email  acme éœ€å®šä¹‰ä¸€ä¸ªACMEè´¦æˆ·é‚®ç®±ï¼Œã€è‡ªå·±å®šä¹‰ã€‘</p><p><a href="http://acme.privateKeySecretRef.name">acme.privateKeySecretRef.name</a> å­˜å‚¨ACMEè´¦æˆ·ç§é’¥çš„secretå¯¹è±¡ï¼Œä¼šè‡ªåŠ¨åˆ›å»º</p><p>webhook.config å®šä¹‰webhoobè°ƒç”¨çš„dns tokenï¼Œã€è‡ªå·±å®šä¹‰ã€‘</p><p>groupName å¹¶ä¸æ˜¯è¯ä¹¦åŒ…å«çš„åŸŸåï¼ŒæŒ‡çš„æ˜¯ç»„ç»‡åï¼Œã€è‡ªå·±å®šä¹‰ã€‘ï¼Œéœ€ä¸webhooké‡Œä¿æŒä¸€ç›´ã€‚</p><p>solverName æŒ‡å‘webhooké‡Œå®šä¹‰çš„è§£æè€…ï¼Œalidns-solver è²Œä¼¼æ˜¯å†™æ­»çš„ã€‚</p></blockquote><h2 id="æ ¡éªŒ">æ ¡éªŒ</h2><p>ç¡®è®¤  <a href="http://clusterissuer.cert-manager.io/letsencrypt-*-ali">clusterissuer.cert-manager.io/letsencrypt-*-ali</a> æ˜¯ True</p><pre><code class="language-bash">âœ   kubectl get Issuers,ClusterIssuers -n cert-managerNAME                                                          READY   AGEissuer.cert-manager.io/cert-manager-alidns-webhook-ca         True    20hissuer.cert-manager.io/cert-manager-alidns-webhook-selfsign   True    20hNAME                                                    READY   AGEclusterissuer.cert-manager.io/letsencrypt-prod-ali      True    137mclusterissuer.cert-manager.io/letsencrypt-staging-ali   True    137m</code></pre><p>å¦‚æœä½ å‘ç°å®ƒæ˜¯Falseï¼Œåˆ™é€šè¿‡describeè§‚å¯Ÿé”™è¯¯ä¿¡æ¯ã€‚åœ¨ä¸­å›½ï¼Œå¯èƒ½å‡ºç°çš„é”™è¯¯ä¿¡æ¯æœ‰ï¼š</p><ol><li><code>Error initializing issuer: context deadline exceeded</code> è¿™é€šå¸¸è¡¨æ˜æ— æ³•è®¿é—®acmeæœåŠ¡ã€‚è¿™ç§æƒ…å†µä¸‹ä½ éœ€è¦è€å¿ƒç­‰å¾…ï¼Œç›´åˆ°æ³¨å†ŒæˆåŠŸã€‚</li></ol><h2 id="æ„å»ºè¯ä¹¦Certificate">æ„å»ºè¯ä¹¦Certificate</h2><p>Certificate ç”¨äºç”³è¯·å¹¶ç”Ÿæˆè¯ä¹¦</p><pre><code class="language-bash">apiVersion: cert-manager.io/v1kind: Certificatemetadata:  name: example-com  namespace: dev-zyhspec:  secretName: example-com-tls  issuerRef:    name: letsencrypt-ali    kind: ClusterIssuer  dnsNames:  - '*.example.com'  - example.com  - example.org</code></pre><blockquote><p>namespace è¯ä¹¦ä½¿ç”¨çš„åŒºåŸŸ</p><p>secretName å­˜å‚¨è¯ä¹¦çš„secretåï¼Œä¼šè‡ªåŠ¨åˆ›å»º</p><p>issuerRef æŒ‡å®šå‘è¡Œæ–¹</p><p>dnsNames è¯ä¹¦åŒ…å«çš„åŸŸå</p></blockquote><h2 id="å†æ¬¡æ ¡éªŒ">å†æ¬¡æ ¡éªŒ</h2><pre><code class="language-bash">âœ   kubectl get Certificates,CertificateRequests,Orders,Challenges -n dev-zyh</code></pre><h2 id="æˆåŠŸç»“æœ">æˆåŠŸç»“æœ</h2><pre><code class="language-bash">âœ   kubectl get Certificates,CertificateRequests,Orders,Challenges -n dev-zyh -o wideNAME                                      READY   SECRET            ISSUER            STATUS                                          AGEcertificate.cert-manager.io/zyh-cool   True    zyh-cool-tls   letsencrypt-ali   Certificate is up to date and has not expired   15mNAME                                                   APPROVED   DENIED   READY   ISSUER            REQUESTOR                                         STATUS                                         AGEcertificaterequest.cert-manager.io/zyh-cool-jgj92   True                True    letsencrypt-ali   system:serviceaccount:cert-manager:cert-manager   Certificate fetched from issuer successfully   15mNAME                                                      STATE   ISSUER            REASON   AGEorder.acme.cert-manager.io/zyh-cool-jgj92-4122243896   valid   letsencrypt-ali            15m</code></pre><p>è¾“å‡º<code>Certificate is up to date and has not expired</code>å³ç”³è¯·æˆåŠŸã€‚</p><h2 id="é¢å¤–">é¢å¤–</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œcert-manager-alidns-webhook æ‰¿è¯ºè‡ªåŠ¨æ›´æ–°è¯ä¹¦ã€‚</p><p>è€ŒCertificateså¯¹è±¡ç”³è¯·çš„è¯ä¹¦æ—¶é—´é»˜è®¤ä¸º90å¤©ï¼Œæå‰30å¤©æ›´æ–°ã€‚</p><p>ä½ è¿˜å¯ä»¥é€šè¿‡<code>spec.duration</code>è®¾å®šè¯ä¹¦æœ‰æ•ˆæ—¶é—´ï¼Œåˆ™æ›´æ–°æ—¶é—´<code>spec.renewBefore</code>å°†é»˜è®¤è®¾å®šä¸º<code>spec.duration</code>çš„<code>2/3</code>ã€‚</p><p>ä¸è¿‡å¦‚æœç”¨<code>letsencrypt</code>ï¼Œåˆ™æ²¡æœ‰å¿…è¦è®¾å®š<code>spec.duration</code>ï¼Œå› ä¸ºä½ åªèƒ½ç”³è¯·æœ€å¤§90å¤©ã€‚</p><h1>è¯ä¹¦ä½¿ç”¨</h1><h2 id="é€šè¿‡ingressç›´æ¥ç”³è¯·è°ƒç”¨">é€šè¿‡ingressç›´æ¥ç”³è¯·è°ƒç”¨</h2><p>cert-manager é€šè¿‡ç»„ä»¶<code>ingress-shim</code>ç›‘æ§<code>Ingress</code>æ³¨è§£å’Œ<code>spec.tls</code>çš„é…ç½®ä»è€Œè‡ªåŠ¨åˆ›å»º Certificate å¯¹è±¡ï¼Œå¹¶è°ƒç”¨<code>issuer</code>æ¥ç”³è¯·è¯ä¹¦ã€‚</p><p>å‰ç½®æ¡ä»¶ï¼š</p><ul><li>issuer æˆ–è€… clusterissuer å¯¹è±¡å·²åˆ›å»º</li></ul><p>ç‰¹ç‚¹ï¼š</p><ul><li>é»˜è®¤å¦‚æœorderå½»åº•å¤±è´¥ï¼Œåˆ™1å°æ—¶ä¹‹åå°†å†æ¬¡å‘èµ·è¯·æ±‚</li></ul><p>å·²çŸ¥å¹¶ç»è¿‡éªŒè¯çš„é—®é¢˜ï¼š</p><ul><li><p>å¦‚æœ<code>ingressæ³¨è§£</code>æˆ–è€…<code>ingress.spec.tls</code>å‘ç”Ÿäº†ä¿®æ”¹ï¼Œä½†<code>ingress.spec.tls.hosts</code>å®Œå…¨æ²¡æœ‰æ”¹å˜ï¼Œåˆ™ä¸å¯ç›´æ¥applyã€‚å› ä¸ºè¿™å°†åœ¨åŒä¸€æ—¶åˆ»å‡ºç°ä¸¤ä»½é’ˆå¯¹ç›¸åŒhostså‘èµ·çš„è¯ä¹¦ç”³è¯·ã€‚è¿™ä¼šå¯¼è‡´å…¶ä¸­ä¸€ä¸ªç”³è¯·æ°¸è¿œä¸ä¼šæˆåŠŸå¹¶ä¸”é‡å¤å‘èµ·ï¼Œç›´è‡³è¿›å…¥é”å®šæœŸã€‚</p><p><a href="https://github.com/jetstack/cert-manager/issues/1888">https://github.com/jetstack/cert-manager/issues/1888</a></p><p>ğŸ’¥å¤šä¸ªingressé‡Œæ°¸è¿œä¸è¦å‡ºç°å®Œå…¨ç›¸åŒçš„<code>ingress.spec.tls.hosts</code></p></li><li><p><code>spec.tls.hosts</code> å¿…é¡»åŒ…å«<code>spec.rules.hosts  </code>ï¼Œå¦åˆ™ ingress ä¼šå°† Kubernetes Ingress Controller Fake Certificate é»˜è®¤è¯ä¹¦ä¼ é€’åˆ° ingress-controller</p></li></ul><p>ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1kind: Ingressmetadata:  annotations:    # add an annotation indicating the issuer to use.    cert-manager.io/cluster-issuer: letsencrypt-ali    cert-manager.io/duration: 2160h # 90d    cert-manager.io/renew-before: 360h # 15d  name: myIngress  namespace: dev-zyhspec:  ingressClassName: nginx  rules:  - host: zyh.cool    http:      paths:      - pathType: Prefix        path: /        backend:          service:            name: myservice            port:              number: 80  tls: # &lt; placing a host in the TLS config will determine what ends up in the cert's subjectAltNames  - hosts:    - '*.zyh.cool'    - zyh.cool    secretName: zyh-cool-tls # &lt; cert-manager will store the created certificate in this secret.</code></pre><p><code>annotations.cert-manager.io/cluster-issuer: nameOfClusterIssuer</code> <code>ingress-shim</code>ç›‘è§†æ­¤æ³¨è§£ï¼Œä»è€Œå¯åŠ¨é›†ç¾¤çº§åˆ«çš„è¯ä¹¦å‘è¡Œæ–¹</p><p><code>tls.secretName</code> æŒ‡å®šå­˜å‚¨è¯ä¹¦çš„secretå¯¹è±¡ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»º</p><p><code>tls.hosts</code> æŒ‡å®šè¯ä¹¦ç»‘å®šçš„åŸŸå</p><h2 id="æ ¡éªŒ-2">æ ¡éªŒ</h2><pre><code class="language-bash">kubectl get Certificates,CertificateRequests,Orders,Challenges -n dev-zyh</code></pre><h2 id="ä¸€ä»½è¯ä¹¦ç”³è¯·æ­£å¸¸çš„æ—¥å¿—">ä¸€ä»½è¯ä¹¦ç”³è¯·æ­£å¸¸çš„æ—¥å¿—</h2><pre><code class="language-bash">2022-01-20T14:31:04.709965618+08:00 I0120 06:31:04.709580       1 conditions.go:201] Setting lastTransitionTime for Certificate &quot;zyh-cool-prod-tls&quot; condition &quot;Ready&quot; to 2022-01-20 06:31:04.709572525 +0000 UTC m=+84737.7244719392022-01-20T14:31:04.709985148+08:00 I0120 06:31:04.709732       1 trigger_controller.go:181] cert-manager/controller/certificates-trigger &quot;msg&quot;=&quot;Certificate must be re-issued&quot; &quot;key&quot;=&quot;dev-cms/zyh-cool-prod-tls&quot; &quot;message&quot;=&quot;Issuing certificate as Secret does not exist&quot; &quot;reason&quot;=&quot;DoesNotExist&quot;2022-01-20T14:31:04.709989519+08:00 I0120 06:31:04.709741       1 conditions.go:201] Setting lastTransitionTime for Certificate &quot;zyh-cool-prod-tls&quot; condition &quot;Issuing&quot; to 2022-01-20 06:31:04.709739172 +0000 UTC m=+84737.7246385452022-01-20T14:31:04.733560526+08:00 I0120 06:31:04.733475       1 controller.go:161] cert-manager/controller/certificates-trigger &quot;msg&quot;=&quot;re-queuing item due to optimistic locking on resource&quot; &quot;key&quot;=&quot;dev-cms/zyh-cool-prod-tls&quot; &quot;error&quot;=&quot;Operation cannot be fulfilled on certificates.cert-manager.io \&quot;zyh-cool-prod-tls\&quot;: the object has been modified; please apply your changes to the latest version and try again&quot;2022-01-20T14:31:04.733613304+08:00 I0120 06:31:04.733525       1 trigger_controller.go:181] cert-manager/controller/certificates-trigger &quot;msg&quot;=&quot;Certificate must be re-issued&quot; &quot;key&quot;=&quot;dev-cms/zyh-cool-prod-tls&quot; &quot;message&quot;=&quot;Issuing certificate as Secret does not exist&quot; &quot;reason&quot;=&quot;DoesNotExist&quot;2022-01-20T14:31:04.733620510+08:00 I0120 06:31:04.733538       1 conditions.go:201] Setting lastTransitionTime for Certificate &quot;zyh-cool-prod-tls&quot; condition &quot;Issuing&quot; to 2022-01-20 06:31:04.73353554 +0000 UTC m=+84737.7484349082022-01-20T14:31:04.833325827+08:00 I0120 06:31:04.833054       1 conditions.go:261] Setting lastTransitionTime for CertificateRequest &quot;zyh-cool-prod-tls-22n7r&quot; condition &quot;Approved&quot; to 2022-01-20 06:31:04.833048731 +0000 UTC m=+84737.8479481322022-01-20T14:31:04.863021821+08:00 I0120 06:31:04.862933       1 conditions.go:261] Setting lastTransitionTime for CertificateRequest &quot;zyh-cool-prod-tls-22n7r&quot; condition &quot;Ready&quot; to 2022-01-20 06:31:04.862927112 +0000 UTC m=+84737.8778264652022-01-20T14:31:17.954783254+08:00 I0120 06:31:17.954632       1 dns.go:88] cert-manager/controller/challenges/Present &quot;msg&quot;=&quot;presenting DNS01 challenge for domain&quot; &quot;dnsName&quot;=&quot;test.zyh.cool&quot; &quot;domain&quot;=&quot;test.zyh.cool&quot; &quot;resource_kind&quot;=&quot;Challenge&quot; &quot;resource_name&quot;=&quot;zyh-cool-prod-tls-22n7r-2700220904-1691659519&quot; &quot;resource_namespace&quot;=&quot;dev-cms&quot; &quot;resource_version&quot;=&quot;v1&quot; &quot;type&quot;=&quot;DNS-01&quot; 2022-01-20T14:32:27.475094724+08:00 I0120 06:32:27.474930       1 acme.go:209] cert-manager/controller/certificaterequests-issuer-acme/sign &quot;msg&quot;=&quot;certificate issued&quot; &quot;related_resource_kind&quot;=&quot;Order&quot; &quot;related_resource_name&quot;=&quot;zyh-cool-prod-tls-22n7r-2700220904&quot; &quot;related_resource_namespace&quot;=&quot;dev-cms&quot; &quot;related_resource_version&quot;=&quot;v1&quot; &quot;resource_kind&quot;=&quot;CertificateRequest&quot; &quot;resource_name&quot;=&quot;zyh-cool-prod-tls-22n7r&quot; &quot;resource_namespace&quot;=&quot;dev-cms&quot; &quot;resource_version&quot;=&quot;v1&quot; 2022-01-20T14:32:27.475161100+08:00 I0120 06:32:27.475001       1 conditions.go:250] Found status change for CertificateRequest &quot;zyh-cool-prod-tls-22n7r&quot; condition &quot;Ready&quot;: &quot;False&quot; -&gt; &quot;True&quot;; setting lastTransitionTime to 2022-01-20 06:32:27.474997969 +0000 UTC m=+84820.4898973122022-01-20T14:32:27.537540719+08:00 I0120 06:32:27.537414       1 conditions.go:190] Found status change for Certificate &quot;zyh-cool-prod-tls&quot; condition &quot;Ready&quot;: &quot;False&quot; -&gt; &quot;True&quot;; setting lastTransitionTime to 2022-01-20 06:32:27.537409387 +0000 UTC m=+84820.5523087522022-01-20T14:32:27.552649591+08:00 E0120 06:32:27.552582       1 controller.go:211] cert-manager/controller/challenges &quot;msg&quot;=&quot;challenge in work queue no longer exists&quot; &quot;error&quot;=&quot;challenge.acme.cert-manager.io \&quot;zyh-cool-prod-tls-22n7r-2700220904-1691659519\&quot; not found&quot;  2022-01-20T14:32:27.571542097+08:00 I0120 06:32:27.571149       1 controller.go:161] cert-manager/controller/certificates-readiness &quot;msg&quot;=&quot;re-queuing item due to optimistic locking on resource&quot; &quot;key&quot;=&quot;dev-cms/zyh-cool-prod-tls&quot; &quot;error&quot;=&quot;Operation cannot be fulfilled on certificates.cert-manager.io \&quot;zyh-cool-prod-tls\&quot;: the object has been modified; please apply your changes to the latest version and try again&quot;2022-01-20T14:32:27.571579091+08:00 I0120 06:32:27.571390       1 conditions.go:190] Found status change for Certificate &quot;zyh-cool-prod-tls&quot; condition &quot;Ready&quot;: &quot;False&quot; -&gt; &quot;True&quot;; setting lastTransitionTime to 2022-01-20 06:32:27.571386394 +0000 UTC m=+84820.586285748</code></pre><p>é‡Œé¢å­˜åœ¨ä¸€äº›çœ‹èµ·æ¥æ˜¯é”™è¯¯çš„æ—¥å¿—ï¼Œä½†å…¶å®å¹¶ä¸æ˜¯ã€‚</p><h2 id="éingressç›´æ¥ç”³è¯·è°ƒç”¨">éingressç›´æ¥ç”³è¯·è°ƒç”¨</h2><p>å‰ç½®æ¡ä»¶ï¼š</p><ul><li>è¯ä¹¦å·²ç”³è¯·æˆåŠŸ</li></ul><p>ingressé…ç½®</p><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: myIngress  namespace: dev-zyhspec:  ingressClassName: nginx  rules:  - host: zyh.cool    http:      paths:      - pathType: Prefix        path: /        backend:          service:            name: myservice            port:              number: 80  tls: # &lt; placing a host in the TLS config will determine what ends up in the cert's subjectAltNames  - hosts:    - '*.zyh.cool'    - zyh.cool    secretName: zyh-cool-tls # &lt; cert-manager will store the created certificate in this secret.</code></pre><h1>ç›‘æ§</h1><p>å¾…ç»­</p><h1>å¸è½½</h1><h2 id="å¸è½½cert-manageråˆ›å»ºçš„èµ„æº">å¸è½½cert-manageråˆ›å»ºçš„èµ„æº</h2><pre><code class="language-bash">kubectl get Issuers,ClusterIssuers,Certificates,CertificateRequests,Orders,Challenges --all-namespaces</code></pre><h2 id="å¸è½½cert-manager">å¸è½½cert-manager</h2><pre><code class="language-bash">helm --namespace cert-manager delete cert-managerkubectl delete namespace cert-manager</code></pre><h2 id="åˆ é™¤CRD">åˆ é™¤CRD</h2><pre><code class="language-bash">helm list -n cert-manager -o yaml | grep app_versionkubectl delete -f https://github.com/jetstack/cert-manager/releases/download/vX.Y.Z/cert-manager.crds.yaml</code></pre><blockquote><p>vX.Y.Zéœ€è¦è‡ªå®šä¹‰</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> ssl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜002Pipelines</title>
      <link href="posts/8a33e212/"/>
      <url>posts/8a33e212/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>çº¯å›¾å½¢åŒ–çš„é…ç½®ï¼Œå¹¶ä¸èƒ½å¾ˆæœ‰æ•ˆçš„æ”¯æ’‘è‡ªåŠ¨åŒ–ï¼Œä¹Ÿä¸çµæ´»ï¼Œä¸€èˆ¬jenkinsçš„å·¥ç¨‹ä¼šé€šè¿‡Jenkinsfileæ¥é…ç½®pipelineã€‚</p><p>pipeline æœ‰å£°æ˜å’Œè„šæœ¬ä¸¤ç§æ–¹å¼ï¼Œå£°æ˜å¼å®˜æ–¹æ¯”è¾ƒæ¨èã€‚å½“ç„¶å£°æ˜ä¹Ÿå¯ä»¥åµŒå…¥è„šæœ¬ã€‚</p><p>æœ€åï¼Œè„šæœ¬è¯­è¨€é‡‡ç”¨groovyè¯­è¨€ç¼–å†™ã€‚</p><blockquote><p>å…³äºgroovyçš„è¯­æ³•ï¼Œå¯ä»¥ç®€å•çš„çœ‹çœ‹https://www.w3cschool.cn/groovy/</p></blockquote><p><a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/#%E6%B5%81%E6%B0%B4%E7%BA%BF%E8%AF%AD%E6%B3%95">æµæ°´çº¿è¯­æ³•</a></p><p>åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š<br>Jenkinså·¥ç¨‹ =&gt; scm git =&gt; Jenkinsfile =&gt; pipeline</p><h1>å£°æ˜å¼è¯­æ³•</h1><h2 id="agent">agent</h2><p>ç”¨äºæŒ‡æ˜è¿è¡Œç¨‹åºçš„èŠ‚ç‚¹</p><p>å¯ç”¨å‚æ•°ï¼š</p><ul><li>label æŒ‡å®šæ ‡ç­¾</li><li>any ä»»æ„èŠ‚ç‚¹</li><li>None é»˜è®¤èŠ‚ç‚¹</li><li>node è¯¦ç»†æè¿°æŸä¸ªèŠ‚ç‚¹ä¿¡æ¯ï¼Œå¯ä»¥åŒ…å«label</li></ul><pre><code class="language-groovy">pipeline &#123;    agent &#123;        node &#123;        label &quot;master&quot; //æŒ‡å®šã€è¿è¡ŒèŠ‚ç‚¹ã€‘çš„æ ‡ç­¾æˆ–è€…åç§°        customWorkspace &quot;$&#123;workspace&#125;&quot;        &#125;    &#125;    stages &#123;        stage &#123;            steps &#123;                pass            &#125;        &#125;    &#125;    post &#123;        always &#123;            pass        &#125;    &#125;&#125;agent &#123;    node &#123;        label &quot;master&quot; //æŒ‡å®šã€è¿è¡ŒèŠ‚ç‚¹ã€‘çš„æ ‡ç­¾æˆ–è€…åç§°        customWorkspace &quot;$&#123;workspace&#125;&quot;    &#125;&#125;</code></pre><h2 id="stages">stages</h2><p>è¿è¡Œé˜¶æ®µï¼ŒåŒ…å«å¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µåŒ…å«æ­¥éª¤æ‰€éœ€çš„ä»£ç </p><pre><code class="language-groovy">pipeline &#123;    agent any    stages &#123;        stage()&#123;            steps &#123;                pass            &#125;        &#125;    &#125;&#125;</code></pre><h2 id="post">post</h2><p>æ ¹æ®stagesè¿è¡ŒçŠ¶æ€ï¼Œæ‰§è¡Œåç»­å¤„ç†çš„ä»£ç </p><p>å¯ç”¨çŠ¶æ€:</p><ul><li>always æ€»æ˜¯æ‰§è¡Œ</li><li>changed ä»»æ„çŠ¶æ€å¯¹æ¯”ä¸Šä¸€æ¬¡æ‰§è¡Œä¸ä¸€è‡´çš„æ—¶å€™æ‰§è¡Œ</li><li>failure æœ€ç»ˆçŠ¶æ€å¤±è´¥çš„æ—¶å€™æ‰§è¡Œ</li><li>success æœ€ç»ˆçŠ¶æ€æˆåŠŸåœ°æ—¶å€™æ‰§è¡Œ</li><li>unstable ä¸­é—´çŠ¶æ€å¤±è´¥å¯¼è‡´æ— æ³•æŠµè¾¾æœ€ç»ˆé˜¶æ®µçš„æ—¶å€™æ‰§è¡Œ</li><li>aborted æ‰‹åŠ¨å–æ¶ˆçš„æ—¶å€™æ‰§è¡Œ</li></ul><pre><code class="language-groovy">pipeline &#123;    agent any    stages &#123;        stage &#123;            pass        &#125;    &#125;    post &#123;        always &#123;            pass        &#125;    &#125;&#125;</code></pre><p>é™¤äº†ä¸Šé¢çš„ä¸‰å¤§å—ï¼Œåœ¨agentåï¼Œä½ è¿˜å¯ä»¥æ·»åŠ ä¸€äº›é¢å¤–çš„</p><h2 id="environment">environment</h2><p>ç¯å¢ƒå˜é‡</p><pre><code class="language-groovy">pipeline &#123;    agent    environment &#123;        key = &quot;123456&quot;    &#125;&#125;</code></pre><h2 id="options">options</h2><p>é…ç½®ç‰¹å®šäºæµæ°´çº¿çš„é€‰é¡¹</p><ul><li>buildDiscarder: ä¸ºæœ€è¿‘çš„æµæ°´çº¿è¿è¡Œçš„ç‰¹å®šæ•°é‡ä¿å­˜ç»„ä»¶å’Œæ§åˆ¶å°è¾“å‡ºã€‚</li><li>disableConcurrentBuilds: ä¸å…è®¸åŒæ—¶æ‰§è¡Œæµæ°´çº¿ã€‚ å¯è¢«ç”¨æ¥é˜²æ­¢åŒæ—¶è®¿é—®å…±äº«èµ„æºç­‰ã€‚</li><li>overrideIndexTriggers: å…è®¸è¦†ç›–åˆ†æ”¯ç´¢å¼•è§¦å‘å™¨çš„é»˜è®¤å¤„ç†ã€‚</li><li>skipDefaultCheckout: åœ¨<code>agent</code> æŒ‡ä»¤ä¸­ï¼Œè·³è¿‡ä»æºä»£ç æ§åˆ¶ä¸­æ£€å‡ºä»£ç çš„é»˜è®¤æƒ…å†µã€‚</li><li>skipStagesAfterUnstable: ä¸€æ—¦æ„å»ºçŠ¶æ€å˜å¾—UNSTABLEï¼Œè·³è¿‡è¯¥é˜¶æ®µã€‚</li><li>checkoutToSubdirectory: åœ¨å·¥ä½œç©ºé—´çš„å­ç›®å½•ä¸­è‡ªåŠ¨åœ°æ‰§è¡Œæºä»£ç æ§åˆ¶æ£€å‡ºã€‚</li><li>timeout: è®¾ç½®æµæ°´çº¿è¿è¡Œçš„è¶…æ—¶æ—¶é—´, åœ¨æ­¤ä¹‹åï¼ŒJenkinså°†ä¸­æ­¢æµæ°´çº¿ã€‚</li><li>retry: åœ¨å¤±è´¥æ—¶, é‡æ–°å°è¯•æ•´ä¸ªæµæ°´çº¿çš„æŒ‡å®šæ¬¡æ•°ã€‚</li><li>timestamps é¢„æµ‹æ‰€æœ‰ç”±æµæ°´çº¿ç”Ÿæˆçš„æ§åˆ¶å°è¾“å‡ºï¼Œä¸è¯¥æµæ°´çº¿å‘å‡ºçš„æ—¶é—´ä¸€è‡´ã€‚</li></ul><pre><code class="language-groovy">pipeline &#123;agent anyoptions &#123;    timeout(time: 1, unit: 'HOURS') &#125;stages &#123;    stage('Example') &#123;        steps &#123;            echo 'Hello World'        &#125;    &#125;&#125;&#125;</code></pre><h2 id="parameters">parameters</h2><p>æ·»åŠ ä¸€äº›å‚æ•°ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œå‚æ•°åªæœ‰æµæ°´çº¿è¿è¡Œä¸€æ¬¡åï¼Œæ‰å¯ä»¥åœ¨webå›¾å½¢åŒ–é‡Œçœ‹åˆ°ç›¸å…³çš„é…ç½®</p><pre><code class="language-groovy">pipeline &#123;    agent any    parameters &#123;        string(name: 'PERSON', defaultValue: 'Mr Jenkins', description: 'Who should I say hello to?')    &#125;    stages &#123;        stage('Example') &#123;            steps &#123;                echo &quot;Hello $&#123;params.PERSON&#125;&quot;            &#125;        &#125;    &#125;&#125;</code></pre><h2 id="triggers">triggers</h2><p>è§¦å‘å™¨</p><ul><li>cron è®¡åˆ’ä»»åŠ¡</li><li>pollSCM ä¸ cron ç±»ä¼¼</li><li>upstream  æ¥å—é€—å·åˆ†éš”çš„å·¥ä½œå­—ç¬¦ä¸²å’Œé˜ˆå€¼ã€‚ å½“å­—ç¬¦ä¸²ä¸­çš„ä»»ä½•ä½œä¸šä»¥æœ€å°é˜ˆå€¼ç»“æŸæ—¶ï¼Œæµæ°´çº¿è¢«é‡æ–°è§¦å‘ã€‚</li></ul><pre><code class="language-groovy">triggers &#123; upstream(upstreamProjects: 'job1,job2', threshold: hudson.model.Result.SUCCESS) &#125;</code></pre><pre><code class="language-groovy">pipeline &#123;    agent any    triggers &#123;        cron('H */4 * * 1-5')    &#125;    stages &#123;        stage('Example') &#123;            steps &#123;                echo 'Hello World'            &#125;        &#125;    &#125;&#125;</code></pre><h2 id="tools">tools</h2><p>è·å–é€šè¿‡è‡ªåŠ¨å®‰è£…æˆ–æ‰‹åŠ¨æ”¾ç½®å·¥å…·çš„ç¯å¢ƒå˜é‡ã€‚æ”¯æŒmaven/jdk/gradleã€‚å·¥å…·çš„åç§°å¿…é¡»åœ¨ç³»ç»Ÿè®¾ç½®-&gt;å…¨å±€å·¥å…·é…ç½®ä¸­å®šä¹‰ã€‚</p><p>ç¤ºä¾‹:</p><pre><code class="language-groovy">pipeline &#123;    agent any    tools &#123;        maven 'apache-maven-3.0.1'     &#125;    stages &#123;        stage('Example') &#123;            steps &#123;                sh 'mvn --version'            &#125;        &#125;    &#125;&#125;</code></pre><h2 id="input">input</h2><p>inputç”¨æˆ·åœ¨æ‰§è¡Œå„ä¸ªé˜¶æ®µçš„æ—¶å€™ï¼Œç”±äººå·¥ç¡®è®¤æ˜¯å¦ç»§ç»­è¿›è¡Œã€‚</p><ul><li>message å‘ˆç°ç»™ç”¨æˆ·çš„æç¤ºä¿¡æ¯ã€‚</li><li>id å¯é€‰ï¼Œé»˜è®¤ä¸ºstageåç§°ã€‚</li><li>ok é»˜è®¤è¡¨å•ä¸Šçš„okæ–‡æœ¬ã€‚</li><li>submitter å¯é€‰çš„,ä»¥é€—å·åˆ†éš”çš„ç”¨æˆ·åˆ—è¡¨æˆ–å…è®¸æäº¤çš„å¤–éƒ¨ç»„åã€‚é»˜è®¤å…è®¸ä»»ä½•ç”¨æˆ·ã€‚</li><li>submitterParameter ç¯å¢ƒå˜é‡çš„å¯é€‰åç§°ã€‚å¦‚æœå­˜åœ¨ï¼Œç”¨<code>submitter</code> åç§°è®¾ç½®ã€‚</li><li>parameters æç¤ºæäº¤è€…æä¾›çš„ä¸€ä¸ªå¯é€‰çš„å‚æ•°åˆ—è¡¨ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><pre><code class="language-groovy">pipeline &#123;    agent any    stages &#123;        stage('Example') &#123;            input &#123;                message &quot;Should we continue?&quot; // æç¤ºä¿¡æ¯                ok &quot;Yes, we should.&quot; // ç¡®è®¤æŒ‰é’®çš„æ ‡é¢˜                submitter &quot;alice,bob&quot; // å…è®¸çš„æäº¤è€…                parameters &#123;                    string(name: 'PERSON', defaultValue: 'Mr Jenkins', description: 'Who should I say hello to?')                &#125;            &#125;            steps &#123;                echo &quot;Hello, $&#123;PERSON&#125;, nice to meet you.&quot;            &#125;        &#125;    &#125;&#125;</code></pre><h2 id="when">when</h2><p>when æŒ‡ä»¤å…è®¸æµæ°´çº¿æ ¹æ®ç»™å®šçš„æ¡ä»¶å†³å®šæ˜¯å¦åº”è¯¥æ‰§è¡Œé˜¶æ®µã€‚ when æŒ‡ä»¤å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ã€‚ å¦‚æœ<code>when</code> æŒ‡ä»¤åŒ…å«å¤šä¸ªæ¡ä»¶, æ‰€æœ‰çš„å­æ¡ä»¶å¿…é¡»è¿”å›Trueï¼Œé˜¶æ®µæ‰èƒ½æ‰§è¡Œã€‚ è¿™ä¸å­æ¡ä»¶åœ¨ allOf æ¡ä»¶ä¸‹åµŒå¥—çš„æƒ…å†µç›¸åŒã€‚</p><p>å†…ç½®æ¡ä»¶</p><ul><li><p>branch: å½“æ­£åœ¨æ„å»ºçš„åˆ†æ”¯ä¸æ¨¡å¼ç»™å®šçš„åˆ†æ”¯åŒ¹é…æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µï¼Œè¿™åªé€‚ç”¨äºå¤šåˆ†æ”¯æµæ°´çº¿ä¾‹å¦‚:</p><pre><code class="language-groovy">when &#123; branch 'master' &#125;</code></pre></li><li><p>environment: å½“æŒ‡å®šçš„ç¯å¢ƒå˜é‡æ˜¯ç»™å®šçš„å€¼æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªæ­¥éª¤,ä¾‹å¦‚:</p><pre><code class="language-groovy">when &#123; environment name: 'DEPLOY_TO', value: 'production' &#125;</code></pre></li><li><p>expression å½“æŒ‡å®šçš„Groovyè¡¨è¾¾å¼è¯„ä¼°ä¸ºtrueæ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ, ä¾‹å¦‚:</p><pre><code class="language-groovy">when &#123; expression &#123; return params.DEBUG_BUILD &#125; &#125;</code></pre></li><li><p>not å½“åµŒå¥—æ¡ä»¶æ˜¯é”™è¯¯æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚:</p><pre><code class="language-groovy">when &#123; not &#123; branch 'master' &#125; &#125;</code></pre></li><li><p>allOf å½“æ‰€æœ‰çš„åµŒå¥—æ¡ä»¶éƒ½æ­£ç¡®æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚:</p><pre><code class="language-groovy">when &#123; allOf &#123; branch 'master'; environment name: 'DEPLOY_TO', value: 'production' &#125; &#125;</code></pre></li><li><p>anyOf å½“è‡³å°‘æœ‰ä¸€ä¸ªåµŒå¥—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªé˜¶æ®µ,å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ¡ä»¶ï¼Œä¾‹å¦‚:</p><pre><code class="language-groovy">when &#123; anyOf &#123; branch 'master'; branch 'staging' &#125; &#125;</code></pre></li></ul><p>ç¤ºä¾‹ï¼š</p><pre><code class="language-groovy">pipeline &#123;    agent any    stages &#123;        stage('Example Build') &#123;            steps &#123;                echo 'Hello World'            &#125;        &#125;        stage('Example Deploy') &#123;            when &#123;                branch 'production'            &#125;            steps &#123;                echo 'Deploying'            &#125;        &#125;    &#125;&#125;pipeline &#123;    agent any    stages &#123;        stage('Example Build') &#123;            steps &#123;                echo 'Hello World'            &#125;        &#125;        stage('Example Deploy') &#123;            when &#123;                branch 'production'                environment name: 'DEPLOY_TO', value: 'production'            &#125;            steps &#123;                echo 'Deploying'            &#125;        &#125;    &#125;&#125;pipeline &#123;    agent any    stages &#123;        stage('Example Build') &#123;            steps &#123;                echo 'Hello World'            &#125;        &#125;        stage('Example Deploy') &#123;            when &#123;                allOf &#123;                    branch 'production'                    environment name: 'DEPLOY_TO', value: 'production'                &#125;            &#125;            steps &#123;                echo 'Deploying'            &#125;        &#125;    &#125;&#125;pipeline &#123;    agent any    stages &#123;        stage('Example Build') &#123;            steps &#123;                echo 'Hello World'            &#125;        &#125;        stage('Example Deploy') &#123;            when &#123;                branch 'production'                anyOf &#123;                    environment name: 'DEPLOY_TO', value: 'production'                    environment name: 'DEPLOY_TO', value: 'staging'                &#125;            &#125;            steps &#123;                echo 'Deploying'            &#125;        &#125;    &#125;&#125;pipeline &#123;    agent any    stages &#123;        stage('Example Build') &#123;            steps &#123;                echo 'Hello World'            &#125;        &#125;        stage('Example Deploy') &#123;            when &#123;                expression &#123; BRANCH_NAME ==~ /(production|staging)/ &#125;                anyOf &#123;                    environment name: 'DEPLOY_TO', value: 'production'                    environment name: 'DEPLOY_TO', value: 'staging'                &#125;            &#125;            steps &#123;                echo 'Deploying'            &#125;        &#125;    &#125;&#125;pipeline &#123;    agent none    stages &#123;        stage('Example Build') &#123;            steps &#123;                echo 'Hello World'            &#125;        &#125;        stage('Example Deploy') &#123;            agent &#123;                label &quot;some-label&quot;            &#125;            when &#123;                beforeAgent true                branch 'production'            &#125;            steps &#123;                echo 'Deploying'            &#125;        &#125;    &#125;&#125;</code></pre><h2 id="parallel">parallel</h2><p>å£°æ˜å¼æµæ°´çº¿çš„é˜¶æ®µå¯ä»¥åœ¨ä»–ä»¬å†…éƒ¨å£°æ˜å¤šéš”åµŒå¥—é˜¶æ®µ, å®ƒä»¬å°†å¹¶è¡Œæ‰§è¡Œã€‚ æ³¨æ„ï¼Œä¸€ä¸ªé˜¶æ®µå¿…é¡»åªæœ‰ä¸€ä¸ª steps æˆ– <code>parallel</code>çš„é˜¶æ®µã€‚ åµŒå¥—é˜¶æ®µæœ¬èº«ä¸èƒ½åŒ…å« è¿›ä¸€æ­¥çš„ <code>parallel</code> é˜¶æ®µ, ä½†æ˜¯å…¶ä»–çš„é˜¶æ®µçš„è¡Œä¸ºä¸ä»»ä½•å…¶ä»– stage<code>parallel</code>çš„é˜¶æ®µä¸èƒ½åŒ…å« <code>agent</code> æˆ– <code>tools</code>é˜¶æ®µ, å› ä¸ºä»–ä»¬æ²¡æœ‰ç›¸å…³ <code>steps</code>ã€‚</p><p>å¦å¤–, é€šè¿‡æ·»åŠ  <code>failFast true</code> åˆ°åŒ…å«<code>parallel</code>çš„ <code>stage</code>ä¸­ï¼Œ å½“å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥å¼ºåˆ¶æ‰€æœ‰çš„ <code>parallel</code> é˜¶æ®µéƒ½è¢«ç»ˆæ­¢ã€‚</p><p>ç¤ºä¾‹:</p><pre><code class="language-groovy">pipeline &#123;    agent any    stages &#123;        stage('Non-Parallel Stage') &#123;            steps &#123;                echo 'This stage will be executed first.'            &#125;        &#125;        stage('Parallel Stage') &#123;            when &#123;                branch 'master'            &#125;            failFast true  // å¦‚æœç¬¬ä¸€ä¸ªstageå¤±è´¥ï¼Œåˆ™åç»­stageä¸å†æ‰§è¡Œ            parallel &#123;                stage('Branch A') &#123;                    agent &#123;                        label &quot;for-branch-a&quot;                    &#125;                    steps &#123;                        echo &quot;On Branch A&quot;                    &#125;                &#125;                stage('Branch B') &#123;                    agent &#123;                        label &quot;for-branch-b&quot;                    &#125;                    steps &#123;                        echo &quot;On Branch B&quot;                    &#125;                &#125;            &#125;        &#125;    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜åŠ¨æ€agent</title>
      <link href="posts/3b5cd3e1/"/>
      <url>posts/3b5cd3e1/</url>
      
        <content type="html"><![CDATA[<h2 id="æµç¨‹">æµç¨‹</h2><p>jenkins-master -&gt; pipeline -&gt; kubernetes æ’ä»¶ -&gt; kubernetes é›†ç¾¤ -&gt; jenkins-agentã€k8s podã€‘ -&gt; jenkins-master</p><h2 id="å‡­è¯ä¿¡æ¯">å‡­è¯ä¿¡æ¯</h2><p>é€šè¿‡ kube config é‡Œçš„åŠ å¯†ä¿¡æ¯è·å–å‡­æ®æ‰€éœ€çš„è¯ä¹¦</p><pre><code class="language-bash">certificate-authority-data=client-certificate-data=client-key-data=echo &quot;$&#123;certificate-authority-data&#125;&quot; | base64 -d &gt; ca.crtecho &quot;$&#123;client-certificate-data&#125;&quot; | base64 -d &gt; client.crtecho &quot;$&#123;client-key-data&#125;&quot; | base64 -d &gt; client.keyopenssl pkcs12 -export -out cert.pfx -inkey client.key -in client.crt -certfile ca.crt</code></pre><p>å°† pkcs12 ä¼ è¾“åˆ° jenkins å‡­æ®ä¸­</p><p><img src="/posts/3b5cd3e1/image-20210116152344875.png" alt="image-20210116152344875"></p><p>ğŸ’ä½ éœ€è¦åœ¨å‡­æ®ã€å¯†ç ã€‘ä½ç½®ä¸­è¾“å…¥ä½ ç”Ÿæˆ pkcs12 è¯ä¹¦æ—¶è¾“å…¥çš„å¯†ç .</p><h2 id="å®‰è£…æ’ä»¶">å®‰è£…æ’ä»¶</h2><ol><li>å®‰è£… kubernetes æ’ä»¶</li><li>æ·»åŠ ä¸€ä¸ªæ–°çš„æ’ä»¶é…ç½®</li></ol><p><img src="/posts/3b5cd3e1/image-20210116152033813.png" alt="image-20210116152033813"></p><ol start="3"><li>ç¡®ä¿æ’ä»¶é…ç½®ã€è¿æ¥æµ‹è¯•ã€‘æ˜¾ç¤ºæˆåŠŸè¿æ¥</li></ol><h2 id="é…ç½®-pipeline-åŠ¨æ€ç”Ÿæˆ-agent">é…ç½® pipeline åŠ¨æ€ç”Ÿæˆ agent</h2><p>å…³äº agent çš„ pod æ¨¡æ¿ï¼Œé»˜è®¤æ’ä»¶å·²ç»æä¾›äº†ä¸€ä¸ªï¼Œåªä¸è¿‡ä½ çœ‹ä¸åˆ°ã€‚å› æ­¤å“ªæ€•ä½ ä»€ä¹ˆéƒ½ä¸åšï¼Œä½  pipeline stages ä¹Ÿä¼šåœ¨é»˜è®¤çš„ agent pod é‡Œæ‰§è¡Œã€‚</p><p>æˆ‘ä»¬ä¸€èˆ¬é€‰æ‹©ç»™ agent pod æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨ï¼Œè¿™ä¸ªé¢å¤–çš„å®¹å™¨é‡ŒåŒ…å«äº†æˆ‘ä»¬æ‰§è¡Œ stages æ‰€éœ€è¦çš„ç¯å¢ƒï¼Œä¾‹å¦‚å« jenkinstoolsã€‚</p><p>å³æœ€ç»ˆï¼Œæ•´ä¸ªpodåŒ…å«ä¸¤ä¸ªå®¹å™¨ï¼Œåˆ†åˆ«æ˜¯æ²Ÿé€š jenkins-master çš„ jenkins-agent æœåŠ¡å’Œæ‰§è¡Œæˆ‘ä»¬å·¥ä½œæµæ­¥éª¤çš„ jenkinstools å®¹å™¨ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><p>å¤šå®¹å™¨ pod æ¨¡æ¿æœ‰è¯¸å¤šçš„ç¡¬æ€§é™åˆ¶ï¼š</p><p>Multiple containers can be defined in a pod. One of them is automatically created with name <code>jnlp</code>, and runs the Jenkins JNLP agent service, with args <code>$&#123;computer.jnlpmac&#125; $&#123;computer.name&#125;</code>, and will be the container acting as Jenkins agent.</p><p>Other containers must run a long running process, so the container does not exit. If the default entrypoint or command just runs something and exit then it should be overridden with something like <code>cat</code> with <code>ttyEnabled: true</code>.</p><p><strong>WARNING</strong> If you want to provide your own Docker image for the JNLP agent, you <strong>must</strong> name the container <code>jnlp</code> so it overrides the default one. Failing to do so will result in two agents trying to concurrently connect to the master.</p><ol><li>jnlp agent å®¹å™¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå“ªæ€•ä½ æ²¡æœ‰å®šä¹‰ã€‚</li><li>å¦‚æœä½ è‡ªå®šä¹‰äº† JNLP æœåŠ¡æ‰€åœ¨çš„å®¹å™¨ï¼Œé‚£ä¹ˆè´Ÿè´£è¿æ¥ master çš„ jnlp agent å®¹å™¨åå¿…é¡»å« jnlpã€‚</li><li>å…¶å®ƒå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨æ¥æ‰§è¡Œ stages çš„å®¹å™¨ï¼Œå¿…é¡»è¿è¡Œä¸€ä¸ªæŒä¹…çš„ç¨‹åºï¼Œä»¥ä¾¿äºå®¹å™¨ä¸ä¼šè‡ªåŠ¨é€€å‡ºã€‚ä¾‹å¦‚ cat å‘½ä»¤å¹¶é™„åŠ ä¸€ä¸ªä¼ªç»ˆç«¯ã€‚</li><li>stages é˜¶æ®µæ‰§è¡Œçš„æ—¶å€™ï¼Œå¿…é¡»æ˜ç¡®çš„æŒ‡å®šé¢å¤–å®¹å™¨ï¼Œå¦åˆ™ä¼šé»˜è®¤åœ¨ jnlp å®¹å™¨é‡Œæ‰§è¡Œ. ï¼ˆè¿™ä¸ªä¸æ˜¯å¾ˆç¡®å®šï¼Œä½†æ˜¯æˆ‘æµ‹è¯•æ˜¯è¿™æ ·ï¼‰</li></ol><p>ä¸‹å›¾æ˜¯æˆ‘çš„ pod æ¨¡æ¿é…ç½®ï¼ˆéƒ¨åˆ†æˆªå›¾ï¼‰</p><p><img src="/posts/3b5cd3e1/image-20210126182630608.png" alt="image-20210126182630608"></p><p>åœ¨ pipeline é‡Œè°ƒç”¨æ’ä»¶é…ç½®</p><pre><code>pipeline&#123;    agent&#123;        kubernetes&#123;            label &quot;jenkins-agent&quot; // pod æ¨¡æ¿æ ‡ç­¾            cloud 'kubernetes'  // æ’ä»¶é…ç½®å        &#125;    &#125;    stages &#123;        stage('Start Command On Remote Machine') &#123;            steps &#123;                container('jenkinstools') &#123;  // æ˜ç¡®æŒ‡å®š pod é‡Œçš„æ‰§è¡Œå®¹å™¨å                    script&#123;                        mytools.getRemoteIP(serverIP)                        mytools.ansible(ansibleRemoteUser,&quot;$&#123;ansibleShellCommand&#125;&quot;)                    &#125;                &#125;            &#125;        &#125;    &#125;&#125;</code></pre><h2 id="é—®é¢˜ç‚¹">é—®é¢˜ç‚¹</h2><h3 id="é¢å¤–çš„è‡ªå®šä¹‰-pod-å±æ€§">é¢å¤–çš„è‡ªå®šä¹‰ pod å±æ€§</h3><p>é»˜è®¤ pod æ¨¡æ¿çš„ web ç•Œé¢ï¼Œå¹¶æ²¡æœ‰æä¾›æ‰€æœ‰çš„å±æ€§è¾“å…¥æ¡†ï¼Œä¾‹å¦‚ spec.hostAliases æŒ‡å®šè‡ªå®šä¹‰åŸŸåè§£æ</p><p>å› æ­¤ï¼Œå½“éœ€è¦ä¸€äº›è‡ªå®šä¹‰çš„å±æ€§æ—¶ï¼Œå°±éœ€è¦ç¼–å†™è‡ªå®šä¹‰çš„ yamlï¼Œå¹¶å°†å…¶å¡«å…¥ ã€Raw YAML for the Podã€‘ï¼Œå¹¶å°†ã€Yaml merge strategyã€‘è®¾ç½®ä¸º ã€Mergeã€‘</p><p>ä»¥æ·»åŠ è‡ªå®šä¹‰åŸŸåè§£æä¸ºä¾‹ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podspec:  hostAliases:  - ip: &quot;1.1.1.1&quot;    hostnames:    - &quot;test.com&quot;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜003å…±äº«åº“</title>
      <link href="posts/e4df8a4f/"/>
      <url>posts/e4df8a4f/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p><a href="https://www.jenkins.io/zh/doc/book/pipeline/shared-libraries/">https://www.jenkins.io/zh/doc/book/pipeline/shared-libraries/</a></p><p>å¤šä¸ªJenkinså·¥ç¨‹çš„æµæ°´çº¿å¯èƒ½åŒ…å«é‡å¤ä»£ç ï¼Œå› æ­¤è¿™äº›é‡å¤ä»£ç å¯ä»¥å‰¥ç¦»å‡ºæ¥ä»è€Œè¢«å…±äº«ä½¿ç”¨ï¼Œè¿™ç§ä¸œè¥¿å«å…±äº«åº“.</p><h1>åŸºæœ¬ç»“æ„</h1><pre><code class="language-groovy">(root)+- src                     # Groovy source files|   +- org|       +- devops|           +- tools.groovy  # for org.devops.tools class+- vars|   +- devops.groovy          # for global 'devops' variable|   +- devops.txt             # help for 'devops' variable+- resources               # resource files (external libraries only)|   +- org|       +- devops|           +- tools.json    # static helper data for org.devops.Bar</code></pre><h1>åŸºæœ¬å†™æ³•</h1><p>/src/org/devops/tools.groovy</p><pre><code class="language-groovy">package org.devops//æ ¼å¼åŒ–è¾“å‡º, éœ€è¦AnsiColoræ’ä»¶æ”¯æŒ.def myPrint(content, color)&#123;    colors = ['red'   : &quot;\033[40;31m #############$&#123;content&#125;############# \033[0m&quot;,              'green' : &quot;\033[40;32m #############$&#123;content&#125;############# \033[0m&quot;,              'yellow' : &quot;\033[40;33m #############$&#123;content&#125;############# \033[0m&quot;,              'blue'  : &quot;\033[47;34m #############$&#123;content&#125;############# \033[0m&quot;]    ansiColor('xterm') &#123;        println(colors[color])    &#125;&#125;//å°è£…chatBotè¯·æ±‚ï¼Œ éœ€è¦ http request æ’ä»¶def myChat(reqMode,reqUrl,reqBody)&#123;    result = httpRequest httpMode: reqMode,                accept: &quot;APPLICATION_JSON_UTF8&quot;,                contentType: &quot;APPLICATION_JSON_UTF8&quot;,                consoleLogResponseBody: true,                ignoreSslErrors: true,                requestBody: reqBody,                url: reqUrl                quiet: true    return result&#125;//æ ¹æ®æ ‡ç­¾è·å–ç›®æ ‡æœºå™¨ip, å¹¶å†™å…¥åˆ° .hosts æ–‡ä»¶ä¸­//ipType: PublicIpAddress PrivateIpAddressdef getEc2Ip(ipType, tagKey, tagValue, Region) &#123;    sh &quot;&quot;&quot;      export AWS_DEFAULT_REGION=$&#123;Regionssss&#125;      aws ec2 describe-instances --filters &quot;Name=tag:$&#123;tagKey&#125;,Values=$&#123;tagValue&#125;&quot; --query 'Reservations[*].Instances[*].[$&#123;ipType&#125;]' --output text &gt; .hosts      cat .hosts   &quot;&quot;&quot;&#125;def getRemoteIP(serverIP) &#123;    sh &quot;&quot;&quot;        echo $&#123;serverIP&#125; &gt; .hosts        cat .hosts    &quot;&quot;&quot;&#125;// è·å–é˜¿é‡Œäº‘ acr æœåŠ¡çš„åŠ¨æ€ token, å¾—åˆ°å…¨å±€å˜é‡ ACRUSER å’Œ ACRPWD// &#123;&quot;data&quot;:&#123;&quot;authorizationToken&quot;:&quot;abcde123456&quot;,&quot;tempUserName&quot;:&quot;cr_temp_user&quot;,&quot;expireDate&quot;:1612348203000&#125;&#125;def getAliAcrToken(url) &#123;    sh (        script: &quot;&quot;&quot;curl -sq $url &gt; acr.token;            cat acr.token | jq -r .'[&quot;data&quot;][&quot;tempUserName&quot;]' &gt; acr.user;            cat acr.token | jq -r .'[&quot;data&quot;][&quot;authorizationToken&quot;]' &gt;&gt; acr.pwd;        &quot;&quot;&quot;    )&#125;// éœ€è¦æå‰éƒ¨ç½²å¥½ç§é’¥ /root/.remote.pem// å¯¹åº”çš„å…¬é’¥éœ€è¦æ”¾ç½®åœ¨ç›®æ ‡æœºå™¨çš„ $&#123;remoteUser&#125; ç”¨æˆ·ä¸­// .hosts å­˜æ”¾åœ¨å·¥ä½œç›®å½•ä¸‹def ansible(remoteUser,shellCommand) &#123;    sh &quot;&quot;&quot;        ansible -i .hosts --private-key /root/.remote.pem -u $&#123;remoteUser&#125; all -m shell -a &quot;$&#123;shellCommand&#125;&quot;    &quot;&quot;&quot;&#125;</code></pre><h2 id="å…³è”pipeline-libraries">å…³è”pipeline libraries</h2><p>jenkins ç³»ç»Ÿç®¡ç†-ç³»ç»Ÿé…ç½®-Global Pipeline Libraries</p><blockquote><p>è¿™é‡Œå°†å…±äº«åº“æ”¾åˆ°gitä¸Šï¼Œé€šè¿‡gitæ‹‰å»å…±äº«åº“.</p></blockquote><p><img src="/posts/e4df8a4f/image-20211102114354246.png" alt="image-20211102114354246"></p><h2 id="è°ƒç”¨pipeline-libraries">è°ƒç”¨pipeline libraries</h2><p>jenkinså·¥ç¨‹çš„pipelineä»£ç å¼€å¤´æ·»åŠ ï¼Œå³jenkinsfileæ–‡ä»¶ä¸­</p><pre><code class="language-groovy">pipeline &#123;    @Library('jenkinslib') _  //å¯¼å…¥libåº“, 'jenkinslib' åå°±æ˜¯ä¸Šä¸€æ­¥é‡ŒGlobal Pipeline Librariesé…ç½®çš„å    def tools = new org.devops.tools()  //åŠ è½½tools    agent &#123;        ...    &#125;    stages &#123;        stage(&quot;ç¬¬ä¸€ä¸ªé˜¶æ®µ&quot;) &#123;            steps &#123;                tool.myPrint(&quot;ç¬¬ä¸€ä¸ªæ­¥éª¤&quot;,&quot;green&quot;)            &#125;        &#125;    &#125;    post &#123;        ...    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>aliyunâ˜oss</title>
      <link href="posts/b5d7d6ee/"/>
      <url>posts/b5d7d6ee/</url>
      
        <content type="html"><![CDATA[<h2 id="æ„å»º-oss-å­˜å‚¨æ¡¶">æ„å»º oss å­˜å‚¨æ¡¶</h2><ul><li>æ‰§è¡Œè„šæœ¬ï¼ˆæ‰§è¡Œæœ¬è„šæœ¬è·‘åˆ°é˜¿é‡Œäº‘çš„äº‘ç«¯cliå»æ‰§è¡Œï¼‰</li></ul><pre><code class="language-python">#!/usr/bin/python3.6# -*- coding: utf-8 -*-###  Usageï¼šhttps://help.aliyun.com/document_detail/32027.html##  Githubï¼šhttps://github.com/aliyun/aliyun-oss-python-sdk##  author: zyhimport oss2, osfrom oss2.models import (LifecycleExpiration, LifecycleRule,                        BucketLifecycle,AbortMultipartUpload,                        TaggingRule, Tagging, StorageTransition,                        NoncurrentVersionStorageTransition,                        NoncurrentVersionExpiration)from oss2.models import Tagging, TaggingRule#from aliyunsdkcore.client import AcsClientfrom aliyunsdkcore.acs_exception.exceptions import ClientExceptionfrom aliyunsdkcore.acs_exception.exceptions import ServerExceptionfrom aliyunsdkram.request.v20150501.CreatePolicyRequest import CreatePolicyRequest####################################region = 'æˆ‘æ˜¯åŒºåŸŸID'bucketName = 'æˆ‘æ˜¯æ¡¶å'project = 'æˆ‘æ˜¯æ ‡ç­¾projectçš„å€¼'akey = skey = ###################################endpoint = 'http://oss-&#123;0&#125;.aliyuncs.com'.format(region)auth = oss2.Auth(akey,skey)bucket = oss2.Bucket(auth, endpoint, bucketName)# create bucketbucket.create_bucket()# add tagrule = TaggingRule()rule.add('project', project)tagging = Tagging(rule)bucket.put_bucket_tagging(tagging)# init dirsbucket.put_object('conf/README','æˆ‘æ˜¯å­˜æ”¾é…ç½®çš„ç›®å½•')bucket.put_object('data/README','æˆ‘æ˜¯å­˜æ”¾æ•°æ®çš„ç›®å½•')bucket.put_object('hive/README','æˆ‘æ˜¯å­˜æ”¾hiveçš„ç›®å½•')bucket.put_object('backup/README','æˆ‘æ˜¯å­˜æ”¾å¤‡ä»½çš„ç›®å½•')bucket.put_object('logs/7days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™7å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/15days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™15å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/30days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™30å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/60days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™60å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/90days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™90å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/180days/README','æˆ‘æ˜¯å­˜æ”¾æ°¸ä¹…ä¿ç•™çš„æ—¥å¿—ç›®å½•')# add lifecyclerule1 = LifecycleRule('rule1', 'logs/7days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=7))rule2 = LifecycleRule('rule2', 'logs/15days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=15))rule3 = LifecycleRule('rule3', 'logs/30days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=30))rule4 = LifecycleRule('rule4', 'logs/60days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=60))rule5 = LifecycleRule('rule5', 'logs/90days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=90))rule6 = LifecycleRule('rule6', 'logs/180days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=180))rule7 = LifecycleRule('rule7', 'logs/longlasting/',                      status=LifecycleRule.ENABLED,                      storage_transitions=[StorageTransition(days=60,storage_class=oss2.BUCKET_STORAGE_CLASS_IA),                          StorageTransition(days=180,storage_class=oss2.BUCKET_STORAGE_CLASS_ARCHIVE)])lifecycle = BucketLifecycle([rule1, rule2, rule3, rule4, rule5, rule6, rule7])bucket.put_bucket_lifecycle(lifecycle)os.system(&quot;sed 's#ossBucketName#&#123;0&#125;#g' local.policy.default &gt; local_&#123;0&#125;.policy&quot;.format(bucketName))os.system(&quot;sed 's#ossBucketName#&#123;0&#125;#g' role.policy.default &gt; role_&#123;0&#125;.policy&quot;.format(bucketName))os.system(&quot;aliyun ram CreatePolicy --PolicyName oss-&#123;0&#125;-local --PolicyDocument \&quot;`cat local_&#123;0&#125;.policy`\&quot;&quot;.format(bucketName))os.system(&quot;aliyun ram CreatePolicy --PolicyName oss-&#123;0&#125;-role --PolicyDocument \&quot;`cat role_&#123;0&#125;.policy`\&quot;&quot;.format(bucketName))</code></pre><ul><li>è¿œç¨‹ç”¨æˆ·ç­–ç•¥ï¼ˆæ‰§è¡Œè„šæœ¬å‰éœ€è¦æ·»åŠ çš„ï¼‰</li></ul><pre><code class="language-json">&#123;  &quot;Version&quot;: &quot;1&quot;,  &quot;Statement&quot;: [    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [                &quot;oss:GetObject&quot;,                &quot;oss:PutObject&quot;,                &quot;oss:DeleteObject&quot;,                &quot;oss:ListObject&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName/logs/7days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/15days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/30days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/60days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/90days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/180days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/longlasting/*&quot;,        &quot;acs:oss:*:*:ossBucketName/conf/*&quot;,        &quot;acs:oss:*:*:ossBucketName/data/*&quot;,        &quot;acs:oss:*:*:ossBucketName/backup/*&quot;,        &quot;acs:oss:*:*:ossBucketName/hive/*&quot;      ],      &quot;Condition&quot;: &#123;        &quot;IpAddress&quot;: &#123;          &quot;acs:SourceIp&quot;: [            &quot;1.1.1.1&quot;,            &quot;2.2.2.2&quot;          ]        &#125;      &#125;    &#125;,    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [        &quot;oss:List*&quot;,        &quot;oss:GetBucketLocation&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName&quot;      ],      &quot;Condition&quot;: &#123;        &quot;IpAddress&quot;: &#123;          &quot;acs:SourceIp&quot;: [            &quot;1.1.1.1&quot;,            &quot;2.2.2.2&quot;          ]        &#125;      &#125;    &#125;  ]&#125;</code></pre><ul><li>è§’è‰²ç”¨æˆ·ç­–ç•¥ï¼ˆæ‰§è¡Œè„šæœ¬å‰éœ€è¦æ·»åŠ çš„ï¼‰</li></ul><pre><code class="language-json">&#123;  &quot;Version&quot;: &quot;1&quot;,  &quot;Statement&quot;: [    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [                &quot;oss:GetObject&quot;,                &quot;oss:PutObject&quot;,                &quot;oss:DeleteObject&quot;,                &quot;oss:ListObject&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName/logs/7days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/15days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/30days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/60days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/90days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/180days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/longlasting/*&quot;,        &quot;acs:oss:*:*:ossBucketName/conf/*&quot;,        &quot;acs:oss:*:*:ossBucketName/data/*&quot;,        &quot;acs:oss:*:*:ossBucketName/backup/*&quot;,        &quot;acs:oss:*:*:ossBucketName/hive/*&quot;      ]    &#125;,    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [        &quot;oss:List*&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName&quot;      ]    &#125;  ]&#125;</code></pre><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><p>ä»¥è§’è‰²æˆæƒæ–¹å¼+aliyun cliå‘½ä»¤æ–¹å¼èµ°èµ·.</p><p>ğŸ˜”ï¼Œaliyun cli çš„æ–‡æ¡£å’Œä½¿ç”¨ä¸€è¨€éš¾å°½=ã€‚=</p><p><strong>ä½¿ç”¨å‰è¯·ç¡®ä¿è§’è‰²å·²ç»å…³è”äº†å¯¹åº”æƒé™ä»¥åŠè§’è‰²å·²ç»ç»‘å®šåˆ°äº†ECSä¸Š</strong></p><pre><code class="language-bash"># /etc/profile.d/ecs_role.shRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`ramRoleName=`curl -sq http://100.100.100.200/latest/meta-data/ram/security-credentials/`aliyun configure set --profile ecsRamRoleProfile  --mode EcsRamRole --ram-role-name $&#123;ramRoleName&#125; --region $&#123;Region&#125;</code></pre><blockquote><p>æœ¬è„šæœ¬ï¼Œä¼šè®©ä»»ä½•ä¸€ä¸ªä¼šè¯ç™»é™†çš„æ—¶å€™å°±æ‹¿åˆ°è§’è‰²æ‹¥æœ‰çš„æƒé™</p></blockquote><pre><code class="language-bash">##å¯¼å…¥è§’è‰²source /etc/profile.d/ecs_role.shRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`Endpoint=&quot;http://oss-$&#123;Region&#125;-internal.aliyuncs.com&quot;BucketName=test#éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¯·æ±‚ç«¯èµ„æºä¸ossä¸åœ¨ä¸€ä¸ªå¤§åŒºï¼Œåˆ™endpointåœ°å€éœ€è¦ç”¨ä¸‹è¿°å¤–ç½‘åœ°å€ï¼š å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼Endpoint=&quot;http://oss-$&#123;Region&#125;.aliyuncs.com&quot;##æŸ¥è¯¢## é»˜è®¤æŸ¥è¯¢æ˜¯é€’å½’æŸ¥è¯¢ï¼Œ-d åªæŸ¥è¯¢ä¸€å±‚aliyun oss ls oss://$&#123;BucketName&#125;/ -d -e $&#123;Endpoint&#125;##åŸºæœ¬çš„ä¸Šä¼ æˆ–ä¸‹è½½##ä¸Šä¼ æ–‡ä»¶ a.file åˆ° oss://test/ aliyun oss cp a.file oss://$&#123;BucketName&#125;/ -e $&#123;Endpoint&#125;##åŸºæœ¬çš„é€’å½’ä¸Šä¼ ##ä¸Šä¼ ç›®å½• abc ä¸‹çš„æ–‡ä»¶åˆ° oss://test/ ä¸‹ï¼Œå¦‚æœæœ‰é‡å¤å†…å®¹ï¼Œåˆ™éœ€è¦åŠ å…¥ --forceï¼šå…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼aliyun oss cp abc oss://$&#123;BucketName&#125;/ --recursive -e $&#123;Endpoint&#125;##å¤æ‚çš„é€’å½’ä¸Šä¼ ##ä¸Šä¼ ç›®å½• abc ä¸‹çš„ .lzo ç»“å°¾çš„æ–‡ä»¶åˆ° oss://test/ ä¸‹.##ä¸¥ç¦åœ¨æºç›®å½•é‡Œæ‰§è¡Œ --recursive å‚æ•°.  å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼##å³ç¦æ­¢æ‰§è¡Œ aliyun oss cp . oss://$&#123;BucketName&#125;/ --recursive aliyun oss cp abc/ oss://$&#123;BucketName&#125;/ --include='*.lzo' --recursive --force -e $&#123;Endpoint&#125;##åŒæ­¥ç›®å½• sync æŒ‡ä»¤å˜æ›´##åŒæ­¥ç›®å½• abc ä¸‹çš„æ–‡ä»¶åˆ° oss://$&#123;BucketName&#125;/ ä¸‹ï¼Œå¦‚æœ‰é‡å¤ï¼Œåˆ™å¿½ç•¥aliyun oss cp abc oss://$&#123;BucketName&#125;/ --recursive -u -e $&#123;Endpoint&#125;</code></pre><h2 id="å¼€å‘å‘-sdk">å¼€å‘å‘ sdk</h2><p>å…³äºphp sdkè®¿é—®å¯¹è±¡å­˜å‚¨çš„æ–‡æ¡£</p><p>php oss å¯¹è±¡ sdk<br><a href="https://packagist.org/packages/aliyuncs/oss-sdk-php?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6">https://packagist.org/packages/aliyuncs/oss-sdk-php?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6</a><br>php ram role sdk<br><a href="https://packagist.org/packages/alibabacloud/credentials?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6">https://packagist.org/packages/alibabacloud/credentials?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6</a></p>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aliyun </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aliyun </tag>
            
            <tag> oss </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go-015åŒ…</title>
      <link href="posts/83a93e23/"/>
      <url>posts/83a93e23/</url>
      
        <content type="html"><![CDATA[<h1>mainåŒ…</h1><p>ä¸»ç¨‹åºéœ€è¦å¼•ç”¨<code>package main</code>ï¼Œåªæœ‰å¼•ç”¨äº†<code>main</code>ï¼Œæ‰å¯ä»¥ç¼–è¯‘ç”ŸæˆäºŒè¿›åˆ¶ç¨‹åºã€‚</p><h1>è‡ªå®šä¹‰åŒ…</h1><h2 id="åŒ…ä»£ç ">åŒ…ä»£ç </h2><blockquote><p>&lt;$GOHOME/src/packageName&gt;/sum.go</p></blockquote><pre><code class="language-go">package calculator // åŒ…åvar logMessage = &quot;[LOG]&quot;// Version of the calculatorvar Version = &quot;1.0&quot;func internalSum(number int) int &#123;    return number - 1&#125;// Sum two integer numbersfunc Sum(number1, number2 int) int &#123;    return number1 + number2&#125;</code></pre><blockquote><p>package å®šä¹‰åŒ…å</p><p>goçº¦å®šï¼šå°å†™å¼€å¤´çš„ä»…ç”¨äºåŒ…å†…éƒ¨ï¼Œå¤§å†™å¼€å¤´çš„åŒ…å†…å¤–å‡å¯ä»¥ç”¨.</p></blockquote><ul><li>åªèƒ½ä»åŒ…å†…è°ƒç”¨ <code>logMessage</code> å˜é‡ã€‚</li><li>å¯ä»¥ä»ä»»ä½•ä½ç½®è®¿é—® <code>Version</code> å˜é‡ã€‚ å»ºè®®ä½ æ·»åŠ æ³¨é‡Šæ¥æè¿°æ­¤å˜é‡çš„ç”¨é€”ã€‚ ï¼ˆæ­¤æè¿°é€‚ç”¨äºåŒ…çš„ä»»ä½•ç”¨æˆ·ã€‚ï¼‰</li><li>åªèƒ½ä»åŒ…å†…è°ƒç”¨ <code>internalSum</code> å‡½æ•°ã€‚</li><li>å¯ä»¥ä»ä»»ä½•ä½ç½®è®¿é—® <code>Sum</code> å‡½æ•°ã€‚ å»ºè®®ä½ æ·»åŠ æ³¨é‡Šæ¥æè¿°æ­¤å‡½æ•°çš„ç”¨é€”ã€‚</li></ul><h2 id="æ¨¡å—">æ¨¡å—</h2><p>Goé€šè¿‡æ¨¡å—å¼•ç”¨åŒ…ã€‚</p><p>æ¨¡å—é€šå¸¸åŒ…å«å¯æä¾›ç›¸å…³åŠŸèƒ½çš„åŒ…ã€‚ åŒ…çš„æ¨¡å—è¿˜æŒ‡å®šäº† Go è¿è¡Œä½ ç»„åˆåœ¨ä¸€èµ·çš„ä»£ç æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€‚ æ­¤ä¸Šä¸‹æ–‡ä¿¡æ¯åŒ…æ‹¬ç¼–å†™ä»£ç æ—¶æ‰€ç”¨çš„ Go ç‰ˆæœ¬ã€‚</p><pre><code class="language-go">cd &lt;$GOHOME/src/packageName&gt;go mod init github.com/myuser/calculator</code></pre><blockquote><p>init åæ˜¯æ¨¡å—åï¼Œä¹Ÿæ˜¯ä¸‹è½½åœ°å€ï¼Œgoé€šè¿‡è¿™ä¸ªåœ°å€å»ä¸‹è½½ã€‚</p></blockquote><h1>åŒ…è°ƒç”¨</h1><p>ä¸»ç¨‹åºï¼š&lt;$GOHOME/src/packageName&gt;/main.go</p><p>é€šè¿‡æ¨¡å—åè°ƒç”¨åŒ…</p><pre><code class="language-go">package mainimport (  &quot;fmt&quot;  &quot;github.com/myuser/calculator&quot;)func main() &#123;    total := calculator.Sum(3, 5) //é€šè¿‡æ¨¡å—åç›´æ¥å¼•ç”¨åŒ…ä¸‹sum.goä¸­çš„Sum()å‡½æ•°    fmt.Println(total)    fmt.Println(&quot;Version: &quot;, calculator.Version)&#125;</code></pre><h2 id="åˆå§‹åŒ–ä¸»ç¨‹åºæ¨¡å—">åˆå§‹åŒ–ä¸»ç¨‹åºæ¨¡å—</h2><p>å‘Šè¯‰goä½ é€šè¿‡æ¨¡å—å¼•ç”¨calculatoråŒ…</p><pre><code class="language-bash">go mod init packageName</code></pre><h2 id="ä¿®æ­£æ¨¡å—æ–‡ä»¶">ä¿®æ­£æ¨¡å—æ–‡ä»¶</h2><p>å‘ŠçŸ¥å¼•ç”¨æœ¬åœ°æ¨¡å—</p><pre><code class="language-go">module helloworldgo 1.14require github.com/myuser/calculator v0.0.0replace github.com/myuser/calculator =&gt; ../calculator</code></pre><p><code>replace</code>å…³é”®è¯æŒ‡å®šæ¨¡å—çš„æœ¬åœ°è·¯å¾„</p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜012å¸¸ç”¨æ¨¡å—çš„è®°å½•</title>
      <link href="posts/d1503f4a/"/>
      <url>posts/d1503f4a/</url>
      
        <content type="html"><![CDATA[<h2 id="os">os</h2><p><a href="https://pkg.go.dev/os#File">os package - os - pkg.go.dev</a></p><h3 id="æ–‡ä»¶">æ–‡ä»¶</h3><p>os.OpenFile</p><pre><code>func OpenFile(name string, flag int, perm FileMode) (*File, error)</code></pre><p><code>os.OpenFile</code>æ ¹æ®<code>flag</code>æ¨¡å¼æ¥åˆ›å»º/æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶</p><p>è¿™é‡Œçš„è¿”å›å€¼<code>*File</code>å…¶å®ä¹Ÿæ˜¯<code>io.Reader</code>ï¼Œéƒ½æ˜¯textual I/Oè¿™ä¸€ç±». å› æ­¤ï¼Œ<code>*File</code>ä¹Ÿå¯ä»¥è¢«ç”¨äº<code>bufio</code>å’Œ<code>io</code>æ¨¡å—</p><p>å¸¸ç”¨çš„flagç»„åˆï¼š</p><p><code>os.O_CREATE|os.O_RDWR</code> åˆ›å»ºå¹¶å¯è¯»å¯å†™</p><p><code>os.O_CREATE|os.O_RDWR|os.O_APPEND</code>åˆ›å»ºå¹¶å¯è¯»å¯å†™å¯è¿½åŠ </p><p>âš ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>os.O_APPEND</code>å°†å§‹ç»ˆå¦‚ä¸€çš„å°†æŒ‡é’ˆå®šä½åˆ°å°¾éƒ¨ï¼Œå› æ­¤<code>*File.Seek</code>æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥ä½ ä¹Ÿæ— æ³•å®ç°è®¡ç®—æ–‡ä»¶è¡Œæ•°ä¹‹ç±»çš„æ–¹æ³•(å› ä¸ºä½ æ— æ³•å®šä½åˆ°é¦–éƒ¨)ã€‚</p><h3 id="å…¨è·¯å¾„">å…¨è·¯å¾„</h3><p>os.Executable()  è¿”å›å¯æ‰§è¡Œç¨‹åºçš„å…¨è·¯å¾„</p><pre><code class="language-go">func Executable() (string, error)</code></pre><p>âš ï¸ ä½†åœ¨ç¬¦å·é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½è¿”å›çš„æ˜¯ç¬¦å·é“¾æ¥çš„è·¯å¾„æˆ–è€…å…¶æŒ‡å‘çš„è·¯å¾„</p><h3 id="å‘½ä»¤è¡Œå‚æ•°">å‘½ä»¤è¡Œå‚æ•°</h3><p>os.Args <code>[]string</code> ï¼Œå…¶<code>os.Args[0]</code>æ˜¯ç¨‹åºå</p><h3 id="é€€å‡ºç¨‹åº">é€€å‡ºç¨‹åº</h3><p>os.Exit(code int) ï¼Œä»¥æŒ‡å®šçš„codeé€€å‡ºç¨‹åºï¼ŒæŒ‰ç…§é€šå¸¸åšæ³•ï¼Œä½ åº”è¯¥ä»¥<code>0</code>è¡¨ç¤ºæ­£å¸¸é€€å‡ºï¼Œ<code>é0</code>è¡¨ç¤ºå¼‚å¸¸</p><p>âš ï¸å®ƒä¼šå¯¼è‡´<code>defer</code>ä¸æ‰§è¡Œ</p><h2 id="os-user">os/user</h2><p>è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</p><pre><code class="language-go">userInfo, err := user.Current()if err != nil &#123;    fmt.Println(&quot;Error: get current user&quot;)&#125; else &#123;    userName := userInfo.Username&#125;</code></pre><h2 id="os-exec">os/exec</h2><p>æ‰§è¡Œå‘½ä»¤</p><pre><code class="language-go">cmd := appPath + &quot; &quot; + appArgsif _, err := exec.LooPath(appPath); err != nil &#123;    fmt.Printf(&quot;Error: %s not found\n&quot;, appPath)&#125; else &#123;    c := exec.Command(&quot;bash&quot;, &quot;-c&quot;, cmd)    output, err := c.CombineOutput()    if err != nil &#123;        fmt.Printf(&quot;Error: %s\n&quot;, output)    &#125; else &#123;        fmt.Printf(&quot;Success: %s\n&quot;, output)    &#125;&#125;</code></pre><h2 id="bytes">bytes</h2><p>å­—èŠ‚å¯¹æ¯”</p><pre><code class="language-go">if bytes.Equal(aByte, bByte) &#123;    fmt.Println(&quot;ä¸¤è€…ç›¸åŒ&quot;)&#125;</code></pre><h2 id="path-filepath">path/filepath</h2><p>è·å–æ–‡ä»¶åå’Œè·¯å¾„</p><pre><code class="language-go">if fullPath, err := os.Executable(); err != nil &#123;fmt.Printf(&quot;Error executing&quot;)&#125; else &#123;basePath, baseName := filepath.Split(fullPath)    &#125;</code></pre><h2 id="bufio">bufio</h2><p>å®ç°å¸¦ç¼“å­˜çš„I/O</p><h2 id="io-å’Œ-os">io å’Œ os</h2><p>è¯»å†™æ–‡ä»¶æˆ–è€…æ–‡ä»¶æè¿°ç¬¦çš„å†…å®¹</p><p>ğŸ’å¦å¤–ï¼Œio/ioutil ä¹Ÿå¯ä»¥å®ç°ioå’Œosé‡Œçš„ä¸€äº›æ–‡ä»¶ç›¸å…³çš„æ–¹æ³•ï¼Œä½†æ˜¯ä»–ä»¬å·²ç»è¿ç§»åˆ°äº†ioå’Œos</p><pre><code class="language-go">fd, err := os.OpenFile(filePath, os.O_RDWR|os.O_CREATE, 0755)defer fd.Close()if err != nil &#123;    fmt.Printf(&quot;Error(open): %s\n&quot;, filePath)&#125; else &#123;    fByte, err := io.ReadAll(fd)    if err != nil &#123;        fmt.Printf(&quot;Error(read): %s\n&quot;, err)    &#125; else &#123;        fmt.Printf(&quot;file content:\n %s\n&quot;, fByte)    &#125;&#125;</code></pre><h2 id="mysql">mysql</h2><p><a href="https://pkg.go.dev/database/sql#Rows.Next">sql package - database/sql - pkg.go.dev</a></p><pre><code class="language-go">import (    &quot;database/sql&quot;_ &quot;github.com/go-sql-driver/mysql&quot;)func main()&#123;mysqlConnect := fmt.Sprintf(&quot;%s:%s@tcp(%s)/mysql&quot;, conf.Database.Username, conf.Database.Password, conf.Database.Host)    if err != nil &#123;        errors.New(&quot;Error mysql connect&quot;)        return    &#125;    db.SetConnMaxLifetime(100*time.Second)  //æœ€å¤§è¿æ¥å‘¨æœŸï¼Œè¶…è¿‡æ—¶é—´çš„è¿æ¥å°±close    db.SetMaxOpenConns(10) //è®¾ç½®æœ€å¤§è¿æ¥æ•°    db.SetMaxIdleConns(5) //è®¾ç½®é—²ç½®è¿æ¥    rows, err := db.Query(&quot;show full processlist&quot;)    if err != nil &#123;        errors.New(&quot;Error db Query&quot;)        return    &#125;      var Id,Time int64    var User, Host, Command, State string    var Db, Info sql.NullString    for rows.Next() &#123;        rows.Scan(&amp;Id, &amp;User, &amp;Host, &amp;Db, &amp;Command, &amp;Time, &amp;State, &amp;Info)    fmt.Printf(&quot;%d,%s,%s,%s,%s,%d,%s,\&quot;%s\&quot;\n&quot;, Id, User, Host, Db.String, Command, Time, State, Info.String&#125;</code></pre><p><code>rows.Next()</code>è¯»å–ä¸€è¡Œï¼Œå¹¶æŒ‡å‘è¡Œå°¾</p><p><code>rows.Scan(dest ...interface&#123;&#125;)</code>å°†å½“å‰è¡Œçš„å€¼é€ä¸ªå­—æ®µçš„å¤åˆ¶ç»™destï¼Œdestæ˜¯æŒ‡é’ˆç±»å‹ã€‚desté¡ºåºå’Œå½“å‰è¡Œçš„å­—æ®µé¡ºåºéœ€è¦ä¸€ä¸€å¯¹åº”ã€‚</p><h2 id="gopkg-in-gomail-v2"><a href="http://gopkg.in/gomail.v2">gopkg.in/gomail.v2</a></h2><p><a href="https://pkg.go.dev/gopkg.in/gomail.v2">gomail package - gopkg.in/gomail.v2 - pkg.go.dev</a></p><pre><code class="language-go">func sendEmail(smtpServer string, smtpPort int, smtpUser string, smtpPassword string, receiveUser []string, subject string, content string, attach string) error &#123;    m := gomail.NewMessage()    m.SetHeader(&quot;From&quot;, smtpUser)    m.SetHeader(&quot;To&quot;, receiveUser...)    m.SetHeader(&quot;Subject&quot;, subject)    m.SetBody(&quot;text/html&quot;, content)    m.Attach(attach)    d := gomail.NewDialer(smtpServer, smtpPort, smtpUser, smtpPassword)    err := d.DialAndSend(m)    return err&#125;</code></pre><h2 id="gopkg-in-yaml-v3"><a href="http://gopkg.in/yaml.v3">gopkg.in/yaml.v3</a></h2><p><a href="https://pkg.go.dev/gopkg.in/yaml.v3">yaml package - gopkg.in/yaml.v3 - pkg.go.dev</a></p><p>é…ç½®æ–‡ä»¶ç¤ºä¾‹</p><pre><code class="language-yaml">email:  smtpserver: smtp.feishu.cn  smtpport: 465  smtpuser:   smtppassword:   receiveuser:     - zhangsan@abc.com  subject:   content: database:  host:   username:   password:   timeout: </code></pre><pre><code class="language-go">//æ˜ å°„é…ç½®æ–‡ä»¶çš„ç»“æ„ä½“type Config struct &#123;    Email struct &#123;        Smtpserver string `json:&quot;smtpserver&quot;`        Smtpport int `yaml:&quot;smtpport&quot;`        Smtpuser string `json:&quot;smtpuser&quot;`        Smtppassword string `yaml:&quot;smtppassword&quot;`        Receiveuser []string `yaml:&quot;receiveuser&quot;`        Subject string `yaml:&quot;subject&quot;`        Content string `yaml:&quot;content&quot;`    &#125;    Database struct &#123;        Host string `yaml:&quot;host&quot;`        Username string `yaml:&quot;username&quot;`        Password string `yaml:&quot;password&quot;`        Timeout int64 `yaml:&quot;timeout&quot;`    &#125;&#125;//å®ç°ç»“æ„ä½“æ–¹æ³• getConffunc (config *Config) getConf(confPath string) (*Config) &#123;    yamlFile, err := ioutil.ReadFile(confPath)    if err != nil &#123;        fmt.Println(&quot;Error reading config&quot;)    &#125;    err = yaml.Unmarshal(yamlFile, config)    if err != nil &#123;        fmt.Println(&quot;Error unmarshaling config&quot;)    &#125;    return config&#125;func main()&#123;    var config Config    conf := config.getConf(&quot;/to_path/config.yaml&quot;)    fmt.Println(conf.Email.Smtpserver)&#125;</code></pre><p>âš ï¸å®šä¹‰é…ç½®æ–‡ä»¶æ˜ å°„çš„ç»“æ„ä½“çš„æ—¶å€™ï¼Œå±æ€§é¦–å­—æ¯è¦å¤§å†™</p><h2 id="encoding-json">encoding/json</h2><p><a href="https://pkg.go.dev/encoding/json">https://pkg.go.dev/encoding/json</a></p><p><a href="https://json2struct.mervine.net/">https://json2struct.mervine.net/</a>    jsonè½¬struct</p><h3 id="æ„é€ jsonå¯¹è±¡ï¼Œç”¨æ¥ä¼ é€’å‚æ•°">æ„é€ jsonå¯¹è±¡ï¼Œç”¨æ¥ä¼ é€’å‚æ•°</h3><pre><code class="language-go">import &quot;encoding/json&quot;postMap := map[string]string&#123;&quot;username&quot;: username, &quot;password&quot;: password&#125;postJson, err := json.Marshal(postMap) // postJson å·²ç»æ˜¯[]byteif err != nil &#123;    fmt.Println(&quot;Error:json.Marshal&quot;)&#125;</code></pre><h3 id="è§£æjsonå¯¹è±¡ï¼Œè·å–å¯¹è±¡å€¼">è§£æjsonå¯¹è±¡ï¼Œè·å–å¯¹è±¡å€¼</h3><pre><code class="language-go">import (    &quot;encoding/json&quot;    &quot;fmt&quot;)func main()&#123;    var bodyByte = []byte(`[        &#123;&quot;Name&quot;: &quot;Platypus&quot;, &quot;Order&quot;: &quot;Monotremata&quot;&#125;,        &#123;&quot;Name&quot;: &quot;Quoll&quot;,    &quot;Order&quot;: &quot;Dasyuromorphia&quot;&#125;    ]`)    type Animal struct &#123;        Name  string        Order string    &#125;    var animals []Animal    if err := json.Unmarshal(bodyByte, &amp;animals); err != nil &#123;        fmt.Println(err)    &#125; else &#123;        for _, val := range animals &#123;            fmt.Printf(&quot;Name:%s, Order:%s\n&quot;, val.Name, val.Order)        &#125;    &#125;&#125;</code></pre><p>è¾“å‡ºï¼š</p><pre><code class="language-bash">Name:Platypus, Order:MonotremataName:Quoll, Order:Dasyuromorphia</code></pre><h3 id="æ³¨æ„ç‚¹">æ³¨æ„ç‚¹</h3><p>ä»¥å°å†™å­—æ¯å¼€å¤´çš„ç»“æ„ä½“å­—æ®µä¸ä¼šè¢«ç¼–ç è¿›å»</p><pre><code class="language-yaml">package mainimport (      &quot;fmt&quot;    &quot;encoding/json&quot;)type MyData struct &#123;      One int    two string&#125;func main() &#123;      in := MyData&#123;1,&quot;two&quot;&#125;    fmt.Printf(&quot;%#v\n&quot;,in) //prints main.MyData&#123;One:1, two:&quot;two&quot;&#125;    encoded,_ := json.Marshal(in)    fmt.Println(string(encoded)) //prints &#123;&quot;One&quot;:1&#125;  è¿™é‡Œå¯ä»¥çœ‹å‡ºtwo:&quot;two&quot;æ²¡æœ‰è¢«ç¼–ç è¿›å»    var out MyData    json.Unmarshal(encoded,&amp;out)    fmt.Printf(&quot;%#v\n&quot;,out) //prints main.MyData&#123;One:1, two:&quot;&quot;&#125;&#125;</code></pre><h2 id="time">time</h2><p><a href="https://pkg.go.dev/time#Now">time package - time - pkg.go.dev</a></p><p>goé‡‡ç”¨ä¸€ç§å¾ˆç‹¬ç‰¹çš„æ–¹å¼æ¥æ ¼å¼åŒ–æ—¶é—´ï¼Œå³ï¼š</p><p>2006æ•°å­—ä»£è¡¨å¹´ï¼Œå¦‚åŒå¸¸è§çš„<code>%Y</code></p><p>01æ•°å­—ä»£è¡¨æœˆï¼Œå¦‚åŒå¸¸è§çš„<code>%m</code></p><p>02æ•°å­—ä»£è¡¨æ—¥</p><p>15æ•°å­—ä»£è¡¨æ—¶ï¼ˆ24å°æ—¶çš„ä¸‹åˆä¸‰ç‚¹ï¼‰</p><p>04æ•°å­—ä»£è¡¨åˆ†</p><p>05æ•°å­—ä»£è¡¨ç§’</p><p>Z07æ•°å­—ä»£è¡¨æ—¶åŒº(-07ä¹Ÿå¯ä»¥)</p><p>æ•´ä½“è®°å¿†æ–¹æ³•å°±æ˜¯ï¼š01ã€02ã€15(03)ã€04ã€05ã€2006(06)ã€Z07(07)</p><pre><code class="language-go">time.Now().Format(&quot;2006.01.02 15:04:05 Z07&quot;)</code></pre><h2 id="net-http">net/http</h2><p><a href="https://pkg.go.dev/net/http">https://pkg.go.dev/net/http</a></p><pre><code class="language-go">import &quot;net/http&quot;func GetUser(url, path, username string, password string) (UserJson, error) &#123;client := &amp;http.Client&#123;&#125; // åˆ›å»ºå®¢æˆ·ç«¯postMap := map[string]string&#123;&quot;username&quot;: username, &quot;password&quot;: password&#125;postJson, err := json.Marshal(postMap)if err != nil &#123;fmt.Println(&quot;Error json.Marshal&quot;)&#125;request, err := http.NewRequest(http.MethodPost, url+path, bytes.NewBuffer(postJson)) // åˆ›å»ºè¯·æ±‚ä½“if err != nil &#123;fmt.Println(&quot;Error http.NewRequest&quot;)&#125;request.Header.Set(&quot;Content-Type&quot;, &quot;application/json&quot;) // æ·»åŠ ç±»å‹response, err := client.Do(request)if err != nil &#123;fmt.Println(&quot;Error client do request&quot;)&#125;bodyByte, err := io.ReadAll(response.Body)defer response.Body.Close()var user UserJsonif err := json.Unmarshal(bodyByte, &amp;user); err != nil &#123;fmt.Println(&quot;Error json unmarshal response userjson&quot;)&#125;return user, err&#125;func main() &#123;    myuser, err := GetUser(acmeServer, &quot;/api/user/&quot;, authuser, authpasswd)&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œâ˜S5700é…ç½®æ”»å‡»æœ”æº</title>
      <link href="posts/5290b79d/"/>
      <url>posts/5290b79d/</url>
      
        <content type="html"><![CDATA[<h2 id="ç›®çš„">ç›®çš„</h2><p>åˆ¤æ–­ç½‘ç»œæ”»å‡»æ¥æº</p><h2 id="è®¾ç½®ç®¡ç†å‘˜ipä¸ºç™½åå•">è®¾ç½®ç®¡ç†å‘˜ipä¸ºç™½åå•</h2><pre><code class="language-bash">acl 3666rule 1 permit ip source 10.200.15.1 0.0.0.0</code></pre><h2 id="æ ¹æ®IPåˆ¤æ–­">æ ¹æ®IPåˆ¤æ–­</h2><pre><code class="language-bash">cpu-defend policy 1auto-defend enableauto-defend attack-packet sample 5auto-defend trace-type source-mac source-ip source-portvlanauto-defend protocol arp icmp dhcp telnetauto-defend threshold 60auto-defend alarm enableauto-defend alarm threshold 60auto-defend whitelist 1 acl 3666</code></pre><h2 id="æ ¹æ®ç«¯å£åˆ¤æ–­">æ ¹æ®ç«¯å£åˆ¤æ–­</h2><pre><code class="language-bash">cpu-defend policy 1auto-port-defend enableauto-port-defend attack-packet sample 5auto-port-defend protocol arp-request arp-reply dhcp icmpauto-port-defend protocol arp-request threshold 30auto-port-defend protocol arp-reply threshold 30auto-port-defend protocol dhcp threshold 30auto-port-defend protocol icmp threshold 30auto-port-defend alarm enableauto-port-defend whitelist 1 acl 3666</code></pre><h2 id="åº”ç”¨ç­–ç•¥">åº”ç”¨ç­–ç•¥</h2><pre><code class="language-bash">cpu-defend-policy 1 global</code></pre><h2 id="æŸ¥çœ‹æ”»å‡»æ¥æºip">æŸ¥çœ‹æ”»å‡»æ¥æºip</h2><pre><code class="language-bash">display auto-defend attack-source</code></pre><h2 id="æŸ¥çœ‹æ”»å‡»æ¥æºç«¯å£">æŸ¥çœ‹æ”»å‡»æ¥æºç«¯å£</h2><pre><code class="language-bash">display auto-port-defend attack-source</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äº¤æ¢æœº </tag>
            
            <tag> S5700 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜ubuntu20.04çº¯å‘½ä»¤è¡Œç½‘å¡é…ç½®</title>
      <link href="posts/e4f7ce4c/"/>
      <url>posts/e4f7ce4c/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>netplan ç”¨äºå±è”½å„ç§ç½‘ç»œç®¡ç†å™¨ï¼Œå®ƒå¯ä»¥è®©ä½ ç”¨ä¸€ä»½é…ç½®ï¼Œå°±å¸®ä½ æŠŠç½‘ç»œç»™é…ç½®å¥½ï¼Œè€Œæ— éœ€ä½ è€ƒè™‘ç½‘ç»œæ§åˆ¶å™¨å¦‚ä½•ä½¿ç”¨ã€‚</p><p>20.04 å·²ç»é»˜è®¤å®‰è£…äº† netplan.</p><h2 id="è®°å½•å½“å‰ç½‘å¡æ ‡è¯†å">è®°å½•å½“å‰ç½‘å¡æ ‡è¯†å</h2><pre><code class="language-bash">ip addr show # ===1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever    inet6 ::1/128 scope host       valid_lft forever preferred_lft forever2: enp0s31f6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000    link/ether d8:9e:f3:31:83:c8 brd ff:ff:ff:ff:ff:ff</code></pre><p>ä¾‹å¦‚ä¸Šè¿°ä¸­çš„ <code>enp0s31f6</code></p><h2 id="ç¼–è¾‘é…ç½®æ–‡ä»¶">ç¼–è¾‘é…ç½®æ–‡ä»¶</h2><pre><code class="language-bash">cat /etc/netplan/00-installer-config.yaml# ===# This is the network config written by 'subiquity'network:  ethernets:    enp0s31f6:      addresses: [10.200.10.2/24]      dhcp4: no      optional: true      gateway4: 10.200.10.1      nameservers:        addresses: [10.200.10.1]  version: 2  renderer: networkd</code></pre><h2 id="åŠ è½½é…ç½®">åŠ è½½é…ç½®</h2><pre><code class="language-bash">netplan applysystemctl restart networkd-dispatcher.service</code></pre><blockquote><p>ä¹‹åå¦‚æœå†ä¿®æ”¹ ipï¼Œ å†æ¬¡æ‰§è¡Œ <code>netplay apply</code> å³å¯</p></blockquote><h2 id="å‚è€ƒ">å‚è€ƒ</h2><p><a href="https://netplan.io/examples/#configuration">https://netplan.io/examples/#configuration</a></p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> ubuntu </tag>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§â˜mysqlæ…¢sqlé¢„è­¦</title>
      <link href="posts/ab1247fb/"/>
      <url>posts/ab1247fb/</url>
      
        <content type="html"><![CDATA[<h2 id="ç”¨é€”">ç”¨é€”</h2><p>æ£€æµ‹æ•°æ®åº“ä¸­æ‰§è¡Œç¼“æ…¢çš„sqlï¼Œå¹¶è®°å½•é¢„è­¦</p><h2 id="è„šæœ¬">è„šæœ¬</h2><pre><code class="language-bash">#!/bin/bash# by zyh# æ£€æŸ¥æ•°æ®åº“è€—æ—¶è¿‡é•¿çš„è¯­å¥# æ‰€éœ€é…ç½®æ–‡ä»¶:# 1. userfile.txt ç”¨äºåˆ¤æ–­ç¨‹åºç”¨æˆ·çš„sqlæ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶äº†æ€æ­»  ##ç”¨æˆ·å      å¯†ç     è¶…æ—¶æ—¶é—´# 2. database.conf éœ€è¦show full processlistæƒé™  ##Username=  ##Password=  ##Mysqlhostname=  ##Database=  ##Port=# bash start.sh database.conf æ”¾åˆ°è®¡åˆ’ä»»åŠ¡é‡Œ# -------------------------------------------------------------------------------#--å˜é‡--basedir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`currtime=`date &quot;+%Y%m%d_%H%M%S&quot;`#Username=#Password=#Mysqlhostname=#Database=#Port=source $basedir/$1datadir=$basedir/data/$Database-$1/$currtime[[ -d $datadir ]] || mkdir -p $datadir#--main--mysql -s -r -u$Username -p$Password -h$Mysqlhostname -P$Port -e 'show full processlist' | grep -v 'Sleep' |grep -v 'system' | egrep '(Query|Execute)' | grep -i $'\tselect' &gt; $datadir/$Database.allawk -F'\t' 'BEGIN&#123;OFS=&quot;\t&quot;&#125;ARGIND==1&#123;warntime[$1]=$3;warnpwd[$1]=$2&#125; \                ARGIND==2&#123; \                        for( nametime in warntime ) &#123; \                                if( $2 == nametime &amp;&amp; $6 &gt; warntime[$2] ) &#123; \                                        print warnpwd[$2],$0;break \                                &#125; \                        &#125; \                &#125;' $basedir/userfile.txt $datadir/$Database.all &gt; $datadir/$Database.warncat $datadir/$Database.warn | while read warningpwd id warningname other;do        echo &quot;# $&#123;warningname&#125;: $id $other&quot;        echo &quot;mysql -s -r -u$warningname -p$warningpwd -h$Mysqlhostname -P$Port -e 'kill '&quot;$id&quot;'&quot;done &gt; $datadir/kill.sql[[ -s $datadir/kill.sql ]] &amp;&amp; python $&#123;basedir&#125;/sendmail.py 'æ”¶ä»¶äººé‚®ç®±åœ°å€' &quot;[SQL-TimeOut]-$Database&quot; &quot;($Mysqlhostname)The attachment content is timeout SQL information&quot; 'æŠ„é€é‚®ç®±åœ°å€'  &quot;$datadir/kill.sql&quot; || rm -rf $datadir</code></pre><pre><code class="language-python">#!/usr/bin/python#coding:utf-8# by zyh# python sendmail.py 'æ”¶ä»¶äººé‚®ç®±åœ°å€'  'ä¸»é¢˜' 'é‚®ä»¶å†…å®¹' 'æŠ„é€é‚®ç®±åœ°å€' 'é™„ä»¶ç»å¯¹è·¯å¾„'import smtplibfrom email.header import Headerfrom email.mime.text import MIMETextfrom email.mime.multipart import MIMEMultipartimport sysreload(sys)sys.setdefaultencoding('utf8')mail_host = 'smtpæœåŠ¡å™¨åœ°å€'  # ä¾‹å¦‚ smtp.gmail.com:587mail_user = 'å‘ä»¶äººé‚®ç®±'      # ä¾‹å¦‚ it@gmail.commail_pass = 'å‘ä»¶äººå¯†ç 'def send_mail(*args):    argsNum=len(args[0])    if argsNum == 4:        filename,to_list, subject, content=args[0]    elif argsNum == 5:        filename,to_list, subject, content, cc_list=args[0]    elif argsNum == 6:        filename,to_list, subject, content, cc_list, subfile=args[0]    me = mail_user+&quot;&lt;&quot;+mail_user+&quot;&gt;&quot;    #åˆå§‹åŒ–é‚®ä»¶å¯¹è±¡ msg    msg = MIMEMultipart()    msg['From'] = me    msg['to'] = to_list    emailList=to_list    # ä¸»é¢˜    msg['Subject'] = Header(subject, 'utf-8').encode()    # å†…å®¹    msg.attach(MIMEText(content, 'plain', 'utf-8'))    # æŠ„é€    if 'cc_list' in vars():        msg['Cc'] = cc_list        emailstring = to_list+','+cc_list        emailList=emailstring.split(&quot;,&quot;)    # é™„ä»¶    if 'subfile' in vars():        att1 = MIMEText(open((&quot;%s&quot;%subfile),'rb').read(), 'base64', 'utf8')        att1[&quot;Content-Type&quot;] = 'text/plain'        att1[&quot;Content-Disposition&quot;] = 'attachment; filename='+subfile.split('/')[-1] # è¿™é‡Œçš„filenameå¯ä»¥ä»»æ„å†™ï¼Œå†™ä»€ä¹ˆåå­—ï¼Œé‚®ä»¶ä¸­æ˜¾ç¤ºä»€ä¹ˆåå­—        msg.attach(att1)    # å‘é€    try:        print &quot;start sendmail&quot;        s = smtplib.SMTP(mail_host)        print &quot;connect mail server suesscc&quot;        s.starttls()        s.login(mail_user,mail_pass)        print &quot;login mail server suesscc&quot;        s.sendmail(me,emailList,msg.as_string())        s.close()        return True    except Exception,e:        print &quot;%s\t%s&quot;%(to_list,str(e))        return Falseif __name__ == &quot;__main__&quot;:    if len(sys.argv) &lt; 4:        exit()    send_mail(sys.argv)</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webâ˜æœåŠ¡å™¨æ‰¿è½½èƒ½åŠ›è®¡ç®—</title>
      <link href="posts/7c44c2e8/"/>
      <url>posts/7c44c2e8/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>æˆ‘ä»¬åœ¨è¯„ä¼°ä¸€ä¸ªç³»ç»Ÿéœ€è¦å¤šå°‘ä¸ªæœåŠ¡å™¨æ¥æ”¯æ’‘çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæ¶‰åŠåˆ°å¤šä¸ªç‚¹ã€‚</p><ul><li>pv</li><li>qps</li><li>å¹¶å‘</li><li>å¹³å‡å“åº”æ—¶é—´</li></ul><p>å¦‚æœä½ å·²ç»æœç´¢è¿‡ç›¸å…³ç«™ç‚¹ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªå…¬å¼ï¼šå¹¶å‘=qps*å¹³å‡å“åº”æ—¶é—´</p><p>è¯´å®è¯ï¼Œè¿™ä¸ªå…¬å¼å¾ˆè›‹ç–¼ï¼ŒçŒ›åœ°ä¸€çœ‹è®©äººä¸€è„¸æ‡µé€¼ã€‚è¿™é‡Œæˆ‘æŒ‰ç…§æˆ‘çš„æ–¹å¼æ¥è¯´ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆå°†å…¬å¼å˜å½¢ï¼Œ QPS = å·¥ä½œè¿›ç¨‹æ•° / å¹³å‡å“åº”æ—¶é—´</p><p>å…¶æ¬¡ï¼Œæ¢ç®—ä¸¤è¾¹æ—¶é—´å•ä½éƒ½ä¸ºç§’çº§ï¼Œ QPS = ï¼ˆ1ç§’ / ç§’çº§å¹³å‡å“åº”æ—¶é—´ï¼‰* å·¥ä½œè¿›ç¨‹æ•°</p><p>å†æ¬¡ï¼Œå°†<code>å¹¶å‘</code>ç†è§£ä¸ºç³»ç»Ÿçš„<code>å·¥ä½œè¿›ç¨‹</code>ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå¹¶å‘æ˜¯100ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç®€å•çš„ç†è§£ä¸ºç†æƒ³æƒ…å†µä¸‹100ä¸ªå·¥ä½œè¿›ç¨‹åŒä¸€æ—¶é—´åªèƒ½å¤„ç†100ä¸ªè¯·æ±‚ã€‚</p><p>é‚£ä¹ˆï¼Œ<code>1ç§’ / ç§’çº§å¹³å‡å“åº”æ—¶é—´</code>å°±æ˜¯æŒ‡æ¯ä¸ªå·¥ä½œè¿›ç¨‹1ç§’èƒ½å¤„ç†å¤šå°‘ä¸ªè¯·æ±‚ã€‚</p><p>æ‰€ä»¥ï¼Œæœ€ç»ˆå¾—åˆ° <code>QPS</code>å°±æ˜¯ç³»ç»Ÿæ¯ç§’å¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°ã€‚</p><p>å¦‚æœä½ æ—¥PVæ˜¯ 300Wï¼Œé‚£ä¹ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯å¤©80%çš„è¯·æ±‚é‡éƒ½é›†ä¸­åœ¨æ¯å¤©20%çš„æ—¶é—´é‡Œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºé«˜å³°æ—¶é—´çš„ç§’çº§è¯·æ±‚é‡æ˜¯ 3000000 * 0.8  / ï¼ˆ3600 * 24 * 0.2ï¼‰ = 139</p><p>å› æ­¤ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿæ ¹æ® <code>QPS = å·¥ä½œè¿›ç¨‹æ•° / å¹³å‡å“åº”æ—¶é—´</code> å¾—åˆ°çš„ QPS å¤§äº 139ï¼Œé‚£ä¹ˆä½ çš„ç³»ç»Ÿå°±å¯ä»¥é¡¶ä½ã€‚</p><p>å¦‚æœå°äºï¼Œé‚£ä¹ˆä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p><ol><li>éœ€è¦å¢åŠ å·¥ä½œè¿›ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯å¢åŠ æœåŠ¡å™¨æ•°é‡æˆ–è€…æœåŠ¡å™¨é‡Œçš„å·¥ä½œè¿›ç¨‹</li><li>ä¼˜åŒ–ç³»ç»Ÿï¼Œé™ä½å¹³å‡å“åº”æ—¶é—´</li></ol><blockquote><p>âš ï¸å¢åŠ æœåŠ¡å™¨çš„å·¥ä½œè¿›ç¨‹ï¼Œå¹¶ä¸ä¸€å®šä¼šäº§ç”Ÿæ­£å‘æ•ˆåº”ï¼Œå› ä¸ºå·¥ä½œè¿›ç¨‹è¶Šå¤šï¼Œé‚£ä¹ˆè¿›ç¨‹å°±å¯èƒ½é¢‘ç¹åˆ‡æ¢ï¼Œåè€Œå¯¼è‡´å·¥ä½œè¿›ç¨‹ä¸å¹²æ´»ã€‚</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> æ‰¿è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜16kubeadmé›†ç¾¤å‡çº§</title>
      <link href="posts/7538d100/"/>
      <url>posts/7538d100/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</a></p><p>âš ï¸ åŠ¡å¿…å…ˆçœ‹æ­¤é¡µé¢ï¼Œå› ä¸ºä¸èƒ½è·¨å¤šä¸ªç‰ˆæœ¬å‡çº§ã€‚éœ€è¦æ ¹æ®å½“å‰ç‰ˆæœ¬ä¸€æ­¥ä¸€æ­¥å‡çº§ã€‚</p><p>åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå‡çº§æ ¸å¿ƒèŠ‚ç‚¹å’Œå‡çº§å·¥ä½œèŠ‚ç‚¹.</p><h1>å‡çº§æ§åˆ¶å¹³é¢èŠ‚ç‚¹ Control Plane</h1><p>æ§åˆ¶å¹³é¢æ ¸å¿ƒç»„ä»¶åŒ…å«ï¼š</p><ul><li>kube-apiserver</li><li>etcd</li><li>kube-scheduler</li><li>kube-controller-manager</li><li>cloud-controller-manager</li></ul><h2 id="åˆ—å‡ºæƒ³å‡çº§çš„kubeç‰ˆæœ¬">åˆ—å‡ºæƒ³å‡çº§çš„kubeç‰ˆæœ¬</h2><p>è¿™é‡Œä»¥1.20-1.21ç‰ˆæœ¬ä¸ºä¾‹</p><blockquote><p>æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p></blockquote><pre><code class="language-bash"># é€‰æ‹©ä¸»ç‰ˆæœ¬å·master_verions=1.21yum list --showduplicates kubeadm --disableexcludes=kubernetes | grep $&#123;master_verions&#125;===kubeadm.x86_64                       1.20.8-0                        @kuberneteskubeadm.x86_64                       1.20.0-0                        kuberneteskubeadm.x86_64                       1.20.1-0                        kuberneteskubeadm.x86_64                       1.20.2-0                        kuberneteskubeadm.x86_64                       1.20.4-0                        kuberneteskubeadm.x86_64                       1.20.5-0                        kuberneteskubeadm.x86_64                       1.20.6-0                        kuberneteskubeadm.x86_64                       1.20.7-0                        kuberneteskubeadm.x86_64                       1.20.8-0                        kubernetes</code></pre><p>â€“disableexcludes=kubernetes åªå…è®¸kubernetesåº“</p><h2 id="æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šæå‰ä¸‹è½½å¥½å‡çº§æ‰€éœ€çš„é•œåƒ">æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šæå‰ä¸‹è½½å¥½å‡çº§æ‰€éœ€çš„é•œåƒ</h2><blockquote><p>æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹æ‰§è¡Œ</p></blockquote><pre><code class="language-bash"># é€‰æ‹©ä¸»ç‰ˆæœ¬å·å¯¹åº”çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬full_version=1.21.7</code></pre><h3 id="åˆ—å‡ºç‰ˆæœ¬æ‰€éœ€çš„åŒ…">åˆ—å‡ºç‰ˆæœ¬æ‰€éœ€çš„åŒ…</h3><pre><code class="language-bash">kubeadm config images list --kubernetes-version=$&#123;full_version&#125;===k8s.gcr.io/kube-apiserver:v1.21.7k8s.gcr.io/kube-controller-manager:v1.21.7k8s.gcr.io/kube-scheduler:v1.21.7k8s.gcr.io/kube-proxy:v1.21.7k8s.gcr.io/pause:3.5k8s.gcr.io/etcd:3.4.13-0k8s.gcr.io/coredns/coredns:v1.8.4</code></pre><p>âš ï¸æœ¬æ–‡æ¡£æ’°å†™çš„æ—¶å€™ï¼Œä¸Šè¿°å‘½ä»¤æ— æ³•åˆ—å‡ºæ­£ç¡®çš„åŒ…ï¼Œä¾‹å¦‚v1.22.4ç‰ˆæœ¬ï¼Œç‰ˆæœ¬å‘å¸ƒä¸­æåˆ°etcdå·²æ›´æ–°è‡³3.5.0ï¼Œä½†å´æ— æ³•æ‰¾åˆ°ï¼Œæ­¤æ—¶ä¼šè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼Œå³åˆ—å‡ºä¸Šä¸€ä¸ªæœ€æ–°ç‰ˆæœ¬.</p><pre><code class="language-bash">could not find officially supported version of etcd for Kubernetes v1.22.4, falling back to the nearest etcd version (3.4.13-0)</code></pre><p>æ­¤æ—¶ï¼Œä½ åº”è¯¥å·²ç‰ˆæœ¬å‘å¸ƒä¿¡æ¯é‡Œçš„ç‰ˆæœ¬ä¸ºå‡†.</p><p>â„¹ï¸ å¯ä»¥é€šè¿‡æå‰å‡çº§ä¸€ä¸ªkubeadmï¼Œå¹¶æ‰§è¡Œ<code>kubeadm upgrade plan</code>å¾—åˆ°æ­£ç¡®çš„åŒ…ç‰ˆæœ¬.</p><h3 id="æ„å»ºåŒ…æ‹‰å–è„šæœ¬">æ„å»ºåŒ…æ‹‰å–è„šæœ¬</h3><blockquote><p>æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹æ‰§è¡Œ</p></blockquote><p>æ ¹æ®ä¸Šé¢çš„è¾“å‡ºç‰ˆæœ¬ï¼Œä¿®æ”¹ä¸‹é¢è„šæœ¬ä¸­ <code>pause</code> <code>etcd</code> <code>coredns</code> çš„ç‰ˆæœ¬å·</p><pre><code class="language-bash">cat&gt;images-pull.sh&lt;&lt;EOF#!/bin/bash# kubeadm config images listimages=(kube-apiserver:v$&#123;full_version&#125;kube-controller-manager:v$&#123;full_version&#125;kube-scheduler:v$&#123;full_version&#125;kube-proxy:v$&#123;full_version&#125;pause:3.5etcd:3.4.13-0coredns:1.8.4)for imageName in \$&#123;images[@]&#125;;do    docker pull registry.aliyuncs.com/google_containers/\$&#123;imageName&#125;    docker tag registry.aliyuncs.com/google_containers/\$&#123;imageName&#125; k8s.gcr.io/\$&#123;imageName&#125;    docker rmi registry.aliyuncs.com/google_containers/\$&#123;imageName&#125;doneEOF</code></pre><pre><code class="language-bash">bash images-pull.sh</code></pre><blockquote><p>å¦‚æœæŸäº›åŒ…æ— æ³•ä¸‹è½½ï¼Œåˆ™éœ€è‡ªè¡Œå» dockerhub ä¸Šæ‰¾ï¼Œå¹¶åœ¨ä¸‹è½½å®Œæ¯•åï¼Œæ·»åŠ  k8s è‡ªå·±çš„ tagsï¼Œä¾‹å¦‚ coredns<br>docker pull coredns/coredns:1.6.7<br>docker tag coredns/coredns:1.6.7 <a href="http://k8s.gcr.io/coredns:1.6.7">k8s.gcr.io/coredns:1.6.7</a><br>docker rmi coredns/coredns:1.6.7</p></blockquote><h2 id="ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šå®‰è£…ç›®æ ‡ç‰ˆæœ¬çš„kubeadm">ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šå®‰è£…ç›®æ ‡ç‰ˆæœ¬çš„kubeadm</h2><blockquote><p>åœ¨ç¬¬ä¸€ä¸ªè¦å‡çº§çš„æ ¸å¿ƒèŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p></blockquote><p>å‡çº§è®¡åˆ’æ˜¯ä»¥kubeadmçš„ç‰ˆæœ¬ä¸ºåŸºå‡†çš„ï¼Œä¾‹å¦‚ä½ å½“å‰å®‰è£…çš„ kubeadm çš„ç‰ˆæœ¬æ˜¯ xï¼Œé‚£ä¹ˆä¹‹åé€šè¿‡ kubeadm å‘½ä»¤åˆ—å‡ºçš„å‡çº§è®¡åˆ’å°±æ˜¯å‡çº§åˆ° x çš„æœ€æ–°ç¨³å®šç‰ˆã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°† kubeadm å‡çº§åˆ°ç›®æ ‡ç‰ˆæœ¬</p><pre><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOFyum install -y kubeadm-$&#123;full_version&#125; --disableexcludes=kubernetes</code></pre><h2 id="ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šåˆ—å‡ºå‡çº§è®¡åˆ’">ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šåˆ—å‡ºå‡çº§è®¡åˆ’</h2><blockquote><p>åœ¨ç¬¬ä¸€ä¸ªè¦å‡çº§çš„æ ¸å¿ƒèŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p></blockquote><pre><code class="language-bash">kubeadm upgrade plan</code></pre><p>ä¼šè¾“å‡ºä¸‰éƒ¨åˆ†å†…å®¹ï¼Œ</p><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯å½“å‰é›†ç¾¤ä¿¡æ¯ v1.20.8å’Œå½“å‰kubeadmç‰ˆæœ¬å¯¹åº”çš„æœ€æ–°ç¨³å®šç‰ˆv1.21.7ï¼Œä»¥åŠå½“å‰é›†ç¾¤ç‰ˆæœ¬æœ€æ–°ç¨³å®šç‰ˆv1.20.13ï¼Œè¿˜æœ‰æœ€æ–°çš„v1.22.4ç‰ˆæœ¬</p><pre><code>[upgrade/config] Making sure the configuration is correct:[upgrade/config] Reading configuration from the cluster...[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'[preflight] Running pre-flight checks.[upgrade] Running cluster health checks[upgrade] Fetching available versions to upgrade to[upgrade/versions] Cluster version: v1.20.8[upgrade/versions] kubeadm version: v1.21.7I1202 16:13:13.030774    4057 version.go:254] remote version is much newer: v1.22.4; falling back to: stable-1.21[upgrade/versions] Target version: v1.21.7[upgrade/versions] Latest version in the v1.20 series: v1.20.13</code></pre><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯å‡çº§ä¿¡æ¯ï¼Œå‡çº§ä¿¡æ¯åˆåˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚</p><ul><li>å‡çº§åˆ°å½“å‰ç‰ˆæœ¬ v1.20.8çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬v1.20.13</li></ul><pre><code>Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':COMPONENT   CURRENT       TARGETkubelet     3 x v1.20.8   v1.20.13Upgrade to the latest version in the v1.20 series:COMPONENT                 CURRENT    TARGETkube-apiserver            v1.20.8    v1.20.13kube-controller-manager   v1.20.8    v1.20.13kube-scheduler            v1.20.8    v1.20.13kube-proxy                v1.20.8    v1.20.13CoreDNS                   1.7.0      v1.8.0etcd                      3.4.13-0   3.4.13-0You can now apply the upgrade by executing the following command:        kubeadm upgrade apply v1.20.13</code></pre><ul><li>å‡çº§åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬v1.21.7</li></ul><pre><code>Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':COMPONENT   CURRENT       TARGETkubelet     3 x v1.20.8   v1.21.7Upgrade to the latest stable version:COMPONENT                 CURRENT    TARGETkube-apiserver            v1.20.8    v1.21.7kube-controller-manager   v1.20.8    v1.21.7kube-scheduler            v1.20.8    v1.21.7kube-proxy                v1.20.8    v1.21.7CoreDNS                   1.7.0      v1.8.0etcd                      3.4.13-0   3.4.13-0You can now apply the upgrade by executing the following command:        kubeadm upgrade apply v1.21.7</code></pre><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯æ‰‹åŠ¨æ›´æ–°éƒ¨åˆ†</p><pre><code class="language-:">The table below shows the current state of component configs as understood by this version of kubeadm.Configs that have a &quot;yes&quot; mark in the &quot;MANUAL UPGRADE REQUIRED&quot; column require manual config upgrade orresetting to kubeadm defaults before a successful upgrade can be performed. The version to manuallyupgrade to is denoted in the &quot;PREFERRED VERSION&quot; column.API GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIREDkubeproxy.config.k8s.io   v1alpha1          v1alpha1            nokubelet.config.k8s.io     v1beta1           v1beta1             no</code></pre><p>â­ï¸å¦‚æœ<code>MANUAL UPGRADE REQUIRED</code>æ ‡è®°æ˜¯<code>yes</code>ï¼Œåˆ™ä½ éœ€è¦æ‰‹åŠ¨è¿›è¡Œå‡çº§ã€‚æ‰‹åŠ¨å‡çº§çš„å‰ææ˜¯éœ€è¦è‡ªè¡Œæä¾›é…ç½®æ–‡ä»¶</p><pre><code class="language-bash">kubeadm upgrade apply --config &lt;é…ç½®æ–‡ä»¶&gt;</code></pre><p>â„¹ï¸ kubeadm upgrade æ€»æ˜¯ä¼šåˆ·æ–°è¯ä¹¦ã€‚</p><h2 id="ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ä¸»è¦ç»„ä»¶">ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ä¸»è¦ç»„ä»¶</h2><blockquote><p>åœ¨ç¬¬ä¸€ä¸ªè¦å‡çº§çš„æ ¸å¿ƒèŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p></blockquote><pre><code class="language-bash">kubeadm upgrade apply v1.21.7=== æœŸé—´ä¼šæœ‰ä¸€æ¬¡ç¡®è®¤[upgrade/config] Making sure the configuration is correct:[upgrade/config] Reading configuration from the cluster...[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'[preflight] Running pre-flight checks.[upgrade] Running cluster health checks[upgrade/version] You have chosen to change the cluster version to &quot;v1.21.7&quot;[upgrade/versions] Cluster version: v1.20.8[upgrade/versions] kubeadm version: v1.21.7[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]:y=== æ‹‰å–é•œåƒ[upgrade/prepull] Pulling images required for setting up a Kubernetes cluster[upgrade/prepull] This might take a minute or two, depending on the speed of your internet connection[upgrade/prepull] You can also perform this action in beforehand using 'kubeadm config images pull'=== é™æ€podå‡çº§ï¼Œå¹¶å¤‡ä»½çš„ä¿¡æ¯[upgrade/apply] Upgrading your Static Pod-hosted control plane to version &quot;v1.21.7&quot;...Static pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3[upgrade/etcd] Upgrading to TLS for etcdStatic pod: etcd-k8s01 hash: d9b8ab2ef694da7813c41fbf36833ba1[upgrade/staticpods] Preparing for &quot;etcd&quot; upgrade[upgrade/staticpods] Current and new manifests of etcd are equal, skipping upgrade[upgrade/etcd] Waiting for etcd to become available[upgrade/staticpods] Writing new Static Pod manifests to &quot;/etc/kubernetes/tmp/kubeadm-upgraded-manifests437528341&quot;[upgrade/staticpods] Preparing for &quot;kube-apiserver&quot; upgrade[upgrade/staticpods] Renewing apiserver certificate[upgrade/staticpods] Renewing apiserver-kubelet-client certificate[upgrade/staticpods] Renewing front-proxy-client certificate[upgrade/staticpods] Renewing apiserver-etcd-client certificate[upgrade/staticpods] Moved new manifest to &quot;/etc/kubernetes/manifests/kube-apiserver.yaml&quot; and backed up old manifest to &quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2021-12-02-16-21-32/kube-apiserver.yaml&quot;[upgrade/staticpods] Waiting for the kubelet to restart the component[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)Static pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: 871c4bc8d662b466c6481ef11d3bc7ecStatic pod: kube-apiserver-k8s01 hash: c99ad4c36653e9251a653ed601ba1117[apiclient] Found 3 Pods for label selector component=kube-apiserver[upgrade/staticpods] Component &quot;kube-apiserver&quot; upgraded successfully![upgrade/staticpods] Preparing for &quot;kube-controller-manager&quot; upgrade[upgrade/staticpods] Renewing controller-manager.conf certificate[upgrade/staticpods] Moved new manifest to &quot;/etc/kubernetes/manifests/kube-controller-manager.yaml&quot; and backed up old manifest to &quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2021-12-02-16-21-32/kube-controller-manager.yaml&quot;[upgrade/staticpods] Waiting for the kubelet to restart the component[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)Static pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-controller-manager-k8s01 hash: 22f0b6f7c55d4fef49a89a4f535241a0Static pod: kube-controller-manager-k8s01 hash: ecd7e36a5c07f4ccf0f769e8f0fe6dc5[apiclient] Found 3 Pods for label selector component=kube-controller-manager[upgrade/staticpods] Component &quot;kube-controller-manager&quot; upgraded successfully![upgrade/staticpods] Preparing for &quot;kube-scheduler&quot; upgrade[upgrade/staticpods] Renewing scheduler.conf certificate[upgrade/staticpods] Moved new manifest to &quot;/etc/kubernetes/manifests/kube-scheduler.yaml&quot; and backed up old manifest to &quot;/etc/kubernetes/tmp/kubeadm-backup-manifests-2021-12-02-16-21-32/kube-scheduler.yaml&quot;[upgrade/staticpods] Waiting for the kubelet to restart the component[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3Static pod: kube-scheduler-k8s01 hash: 98178ef8494b07ffc6d724adb4d8a0c3Static pod: kube-scheduler-k8s01 hash: 7d2a77b067995d323e127a47f45e8f14[apiclient] Found 3 Pods for label selector component=kube-scheduler[upgrade/staticpods] Component &quot;kube-scheduler&quot; upgraded successfully![upgrade/postupgrade] Applying label node-role.kubernetes.io/control-plane='' to Nodes with label node-role.kubernetes.io/master='' (deprecated)[upgrade/postupgrade] Applying label node.kubernetes.io/exclude-from-external-load-balancers='' to control plane Nodes[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace[kubelet] Creating a ConfigMap &quot;kubelet-config-1.21&quot; in namespace kube-system with the configuration for the kubelets in the cluster[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster[addons] Applied essential addon: CoreDNS[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address[addons] Applied essential addon: kube-proxy[upgrade/successful] SUCCESS! Your cluster was upgraded to &quot;v1.21.7&quot;. Enjoy!=== æé†’è‹¥æ²¡æœ‰å‡çº§ kubelets åˆ™éœ€è¦ç»§ç»­å‡çº§[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.</code></pre><p>æ ¹æ®æç¤ºä¿¡æ¯&quot; Moved new manifest to â€œ/etc/kubernetes/manifests/kube-apiserver.yamlâ€ and backed up old manifest to â€œ/etc/kubernetes/tmp/kubeadm-backup-manifests-2021-12-02-16-21-32/kube-apiserver.yamlâ€ å¯ä»¥å¾—çŸ¥å¤‡ä»½æ–‡ä»¶è·¯å¾„.</p><h2 id="ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ç½‘ç»œæ’ä»¶">ç¬¬ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ç½‘ç»œæ’ä»¶</h2><blockquote><p>åœ¨æ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„å®¢æˆ·ç«¯æ“ä½œ</p></blockquote><p>è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ flannel. æ‰€ä»¥æˆ‘åªæ˜¯ç®€å•çš„é‡æ–°æ‰§è¡Œä¸€è¾¹.å› ä¸º flannel æ˜¯ DaemonSetï¼Œæ‰€ä»¥æ— éœ€åœ¨å…¶å®ƒæ ¸å¿ƒèŠ‚ç‚¹å†æ¬¡æ‰§è¡Œ.</p><p><a href="https://github.com/flannel-io/flannel#deploying-flannel-manually">https://github.com/flannel-io/flannel#deploying-flannel-manually</a></p><pre><code class="language-bash">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></pre><blockquote><p>ä¿®æ”¹é‡Œé¢çš„<code>data.net-conf.json</code>ä¸‹çš„ â€œNetworkâ€: â€œ10.244.0.0/16â€, å˜æ›´ä¸ºä½ è‡ªå·±çš„ pod ç½‘æ®µï¼Œå³ cmå¯¹è±¡ kubeadm-config é‡Œçš„ networking.podSubnet æˆ–è€… kubeadm åˆå§‹åŒ–å®‰è£…å‚æ•° pod-network-cidr</p></blockquote><pre><code class="language-bash">kubectl describe cm kubeadm-config -n kube-system===ClusterConfiguration:----apiServer:  extraArgs:    authorization-mode: Node,RBAC  timeoutForControlPlane: 4m0sapiVersion: kubeadm.k8s.io/v1beta2certificatesDir: /etc/kubernetes/pkiclusterName: kubernetescontrolPlaneEndpoint: k8sapi:8443controllerManager: &#123;&#125;dns:  type: CoreDNSetcd:  local:    dataDir: /var/lib/etcdimageRepository: k8s.gcr.iokind: ClusterConfigurationkubernetesVersion: v1.20.8networking:  dnsDomain: cluster.local  podSubnet: 10.97.0.0/16  serviceSubnet: 10.96.0.0/16scheduler: &#123;&#125;</code></pre><pre><code class="language-bash">kubectl apply -f  kube-flannel.yml</code></pre><p>ç­‰å¾…podéƒ¨ç½²å®Œæ¯•</p><pre><code class="language-bash">âœ   kubectl get pod -n kube-system -o wide | grep kube-flannelkube-flannel-ds-52krd             1/1     Running   0          6m25s   10.200.16.102   k8s02   &lt;none&gt;           &lt;none&gt;kube-flannel-ds-9hnrs             1/1     Running   0          4m31s   10.200.16.103   k8s03   &lt;none&gt;           &lt;none&gt;kube-flannel-ds-b5b6m             1/1     Running   0          2m47s   10.200.16.101   k8s01   &lt;none&gt;           &lt;none&gt;</code></pre><h2 id="å‰©ä½™æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§-kubeadmå’Œä¸»è¦ç»„ä»¶">å‰©ä½™æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ kubeadmå’Œä¸»è¦ç»„ä»¶</h2><blockquote><p>å‰©ä½™çš„æ ¸å¿ƒèŠ‚ç‚¹</p></blockquote><pre><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF# å®‰è£… kubeadmyum install -y kubeadm-$&#123;full_version&#125; --disableexcludes=kubernetes# å‡çº§èŠ‚ç‚¹kubeadm upgrade node</code></pre><h2 id="æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šä¾æ¬¡å‡çº§-kubelet-å’Œ-kubectl">æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šä¾æ¬¡å‡çº§ kubelet å’Œ kubectl</h2><p>ä¾æ¬¡å‡çº§æ¯ä¸€ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ï¼Œä¸è¦åŒæ—¶å‡çº§.</p><h3 id="åœæ­¢è°ƒåº¦">åœæ­¢è°ƒåº¦</h3><blockquote><p>åœ¨æ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„å®¢æˆ·ç«¯æ“ä½œ</p></blockquote><p>åœæ­¢è°ƒåº¦ä¹‹å‰ï¼Œå¦‚æœæœ‰é‡å‹åˆ†å¸ƒå¼èŠ‚ç‚¹ï¼Œåˆ™éœ€ç¡®ä¿èŠ‚ç‚¹çŠ¶æ€å‡ä¸º<code>running</code>.ä¾‹å¦‚EFKæˆ–è€…etcdç­‰</p><pre><code class="language-bash">kubectl get pod -n kube-system</code></pre><pre><code class="language-bash:">nodeHostname=kubectl drain $&#123;nodeHostname&#125; --ignore-daemonsets</code></pre><p>â€“ignore-daemonsets å¿½ç•¥ daemonsetsï¼Œå› ä¸º daemonsets ä¼šåœ¨é©±é€èŠ‚ç‚¹ä¸Šé‡å»º pod ä»è€Œå¯¼è‡´é©±é€å¤±è´¥ã€‚</p><p>â„¹ï¸æœ‰æ—¶å€™é©±é€ä¼šæŠ¥é”™ï¼Œæç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p><pre><code class="language-bash">error: cannot delete Pods with local storage (use --delete-emptydir-data to override): kube-system/metrics-server-6bd8d94d7f-c72hn</code></pre><p>æ ¹æ®æç¤ºä¿¡æ¯ï¼Œåˆ¤æ–­æåˆ°çš„å®¹å™¨çš„æœ¬åœ°æ•°æ®æ˜¯å¦æœ‰ç”¨ï¼Œæ— ç”¨åˆ™ç›´æ¥é™„åŠ <code>--delete-emptydir-data</code>å³å¯ã€‚</p><pre><code class="language-bash">kubectl get node===NAME    STATUS                     ROLES    AGE   VERSIONk8s01   Ready,SchedulingDisabled   master   40h   v1.18.6</code></pre><h3 id="å‡çº§-kubeletã€kubectl">å‡çº§ kubeletã€kubectl</h3><blockquote><p>å¾…å‡çº§æ ¸å¿ƒèŠ‚ç‚¹æ‰§è¡Œ</p></blockquote><pre><code class="language-bash"># åœ¨å¾…å‡çº§çš„æ ¸å¿ƒèŠ‚ç‚¹ä¸Šæ“ä½œyum install -y kubelet-$&#123;full_version&#125; kubectl-$&#123;full_version&#125; --disableexcludes=kubernetessystemctl daemon-reloadsystemctl restart kubelet</code></pre><h3 id="æ¢å¤è°ƒåº¦">æ¢å¤è°ƒåº¦</h3><blockquote><p>åœ¨æ‹¥æœ‰ç®¡ç†å‘˜æƒé™çš„å®¢æˆ·ç«¯æ“ä½œ</p></blockquote><pre><code class="language-bash">kubectl uncordon $&#123;nodeHostname&#125;kubectl get nodeNAME    STATUS   ROLES                  AGE    VERSIONk8s01   Ready    control-plane,master   408d   v1.20.8k8s02   Ready    control-plane,master   408d   v1.20.8k8s03   Ready    control-plane,master   282d   v1.20.8</code></pre><h2 id="æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šå¼€å¯-kube-scheduler-å’Œ-kube-controller-manager-ç«¯å£">æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šå¼€å¯ kube-scheduler å’Œ kube-controller-manager ç«¯å£</h2><p>è‹¥å‘ç°<code>kubectl get cs</code> ä¸¤ä¸ªæœåŠ¡æ— æ³•è¿æ¥ï¼Œåˆ™å¯ä»¥çœ‹ä¸‹é…ç½®ç«¯å£æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œä¸‹åˆ—å‘½ä»¤</p><blockquote><p>æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹æ‰§è¡Œ</p></blockquote><pre><code class="language-bash">sed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-scheduler.yamlsed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-controller-manager.yaml</code></pre><p>ğŸŒŸä¸ä¸€å®šéœ€è¦æ‰§è¡Œï¼Œå…·ä½“ä»¥å®é™…ç¯å¢ƒä¸ºå‡†</p><h2 id="æ£€æŸ¥å‡çº§ç»“æœ">æ£€æŸ¥å‡çº§ç»“æœ</h2><pre><code class="language-bash">âœ   kubectl get nodeNAME    STATUS   ROLES                  AGE    VERSIONk8s01   Ready    control-plane,master   408d   v1.21.7k8s02   Ready    control-plane,master   408d   v1.21.7k8s03   Ready    control-plane,master   282d   v1.21.7</code></pre><pre><code class="language-bash">âœ   kubectl get csWarning: v1 ComponentStatus is deprecated in v1.19+NAME                 STATUS    MESSAGE             ERRORcontroller-manager   Healthy   okscheduler            Healthy   oketcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</code></pre><pre><code class="language-bash">âœ   kubectl get pod -n kube-systemNAME                              READY   STATUS    RESTARTS   AGEcoredns-85d9df8444-kd2w6          1/1     Running   0          28mcoredns-85d9df8444-m6r2f          1/1     Running   0          24metcd-k8s01                        1/1     Running   0          2m13setcd-k8s02                        1/1     Running   1          2m14setcd-k8s03                        1/1     Running   0          2m12skube-apiserver-k8s01              1/1     Running   0          2m13skube-apiserver-k8s02              1/1     Running   1          2m13skube-apiserver-k8s03              1/1     Running   0          2m15skube-controller-manager-k8s01     1/1     Running   0          105skube-controller-manager-k8s02     1/1     Running   0          106skube-controller-manager-k8s03     1/1     Running   0          105skube-flannel-ds-52krd             1/1     Running   0          44mkube-flannel-ds-9hnrs             1/1     Running   0          42mkube-flannel-ds-b5b6m             1/1     Running   0          40mkube-proxy-lmkw9                  1/1     Running   0          53mkube-proxy-nh98w                  1/1     Running   0          54mkube-proxy-wdvfd                  1/1     Running   0          53mkube-scheduler-k8s01              1/1     Running   0          107skube-scheduler-k8s02              1/1     Running   0          106skube-scheduler-k8s03              1/1     Running   0          101smetrics-server-6bd8d94d7f-wp59m   1/1     Running   0          28m</code></pre><h1>å‡çº§å·¥ä½œèŠ‚ç‚¹ node</h1><p>â„¹ï¸åº”è¯¥ä¸€ä¸ªä¸€ä¸ªçš„å‡çº§ï¼Œè€Œä¸æ˜¯æ‰¹é‡ï¼Œé¿å…é›†ç¾¤å‹åŠ›è¿‡å¤§.</p><p>æˆ‘è¿™é‡Œæµ‹è¯•ç¯å¢ƒï¼Œæ ¸å¿ƒèŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹æ˜¯é‡å çš„ï¼Œæ‰€ä»¥æ— éœ€å†å‡çº§å·¥ä½œèŠ‚ç‚¹ã€‚</p><pre><code class="language-bash">full_version=1.21.7nodeName=# å‡çº§kubeadmyum install -y kubeadm-$&#123;appVersion&#125; --disableexcludes=kubernetes# å‡çº§æœ¬åœ° kubelet é…ç½®kubeadm upgrade node# é”å®šnodekubectl drain $&#123;nodeName&#125; --ignore-daemonsets# å‡çº§ kubelet å’Œ kubectlyum install -y kubelet-$&#123;appVersion&#125; kubectl-$&#123;appVersion&#125; --disableexcludes=kubernetes# é‡å¯systemctl daemon-reloadsystemctl restart kubelet# è§£é”nodekubectl uncordon $&#123;nodeName&#125;</code></pre><h1>å‡çº§å¤±è´¥</h1><h3 id="å‡çº§å¤±è´¥ï¼Œæ²¡æœ‰å›æ»š">å‡çº§å¤±è´¥ï¼Œæ²¡æœ‰å›æ»š</h3><p>å¯èƒ½æ˜¯æ‰§è¡ŒæœŸé—´è¢«æ„å¤–å…³é—­ï¼Œåˆ™å¯ä»¥å†æ¬¡è¿è¡Œ<code>kubeadm upgrade </code></p><h3 id="å‡çº§å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»šä¹Ÿå¤±è´¥">å‡çº§å¤±è´¥ï¼Œè‡ªåŠ¨å›æ»šä¹Ÿå¤±è´¥</h3><pre><code class="language-bash">full_version=kubeadm upgrade apply --force $&#123;appVersion&#125;</code></pre><h2 id="æ— è®ºå¦‚ä½•éƒ½å¤±è´¥ï¼Œæ‰‹åŠ¨æ¢å¤">æ— è®ºå¦‚ä½•éƒ½å¤±è´¥ï¼Œæ‰‹åŠ¨æ¢å¤</h2><p>å‡çº§å‰ï¼Œkubernetes ä¼šå¤‡ä»½ etcd å’Œ é™æ€podçš„å†…å®¹</p><p>å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><p><code>/etc/kubernetes/tmp/kubeadm-backup-etcd-&lt;date&gt;-&lt;time&gt;/etcd</code>= <code>/var/lib/etcd/</code></p><p><code>/etc/kubernetes/tmp/kubeadm-backup-manifests-&lt;date&gt;-&lt;time&gt;</code>= <code> /etc/kubernetes/manifests/</code></p><p>å°†ç­‰å·å·¦è¾¹çš„è·¯å¾„å†…å®¹è¦†ç›–åˆ°ç­‰å·å³è¾¹ï¼Œä»¥ä¾¿äºé™æ€podé‡å»º</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> kubeadm </tag>
            
            <tag> å‡çº§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜15è¯ä¹¦ç®¡ç†</title>
      <link href="posts/55da993d/"/>
      <url>posts/55da993d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>k8sé»˜è®¤çš„CAè¯ä¹¦æœ‰æ•ˆæœŸæ˜¯10å¹´ã€‚é»˜è®¤ç­¾å‘çš„æœåŠ¡è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯1å¹´ã€‚</p><p>k8sæ”¯æŒè‡ªåŠ¨è½®æ¢è¯ä¹¦ã€‚</p><p>k8sæ”¯æŒè½®æ¢æ—¶å€™çš„è¯ä¹¦æœ‰æ•ˆæœŸã€‚ä¸è¿‡æœ€é•¿æ˜¯10å¹´ã€‚ï¼ˆæˆ‘è¿™è¾¹è®¾ç½®ä¸º100å¹´ï¼Œæ²¡æ•ˆæœï¼‰</p><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/</a></p><h2 id="æ£€æŸ¥å½“å‰æ§åˆ¶é¢èŠ‚ç‚¹é‡Œè¯ä¹¦">æ£€æŸ¥å½“å‰æ§åˆ¶é¢èŠ‚ç‚¹é‡Œè¯ä¹¦</h2><pre><code class="language-bash">kubeadm alpha certs check-expiration</code></pre><p>ä½ å¯ä»¥é€šè¿‡æ­¤å‘½ä»¤æŸ¥çœ‹å„ç±»è¯ä¹¦çš„æœ‰æ•ˆæœŸ</p><h2 id="è§¦å‘è‡ªåŠ¨è½®æ¢è¯ä¹¦çš„è¡Œä¸º">è§¦å‘è‡ªåŠ¨è½®æ¢è¯ä¹¦çš„è¡Œä¸º</h2><p>å½“ä½ é€šè¿‡kubeadm upgrade nodeå‘½ä»¤è¿›è¡Œå‡çº§æˆ–è€…é€šè¿‡control planeè¿›è¡Œå‡çº§çš„æ—¶å€™ï¼Œk8sä¼šè‡ªåŠ¨è½®æ¢è¯ä¹¦ã€‚</p><h2 id="é€šè¿‡å‘½ä»¤æ‰‹åŠ¨è§¦å‘è¯ä¹¦è½®æ¢">é€šè¿‡å‘½ä»¤æ‰‹åŠ¨è§¦å‘è¯ä¹¦è½®æ¢</h2><p><code>kubeadm alpha certs renew all</code>ä½ å¯ä»¥é€šè¿‡æ­¤å‘½ä»¤è¿›è¡Œæ‰€æœ‰è¯ä¹¦è½®æ¢</p><p>â­ï¸è¯·æ³¨æ„ï¼Œå¦‚æœä½ è¿è¡Œäº†é«˜å¯ç”¨é›†ç¾¤ï¼Œåˆ™éœ€è¦åœ¨æ‰€æœ‰çš„control-planeèŠ‚ç‚¹ä¸Šè¿è¡Œæ­¤å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸»èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p><h2 id="ä¸ºkubeleté…ç½®è¯ä¹¦è‡ªåŠ¨è½®è½¬">ä¸ºkubeleté…ç½®è¯ä¹¦è‡ªåŠ¨è½®è½¬</h2><p><a href="https://kubernetes.io/docs/tasks/tls/certificate-rotation/">https://kubernetes.io/docs/tasks/tls/certificate-rotation/</a></p><p>â­ï¸1.18å’Œ1.19æœ‰å·®å¼‚ã€‚1.18æ˜¯å·²ç»é»˜è®¤å¼€å¯çš„ï¼Œä¸è¿‡é»˜è®¤çš„è½®è½¬çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯1å¹´</p><p>ä½¿ç”¨è‡ªåŠ¨è½®è½¬ï¼Œéœ€è¦å¼€å¯ä¸¤ä¸ªæœåŠ¡çš„é…ç½®ï¼š</p><ul><li><p>å¼€å¯kubeletå¯åŠ¨æ ‡è®°ï¼š<code>--rotate-certificates=true</code></p><p>â­ï¸å¼€å¯ç¡®è®¤å‘½ä»¤ï¼š<code>kubectl describe cm/kubelet-config-1.18 -n kube-system | grep 'rotateCertificates'</code></p><p>â­ï¸åŠ¨æ€çš„ä¿®æ”¹kubelet <a href="https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/#reconfiguring-the-kubelet-on-a-running-node-in-your-cluster">https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/#reconfiguring-the-kubelet-on-a-running-node-in-your-cluster</a></p><pre><code class="language-bash"># è¯·å…ˆå®‰è£… jq å‘½ä»¤. ä»–æ˜¯ epel é‡Œçš„# å¼€å¯ä»£ç†ç›‘å¬kubectl proxy --port=8001 # å¯¼å‡ºkubeleté…ç½®NODE_NAME=&quot;èŠ‚ç‚¹å&quot;; curl -sSL &quot;http://localhost:8001/api/v1/nodes/$&#123;NODE_NAME&#125;/proxy/configz&quot; | jq '.kubeletconfig|.kind=&quot;KubeletConfiguration&quot;|.apiVersion=&quot;kubelet.config.k8s.io/v1beta1&quot;' &gt; kubelet_configz_$&#123;NODE_NAME&#125;# ç¼–è¾‘å®Œé…ç½®ï¼Œé‡æ–°å¯¼å…¥ï¼Œå¹¶ç¡®è®¤æ–°é…ç½®å¯¹è±¡åkubectl -n kube-system create configmap node-config-new --from-file=kubelet=kubelet_configz_$&#123;NODE_NAME&#125; --append-hash -o yaml# è°ƒæ•´æ¯ä¸€ä¸ªnodeå¯¹è±¡ï¼Œæ·»åŠ æ–°çš„é…ç½®å¯¹è±¡kubectl edit node $&#123;NODE_NAME&#125;===configSource:    configMap:        name: CONFIG_MAP_NAME # å°†è¿™ä¸ªåå­—æ›¿æ¢æˆæ–°çš„é…ç½®å¯¹è±¡å        namespace: kube-system        kubeletConfigKey: kubelet# æ£€æŸ¥é…ç½®ç”Ÿæ•ˆkubectl get node $&#123;NODE_NAME&#125; -o json | jq '.status.config'</code></pre></li><li><p>è°ƒæ•´é»˜è®¤è¯ä¹¦æœ‰æ•ˆæœŸ</p><p>å¼€å¯<code>kube-controller-manager</code>å¯åŠ¨æ ‡è®°ï¼š<code>--cluster-signing-duration</code>ï¼Œè¿™ä¸ªæ ‡è®°é»˜è®¤æ˜¯1å¹´ï¼Œä½ å¯ä»¥æ”¹æˆ10å¹´ <code>87600h0m0s</code></p><p>ä¿®æ”¹ä½ç½®ï¼š<code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code></p><p>ä¿®æ”¹ç”Ÿæ•ˆï¼škube-controller-manager pod å°†è‡ªåŠ¨é‡å»º</p><p>âš ï¸å¦‚æœæ˜¯1.18ï¼Œåˆ™å¯åŠ¨æ ‡è®°æ˜¯<code>--experimental-cluster-signing-duration</code></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> è¯ä¹¦ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜14è®¤è¯æˆæƒ</title>
      <link href="posts/a5ed67a6/"/>
      <url>posts/a5ed67a6/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºç¡€">åŸºç¡€</h2><h3 id="æµç¨‹ä»‹ç»">æµç¨‹ä»‹ç»</h3><p>è¿™é‡Œæ˜¯ä¸€ä¸ªè®¤è¯çš„ä¸€ä¸ªåŸºæœ¬æµç¨‹ï¼š</p><p><img src="/posts/a5ed67a6/image-20201016114248549.png" alt="image-20201016114248549"></p><p>å³ï¼š kubectl =&gt; ç”¨æˆ·è®¤è¯ =&gt; ç”¨æˆ·æˆæƒ =&gt; å…¥å£æ§åˆ¶ -&gt; èµ„æºå¯¹è±¡</p><p>ç”¨æˆ·è®¤è¯ï¼šæ£€æŸ¥é€’äº¤ä¿¡æ¯åŒ…å«çš„è¯ä¹¦ï¼Œç”¨æˆ·åã€‚ç¡®å®šæ˜¯å¦æ˜¯æ­£å¸¸ç”¨æˆ·ã€‚</p><p>ç”¨æˆ·æˆæƒï¼šç»™ç”¨æˆ·æˆæƒæƒé™ç­–ç•¥ï¼Œæˆæƒæ–¹å¼æœ‰å¤šç§ï¼šABAC modeï¼Œ RBAC Modeï¼Œ and Webhook modeã€‚ç¡®å®šæ˜¯å¦æœ‰æƒé™ã€‚</p><p>å…¥å£æ§åˆ¶å™¨ï¼šå…·æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„è¿‡æ»¤å™¨ï¼Œä»–ä»¬ä¼šæŠŠè¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œå¦‚æœè¯·æ±‚è¿åäº†è¿‡æ»¤å™¨çš„é…ç½®ï¼Œåˆ™è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚ç¡®å®šæ˜¯å¦æœ‰æ›´ç²¾ç»†çš„ç²’åº¦æ§åˆ¶ã€‚</p><blockquote><p>ä»¥ä¸Šä¸‰é˜¶æ®µéƒ½æ˜¯é€šè¿‡æ’ä»¶å®ç°çš„ã€‚å½“æŸä¸ªé˜¶æ®µçš„æŸä¸ªæ’ä»¶æˆæƒé€šè¿‡åï¼Œå°±ä¸ä¼šå†éœ€è¦æ­¤é˜¶æ®µçš„å…¶å®ƒæ’ä»¶è¿›è¡Œæ ¡éªŒã€‚</p></blockquote><h2 id="ç”¨æˆ·è®¤è¯">ç”¨æˆ·è®¤è¯</h2><h3 id="ä»¤ç‰Œè®¤è¯">ä»¤ç‰Œè®¤è¯</h3><p>kubectl é€šè¿‡æäº¤ä»¤ç‰Œç»™ç”¨æˆ·è®¤è¯</p><h3 id="TSLè®¤è¯">TSLè®¤è¯</h3><p>kubectl å’Œ Api server åŒå‘è®¤è¯</p><h3 id="username-passwordè®¤è¯">username/passwordè®¤è¯</h3><p>ä¸€èˆ¬ä¸ç”¨è¿™ç§æ–¹å¼</p><h2 id="ç”¨æˆ·ç±»å‹">ç”¨æˆ·ç±»å‹</h2><p>å½“ä½ ä»ä½¿ç”¨è€…è§’åº¦æ¥çœ‹çš„æ—¶å€™ï¼Œk8sæŠŠç”¨æˆ·åˆ†ä¸º<code>æ™®é€šç”¨æˆ·</code>å’Œ<code>æœåŠ¡ç”¨æˆ·</code>ã€‚æ™®é€šç”¨æˆ·å¯¹å¤–ï¼ˆä¹Ÿå°±æ˜¯ä¸Šå›¾é‡Œçš„Humanï¼‰ï¼ŒæœåŠ¡ç”¨æˆ·å¯¹å†…ï¼ˆä¹Ÿå°±æ˜¯ä¸Šå›¾é‡Œçš„Podï¼‰ã€‚</p><p>è¯·è®°ä½ï¼Œk8så¹¶æ²¡æœ‰æ™®é€šç”¨æˆ·çš„<strong>å®ä½“å¯¹è±¡</strong>ã€‚å› æ­¤ï¼Œåªè¦ä½ é€’äº¤çš„ç”¨æˆ·æ‹¥æœ‰k8sé›†ç¾¤å†…éƒ¨CAæ‰€ç­¾å‘çš„è¯ä¹¦ï¼Œé‚£ä¹ˆè¿™ä¸ªç”¨æˆ·å°±ä¼šè¢«rbacå­ç³»ç»Ÿè®¤ä¸ºæ˜¯æœ‰æ•ˆçš„ã€‚</p><h3 id="æ™®é€šç”¨æˆ·">æ™®é€šç”¨æˆ·</h3><h4 id="åˆ›å»ºæ™®é€šç”¨æˆ·">åˆ›å»ºæ™®é€šç”¨æˆ·</h4><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user">https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user</a></p><ol><li><p>åˆ›å»ºç§é’¥keyï¼Œè¯ä¹¦è¯·æ±‚æ–‡ä»¶csr</p><p>åˆ›å»ºç§é’¥ä¼šè®©ä½ å¡«å†™ä¸€äº›å±æ€§ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå±æ€§ç‰¹åˆ«é‡è¦ï¼Œåˆ†åˆ«æ˜¯æŒ‡å®šç”¨æˆ·åçš„å±æ€§CNå’ŒæŒ‡å®šç”¨æˆ·ç»„çš„å±æ€§O</p><p>ä¾‹å¦‚åˆ›å»ºç”¨æˆ·<code>zyh</code>ï¼Œç¾¤ç»„<code>it</code></p><pre><code>openssl genrsa -out zyh.key 2048openssl req -new -key zyh.key -out zyh.csr -subj &quot;/CN=zyh/O=it&quot;</code></pre></li><li><p>æ„å»ºk8sçš„ CertificateSigningRequest è¯ä¹¦è¯·æ±‚å¯¹è±¡</p><ul><li>å…ˆå°†csræ–‡ä»¶è¿›è¡Œbase64ç¼–ç </li></ul><pre><code class="language-bash">RequestStr=`cat zyh.csr | base64 | tr -d &quot;\n&quot;`</code></pre><ul><li>å°†ç¼–ç åçš„å†…å®¹å†™å…¥ request å­—æ®µ</li></ul><pre><code class="language-yaml">cat &lt;&lt;EOF | kubectl apply -f -apiVersion: certificates.k8s.io/v1kind: CertificateSigningRequestmetadata:  name: zyhspec:  groups:  - system:authenticated  request: $&#123;RequestStr&#125;  signerName: kubernetes.io/kube-apiserver-client  usages:  - client authEOF</code></pre><p>â­ï¸usageså­—æ®µå¿…é¡»æ˜¯<code>client auth</code></p><p>â­ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯ä¹¦ç­¾å‘é»˜è®¤åªæœ‰1å¹´æœ‰æ•ˆæœŸ</p><p>ğŸŒŸç¡®ä¿å½“å‰ csr æ²¡æœ‰é‡åç”³è¯·</p></li><li><p>æ‰¹å‡†è¯ä¹¦è¯·æ±‚ï¼Œå¹¶è·å–è¯ä¹¦</p><p>æ‰¹å‡†ï¼š</p><pre><code class="language-bash">kubectl get csrkubectl certificate approve zyh</code></pre><p>è·å–ï¼š</p><pre><code class="language-bash">kubectl get csr zyh -o jsonpath='&#123;.status.certificate&#125;' | base64 --decode &gt; zyh.crt</code></pre><p>â­ï¸æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸï¼šâ€‹<code>openssl x509 -in zyh.crt -noout -dates</code></p><p>è‡³æ­¤ï¼Œä¸€ä¸ªæ™®é€šç”¨æˆ·å°±åˆ›å»ºå®Œæ¯•äº†ã€‚ä½†æ˜¯å®ƒæ²¡æœ‰ä»»ä½•æƒé™ï¼Œè¿˜éœ€è¦è¿›è¡Œæˆæƒã€‚</p></li></ol><h4 id="ä½¿ç”¨æ™®é€šç”¨æˆ·">ä½¿ç”¨æ™®é€šç”¨æˆ·</h4><ol><li><p>æ·»åŠ ç”¨æˆ·è¯ä¹¦åˆ°kubectlé…ç½®</p><pre><code class="language-bash">kubectl config set-credentials zyh --client-key=zyh.key --client-certificate=zyh.crt --embed-certs=true</code></pre></li><li><p>è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œæ–¹ä¾¿è¿›è¡Œç”¨æˆ·åˆ‡æ¢</p><pre><code class="language-bash">kubectl config set-context zyh --cluster=kubernetes --user=zyh</code></pre></li><li><p>é€šè¿‡ç”¨æˆ·ä¸Šä¸‹æ–‡è¿›è¡Œç”¨æˆ·åˆ‡æ¢</p><pre><code class="language-bash">kubectl config use-context zyh</code></pre></li></ol><p>ç”¨æˆ·çš„æœ‰æ•ˆæœŸï¼Œå–å†³äºä½ è¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚</p><h3 id="æœåŠ¡ç”¨æˆ·">æœåŠ¡ç”¨æˆ·</h3><h4 id="æµç¨‹">æµç¨‹</h4><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/#service-account-automation">https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/#service-account-automation</a></p><p>æœåŠ¡ç”¨æˆ·å¯¹è±¡ï¼Œå³ServiceAccountã€‚</p><ul><li><p>æ¯ä¸€ä¸ªnamespaceçš„æ—¶å€™éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤ServiceAccountå’Œé»˜è®¤secretï¼Œå¹¶ä¸”é»˜è®¤ServiceAccountå…³è”é»˜è®¤secretã€‚</p></li><li><p>secretä¸­å«æœ‰saè®¤è¯æ‰€éœ€çš„è¯ä¹¦å’ŒTokenã€‚</p></li><li><p>å½“Podåˆ›å»ºå¥½ä¹‹åï¼Œsecretä¼šå°†è¯ä¹¦å’ŒTokenæŒ‚è½½åˆ°<code>/var/run/secrets/kubernetes.io/serviceaccount/</code>è·¯å¾„ä¸‹ã€‚Podé€šè¿‡æŒ‚è½½çš„è®¤è¯æ–‡ä»¶åˆæ³•åŒ–ã€‚</p></li><li><p>é€šè¿‡RABCæœºåˆ¶å¯¹saè¿›è¡Œæˆæƒï¼Œä»è€Œä½¿Podæ‹¥æœ‰äº†è·å–è¯¸å¤šèµ„æºçš„æƒé™ã€‚</p></li><li><p>åœ¨æ²¡æœ‰æ˜¾å¼æŒ‡å®šsaçš„æ—¶å€™ï¼ŒPodä¼šè°ƒç”¨é»˜è®¤saã€‚</p></li></ul><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„SAå¯¹è±¡é€šè¿‡<code>imagePullSecrets</code>é™„åŠ äº†é¢å¤–çš„secretæˆæƒä¿¡æ¯<code>myregistrykey</code>ï¼Œä½¿å¾—Podå¯ä»¥æ‹‰å–é•œåƒã€‚</p><pre><code class="language-yaml">apiVersion: v1kind: ServiceAccountmetadata:  name: default  namespace: defaultsecrets:- name: default-token-uudge # è¿™æ˜¯é»˜è®¤æœåŠ¡è´¦æˆ·çš„TokenimagePullSecrets:- name: myregistrykey  # è¿™æ˜¯Secretå¯¹è±¡çš„keyï¼Œå­˜å‚¨ç€æ‹‰å–é•œåƒçš„ç”¨æˆ·å¯†ç </code></pre><h4 id="åˆ›å»ºæœåŠ¡ç”¨æˆ·">åˆ›å»ºæœåŠ¡ç”¨æˆ·</h4><pre><code class="language-bash">kubectl create serviceaccount admin</code></pre><blockquote><p>åˆ›å»ºå®Œæ¯•åï¼Œå¯¹åº”çš„ secret.namespace ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼š&lt;sa_name&gt;-token-$RANDOMï¼Œç”¨æ¥è¿›è¡Œèµ„æºå¯¹è±¡çš„è®¤è¯ï¼Œè¯·æ³¨æ„è¿™é‡Œæ˜¯è®¤è¯ï¼Œä¸æ˜¯æˆæƒã€‚ä¹Ÿå°±æ˜¯è¯´é€šè¿‡äº†è®¤è¯ä½†æ²¡æƒé™è®¿é—®èµ„æºã€‚</p></blockquote><h4 id="ä½¿ç”¨æœåŠ¡ç”¨æˆ·">ä½¿ç”¨æœåŠ¡ç”¨æˆ·</h4><p>Podé€šè¿‡spec.serviceAccountNameæ˜¾å¼æŒ‡å®šä¸€ä¸ªSA</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  labels:    run: cirros-6365  name: cirros-6365  namespace: defaultspec:  serviceAccountName: &lt;serviceAccount_name&gt;</code></pre><h2 id="ç”¨æˆ·æˆæƒ">ç”¨æˆ·æˆæƒ</h2><p>é€šè¿‡kubeadmå®‰è£…çš„é›†ç¾¤ï¼Œé»˜è®¤å°±æ˜¯RBACæˆæƒæœºåˆ¶ã€‚</p><p>RBACæœºåˆ¶ï¼šåŸºäºè§’è‰²çš„æˆæƒæ–¹å¼ã€‚</p><p>å…¶æ„æ€å°±æ˜¯ï¼šç”¨æˆ·é€šè¿‡æ‰®æ¼”æŸä¸ªè§’è‰²æ¥è·å–èµ„æºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·ä¸è§’è‰²ç»‘å®šï¼Œè§’è‰²ä¸æƒé™ç»‘å®šã€‚</p><h3 id="æ¶‰åŠçš„å¯¹è±¡">æ¶‰åŠçš„å¯¹è±¡</h3><ul><li>è§’è‰²ï¼šåŒ…å«æƒé™çš„å¯¹è±¡ï¼Œåˆ†ä¸ºroleå’Œclusterroleã€‚<ul><li>roleåªèƒ½ç”¨äºæŸä¸ªå‘½åç©ºé—´ã€‚clusterroleå¯ä»¥ç”¨äºæ•´ä¸ªé›†ç¾¤ã€‚</li></ul></li><li>ä¸»é¢˜ï¼šè¢«æˆæƒçš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯ userï¼Œgroupï¼Œserviceaccount</li><li>ç»‘å®šï¼šç”¨äºå°†è§’è‰²å’Œä¸»é¢˜ç»‘å®šåœ¨ä¸€èµ·çš„å¯¹è±¡ï¼Œåˆ†ä¸ºrolebindingå’Œclusterrolebinding</li></ul><h3 id="ç”¨æ³•">ç”¨æ³•</h3><ol><li><p>è§’è‰²åˆ›å»ºã€‚ä½äº dev å‘½åç©ºé—´ä¸”æ‹¥æœ‰ deployments èµ„æºçš„å¢åˆ æ”¹æŸ¥çš„è§’è‰² developer</p><pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata:  name: developer  namespace: devrules:- apiGroups: [&quot;&quot;, &quot;apps&quot;]  resources: [&quot;deployments&quot;, &quot;replicasets&quot;, &quot;pods&quot;]  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;] # ä¹Ÿå¯ä»¥ä½¿ç”¨['*']</code></pre></li><li><p>ç»‘å®šåˆ›å»ºã€‚ä½äº dev å‘½åç©ºé—´çš„ rolebinding å¯¹è±¡</p><pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata:  name: developer-rolebinding  namespace: devsubjects:- kind: User  name: zyh  apiGroup: &quot;&quot;roleRef:  kind: Role  name: developer  apiGroup: rbac.authorization.k8s.io  # ç•™ç©ºå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ï¼Œåˆ™ä½¿ç”¨å½“å‰çš„apiGroup</code></pre></li><li><p>æµ‹è¯•æƒé™</p><pre><code class="language-bash">kubectl get pod -n dev===No resources found in developer namespace.kubectl get svc -n dev===Error from server (Forbidden): services is forbidden: User &quot;zyh&quot; cannot list resource &quot;services&quot; in API group &quot;&quot; in the namespace &quot;developer&quot;</code></pre></li></ol><p>é€šè¿‡ä¸Šè¿°åˆ›å»ºè¿‡ç¨‹ï¼Œä½ å¯ä»¥å‘ç°ç”¨æˆ·åˆ›å»ºå’Œç”¨æˆ·æˆæƒä¸¤ä¸ªé˜¶æ®µæ˜¯åˆ†ç¦»çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥åˆ›å»ºå¤šä¸ªç”¨æˆ·ï¼Œç„¶åç”¨åŒä¸€ä¸ªè§’è‰²ç»‘å®šå¤šä¸ªç”¨æˆ·ã€‚</p><h3 id="å¯¹è±¡æ€»ç»“">å¯¹è±¡æ€»ç»“</h3><p>role å’Œ rolebinding æ˜¯ namespace çº§åˆ«å¯¹è±¡ï¼Œclusterrole å’Œ clusterrolebinding æ˜¯é›†ç¾¤çº§åˆ«å¯¹è±¡ã€‚</p><ol><li>æˆæƒæŸä¸ªç”¨æˆ·å•å‘½åç©ºé—´æˆ–è€…é›†ç¾¤æƒé™ã€‚</li></ol><ul><li><p>é€šè¿‡ rolebinding å°† user å’Œ role å…³è”èµ·æ¥ï¼Œå®ç°å¯¹ä¸€ä¸ª user æ·»åŠ  namespace çº§åˆ«çš„ role æƒé™ã€‚</p></li><li><p>é€šè¿‡ clusterrolebinding å°† user å’Œ clusterrole å…³è”èµ·æ¥ï¼Œå®ç°å¯¹ä¸€ä¸ª user æ·»åŠ æ˜¯é›†ç¾¤çº§åˆ«çš„ clusterrole æƒé™ã€‚</p></li></ul><ol start="2"><li>æˆæƒæŸä¸ªç”¨æˆ·å¤šä¸ªå‘½åç©ºé—´çš„æƒé™ã€‚</li></ol><ul><li><p>é€šè¿‡ rolebinding å°† user å’Œ clusterrole å…³è”èµ·æ¥ï¼Œå®ç°å¯¹ä¸€ä¸ª user æ·»åŠ  namespace çº§åˆ«çš„ clusterrole æƒé™ã€‚</p><p>å› ä¸º clusterrole æ˜¯é›†ç¾¤çº§åˆ«ï¼Œæ‰€ä»¥ä½ å¯ä»¥å°†å¤šä¸ª namespace ä¸‹çš„ rolebinding å’Œ user å…³è”åˆ°ä¸€ä¸ª clusterroleã€‚</p><p>æ­¤æ—¶ï¼Œuser æ‹¥æœ‰çš„æƒé™å°†è‡ªåŠ¨è¢«çº¦æŸåœ¨å¤šä¸ª rolebinding çš„ namespace ä¸‹ã€‚</p></li></ul><blockquote><p>å½“ä½ æŠŠ user æ›¿æ¢ä¸º group çš„æ—¶å€™ï¼Œå°†ä¼šæˆæƒæŸä¸ªç»„</p><p>å½“ä½ æŠŠ user æ›¿æ¢ä¸º serviceaccount çš„æ—¶å€™ï¼Œå°†ä¼šæˆæƒè°ƒç”¨ spec.serviceAccountName çš„ pod</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> authorization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜011ç‰¹æ®Šæ§åˆ¶æµ</title>
      <link href="posts/2dab3d00/"/>
      <url>posts/2dab3d00/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>ä¸‰ä¸ªå¥‡ç‰¹çš„å…³é”®å­—<code>defer</code>/<code>recover</code>/<code>Panic</code></p><h1>defer</h1><p><code>defer</code>ç”¨äºå½“å‰å‡½æ•°ä½œç”¨åŸŸç»“æŸåï¼Œæ‰§è¡Œ defer åå®šä¹‰çš„ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ defer å¯ä»¥æ¨è¿Ÿè¯­å¥çš„æ‰§è¡Œã€‚</p><h2 id="è§„åˆ™">è§„åˆ™</h2><ol><li>ä¸€ä¸ªå‡½æ•°ä½“å†…å¯ä»¥åŒ…å«å¤šä¸ª deferï¼Œå¤šä¸ª defer ä¼šæš‚å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”å¤šä¸ª defer çš„æ‰§è¡Œé¡ºåºæ˜¯é€†åºçš„ï¼Œå³å…ˆè¿›åå‡ºã€‚</li><li>defer è¿›æš‚å­˜é˜Ÿåˆ—ä¹‹å‰ï¼Œå…¶æ¨è¿Ÿçš„ä»£ç ä¸­ä¸ä¸»å‡½æ•°åŒä½œç”¨åŸŸä¸‹çš„å˜é‡è‹¥å·²èµ‹å€¼ï¼Œåˆ™å˜é‡éœ€å¸¦å€¼è¿›é˜Ÿåˆ—ï¼›</li></ol><pre><code class="language-go">package mainimport &quot;fmt&quot;func main() &#123;    for i := 1; i &lt;= 4; i++ &#123;        defer fmt.Println(&quot;deferred&quot;, -i)        fmt.Println(&quot;regular&quot;, i)    &#125;&#125;</code></pre><pre><code class="language-bash">#è¾“å‡ºregular 1regular 2regular 3regular 4deferred -4deferred -3deferred -2deferred -1</code></pre><h2 id="æ¨è¿Ÿå‡½æ•°">æ¨è¿Ÿå‡½æ•°</h2><pre><code class="language-go">defer funcA() // æ¨è¿Ÿä¸€ä¸ªå·²æœ‰çš„å‡½æ•°funcAdefer func(&lt;args&gt;)&#123;&#125;(&lt;vars&gt;) // æ¨è¿Ÿä¸€ä¸ªå…¨æ–°çš„å‡½æ•°ï¼Œvarsæ˜¯ä¼ å…¥å˜é‡ï¼Œargsæ˜¯å½¢å‚ã€‚</code></pre><p>argså’Œvarsæ˜¯å¯é€‰çš„ã€‚ä½† <code>defer func()&#123; xxx &#125;()</code> æ ¼å¼ä¸å¯å˜ã€‚</p><h2 id="ç‰¹æ®Šä¾‹å­">ç‰¹æ®Šä¾‹å­</h2><ul><li>æƒ…å†µ1ï¼š<code>defer</code>ä¸­çš„å˜é‡ä¸å‡½æ•°è¿”å›å€¼å˜é‡ä¸€è‡´ï¼Œå¯¼è‡´è¿”å›ç»“æœè¶…å‡ºé¢„æœŸ</li></ul><pre><code class="language-go">func test01()(p int)&#123;    defer func()&#123;        p++    &#125;()    return 0&#125;func main()&#123;    f := test01()    fmt.Printf(&quot;fæ˜¯ï¼š%d\n&quot;,f)&#125;</code></pre><pre><code class="language-bash">#è¾“å‡ºfæ˜¯ï¼š1</code></pre><p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ</p><ol><li>defer æ¨è¿Ÿ p++</li><li>å‡½æ•° test01 æ‰§è¡Œå®Œæ¯•åï¼Œreturn 0ï¼Œä¼ é€’ç»™è¿”å›å˜é‡p;</li><li>æ‰§è¡Œ p++</li><li>p = 1</li></ol><ul><li>æƒ…å†µ2:<code>defer</code>ä¸å½“å‰å‡½æ•°æ„æˆé—­åŒ…ã€‚</li></ul><pre><code class="language-go">package mainimport &quot;fmt&quot;func test01(x int)(p int)&#123;    defer func(y int)&#123;        y++        p=x+y    &#125;(x)    x++    return 0&#125;func main()&#123;    f := test01(2)    fmt.Println(f)&#125;</code></pre><p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ:</p><ol><li>æ‰§è¡Œtest01(2);</li><li>æ¨è¿Ÿ func(y int) { y++; p=x+y} (2)</li><li>test01(2) æ‰§è¡Œå®Œï¼Œreturn 0ï¼Œä¼ é€’ç»™è¿”å›å˜é‡ pã€‚æ­¤æ—¶ p = 0ï¼Œx = 3;</li><li>å›  defer è°ƒç”¨äº† xï¼Œæ‰€ä»¥ test01 è™½ç„¶æ‰§è¡Œå®Œï¼Œä½† x æ— æ³•é‡Šæ”¾ã€‚</li><li>æ‰§è¡Œ func(y int) { y++; p=3+y} (2) å¾— y=3;p=3+y</li><li>p = 6</li></ol><h2 id="å¸¸ç”¨æ–¹å¼">å¸¸ç”¨æ–¹å¼</h2><p><code>defer</code> å‡½æ•°çš„ä¸€ä¸ªå…¸å‹ç”¨ä¾‹æ˜¯åœ¨ä½¿ç”¨å®Œæ–‡ä»¶åå°†å…¶å…³é—­.</p><pre><code class="language-go">package mainimport (    &quot;io&quot;    &quot;os&quot;    &quot;fmt&quot;)func main() &#123;    newfile, error := os.Create(&quot;learnGo.txt&quot;)    if error != nil &#123;        fmt.Println(&quot;Error: Could not create file.&quot;)        return    &#125;    defer newfile.Close()    if _, error = io.WriteString(newfile, &quot;Learning Go!&quot;); error != nil &#123;        fmt.Println(&quot;Error: Could not write to file.&quot;)        return    &#125;    newfile.Sync()&#125;</code></pre><h1>panic</h1>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜010é”™è¯¯å¤„ç†</title>
      <link href="posts/336ec0ac/"/>
      <url>posts/336ec0ac/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>Goè¯­è¨€æ£€æµ‹å’ŒæŠ¥å‘Šé”™è¯¯æƒ…å†µçš„æ–¹æ³•æ˜¯</p><ul><li>å¯èƒ½å¯¼è‡´é”™è¯¯çš„å‡½æ•°å°†è¿”å›ä¸¤ä¸ªå˜é‡ï¼šä¸€ä¸ªå€¼å’Œä¸€ä¸ªé”™è¯¯ä»£ç ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™ä¸ºnilï¼›å¦‚æœé”™è¯¯æ¡ä»¶ï¼Œåˆ™ä¸º== nilã€‚</li><li>åœ¨å‡½æ•°è°ƒç”¨ä¹‹åæ£€æŸ¥é”™è¯¯ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼ˆ if error != nilï¼‰ï¼Œåˆ™åœæ­¢æ‰§è¡Œå®é™…åŠŸèƒ½ï¼ˆæˆ–å¿…è¦æ—¶æ•´ä¸ªç¨‹åºï¼‰ã€‚</li></ul><h2 id="ä¾‹å­">ä¾‹å­</h2><pre><code class="language-go">package mainimport (    &quot;fmt&quot;    &quot;errors&quot;    &quot;math&quot;)func Sqrt(i float64) (float64, error) &#123;    if i&lt;0 &#123;        return 0,errors.New(&quot;é”™è¯¯ï¼šè´Ÿæ•°çš„å¹³æ–¹æ ¹&quot;)    &#125;    return math.Sqrt(i), nil&#125;func main()&#123;    var i float64    i=-64    q, err := Sqrt(i)    if err != nil &#123;        fmt.Println(err)    &#125;    fmt.Println(q)&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜009æ¥å£</title>
      <link href="posts/77a46e91/"/>
      <url>posts/77a46e91/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æ¥å£å’Œç»“æ„ä½“ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼Œè‹¥å¤šä¸ªæ•°æ®ç±»å‹éƒ½æ‹¥æœ‰ç›¸åŒçš„æ–¹æ³•ï¼Œä¸ºäº†æ–¹ä¾¿çš„è°ƒç”¨è¿™äº›æ•°æ®ç±»å‹çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†è¿™äº›æ–¹æ³•å®šä¹‰ä¸ºä¸€ä¸ªæ¥å£ã€‚æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯è¯´å®šä¹‰ï¼Œå¹¶ä¸æ˜¯å®ç°ã€‚</p><p>åè¿‡æ¥è¯´ï¼Œå½“ä¸€ä¸ªæ•°æ®ç±»å‹å®ç°äº†æ¥å£é‡Œçš„æ‰€æœ‰æ–¹æ³•å®šä¹‰ï¼Œå°±æ„å‘³ç€è¿™ä¸ªæ•°æ®ç±»å‹å®ç°äº†æ¥å£ã€‚</p><p>æ¥å£ç±»å‹å˜é‡ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚</p><h2 id="ä»€ä¹ˆæ—¶å€™ç”¨">ä»€ä¹ˆæ—¶å€™ç”¨</h2><p>ä½ å†™äº†ä¸€ä¸ªç¨‹åºï¼Œå®ƒé€šè¿‡ type-c æ¥å£æ¥æ”¶æ•°æ®å¹¶åˆ¤æ–­ type-c æ¥å£çš„åŠŸèƒ½ã€‚</p><p>ä½†æ˜¯æ‹¥æœ‰ type-c æ¥å£çš„è®¾å¤‡ç§ç±»å¾ˆå¤šï¼Œæ¯ä¸€ä¸ªè®¾å¤‡éƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå› ä½ çš„ç¨‹åºæ˜¯é€šç”¨çš„ï¼Œå®ƒå°±åªæ¥æ”¶ä¸€ä¸ª type-c æ¥å£ç±»å‹ï¼Œä¸èƒ½æ¥æ”¶è®¾å¤‡ç±»å‹ã€‚</p><p>å› æ­¤ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨æ¥å£è¿™ä¸ªç±»å‹ä½œä¸ºå”¯ä¸€å‚æ•°äº†ã€‚</p><h2 id="ç”¨æ³•">ç”¨æ³•</h2><h3 id="å¦‚ä½•å®šä¹‰æ¥å£ï¼Ÿ">å¦‚ä½•å®šä¹‰æ¥å£ï¼Ÿ</h3><p>å®šä¹‰æ¥å£ï¼Œæ¥å£åŒ…å«æ–¹æ³•åã€‚å°±å¦‚åŒå®ƒæ˜¯ä¸€ä¸ª type-c æ¥å£</p><blockquote><p>æ–¹æ³•åå¿…é¡»å”¯ä¸€ï¼Œä¸”ä¸èƒ½ä¸ºç©ºã€‚</p></blockquote><pre><code class="language-go">type &lt;inter_name&gt; interface &#123;    &lt;method_name1&gt; [return_type]    &lt;method_name2&gt; [return_type]    ...&#125;</code></pre><h3 id="å¦‚ä½•æ»¡è¶³æ¥å£ï¼Ÿ">å¦‚ä½•æ»¡è¶³æ¥å£ï¼Ÿ</h3><p>å®šä¹‰ç»“æ„ä½“ã€‚å°±å¦‚åŒå®ƒæ˜¯ä¸€ä¸ªè®¾å¤‡</p><pre><code class="language-go">type &lt;struct_name&gt; struct &#123;    var var_name1 var_type&#125;</code></pre><p>å®šä¹‰æ¥å£æ–¹æ³•ï¼Œå› ä¸ºç»“æ„ä½“<code>éœ€è¦</code>å®ç°æ–¹æ³•ï¼Œæ‰€ä»¥æ–¹æ³•<code>æ¥æ”¶è€…</code>æ˜¯ç»“æ„ä½“</p><pre><code class="language-go">// å®ç°æ–¹æ³•1ï¼Œä¾‹å¦‚å……ç”µfunc (self &lt;struct_name&gt;) &lt;method_name1&gt;() [return_type]&#123;    ...&#125;// å®ç°æ–¹æ³•2ï¼Œä¾‹å¦‚æ•°æ®ä¼ è¾“func (self &lt;struct_name&gt;) &lt;method_name2&gt;() [return_type]&#123;    ...&#125;</code></pre><blockquote><p>æ¥å£å¯ä»¥åµŒå¥—</p></blockquote><h3 id="ä¾‹å­">ä¾‹å­</h3><pre><code class="language-go">package mainimport &quot;fmt&quot;// typec æ¥å£type typeC interface &#123;    chongdian()    hdmi()&#125;// æ¥å£ä½“ï¼Œè®¾å¤‡type diannao struct &#123;    PinPai string    TypeC int&#125;func (self diannao) chongdian() &#123;    if self.TypeC == 1 &#123;        fmt.Printf(&quot;%sç”µè„‘å¯ä»¥å……ç”µ\n&quot;, self.PinPai)    &#125;&#125;func (self diannao) hdmi() &#123;    if self.TypeC == 2&#123;        fmt.Printf(&quot;%sç”µè„‘æ—¢å¯ä»¥å……ç”µï¼Œä¹Ÿå¯ä»¥HDMI\n&quot;, self.PinPai)    &#125;&#125;type shouji struct &#123;    PinPai string    TypeC int&#125;func (self shouji) chongdian() &#123;    if self.TypeC == 1 &#123;        fmt.Printf(&quot;%sæ‰‹æœºå¯ä»¥å……ç”µ\n&quot;, self.PinPai)    &#125;&#125;func (self shouji) hdmi() &#123;    if self.TypeC == 2&#123;        fmt.Printf(&quot;%sæ‰‹æœºæ—¢å¯ä»¥å……ç”µï¼Œä¹Ÿå¯ä»¥HDMI\n&quot;, self.PinPai)    &#125;&#125;func TypeCInfo(j typeC)&#123;    j.chongdian()    j.hdmi()&#125;func main()&#123;    d1 := diannao&#123;&quot;sanxing&quot;, 2&#125;    s1 := shouji&#123;&quot;huawei&quot;, 1&#125;    TypeCInfo(d1)    TypeCInfo(s1)&#125;</code></pre><p>è¾“å‡ºï¼š</p><pre><code>sanxingç”µè„‘æ—¢å¯ä»¥å……ç”µï¼Œä¹Ÿå¯ä»¥HDMIhuaweiæ‰‹æœºå¯ä»¥å……ç”µ</code></pre><h2 id="ç”¨æ³•æ€»ç»“">ç”¨æ³•æ€»ç»“</h2><p>å½“æŸä¸ªå‡½æ•°Açš„å½¢å‚argsAæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹çš„æ—¶å€™ï¼Œ</p><p>æƒ…å†µä¸€ï¼šå¦‚æœæ»¡è¶³æ¥å£çš„æ•°æ®ç±»å‹Bï¼Œåœ¨å®ç°æ–¹æ³•çš„æ—¶å€™ï¼Œæ–¹æ³•æ¥æ”¶è€…ï¼ˆæ•°æ®ç±»å‹æœ¬èº«ï¼‰æ˜¯<code>å€¼</code>ï¼Œåˆ™å¯ä»¥ç›´æ¥å°†Bçš„å˜é‡ä¼ é€’ç»™Aï¼Œä¹Ÿå¯ä»¥å°†<code>&amp;B</code>ä¼ é€’ç»™Aï¼Œä¹Ÿå¯ä»¥å°†æ¥å£å˜é‡ï¼ˆå·²æŒ‡å‘&amp;Bï¼‰ä¼ é€’ç»™Aï¼›åˆå› ä¸ºæ˜¯<code>å€¼ä¼ é€’</code>ï¼Œæ‰€ä»¥æ–¹æ³•å†…é’ˆå¯¹æ¥æ”¶è€…çš„ä¿®æ”¹ï¼Œå¹¶ä¸å½±å“æ–¹æ³•å¤–çš„æ¥æ”¶è€…æœ¬èº«ã€‚</p><p>æƒ…å†µäºŒï¼šå¦‚æœæ»¡è¶³æ¥å£çš„æ•°æ®ç±»å‹Bï¼Œåœ¨å®ç°æ–¹æ³•çš„æ—¶å€™ï¼Œæ–¹æ³•æ¥æ”¶è€…ï¼ˆæ•°æ®ç±»å‹æœ¬èº«ï¼‰æ˜¯<code>æŒ‡é’ˆ</code>ï¼Œåˆ™åªèƒ½å°†<code>&amp;B</code>ä¼ é€’ç»™Aï¼Œæˆ–è€…å°†æ¥å£å˜é‡ï¼ˆå·²æŒ‡å‘&amp;Bï¼‰ä¼ é€’ç»™Aï¼›åˆå› ä¸ºæ˜¯<code>æŒ‡é’ˆä¼ é€’</code>ï¼Œæ‰€ä»¥æ–¹æ³•å†…é’ˆå¯¹æ¥æ”¶è€…çš„ä¿®æ”¹ï¼Œä¼šå½±å“åˆ°æ–¹æ³•å¤–çš„æ¥æ”¶è€…æœ¬èº«ã€‚</p><p>æœ€åï¼Œå…³äºæƒ…å†µä¸€ï¼Œå…¶å®goæ˜¯å¼ºç±»å‹ï¼Œåªä¸è¿‡æŒ‡é’ˆå¯ä»¥ä¼ å…¥çš„åŸå› æ˜¯goè§£æå™¨åº•å±‚å¸®ä½ ä¿®æ­£äº†ä»£ç ã€‚</p><p>ä¾‹å¦‚ï¼Œsort.Sort(data Interface) ï¼Œå®ƒæ¥æ”¶<code>sort.Interface</code>ç±»å‹ï¼Œå› æ­¤åªè¦ç¡®ä¿æ’åºçš„æ•°æ®å¯¹è±¡å®ç°äº†<code>sort.Interface</code>å®šä¹‰çš„<code>Len(),Less(),Swap()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥ä¼ å…¥ä½ éœ€è¦æ’åºçš„æ•°æ®å¯¹è±¡å³å¯ã€‚</p><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆTypeCInfo(j typeC) æ˜æ˜æ¥æ”¶ä¸€ä¸ªinterfaceï¼Œå´å¯ä»¥æ¥æ”¶ä¸€ä¸ªæ»¡è¶³interfaceçš„æ•°æ®ç±»å‹ã€‚</p><p>å› ä¸ºgolangåœ¨åº•å±‚å¸®ä½ æ”¹äº†ï¼Œå®é™…çš„ä»£ç æ˜¯ï¼š</p><pre><code class="language-golang">    var myd1 typeC    d1 := diannao&#123;&quot;sanxing&quot;, 2&#125;    s1 := shouji&#123;&quot;huawei&quot;, 1&#125;    myd1 = &amp;d1    TypeCInfo(myd1)    myd1 = &amp;s1    TypeCInfo(myd1)</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜008ç»“æ„ä½“</title>
      <link href="posts/a705a91a/"/>
      <url>posts/a705a91a/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ç»“æ„ä½“æ˜¯å¤šç§ç±»å‹çš„é›†åˆï¼Œå®ƒæœ¬èº«å°±æ˜¯ç±»å‹çš„ä¸€ç§ï¼Œå› æ­¤éœ€è¦ç”¨<code>type</code>å…³é”®å­—æ¥å£°æ˜</p><p>é‰´äºä¸Šè¿°çš„æ€§è´¨ï¼Œå¸¸ç”¨æ¥æè¿°ä¸€ä¸ªå…·æœ‰å¤šç§å±æ€§çš„ç±»ã€‚</p><p>ä¾‹å¦‚ï¼Œäººç±»ï¼Œä¹¦æœ¬ç­‰ã€‚</p><h2 id="å†™æ³•å’Œä½¿ç”¨">å†™æ³•å’Œä½¿ç”¨</h2><p>å½“å®šä¹‰å¥½ä¸€ä¸ªstructåï¼Œå°±å¯ä»¥é€šè¿‡varå£°æ˜structç±»å‹äº†</p><pre><code class="language-go">package mainimport &quot;fmt&quot;type Person struct &#123;    name string    age int&#125;type Book struct &#123;    title string    author string&#125;func readBook(b *Book) &#123;    fmt.Printf(&quot;ä»–ä»¬è¯»å–çš„ä¹¦ç±ï¼š%s\n&quot;, (*b).title)&#125;func main()&#123;    p1 := Person&#123;&quot;zhangsan&quot;, 20&#125;    p2 := Person&#123;name:&quot;lisi&quot;, age:10&#125;    b := Book&#123;title:&quot;é­”å…½ä¸–ç•Œ&quot;, author:&quot;wangwu&quot;&#125;    fmt.Println(p1.name, p2.name)    readBook(&amp;b)&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜007å‡½æ•°-æ–¹æ³•</title>
      <link href="posts/f8eb4b1b/"/>
      <url>posts/f8eb4b1b/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¸€ä¸ªå‡½æ•°æ˜¯æ²¡æœ‰æ‰€æœ‰è€…çš„ã€‚</p><p>ä½†å½“ä¸€ä¸ªå‡½æ•°æœ‰äº†æ‰€å±å¯¹è±¡åï¼Œåˆ™ç§°ä¹‹ä¸º<code>æ–¹æ³•</code></p><p>åœ¨pythonä¸­ï¼Œä¸€ä¸ªç±»ï¼ˆæ¥æ”¶è€…ï¼‰å®šä¹‰æ–¹æ³•ï¼Œç›´æ¥åœ¨ç±»é‡Œå†™æ–¹æ³•å³å¯ï¼Œåªä¸è¿‡æœ‰ä¸€ä¸ª<code>self</code>æŒ‡å‘äº†å®ƒæœ¬èº«ã€‚</p><p>åœ¨goä¸­ï¼Œæ²¡æœ‰è¿™ä¸ª<code>self</code>ï¼Œå› æ­¤å®šä¹‰æ–¹æ³•éœ€è¦æŒ‡å‡º<code>æ‰€å±è€…</code>æ˜¯è°ã€‚</p><h2 id="å®šä¹‰">å®šä¹‰</h2><pre><code class="language-go">func (&lt;æ‰€å±è€…&gt; &lt;æ‰€å±è€…ç±»å‹&gt;) å‡½æ•°å() å‡½æ•°è¿”å›ç±»å‹&#123;    ...&#125;</code></pre><p>ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œæ–¹æ³•å’Œå‡½æ•°å®šä¹‰çš„åŒºåˆ«ï¼Œå°±æ˜¯<code>å‡½æ•°å</code>å‰é¢æ·»åŠ äº†ä¸€ä¸ª<code>(æ‰€å±è€… æ‰€å±è€…ç±»å‹)</code></p><h2 id="ä¾‹å­">ä¾‹å­</h2><pre><code class="language-go">package mainimport &quot;fmt&quot;// å®šä¹‰æ‰€å±è€…äººç±»type person struct &#123;    name string&#125;// å®šä¹‰äººç±»çš„æ–¹æ³• change func (self person) change()&#123;    self.name = &quot;å‡¡å°”èµ›.&quot;+self.name    fmt.Printf(&quot;ä½ çš„æ–°åå­—å¯èƒ½å˜æˆäº†ï¼š%s\n&quot;, self.name)&#125;// ä¸»å‡½æ•°func main()&#123;    // å£°æ˜äººç±»å˜é‡ p    p := person&#123;name:&quot;å¼ ä¸‰&quot;&#125;    // è°ƒç”¨ change æ–¹æ³•    p.change()    fmt.Printf(&quot;ä½ çš„æ–°åå­—å˜æ›´å¤±è´¥ï¼Œå®ƒä¾ç„¶æ˜¯ï¼š%s\n&quot;, p.name)&#125;</code></pre><p>ä¸Šé¢çš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ªç°è±¡ï¼Œå°±æ˜¯<code>change()</code>å¹¶ä¸èƒ½å˜æ›´<code>person.name</code></p><p>å› ä¸ºæ–¹æ³•çš„æ‰€å±è€…æ˜¯<code>å€¼</code>ç±»å‹ï¼Œæ‰€ä»¥<code>p.change()</code>å…¶å®æ˜¯å°†på¤åˆ¶äº†ä¸€ä»½ä¼ é€’ç»™äº†æ–¹æ³•çš„<code>self</code>å˜é‡ã€‚é‚£ä¹ˆpå’Œselfçš„<code>å†…å­˜åœ°å€</code>ä¸ä¸€æ ·ï¼Œä¿®æ”¹<code>self.name</code>å½“ç„¶å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚</p><p>é‚£ä¹ˆå°†æ–¹æ³•çš„æ¥æ”¶è€…å˜æ›´ä¸ºæŒ‡é’ˆï¼Œå°±æ²¡å¾—é—®é¢˜äº†ã€‚</p><pre><code class="language-go">func (self *person) change()&#123;    self.name = &quot;å‡¡å°”èµ›.&quot;+self.name    fmt.Printf(&quot;ä½ çš„æ–°åå­—å˜æˆäº†ï¼š%s\n&quot;, self.name)&#125;func main()&#123;    p := person&#123;name:&quot;å¼ ä¸‰&quot;&#125;    (&amp;p).change()    fmt.Printf(&quot;ä½ çš„æ–°åå­—å˜æ›´æˆåŠŸï¼Œå®ƒæ˜¯ï¼š%s\n&quot;, p.name)&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜006å‡½æ•°-é—­åŒ…</title>
      <link href="posts/318675c1/"/>
      <url>posts/318675c1/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æ„å»ºé—­åŒ…åŸåˆ™ï¼š</p><ol><li>å‡½æ•°Aä¸­è¿˜æœ‰ä¸€ä¸ªå‡½æ•°Bï¼Œå¹¶ä¸”å‡½æ•°Aè¿”å›äº†å‡½æ•°B</li><li>å‡½æ•°Bè°ƒç”¨äº†å‡½æ•°Açš„å½¢å‚</li><li>mainå‡½æ•°é‡Œè°ƒç”¨å‡½æ•°A</li></ol><h2 id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</h2><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‡½æ•°è¢«è°ƒç”¨æ‰§è¡Œå®Œæ¯•åï¼Œå‡½æ•°çš„å½¢å‚å°†è¢«é‡Šæ”¾å›æ”¶ã€‚</p><p>ä½†å½“å‡½æ•°æ˜¯ä¸€ä¸ªé—­åŒ…åï¼Œè¿™é‡Œå‡è®¾æ˜¯å‡½æ•°Aã€‚</p><p>æ­¤æ—¶<code>C=å‡½æ•°A</code>, è€Œå‡½æ•°Aè¿”è¿˜å‡½æ•°Bï¼Œå› æ­¤<code>C=å‡½æ•°B</code>ï¼Œå‡½æ•°Aå·²è¢«è°ƒç”¨å®Œæ¯•ï¼ŒæŒ‰ç†è¯´å‡½æ•°Açš„å½¢å‚Aåº”è¯¥è¢«å›æ”¶ã€‚</p><p>å› ä¸º<code>Cè¿˜å­˜åœ¨</code>ï¼Œæ•…è€Œå‡½æ•°Bä¸­è°ƒç”¨çš„å‡½æ•°Açš„å½¢å‚Aæ— æ³•è¢«å›æ”¶ï¼Œå› æ­¤ï¼Œå½¢å‚Aå°±å¯ä»¥ä¸€ç›´å­˜æ´»ä¸‹æ¥ã€‚</p><p>é‚£ä¹ˆï¼Œæ¯å½“ä½ æ‰§è¡Œä¸€æ¬¡Cï¼Œå‡½æ•°Bå°±æ‰§è¡Œä¸€æ¬¡ï¼Œå½¢å‚Aå› ä¸ºæ— æ³•è¢«å›æ”¶ï¼Œä¹Ÿä¼šä¸€ç›´ä¿æŒæœ€æ–°çš„æ•°æ®ã€‚</p><h2 id="ä¸¾ä¾‹">ä¸¾ä¾‹</h2><pre><code class="language-go">package mainimport &quot;fmt&quot;// è¿”å›func(y int) int å‡½æ•°func fca(x int) func(y int) int&#123;    return func(y int) int &#123;        x+=y        return x    &#125;&#125;func fcb(startNum,step,time int) &#123;    fmt.Printf(&quot;åˆå§‹æ•°(startNum)ï¼š%d, æ­¥é•¿(step)%d, è¿ˆæ­¥æ¬¡æ•°(time)ï¼š%d\n&quot;,startNum, step, time)    nextNum := fca(startNum)    fmt.Printf(&quot;nextNumè¢«èµ‹å€¼ï¼Œå³nextNumç­‰å‡½æ•°func(y int) int&#123;&#125;, æ­¤æ—¶funcä¸­å¼•ç”¨äº†å½¢å‚x:1\n&quot;)    for i:=1;i&lt;=time;i++ &#123;        fmt.Printf(&quot;æ‰§è¡ŒnextNum(step) &#123;x+=y&#125;, è¿”å›x:%d\n&quot;,nextNum(step))        if i == 3 &#123;            fmt.Printf(&quot;é‡æ–°èµ‹å€¼nextNumï¼Œå¯¼è‡´nextNumé‡Šæ”¾ï¼Œè¿›è€Œé‡Šæ”¾å˜é‡xï¼Œxé‡æ–°è¢«èµ‹å€¼ä¸ºstartNumã€‚\n&quot;)            nextNum = fca(startNum)        &#125;    &#125;&#125;func main()&#123;    fcb(1,2,5)&#125;===åˆå§‹æ•°(startNum)ï¼š1, æ­¥é•¿(step)2, è¿ˆæ­¥æ¬¡æ•°(time)ï¼š5nextNumè¢«èµ‹å€¼ï¼Œå³nextNumç­‰å‡½æ•°func(y int) int&#123;&#125;, æ­¤æ—¶funcä¸­å¼•ç”¨äº†å½¢å‚x:1æ‰§è¡ŒnextNum(step) &#123;x+=y&#125;, è¿”å›x:3æ‰§è¡ŒnextNum(step) &#123;x+=y&#125;, è¿”å›x:5æ‰§è¡ŒnextNum(step) &#123;x+=y&#125;, è¿”å›x:7é‡æ–°èµ‹å€¼nextNumï¼Œå¯¼è‡´nextNumé‡Šæ”¾ï¼Œè¿›è€Œé‡Šæ”¾å˜é‡xï¼Œxé‡æ–°è¢«èµ‹å€¼ä¸ºstartNumã€‚æ‰§è¡ŒnextNum(step) &#123;x+=y&#125;, è¿”å›x:3æ‰§è¡ŒnextNum(step) &#123;x+=y&#125;, è¿”å›x:5</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜004æ§åˆ¶æµ</title>
      <link href="posts/8a6b5455/"/>
      <url>posts/8a6b5455/</url>
      
        <content type="html"><![CDATA[<h1>if</h1><pre><code class="language-go">package mainimport &quot;fmt&quot;func givemeanumber() int &#123;    return -1&#125;func main() &#123;    if num := givemeanumber(); num &lt; 0 &#123;        fmt.Println(num, &quot;is negative&quot;)    &#125; else if num &lt; 10 &#123;        fmt.Println(num, &quot;has only one digit&quot;)    &#125; else &#123;        fmt.Println(num, &quot;has multiple digits&quot;)    &#125;&#125;</code></pre><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œnum å˜é‡æ˜¯åœ¨ if ä¸­å£°æ˜çš„ï¼Œå› æ­¤å®ƒçš„ä½œç”¨åŸŸä»…é™äº if ä¸­ã€‚è¿™ç§å†™æ³•åœ¨ go ä¸­å¾ˆå¸¸è§ã€‚</p><h1>switch</h1><p>switch æ—¨åœ¨é¿å…ç»´æŠ¤å«æœ‰å¤šä¸ª if çš„è¯­å¥ã€‚</p><ul><li>æ»¡è¶³å˜é‡</li></ul><p>â˜ case åä¸å¯è·Ÿæ¡ä»¶è¡¨è¾¾å¼ï¼Œåªèƒ½è·Ÿå€¼</p><pre><code class="language-go">switch å˜é‡/å¸¸é‡ &#123;    case å€¼1:        ...    case å€¼2, å€¼3:        ...    default:        ...&#125;</code></pre><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œè‹¥caseåé¢çš„å€¼è‹¥åŒ¹é…å˜é‡ï¼Œå°±æ‰§è¡Œå¯¹åº”ä»£ç ï¼Œå¦åˆ™æ‰§è¡Œdefaultä»£ç ã€‚defaultè¯­å¥ä¸æ˜¯å¿…é¡»çš„ã€‚</p><p>ğŸ¤·â€â™‚ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œswitch å…³é”®è¯åçš„å˜é‡ç±»å‹å’Œcaseåçš„å€¼ç±»å‹è¦ä¿æŒä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œåˆ™ç¼–è¯‘å°†å¤±è´¥ã€‚</p><ul><li>æ»¡è¶³æ¡ä»¶</li></ul><p>â˜ case åè·Ÿæ¡ä»¶è¡¨è¾¾å¼ï¼Œswitch åä¸å¯æœ‰å˜é‡</p><pre><code class="language-go">switch &#123;    case æ¡ä»¶1:        ...    case æ¡ä»¶2:        ...    default:        ...&#125;</code></pre><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œè‹¥æ¡ä»¶ä¸ºçœŸï¼Œå°±æ‰§è¡Œå¯¹åº”ä»£ç ï¼Œå¦åˆ™æ‰§è¡Œdefaultä»£ç </p><ul><li>æ»¡è¶³å‡½æ•°è¿”å›å€¼</li></ul><pre><code class="language-go">package mainimport (    &quot;fmt&quot;    &quot;time&quot;)func main() &#123;    switch time.Now().Weekday().String() &#123;    case &quot;Monday&quot;, &quot;Tuesday&quot;, &quot;Wednesday&quot;, &quot;Thursday&quot;, &quot;Friday&quot;:        fmt.Println(&quot;It's time to learn some Go.&quot;)    default:        fmt.Println(&quot;It's weekend, time to rest!&quot;)    &#125;    fmt.Println(time.Now().Weekday().String())&#125;</code></pre><h2 id="switchï¼šfallthrough">switchï¼šfallthrough</h2><p><code>fallthrough</code>å…³é”®è¯</p><p>å½“æŸä¸ªcaseä¸Šä¸‹æ–‡ä¸­åŒ…å«<code>fallthrough</code>çš„è¯ï¼Œåˆ™ä¼šç›´æ¥æ‰§è¡Œç´§é‚»çš„ä¸‹ä¸€æ¡<code>case</code>ä¸”ä¸åˆ¤æ–­æ¡ä»¶ã€‚</p><pre><code class="language-go">package mainimport (    &quot;fmt&quot;)func main() &#123;    switch num := 15; &#123;    case num &lt; 50:        fmt.Printf(&quot;%d is less than 50\n&quot;, num)        fallthrough    case num &gt; 100:        fmt.Printf(&quot;%d is greater than 100\n&quot;, num)        fallthrough    case num &lt; 200:        fmt.Printf(&quot;%d is less than 200&quot;, num)    &#125;&#125;</code></pre><pre><code class="language-bash">15 is less than 5015 is greater than 10015 is less than 200</code></pre><h1>for</h1><pre><code class="language-go">func main()&#123;    sum := 0    for i := 0; i &lt; 100; i++ &#123;        sum += 1    &#125;    fmt.Printf(&quot;result: %d\n&quot;, sum)&#125;</code></pre><p>go æ²¡æœ‰ while å…³é”®è¯ã€‚ä¸è¿‡ï¼Œå¯ä»¥ç”¨ for å»æ¨¡æ‹Ÿã€‚</p><p>for åå¯ä»¥ç›´æ¥è·Ÿæ¡ä»¶è¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼ä¸º true çš„æ—¶å€™ï¼Œå¾ªç¯å°±ä¸ä¼šç»“æŸï¼›</p><pre><code class="language-go">package mainimport (    &quot;fmt&quot;    &quot;math/rand&quot;    &quot;time&quot;)func main() &#123;    var num int64    rand.Seed(time.Now().Unix())    for num != 5 &#123;        num = rand.Int63n(15)        fmt.Println(num)    &#125;&#125;</code></pre><p>è‹¥ for åé¢æ²¡æœ‰ä»»ä½•è¡¨è¾¾å¼ï¼Œåˆ™å¾ªç¯æ°¸è¿œä¸ä¼šç»“æŸï¼Œé™¤éå¾ªç¯ä½“ä¸­åŒ…å« breakã€‚</p><p>å¦å¤–ï¼Œå¾ªç¯ä½“ä¸­é‡åˆ° continue å°†ç»ˆæ­¢å½“å‰è¿­ä»£ï¼Œç›´æ¥è¿›å…¥ä¸‹æ¬¡å¾ªç¯ã€‚</p><h1>select</h1><p>selectè¯­å¥ä¸switchç±»ä¼¼ï¼Œä½†å®ƒä»…ç”¨æ¥ç›‘å¬å’Œchannelæœ‰å…³çš„IOæ“ä½œï¼Œå½“ IO æ“ä½œå‘ç”Ÿæ—¶ï¼Œè§¦å‘ç›¸åº”çš„åŠ¨ä½œã€‚</p><p>é‚£ä¹ˆæ—¢ç„¶caseæ¡ä»¶ä¸channelæœ‰å…³ï¼Œåˆ™caseæ¡ä»¶å¿…ç„¶ä¼´éšç€å†™å…¥å’Œè¯»å–chanç±»å‹å˜é‡</p><p>å­å¥æ‰§è¡Œè§„åˆ™ï¼š</p><p>selectåˆ¤æ–­æ‰€æœ‰caseæ¡ä»¶æ˜¯å¦ä¸chanæœ‰å…³ï¼š</p><p>ä¸chanæœ‰å…³ï¼š</p><p>â€‹åˆ¤æ–­caseæ¡ä»¶æ˜¯å¦å¯å®Œæˆchançš„I/Oæ“ä½œï¼š</p><p>â€‹å¯å®Œæˆï¼š</p><p>â€‹<code>éšæœº</code>æ‰§è¡Œä¸€ä¸ªå®Œæˆcaseæ¡ä»¶çš„è¯­å¥</p><p>â€‹ä¸å¯å®Œæˆï¼š</p><p>â€‹æœ‰defaultå­å¥ï¼šæ‰§è¡Œdefaultå­å¥</p><p>â€‹æ— defaultå­å¥ï¼šé˜»å¡ï¼Œç›´åˆ°å‡ºç°ä¸€ä¸ªå¯å®Œæˆçš„caseæ¡ä»¶</p><p>ä¸chanæ— å…³ï¼š</p><p>â€‹ç›´æ¥æŠ¥é”™</p><pre><code class="language-go">package mainimport (    &quot;fmt&quot;)func main() &#123;    ch1 := make(chan int,1)    for i := 0; i &lt; 10; i++&#123;        select &#123;        case x := &lt;- ch1:            fmt.Printf(&quot;ch1å–å‡ºæ•°æ®%d\n&quot;,x)        case ch1 &lt;- i:            fmt.Printf(&quot;ch1æ’å…¥æ•°æ®%d\n&quot;,i)        &#125;    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜005å‡½æ•°</title>
      <link href="posts/98f86e16/"/>
      <url>posts/98f86e16/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™éœ€æä¾›å‚æ•°ç±»å‹</p><p>å¦‚æœæœ‰è¿”å›å€¼ï¼Œåˆ™éœ€æä¾›è¿”å›å€¼ç±»å‹</p><h2 id="ç»“æ„">ç»“æ„</h2><pre><code class="language-go">func &lt;func_name&gt; (&lt;args&gt; args_type) &lt;rtn_value_type&gt; &#123;    ...    return rtn_value&#125;</code></pre><h2 id="å‡½æ•°å‚æ•°">å‡½æ•°å‚æ•°</h2><p>å‡½æ•°å‚æ•°æ˜¯å½¢å‚ï¼Œè°ƒç”¨å‡½æ•°å¹¶ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°æ˜¯å®å‚ï¼Œå½¢å‚å’Œå®å‚ç±»å‹è¦<code>ä¸€è‡´</code></p><p>å‡½æ•°å‚æ•°ï¼ˆå½¢å‚ï¼‰ä»…åœ¨å‡½æ•°ä½“å†…ç”Ÿæ•ˆ</p><p>åœ¨å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå‡½æ•°å‚æ•°ï¼ˆå½¢å‚ï¼‰ä¸ä¼šåˆ†é…å†…å­˜å•å…ƒ</p><p>å½“å‡½æ•°å‚æ•°ï¼ˆå½¢å‚ï¼‰æ¥æ”¶äº†ä¸€ä¸ªå®å‚<code>å†…å­˜å€¼</code>çš„æ—¶å€™ï¼Œå‡½æ•°ä½“å†…çš„<code>å‡½æ•°å‚æ•°</code>å°†å’Œ<code>å®å‚</code>æ²¡æœ‰ä»»ä½•å…³è”</p><p>å½“å‡½æ•°å‚æ•°ï¼ˆå½¢å‚ï¼‰æ¥æ”¶äº†ä¸€ä¸ªå®å‚<code>å†…å­˜åœ°å€</code>çš„æ—¶å€™ï¼Œå‡½æ•°ä½“å†…çš„<code>&amp;å‡½æ•°å‚æ•°</code>å°†å—åˆ°<code>å®å‚</code>å½±å“</p><h3 id="å‚æ•°ä¸ªæ•°">å‚æ•°ä¸ªæ•°</h3><p>å‚æ•°å¯ä»¥æœ‰å¤šä¸ªï¼Œåªéœ€è¦åœ¨å½¢å‚ç±»å‹å‰æ·»åŠ <code>...</code></p><pre><code class="language-go">package mainimport &quot;fmt&quot;func main()&#123;    print(1,2,3,4,5)&#125;func print (a ...int) &#123;    for _,v := range a&#123;        fmt.Println(v)    &#125;&#125;</code></pre><blockquote><p><code>_</code> è¡¨ç¤ºæ¥æ”¶æ— ç”¨çš„å€¼</p></blockquote><h2 id="ç”¨ä¾‹">ç”¨ä¾‹</h2><pre><code class="language-go">package mainimport &quot;fmt&quot;func fcLen(yp *string) int &#123;    fmt.Printf(&quot;ä¼ é€’çš„å½¢å‚æ˜¯ï¼š%p,%s&quot;,yp, *yp) // %pæ ‡è¯†æŒ‡é’ˆå˜é‡    return len(*yp)&#125;func main()&#123;    a := &quot;abc&quot;    b := fcLen(&amp;a)    fmt.Println(b)                                            &#125;</code></pre><h2 id="é€’å½’å‡½æ•°">é€’å½’å‡½æ•°</h2><p>é€’å½’å‡½æ•°åœ¨åµŒå¥—çš„æ—¶å€™ï¼Œéœ€è¦ä¸€ä¸ªé€€å‡ºæ¡ä»¶ï¼Œä»è€Œé˜²æ­¢æ­»å¾ªç¯</p><p>ä¾‹å¦‚</p><pre><code class="language-go">func jiecheng(i int)int &#123;    if i &gt; 1 &#123;        result = i * jiecheng(i-1)        return result    &#125;    return 1&#125;</code></pre><h2 id="ç‰¹æ®Šå‡½æ•°">ç‰¹æ®Šå‡½æ•°</h2><p>make()ç”¨äºchanã€mapä»¥åŠåˆ‡ç‰‡åˆ›å»º</p><p>new(<type>)ç”¨äºåˆ›å»ºä¸€ä¸ªæŒ‡å‘typeå†…å­˜åœ°å€çš„æŒ‡é’ˆ</type></p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜002å¸¸é‡</title>
      <link href="posts/8c3e952e/"/>
      <url>posts/8c3e952e/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å¸¸é‡åªæœ‰ä¸€ä¸ªå…ƒæ•°æ®ï¼Œå°±æ˜¯å†…å­˜åœ°å€å­˜å‚¨çš„æ•°æ®ã€‚å®ƒæ˜¯ä¸€ä¸ªé™æ€å€¼ã€‚</p><p>å¸¸é‡å£°æ˜çš„åŒæ—¶å¿…é¡»èµ‹å€¼ã€‚</p><p>å¸¸é‡ä¸å¯ç”¨<code>:=</code>å£°æ˜å¹¶èµ‹å€¼ã€‚</p><p>åœ¨ Go ä¸­ï¼Œå¸¸é‡åç§°é€šå¸¸ä»¥æ··åˆå¤§å°å†™å­—æ¯æˆ–å…¨éƒ¨å¤§å†™å­—æ¯ä¹¦å†™ã€‚</p><p>å¸¸é‡å®šä¹‰åå¯ä»¥ä¸ç”¨ã€‚</p><h2 id="å£°æ˜å’Œèµ‹å€¼">å£°æ˜å’Œèµ‹å€¼</h2><p>å¸¸é‡å…³é”®è¯æ˜¯constã€‚</p><blockquote><p>ä¸èƒ½çœç•¥ const å…³é”®è¯ï¼Œçœç•¥äº†å°±æ²¡æ³•åˆ¤æ–­æ˜¯å¸¸é‡è¿˜æ˜¯å˜é‡äº†</p></blockquote><h3 id="å•ç±»å‹">å•ç±»å‹</h3><pre><code class="language-go">const &lt;å¸¸é‡1&gt;,&lt;å¸¸é‡2&gt; &lt;å¸¸é‡ç±»å‹&gt; = &lt;å¸¸é‡1çš„å€¼&gt;, &lt;å¸¸é‡2çš„å€¼&gt;</code></pre><h3 id="å¤šç±»å‹">å¤šç±»å‹</h3><p>æ ¹æ®å˜é‡å€¼ï¼Œè‡ªåŠ¨åˆ¤æ–­å˜é‡ç±»å‹</p><pre><code class="language-go">const &lt;å¸¸é‡1&gt;, &lt;å¸¸é‡2&gt; = &lt;å¸¸é‡1çš„å€¼&gt;, &lt;å¸¸é‡2çš„å€¼&gt;</code></pre><h3 id="å•ç±»å‹å’Œå¤šç±»å‹æ··åˆ">å•ç±»å‹å’Œå¤šç±»å‹æ··åˆ</h3><pre><code class="language-go">const (    &lt;å¸¸é‡1&gt;,&lt;å¸¸é‡11&gt; &lt;ç±»å‹1&gt; = &lt;å¸¸é‡1çš„å€¼&gt;, &lt;å¸¸é‡11çš„å€¼&gt;    &lt;å¸¸é‡2&gt; &lt;ç±»å‹2&gt; = &lt;å¸¸é‡2çš„å€¼&gt;)</code></pre><p>ä¸Šè¿°å†™æ³•ä¸­ï¼Œå¦‚æœå¸¸é‡2å’Œå¸¸é‡1ä¸€æ ·ï¼Œåˆ™å¯ä»¥ç›´æ¥å†™å¸¸é‡2åï¼Œç±»å‹2å’Œå¸¸é‡2çš„å€¼å¯ä»¥çœç•¥ã€‚</p><pre><code class="language-go">const (    &lt;å¸¸é‡1&gt;,&lt;å¸¸é‡11&gt; &lt;ç±»å‹1&gt; = &lt;å¸¸é‡1çš„å€¼&gt;, &lt;å¸¸é‡11çš„å€¼&gt;    &lt;å¸¸é‡2&gt;,&lt;å¸¸é‡22&gt;)</code></pre><p>åœ¨è¿™ç§çœç•¥å†™æ³•ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰ä¸¤åˆ—éœ€è¦å¯¹é½ä¸€è‡´ã€‚</p><h2 id="ç‰¹æ®Šå¸¸é‡iota">ç‰¹æ®Šå¸¸é‡iota</h2><p>æœ‰ä¸€ä¸ªå†…ç½®çš„ç‰¹æ®Šå¸¸é‡iotaï¼Œæ¯å£°æ˜ä¸€ä¸ªå¸¸é‡ï¼Œå®ƒä¼š+1ï¼Œåˆå§‹å€¼æ˜¯0</p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜003è¿ç®—ç¬¦</title>
      <link href="posts/1a034363/"/>
      <url>posts/1a034363/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å¸¸è§çš„è¿ç®—ç¬¦å°±ä¸è¯´äº†ï¼Œå­¦è¿‡æ•°å­¦çš„éƒ½ä¼šã€‚</p><h2 id="é€»è¾‘è¿ç®—ç¬¦">é€»è¾‘è¿ç®—ç¬¦</h2><p><code>A &amp;&amp; B</code> Aå’ŒBéƒ½ä¸ºçœŸï¼Œåˆ™çœŸ</p><p><code>A || B</code> Aå’ŒBä»»æ„ä¸ºçœŸï¼Œåˆ™ä¸ºçœŸ</p><p><code>!A</code> Aä¸ºçœŸï¼Œåˆ™ä¸ºå‡</p><p>å½“ä¸Šè¿°æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œåˆ™æ‰§è¡Œä¸‹ä¸€æ­¥ä»£ç </p><h2 id="ä½è¿ç®—ç¬¦">ä½è¿ç®—ç¬¦</h2><p>å°†æ•´æ•°è½¬ä¸ºäºŒè¿›åˆ¶åè¿›è¡Œè¿ç®—</p><p>äºŒè¿›åˆ¶æ•°ï¼š0ä¸ºå‡ï¼Œ1ä¸ºçœŸ</p><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-go">a,b := 2,4</code></pre><p>è‹¥<code>c := a &amp; b</code>æŒ‰ä½ä¸ï¼ŒæŒ‰ç…§<code>ä½æ•°</code>åˆ†åˆ«è¿›è¡Œ<code>ä¸</code>è¿ç®—</p><pre><code>aï¼š 0 1 0bï¼š 1 0 0cï¼š 0 0 0</code></pre><p>å› æ­¤ï¼Œæœ€ç»ˆ c = 0</p><p>è‹¥<code>c := a | b</code>æŒ‰ä½æˆ–ï¼ŒæŒ‰ç…§<code>ä½æ•°</code>åˆ†åˆ«è¿›è¡Œ<code>æˆ–</code>è¿ç®—</p><pre><code>aï¼š 0 1 0bï¼š 1 0 0cï¼š 1 1 0</code></pre><p>å› æ­¤ï¼Œæœ€ç»ˆ c = 6</p><p>è‹¥<code>c := a ^ b</code>æŒ‰ä½å¼‚æˆ–ï¼ŒæŒ‰ç…§<code>ä½æ•°</code>åˆ†åˆ«è¿›è¡Œ<code>å¼‚æˆ–</code>è¿ç®—</p><p>å¼‚æˆ–ï¼šç›¸åŒä¸º0ï¼Œä¸åŒä¸º1</p><pre><code>aï¼š 0 1 0bï¼š 1 0 0cï¼š 1 1 0</code></pre><p>å› æ­¤ï¼Œæœ€ç»ˆ c = 6</p><p>è‹¥<code>c := a &amp;^ b</code>ï¼Œ</p><p>åˆ™cç­‰äºå°†aä¸­abéƒ½ä¸º1çš„ä½å†™ä¸º0åçš„æ–°a</p><pre><code>aï¼š 0 1 0bï¼š 1 0 0cï¼š 0 1 0  # aä¸­æ²¡æœ‰abéƒ½ä¸º1çš„ä½ï¼Œå› æ­¤cçš„å€¼ä¾ç„¶æ˜¯a</code></pre><p>è‹¥<code>c := a&lt;&lt;b</code>å·¦ç§»è¿ç®—ï¼Œå³<code>a*2çš„bæ¬¡æ–¹</code>ã€‚cç­‰äº32</p><p>è‹¥<code>c := a&gt;&gt;b</code>å³ç§»è¿ç®—ï¼Œå³<code>a/2çš„bæ¬¡æ–¹</code>ï¼Œcç­‰äº0</p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goâ˜001å˜é‡</title>
      <link href="posts/759b68d8/"/>
      <url>posts/759b68d8/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å˜é‡æœ‰ä¸¤ä¸ªå…ƒæ•°æ®ï¼Œä¸€æ˜¯å†…å­˜åœ°å€ï¼Œä¸€æ˜¯å†…å­˜åœ°å€å­˜å‚¨çš„æ•°æ®ã€‚</p><blockquote><p>å†…å­˜åœ°å€ä¹Ÿæ˜¯ä¸€ä¸²æ•°</p></blockquote><h2 id="å£°æ˜ç±»å‹">å£°æ˜ç±»å‹</h2><ul><li>åŸºæœ¬ç±»å‹ï¼šæ•°å­—ã€å­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼</li><li>èšåˆç±»å‹ï¼šæ•°ç»„å’Œç»“æ„</li><li>å¼•ç”¨ç±»å‹ï¼šæŒ‡é’ˆã€åˆ‡ç‰‡ã€æ˜ å°„ã€å‡½æ•°å’Œé€šé“</li><li>æ¥å£ç±»å‹ï¼šæ¥å£</li></ul><p>éƒ¨åˆ†å˜é‡ç±»å‹:</p><p>intï¼Œæ•´å‹ï¼Œé»˜è®¤æ˜¯0</p><p>stringï¼Œå­—ç¬¦ä¸²ï¼Œé»˜è®¤æ˜¯ç©º</p><p>â€‹ğŸ’¥å­—ç¬¦ä¸²çš„è¡¨ç¤ºç”¨åŒå¼•å·å’Œåå¼•å·ï¼Œä¸å¯ç”¨å•å¼•å·ï¼Œå•å¼•å·åœ¨golangé‡Œè¡¨ç¤º<code>rune</code> ï¼Œç±»ä¼¼äºå…¶å®ƒè¯­è¨€çš„å­—èŠ‚ç±»å‹</p><p>â€‹å­—ç¬¦ä¸²ç®—æ˜¯åªè¯»åˆ‡ç‰‡ï¼Œå› æ­¤æ— æ³•ç›´æ¥ä¿®æ”¹ï¼Œè‹¥çœŸä¿®æ”¹ï¼Œå…ˆè½¬æˆbyte</p><p>boolï¼Œå¸ƒå°”ï¼Œé»˜è®¤æ˜¯false</p><p>chanï¼Œç®¡é“ï¼Œé»˜è®¤æ˜¯nil</p><p>[æ•°ç»„å¤§å°]æ•°ç»„å€¼ç±»å‹ æ•°ç»„ï¼Œé»˜è®¤æ˜¯nil</p><p>[]æ•°ç»„å€¼ç±»å‹ åˆ‡ç‰‡ï¼Œé»˜è®¤æ˜¯nil</p><p>map   å­—å…¸ï¼Œé»˜è®¤æ˜¯nil</p><p>byteï¼Œå­—èŠ‚ï¼Œé»˜è®¤æ˜¯0ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•´å‹</p><h2 id="å˜é‡ç±»å‹">å˜é‡ç±»å‹</h2><p>å¦‚æœå˜é‡å†…å­˜åœ°å€é‡Œå­˜å‚¨çš„æ˜¯<code>éå†…å­˜åœ°å€</code>,åˆ™è¿™ç±»å˜é‡ç§°ä¹‹ä¸º<code>å€¼ç±»å‹</code>å˜é‡ï¼Œä¹Ÿå°±æ˜¯<code>æ™®é€š</code>å˜é‡</p><p>å¦‚æœå˜é‡å†…å­˜åœ°å€é‡Œå­˜å‚¨çš„æ˜¯<code>å¦ä¸€ä¸ªå˜é‡çš„å†…å­˜åœ°å€</code>ï¼Œåˆ™è¿™ç±»å˜é‡ç§°ä¹‹ä¸º<code>å¼•ç”¨ç±»å‹</code>å˜é‡ï¼Œä¹Ÿå«<code>æŒ‡é’ˆ</code>å˜é‡</p><p>ğŸ’ å˜é‡çš„å†…å­˜åœ°å€é‡Œä¸èƒ½å­˜å‚¨å˜é‡è‡ªå·±çš„å†…å­˜åœ°å€</p><h3 id="å€¼å˜é‡ï¼šæ™®é€šå˜é‡">å€¼å˜é‡ï¼šæ™®é€šå˜é‡</h3><p>æ–¹æ³•1ï¼š</p><p>ä»…å¯ä»¥å®šä¹‰ä¸€ç§å˜é‡ç±»å‹</p><pre><code class="language-go">var &lt;å˜é‡1&gt;,&lt;å˜é‡2&gt; &lt;å˜é‡ç±»å‹&gt; = &lt;å˜é‡1çš„å€¼&gt;, &lt;å˜é‡2çš„å€¼&gt;</code></pre><blockquote><p>è‹¥å˜é‡çš„å€¼æ²¡æœ‰æä¾›ï¼Œåˆ™ç³»ç»Ÿä¼šæ ¹æ®å˜é‡ç±»å‹è‡ªåŠ¨æä¾›</p><p>ä¾‹å¦‚:</p><p>intç±»å‹ï¼Œé»˜è®¤ä¸º0</p><p>boolç±»å‹ï¼Œé»˜è®¤ä¸ºfalse</p><p>å­—ç¬¦ä¸²ç±»å‹ï¼Œé»˜è®¤ä¸º&quot;&quot;</p><p>å…¶ä½™ç±»å‹ï¼ŒåŸºæœ¬éƒ½æ˜¯nil  (nilå’Œpythonä¸­çš„NULLæ˜¯ä¸€ä¸ªæ„æ€)</p></blockquote><p>æ–¹æ³•2:</p><p>å¯ä»¥åŒæ—¶å®šä¹‰å¤šç§ç±»å‹</p><p>æ ¹æ®å˜é‡å€¼ï¼Œè‡ªåŠ¨åˆ¤æ–­å˜é‡ç±»å‹</p><pre><code class="language-go">var &lt;å˜é‡1&gt;, &lt;å˜é‡2&gt; = &lt;å˜é‡1çš„å€¼&gt;, &lt;å˜é‡2çš„å€¼&gt;</code></pre><p>æ–¹æ³•3:</p><p>å¯ä»¥åŒæ—¶å®šä¹‰å¤šç§ç±»å‹</p><p>æ ¹æ®å˜é‡å€¼ï¼Œè‡ªåŠ¨åˆ¤æ–­å˜é‡ç±»å‹</p><p>çœç•¥ var å£°æ˜å…³é”®è¯</p><p>âš ï¸</p><ol><li>åªèƒ½ç”¨äºå‡½æ•°ä½“å†…ã€‚</li><li>ä»…å¯ä»¥ç”¨äºæ–°å˜é‡ã€‚</li><li>å¤šä¸ªå˜é‡å•è¡ŒåŒæ—¶å£°æ˜å¹¶èµ‹å€¼çš„æ—¶å€™ï¼Œå¦‚æœæŸä¸€ä¸ªå˜é‡æ˜¯ç»“æ„ä½“å­—æ®µï¼Œåˆ™æ‰€æœ‰å˜é‡éƒ½éœ€è¦æå‰å£°æ˜ã€‚</li></ol><pre><code class="language-go">&lt;å˜é‡1&gt;, &lt;å˜é‡2&gt; := &lt;å˜é‡1çš„å€¼&gt;,&lt;å˜é‡2çš„å€¼&gt;</code></pre><p>æ–¹æ³•4ï¼š</p><p>å› å¼åˆ†è§£ï¼Œå¸¸ç”¨æ¥åœ¨å‡½æ•°ä½“å¤–å£°æ˜å…¨å±€å˜é‡</p><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨å‡½æ•°ä½“å†…å®šä¹‰å±€éƒ¨å˜é‡</p><pre><code class="language-go">var (    &lt;å˜é‡1&gt; &lt;ç±»å‹1&gt; = &lt;å˜é‡1çš„å€¼&gt;    &lt;å˜é‡2&gt; &lt;ç±»å‹2&gt; = &lt;å˜é‡2çš„å€¼&gt;)</code></pre><h3 id="å¼•ç”¨å˜é‡ï¼šæŒ‡é’ˆå˜é‡">å¼•ç”¨å˜é‡ï¼šæŒ‡é’ˆå˜é‡</h3><p>å˜é‡çš„å€¼å­˜å‚¨çš„æ˜¯å¦ä¸€ä¸ªå˜é‡çš„<code>å†…å­˜åœ°å€</code>ã€‚å› æ­¤ï¼Œé€šè¿‡æŒ‡é’ˆå˜é‡ä½ å¯ä»¥ä¿®æ”¹å¦ä¸€ä¸ªå˜é‡çš„å€¼ã€‚</p><p>åœ¨ Go ä¸­ï¼Œæœ‰ä¸¤ä¸ªè¿ç®—ç¬¦å¯ç”¨äºå¤„ç†æŒ‡é’ˆï¼š</p><ul><li><code>&amp;</code> è¿ç®—ç¬¦è°ƒç”¨å˜é‡å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚</li><li><code>*</code> è¿ç®—ç¬¦è¡¨ç¤ºå–æ¶ˆå¼•ç”¨æŒ‡é’ˆæˆ–å£°æ˜ä¸€ä¸ªæŒ‡é’ˆã€‚<ul><li><code>*æŒ‡é’ˆå˜é‡</code>å–æ¶ˆå¼•ç”¨æŒ‡é’ˆï¼Œæœ¬è´¨ä¸Šæ˜¯æŒ‡é’ˆå˜é‡å­˜å‚¨çš„å†…å­˜åœ°å€æ‰€å¯¹åº”çš„å˜é‡å¯¹è±¡ã€‚</li><li><code>*å˜é‡ç±»å‹</code>å£°æ˜æŒ‡é’ˆã€‚</li></ul></li></ul><p>ä¾‹å¦‚:</p><pre><code class="language-go">package mainimport &quot;fmt&quot;func main() &#123;    firstName := &quot;John&quot;    updateName(&amp;firstName) // 3. æ™®é€šå˜é‡å‰åŠ &amp;ï¼Œè¡¨ç¤ºè·å–æ™®é€šå˜é‡çš„å†…å­˜åœ°å€    fmt.Println(firstName)&#125;func updateName(name *string) &#123; // 1. å½¢å‚å˜é‡ç±»å‹å‰åŠ *,è¡¨ç¤ºè¿™ä¸ªå½¢å‚æ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡    *name = &quot;David&quot; // 2. æŒ‡é’ˆå˜é‡å‰åŠ *ï¼Œç­‰åŒäºæŒ‡é’ˆå˜é‡æ‰€æŒ‡å‘çš„æ™®é€šå˜é‡&#125;</code></pre><h3 id="å˜é‡ç±»å‹è½¬æ¢">å˜é‡ç±»å‹è½¬æ¢</h3><p>Go ä¸­éšå¼å¼ºåˆ¶è½¬æ¢ä¸èµ·ä½œç”¨ã€‚</p><ol><li>æµ®ç‚¹å’Œæ•´æ•°ä¹‹é—´</li></ol><p><code>type_name(expression)</code></p><ol start="2"><li>å­—ç¬¦ä¸²å’Œæ•°å­—ä¹‹é—´</li></ol><blockquote><p>import â€œstrconvâ€</p></blockquote><p><code>strconv.Atoi(expression)</code>  å­—ç¬¦ä¸²åˆ°æ•°å­—</p><pre><code class="language-go">package mainimport (    &quot;fmt&quot;    &quot;strconv&quot;)func main() &#123;    i, _ := strconv.Atoi(&quot;-42&quot;)    s := strconv.Itoa(-42)    fmt.Println(i, s)&#125;</code></pre><h2 id="æ™®é€šå˜é‡å’ŒæŒ‡é’ˆå˜é‡çš„ä½¿ç”¨åŒºåˆ«">æ™®é€šå˜é‡å’ŒæŒ‡é’ˆå˜é‡çš„ä½¿ç”¨åŒºåˆ«</h2><p>é€šè¿‡è€çš„æ™®é€šå˜é‡èµ‹å€¼ç”Ÿæˆçš„æ–°æ™®é€šå˜é‡ï¼Œä¸¤è€…ä¹‹é—´å› ä¸ºå†…å­˜åœ°å€ä¸ä¸€æ ·ï¼Œå› æ­¤æ²¡æœ‰ä»»ä½•å…³è”</p><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-go">package mainimport &quot;fmt&quot;func main() &#123;var var01 int = 123var var02 int = var01fmt.Printf(&quot;var01çš„å€¼æ˜¯:%d\nvar02çš„å€¼æ˜¯:%d\n&quot;, var01, var02)fmt.Printf(&quot;var01çš„å†…å­˜åœ°å€æ˜¯:%d\nvar02çš„å†…å­˜åœ°å€æ˜¯:%d\n&quot;, &amp;var01, &amp;var02)var01 = 456    fmt.Printf(&quot;var01çš„æ–°å€¼æ˜¯:%d\nvar02çš„å€¼ä¸å˜:%d\n&quot;, var01, var02) &#125;===var01çš„å€¼æ˜¯:123var02çš„å€¼æ˜¯:123var01çš„å†…å­˜åœ°å€æ˜¯:824634941440var02çš„å†…å­˜åœ°å€æ˜¯:824634941448var01çš„æ–°å€¼æ˜¯:456var02çš„å€¼ä¸å˜:123</code></pre><p>é€šè¿‡è€çš„æ™®é€šå˜é‡èµ‹å€¼ç”Ÿæˆçš„æ–°æŒ‡é’ˆå˜é‡ï¼Œä¸¤è€…ä¹‹é—´æ˜¯å¼•ç”¨å…³ç³»</p><p>å½“æ™®é€šå˜é‡è¢«èµ‹äºˆæ–°å€¼åï¼Œå¯¹åº”çš„æŒ‡é’ˆå˜é‡ä¹Ÿå¯ä»¥è¾“å‡ºæ–°å€¼ï¼Œå› ä¸ºæ™®é€šå˜é‡çš„å†…å­˜åœ°å€å§‹ç»ˆæ²¡å˜</p><pre><code class="language-go">package mainimport &quot;fmt&quot;func main() &#123;var var01 int = 123var var02 *int = &amp;var01fmt.Printf(&quot;var01çš„å€¼æ˜¯:%d\nvar01çš„å†…å­˜åœ°å€æ˜¯:%d\n&quot;, var01, var02)fmt.Printf(&quot;var01çš„çš„å€¼æ˜¯ï¼ˆé€šè¿‡*var02è·å–ï¼‰:%d\n&quot;, *var02)&#125;===var01çš„å€¼æ˜¯:123var01çš„å†…å­˜åœ°å€ï¼ˆé€šè¿‡var02è·å–ï¼‰:824633802928var01çš„å€¼æ˜¯ï¼ˆé€šè¿‡*var02è·å–ï¼‰:123var01çš„æ–°å€¼æ˜¯:456var01çš„å†…å­˜åœ°å€ï¼ˆé€šè¿‡var02è·å–ï¼‰:824633802928var01çš„æ–°å€¼æ˜¯ï¼ˆé€šè¿‡*var02è·å–ï¼‰:456</code></pre><h2 id="ä½œç”¨èŒƒå›´">ä½œç”¨èŒƒå›´</h2><p>å‡½æ•°å†…å®šä¹‰çš„å˜é‡ï¼Œç”Ÿå‘½å‘¨æœŸä»…åœ¨å‡½æ•°è¢«è°ƒç”¨æœŸé—´</p><p>â€‹éœ€è¦æ³¨æ„çš„æ˜¯ï¼šif å’Œ for è¿™äº›æ§åˆ¶ç»“æ„ä¸­å£°æ˜çš„å˜é‡çš„ä½œç”¨åŸŸåªåœ¨ç›¸åº”çš„ä»£ç å—å†…ã€‚å³ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸå¯ä»¥é€šè¿‡ä»£ç å—ï¼ˆç”¨å¤§æ‹¬å·æ‹¬èµ·æ¥çš„éƒ¨åˆ†ï¼‰åˆ¤æ–­ã€‚</p><p>å‡½æ•°å¤–å®šä¹‰çš„å˜é‡ï¼Œå¯ä»¥åœ¨æœ¬çº§ä»¥åŠä¸‹ä¸€çº§åµŒå¥—é‡Œä½¿ç”¨</p><p>å½“ä¸¤ç§å˜é‡åä¸€è‡´æ—¶ï¼Œå‡½æ•°å†…å˜é‡ä¼˜å…ˆçº§æ›´é«˜</p><pre><code class="language-go">package mainimport &quot;fmt&quot;func main() &#123;      x := 1    fmt.Println(x)     //prints 1    &#123;        fmt.Println(x) //prints 1        x := 2        fmt.Println(x) //prints 2    &#125;    fmt.Println(x)     //prints 1 (bad if you need 2)&#125;</code></pre><h2 id="æ•°ç»„">æ•°ç»„</h2><p>ä¸€ç»´æ•°ç»„ï¼š<code>var &lt;var_name&gt; [æ•°ç»„å¤§å°]&lt;type&gt;&#123;&#125;</code></p><p>äºŒç»´æ•°ç»„ï¼š<code>var &lt;var_name&gt; [ä¸€ç»´æ•°ç»„å¤§å°][äºŒç»´æ•°ç»„å¤§å°]&lt;type&gt;&#123;&#125;</code></p><p>[] è¡¨ç¤ºæ•°ç»„é•¿åº¦ï¼š</p><ul><li>å¡«å…¥æ•°å­—ä»£è¡¨æ•°ç»„å¤§å°</li><li>å¡«å…¥<code>...</code>ä»£è¡¨ä¸ç¡®å®šæ•°ç»„å¤§å°ç”±ç³»ç»Ÿæ ¹æ®åˆå§‹åŒ–çš„å€¼æ•°é‡è‡ªåŠ¨è®¡ç®—å¤§å°</li></ul><p>ä¸ç®¡æ˜¯ä¸€ç»´æ•°ç»„ï¼Œè¿˜æ˜¯äºŒç»´æ•°ç»„ï¼Œåªèƒ½å­˜åœ¨ä¸€ç§ç±»å‹ã€‚</p><p>æ•°ç»„ä¸€æ—¦å®šä¹‰åˆ™ä¸å¯å˜çš„ã€‚</p><p>æœ€åï¼Œå‡½æ•°å‚æ•°æ˜¯æ•°ç»„çš„æ—¶å€™ï¼Œé»˜è®¤æ˜¯å€¼ä¼ é€’ã€‚</p><h3 id="ä¾‹å­">ä¾‹å­</h3><pre><code class="language-go">package mainimport &quot;fmt&quot;func main()&#123;    array01 := [3]int&#123;1,2,3&#125;    array02 := [3]int&#123;4,5,6&#125;    array03 := [][3]int&#123;&#125;                    array03 = append(array03, array01)    array03 = append(array03, array02)    for _,x := range(array03)&#123;        for _,y := range(x)&#123;            fmt.Println(y)        &#125;    &#125;&#125;</code></pre><p><code>array03</code>å®šä¹‰äº†ä¸€ä¸ªä¸é™è¡Œï¼Œé™3åˆ—çš„æ•°ç»„ï¼Œè¿™é‡Œä¸é™è¡Œ<code>[]</code>çš„å†™æ³•å«<code>åˆ‡ç‰‡</code></p><h2 id="åˆ‡ç‰‡">åˆ‡ç‰‡</h2><p>åˆ‡ç‰‡åŒ…å«ä¸‰ä¸ªç»„ä»¶æ•°æ®ï¼š</p><ul><li><strong>æŒ‡å‘åŸºç¡€æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå¯è®¿é—®å…ƒç´ çš„æŒ‡é’ˆ</strong>ã€‚æ­¤å…ƒç´ ä¸ä¸€å®šæ˜¯æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  <code>array[0]</code>ã€‚</li><li><strong>åˆ‡ç‰‡çš„é•¿åº¦</strong>ã€‚åˆ‡ç‰‡ä¸­å…ƒç´ æ•°ç›®ã€‚</li><li><strong>åˆ‡ç‰‡çš„å®¹é‡</strong>ã€‚åˆ‡ç‰‡å¼€å¤´ä¸åŸºç¡€æ•°ç»„ç»“æŸä¹‹é—´çš„å…ƒç´ æ•°ç›®ã€‚</li></ul><p>åˆ‡ç‰‡æ˜¯å¯å˜çš„æ•°ç»„ï¼Œå¯ä»¥é€šè¿‡<code>append(åˆ‡ç‰‡,è¿½åŠ åˆ‡ç‰‡)</code>æ¥æ‰©å±•<code>åˆ‡ç‰‡</code></p><p>åˆ‡ç‰‡æ˜¯ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œå› æ­¤åˆ‡ç‰‡å˜é‡å­˜å‚¨çš„æ˜¯å†…å­˜åœ°å€ï¼Œè¿™ä¸ªå†…å­˜åœ°å€å°±æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p><p>ğŸ’–æ‰€ä»¥å½“ä½ å‡½æ•°å‚æ•°æ˜¯åˆ‡ç‰‡çš„æ—¶å€™ï¼Œæ­¤æ—¶ä½ ä¼ å‚ä¼ é€’æ˜¯<code>å¼•ç”¨ä¼ é€’</code></p><p><img src="/posts/759b68d8/image-20211021224622784.png" alt="image-20211021224622784"></p><h3 id="å†™æ³•">å†™æ³•</h3><p>åŸºæœ¬å†™æ³•</p><pre><code class="language-go">s1 := []int&#123;1,2,3,&#125; // åˆå§‹åŒ–ä¸€ä¸ªå†…ç½®3å…ƒç´ ï¼Œå®¹é‡3çš„åˆ‡ç‰‡s1</code></pre><p>æ·»åŠ å®¹é‡å¤§å°çš„å†™æ³•</p><pre><code class="language-go">s1 := make([]int, &lt;len&gt;, &lt;cap&gt;) // &lt;len&gt;æ˜¯å®šä¹‰åˆ‡ç‰‡å†…å…ƒç´ çš„é•¿åº¦ï¼Œ&lt;cap&gt;æ˜¯å®šä¹‰åˆ‡ç‰‡å®¹çº³å…ƒç´ çš„ä¸Šé™æ•°</code></pre><p>é•¿åº¦å†³å®šäº†åˆ‡ç‰‡çš„åˆå§‹å…ƒç´ ä¸ªæ•°ï¼Œå®¹é‡å†³å®šäº†åˆ‡ç‰‡åº•å±‚æ•°ç»„çš„å…ƒç´ ä¸ªæ•°</p><h3 id="å¸¸ç”¨å‡½æ•°">å¸¸ç”¨å‡½æ•°</h3><p><code>æ–°åˆ‡ç‰‡ = append(&lt;ç›®æ ‡åˆ‡ç‰‡&gt;, &lt;å¡«å……åˆ‡ç‰‡&gt;...)</code>ï¼Œç”¨æ¥æ‰©å±•ç›®æ ‡åˆ‡ç‰‡å¹¶åˆ‡å‡ºä¸€ä¸ªæ–°åˆ‡ç‰‡ã€‚æ–°åˆ‡ç‰‡æ˜¯å¦åœ¨&lt;ç›®æ ‡åˆ‡ç‰‡&gt;åŸºç¡€ä¸Šæ“ä½œå–å†³äº&lt;ç›®æ ‡åˆ‡ç‰‡&gt;å®¹é‡æ˜¯å¦å……è¶³</p><p><code>copy(&lt;ç›®æ ‡åˆ‡ç‰‡&gt;, &lt;éœ€å¤åˆ¶åˆ‡ç‰‡&gt;)</code>ï¼Œç”¨æ¥å°†åˆ‡ç‰‡å¤åˆ¶åˆ°ç›®æ ‡åˆ‡ç‰‡ï¼Œç›®æ ‡åˆ‡ç‰‡æœ‰å¤šé•¿ï¼Œå°±å¡«å……å¤šé•¿</p><h3 id="åˆ‡ç‰‡æˆªå–">åˆ‡ç‰‡æˆªå–</h3><pre><code class="language-go">s[:3] //æˆªå–0-2æ„å»ºæ–°åˆ‡ç‰‡, å¿½ç•¥é¦–ä½æ•°å­—s[3:] //æˆªå–3-æœ€åï¼Œæ„å»ºæ–°åˆ‡ç‰‡ï¼Œå¿½ç•¥æœ«å°¾æ•°å­—</code></pre><h3 id="éå†è¾“å‡º">éå†è¾“å‡º</h3><p>ç”¨<code>range</code>å…³é”®å­—</p><p>å¦‚æœæ˜¯æ•°ç»„æˆ–è€…åˆ‡ç‰‡ï¼Œå®ƒè¿”å›(å…ƒç´ åºå·ï¼Œå…ƒç´ å€¼)</p><p>å¦‚æœæ˜¯é›†åˆï¼Œå®ƒè¿”å›(key, value)</p><pre><code class="language-go">for _, i := range &lt;åˆ‡ç‰‡&gt;&#123;    fmt.Println(i)&#125;</code></pre><h2 id="æ˜ å°„">æ˜ å°„</h2><p>map ç±»ä¼¼äº pythhon çš„å­—å…¸ï¼Œç”±kvå¯¹ç»„æˆï¼Œå®ƒæ˜¯æ— åºçš„ï¼Œå› æ­¤ï¼Œåœ¨ä½¿ç”¨ range è¿”å›çš„æ—¶å€™ï¼Œæ— æ³•å†³å®šè¿”å›é¡ºåºã€‚</p><h3 id="å†™æ³•-2">å†™æ³•</h3><pre><code class="language-go">var m1 map[&lt;key_type&gt;]value_type = &#123;&quot;&quot;:&quot;&quot;&#125;</code></pre><p>ğŸ˜’å¦‚æœå•çº¯çš„å£°æ˜å˜é‡ï¼Œå´æ²¡æœ‰èµ‹å€¼ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªnil mapã€‚nil mapä¸å¯é€šè¿‡<code>m1[key]=value</code>åŠ é›†åˆå…ƒç´ ã€‚</p><p>å¦‚æœå•çº¯çš„å£°æ˜ï¼Œå¯ä»¥ä½¿ç”¨make()</p><pre><code class="language-go">package mainimport &quot;fmt&quot;func main() &#123;    m := make(map[string]int)    m[&quot;a&quot;]=1    fmt.Println(m[&quot;a&quot;])&#125;</code></pre><p>ä¾‹å­ï¼š</p><pre><code class="language-go">m1 := map[string]int&#123;&quot;æ²³å—&quot;:1, &quot;éƒ‘å·&quot;:2&#125;fmt.Println(m1[&quot;æ²³å—&quot;])fmt.Println(m1[&quot;éƒ‘å·&quot;])===12</code></pre><h3 id="åˆ é™¤">åˆ é™¤</h3><p>delete(<map>, <key>) ä»mapä¸­åˆ é™¤å¯¹åº”çš„kv</key></map></p><h3 id="æŠ€å·§">æŠ€å·§</h3><p>ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œé€šè¿‡åˆ¤æ–­mapå–å€¼è¿”å›çš„ç¬¬äºŒä¸ªå€¼<code>ok</code>ï¼Œæ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„é€»è¾‘è¡Œä¸ºã€‚</p><pre><code class="language-go">package mainimport &quot;fmt&quot;func main() &#123;      x := map[string]string&#123;&quot;one&quot;:&quot;a&quot;,&quot;two&quot;:&quot;&quot;,&quot;three&quot;:&quot;c&quot;&#125;    if _,ok := x[&quot;two&quot;]; !ok &#123;        fmt.Println(&quot;no entry&quot;)    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜09å­˜å‚¨èµ„æº</title>
      <link href="posts/1080c6b6/"/>
      <url>posts/1080c6b6/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>åœ¨ä½¿ç”¨äº‘æœåŠ¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ›å»ºç£ç›˜ï¼Œéœ€è¦åœ¨å­˜å‚¨æœåŠ¡ä¸­æäº¤ä¸€ä¸ªè¯·æ±‚ï¼Œé‡Œé¢åŒ…å«äº†ç£ç›˜ç±»å‹ï¼Œç£ç›˜å¤§å°.ä¹‹åï¼Œæˆ‘ä»¬å†æŠŠè¿™ä¸ªç”³è¯·çš„ç£ç›˜æŒ‚è½½åˆ°æ‰€éœ€çš„è®¡ç®—èµ„æºä¸Šå³å¯.</p><p>è€Œåœ¨k8sä¸­. å½“ä½¿ç”¨å­˜å‚¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹ä¸»è¦æ¦‚å¿µ</p><p>æ„å»ºå­˜å‚¨çš„æ¦‚å¿µï¼š</p><ul><li>volume å£°æ˜å­˜å‚¨æœåŠ¡ï¼Œä¾‹å¦‚å…¬æœ‰äº‘çš„äº‘ç›˜ï¼ˆaws-ebsï¼Œé˜¿é‡Œäº‘-äº‘ç›˜ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯nfs/cephfsã€‚</li><li>pv å£°æ˜volumeçš„ä¿¡æ¯ï¼Œå¦åˆ™ï¼Œk8så°±ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨ volumeã€‚</li></ul><p>ä½¿ç”¨å­˜å‚¨çš„æ¦‚å¿µï¼š</p><ul><li><p>pvc é€šè¿‡PVå£°æ˜ã€æœŸæœ›ã€‘çš„å­˜å‚¨ã€‚ä¾‹å¦‚æœŸæœ›å¾—åˆ°çš„ç£ç›˜å¤§å°ã€è®¿é—®æ¨¡å¼ã€‚</p></li><li><p>spec.template.spec.volumes  é€šè¿‡ PVC æˆ–è€… CM åˆ›å»º pod æ‰€éœ€çš„å·ã€‚å¦‚åŒä½ åœ¨awsä¸­ä½ å°†EBSç»‘å®šåˆ°EC2ã€‚</p></li><li><p>spec.template.spec.containers.volumeMounts  å£°æ˜ pod å¦‚ä½•æŒ‚è½½ volumesã€‚å¦‚åŒä½ ç™»é™†åˆ°awsçš„EC2ä¸­ï¼Œå¹¶ä½¿ç”¨mountå‘½ä»¤è¿›è¡Œå®é™…æŒ‚è½½ã€‚</p></li></ul><p>ä½ å¯èƒ½ä¼šå‘ç°ï¼Œ<code>podtemplate.spec.volumes</code>å’Œ<code>podtemplate.spec.containers.volumeMounts</code>ä¹‹é—´ç¼ºå°‘äº†ä¸€ä¸ªæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿçš„è¿‡ç¨‹ï¼Œè¿™æ˜¯å› ä¸ºk8så·²ç»åœ¨ä½ é€šè¿‡pvèµ„æºå¸®ä½ åˆ›å»ºå¥½äº†æ–‡ä»¶ç³»ç»Ÿã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡å°†pvçš„æ¨¡å¼æ”¹ä¸ºå—è®¾å¤‡ï¼Œä¸è¿‡è¿™æ ·ä¸€æ¥ï¼Œç¨‹åºå°±éœ€è¦ç¡®è®¤æ˜¯å¦å¯ä»¥è¯†åˆ«å—è®¾å¤‡äº†ã€‚æˆ‘æƒ³ä¸€èˆ¬çš„åº”ç”¨ç¨‹åºæ˜¯ç”¨ä¸ä¸Šè¿™ä¸ªç±»å‹çš„ã€‚<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#volume-mode">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#volume-mode</a></p><p>æœ€åï¼Œpod ä¸ pv ä¸ pvc ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€å¼ºä¾èµ–å…³ç³»ã€‚ä¸‰è€…ä¹‹é—´ï¼Œåœ¨Aèµ„æºå¯¹è±¡ã€è¢«Bè°ƒç”¨ã€‘çš„è¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªåˆ é™¤Aèµ„æºå¯¹è±¡çš„æ“ä½œéƒ½ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ã€Bè°ƒç”¨æ–¹ã€‘ç”Ÿå‘½å‘¨æœŸç»“æŸä¹‹åæ‰ä¼šæ‰§è¡Œã€‚</p><h1>volumeå·</h1><p>æ”¯æŒçš„å­˜å‚¨ç±»å‹</p><p><a href="https://kubernetes.io/docs/concepts/storage/volumes/#volume-types">https://kubernetes.io/docs/concepts/storage/volumes/#volume-types</a></p><p>åœ¨ä½¿ç”¨æŸä¸€ä¸ªå­˜å‚¨æœåŠ¡ç±»å‹ä¹‹å‰ï¼Œè¯¦ç»†çš„é˜…è¯»å­˜å‚¨æœåŠ¡çš„é™åˆ¶å¾ˆæœ‰å¿…è¦ã€‚</p><p>å­˜å‚¨ç±»å‹æ”¯æŒçš„æ¨¡å¼:</p><p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes</a></p><ol><li><p><strong>ReadWriteOnce</strong>(å•èŠ‚ç‚¹æŒ‚è½½è¯»å†™ï¼Œå•èŠ‚ç‚¹å†…å¤špodè¯»å†™)</p></li><li><p><strong>ReadOnlyMany</strong>(å¤šèŠ‚ç‚¹æŒ‚è½½åªè¯»ï¼Œå¤špodåªè¯»)</p></li><li><p><strong>ReadWriteMany</strong>(å¤šèŠ‚ç‚¹æŒ‚è½½è¯»å†™ï¼Œå¤špodè¯»å†™)</p></li><li><p><strong>ReadWriteOncePod</strong>(å•Podè¯»å†™)</p></li></ol><p>âš ï¸ReadWriteOncePod æ˜¯æ–°å¢ï¼Œä»…æ”¯æŒ csi + k8s 1.22+</p><h2 id="NFS">NFS</h2><p>ä½¿ç”¨NFSä¹‹å‰ï¼Œéœ€è¦å…ˆæ­å»ºNFSæœåŠ¡ç«¯ã€‚</p><p>ä¾‹å¦‚äº‘æœåŠ¡å·²æœ‰çš„NFSæœåŠ¡ï¼Œæˆ–è€…è‡ªè¡Œæ­å»ºã€‚</p><p>ä¸‹é¢æ˜¯k8så®˜æ–¹ç»™å‡ºçš„è‡ªè¡Œæ­å»ºï¼š</p><p><a href="https://github.com/kubernetes/examples/tree/master/staging/volumes/nfs">https://github.com/kubernetes/examples/tree/master/staging/volumes/nfs</a></p><h2 id="æœ¬åœ°">æœ¬åœ°</h2><p>local volume ç‰¹ç‚¹ï¼š</p><ul><li>å½“å‰åªæ”¯æŒé™æ€PVã€‚</li><li>æ˜¾å¼çš„æ·»åŠ èŠ‚ç‚¹äº²å’Œæ€§ï¼Œç³»ç»Ÿé€šè¿‡PVçš„èŠ‚ç‚¹äº²å’Œæ€§å°†Podè°ƒåº¦åˆ°æœ¬åœ°å·æ‰€åœ¨èŠ‚ç‚¹ä¸Šã€‚</li><li>å»ºç«‹ä¸€ä¸ªåŠ¨æ€PVï¼Œå¹¶é€šè¿‡è®¾ç½®æ¨¡å¼å»¶è¿Ÿç»‘å®šç›´åˆ°Podè°ƒåº¦åˆ°æœ¬åœ°å·æ‰€åœ¨èŠ‚ç‚¹ä¸Šã€‚</li></ul><p>ä¸€ä¸ªä¾‹å­ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: PersistentVolumemetadata:  name: example-pvspec:  capacity:    storage: 100Gi  volumeMode: Filesystem  accessModes:  - ReadWriteOnce  persistentVolumeReclaimPolicy: Delete  storageClassName: local-storage  local:    path: /mnt/disks/ssd1  nodeAffinity:    required:      nodeSelectorTerms:      - matchExpressions:        - key: kubernetes.io/hostname          operator: In          values:          - example-node    --- apiVersion: storage.k8s.io/v1kind: StorageClassmetadata:  name: local-storageprovisioner: kubernetes.io/no-provisionervolumeBindingMode: WaitForFirstConsumer</code></pre><h1>PVæŒä¹…å·</h1><h2 id="çŠ¶æ€">çŠ¶æ€</h2><pre><code class="language-bash">kubectl get pv -n &lt;ns&gt;</code></pre><ul><li>Availableï¼ˆå¯ç”¨ï¼‰ï¼šè¡¨ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè¿˜æœªè¢«ä»»ä½• PVC ç»‘å®š</li><li>Boundï¼ˆå·²ç»‘å®šï¼‰ï¼šè¡¨ç¤º PV å·²ç»è¢« PVC ç»‘å®š</li><li>Releasedï¼ˆå·²é‡Šæ”¾ï¼‰ï¼šPVC è¢«åˆ é™¤ï¼Œä½†æ˜¯æ•°æ®èµ„æºè¿˜åœ¨</li><li>Failedï¼ˆå¤±è´¥ï¼‰ï¼š è¡¨ç¤ºè¯¥ PV çš„è‡ªåŠ¨å›æ”¶å¤±è´¥</li></ul><h2 id="ç±»å‹">ç±»å‹</h2><p>PVåˆ†ä¸ºé™æ€å’ŒåŠ¨æ€ã€‚</p><p>é™æ€pv: éœ€è¦å…ˆåˆ›å»ºä¸€å®šæ•°é‡çš„pvï¼Œ ç„¶åæ‰èƒ½é€šè¿‡pvcå¯¹åº”ç”³è¯·ã€‚è‹¥pvcæ— æ³•åŒ¹é…ä»»æ„é™æ€pvï¼Œåˆ™pvcä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚</p><p>åŠ¨æ€pv: éœ€è¦å…ˆæ„å»ºä¾›åº”å•†.ä¸»æµçš„äº‘å•†å­˜å‚¨åŸºæœ¬éƒ½æœ‰ä¾›åº”å•†ï¼Œ åŒºåˆ«åœ¨äºæ˜¯å†…ç½®äº†ï¼Œè¿˜æ˜¯éœ€è¦è‡ªè¡Œå¤–éƒ¨åˆ›å»º.ç„¶åå†é€šè¿‡pvcå»ç”³è¯·.</p><p>å†…ç½®ä¾›åº”å•†åˆ—è¡¨: <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner">https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner</a></p><p>å¤–ç½®ä¾›åº”å•†éƒ¨ç½²: <a href="https://github.com/kubernetes-retired/external-storage">https://github.com/kubernetes-retired/external-storage</a></p><h2 id="å›æ”¶ç­–ç•¥">å›æ”¶ç­–ç•¥</h2><p><code>spec.persistentVolumeReclaimPolicy</code> å®šä¹‰ PVC è¢«åˆ é™¤çš„æ—¶å€™ï¼Œé›†ç¾¤å¦‚ä½•å¤„ç†PVã€‚</p><p><strong>Retain</strong>  ä¸å¤„ç†PVã€‚ä½† PV ä¸èƒ½ç›´æ¥å†æ¬¡æœç”¨ï¼Œå› ä¸ºé‡Œé¢è¿˜æœ‰ä¹‹å‰Podçš„æ•°æ®ã€‚å¤ç”¨PVï¼š</p><ul><li>åœ¨é™æ€PVä¸‹ï¼ŒPVçš„åå­—æ˜¯å›ºå®šçš„ï¼Œå› æ­¤åˆ é™¤PVCä¹‹åï¼Œé€šè¿‡åˆ é™¤<code>pv.spec.claimRef.uid</code>è§£é™¤PVçš„<code>Released</code>çŠ¶æ€ï¼Œå°±å¯ä»¥é‡‡ç”¨åŸæœ‰çš„PVCé…ç½®åˆ†é…åˆ°ã€‚</li><li>åœ¨åŠ¨æ€PVä¸‹ï¼ŒPVçš„åå­—æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œ å› æ­¤åˆ é™¤PVCä¹‹åï¼Œ å½“PVCé‡æ–°ç”³è¯·èµ„æºçš„æ—¶å€™ï¼Œ PVé»˜è®¤å°†ä¼šåˆ†é…åˆ°ä¸€ä¸ªæ–°çš„èµ„æºè·¯å¾„ã€‚</li></ul><p><strong>Delete</strong> åŒæ—¶åˆ é™¤PVCå’ŒVolumeã€‚åªä¸è¿‡Volumeæ˜¯å¦åˆ é™¤å–å†³äºæ¯ä¸€ä¸ªStorageClassä¸­parametersçš„å®šä¹‰ã€‚</p><ul><li>å½“StorageClassæ˜¯nfs-clientæ—¶ï¼Œå¼€å¯ <code>parameters.archiveOnDelete=true</code> ï¼Œå°±å¯ä»¥å®šä¹‰ä¸åˆ é™¤è€Œæ˜¯åœ¨nfsä¸­å°†å…¶æ•°æ®ç›®å½•é‡å‘½åå½’æ¡£ã€‚</li><li>å½“StorageClassæ˜¯å¾®è½¯/aws/é˜¿é‡Œäº‘çš„äº‘ç›˜çš„æ—¶å€™ï¼Œä¸€èˆ¬é»˜è®¤æ˜¯åˆ é™¤äº‘ç›˜ã€‚ä»è€Œé¿å…äº§ç”Ÿå¤§é‡é—²ç½®äº‘ç›˜ã€‚</li></ul><p><strong>Recycle</strong> åˆ é™¤PVã€‚</p><ul><li>å½“å‰åªæœ‰nfså’ŒhostPathæ”¯æŒ.</li><li>å·²åºŸå¼ƒã€‚å»ºè®®é€šè¿‡åŠ¨æ€PV+Deleteå»æ§åˆ¶ã€‚</li></ul><h2 id="é™æ€PV">é™æ€PV</h2><p>é™æ€PVï¼Œå¿…é¡»ç”±ç®¡ç†å‘˜ç”¨æˆ·å…ˆåˆ›å»ºå¥½pv.å°±å¦‚åŒä½ æƒ³æ„å»ºä¸€ä¸ªäº‘æœåŠ¡å™¨ï¼Œä½†éœ€è¦å…ˆåˆ›å»ºå¥½ä¸€ä¸ªäº‘ç›˜ã€‚</p><p>ä¸€ä¸ªé™æ€pvçš„ä¾‹å­ï¼Œ è¿™é‡Œä»¥ nfs ä¸ºä¾‹:</p><pre><code class="language-yaml">apiVersion: v1kind: PersistentVolumemetadata:  name:  nas-nginx-pv  # pv åå­—ï¼Œä¼šè¢« pvc å¼•ç”¨spec:  claimRef:    name: nas-nginx-pvc    namespace: default  capacity:    storage: 10Gi  # å®šä¹‰æœ¬æŒä¹…å·å¤§å°  accessModes:  - ReadWriteMany   # å®šä¹‰æœ¬æŒä¹…å·è®¿é—®æ¨¡å¼  persistentVolumeReclaimPolicy: Retain   # å®šä¹‰pvcåˆ é™¤åçš„ç­–ç•¥  nfs:    path: /volume1/k8s  # å®šä¹‰ nfs å…±äº«è·¯å¾„    server: 10.200.10.4        # å®šä¹‰ nfs æœåŠ¡å™¨åœ°å€</code></pre><ul><li><p>claimRef æ˜¾å¼çš„æŒ‡å®šå…è®¸ç»‘å®šçš„PVCã€‚</p></li><li><p>accessModes è®¿é—®æ¨¡å¼ã€‚</p></li><li><p>persistentVolumeReclaimPolicy è¯¦è§<strong>PVå›æ”¶ç­–ç•¥ã€‚</strong></p></li></ul><h3 id="é™æ€PVå¯¹åº”çš„PVC">é™æ€PVå¯¹åº”çš„PVC</h3><pre><code class="language-yaml">kind: PersistentVolumeClaimapiVersion: v1metadata:  name: nas-nginx-pvc  namespace: defaultspec:  accessModes:    - ReadWriteMany  resources:    requests:      storage: 10Gi  volumeName: nas-nginx-pv</code></pre><ul><li>spec.volumeName æ˜¾å¼çš„æŒ‡å®šè¦ç»‘å®šçš„pv</li></ul><h2 id="åŠ¨æ€PV">åŠ¨æ€PV</h2><p>åŠ¨æ€PVç›®çš„åœ¨äºç”¨æˆ·å¯ä»¥è‡ªè¡Œé€šè¿‡PVCç”³è¯·èµ„æºï¼Œæ— éœ€æå‰é€šè¿‡ç®¡ç†å‘˜åˆ›å»ºPVã€‚</p><p>åŠ¨æ€PVçš„æ„å»ºéœ€è¦ä¸€ä¸ªæ–°çš„èµ„æºå¯¹è±¡StroageClassï¼Œå®ƒé€šè¿‡<code>provisioner</code>æŒ‡å®šå·æ’ä»¶ï¼Œä»è€Œå¯¹æ¥ä¸åŒçš„å‚¨å­˜ã€‚å·æ’ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªå­˜å‚¨ç±»å‹çš„å®¢æˆ·ç«¯ã€‚</p><p>å·æ’ä»¶éƒ½ä¼šæ‹¥æœ‰è‡ªå·±çš„ä¸€äº›ç‰¹å®šå‚æ•°ï¼Œä»è€Œæ»¡è¶³å‘å·ä¾›åº”å•†æä¾›åˆ›å»ºå·æ—¶æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚</p><p>å½“å‰æ”¯æŒçš„volumeç±»å‹ä»¥åŠå¯¹åº”çš„å·æ’ä»¶å‚æ•°ï¼š</p><p><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner">https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner</a></p><p>âš ï¸ k8så¹¶ä¸æä¾›æ‰€æœ‰çš„å·æ’ä»¶ã€‚</p><h3 id="åŸºäºnfsæ„å»ºStroageClass">åŸºäºnfsæ„å»ºStroageClass</h3><p>ä»¥ç½‘ç»œå­˜å‚¨nfsä¸ºä¾‹ã€‚nfså±äºå¤–ç½®ä¾›åº”å•†ï¼Œå› æ­¤æ²¡æœ‰å†…ç½®å·æ’ä»¶ã€‚å› æ­¤éœ€è¦å…ˆåˆ›å»ºã€‚åˆ›å»ºæ–‡æ¡£ï¼š</p><p><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/blob/master/charts/nfs-subdir-external-provisioner/README.md">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/blob/master/charts/nfs-subdir-external-provisioner/README.md</a></p><p>âš ï¸ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œnfs-clientæ­£å¸¸è¿è¡Œæ¡ä»¶ï¼š</p><ul><li>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…nfs-utilsã€‚<code>yum install nfs-utils -y</code></li></ul><p>å®‰è£…å‘½ä»¤ï¼š</p><ul><li>å›½å¤–æº</li></ul><pre><code class="language-yaml">#############################################å›½å¤–æº###################################################helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/helm repo updatehelm search repo --max-col-width 200 | grep nfshelm install nfs-client nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \         --set storageClass.name=nfs-client \         --set nfs.server=10.200.10.4 \         --set nfs.path=/volume1/k8s \         --set storageClass.reclaimPolicy=Delete \         --set storageClass.archiveOnDelete=true \         --set storageClass.allowVolumeExpansion=true \         --set storageClass.defaultClass=true</code></pre><ul><li>é˜¿é‡Œæº(ç‰ˆæœ¬å¯èƒ½é™ˆæ—§)</li></ul><pre><code class="language-bash">#############################################é˜¿é‡Œæº###################################################helm repo add apphub https://apphub.aliyuncs.comhelm repo updatehelm install nfs-client apphub/nfs-client-provisioner \--set storageClass.name=nfs-client \--set nfs.server=10.200.10.4 \--set nfs.path=/volume1/k8s \--set storageClass.reclaimPolicy=Delete \--set storageClass.archiveOnDelete=true \--set storageClass.allowVolumeExpansion=true \--set storageClass.defaultClass=true</code></pre><ul><li><p>parameters.archiveOnDelete å½“å›æ”¶ç­–ç•¥åœ¨è¢«æ‰§è¡Œçš„æ—¶å€™ï¼ˆ<a href="#persistentVolumeReclaimPolicy">persistentVolumeReclaimPolicy</a>ï¼‰ï¼Œpvåˆ é™¤çš„åŒæ—¶ç”³è¯·çš„å­˜å‚¨èµ„æºæ˜¯å¦è¦å½’æ¡£ã€‚falseå°±æ˜¯ä¸å½’æ¡£ç›´æ¥åˆ é™¤ã€‚è¿™é‡Œå½’æ¡£çš„æ„æ€å°±æ˜¯å°†ç”³è¯·çš„å­˜å‚¨èµ„æºçš„ç‰©ç†è·¯å¾„å‰åŠ ä¸€ä¸ªarchivedå‰ç¼€ã€‚æœ€ç»ˆæ ¼å¼ï¼š<code>archived-$&#123;NS_NAME&#125;-$&#123;PVC_NAME&#125;-$&#123;PV_NAME&#125;</code></p></li><li><p>storageClass.allowVolumeExpansion å¼€å¯å·æ‰©å±•ã€‚è¿™ä¸ªé€‰é¡¹å¯ä»¥è®©ä½ åŠ¨æ€çš„è°ƒæ•´ pvc è¯·æ±‚çš„å¯¹è±¡å¤§å°ã€‚</p><blockquote><p>å…¶å®è¿™ä¸ªå‚æ•°æ²¡ç”¨ï¼Œå› ä¸ºk8sç›®å‰ä¸æ”¯æŒnfsåŠ¨æ€æ‰©å±•ã€‚</p></blockquote></li></ul><p>nfs-clientä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»ºä¸€ä¸ª StroageClassã€‚</p><pre><code class="language-yaml">kubectl get StorageClass/nfs-client -o yamlallowVolumeExpansion: trueapiVersion: storage.k8s.io/v1kind: StorageClassmetadata:  annotations:    meta.helm.sh/release-name: nfs-client    meta.helm.sh/release-namespace: default    storageclass.kubernetes.io/is-default-class: &quot;true&quot;  creationTimestamp: &quot;2021-12-27T06:25:24Z&quot;  labels:    app: nfs-subdir-external-provisioner    app.kubernetes.io/managed-by: Helm    chart: nfs-subdir-external-provisioner-4.0.14    heritage: Helm    release: nfs-client  ......  name: nfs-clientparameters:  archiveOnDelete: &quot;true&quot;provisioner: cluster.local/nfs-client-nfs-subdir-external-provisionerreclaimPolicy: DeletevolumeBindingMode: Immediate</code></pre><h3 id="åŠ¨æ€PVå¯¹åº”çš„PVC">åŠ¨æ€PVå¯¹åº”çš„PVC</h3><pre><code class="language-yaml">kind: PersistentVolumeClaimapiVersion: v1metadata:  name: nas-vsftpd-pvcspec:  storageClassName: nfs-client  accessModes:    - ReadWriteMany  resources:    requests:      storage: 100Gi</code></pre><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ <code>spec.storageClassName</code>æ˜¾å¼æŒ‡å®šStroageClassã€‚</p><h3 id="Podä¸­çš„PVCæ¨¡æ¿">Podä¸­çš„PVCæ¨¡æ¿</h3><p>PVCæ¨¡æ¿å¯ä»¥åŠ¨æ€çš„åˆ›å»ºPVCï¼Œç„¶åPVCå†é€šè¿‡StorageClassåŠ¨æ€åˆ›å»ºPVã€‚</p><p>ğŸ’¥ volumeClaimTemplates ä¸æ”¯æŒ Deployment.spec</p><pre><code class="language-yaml">apiVersion: apps/v1kind: StatefulSetmetadata:  name: app-demospec:...    spec:      containers:...        volumeMounts:        - name: appdata          mountPath: /app/data  volumeClaimTemplates:  - metadata:      name: appdata  # appdata å³ volumeMounts.name    spec:      accessModes: [ &quot;ReadWriteOnce&quot; ]      resources:        requests:          storage: 1Gi</code></pre><h3 id="åœ¨çº¿æ‰©å±•ï¼ˆä»…æ”¯æŒåŠ¨æ€pvï¼‰">åœ¨çº¿æ‰©å±•ï¼ˆä»…æ”¯æŒåŠ¨æ€pvï¼‰</h3><p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#expanding-persistent-volumes-claims">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#expanding-persistent-volumes-claims</a> æ–‡æ¡£ä¸­åˆ—ä¸¾äº†æ”¯æŒæ‰©å±•çš„å­˜å‚¨ç±»ã€‚</p><p>ğŸ’”NFSæ˜¯ä¸è¢«æ”¯æŒçš„ã€‚</p><p>å¦å¤–ï¼Œè¿˜éœ€è¦æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ï¼š</p><ol><li><p>feature-gatesçš„<code>ExpandInUsePersistentVolumes</code>è¢«å¼€å¯ã€‚å®ƒåœ¨1.15ç‰ˆæœ¬ä»¥åé»˜è®¤å¼€å¯ã€‚</p></li><li><p>StorageClassçš„<code>allowVolumeExpansion</code>è¢«å¼€å¯ã€‚</p></li><li><p>æ–‡ä»¶ç³»ç»Ÿæ˜¯XFSï¼Œ Ext3ï¼Œ or Ext4ã€‚è¿™ä¸ªéœ€è¦StorageClassçš„æ”¯æŒã€‚ä¸€èˆ¬æ¥è¯´volumeå±äºå—è®¾å¤‡ç±»å‹çš„èµ„æºæ‰æ”¯æŒï¼Œæ¯”å¦‚awsçš„ebsã€‚</p><blockquote><p>ä½ å¯ä»¥åœ¨è¿™é‡Œç¡®è®¤StorageClassæ˜¯å¦æ”¯æŒfstypeå±æ€§ã€‚<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#parameters">https://kubernetes.io/docs/concepts/storage/storage-classes/#parameters</a></p></blockquote></li></ol><p>æ»¡è¶³ä¸Šè¿°æ¡ä»¶åï¼Œä½ å°±å¯ä»¥é€šè¿‡ä¿®æ”¹pvcæå‡å­˜å‚¨å¤§å°äº†ã€‚å³ä½¿ pvc æ­£åœ¨è¢«ä½¿ç”¨ã€‚</p><h3 id="å±€é™æ€§">å±€é™æ€§</h3><p>å½“ä¸€ä¸ª pod åŒæ—¶ç”³è¯·å¤šä¸ª volume çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç° volume-A ç”³è¯·æˆåŠŸï¼Œvolume-B å› ç‰©ç†å®¹é‡ä¸å¤Ÿç”³è¯·å¤±è´¥çš„é—®é¢˜ï¼Œæ­¤æ—¶ pod å°†å¡ä½ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ‰‹åŠ¨ä»‹å…¥å»æ¸…ç†ã€‚</p><h3 id="PVCç”³è¯·å¤±è´¥">PVCç”³è¯·å¤±è´¥</h3><p>éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨çš„æ—¶å€™ï¼Œéƒ½æ˜¯èµ„æºç”³è¯·å¤±è´¥æˆ–è€…ä¸å°å¿ƒåˆ é™¤äº†PVCä¹‹ç±»çš„ã€‚è€Œä¸ç®¡æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬ç¬¬ä¸€ç›®çš„æ˜¯æ•°æ®ä¸ä¸¢ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ¸…ç†æ•…éšœå¯¹è±¡èµ„æºçš„æ—¶å€™ï¼Œåº”è¯¥éµå¾ªä¸‹åˆ—æ­¥éª¤ï¼š</p><ol><li>å°†pvçš„å›æ”¶ç­–ç•¥<code>persistentVolumeReclaimPolicy</code>å®šä¹‰ä¸º<code>Retain</code></li><li>åˆ é™¤pvcï¼Œè¿™ä¸ªæ—¶å€™ pv å¯¹è±¡å°†ä¼šä¿ç•™ï¼Œä½†æ˜¯ pv çŠ¶æ€ä¼šå˜æˆ Releasedï¼Œè¿™ä¸ªçŠ¶æ€ä¸‹ pv æ— æ³•å†è¢«ä½¿ç”¨</li><li>åˆ é™¤pvå¯¹è±¡å­—æ®µ<code>spec.claimRef.uid</code>ï¼Œä»è€Œå°†pvä¸pvcè§£ç»‘ï¼Œä»è€Œä½¿ pv çŠ¶æ€å˜ä¸º Available</li><li>å°†pvcå¯¹è±¡å­—æ®µ<code>volumeName</code>è®¾ç½®ä¸ºpvçš„åå­—ï¼Œé‡å»ºpvc</li><li>æ¢å¤pvçš„å›æ”¶ç­–ç•¥ã€‚</li></ol><h1>Podä½¿ç”¨PVC</h1><p>ä¸Šè¿°ä¾‹å­ä¸­çš„ nfs å·ç±»å‹ä¸ºä¾‹ã€‚</p><p>Deploymenté…ç½®ï¼š</p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: vsftpd  namespace: it  labels:    app: vsftpdspec:  serviceName: vsftpd  revisionHistoryLimit: 10  replicas: 1  selector:    matchLabels:      app: vsftpd  template:    metadata:      labels:        app: vsftpd    spec:      hostNetwork: true      affinity:        nodeAffinity:          requiredDuringSchedulingIgnoredDuringExecution:            nodeSelectorTerms:            - matchExpressions:              - key: kubernetes.io/hostname                operator: In                values:                - k8s01      containers:      - name: vsftp        image: fauria/vsftpd        ports:        - containerPort: 20        - containerPort: 21        env:        - name: LOG_STDOUT          value: STDOUT        resources:          requests:            memory: &quot;128Mi&quot;            cpu: &quot;125m&quot;          limits:            memory: &quot;512Mi&quot;            cpu: &quot;250m&quot;        volumeMounts:        - name: vsftpd-vol          subPath: vsftpd/data          mountPath: /home/vsftpd        - name: vsftpd-vc          subPath: vsftpd.conf          mountPath: /etc/vsftpd/vsftpd.conf          readOnly: true        - name: vsftpd-vc          subPath: virtual_users.txt          mountPath: /etc/vsftpd/virtual_users.txt          readOnly: true        - name: vsftpd-vc          subPath: admin          mountPath: /etc/vsftpd/virtual/admin          readOnly: true      volumes:      - name: vsftpd-vol        persistentVolumeClaim:          claimName: vsftpd-pvc      - name: vsftpd-vc        configMap:          name: vsftpd-cm</code></pre><ol><li><p><code>spec.template.spec.volumes</code>ï¼šå®šä¹‰Podæ‰€ç”¨çš„å·</p></li><li><p><code>spec.template.spec.containers.volumeMounts</code>ï¼šå®šä¹‰ <code>nas-vsftpd-vol</code>å¦‚ä½•æŒ‚è½½</p><p>è¿™é‡Œå°† nfs å…±äº«ç›®å½•<code>&lt;nfs_root&gt;/vsftpd/data</code>æŒ‚è½½åˆ°å®¹å™¨é‡Œçš„ <code>/home/vsftpd</code>è·¯å¾„ã€‚subPathä¸å­˜åœ¨çš„æ—¶å€™ï¼Œnfsä¼šè‡ªåŠ¨åˆ›å»ºã€‚</p></li><li><p>configMap å‚è§ä¸´æ—¶å·</p></li></ol><p>âš ï¸ subPath æ–¹å¼çš„æŒ‚è½½æ— æ³•æ¥æ”¶æ•°æ®æ›´æ–°ã€‚</p><h1>ä¸´æ—¶å·</h1><p><a href="https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/#types-of-ephemeral-volumes">https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/#types-of-ephemeral-volumes</a></p><p>k8sç”¨æ¥è¿›è¡Œä¸´æ—¶çš„æ•°æ®å­˜å‚¨æˆ–è€…ä¸´æ—¶è°ƒç”¨æ•°æ®ã€‚ä¾‹å¦‚ç¼“å­˜/ä¼šè¯/å¯†ç /é…ç½®ä¸€ç±»çš„ã€‚</p><p>â„¹ï¸ ä»–ä»¬æ— éœ€äººä¸ºçš„æå‰åˆ›å»ºPVCå»ç»‘å®šï¼Œè€Œæ˜¯ç›´æ¥åœ¨Podä¸­å»è°ƒç”¨ã€‚</p><p>ä¸´æ—¶å·å‡é€šè¿‡èŠ‚ç‚¹çš„kubeletè‡ªåŠ¨ç®¡ç†ï¼Œå®ç°ä¸´æ—¶å·çš„PVCå°†éšç€PODçš„åˆ é™¤è€Œè‡ªåŠ¨åˆ é™¤ã€‚</p><ul><li><p>emptyDir</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: test-pdspec:  containers:  - image: k8s.gcr.io/test-webserver    name: test-container    volumeMounts:    - mountPath: /cache      name: cache-volume  volumes:  - name: cache-volume    emptyDir: &#123;&#125;</code></pre><p>emptyDiræ”¯æŒæ„å»ºä¸€ä¸ªå†…å­˜å±‚ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ tmpfsã€‚ä½ å¯ä»¥é€šè¿‡<code>emptyDir.medium: &quot;Memory&quot;</code>æ¥å¼€å¯ã€‚</p></li><li><p>configMapã€secret</p><p>é…ç½®å·å’Œå¯†ç å·ï¼Œå¾ˆé‡è¦çš„ç±»å‹ã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯ConfigMapå’Œsecretå¯¹è±¡çš„å…¶ä¸­ä¸€ç§ä½¿ç”¨æ–¹å¼ã€‚</p><p>âš ï¸ éœ€è¦å…ˆåˆ›å»ºConfigMapå’Œsecretå¯¹è±¡ï¼Œæ‰èƒ½åœ¨Podä¸­å¼•ç”¨ä»–ä»¬ã€‚</p></li><li><p>Downward API</p><p>å¸¸ç”¨æ¥ç»™å®¹å™¨æä¾›Podä¿¡æ¯ã€‚</p></li><li><p>generic ephemeral volumes è¿™ä¸€ç§æ˜¯æ›´åŠ çµæ´»çš„emptyDirï¼Œå¯ä»¥æ˜¯ç½‘ç»œå­˜å‚¨ï¼Œå¦‚æœæ’ä»¶æ”¯æŒï¼Œåˆ™å„ç§æŒä¹…å·çš„ç‰¹æ€§å®ƒéƒ½æœ‰å¯èƒ½æ”¯æŒã€‚ä»1.19å¼€å§‹æ”¯æŒï¼Œ1.19ä¹Ÿæ˜¯alphaï¼Œé»˜è®¤ä¸å¼€å¯ã€‚</p><p>å…·ä½“ä½¿ç”¨çœ‹https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/#generic-ephemeral-volumes</p></li></ul><h1>Projected Volumes</h1><p>å¯å®ç°å°†volumesçš„æ‰€æœ‰åˆ—è¡¨é¡¹æŒ‚è½½åœ¨PodåŒä¸€ä¸ªä½ç½®ä¸Šã€‚</p><p>è¯¦ç»†ä½¿ç”¨è§ã€k8sâ˜10åº”ç”¨é…ç½®ä¸å¯†ç ä¸ä¿¡æ¯æä¾›ã€‘</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> storage </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…åº“â˜vsftpd</title>
      <link href="posts/894f9595/"/>
      <url>posts/894f9595/</url>
      
        <content type="html"><![CDATA[<h2 id="é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</h2><pre><code class="language-yaml">apiVersion: apps/v1kind: StatefulSetmetadata:  name: nas-it-local-dep  namespace: it  labels:    app: nas-it-localspec:  serviceName: nas-it-local-vsftpd  revisionHistoryLimit: 10  replicas: 1  selector:    matchLabels:      app: nas-it-local  template:    metadata:      labels:        app: nas-it-local    spec:      hostNetwork: true      affinity:        nodeAffinity:          requiredDuringSchedulingIgnoredDuringExecution:            nodeSelectorTerms:            - matchExpressions:              - key: kubernetes.io/hostname                operator: In                values:                - k8s01  # è¿™é‡Œç»‘å®š pod æ‰€åœ¨èŠ‚ç‚¹      containers:      - name: vsftp        image: fauria/vsftpd        ports:        - containerPort: 20        - containerPort: 21        env:        - name: LOG_STDOUT          value: STDOUT        resources:          requests:            memory: &quot;128Mi&quot;            cpu: &quot;125m&quot;          limits:            memory: &quot;512Mi&quot;            cpu: &quot;250m&quot;        volumeMounts:        - name: nas-it-local-vol          subPath: nas.it.local/data          mountPath: /home/vsftpd        - name: nas-it-local-vc          subPath: vsftpd.conf          mountPath: /etc/vsftpd/vsftpd.conf          readOnly: true        - name: nas-it-local-vc          subPath: virtual_users.txt          mountPath: /etc/vsftpd/virtual_users.txt          readOnly: true        - name: nas-it-local-vc          subPath: admin          mountPath: /etc/vsftpd/virtual/admin          readOnly: true        - name: nas-it-local-vc          subPath: yuangong          mountPath: /etc/vsftpd/virtual/yuangong          readOnly: true      volumes:      - name: nas-it-local-vol        persistentVolumeClaim:          claimName: nas-it-local-pvc      - name: nas-it-local-vc        configMap:          name: nas-it-local-cm---kind: ConfigMapapiVersion: v1metadata:  name: nas-it-local-cm  namespace: itdata:  vsftpd.conf: |    # Run in the foreground to keep the container running:    background=NO    # Allow anonymous FTP? (Beware - allowed by default if you comment this out).    anonymous_enable=NO    # Uncomment this to allow local users to log in.    local_enable=YES    ## Enable virtual users    guest_enable=YES    ## Virtual users will use the same permissions as anonymous    virtual_use_local_privs=YES    # Uncomment this to enable any form of FTP write command.    write_enable=YES    ## PAM file name    pam_service_name=vsftpd_virtual    ## Home Directory for virtual users    user_sub_token=$USER    local_root=/home/vsftpd/$USER    user_config_dir=/etc/vsftpd/virtual    # You may specify an explicit list of local users to chroot() to their home    # directory. If chroot_local_user is YES, then this list becomes a list of    # users to NOT chroot().    chroot_local_user=YES    # Workaround chroot check.    # See https://www.benscobie.com/fixing-500-oops-vsftpd-refusing-to-run-with-writable-root-inside-chroot/    # and http://serverfault.com/questions/362619/why-is-the-chroot-local-user-of-vsftpd-insecure    allow_writeable_chroot=YES    ## Hide ids from user    hide_ids=YES    ## Enable logging    xferlog_enable=YES    xferlog_file=/var/log/vsftpd/vsftpd.log    ## Enable active mode    port_enable=YES    connect_from_port_20=YES    ftp_data_port=20    ##Â Disable seccomp filter sanboxing    seccomp_sandbox=NO    ### Variables set at container runtime    pasv_address=10.200.16.10    pasv_max_port=21110    pasv_min_port=21100    pasv_addr_resolve=NO    pasv_enable=YES    file_open_mode=0666    local_umask=077    xferlog_std_format=NO    reverse_lookup_enable=YES    pasv_promiscuous=NO    port_promiscuous=NO  virtual_users.txt: |    admin    admin    yuangong    yuangong  admin: |    local_root=/home/vsftpd    anon_world_readable_only=NO    write_enable=YES    anon_mkdir_write_enable=YES    anon_upload_enable=YES    anon_other_write_enable=YES  yuangong: |    local_root=/home/vsftpd/yuangong    anon_world_readable_only=NO    write_enable=NO    anon_mkdir_write_enable=NO    anon_upload_enable=NO    anon_other_write_enable=NO---apiVersion: v1kind: PersistentVolumemetadata:  name:  nas-it-local-pv  # å®šä¹‰ pv åå­—, ä¼šè¢« pvc å¼•ç”¨  namespace: itspec:  claimRef:    name: nas-it-local-pvc    namespace: it  capacity:    storage: 100Gi  # å®šä¹‰å¤§å°  accessModes:  - ReadWriteMany   # å®šä¹‰è®¿é—®æ¨¡å¼  persistentVolumeReclaimPolicy: Retain   # å®šä¹‰pvcåˆ é™¤åçš„ç­–ç•¥  nfs:    path: /mnt/data001/nfs-k8s   # å®šä¹‰ nfs å…±äº«è·¯å¾„    server: 10.200.16.250        # å®šä¹‰ nfs æœåŠ¡å™¨åœ°å€---kind: PersistentVolumeClaimapiVersion: v1metadata:  name: nas-it-local-pvc  namespace: itspec:  accessModes:    - ReadWriteMany  resources:    requests:      storage: 100Gi  volumeName: nas-it-local-pv</code></pre><ul><li>è¿™æ˜¯ä¸€ä¸ª<strong>ä¸»åŠ¨æ¨¡å¼</strong>çš„ ftp. é‰´äº k8s ç‰¹æ®Šçš„ç½‘ç»œç¯å¢ƒ.ä»¥åŠç«¯å£çš„ç¹çé…ç½®. æ‰€ä»¥é‡‡ç”¨ä¸»åŠ¨æ¨¡å¼, å¯ä»¥è®©æˆ‘ä»¬æ›´èˆ’æœä¸€äº›.</li><li>pvå’Œpvcæ–¹é¢æ ¹æ®ä½ è‡ªå·±çš„ç¯å¢ƒè‡ªè¡Œè°ƒæ•´.</li><li>ä½ éœ€è¦è‡ªè¡Œå°†podå¼ºåˆ¶ç»‘å®šåˆ°æŸä¸ªç‰©ç†èŠ‚ç‚¹çš„ipä¸Š. é¿å…å› podé‡æ„æ—¶æ¼‚ç§»åˆ°å…¶å®ƒip. é…ç½®æ–‡ä»¶é‡Œç»‘å®šçš„æ˜¯k8s01</li></ul><h2 id="ç”¨æˆ·åˆ›å»º">ç”¨æˆ·åˆ›å»º</h2><p>ä¸Šè¿°é…ç½®ä¼šåˆ›å»ºadminå’Œyuangongä¸¤ä¸ªç”¨æˆ·ã€‚</p><p>adminç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰æƒã€‚æ ¹ç›®å½•æ˜¯/home/vsftpd</p><p>yuangongç”¨æˆ·åªæœ‰ä¸‹è½½æƒé™ã€‚æ ¹ç›®å½•æ˜¯/home/vsftpd/yuangong</p><h3 id="æ·»åŠ æ–°ç”¨æˆ·">æ·»åŠ æ–°ç”¨æˆ·</h3><ul><li><p>æ·»åŠ ç”¨æˆ·åå’Œå¯†ç åˆ° virtual_users.txt é…ç½®</p></li><li><p>æ·»åŠ ç”¨æˆ·é…ç½®åˆ°cmå¯¹è±¡ä¸­</p><pre><code class="language-yaml">  æˆ‘æ˜¯ç”¨æˆ·å: |    local_root=/home/vsftpd/&lt;æˆ‘æ˜¯ç”¨æˆ·å&gt;    anon_world_readable_only=NO    write_enable=YES    anon_mkdir_write_enable=YES    anon_upload_enable=YES    anon_other_write_enable=YES</code></pre></li><li><p>åˆ›å»ºç”¨æˆ·ç›®å½• /home/vsftpd/&lt;æˆ‘æ˜¯ç”¨æˆ·å&gt;</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vsftpd </tag>
            
            <tag> å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§â˜monit</title>
      <link href="posts/ae41ae33/"/>
      <url>posts/ae41ae33/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash">yum install monit -y</code></pre><h2 id="ä¸»é…ç½®">ä¸»é…ç½®</h2><pre><code class="language-bash"># vim /etc/monitrcset daemon  10 # è°ƒæ•´å‘¨æœŸ</code></pre><p>â­ï¸å®˜æ–¹é…ç½®æ–‡æ¡£: <a href="https://mmonit.com/monit/documentation/monit.html">https://mmonit.com/monit/documentation/monit.html</a></p><h2 id="ç¨‹åºä¿æ´»é…ç½®">ç¨‹åºä¿æ´»é…ç½®</h2><p>é»˜è®¤å­˜æ”¾ä½ç½®: /etc/monit.d/</p><p>è¿™é‡Œä»¥ pidfile æ£€æµ‹æ–¹å¼ä¸ºä¾‹</p><p>nginxçš„é…ç½®:</p><pre><code class="language-bash">check process nginx with pidfile /var/run/nginx.pid  start program = &quot;/usr/sbin/nginx&quot;  stop program = &quot;/usr/bin/killall nginx&quot;if changed pid then alert</code></pre><p>ä¸Šè¿°nginxé…ç½®çš„æ„æ€:</p><ol><li><p>æ£€æµ‹æ–¹å¼: pidfile</p></li><li><p>å¼€å…³ç¨‹åºè·¯å¾„</p></li><li><p>å‘ç°pidæ”¹å˜,åˆ™è§¦å‘åŠ¨ä½œ: é¢„è­¦</p></li></ol><p>tomcatçš„é…ç½®:</p><pre><code class="language-bash">check process tomcat-8080 with pidfile /opt/tomcat/tomcat-8080/bin/tomcat.pid  start program = &quot;/usr/bin/bash /opt/tomcat/tomcat-8080/bin/startup.sh&quot;    as uid &quot;root&quot; and gid &quot;root&quot;  stop program = &quot;/usr/bin/ps aux | /usr/bin/grep '/opt/tomcat/tomcat-8080/bin/bootstrap.jar' | /usr/bin/awk '&#123;print &quot;kill -9 &quot;$2&#125;' | /usr/bin/bash&quot;    as uid &quot;root&quot; and gid &quot;root&quot;if failed port 8080 then alert</code></pre><p>ä¸Šè¿°tomcaté…ç½®çš„æ„æ€:</p><ol><li>æ£€æµ‹æ–¹å¼: pidfile</li><li>å¼€å…³ç¨‹åºè·¯å¾„, å¹¶ä¸”æ‰§è¡Œçš„æ—¶å€™éœ€è¦ä»¥ root æƒé™æ‰§è¡Œ</li><li>å‘ç° 8080 ä¸é€š, åˆ™è§¦å‘åŠ¨ä½œ: é¢„è­¦</li></ol><p>ğŸŒŸéœ€è¦æ³¨æ„çš„æ˜¯, æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„éƒ½éœ€è¦æ˜¯ç»å¯¹è·¯å¾„, åŒ…æ‹¬å‘½ä»¤.</p><h2 id="å¯åŠ¨-å…³é—­">å¯åŠ¨/å…³é—­</h2><pre><code class="language-bash">systemctl start/stop/reload monit</code></pre><p>ğŸŒŸå½“monitå¯åŠ¨ä¹‹å, å®ƒå°±ä¼šåŠ è½½ä¿æ´»é…ç½®, å¹¶è¿›è¡Œæ£€æµ‹.</p><h2 id="æ—¥å¿—">æ—¥å¿—</h2><pre><code>/var/log/monit.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> monit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> monit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜13é«˜çº§ç‰ˆè´Ÿè½½å‡è¡¡ingressæ§åˆ¶å™¨</title>
      <link href="posts/7627a41d/"/>
      <url>posts/7627a41d/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>svcçš„NodePortè§£å†³äº†4å±‚çš„å¯¹å¤–æœåŠ¡æä¾›ã€‚ä½†7å±‚çš„åŠŸèƒ½svcæ— æ³•è§£å†³ã€‚ä¾‹å¦‚httpsã€‚</p><p>ingress controller å¯ä»¥å°†å¤šä¸ªåŸŸåè½¬å‘åˆ°serviceï¼Œæä¾›è´Ÿè½½å‡è¡¡/SSLç®¡ç†/è™šæ‹Ÿå‘½åä¸»æœº/pathè·¯ç”±ã€‚</p><p>ingress controller è´Ÿè´£å®ç°åŠŸèƒ½ï¼Œä¸è¿‡é…ç½®è§„åˆ™ç”±ingresså¯¹è±¡å®ç°ã€‚</p><p>ingress-controller çš„å®ç°æœ‰å¾ˆå¤šï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹é¡µé¢ï¼Œk8så®˜æ–¹ç»´æŠ¤äº†<code>aws</code>ï¼Œ<code>gce</code>ï¼Œ<code>nginx</code>ã€‚</p><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers/</a></p><p>ä¾‹å¦‚ï¼š</p><ul><li>nginx ingress åŸºäº nginx çš„ ingress æ§åˆ¶å™¨</li><li>istio ingress åŸºäº istio çš„ ingress æ§åˆ¶å™¨</li><li>traefik ingress åŸºäº traefik çš„ ingress æ§åˆ¶å™¨</li></ul><h1>ç‰¹ç‚¹</h1><ul><li><p>ingress æä¾›è§„åˆ™, å®ƒéœ€è¦å’Œåç«¯ä¸šåŠ¡ä½äºåŒä¸€ä¸ªnsä¸­.</p></li><li><p>ingress controller å¯ä»¥å•ç‹¬ä½äºä¸€ä¸ªnsï¼Œå®ƒä¼šè‡ªåŠ¨å»è§£æ Ingress å¯¹è±¡ï¼ˆå‰ææ˜¯ ingress å¯¹è±¡æ³¨è§£ annotations ä¸­å«æœ‰è¿™ä¸ª ingress controllerï¼‰ã€‚</p></li><li><p>ingress é’ˆå¯¹çš„ä¸»è¦æ˜¯ http å’Œ https. è¿™äº›ä¹‹å¤–çš„ç«¯å£æš´æ¼ï¼Œå¦‚æœä»…ä»…æ˜¯4å±‚ï¼Œåˆ™é€šè¿‡ Service.Type=NodePort æˆ–è€… Service.Type=LoadBalancer å³å¯ã€‚</p></li></ul><h1>æµé‡è·¯å¾„</h1><p>internet =&gt; Ingress =&gt; Service</p><p><img src="/posts/7627a41d/image-20201023110559218.png" alt="image-20201023110559218"></p><h1>ç»„ä»¶</h1><h2 id="Ingress-controller">Ingress controller</h2><ol><li><p>Ingress æƒ³è¦æ­£å¸¸è¿ä½œ, éœ€è¦Ingressæ§åˆ¶å™¨çš„æ”¯æŒ.</p></li><li><p>å¯ä»¥åœ¨k8sä¸­éƒ¨ç½²å¤šä¸ªIngressæ§åˆ¶å™¨, ä½†æ˜¯éœ€è¦é€šè¿‡åœ¨ annotations ä¸­ç”¨ ingress.class æ³¨è§£å¼ºè°ƒæƒ³ç”¨å“ªä¸€æ¬¾.</p></li></ol><p>è¿™é‡Œæˆ‘ä»¬é€‰ç”¨ nginx ingress æ§åˆ¶å™¨ã€‚å®ƒçš„éƒ¨ç½²æ–‡æ¡£æ˜¯:</p><p><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md">https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md</a></p><p>æˆ–è€…</p><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a></p><p>è¿™é‡Œï¼Œæˆ‘å°†é€šè¿‡helmæ¥å®‰è£…ingress-nginx. å…¶å®ƒå®‰è£…æ–¹å¼. åœ¨ <a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a> ä¸­å¯ä»¥æ‰¾åˆ°å¾ˆå¤šä¸åŒç¯å¢ƒçš„å®‰è£…æ–¹å¼.</p><p>å½“å‰ ingress-nginx çš„ä»“åº“åœ°å€æ˜¯: <a href="https://hub.helm.sh/charts/ingress-nginx/ingress-nginx">https://hub.helm.sh/charts/ingress-nginx/ingress-nginx</a></p><pre><code class="language-bash">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginxhelm repo update</code></pre><h3 id="é…ç½®ingress-nginx">é…ç½®ingress-nginx</h3><pre><code class="language-bash">helm show values ingress-nginx/ingress-nginx &gt; values.yaml</code></pre><p>å°†ä¸‹åˆ—ä¿¡æ¯ï¼Œæ·»åŠ åˆ°<code>values.yaml</code></p><pre><code class="language-yaml">controller:  ......  #lifecycle:    #preStop:      #exec:        #command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;sleep 5; /usr/local/openresty/nginx/sbin/nginx -c /etc/nginx/nginx.conf -s quit; while pgrep -x nginx; do sleep 1; done&quot;]  metrics:    port: 10254    # if this port is changed, change healthz-port: in extraArgs: accordingly    enabled: true    service:      annotations: #&#123;&#125;        prometheus.io/scrape: &quot;true&quot;        prometheus.io/port: &quot;10254&quot;</code></pre><p>#<code>sleep 5</code>æ˜¯å¿…é¡»çš„ï¼Œä½†åŸå› ä¸æ˜ã€‚æ²¡æœ‰å®ƒï¼Œæ§åˆ¶å™¨å…³é—­çš„æ—¶å€™ä¼šä¸¢å¤±è¿æ¥ã€‚</p><p>#<code>terminationGracePeriodSeconds: 300</code>å»¶é•¿podç»ˆæ­¢å‰çš„å®½æ•æœŸï¼Œä¸ä¸€å®šæ˜¯æœ€åˆé€‚çš„æ—¶é—´ï¼Œå¯èƒ½æœ‰ç‚¹é•¿ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚</p><h3 id="å®‰è£…ingress-nginx">å®‰è£…ingress-nginx</h3><pre><code class="language-bash">kubectl create namespace ingress-nginx## æŸ¥çœ‹æœ€æ–°çš„chat versionhelm search repo ingress-nginx/ingress-nginxversion=4.0.16helm install ingress-nginx ingress-nginx/ingress-nginx --version $&#123;version&#125; -n ingress-nginx -f values.yaml</code></pre><pre><code class="language-bash">kubectl get all -n ingress-nginx===NAME                                            READY   STATUS    RESTARTS   AGEpod/ingress-nginx-controller-5886685d54-hf6l6   1/1     Running   0          68mNAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGEservice/ingress-nginx-controller             LoadBalancer   10.96.210.139   &lt;pending&gt;     80:32489/TCP,443:30936/TCP   68mservice/ingress-nginx-controller-admission   ClusterIP      10.96.128.101   &lt;none&gt;        443/TCP                      68mNAME                                       READY   UP-TO-DATE   AVAILABLE   AGEdeployment.apps/ingress-nginx-controller   1/1     1            1           68mNAME                                                  DESIRED   CURRENT   READY   AGEreplicaset.apps/ingress-nginx-controller-5886685d54   1         1         1       68m</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ingress-nginx æ§åˆ¶å™¨åˆ›å»ºäº†ä¸€ä¸ª <code>pod/ingress-nginx-controller-5886685d54-hf6l6</code>, è¿™ä¸ª pod å…¶å®å°±æ˜¯ä¸€ä¸ª nginx. å®ƒé€šè¿‡ ingress å®šä¹‰çš„è§„åˆ™ï¼Œæ¥åŠ¨æ€çš„å˜æ›´nginxé…ç½®ï¼Œä»è€Œæ­£ç¡®çš„å°†æµé‡è½¬å‘ç»™åç«¯åº”ç”¨çš„serviceå¯¹è±¡.</p><pre><code class="language-bash">kubectl describe pod/ingress-nginx exec -it pod/ingress-nginx-controller-5886685d54-hf6l6===    Requests:      cpu:      100m      memory:   90Mi</code></pre><p>å½“å‰é…ç½®é»˜è®¤æ²¡æœ‰åšlimité™åˆ¶. æ‰€ä»¥éœ€è¦å…³æ³¨ingress-nginxåˆ›å»ºçš„podæ‰€åœ¨ç‰©ç†èŠ‚ç‚¹çš„æ€§èƒ½æ˜¯å¦å¯ä»¥æ»¡è¶³. å»ºè®®å¼ºåˆ¶ç»‘å®šåˆ°å¤šä¸ªnodeèŠ‚ç‚¹ï¼ˆé€šè¿‡æ±¡ç‚¹ï¼‰ï¼Œ è¿™æ‰¹èŠ‚ç‚¹ä¸“é—¨è·‘ç”¨æ¥è¿›è¡Œingressæ§åˆ¶å™¨.</p><p>é€šè¿‡ç™»é™†podï¼Œå¯ä»¥æŸ¥çœ‹è½¬åŒ–åçš„nginxé…ç½®.</p><pre><code class="language-bash">kubectl --namespace ingress-nginx exec -it pod/ingress-nginx-controller-5886685d54-hf6l6 -- /bin/bash==cat /etc/nginx/nginx.conf</code></pre><h2 id="ingress">ingress</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">https://kubernetes.io/docs/concepts/services-networking/ingress/</a></p><p>client =&gt; <a href="http://one.foo.com/one">http://one.foo.com/one</a> =&gt; Ingress = &gt; Service(one):8001 =&gt; pod</p><p>client =&gt; http://*.foo.com/other =&gt; Ingress  =&gt; Service(other):8002 =&gt; pod</p><p>ingressç¼–å†™è·¯ç”±è§„åˆ™ï¼Œå¹¶ç”±ingress-controllerè¿›è¡Œè½¬åŒ–ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: minimal-ingress  namespace: default#  annotations:#    nginx.ingress.kubernetes.io/rewrite-target: /spec:  ingressClassName: nginx  rules:  - host: one.foo.com    http:      paths:      - path: /one        pathType: Prefix        backend:          service:            name: one            port:              number: 8001  - host: &quot;*.foo.com&quot;    http:      paths:      - pathType: Prefix        path: &quot;/other&quot;        backend:          service:            name: other            port:              number: 8002</code></pre><p>ğŸŒŸè¯·æ³¨æ„, <code>networking.k8s.io/v1</code>å¿…é¡»æ˜¯v1.19+æ‰å¯ä»¥ä½¿ç”¨, å¦‚æœä½ ä¸æ˜¯,åˆ™åº”è¯¥ä½¿ç”¨<code>networking.k8s.io/v1beta1</code></p><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ ingress çš„é…ç½®é¡¹ï¼Œæˆ‘å‚è€ƒ nginx é…ç½®ï¼Œæ¥è¿›è¡Œäº†ä¸€äº›æ¨ªå‘å¯¹æ¯”ï¼š</p><p>nginx.servername:  è¿™é‡Œæ˜¯ spec.rules[].host</p><p>nginx.location: è¿™é‡Œæ˜¯ spec.rules.http.paths[].path</p><p>nginx.upstream: è¿™é‡Œæ˜¯ spec.rules.http.paths[].backend</p><h3 id="å…³äº-spec-rules-host">å…³äº spec.rules[].host</h3><p>è¿™é‡Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹. host æ”¯æŒç»Ÿé…åŒ¹é…. ä¸è¿‡ <code>*</code>ä¸èƒ½è·¨çº§åŒ¹é…. ä¾‹å¦‚,</p><p>*.abc.com å¯ä»¥åŒ¹é… <a href="http://one.abc.com">one.abc.com</a> ä½†æ˜¯ä¸èƒ½åŒ¹é… <a href="http://two.one.abc.com">two.one.abc.com</a>.</p><h3 id="å…³äº-spec-rules-http-paths-path">å…³äº spec.rules.http.paths[].path</h3><p>è¿™é‡Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹.å¦‚ä¸Šä¾‹å­æ‰€è¿°. pathType å®šä¹‰äº† path çš„ç±»å‹. å®ƒæœ‰ä¸‰ä¸ªç±»å‹:</p><ul><li><p>ImplementationSpecific: æ ¹æ®é€‰ç”¨çš„ ingress class æ¥å®šæ€§.è¿™æ˜¯é»˜è®¤ç±»å‹.</p></li><li><p>Exact: ä¸¥æ ¼åŒ¹é…. ä¸èƒ½æœ‰ä¸€ç‚¹ä¸åŒ.</p></li><li><p>Prefix: åŸºäº&quot;/&quot;åˆ†æ®µè¿›è¡Œå‰ç¼€åŒ¹é…. ä¾‹å¦‚,</p><ul><li>/aaa/bbb å¯ä»¥åŒ¹é…ä»»ä½• /aaa/bbb/ å¼€å¤´çš„, æˆ–è€… /aaa/bbb.  å› æ­¤ /aaa/bbbb æ˜¯ä¸èƒ½åŒ¹é…çš„.</li><li>/aaa å¯ä»¥åŒ¹é…ä»»ä½• /aaa/ å¼€å¤´çš„, æˆ–è€… /aaa. å› æ­¤, /aaaa æ˜¯ä¸èƒ½åŒ¹é…çš„.</li><li>/ å¯ä»¥åŒ¹é…ä»»ä½• / å¼€å¤´çš„. å› æ­¤, åŒ¹é…æ‰€æœ‰.</li></ul><p>â­ï¸è¯·æ³¨æ„, Prefix ç±»å‹ä¸‹.ä½ å†™çš„åŒ¹é…å­—ç¬¦ä¸²é¦–å°¾éƒ½éœ€è¦åŠ <code>/</code>, å¦‚æœä½ å°¾éƒ¨æ²¡æœ‰åŠ <code>/</code>, é‚£ä¹ˆ ingress åœ¨åŒ¹é…çš„æ—¶å€™, ä¹Ÿä¼šå¸®ä½ åŠ ä¸Š<code>/</code>.</p></li></ul><p>å½“Exactå’ŒPrefixæ··ç”¨çš„æ—¶å€™, å¦‚æœä¸€ä¸ªè¯·æ±‚åŒæ—¶åŒ¹é…äº†è¿™ä¸¤ä¸ªç±»å‹ä¸‹çš„path, é‚£ä¹ˆExact ä¼˜å…ˆçº§æ›´é«˜.</p><h3 id="æ„å»ºTLS">æ„å»ºTLS</h3><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/#tls">https://kubernetes.io/zh/docs/concepts/services-networking/ingress/#tls</a></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸º Ingress å¯ç”¨äº† TLSï¼Œingress-controller å°†ä½¿ç”¨ 308 æ°¸ä¹…é‡å®šå‘å“åº”å°† HTTP å®¢æˆ·ç«¯é‡å®šå‘åˆ° HTTPS ç«¯å£ 443ã€‚</p><p>ğŸ’¥<code>ingress.spec.tls.hosts</code>å¿…é¡»å®Œå…¨åŒ…å«<code>ingress.spec.rules.hosts</code></p><h4 id="æ‰‹åŠ¨è¯ä¹¦">æ‰‹åŠ¨è¯ä¹¦</h4><ol><li><h4 id="åˆ›å»º-Secret-å¯¹è±¡-å¯¼å…¥è¯ä¹¦æ–‡ä»¶">åˆ›å»º Secret å¯¹è±¡, å¯¼å…¥è¯ä¹¦æ–‡ä»¶</h4><pre><code class="language-yaml">apiVersion: v1kind: Secretmetadata:  name: foo-com-tls  namespace: defaultdata:  tls.crt: base64 encoded cert # è¿™é‡Œéœ€è¦å¡«å†™ base64 ç¼–ç åçš„ cert å†…å®¹. tls.crt ä¸å¯æ›´å  tls.key: base64 encoded key  # è¿™é‡Œéœ€è¦å¡«å†™ base64 ç¼–ç åçš„ key å†…å®¹. tls.key ä¸å¯æ›´åtype: kubernetes.io/tls</code></pre><p>å¯ä»¥é€šè¿‡<code>cat è¯ä¹¦æ–‡ä»¶|base64</code>è·å–ç¼–ç åçš„å†…å®¹</p></li><li><h4 id="åœ¨Ingresså¯¹è±¡ä¸­è°ƒç”¨-Secret">åœ¨Ingresså¯¹è±¡ä¸­è°ƒç”¨ Secret</h4><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: tls-example-ingressspec:  tls:  - hosts:      - https-example.foo.com    secretName: foo-com-tls  rules:  - host: https-example.foo.com    http:      paths:      - path: /        pathType: Prefix        backend:          service:            name: service1            port:              number: 80</code></pre><p>â€¦backend.service.name svcå¯¹è±¡å</p><p>â€¦backend.service.port svcå¯¹è±¡ç«¯å£</p></li></ol><p>ä¸åŒçš„Ingressæ§åˆ¶å™¨å¯¹äºTLSè¿™å—ä¹Ÿæœ‰ä¸€å®šå·®å¼‚.å…·ä½“ä»¥æ§åˆ¶å™¨æœ¬èº«è¯´æ˜ä¸ºå‡†.</p><h4 id="è‡ªåŠ¨è¯ä¹¦">è‡ªåŠ¨è¯ä¹¦</h4><p>æ„å»ºcert-managerè¯ä¹¦ç®¡ç†å™¨ã€‚å…·ä½“å®‰è£…å‚è§è¯ä¹¦ç®¡ç†å™¨æ–‡æ¡£ã€‚</p><h1>é—®é¢˜</h1><h2 id="è§£å†³svc-lbç±»å‹çš„é—®é¢˜">è§£å†³svc lbç±»å‹çš„é—®é¢˜</h2><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é€šè¿‡helmé»˜è®¤å®‰è£…çš„ ingress crotroller çš„ Service å¯¹è±¡æ˜¯LoadBalancerç±»å‹. è¿™ç§ç±»å‹æˆ‘ä»¬ç”¨äºäº‘ç«¯ç¯å¢ƒ. è€Œæˆ‘è¿™é‡Œæµ‹è¯•ç¯å¢ƒæ˜¯è£¸æœº,å› æ­¤ä½ å¯ä»¥çœ‹åˆ°è¿™é‡Œå®ƒä¸€ç›´æ— æ³•è·å–åˆ°<code>EXTERNAL-IP</code>.</p><p>è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬æ— æ³•å°†æµé‡é€šè¿‡<code>service/ingress-nginx-controller</code>ä¼ é€’åˆ°<code>pod/ingress-nginx-controller-5886685d54-hf6l6</code>.ğŸ™„</p><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜.k8så®˜æ–¹æ–‡æ¡£è¿™é‡Œæä¾›äº†å¤šç§è£¸æœºå®‰è£…ä¸‹çš„è§£å†³æ–¹æ¡ˆï¼š</p><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/</a></p><p>è¿™é‡Œé€šè¿‡ <a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a> çº¯è½¯ä»¶æ–¹æ¡ˆæ¥è§£å†³ LB ç±»å‹çš„ <code>EXTERNAL-IP</code>è·å–é—®é¢˜. å…¶å®ƒæ–¹æ¡ˆå¹¶ä¸æ˜¯é‡‡ç”¨çš„ LB ç±»å‹, å› æ­¤è¿™é‡Œä¸å†å™è¯´.</p><p>âš ï¸metallb æ–¹æ¡ˆåœ¨å½“å‰å¹¶ä¸æ˜¯ä¸€ä¸ªæˆç†Ÿçš„æ–¹æ¡ˆ,å½“ç„¶å®ƒåº”è¯¥æ˜¯å¯ç”¨çš„ğŸ˜„ æ‰€ä»¥ç”¨äºæœ¬åœ°æµ‹è¯•ç¯å¢ƒæ˜¯å¯ä»¥çš„. çº¿ä¸Šç¯å¢ƒå»ºè®®ç›´æ¥ç”¨äº‘æœåŠ¡çš„LBå³å¯.</p><h3 id="metallb">metallb</h3><p><a href="https://metallb.universe.tf/installation/#installation-with-helm">https://metallb.universe.tf/installation/#installation-with-helm</a></p><p>metallb æ¨¡æ‹Ÿäº†äº‘ç¯å¢ƒä¸­çš„è´Ÿè½½å‡è¡¡å™¨åŠŸèƒ½.</p><p>ğŸŒŸIf youâ€™re using kube-proxy in IPVS mode, since Kubernetes v1.14.2 you have to enable strict ARP mode.</p><p>å¦‚æœä½ æ˜¯ipvs ä¸” k8s ç‰ˆæœ¬åœ¨1.14.2ä»¥ä¸Š, é‚£ä¹ˆä½ éœ€è¦å¯åŠ¨ä¸¥æ ¼arpæ¨¡å¼.</p><pre><code class="language-bash">kubectl edit configmap -n kube-system kube-proxy===ipvs:  strictARP: true</code></pre><p>å¼€å§‹å®‰è£…</p><pre><code class="language-bash">helm repo add metallb https://metallb.github.io/metallbhelm fetch metallb metallb/metallb</code></pre><p>ä¿®æ”¹ metalla/values.yaml, æ·»åŠ åœ°å€æ± ï¼Œç”¨æ¥ç»™svcä¸‹å‘ipã€‚è¯·è®°ä½, è¿™äº›åœ°å€å¿…é¡»æ˜¯æ²¡æœ‰è¢«å…¶å®ƒèµ„æºå ç”¨çš„.</p><pre><code class="language-bash">configInline:  address-pools:   - name: default     protocol: layer2     addresses:     - 10.200.16.11 - 10.200.16.19</code></pre><p>é€šè¿‡ helm å®‰è£…</p><pre><code class="language-bash">kubectl create ns metallb-systemhelm install metallb --namespace metallb-system -f metallb/values.yaml metallb/metallb# ä¸‹é¢è¿™ä¸ªå‘½ä»¤ä»…åœ¨ä½ åˆå§‹å®‰è£…çš„æ—¶å€™éœ€è¦è¿è¡Œkubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=&quot;$(openssl rand -base64 128)&quot;</code></pre><p>ä¸‹é¢,è®©æˆ‘ä»¬å†çœ‹çœ‹ ingress crotroller çš„ svc å¯¹è±¡ä¿¡æ¯.</p><pre><code class="language-bash">kubectl get svc -n ingress-nginx===NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                      AGEingress-nginx-controller             LoadBalancer   10.96.210.139   10.200.16.11   80:32489/TCP,443:30936/TCP   88mingress-nginx-controller-admission   ClusterIP      10.96.128.101   &lt;none&gt;         443/TCP                      88m</code></pre><p>ç»ˆäº<code>svc/ingress-nginx-controller</code>æ‹¿åˆ°äº†ä¸€ä¸ª<code>EXTERNAL-IP</code>, ç°åœ¨ä½ å°±å¯ä»¥å°†åŸŸåè§£æåˆ°<code>EXTERNAL-IP</code>, å¹¶é€šè¿‡è¿™ä¸ªåŸŸåæ¥è®¿é—®ä½ çš„åº”ç”¨äº†.(è€Œä¸”å®ƒå¿…é¡»æ˜¯èƒ½é€šè¿‡80è®¿é—®çš„.)ğŸ˜„</p><p>å‡è®¾å·²ç»è®¾ç½®ç¼–å†™ä¸€ä¸ª ingressï¼Œåˆ™åº”ç”¨åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="language-bash">kubectl get ingress -n it===NAME                   CLASS    HOSTS          ADDRESS        PORTS   AGE test-it-local-ingress   &lt;none&gt;   test.it.local   10.200.16.11   80      106m</code></pre><p>å¯ä»¥çœ‹åˆ° ingress å¯¹è±¡ä¸­ä¹Ÿæ˜¾ç¤ºäº† metallb çš„ä¸‹å‘çš„ip.</p><p>ä½ å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šé€šè¿‡ ipvs è§„åˆ™æ¥çœ‹åˆ°è½¬å‘æƒ…å†µ.</p><pre><code class="language-bash">ipvsadm -L -n===TCP  10.200.16.11:80 rr  -&gt; 10.97.2.57:80                Masq    1      0          0TCP  10.200.16.11:443 rr  -&gt; 10.97.2.57:443               Masq    1      0          0</code></pre><p>è¿™é‡Œ 10.97.2.57 æ˜¯ ingress æ§åˆ¶å™¨çš„ pod ip.</p><blockquote><p>metallbå‡çº§ï¼š<a href="https://metallb.universe.tf/installation/#upgrade">https://metallb.universe.tf/installation/#upgrade</a></p></blockquote><h2 id="æš´æ¼é80å’Œé443ç«¯å£">æš´æ¼é80å’Œé443ç«¯å£</h2><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/">https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/</a></p><p>é»˜è®¤ä½ ä¼šå‘ç°ingressæ— æ³•æš´æ¼80å’Œ443ä¹‹å¤–çš„ç«¯å£.è¿™æ˜¯å› ä¸ºé»˜è®¤ingress-nginxå¹¶æ²¡æœ‰å¼€å¯4å±‚è½¬å‘.</p><h3 id="å¼€å¯ingress-nginxä¸­podçš„4å±‚è½¬å‘">å¼€å¯ingress-nginxä¸­podçš„4å±‚è½¬å‘</h3><p>æ£€æŸ¥ deployment: ingress-nginx ä¸­ pod æ¨¡æ¿æ˜¯å¦å¼€å¯äº†ä¸‹åˆ—å‚æ•°</p><pre><code class="language-bash">deploymentName=`kubectl get all -n ingress-nginx | grep deployment | awk '&#123;print $1&#125;'`kubectl edit $&#123;deploymentName&#125; -n ingress-nginx===- args:    - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services    - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</code></pre><h3 id="åˆ›å»ºæš´æ¼ç«¯å£çš„é…ç½®æ–‡ä»¶">åˆ›å»ºæš´æ¼ç«¯å£çš„é…ç½®æ–‡ä»¶</h3><pre><code class="language-yaml">apiVersion: v1kind: ConfigMapmetadata:  name: tcp-services  namespace: ingress-nginxdata:  8080: &quot;it/test-it-local-svc:8080&quot;</code></pre><p>è¿™é‡Œ8080: &quot;it/test-it-local-svc:8080&quot;<code>ç¬¬ä¸€ä¸ª8080æŒ‡çš„æ˜¯ingress-nginxçš„podå¯¹è±¡é‡Œéœ€è¦ç›‘å¬çš„ç«¯å£, </code>it/test-it-local-svc:8080` æŒ‡çš„æ˜¯ns:itä¸‹çš„svcå¯¹è±¡test-it-local-svcçš„8080ç«¯å£</p><h3 id="æ·»åŠ æš´æ¼ç«¯å£åˆ°ingress-nginxä¸­svcå¯¹è±¡">æ·»åŠ æš´æ¼ç«¯å£åˆ°ingress-nginxä¸­svcå¯¹è±¡</h3><pre><code class="language-bash">kubectl get all -n ingress-nginx | grep service | awk '&#123;print $1&#125;' kubectl edit service/ingress-nginx-controller -n ingress-nginx===  - name: test-8080    port: 8080    protocol: TCP    targetPort: 8080</code></pre><p>ä¸‰æ­¥è¿‡å, ä¸å‡ºæ„å¤–, ä½ å°†å¯ä»¥é€šè¿‡ingress-nginxçš„podå¯¹è±¡ä¸­çš„nginx.confæ–‡ä»¶çœ‹åˆ°tcpçš„è½¬å‘é…ç½®.</p><pre><code class="language-bash">        # TCP services        server &#123;                preread_by_lua_block &#123;                        ngx.var.proxy_upstream_name=&quot;tcp-it-test-it-local-svc-8080&quot;;                &#125;                listen                  8080;                proxy_timeout           600s;                proxy_pass              upstream_balancer;        &#125;</code></pre><h2 id="ingressæ— æ³•åˆ›å»ºï¼ŒæŠ¥æ‰¾ä¸åˆ°æ§åˆ¶å™¨çš„svc">ingressæ— æ³•åˆ›å»ºï¼ŒæŠ¥æ‰¾ä¸åˆ°æ§åˆ¶å™¨çš„svc</h2><pre><code>Error from server (InternalError): error when creating &quot;cms-ingress.yaml&quot;: Internal error occurred: failed calling webhook &quot;validate.nginx.ingress.kubernetes.io&quot;: Post &quot;https://ingress-nginx-controller-admission-nginx.ingress-nginx.svc:443/networking/v1/ingresses?timeout=10s&quot;: service &quot;ingress-nginx-controller-admission-nginx&quot; not found</code></pre><p>ä¸Šè¿°é—®é¢˜ï¼Œå¸¸è§äºé€šè¿‡helmé‡å»ºingress-nginxä¹‹åï¼Œè¿™æ˜¯å› ä¸º<code>ValidatingWebhookConfiguration</code>é™ˆæ—§é…ç½®æ²¡æœ‰è¢«åˆ é™¤ï¼Œä»¥è‡³äºingressæ‰¾åˆ°äº†é”™è¯¯çš„é…ç½®.</p><pre><code class="language-bash">âœ   kubectl get ValidatingWebhookConfigurationNAME                                      WEBHOOKS   AGEingress-nginx-admission                   1          46mingress-nginx-admission-nginx             1          29dingress-nginx-doc-it-local-admission      1          448d</code></pre><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘è¿™é‡Œæœ‰ä¸¤ä¸ªé™ˆæ—§çš„é…ç½®<code>ingress-nginx-admission-nginx </code>å’Œ<code>ingress-nginx-doc-it-local-admission</code>ï¼Œåˆ é™¤å³å¯.</p><h1>ä¼˜é›…æ›´æ–°ingressæ§åˆ¶å™¨</h1><h2 id="å¯åŠ¨ä¸´æ—¶æ§åˆ¶å™¨">å¯åŠ¨ä¸´æ—¶æ§åˆ¶å™¨</h2><p>ä¸´æ—¶æ§åˆ¶å™¨ç”¨äºä¸´æ—¶æ¥æ”¶æµé‡ï¼Œåˆ›å»ºä¸´æ—¶æ§åˆ¶å™¨ï¼Œå¹¶ä¸”ç‰ˆæœ¬å’Œé…ç½®ä¸åŸæ§åˆ¶å™¨ä¸€è‡´ã€‚</p><pre><code class="language-bash">kubectl create ns ingress-nginx-temp# åŸæ§åˆ¶å™¨ç‰ˆæœ¬version=# values.yaml åŸæ§åˆ¶å™¨é…ç½®helm install ingress-nginx-temp ingress-nginx/ingress-nginx --version $&#123;version&#125; -n ingress-nginx-temp -f values.yaml</code></pre><h2 id="åˆ‡æ¢DNSï¼ŒæŒ‡å‘ä¸´æ—¶æ§åˆ¶å™¨">åˆ‡æ¢DNSï¼ŒæŒ‡å‘ä¸´æ—¶æ§åˆ¶å™¨</h2><p>é€šè¿‡è§‚å¯ŸåŸæ§åˆ¶å™¨æ—¥å¿—ï¼Œç­‰å¾…åŸæ§åˆ¶å™¨æµé‡ç»“æŸã€‚</p><h2 id="æ›´æ–°åŸæ§åˆ¶å™¨">æ›´æ–°åŸæ§åˆ¶å™¨</h2><p>æ·»åŠ è¦æ›´æ–°çš„å†…å®¹åˆ° values.yaml</p><pre><code class="language-bash"># æ›´æ–°çš„ç‰ˆæœ¬version=# values.yaml æ›´æ–°åçš„é…ç½®helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx --version $&#123;version&#125; -n ingress-nginx -f values.yaml</code></pre><p>æŸ¥çœ‹ç»“æœ</p><pre><code class="language-bash">kubectl get deployment nginx-ingress-controller -n ingress-nginx -o yaml</code></pre><h2 id="åˆ‡æ¢DNSï¼ŒæŒ‡å‘åŸæ§åˆ¶å™¨">åˆ‡æ¢DNSï¼ŒæŒ‡å‘åŸæ§åˆ¶å™¨</h2><p>é€šè¿‡è§‚å¯Ÿä¸´æ—¶æ§åˆ¶å™¨æ—¥å¿—ï¼Œç­‰å¾…ä¸´æ—¶æ§åˆ¶å™¨æµé‡ç»“æŸ</p><h2 id="åˆ é™¤ä¸´æ—¶æ§åˆ¶å™¨">åˆ é™¤ä¸´æ—¶æ§åˆ¶å™¨</h2><pre><code class="language-bash">helm delete --purge nginx-ingress-temp --namespace ingress-nginx-temphelm delete ns ingress-nginx-temp</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜12-2æœ‰çŠ¶æ€æœåŠ¡StatefulSet</title>
      <link href="posts/4bf29cf0/"/>
      <url>posts/4bf29cf0/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å½“æˆ‘ä»¬æ„å»ºä¸€ä¸ªæœ‰çŠ¶æ€çš„åº”ç”¨çš„æ—¶å€™, ä¾‹å¦‚ mysql / ftp / åŒ…å«sessionçš„ç®¡ç†ç•Œé¢ç­‰. æˆ‘ä»¬å¯èƒ½ä¼šæœ‰ä¸‹åˆ—é¢„æœŸ:</p><ul><li>ç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦ã€‚</li><li>ç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨ã€‚</li><li>æœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œç¼©æ”¾ã€‚</li><li>æœ‰åºçš„ã€ä¼˜é›…çš„åˆ é™¤å’Œç»ˆæ­¢ã€‚</li><li>æœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–°ã€‚</li></ul><p>StatefulSet å°±æ˜¯å¹²è¿™ä¸ªçš„ã€‚ä¸è¿‡åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œå…¶å®æˆ‘ä»¬è¿˜æ˜¯å¾ˆå°‘ä¼šå»ç›´æ¥é€šè¿‡ StatefulSet æ¥éƒ¨ç½²æˆ‘ä»¬çš„æœ‰çŠ¶æ€æœåŠ¡çš„ï¼Œé™¤éä½ è‡ªå·±èƒ½å¤Ÿå®Œå…¨èƒ½å¤Ÿ hold ä½ï¼Œå¯¹äºä¸€äº›ç‰¹å®šçš„æœåŠ¡ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä½¿ç”¨æ›´åŠ é«˜çº§çš„ Operator æ¥éƒ¨ç½²ï¼Œæ¯”å¦‚ etcd-operatorã€prometheus-operator ç­‰ç­‰ï¼Œè¿™äº›åº”ç”¨éƒ½èƒ½å¤Ÿå¾ˆå¥½çš„æ¥ç®¡ç†æœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œè€Œä¸æ˜¯å•çº¯çš„ä½¿ç”¨ä¸€ä¸ª StatefulSet æ¥éƒ¨ç½²ä¸€ä¸ª Pod å°±è¡Œï¼Œå› ä¸ºå¯¹äºæœ‰çŠ¶æ€çš„åº”ç”¨æœ€é‡è¦çš„è¿˜æ˜¯æ•°æ®æ¢å¤ã€æ•…éšœè½¬ç§»ç­‰ç­‰ã€‚</p><h2 id="ä¾‹å­">ä¾‹å­</h2><pre><code class="language-yaml:">apiVersion: v1kind: Servicemetadata:  name: nginx  labels:    app: nginxspec:  ports:  - port: 80    name: web  clusterIP: None  selector:    app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata:  name: webspec:  serviceName: &quot;nginx&quot;  replicas: 2  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: k8s.gcr.io/nginx-slim:0.8        ports:        - containerPort: 80          name: web        volumeMounts:        - name: www          mountPath: /usr/share/nginx/html  volumeClaimTemplates:  - metadata:      name: www    spec:      accessModes: [ &quot;ReadWriteOnce&quot; ]      resources:        requests:          storage: 1Gi</code></pre><ul><li>svcå¯¹è±¡å¿…é¡»å…ˆåˆ›å»º</li><li>StatefulSet.spec.serviceName è®¾å®š svc åç§°</li><li>StatefulSet.spec.volumeClaimTemplates PVCæ¨¡æ¿ï¼Œå¯ä»¥è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªPVC</li></ul><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>Pod æ ‡è¯†ï¼šæ‹¥æœ‰å”¯ä¸€çš„æœ‰åºç´¢å¼•å’Œç¨³å®šçš„ç½‘ç»œèº«ä»½ã€‚pod è¢«éƒ¨ç½²çš„æ—¶å€™å…¶åå­—æ˜¯æŒ‰ç…§<code>&lt;statefulset.name&gt;-&lt;index.num&gt;</code>åˆ›å»ºçš„ï¼Œä¾‹å¦‚(web-0, web-1)ã€‚è¿™ä¸ªåå­—å°±æ˜¯ä»–ä»¬çš„hostnameï¼Œä¸”ä¸ç®¡ pod å¦‚ä½•è°ƒåº¦ï¼Œéƒ½æ°¸ä¸å˜ã€‚</li><li>Service å¿…é¡»æ˜¯ headlessã€‚StatefulSet ä½¿ç”¨ headless ç»“åˆPodæ ‡è¯†æ¥æ„å»º Pod å­åŸŸåã€‚å…¶Podå­åŸŸåæ ¼å¼ï¼š<code>$(statefulset.name)-$(index.name).$(svc.name).$(ns.name).svc.cluster.local</code></li><li>pod ä¸ç®¡æ€ä¹ˆåˆ , podä¸pvcä¹‹é—´çš„å…³ç³»éƒ½ä¸ä¼šæ··ä¹±.</li><li>pod ä¹‹é—´å¯ä»¥é€šè¿‡å›ºå®šçš„Podå­åŸŸåäº’ç›¸è®¿é—®.</li><li>å¯åŠ¨ pod çš„æ—¶å€™, æŒ‰ç…§ç´¢å¼•, ä» 0 å¼€å§‹. ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨. ä¸ä¼šåŒæ—¶å¯åŠ¨å¤šä¸ª. (è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>åˆ é™¤ pod çš„æ—¶å€™, æŒ‰ç…§ç´¢å¼•å€’åºåˆ é™¤, ä»æœ€åä¸€ä¸ªå¼€å§‹, ä¸€ä¸ªä¸€ä¸ªåˆ é™¤. ä¸ä¼šåŒæ—¶åˆ é™¤å¤šä¸ª. (è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>åˆ é™¤ pod çš„æ—¶å€™, pvc å’Œ pv å¹¶ä¸ä¼šåˆ é™¤ã€‚ä¸”PVCçš„åç§°ä¹Ÿæ˜¯æœ‰åºçš„ã€‚$(<a href="http://VCT.name">VCT.name</a>)-$(<a href="http://statefulset.name">statefulset.name</a>)-${index.num}</li></ul><blockquote><p>ä½ å¯ä»¥é€šè¿‡è®¾ç½®statefulsetç®¡ç†ç­–ç•¥, æ¥æ”¹å˜ä¸Šè¿°é»˜è®¤è¡Œä¸º</p><p><a href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy">https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy</a></p><p><code>StatefulSet.spec.podManagementPolicy</code>è®¾å®šä¸ºï¼šParallel ã€‚å°±å¯ä»¥å¹¶å‘çš„åˆ›å»ºPodå’Œåˆ é™¤Pod.</p></blockquote><h2 id="æ‰©å±•-ç¼©æ”¾">æ‰©å±•/ç¼©æ”¾</h2><p>æ‰©å±•: <code>kubectl scale sts web --replicas=5</code></p><p>ç¼©æ”¾: <code>kubectl patch sts web -p '&#123;&quot;spec&quot;:&#123;&quot;replicas&quot;:3&#125;&#125;'</code></p><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œ replicas çš„å€¼æ¥è¿›è¡Œå˜æ›´.</p><h2 id="æ›´æ–°">æ›´æ–°</h2><p>æœ‰çŠ¶æ€åº”ç”¨çš„æ›´æ–°å’Œæ— çŠ¶æ€åº”ç”¨çš„æ›´æ–°æœ‰äº›å·®å¼‚.</p><p>æœ‰çŠ¶æ€åº”ç”¨çš„æ›´æ–°ç­–ç•¥(spec.updateStrategy)æ˜¯ RollingUpdate å’Œ OnDelete. å…¶ä¸­ RollingUpdate æ˜¯é»˜è®¤ç­–ç•¥, è¿™ä¸ªæ˜¯è‡ªåŠ¨æ»šåŠ¨æ›´æ–°. è€ŒOnDeleteçš„æ„æ€æ˜¯åªæœ‰ä½ æ‰‹åŠ¨åˆ é™¤äº†podæ‰ä¼šæ›´æ–°.</p><p>æ›´æ–°æ˜¯é’ˆå¯¹podæ¨¡æ¿çš„. ä¾‹å¦‚:</p><pre><code class="language-bash">kubectl patch statefulset web --type='json' -p='[&#123;&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;gcr.io/google_containers/nginx-slim:0.8&quot;&#125;]'</code></pre><blockquote><p>è¿™é‡Œæ›´æ–°äº†nginxçš„é•œåƒ.</p></blockquote><p>æ›´æ–°éµå¾ªä»¥ä¸‹åŸåˆ™:</p><ul><li><p>æ‰€æœ‰çš„ pod éœ€è¦æ˜¯å°±ç»ªçŠ¶æ€.</p></li><li><p>æ›´æ–°é‡‡ç”¨ç´¢å¼•å€’åºè¿›è¡Œ(å³ä»ç´¢å¼•æœ€åä¸€ä¸ªå·ç å¼€å§‹æ›´æ–°), å¹¶ä¸”æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ›´æ–°.</p></li><li><p>å½“æ›´æ–°å¤±è´¥çš„æ—¶å€™, å·²ç»æ”¶åˆ°æ›´æ–°çš„podå°†ä¿æŒæ›´æ–°åçš„ç‰ˆæœ¬, æ²¡æœ‰å¼€å§‹æ›´æ–°çš„podå°†æ¢å¤åˆ°æ›´æ–°å‰çš„ç‰ˆæœ¬.</p></li></ul><p>ğŸŒŸéœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœä½ çš„æ›´æ–°æ–‡ä»¶(äºŒè¿›åˆ¶æ–‡ä»¶æ•…éšœæˆ–è€…é…ç½®æ–‡ä»¶)æœ‰é—®é¢˜ä»è€Œå¯¼è‡´æ›´æ–°å¤±è´¥, ä½ å¯èƒ½éœ€è¦å¼ºåˆ¶å›æ»š. ä»¥ä¸‹æ˜¯è¯´æ˜ä¿¡æ¯:</p><p>å³ä½ æ¢å¤äº†æ›´æ–°å‰çš„æ¨¡æ¿,å´å‘ç°statefulsetä¾ç„¶ä¸æ­£å¸¸, åˆ™ä½ éœ€è¦<strong>æ‰‹åŠ¨åˆ é™¤</strong>æ‰€æœ‰ç”±é”™è¯¯æ¨¡æ¿äº§å‡ºçš„pod.</p><p>åœ¨è¿™ä¹‹å, statefulsetå°†ä¼šé‡‡ç”¨æ›´æ–°å‰çš„æ¨¡æ¿é‡å»ºpod.</p><p>(<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#forced-rollback">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#forced-rollback</a>)</p><h2 id="é˜¶æ®µæ›´æ–°-staging-an-update">é˜¶æ®µæ›´æ–°(staging an update)</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½å¹¶ä¸æƒ³ä¸€æ¬¡æ›´æ–°æ‰€æœ‰, æ­¤æ—¶å¯ä»¥è¿›è¡Œé˜¶æ®µæ›´æ–°.</p><p>é˜¶æ®µæ›´æ–°çš„æ„æ€å°±æ˜¯é€šè¿‡åœ¨ç´¢å¼•ä¸Šè®¾ç½®ä¸€ä¸ªç‚¹. å½“podçš„ç´¢å¼•å¤§äºç­‰äºè¿™ä¸ªç‚¹çš„æ—¶å€™, æ‰ä¼šæ›´æ–°. (é»˜è®¤ç‚¹æ˜¯ç´¢å¼•0ï¼Œå³æ‰€æœ‰Podéƒ½æ›´æ–°)</p><pre><code class="language-bash">kubectl patch statefulset web -p '&#123;&quot;spec&quot;:&#123;&quot;updateStrategy&quot;:&#123;&quot;type&quot;:&quot;RollingUpdate&quot;,&quot;rollingUpdate&quot;:&#123;&quot;partition&quot;:3&#125;&#125;&#125;&#125;'</code></pre><p>è¿™ä¸ªæ„æ€æ˜¯è®¾ç½®ç´¢å¼•3ä¸ºé˜¶æ®µåˆ†å‰²ç‚¹.</p><p>å¦‚æœä½ æƒ³å›åˆ°é»˜è®¤æ›´æ–°, åˆ™åªéœ€è¦è°ƒæ•´åˆ†å‰²ç‚¹, é‡æ–°æ‰§è¡Œä¸Šè¿°å‘½ä»¤å³å¯.</p><h2 id="åˆ é™¤">åˆ é™¤</h2><p>åˆ é™¤åˆ†ä¸ºè”çº§åˆ é™¤å’Œéè”çº§åˆ é™¤.</p><p>è”çº§åˆ é™¤å°±æ˜¯ statefulset å’Œ pod éƒ½åˆ é™¤. è¿™æ˜¯é»˜è®¤è¡Œä¸º.</p><p>éè”çº§åˆ é™¤, åªä¼šåˆ é™¤ statefulset. ä½ å¯ä»¥é€šè¿‡åˆ é™¤çš„æ—¶å€™é™„åŠ <code>--cascade=false</code>å¼€å¯å®ƒ.</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> StatefulSet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜12-1DaemonSet</title>
      <link href="posts/63d8d3d4/"/>
      <url>posts/63d8d3d4/</url>
      
        <content type="html"><![CDATA[<h1>åŸºç¡€</h1><p>DaemonSet ç¡®ä¿ç¬¦åˆè§„åˆ™çš„ k8s node ä¸Šéƒ½å­˜åœ¨ä¸€ä»½ podã€‚å¸¸ç”¨æ¥æ„å»ºèŠ‚ç‚¹å¸¸é©»æ€§çš„app. ä¾‹å¦‚ç›‘æ§èŠ‚ç‚¹çš„appï¼Œ æˆ–è€…é‡‡é›†èŠ‚ç‚¹æ—¥å¿—çš„appï¼Œä»¥åŠç½‘ç»œappç­‰ã€‚</p><h1>ç‰¹ç‚¹</h1><ul><li><p>è°ƒåº¦åœ¨æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„nodeä¸Šã€‚</p></li><li><p>å½“DaemonSetåˆ›å»ºæˆ–åˆ é™¤ï¼Œ åˆ™æŒ‡å®šèŠ‚ç‚¹ä¸Šçš„ pod éƒ½ä¼šåˆ›å»ºæˆ–åˆ é™¤ã€‚</p></li><li><p>å½“ä¸€ä¸ªç¬¦åˆDaemonSetè§„åˆ™çš„èŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤æˆ–ä»é›†ç¾¤ä¸­åˆ é™¤ï¼Œ åˆ™ pod ä¼šè‡ªåŠ¨è¢«æ·»åŠ /åˆ é™¤ã€‚</p></li><li><p>å½“DaemonSetè¢«åˆ é™¤ï¼Œ åˆ™æŒ‡å®šèŠ‚ç‚¹ä¸Šçš„ pod éƒ½ä¼šè¢«åˆ é™¤.</p></li><li><p>podæ¨¡æ¿ä¸­çš„ RestartPolicy å¿…é¡»æ˜¯é»˜è®¤å€¼ï¼Œ ä¹Ÿå°±æ˜¯ Always.</p></li><li><p>åˆ›å»ºå.spec.selector ä¸å¯ä¿®æ”¹.</p></li></ul><h1>ä¾‹å­</h1><pre><code class="language-yaml">apiVersion: apps/v1kind: DaemonSetmetadata:  name: fluentd-elasticsearch  namespace: kube-system  labels:    k8s-app: fluentd-loggingspec:  selector:    matchLabels:      name: fluentd-elasticsearch  template:    metadata:      labels:        name: fluentd-elasticsearch    spec:      tolerations:      # æ·»åŠ å®¹å¿æ ‡ç­¾ï¼Œå…è®¸å°† Pod è°ƒåº¦åˆ°é™„åŠ äº† NoSchedule çš„ master ä¸»æœº      - key: node-role.kubernetes.io/master        effect: NoSchedule      containers:      - name: fluentd-elasticsearch        image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2        resources:          limits:            memory: 200Mi          requests:            cpu: 100m            memory: 200Mi        volumeMounts:        - name: varlog          mountPath: /var/log        - name: varlibdockercontainers          mountPath: /var/lib/docker/containers          readOnly: true      terminationGracePeriodSeconds: 30      volumes:      - name: varlog        hostPath:          path: /var/log      - name: varlibdockercontainers        hostPath:          path: /var/lib/docker/containers</code></pre><p>è¿™æ˜¯ä¸€ä¸ªæ—¥å¿—é‡‡é›†pod. å®ƒå°†k8sé›†ç¾¤èŠ‚ç‚¹çš„ /var/log å’Œ /var/lib/docker/containers æŒ‚è½½åˆ° pod ä¸­. è¿™æ ·ï¼Œ elasticsearch å°±å¯ä»¥è·å–åˆ°k8sé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯äº†.</p><h1>è°ƒåº¦</h1><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDaemonSetsçš„Podä¼šè°ƒåº¦åˆ°æ¯ä¸€ä¸ªNodeä¸Šã€‚</p><p>ä¸è°ƒåº¦é€‰æ‹©æœ‰å…³çš„çŸ¥è¯†ï¼Œåˆ†ä¸‰ç±»ï¼š</p><ul><li>èŠ‚ç‚¹æ±¡ç‚¹å’ŒPodå®¹å¿åº¦</li><li>èŠ‚ç‚¹æ ‡ç­¾é€‰æ‹©å™¨</li><li>èŠ‚ç‚¹äº²å’Œæ€§</li></ul><h2 id="èŠ‚ç‚¹æ±¡ç‚¹å’Œå®¹å¿åº¦">èŠ‚ç‚¹æ±¡ç‚¹å’Œå®¹å¿åº¦</h2><p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/</a></p><p>k8sé€šè¿‡æ±¡ç‚¹æ¥å‰”é™¤æŸäº›æ•…éšœèŠ‚ç‚¹æˆ–æ„å»ºä¸€äº›ä¸“å±èŠ‚ç‚¹ï¼Œé˜²æ­¢Podè°ƒåº¦åˆ°å­˜åœ¨æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚</p><p>k8sé€šè¿‡å®¹å¿åº¦æ¥ç¡®ä¿æŸäº›podå¯ä»¥å¿½ç•¥æ±¡ç‚¹ï¼Œä»è€Œè°ƒåº¦åˆ°å­˜åœ¨æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚</p><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹. æ²¡æœ‰ä»»ä½•å®¹å¿åº¦çš„podä¸ä¼šè¢«è°ƒåº¦åˆ°å­˜åœ¨æ±¡ç‚¹çš„nodeä¸Š. (å½“å‡ºç°èŠ‚ç‚¹æ•…éšœæ—¶å€™ï¼Œ é»˜è®¤ä¼šé™„åŠ ä¸€ä¸ªå®¹å¿åº¦ï¼Œ å®¹å¿åº¦å¤±æ•ˆ300ç§’)</p><p>DaemonSetä¼šç»™Podè‡ªåŠ¨é™„åŠ å®¹å¿åº¦ï¼Œä»è€Œå¯ä»¥è®©Podä¸€ç›´åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ (æˆªè‡³åˆ°v1.19)ã€‚ä»¥ä¸‹æ˜¯è‡ªåŠ¨é™„åŠ çš„å®¹å¿åº¦ï¼š</p><pre><code class="language-bash">node.kubernetes.io/not-readynode.kubernetes.io/unreachablenode.kubernetes.io/disk-pressurenode.kubernetes.io/memory-pressurenode.kubernetes.io/unschedulablenode.kubernetes.io/network-unavailable</code></pre><p>ä¸Šè¿°æƒ…å†µåŸºæœ¬ä¿è¯äº†DaemonSetçš„podä¸ä¼šå› å„ç§æ„å¤–æƒ…å†µå¯¼è‡´podè¢«é©±é€.</p><h2 id="é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾-nodeSelector-å®ç°éƒ¨åˆ†è°ƒåº¦">é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾(nodeSelector)å®ç°éƒ¨åˆ†è°ƒåº¦</h2><p>é€šè¿‡ä¸‹åˆ—å‘½ä»¤è·çŸ¥èŠ‚ç‚¹æ ‡ç­¾:</p><pre><code class="language-bash">kubectl describe node k8s01Labels:             beta.kubernetes.io/arch=amd64                    beta.kubernetes.io/os=linux                    kubernetes.io/arch=amd64                    kubernetes.io/hostname=k8s01                    kubernetes.io/os=linux                    node-role.kubernetes.io/control-plane=                    node-role.kubernetes.io/master=                    node.kubernetes.io/exclude-from-external-load-balancers=</code></pre><p><code>.spec.template.spec.nodeSelector</code>å¯ä»¥è®©ä½ ä»…åœ¨åŒ¹é…çš„nodeä¸Šåˆ›å»ºpod.</p><p>ä¾‹å¦‚: ä»…è°ƒåº¦åˆ°æ‹¥æœ‰ssdç£ç›˜æ ‡ç­¾çš„èŠ‚ç‚¹</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: nginx  labels:    env: testspec:  containers:  - name: nginx    image: nginx    imagePullPolicy: IfNotPresent  nodeSelector:    disktype: ssd</code></pre><h2 id="é€šè¿‡èŠ‚ç‚¹äº²å’Œæ€§-nodeAffinity-å®ç°éƒ¨åˆ†è°ƒåº¦">é€šè¿‡èŠ‚ç‚¹äº²å’Œæ€§(nodeAffinity)å®ç°éƒ¨åˆ†è°ƒåº¦</h2><p><code>.spec.affinity.nodeAffinity</code> ï¼Œ å®ƒæœ‰ä»¥ä¸‹ç±»å‹: (æ¯ä¸€ä¸ªç±»å‹ç”±ä¸¤éƒ¨åˆ†æ„æ€ç»„æˆ)</p><p>requiredDuringScheduling<strong>IgnoredDuringExecution</strong><br>è¡¨ç¤ºpodå¿…é¡»éƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²åè¿è¡ŒæœŸé—´ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p><p>requiredDuringScheduling<strong>RequiredDuringExecution</strong><br>è¡¨ç¤ºpodå¿…é¡»éƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²åè¿è¡ŒæœŸé—´ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œåˆ™é‡æ–°é€‰æ‹©ç¬¦åˆè¦æ±‚çš„èŠ‚ç‚¹ã€‚</p><p>preferredDuringScheduling<strong>IgnoredDuringExecution</strong><br>è¡¨ç¤ºä¼˜å…ˆéƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p><p>preferredDuringScheduling<strong>RequiredDuringExecution</strong><br>è¡¨ç¤ºä¼˜å…ˆéƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºå¦‚æœåé¢èŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œæ»¡è¶³äº†æ¡ä»¶ï¼Œåˆ™é‡æ–°è°ƒåº¦åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ã€‚</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: with-node-affinityspec:  affinity:    nodeAffinity:      requiredDuringSchedulingIgnoredDuringExecution:        nodeSelectorTerms:        - matchExpressions:          - key: kubernetes.io/e2e-az-name            operator: In            values:            - e2e-az1            - e2e-az2      preferredDuringSchedulingIgnoredDuringExecution:      - weight: 1        preference:          matchExpressions:          - key: another-node-label-key            operator: In            values:            - another-node-label-value  containers:  - name: with-node-affinity    image: gcr.io/google_containers/pause:2.0</code></pre><p>è¿™ä¸ªé…ç½®çš„æ„æ€æ˜¯podã€å¿…é¡»è¢«è°ƒåº¦ã€‘åˆ°æ‹¥æœ‰æ ‡ç­¾ã€<a href="http://kubernetes.io/e2e-az-name=e2e-az1%E6%88%96kubernetes.io/e2e-az-name=e2e-az2%E3%80%91">kubernetes.io/e2e-az-name=e2e-az1æˆ–kubernetes.io/e2e-az-name=e2e-az2ã€‘</a> çš„èŠ‚ç‚¹ã€‚ä¸æ­¤åŒæ—¶ï¼Œ è¿˜å°†åœ¨ä¸Šè¿°æ¡ä»¶çš„åŸºç¡€ä¸Šï¼Œ <strong>ä¼˜å…ˆè°ƒåº¦</strong>åˆ°é¢å¤–æ‹¥æœ‰æ ‡ç­¾ä¸ºanother-node-label-key=another-node-label-valueçš„èŠ‚ç‚¹ä¸Šã€‚</p><h1>è®¿é—®</h1><p>ä½ å¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ª Headless Service å¹¶é€šè¿‡ endpoint  æ¥è®¿é—®å„ä¸ª pod.</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> DaemonSet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜11-2namespaceèµ„æºçº¦æŸLimitRange</title>
      <link href="posts/ed4c29d5/"/>
      <url>posts/ed4c29d5/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬">åŸºæœ¬</h2><p><a href="https://kubernetes.io/docs/concepts/policy/limit-range/">https://kubernetes.io/docs/concepts/policy/limit-range/</a></p><p>namespace èµ„æºçº¦æŸ(LimitRange)æä¾›é»˜è®¤çš„Podèµ„æºçº¦æŸï¼Œå¹¶é˜²æ­¢å‘½åç©ºé—´å†…çš„Podèµ„æºé…ç½®è¶…å‡ºç®¡ç†å‘˜å…è®¸çš„é¢„æœŸèŒƒå›´ã€‚è‹¥è¶…å‡ºåˆ™ä¸å…è®¸åˆ›å»ºï¼Œä»è€Œè®©æˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿çš„ç®¡ç†èµ„æº.</p><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>æä¾› pod çš„é»˜è®¤ request çº¦æŸ.</li><li>æä¾› pod çš„é»˜è®¤ limit çº¦æŸ.</li><li>æä¾›é»˜è®¤çš„ pvc.</li><li>LimitRangeé…ç½®ç­–ç•¥çš„æ„å»ºå’Œå˜æ›´ä»…å½±å“ä¹‹åçš„podåˆ›å»ºã€‚å·²åˆ›å»ºPodä¸å—å½±å“ã€‚</li></ul><h3 id="å†™æ³•">å†™æ³•</h3><pre><code class="language-yaml">apiVersion: v1kind: LimitRangemetadata:  name: cpu-mem-storage-min-max-defaultspec:  limits:  - type: Container    max:      cpu: &quot;1000m&quot;      memory: &quot;1G&quot;    min:      cpu: &quot;50m&quot;      memory: &quot;50M&quot;    default:      cpu: &quot;250m&quot;      memory: &quot;250M&quot;    defaultRequest:      cpu: &quot;50m&quot;      memory: &quot;50M&quot;  - type: PersistentVolumeClaim    max:      storage: 30G    min:      storage: 8G</code></pre><pre><code class="language-bash">kubectl apply -f limitrange-default.yaml --namespace=default</code></pre><p>ä¸Šè¿°çš„æ„æ€åŸºæœ¬éµå¾ªï¼š</p><ul><li>ä¸è®¾ç½®Podçº¦æŸï¼Œåˆ™Podçº¦æŸlimitçº§èµ°defaultï¼ŒPodçº¦æŸrequestçº§èµ°defaultRequest</li><li>è®¾ç½®Podçº¦æŸï¼Œåˆ™Podçº¦æŸä¸èƒ½ä½äºminï¼Œä¸èƒ½å¤§äºmaxï¼Œä¸”requestçº§ä¸èƒ½å¤§äºlimitçº§.</li><li>åœ¨ç»§æ‰¿ä¸Šè¿°æ¡ä»¶çš„åŸºç¡€ä¸‹ï¼Œè‹¥Podåªè®¾ç½®äº†limitçº¦æŸï¼Œåˆ™Podçš„requestçº¦æŸç›´æ¥ç­‰åŒäºPodçš„limitçº¦æŸ</li></ul><p>ä¸Šè¿°ä¾‹å­ä¸º default å‘½åç©ºé—´åŠ äº†ä¸€ä¸ªèµ„æºç­–ç•¥.æ•ˆæœå¦‚ä¸‹:</p><ul><li><p>å½“podæ²¡æœ‰ä»»ä½•é™åˆ¶çš„æ—¶å€™, pod è§„åˆ™å¦‚ä¸‹éµå¾ª default å’Œ defaultRequest çš„å±æ€§</p><ul><li><p>limit: cpu=250m mem=250M</p></li><li><p>request: cpu=50m mem=50M</p></li><li><p>8G &lt; pvc &lt; 30G</p><p>ä¼šå…¨éƒ¨èµ°limitrangeçš„é»˜è®¤å€¼</p></li></ul></li><li><p>å½“podä»…è®¾ç½®äº†request: cpu=100m mem=150Mçš„æ—¶å€™, podè§„åˆ™å¦‚ä¸‹</p><ul><li>limit: cpu=250m mem=250M</li><li>request: cpu=100m mem=150M</li><li>8G &lt; pvc &lt; 30G</li></ul></li><li><p>å½“podä»…è®¾ç½®äº†limitï¼Œä¸”limitå€¼ä¸è¶…è¿‡namespaceçš„maxçš„æ—¶å€™, podè§„åˆ™å¦‚ä¸‹</p><blockquote><p>å‡è®¾è¿™é‡Œpodçš„limitæ˜¯ cpu=1000m mem=1G</p></blockquote><ul><li>limit: cpu=1000m mem=1G</li><li>request: cpu=1000m mem=1G</li><li>8G &lt; pvc &lt; 30G</li></ul><p>å³ä»…å½“è®¾ç½®limitçº§çš„Podçº¦æŸæ—¶ï¼Œrequestçº§Podçº¦æŸç­‰åŒäºlimitçº§</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> èµ„æºçº¦æŸ </tag>
            
            <tag> namespace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜11-1podèµ„æºçº¦æŸ</title>
      <link href="posts/64fa9c84/"/>
      <url>posts/64fa9c84/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬">åŸºæœ¬</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</a></p><p>èµ„æºçº¦æŸåœ¨æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„æ—¶å€™ä¸»è¦æ˜¯cpuå’Œå†…å­˜å±‚é¢, ä»¥åŠæœ¬åœ°ä¸´æ—¶å­˜å‚¨(emptyDir)</p><p>k8sèµ„æºçº¦æŸåˆ†ä¸ºä¸¤ç§: request(è½¯çº¦æŸ) å’Œ limits(ç¡¬çº¦æŸ)</p><p>k8sé€šè¿‡request(è½¯çº¦æŸ)å°†Podè°ƒåº¦åˆ°æœ‰èµ„æºçš„Nodeä¸Šï¼Œç¡®ä¿äº†podä¸­çš„å®¹å™¨è‡³å°‘å¯ä»¥ä½¿ç”¨è¿™ä¹ˆå¤šèµ„æº. ä¸è¿‡å½“èŠ‚ç‚¹å¦‚æœæ²¡æœ‰å…¶å®ƒå®¹å™¨,åˆ™æ­¤å®¹å™¨å¯ä»¥çªç ´requesté™åˆ¶.</p><p>k8sé€šè¿‡limits(ç¡¬çº¦æŸ) å°†è°ƒåº¦å®Œæ¯•çš„Podæ‰€ä½¿ç”¨çš„èµ„æºé™åˆ¶åœ¨limitsä¹‹å†…ã€‚å¦‚æœå®¹å™¨è¯·æ±‚çš„å†…å­˜å¤§äºäº†limits,åˆ™ä¼šæ”¶åˆ°oomé”™è¯¯ã€‚</p><blockquote><p>å¦‚æœåªè®¾ç½®äº†limitsï¼Œåˆ™k8sä¼šå°†requestçš„å€¼è‡ªåŠ¨è®¾ç½®ä¸ºå’Œlimitsä¸€è‡´ã€‚</p></blockquote><h2 id="å†™æ³•">å†™æ³•</h2><ul><li><code>spec.containers[].resources.limits.cpu </code>cpué™åˆ¶</li><li><code>spec.containers[].resources.limits.memory</code> å†…å­˜é™åˆ¶</li><li><code>spec.containers[].resources.limits.hugepages-&lt;size&gt;</code>   ä¸å¸¸ç”¨, å¯ä»¥å¿½ç•¥</li><li><code>spec.containers[].resources.limits.ephemeral-storage</code> emptyä¸´æ—¶å­˜å‚¨é™åˆ¶</li><li><code>spec.containers[].resources.requests.cpu</code></li><li><code>spec.containers[].resources.requests.memory</code></li><li><code>spec.containers[].resources.requests.hugepages-&lt;size&gt; </code> ä¸å¸¸ç”¨, å¯ä»¥å¿½ç•¥</li><li><code>spec.containers[].resources.requests.ephemeral-storage</code></li></ul><h2 id="å•ä½">å•ä½</h2><p>k8så°†ä¸€ä¸ªè¶…çº¿ç¨‹ç§°ä¸ºä¸€ä¸ªvcpu. 1vcpu=1000m. æˆ‘ä»¬åœ¨å®šä¹‰èµ„æºé™åˆ¶æ—¶, åº”è¯¥å§‹ç»ˆç”¨ m ä½œä¸ºå•ä½.å‡è®¾ä½ é™åˆ¶0.5ä¸ªvcpu,åˆ™å¡«å†™500m.</p><p>k8sçš„å†…å­˜å’Œä¸´æ—¶å­˜å‚¨å•ä½å’Œå¹³æ—¶æˆ‘ä»¬æ‰€ç”¨çš„æ²¡ä»€ä¹ˆåŒºåˆ«. ä½ åªéœ€è¦è®°ä½ K/M/G/T/P/E è¿™äº›å³å¯. ä¾‹å¦‚, 100Må°±æ˜¯100å…†</p><p>ä¸€ä¸ªä¾‹å­:</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: frontendspec:  containers:  - name: app    image: images.my-company.example/app:v4    resources:      requests:        memory: &quot;64M&quot;        cpu: &quot;250m&quot;        ephemeral-storage: &quot;2Gi&quot;      limits:        memory: &quot;128M&quot;        cpu: &quot;500m&quot;        ephemeral-storage: &quot;4Gi&quot;  - name: log-aggregator    image: images.my-company.example/log-aggregator:v6    resources:      requests:        memory: &quot;64M&quot;        cpu: &quot;250m&quot;        ephemeral-storage: &quot;2Gi&quot;      limits:        memory: &quot;128M&quot;        cpu: &quot;500m&quot;        ephemeral-storage: &quot;4Gi&quot;</code></pre><h2 id="èµ„æºé™åˆ¶å¦‚ä½•è¿ä½œ">èµ„æºé™åˆ¶å¦‚ä½•è¿ä½œ</h2><p>k8sä¼šé€šè¿‡kubeletå°†podå®šä¹‰çš„èµ„æºé™åˆ¶ä¼ é€’ç»™å®¹å™¨.</p><p>å¦‚æœä½ å®¹å™¨ä½¿ç”¨çš„æ˜¯docker.</p><p>cpuè½¯é™åˆ¶å°†å¯¹æ ‡dockerçš„â€“cpu-shares. è€Œcpuç¡¬é™åˆ¶ä¼šå‘Šè¯‰å®¹å™¨æ¯100mså¯ä»¥ä½¿ç”¨çš„CPUæ—¶é—´æ€»é‡æ˜¯  limits.cpu * 100.</p><blockquote><p>å…³äºdockerçš„â€“cpu-shares, å¯ä»¥å‚è€ƒhttps://docs.docker.com/engine/reference/run/#cpu-share-constraint</p><p>æ€»çš„æ¥è¯´, --cpu-shares ä¼šè®©å®¹å™¨æŒ‰ç…§æ‰€è®¾å®šçš„åˆ†å€¼æ¯”ä¾‹å»ä½¿ç”¨cpu.ä¸è¿‡, åœ¨å¤šæ ¸å¿ƒèŠ‚ç‚¹ä¸Š, è¿™ä¸ªè§„åˆ™åˆä¸æ˜¯å¾ˆé€‚ç”¨. æŒ‰ç…§å®˜æ–¹çš„è¯´æ³•, å½“å¤šæ ¸å¿ƒcpuçš„æ—¶å€™,å®ƒçš„è§„åˆ™æ˜¯:</p><p>On a multi-core system, the shares of CPU time are distributed over all CPU cores. Even if a container is limited to less than 100% of CPU time, it can use 100% of each individual CPU core.</p><p>For example, consider a system with more than three cores. If you start one container <code>&#123;C0&#125;</code> with <code>-c=512</code> running one process, and another container <code>&#123;C1&#125;</code> with <code>-c=1024</code> running two processes, this can result in the following division of CPU shares:</p><pre><code>PID    containerCPUCPU share100    &#123;C0&#125;0100% of CPU0101    &#123;C1&#125;1100% of CPU1102    &#123;C1&#125;2100% of CPU2</code></pre><p>è¿™é‡Œä¸‰ä¸ªå®¹å™¨,éƒ½æ˜¯å•æ ¸å¿ƒç¨‹åº</p></blockquote><p>å†…å­˜çš„é™åˆ¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«éœ€è¦æ³¨æ„çš„.</p><h2 id="å®¹å™¨ä¸­çš„å¯è§èµ„æº">å®¹å™¨ä¸­çš„å¯è§èµ„æº</h2><p>é»˜è®¤æƒ…å†µä¸‹,ä¸ç®¡ä½ å¦‚ä½•è®¾ç½®èµ„æºé™åˆ¶,å®¹å™¨é‡Œçš„å¯è§èµ„æºéƒ½ç­‰äºèŠ‚ç‚¹èµ„æº.ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨å®¹å™¨é‡ŒæŸ¥çœ‹/proc/meminfoæ˜¾ç¤ºçš„èµ„æºå¹¶ä¸æ˜¯ä½ è®¾ç½®çš„.è¿™ä¸ªé—®é¢˜ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦.</p><p>å› ä¸ºå¾ˆå¤šç¨‹åºçš„å‚æ•°éƒ½æ˜¯æ ¹æ®å¯è§èµ„æºæ¥è®¾å®šçš„.ä¾‹å¦‚nginxçš„auto, æˆ–è€…jvmé‡Œçš„å†…å­˜å‚æ•°.</p><blockquote><p>ä» Java 8u191å¼€å§‹, jvm å·²ç»é»˜è®¤å®ç°äº†å®¹å™¨æ„ŸçŸ¥( -XX:+UseContainerSupport). å› æ­¤æ— éœ€å®‰è£…ä¸‹é¢çš„ lxcfs æ–¹æ¡ˆ.</p><p>å¹¶ä¸”, åœ¨å®¹å™¨ä¸­å»ºè®®åªè®¾ç½®å¦‚ä¸‹å†…å­˜å‚æ•°:</p><p>-XX:MaxRAMPercentage  æœ€å¤§å †å†…å­˜=ç‰©ç†å†…å­˜ç™¾åˆ†æ¯”, å»ºè®®ä¸ºå®¹å™¨é™åˆ¶çš„50%-75% . æ¯•ç«Ÿè¿˜éœ€è¦é¢„ç•™å…¶å®ƒå†…å­˜.</p></blockquote><p>è€Œç¤¾åŒºå¸¸è§çš„ä½œæ³•æ˜¯ç”¨<code>lxcfs</code> æ¥æå‡èµ„æºçš„å¯è§æ€§.<code>lxcfs</code> æ˜¯ä¸€ä¸ªå¼€æºçš„FUSEï¼ˆç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼‰å®ç°æ¥æ”¯æŒLXCå®¹å™¨, å®ƒä¹Ÿå¯ä»¥æ”¯æŒDockerå®¹å™¨.</p><p>LXCFSé€šè¿‡ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ, åœ¨å®¹å™¨ä¸­æä¾›ä¸‹åˆ— <code>procfs</code> çš„æ–‡ä»¶.</p><pre><code class="language-bash">/proc/cpuinfo/proc/diskstats/proc/meminfo/proc/stat/proc/swaps/proc/uptime</code></pre><p>ä¸æˆ‘ä»¬èµ„æºé™åˆ¶æœ‰å…³çš„, ä¸»è¦æ˜¯ cpuinfo å’Œ meminfo.</p><p>ç›®å‰ç¤¾åŒºçš„åšæ³•å¦‚ä¸‹:</p><ol><li><p>æ‰€æœ‰èŠ‚ç‚¹å®‰è£… fuse-libs åŒ….</p><pre><code class="language-bash">yum install -y fuse-libs</code></pre></li><li><p>å®‰è£…éƒ¨ç½²lxcfs</p><pre><code class="language-bash">git clone https://github.com/denverdino/lxcfs-admission-webhook.gitcd lxcfs-admission-webhookvim deployment/lxcfs-daemonset.yaml=== ä¿®æ­£é…ç½®é‡Œçš„ apiVersion=== å½“å‰gité‡Œçš„ä»£ç æ˜¯é™ˆæ—§çš„...ä»£ç é‡Œçš„ç‰ˆæœ¬åœ¨ 1.18 å·²ç»è¢«åºŸå¼ƒ). å…·ä½“å½’å±äºä»€ä¹ˆç‰ˆæœ¬, è¯·å‚è€ƒk8så®˜æ–¹apiæ–‡æ¡£ === https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#daemonset-v1-appsapiVersion:apps/v1  kubectl apply -f deployment/lxcfs-daemonset.yamlkubectl get pod#ç­‰å¾… lxcfs pod çŠ¶æ€æˆ running#å¦‚æœä½ å‘ç° pod å§‹ç»ˆå‡ºé”™ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼škubectl delete -f deployment/lxcfs-daemonset.yamlrm -rf /var/lib/lxcfskubectl apply -f deployment/lxcfs-daemonset.yamldeployment/install.shkubectl get secrets,pods,svc,mutatingwebhookconfigurations=== æŸ¥çœ‹å„ä¸ªå¯¹è±¡çŠ¶æ€</code></pre></li><li><p>ç»™ç›¸å…³namespaceæ³¨å…¥lxcfsï¼Œä¾‹å¦‚default</p><pre><code class="language-bash">kubectl label namespace default lxcfs-admission-webhook=enabled</code></pre></li><li><p>é‡å¯æ·»åŠ äº†èµ„æºé™åˆ¶çš„pod, æ­¤æ—¶ /proc/cpuinfo å’Œ /proc/meminfo å°†ä¼šæ­£ç¡®æ˜¾ç¤º.</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
            <tag> èµ„æºçº¦æŸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜10åº”ç”¨é…ç½®ä¸å¯†ç ä¸ä¿¡æ¯æä¾›</title>
      <link href="posts/4b0e4a5/"/>
      <url>posts/4b0e4a5/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>åœ¨Podä¸­åº”ç”¨é…ç½®å’Œå¯†ç ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºé…ç½®å¯¹è±¡ConfigMapå’Œå¯†ç å¯¹è±¡Secretã€‚</p><p>è€Œè¿™ä¸¤ç§å¯¹è±¡çš„ä½¿ç”¨æœ‰å¤šç§æ–¹å¼ï¼š</p><ul><li>å­˜å‚¨å·æ–¹å¼</li><li>ç¯å¢ƒå˜é‡æ–¹å¼</li><li>å‘½ä»¤è¡Œæ–¹å¼</li></ul><h1>éåŠ å¯†ConfigMap</h1><p><a href="https://kubernetes.io/docs/concepts/configuration/configmap/">https://kubernetes.io/docs/concepts/configuration/configmap/</a></p><p>ConfigMap å¸¸ç”¨åœ¨ä¸¤ç§æƒ…å†µä¸­. ç¬¬ä¸€ç§æ˜¯æä¾›ç¯å¢ƒå˜é‡.ç¬¬äºŒç§æ˜¯æä¾›é…ç½®æ–‡ä»¶</p><h2 id="å†™æ³•">å†™æ³•</h2><pre><code class="language-yaml">kind: ConfigMapapiVersion: v1metadata:  name: cm-demo  namespace: defaultdata:  data.1: hello  data.2: world  nginx.conf: |    property.1=value-1    property.2=value-2    property.3=value-3immutable: true</code></pre><pre><code class="language-yaml">immutable: true è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªä¸å¯å˜æ›´çš„CMï¼Œä¸€æ—¦CMåˆ›å»ºï¼Œåˆ™è¿™ä¸ªå±æ€§ä¸å¯æ›´æ”¹ã€‚æ„å‘³ç€å¦‚æœä½ è¦æ›´æ”¹ï¼Œåˆ™éœ€è¦åˆ é™¤CMå’Œè°ƒç”¨CMçš„Podã€‚</code></pre><p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ åŒ…å«ä¸¤ç§å†™æ³•</p><ul><li>ç¯å¢ƒå˜é‡</li></ul><pre><code class="language-yaml">  data.1: hello  data.2: world</code></pre><ul><li>é…ç½®æ–‡ä»¶</li></ul><pre><code class="language-yaml">  nginx.conf: |    property.1=value-1    property.2=value-2    property.3=value-3</code></pre><p>nginx.config æ˜¯æ–‡ä»¶åï¼Œ ç®¡é“ç¬¦ | ä¸‹é¢æ˜¯æ–‡ä»¶å†…å®¹.</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ å†…å®¹ä¾ç„¶è¦éµå¾ª yaml çš„ç¼©è¿›è§„åˆ™</p><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><p>Podè°ƒç”¨ç¤ºä¾‹</p><pre><code class="language-yaml">    spec:      containers:      - name: nginx        image: nginx        command: [&quot;/bin/sh&quot;ï¼Œ &quot;-c&quot;ï¼Œ &quot;echo $&#123;DATA.1&#125; $&#123;DATA.2&#125;&quot;]        ports:        - containerPort: 80        env:        - name: DATA1          valueFrom:            configMapKeyRef:              name: cm-demo  # è¿™æ˜¯ConfigMapåï¼Œè€Œä¸æ˜¯configMapä¸´æ—¶å·.              key: data.1    # è¿™æ˜¯ConfigMapé‡Œçš„key        - name: DATA2          valueFrom:            configMapKeyRef:              name: cm-demo              key: data.2        volumeMounts:        - name: cm-demo-vc          subPath: nginx.conf          mountPath: /etc/nginx/nginx.conf      volumes:      - name: cm-demo-vc        configMap:          name: cm-demo</code></pre><p>ä¸Šè¿°subPathæ–¹å¼ï¼Œè™½ç„¶å¯ä»¥æŒ‚è½½ä¸€ä¸ªå•ä¸€é…ç½®å¯¹è±¡åˆ°å…·ä½“çš„æ–‡ä»¶ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼é…ç½®å¯¹è±¡æ›´æ–°ä¸ä¼šåŒæ­¥åˆ°å®¹å™¨ä¸­ã€‚</p><h3 id="ä»…éƒ¨åˆ†keyåŒæ­¥åˆ°æŒ‚è½½ç‚¹">ä»…éƒ¨åˆ†keyåŒæ­¥åˆ°æŒ‚è½½ç‚¹</h3><pre><code class="language-yaml">      volumeMounts:      - name: config        mountPath: &quot;/config&quot;  # ConfigMapå¯¹è±¡keyçš„æ–‡ä»¶æ ¹è·¯å¾„ã€‚        readOnly: true  volumes:    - name: config      configMap:        name: game-demo        # æŒ‡å®šä¸€ä¸ªæ•°ç»„ï¼Œä»…å°†æ•°ç»„é‡Œåˆ—å‡ºçš„ConfigMapå¯¹è±¡keyåˆ›å»ºä¸ºæ–‡ä»¶ã€‚        items:        - key: &quot;game.properties&quot;  # ConfigMapå¯¹è±¡key          path: &quot;game.properties&quot; # æ–‡ä»¶å        - key: &quot;user-interface.properties&quot;          path: &quot;user-interface.properties&quot;</code></pre><h3 id="ä¸´æ—¶å·">ä¸´æ—¶å·</h3><ul><li>é€šè¿‡åœ¨ spec.volumes.configMap ä¸­å®šä¹‰ä¸´æ—¶å· cm-demo-vcã€‚</li><li>ç„¶åé€šè¿‡ spec.containers.volumeMounts æŒ‚è½½ä¸´æ—¶å·ã€‚</li><li>è¿™ç§æ–¹å¼ä¸‹ConfigMapæ›´æ–°åï¼Œpodå†…æŒ‚è½½çš„ä¹Ÿä¼šåŒæ—¶æ›´æ–°ã€‚ï¼ˆæ›´æ–°é€Ÿåº¦å¹¶ä¸æ˜¯ç«‹é©¬å°±èƒ½å“åº”ï¼Œä¹Ÿæ˜¯è½®è¯¢æ›´æ–°ï¼‰ï¼Œè€Œä¸”ä»…é™äºæ²¡æœ‰ä½¿ç”¨subPathçš„æ–¹å¼ã€‚</li></ul><p>ğŸ’¢éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŒ‚è½½ç‚¹éœ€è¦é˜²æ­¢å®¹å™¨ç›®å½•é‡ŒåŸæœ‰çš„æ–‡ä»¶è¢«æ¸…é™¤ã€‚</p><h3 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</h3><ul><li>é€šè¿‡åœ¨ spec.containers.env ä¸­å®šä¹‰. ä¾‹å­ä¸­ï¼Œ DATA1 æ˜¯ç¯å¢ƒå˜é‡åï¼Œ DATA1çš„å€¼é€šè¿‡valueFromå®šä¹‰.æœ€ç»ˆï¼Œä½ å¯ä»¥åœ¨å®¹å™¨ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡DATA1å’ŒDATA2</li><li>è¿™ç§æ–¹å¼ä¸‹ConfigMapæ›´æ–°åï¼Œç¯å¢ƒå˜é‡ä¸ä¼šæ›´æ–°ã€‚</li></ul><h1>åŠ å¯†Secret</h1><p><a href="https://kubernetes.io/docs/concepts/configuration/secret/">https://kubernetes.io/docs/concepts/configuration/secret/</a></p><p>secretå¯¹è±¡é‡Œçš„å€¼éœ€è¦å†™å…¥åŠ å¯†åçš„.</p><h2 id="å†™æ³•-2">å†™æ³•</h2><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç”¨æˆ·å¯†ç å¯¹ï¼Œåˆ†åˆ«æ—¶usernameå’Œpassword</p><p>secretå¯¹è±¡è¦æ±‚å€¼å¿…é¡»è¿›è¡Œbase64ç¼–ç åŠ å¯†(å½“typeä¸ºOpaqueçš„æ—¶å€™).</p><pre><code class="language-bash">[root@k8s00 test-yaml]# echo -n &quot;admin&quot; | base64YWRtaW4=[root@k8s00 test-yaml]# echo -n &quot;admin321&quot; | base64YWRtaW4zMjE=</code></pre><pre><code class="language-yaml"># åˆ›å»º secret å¯¹è±¡ mysecretapiVersion: v1kind: Secretmetadata:  name: mysecret  namespace: defaulttype: Opaquedata:  username: YWRtaW4=  password: MWYyZDFlMmU2N2Rm</code></pre><p>ğŸ‘€<code>type</code>ç”¨æ¥å®šä¹‰ä¸åŒçš„ç±»å‹ï¼Œä¾‹å¦‚:</p><ul><li><code>Opaque</code> æ™®é€šåŠ å¯†å­—ç¬¦ä¸²</li><li><code>kubernetes.io/tls</code> tlsè¯ä¹¦</li><li><code>kubernetes.io/dockerconfigjson</code> dockerä»“åº“è´¦æˆ·å¯†ç </li><li><code>kubernetes.io/service-account-token</code> æœåŠ¡è´¦æˆ·æˆæƒtoken</li></ul><h2 id="ä½¿ç”¨-2">ä½¿ç”¨</h2><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: mypodspec:  containers:  - name: mypod    image: busybox    command:    - sleep    - &quot;3600&quot;    env:      - name: SECRET_USERNAME        valueFrom:          secretKeyRef:            name: mysecret            key: username      - name: SECRET_PASSWORD        valueFrom:          secretKeyRef:            name: mysecret            key: password    volumeMounts:    - name: mysecret-vol      mountPath: &quot;/etc/foo&quot;      readOnly: true  volumes:  - name: mysecret-vol    secret:      secretName: mysecret</code></pre><h3 id="ä¸´æ—¶å·-2">ä¸´æ—¶å·</h3><ul><li>é€šè¿‡åœ¨ spec.volumes.secret ä¸­å®šä¹‰ä¸´æ—¶å· mysecret-volã€‚</li><li>å‰©ä½™ç”¨æ³•å’Œ spec.volumes.configMap ä¸€æ ·ã€‚</li></ul><h3 id="ç¯å¢ƒå˜é‡-2">ç¯å¢ƒå˜é‡</h3><ul><li>é€šè¿‡åœ¨ spec.containers.env ä¸­å®šä¹‰ã€‚</li></ul><h3 id="æµ‹è¯•">æµ‹è¯•</h3><p>åœ¨é€šè¿‡ä¸Šè¿°é…ç½®åˆ›å»ºå¥½èµ„æºåï¼Œæˆ‘ä»¬è¿›å…¥podï¼Œè¿›è¡Œæµ‹è¯•.</p><pre><code class="language-bash">[root@k8s00 test-yaml]# kubectl exec -it mypod -- /bin/sh===å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªåŠ å¯†ä¿¡æ¯ç”Ÿæˆäº†ä¸¤ä¸ªè½¯è¿æ¥ï¼Œå¹¶æŒ‡å‘äº†éšè—æ–‡ä»¶/ # ls -l /etc/foototal 0lrwxrwxrwx    1 root     root            15 Sep 17 07:18 password -&gt; ..data/passwordlrwxrwxrwx    1 root     root            15 Sep 17 07:18 username -&gt; ..data/username===ç¯å¢ƒå˜é‡/ # echo $&#123;SECRET_USERNAME&#125;admin===æ–‡ä»¶æ–¹å¼/ # cat /etc/foo/usernameadmin </code></pre><h1>é™åˆ¶</h1><ul><li>èµ„æºå’ŒPodé™åˆ¶åœ¨åŒä¸€å‘½åç©ºé—´</li><li>å¯¹è±¡æ•°æ®å¤§å°ä¸èƒ½è¶…è¿‡1MB</li><li>å½“podå¼•ç”¨ä¸å­˜åœ¨çš„å¯¹è±¡æ—¶ï¼Œpodæ— æ³•å¯åŠ¨</li></ul><h1>å…¶å®ƒ</h1><ol><li><p>å‘½ä»¤æ–¹å¼åˆ›å»º</p><p>kubectl create configmap/secret <name> xxx</name></p><p>è¿™é‡Œxxxå¯ä»¥ç”¨ä¸¤ç§æ–¹å¼:</p><ul><li>â€“from-literal=<key>=<value> æŒ‡å®škv</value></key></li><li>â€“from-file=&lt;æ–‡ä»¶/ç›®å½•&gt; å½“ä¸ºç›®å½•çš„æ—¶å€™ï¼Œä¼šé€’å½’å°†ç›®å½•é‡Œçš„æ–‡ä»¶éƒ½å†™å…¥å¯¹è±¡ä¸­</li></ul></li><li><p>åœ¨Podä¸­éšè—é…ç½®æˆ–è€…å¯†ç æ–‡ä»¶</p><p>ä½ å¯ä»¥å°† <code>secret.data.&lt;key&gt;</code> å†™æˆ <code>secret.data.&lt;.key&gt;</code> æ¥éšè—å®ƒ.</p></li></ol><h1>ä¿¡æ¯æä¾›Downward API</h1><p><a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/">https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/</a></p><p>Downward APIç”¨æ¥å‘Podä¸­è¿è¡Œçš„å®¹å™¨å…¬å¼€æä¾›å®¹å™¨å’ŒPodçš„ä¿¡æ¯ã€‚</p><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­: å°†èµ„æºé™åˆ¶æ•°æ®æŒ‚è½½åˆ°å®¹å™¨/etc/podinfo</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: kubernetes-downwardapi-volume-example-2spec:  containers:    - name: client-container      image: k8s.gcr.io/busybox:1.24      command: [&quot;sh&quot;ï¼Œ &quot;-c&quot;]      args:      - while true; do          echo -en '\n';          if [[ -e /etc/podinfo/cpu_limit ]]; then            echo -en '\n'; cat /etc/podinfo/cpu_limit; fi;          if [[ -e /etc/podinfo/cpu_request ]]; then            echo -en '\n'; cat /etc/podinfo/cpu_request; fi;          if [[ -e /etc/podinfo/mem_limit ]]; then            echo -en '\n'; cat /etc/podinfo/mem_limit; fi;          if [[ -e /etc/podinfo/mem_request ]]; then            echo -en '\n'; cat /etc/podinfo/mem_request; fi;          sleep 5;        done;      resources:        requests:          memory: &quot;32Mi&quot;          cpu: &quot;125m&quot;        limits:          memory: &quot;64Mi&quot;          cpu: &quot;250m&quot;      volumeMounts:        - name: podinfo          mountPath: /etc/podinfo  volumes:    - name: podinfo      downwardAPI:        items:          - path: &quot;cpu_limit&quot;            resourceFieldRef:              containerName: client-container              resource: limits.cpu              divisor: 1m          - path: &quot;cpu_request&quot;            resourceFieldRef:              containerName: client-container              resource: requests.cpu              divisor: 1m          - path: &quot;mem_limit&quot;            resourceFieldRef:              containerName: client-container              resource: limits.memory              divisor: 1Mi          - path: &quot;mem_request&quot;            resourceFieldRef:              containerName: client-container              resource: requests.memory              divisor: 1Mi</code></pre><h1>projected volumeä½¿ç”¨æ–¹å¼</h1><p>kubernetes æä¾›äº†ä¸€ç§å·ç±»å‹ projected volumeã€‚å¯ä»¥å°†å¤šä¸ªvolumeæŒ‚è½½åˆ°ä¸€ä¸ªä½ç½®ä¸Šã€‚</p><p>å†™æ³•ï¼š</p><pre><code class="language-yaml:">        volumeMounts:        - name: all-in-one          mountPath: /etc/allinfo          readonly: true  volumes:  - name: all-in-one    projected:      sources:      - secret:          name: user      - secret:          name: pass      - configmap:          name: content      - downwardAPI:          items:            - path: &quot;labels&quot;              fieldRef:                fieldPath: metadata.labels            - path: &quot;annotations&quot;              fieldRef:                fieldPath: metadata.annotations</code></pre><blockquote><p>userï¼Œ passï¼Œ contentï¼Œ labelsï¼Œ annotations å°†ä¼šä»¥æ–‡ä»¶å½¢å¼å­˜åœ¨äºå®¹å™¨æŒ‚è½½ç‚¹ /etc/allinfo å†…ã€‚</p></blockquote><p>åˆ›å»ºSecretå¯¹è±¡ï¼š secret: user å’Œ secret: pass</p><pre><code class="language-bash">echo -n &quot;admin&quot; &gt; ./username.txtkubectl create secret generic user --from-file=./username.txtecho -n &quot;1f2d1e2e67df&quot; &gt; ./username.txtkubectl create secret generic pass --from-file=./password.txt</code></pre><p>åˆ›å»º ConfigMapå¯¹è±¡: content</p><pre><code class="language-bash">echo -n &quot;userinfo&quot; &gt; ./content.txtkubectl create configmap content --from-file=./content.txt</code></pre><p>DownwardAPI ä¸´æ—¶å·å†…å®¹ç›´æ¥é…ç½®é‡Œå†™å…¥</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> ConfigMap </tag>
            
            <tag> Secret </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜08è´Ÿè½½å‡è¡¡service</title>
      <link href="posts/d3b80b5f/"/>
      <url>posts/d3b80b5f/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨å®é™…ä¸šåŠ¡ä¸­,å› ä¸šåŠ¡å‹åŠ›é—®é¢˜,ç»å¸¸ä¼šæœ‰å¤šä¸ªåç«¯æœåŠ¡å‰¯æœ¬,å®ƒä»¬å…±åŒæ‰¿æ‹…è¯·æ±‚.æˆ‘ä»¬ä½¿ç”¨äº‘æœåŠ¡çš„æ—¶å€™,å¯ä»¥è´­ä¹°é˜¿é‡Œäº‘çš„slbæˆ–è€…awsçš„elb/albç­‰è´Ÿè½½å‡è¡¡å™¨å‘è¿™äº›åç«¯å‰¯æœ¬åˆ†å‘æµé‡. å¹¶é€šè¿‡è¿™äº›è´Ÿè½½å‡è¡¡å‘å…¬/å†…ç½‘å‘å¸ƒåç«¯ç¨‹åºã€‚</p><p>k8sè®¾è®¡äº†ä¸€ä¸ªserviceå¯¹è±¡æ¥å®ç°è¿™ä¸€ç›®çš„.</p><h2 id="k8sIP">k8sIP</h2><p>åœ¨æServiceå¯¹è±¡ä¹‹å‰,éœ€è¦å…ˆçŸ¥é“k8sä¸­å­˜åœ¨çš„ä¸‰ç§IP.å³ NodeIP, ClusterIP, PodIP</p><p>NodeIP å°±æ˜¯ç‰©ç†èŠ‚ç‚¹ip, è¿™ä¸ªæ²¡å¾—è¯´, ç©å®¶è‡ªå·±å®šä¹‰</p><p>ClusterIP æ˜¯k8sçš„ä¸€ä¸ªè™šæ‹Ÿip, æœ¬èº«æ²¡æœ‰ä»»ä½•å®ä½“, ä¹Ÿå°±æ˜¯VIP</p><p>PodIP æ˜¯å®¹å™¨å…±äº«çš„ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´å¯¹åº”çš„ip, ä¸€ä¸ªpodé‡Œçš„å®¹å™¨å…±ç”¨</p><h2 id="ä¸kube-proxy">ä¸kube-proxy</h2><p>kube-proxy æ˜¯å®ç° svc çš„é‡è¦ç»„ä»¶ï¼Œkube-proxy é€šè¿‡ä»£ç†æ–¹å¼è½¬å‘æµé‡åˆ°Podã€‚å…¶ä»£ç†æ–¹å¼åˆ†ä¸‰ç§ï¼šnamespace æ–¹å¼ï¼Œiptables æ–¹å¼ï¼Œipvsæ–¹å¼ã€‚åŸºæœ¬ç”¨çš„éƒ½æ˜¯ ipvs æ–¹å¼ã€‚</p><p>ipvsæ–¹å¼çš„å‰ç½®è¦æ±‚æ˜¯ ipvs ç»„ä»¶ï¼Œå¦‚æœ kube-proxy æ²¡æœ‰æ£€æµ‹åˆ° ipvs ç»„ä»¶åˆ™ä¼šå›é€€åˆ° iptables æ–¹å¼ï¼Œå¦‚æœä¾ç„¶ä¸åˆé€‚ï¼Œåˆ™ç»§ç»­å›é€€åˆ° namespaceã€‚</p><h2 id="ç±»å‹">ç±»å‹</h2><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">https://kubernetes.io/zh/docs/concepts/services-networking/service/</a></p><p><a href="https://kubernetes.io/docs/reference/kubernetes-api/service-resources/service-v1/">https://kubernetes.io/docs/reference/kubernetes-api/service-resources/service-v1/</a></p><p>Serviceå¯¹è±¡é€šè¿‡spec.typeæ¥è®¾å®šç±»å‹, å…±è®¡4ä¸ªç±»å‹: ClusterIP, NodePort, LoadBalancer, ExternalName. è¿™å››ä¸ªç±»å‹å¯ä»¥åˆ†ä¸ºä¸¤ç±»</p><h3 id="ClusterIP">ClusterIP</h3><p>ClusterIP(é»˜è®¤ç±»å‹): åå‘ä»£ç†é›†ç¾¤å†…çš„pod. ä¾›é›†ç¾¤å†…å…¶å®ƒæœåŠ¡è®¿é—®. æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å†…éƒ¨å…¶å®ƒæœåŠ¡=&gt;svc_name=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><pre><code class="language-yaml">apiVersion: v1kind: Servicemetadata:  name: myservicespec:  selector:    app: myapp  type: ClusterIP  ports:  - name: myapp-http    protocol: TCP    port: 80    targetPort: 8080  - name: myapp-https    protocol: TCP    port: 443    targetPort: 8081</code></pre><blockquote><p>spec.selectorï¼šé€‰æ‹©å™¨ï¼Œé€‰æ‹©ç›®æ ‡podçš„æ ‡ç­¾</p><p>spec.portsï¼š</p><ul><li><p>name æ˜¯ç«¯å£åï¼Œç”±å°å†™å­—æ¯ã€æ•°å­—ã€<code>-</code>ç»„æˆ</p></li><li><p>port æ˜¯Serviceæš´éœ²ç«¯å£</p></li><li><p>targetPortæ˜¯podæš´éœ²ç«¯å£. é»˜è®¤æƒ…å†µä¸‹, targetPortå°†ç­‰äºport</p></li></ul></blockquote><p>â„¹ï¸è‹¥spec.typeæ²¡æœ‰å®šä¹‰ï¼Œåˆ™é»˜è®¤æ˜¯<code>ClusterIP</code></p><h3 id="ExternalName">ExternalName</h3><p>ExternalName: æ„å»ºä¸€ä¸ªCNAMEè§£æ(serviceå¯¹è±¡-CNAME-å…¶å®ƒåŸŸå).  æˆ‘èƒ½æƒ³åˆ°çš„ä¸»è¦æ˜¯è®©é›†ç¾¤å†…éƒ¨æœåŠ¡å¯ä»¥è®¿é—®åˆ°é›†ç¾¤å¤–éƒ¨æœåŠ¡.</p><p>ä¾‹å¦‚:</p><pre><code class="language-yaml">kind: ServiceapiVersion: v1metadata:  name: my-service  namespace: prodspec:  type: ExternalName  externalName: my.database.example.com</code></pre><blockquote><p>é›†ç¾¤å†…éƒ¨è®¿é—®my-service.prodçš„æ—¶å€™, <a href="http://xn--k8sdnsmy-vq8m536awioci6an95by58d3far6b.database.example.com">å°†é€šè¿‡k8sçš„dnsæœåŠ¡è¿”å›my.database.example.com</a></p></blockquote><h3 id="NodePort">NodePort</h3><p>NodePort: åå‘ä»£ç†é›†ç¾¤å†…çš„pod(ä½¿ç”¨NATåœ¨æ¯ä¸€ä¸ªé›†ç¾¤nodeä¸Šçš„ç›¸åŒç«¯å£ä¸Šå…¬å¼€Service, æ˜¯ã€ClusterIPç±»å‹çš„è¶…é›†ã€‘). ä¾›é›†ç¾¤å¤–æœåŠ¡è®¿é—®. æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å¤–=&gt;ä»»æ„èŠ‚ç‚¹ip:ç«¯å£=&gt;svc_name=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><pre><code class="language-yaml">apiVersion: v1kind: Servicemetadata:  name: myservicespec:  selector:    app: myapp  type: NodePort  ports:  - protocol: TCP    nodePort: 31000    port: 80    targetPort: 80    name: myapp-http</code></pre><blockquote><p>é›†ç¾¤å¤–éƒ¨æ­¤æ—¶å¯ä»¥è®¿é—®ä»»æ„ç‰©ç†èŠ‚ç‚¹ip:31000, æ­¤æ—¶å¯ä»¥è®¿é—®åˆ°é›†ç¾¤å†…éƒ¨app=myappçš„pod.</p><p>è¿™é‡ŒnodePortæ˜¯ç‰©ç†èŠ‚ç‚¹æš´éœ²ç«¯å£, portæ˜¯Serviceæš´éœ²ç«¯å£, targetPortæ˜¯podæš´éœ²ç«¯å£.</p><p>nodePort å¯ä»¥ä¸å®šä¹‰, ä¼šè‡ªåŠ¨ä»30000-32767éšæœºåˆ†é….å…¶èŒƒå›´çš„ä¿®æ”¹éœ€è¦æŒ‡å®š apiserver ç»„ä»¶çš„<code>--service-node-port-range</code>ã€‚</p></blockquote><h3 id="LoadBalancer">LoadBalancer</h3><p>LoadBalancer: å¯¹æ¥äº‘å•†çš„è´Ÿè½½å‡è¡¡æœåŠ¡, ç»™Serviceåˆ†é…ä¸€ä¸ªå›ºå®šIP. æ–¹ä¾¿äº‘æœåŠ¡å•†çš„LBæœåŠ¡ç»‘å®š. ã€æ˜¯NodePortç±»å‹çš„è¶…é›†ã€‚ æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å¤–=&gt;äº‘æœåŠ¡LB=&gt;ä»»æ„ç‰©ç†èŠ‚ç‚¹ip:ç«¯å£=&gt;svc_name=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><p>è¿™ç§ç±»å‹å»ºè®®ç›´æ¥å‚è€ƒå®˜æ–¹æ–‡æ¡£: <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer">https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer</a></p><h3 id="Headless-Service">Headless Service</h3><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒdnsæœåŠ¡ä¼šå°†svcçš„åŸŸåè§£æä¸ºclusterIPï¼ˆvipï¼‰ï¼Œç„¶åé€šè¿‡ä»£ç†æ–¹å¼å°†åˆ°è¾¾vipçš„æµé‡è½¬å‘åˆ°endpointsåˆ—è¡¨ã€‚</p><p>è€ŒHeadlessç±»å‹ä¸‹ï¼Œsvcæ²¡æœ‰vipï¼Œä¹Ÿæ²¡æœ‰è½¬å‘è§„åˆ™ï¼Œè€Œæ˜¯é€šè¿‡Aè®°å½•è§£æå°†<code>svc_name.ns_name</code>ç›´æ¥è§£æä¸º<code>endpoints</code>åˆ—è¡¨ï¼Œå³ç›´è¾¾podã€‚</p><p>ä¸åŒç‚¹ï¼š</p><ul><li>é…ç½®ä¸Šï¼Œè®¾ç½®<code>spec.clusterIP: None</code>ã€‚</li><li>è§£æä¸Šï¼ŒAè®°å½•æ–¹å¼è§£æä¸ºendpointsåˆ—è¡¨çš„æ‰€æœ‰ipï¼Œè€Œä¸æ˜¯ClusterIPã€‚</li></ul><p>å¸¸è§äºåˆ†å¸ƒå¼åº”ç”¨éƒ¨ç½²åœºæ™¯ï¼Œä¾‹å¦‚StatefulSet æ§åˆ¶å™¨ä½¿ç”¨ Headless ç»“åˆPodæ ‡è¯†æ„å»º Pod å”¯ä¸€å­åŸŸåï¼Œå…·ä½“å¦‚ä½•ä½¿ç”¨å‚è€ƒ StatefulSetï¼Œè¿™é‡Œæš‚ä¸è€ƒè™‘ã€‚</p><h2 id="ç²˜æ€§ä¼šè¯">ç²˜æ€§ä¼šè¯</h2><p>æœ‰äº›æ—¶å€™,æˆ‘ä»¬éœ€è¦ä¼šè¯é»æ€§,ä½ å¯ä»¥é€šè¿‡service.spec.sessionAffinity=ClientIPæ¥è®¾ç½®.å¹¶åŒæ—¶å¯ä»¥é€šè¿‡service.spec.sessionAffinityConfig.clientIP.timeoutSecondsæ¥è®¾ç½®ä¼šè¯ä¿æŒæ—¶é—´,å®ƒé»˜è®¤æ˜¯3å°æ—¶.</p><h2 id="æœåŠ¡å‘ç°">æœåŠ¡å‘ç°</h2><p>Pod å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å‘ç°svcã€‚</p><h3 id="DNS">DNS</h3><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#dns">https://kubernetes.io/zh/docs/concepts/services-networking/service/#dns</a></p><p>Podå¯ä»¥å‘ç°é›†ç¾¤ä»»ä½•ä½ç½®çš„svc</p><p>ä¸åŒnsä¸‹ï¼Œä½ å¯ä»¥é€šè¿‡<code>svc_name.ns_name</code>è®¿é—® svc</p><p>ç›¸åŒnsä¸‹ï¼Œå¯åªé€šè¿‡<code>svc_name</code>è®¿é—® svc</p><h3 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</h3><p>Podä»…å¯ä»¥å‘ç°ç›¸åŒnsä¸‹çš„svc</p><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables">https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables</a></p><p>å½“serviceåˆ›å»ºçš„æ—¶å€™,kubeletä¼šç”Ÿæˆä¸€æ‰¹ç¯å¢ƒå˜é‡ã€‚ä¾‹å¦‚ï¼Œsvc åç§°æ˜¯ myserviceï¼ŒClusterIPæ˜¯10.0.0.11ï¼Œæš´æ¼çš„ç«¯å£æ˜¯6379ï¼Œåˆ™ç”Ÿæˆä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š</p><pre><code class="language-bash">MYSERVICE_SERVICE_HOST=10.0.0.11MYSERVICE_SERVICE_PORT=6379MYSERVICE_PORT=tcp://10.0.0.11:6379MYSERVICE_PORT_6379_TCP=tcp://10.0.0.11:6379MYSERVICE_PORT_6379_TCP_PROTO=tcpMYSERVICE_PORT_6379_TCP_PORT=6379MYSERVICE_PORT_6379_TCP_ADDR=10.0.0.11</code></pre><p>â„¹ï¸ åˆ™ä¸ç®¡ä½ ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½åº”è¯¥æå‰é€šè¿‡<code>init</code>å®¹å™¨æ¥æ ¡éªŒsvcå¯¹è±¡å·²æˆåŠŸåˆ›å»ºï¼Œä¾‹å¦‚é€šè¿‡untilæ­»å¾ªç¯æ¥åˆ¤æ–­è§£ææ˜¯å¦æˆåŠŸã€‚</p><h2 id="å…¶å®ƒæš´éœ²æ–¹å¼">å…¶å®ƒæš´éœ²æ–¹å¼</h2><p>é™¤äº† svc æš´éœ²æœåŠ¡ï¼Œè¿˜å¯ä»¥é€šè¿‡ ingress æš´éœ²æœåŠ¡ï¼Œå®ƒæ˜¯å……å½“é›†ç¾¤å…¥å£ï¼Œå¯ä»¥åœ¨å•ipä¸‹æš´éœ²å¤šæœåŠ¡ã€‚è¿™é‡Œæš‚ä¸è®¨è®ºã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> service </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜06æ— çŠ¶æ€æœåŠ¡deployment</title>
      <link href="posts/18e4fa73/"/>
      <url>posts/18e4fa73/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>Deploymentæ§åˆ¶å™¨ç”¨æ¥ç®¡ç†æ— çŠ¶æ€åº”ç”¨ï¼Œé€šè¿‡Deploymentæ§åˆ¶å™¨åˆ›å»ºReplicaSetï¼ŒReplicaSetæ§åˆ¶Podå‰¯æœ¬é›†ã€‚</p><p>ä»»ä½•æ—¶å€™ï¼Œéƒ½ä¸åº”è¯¥ç›´æ¥å»åˆ›å»ºReplicaSetæ§åˆ¶å™¨ï¼Œåº”å§‹ç»ˆä½¿ç”¨Deploymentæ§åˆ¶å™¨ã€‚</p><h1>ä¾‹å­</h1><p>APIè¯­æ³•ï¼š<a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/deployment-v1/">https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/deployment-v1/</a></p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-deployment  labels:    app: nginxspec:  replicas: 3  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      imagePullSecrets:      - name: apps-ro-token      containers:      - name: nginx        image: nginx:v1.20.1        command:        - nginx        args:        - -g        - &quot;daemon off;&quot;        ports:        - containerPort: 80</code></pre><blockquote><p><code>spec.selector</code>ï¼šDeploymenté€šè¿‡å®ƒæ§åˆ¶Podï¼Œä¸Pod<code>spec.template.metadata.labels</code>ä¸€è‡´ã€‚</p><p><code>metadata</code>ï¼š è¿™é‡Œä¼šå®šä¹‰nameï¼Œlabelsï¼Œnamespaceï¼Œannotationsã€‚</p></blockquote><p>âš ï¸Deploymentçš„<code>spec.selector</code>é€‰æ‹©çš„æ ‡ç­¾åº”è¯¥æ˜¯å…¨å±€å”¯ä¸€ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šä¸ªDeploymentå‡ºç°å†²çªå‡ºç°ä¸å¯é¢„çŸ¥çš„é—®é¢˜ã€‚</p><p>â„¹ï¸ å…¶ä¸­ annotations ï¼ˆæ³¨è§£ï¼‰å¾ˆç‰¹æ®Šï¼Œk8sé€šè¿‡æ³¨è§£ä¸­çš„<code>key</code>æ¥ç¡®è®¤è¦å…³è”çš„é¢å¤–æœåŠ¡ä¿¡æ¯ã€‚</p><p>ä¾‹å¦‚åœ¨é˜¿é‡Œäº‘çš„k8sæœåŠ¡ä¸­ï¼Œä½ å¯ä»¥æ·»åŠ é•œåƒå¿«ç…§æ³¨è§£ä¿¡æ¯ï¼Œä»è€Œè®© pod æ— éœ€ä»é•œåƒä»“åº“ä¸‹è½½å¯åŠ¨ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡å¿«ç…§åŠ é€Ÿå¯åŠ¨ã€‚</p><h1>æ›´æ–°</h1><p>Deploymentçš„é»˜è®¤ç­–ç•¥å¤§è‡´å¦‚ä¸‹</p><p>æ›´æ–°è§„åˆ™ï¼š</p><ul><li>å…ˆæ‰©å±•ä¸€éƒ¨åˆ†æ–°ç‰ˆæœ¬</li><li>åˆ é™¤ä¸€éƒ¨åˆ†è€ç‰ˆæœ¬</li><li>é‡å¤ä¸Šè¿°è¡Œä¸º,ç›´è‡³æ‰€æœ‰è€ç‰ˆæœ¬è¢«æ›¿æ¢</li></ul><p>å›æ»šè§„åˆ™ï¼š</p><ul><li>å›æ»šåˆ°ä»»ä½•ä¸€ä¸ªä¹‹å‰çš„ç‰ˆæœ¬</li></ul><blockquote><p>Deploymentåªä¼šé’ˆå¯¹<code>spec.template</code>æ›´æ–°Pod</p></blockquote><h2 id="åˆå§‹ç‰ˆæœ¬">åˆå§‹ç‰ˆæœ¬</h2><p>åˆ›å»ºä¸€ä¸ªnginxçš„deployment</p><pre><code class="language-bash">kubectl apply -f nginx-deployment-1.14.2.yaml===apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-deployment  labels:    app: nginxspec:  replicas: 3  selector:    matchLabels:      app: nginx  minReadySeconds: 3  revisionHistoryLimit: 10  strategy:    type: RollingUpdate    rollingUpdate:      maxUnavailable: 30%      maxSurge: 30%  template:    metadata:      labels:        app: nginx        version: v1.14.2      annotations:        kubernetes.io/change-cause: &quot;version: v1.14.2&quot;    spec:      containers:      - name: nginx        image: nginx:1.14.2        lifecycle:          postStart:            exec:              command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo This is v1.14.2 &gt; /usr/share/nginx/html/index.html&quot;]        command:        - nginx        args:        - -g        - &quot;daemon off;&quot;        ports:        - containerPort: 80</code></pre><p><a href="http://spec.template.metadata.annotations.kubernetes.io/change-cause">spec.template.metadata.annotations.kubernetes.io/change-cause</a> é€šè¿‡æ³¨è§£æ·»åŠ å˜æ›´è¯´æ˜</p><h2 id="æ›´æ–°ç­–ç•¥">æ›´æ–°ç­–ç•¥</h2><p>deployment çš„ .spec ä¸­å¯ä»¥æ·»åŠ ä¸€äº›ç­–ç•¥.</p><pre><code class="language-bash">spec:    minReadySeconds: 3  # pod å°±ç»ªæ—¶é—´ï¼Œåœ¨æ­¤æ—¶é—´ä¹‹å‰ï¼Œdeployment è®¤ä¸º pod è¿˜æ²¡æœ‰å‡†å¤‡å¥½. é»˜è®¤0  revisionHistoryLimit: 10 # æœ€å¤§ç‰ˆæœ¬ä¿ç•™æ¬¡æ•°. é»˜è®¤10   strategy:    type: RollingUpdate # å®šä¹‰å˜æ›´ç­–ç•¥. é™¤äº† RollingUpdateï¼Œè¿˜å¯ä»¥æ˜¯Recreate.RecreateæŒ‡çš„æ˜¯å…ˆåˆ é™¤æ‰€æœ‰pod,å†åˆ›å»º.    rollingUpdate:      maxUnavailable: 30% # å˜æ›´æœŸé—´æœ€å¤šå­˜åœ¨å¤šå°‘ä¸ªä¸å¯ç”¨çš„pod,å¯ä»¥æ˜¯å…·ä½“æ•°å­—      maxSurge: 30% # å˜æ›´æœŸé—´æœ€å¤šå­˜åœ¨å¤šå°‘ä¸ªè¶…å‡ºå·²å®šä¹‰å‰¯æœ¬çš„podæ•°é‡,å¯ä»¥æ˜¯å…·ä½“æ•°å­—</code></pre><blockquote><p>maxUnavailable å’Œ maxSurge è®¾ç½®ç›¸ç­‰å³å¯. å³å¼€å¤šå°‘ä¸ªæ–°çš„åŒæ—¶ï¼Œå°±å…³å¤šå°‘ä¸ªè€çš„</p></blockquote><h3 id="é€šè¿‡å‘½ä»¤æ·»åŠ -åˆ é™¤å˜æ›´è¯´æ˜">é€šè¿‡å‘½ä»¤æ·»åŠ /åˆ é™¤å˜æ›´è¯´æ˜</h3><ul><li>æ·»åŠ </li></ul><pre><code class="language-bash">kubectl annotate deployment/nginx-deployment kubernetes.io/change-cause=&quot;first&quot;</code></pre><ul><li>åˆ é™¤(å‘½ä»¤æœ€åä¸€ä¸ªå‡å·)</li></ul><pre><code class="language-bash">kubectl annotate deployment/nginx-deployment &lt;æ³¨è§£key&gt;-</code></pre><ul><li>æ‰§è¡Œkubectlå‘½ä»¤çš„åŒæ—¶å°†å‘½ä»¤å†™å…¥<code>CHANGE-CAUSE</code></li></ul><pre><code class="language-bash">kubectl xxx --record</code></pre><h2 id="ç‰ˆæœ¬å†å²">ç‰ˆæœ¬å†å²</h2><pre><code class="language-bash">âœ   kubectl rollout history deployment/nginx-deploymentdeployment.apps/nginx-deploymentREVISION  CHANGE-CAUSE1         version: v1.14.2</code></pre><h2 id="æš‚åœå‘å¸ƒ">æš‚åœå‘å¸ƒ</h2><p>æ­¤æ“ä½œä¸ä¼šå½±å“podçš„è¿è¡Œï¼Œä»…ä»…æ˜¯é˜»æ–­deploymentå®æ–½æ›´æ–°ã€‚</p><p>å¦‚æœæ›´æ–°ä¹‹å‰å°±æš‚åœï¼Œåˆ™ä½ å¯ä»¥å¤šæ¬¡æ›´æ–°ï¼Œè¿™äº›æ›´æ–°åœ¨ã€æ¢å¤å‘å¸ƒã€‘ä¹‹å‰ä¸ä¼šè¢«åº”ç”¨ï¼Œä¹Ÿä¸ä¼šè®°å½•åœ¨ã€å†å²ç‰ˆæœ¬ã€‘ä¸­ã€‚</p><p>å¦‚æœæ›´æ–°æœŸé—´æ‰§è¡Œæš‚åœï¼Œåˆ™æ›´æ–°ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼Œå·²æ›´æ–°çš„ä¸ä¼šå›æ»šã€‚</p><pre><code class="language-yaml">kubectl rollout pause deployment/nginx-deployment</code></pre><h2 id="æ›´æ–°ç‰ˆæœ¬">æ›´æ–°ç‰ˆæœ¬</h2><p>å‘å¸ƒç‰ˆæœ¬1.20.1</p><pre><code>sed 's@1.14.2@1.20.1@g' nginx-deployment-1.14.2.yaml &gt; nginx-deployment-1.20.1.yamlkubectl apply -f nginx-deployment-1.20.1.yaml</code></pre><h2 id="æ¢å¤å‘å¸ƒ">æ¢å¤å‘å¸ƒ</h2><pre><code class="language-yaml">kubectl rollout resume deployment/nginx-deployment</code></pre><p>å¯ç”¨æ¢å¤åï¼Œåˆ™æš‚åœæœŸé—´å¯ç”¨çš„æ‰€æœ‰æ›´æ–°å°†å¼€å§‹å‘æŒ¥ä½œç”¨ï¼Œå¹¶ä¸”åªä¼šå°†æ›´æ–°çš„æœ€ç»ˆç‰ˆæœ¬å†™å…¥ã€å†å²ç‰ˆæœ¬ã€‘</p><pre><code class="language-bash">âœ   kubectl rollout history deployment/nginx-deploymentdeployment.apps/nginx-deploymentREVISION  CHANGE-CAUSE1         version: v1.14.22         version: v1.20.1</code></pre><p>æ›´æ–°è¿‡ç¨‹å’Œç»“æœæŸ¥çœ‹ï¼Œå¯è¿è¡Œï¼š</p><pre><code class="language-bash">kubectl rollout status deployment/nginx-deployment</code></pre><p>æ›´æ·±å±‚çš„rsçŠ¶æ€æŸ¥çœ‹ï¼Œå¯è¿è¡Œï¼š</p><pre><code class="language-bash">kubectl get rs -l app=nginx -l version=v1.20.1kubectl get pod -l app=nginx -l version=v1.20.1</code></pre><blockquote><p>-l æ˜¯è°ƒç”¨æ ‡ç­¾è¿‡æ»¤</p></blockquote><p>ä½ å¯ä»¥é€šè¿‡è¿½åŠ ç‰ˆæœ¬å·æ¥çœ‹å…·ä½“çš„ç‰ˆæœ¬å†…å®¹</p><pre><code class="language-bash">kubectl rollout history deployment/nginx-deployment --revision=&lt;num&gt;</code></pre><h2 id="å›æ»šç‰ˆæœ¬">å›æ»šç‰ˆæœ¬</h2><p>æˆ‘ä»¬é€‰æ‹©å°†nginxç‰ˆæœ¬å›æ»šåˆ°ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚è¢«å›æ»šçš„ç‰ˆæœ¬ä¼šä»ç‰ˆæœ¬åº“é‡Œç§»åŠ¨åˆ°æœ€æ–°ä½ç½®ã€‚</p><pre><code class="language-bash">kubectl rollout undo deployment/nginx-deployment --to-revision=1âœ   kubectl rollout history deployment/nginx-deploymentdeployment.apps/nginx-deploymentREVISION  CHANGE-CAUSE2         version: v1.20.13         version: v1.14.2</code></pre><blockquote><p>å¦‚æœä¸æŒ‡å®šç‰ˆæœ¬ï¼Œåˆ™å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚</p></blockquote><h2 id="å°ç»“">å°ç»“</h2><pre><code class="language-bash">kubectl rollout history deployment/&lt;&gt; # æŸ¥çœ‹å¯¹è±¡å†å²kubectl rollout undo deployment/&lt;&gt; --to-revision=&lt;&gt; # å¯¹è±¡ç‰ˆæœ¬å›é€€kubectl rollout status deployment/&lt;&gt;# å±•ç¤ºæ‰§è¡ŒçŠ¶æ€kubectl rollout pause deployment/&lt;&gt; # æš‚åœæ­¤æ¬¡ç‰ˆæœ¬æ“ä½œè¡Œä¸ºkubectl rollout resume deployment/&lt;&gt; # æ¢å¤æ­¤æ¬¡ç‰ˆæœ¬æ“ä½œè¡Œä¸ºkubectl set image # ä¿®æ”¹é•œåƒé…ç½®kubectl annotate # æ·»åŠ ä¸€ä¸ªæ³¨é‡Š</code></pre><p>æ›´æ–°è¿‡ç¨‹ï¼š</p><ul><li>åˆ›å»ºæ–°çš„replicaset</li><li>å°†æ–°çš„replicasetæ‰©å±•</li><li>å°†æ—§çš„replicasetç¼©å®¹</li><li>æ–°çš„replicasetå¯¹åº”çš„podå·²å°±ç»ªæˆ–å¯ç”¨</li></ul><p>å¦å¤–ï¼Œå¯ä»¥é€šè¿‡åˆ¤æ–­<code>kubectl rollout status deployment/&lt;&gt;</code>å‘½ä»¤æ‰§è¡Œç»“æœï¼Œ$? çŠ¶æ€ä¸º 0ï¼Œåˆ™è¯´æ˜ deployment å¤„äº completeã€‚</p><h1>é‡‘ä¸é›€å‘å¸ƒ</h1><p>é‡‘ä¸é›€å‘å¸ƒçš„é€»è¾‘ï¼š</p><ul><li>å¼€æ–°Podï¼Œä¸å…³è€Podï¼Œå³ç¡®ä¿å¯ç”¨çš„Podæ•°ä¸ä½äºé¢„æœŸæ•°ã€‚</li><li>å¾…æ–° Pod åˆ›å»ºåï¼Œç«‹å³æš‚åœå‘å¸ƒã€‚</li><li>æ–° Pod Ready åï¼Œéƒ¨åˆ†æµé‡ç»è¿‡æ–° Podã€‚</li><li>è‹¥æ–° Pod é€šè¿‡éªŒè¯ï¼Œåˆ™æ¢å¤å‘å¸ƒã€‚</li><li>è‹¥æ–° Pod æ²¡æœ‰é€šè¿‡éªŒè¯ï¼Œåˆ™æ¢å¤å‘å¸ƒå¹¶ç«‹å³æ‰§è¡Œå›æ»šæ“ä½œã€‚</li></ul><p>æ“ä½œæ­¥éª¤ï¼š</p><ol><li>è°ƒæ•´æ–°ç‰ˆæœ¬Deploymentæ›´æ–°ç­–ç•¥</li></ol><ul><li><p><code>minReadySeconds</code>è®¾ç½®ä¸º3ï¼Œæ·»åŠ æ‰§è¡Œã€æš‚åœå‘å¸ƒå‘½ä»¤ã€‘çš„ç¼“å†²æ—¶é—´ï¼Œé¿å…æ–°Podè¢«Deploymentè®¤ä¸ºå¯ç”¨çš„åŒæ—¶åˆ é™¤æ—§Podã€‚</p></li><li><p><code>maxUnavailable</code>è®¾ç½®ä¸º0ï¼Œé¿å…æ›´æ–°ä¸­ï¼Œå¯ç”¨Podä½äºé¢„æœŸå€¼ã€‚</p></li><li><p><code>maxSurge</code>çš„å€¼å°±æ˜¯éªŒè¯æ–°ç‰ˆæœ¬çš„Podï¼ˆâ€é‡‘ä¸é›€â€œï¼‰æ•°é‡ã€‚</p></li></ul><ol start="2"><li>å¯åŠ¨æ›´æ–°ï¼Œå¹¶ç«‹å³æš‚åœå‘å¸ƒ</li></ol><pre><code class="language-bash">kubectl apply -f new-nginx-deployment.yaml &amp;&amp; kubectl rollout pause deployment/nginx-deployment</code></pre><ol start="3"><li>è‹¥æ–° Pod æ²¡æœ‰é€šè¿‡éªŒè¯ï¼Œåˆ™æ¢å¤å‘å¸ƒå¹¶ç«‹å³å›æ»šã€‚</li></ol><pre><code class="language-bash">kubectl rollout resume deployment/nginx-deployment &amp;&amp; kubectl rollout undo deployment/nginx-deployment</code></pre><blockquote><p>è¿™ä¸ªè¿‡ç¨‹ä¸ä¼šé‡å»ºè€ç‰ˆæœ¬Podï¼Œåªä¼šé€šè¿‡æ–°ç‰ˆæœ¬rsåˆ é™¤æ–°ç‰ˆæœ¬Pod</p></blockquote><ol start="4"><li>è‹¥æ–° Pod é€šè¿‡éªŒè¯ï¼Œåˆ™æ¢å¤å‘å¸ƒ</li></ol><pre><code class="language-bash">kubectl rollout resume deployment/nginx-deployment</code></pre><p>æ•´ä¸ªæ›´æ–°è¿‡ç¨‹ï¼Œè‹¥é¡ºåˆ©ï¼Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/posts/18e4fa73/image-20211215163355711.png" alt="image-20211215163355711"></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> deployment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜07è‡ªåŠ¨æ‰©ç¼©</title>
      <link href="posts/f6e328b5/"/>
      <url>posts/f6e328b5/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>k8sçš„podç¼©æ”¾åŠŸèƒ½,å’Œawsçš„auto scalingåŠŸèƒ½æ˜¯ä¸€å›äº‹ã€‚è™½ç„¶å¯èƒ½æ²¡æœ‰awsçš„auto scalingåŠŸèƒ½å¼ºå¤§ã€‚</p><p>k8sçš„podè‡ªåŠ¨ç¼©æ”¾åŠŸèƒ½ç§°ä¹‹ä¸ºHPA(Horizontal Pod Autoscaler)ï¼Œå®ƒå¯ä»¥åŸºäºè®¾å®šçš„cpué˜ˆå€¼ï¼Œæ¥è‡ªåŠ¨è°ƒæ•´æ§åˆ¶å™¨ä¸­çš„podæ•°é‡ã€‚</p><h1>æ‰‹åŠ¨ç¼©æ”¾</h1><p>å°±æ˜¯æŒ‡å®šä¸€ä¸ªå‰¯æœ¬æ•°é‡</p><pre><code class="language-yaml">kubectl scale deployment.v1.apps/nginx-dep --replicas=10</code></pre><h1>è‡ªåŠ¨ç¼©æ”¾</h1><p>è‡ªåŠ¨ç¼©æ”¾åŸºäºhpaå¯¹è±¡èµ„æºï¼Œhpaéœ€è¦ç›‘æ§æœåŠ¡ï¼Œæ¯•ç«Ÿæ²¡æœ‰ç›‘æ§æŒ‡æ ‡ï¼Œå°±æ— æ³•æ ¹æ®æŒ‡æ ‡è¿›è¡Œè‡ªåŠ¨ç¼©æ”¾ã€‚</p><h2 id="æ·»åŠ ç›‘æ§æœåŠ¡-metrics-server">æ·»åŠ ç›‘æ§æœåŠ¡ metrics-server</h2><p><a href="https://github.com/kubernetes-sigs/metrics-server">https://github.com/kubernetes-sigs/metrics-server</a></p><p>metrics æœåŠ¡å™¨å¯ä»¥é€šè¿‡èµ„æºåº¦é‡å€¼ API å¯¹å¤–æä¾›åº¦é‡æ•°æ®ï¼ŒHorizontal Pod Autoscaler æ­£æ˜¯æ ¹æ®æ­¤ API æ¥è·å–åº¦é‡æ•°æ®.å¦‚æœæ²¡æœ‰æ­¤æœåŠ¡,HPAå°†æ— æ³•å·¥ä½œ.</p><pre><code class="language-bash">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</code></pre><p>é»˜è®¤ metrics-server çš„ deployment æ— æ³•ç›´æ¥ä½¿ç”¨, æˆ‘ä»¬éœ€è¦æ·»åŠ å‡ ä¸ªå‚æ•°,  æ¥ç¦æ­¢ ca è®¤è¯å’Œå¼€é€š dns</p><p>åœ¨ deployment.spec.template.spec.containers ä¸­æ–°åŠ å…¥ä¸‹åˆ—é…ç½®:</p><pre><code class="language-yaml">        command:          - /metrics-server          - --kubelet-insecure-tls          - --kubelet-preferred-address-types=InternalDNS,InternalIP,ExternalDNS,ExternalIP,Hostname</code></pre><pre><code class="language-bash">kubectl apply -f components.yaml</code></pre><h2 id="åˆ›å»ºæµ‹è¯•ç”¨ä¾‹">åˆ›å»ºæµ‹è¯•ç”¨ä¾‹</h2><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</a></p><p>hpa-test.yaml</p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: php-apachespec:  selector:    matchLabels:      run: php-apache  replicas: 1  template:    metadata:      labels:        run: php-apache    spec:      containers:      - name: php-apache        image: k8s.gcr.io/hpa-example        ports:        - containerPort: 80        resources:          limits:            cpu: 500m          requests:            cpu: 200m---apiVersion: v1kind: Servicemetadata:  name: php-apache  labels:    run: php-apachespec:  ports:  - port: 80  selector:    run: php-apache</code></pre><blockquote><p>Service ç±»å‹é€šè¿‡<code>spec.selector</code>é€‰æ‹©pod</p></blockquote><h2 id="åŸºäºCPUæŒ‡æ ‡å¼€å¯">åŸºäºCPUæŒ‡æ ‡å¼€å¯</h2><p>å‘½ä»¤æ–¹å¼:</p><pre><code class="language-bash">kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=5</code></pre><p>å£°æ˜æ–¹å¼:</p><pre><code class="language-yaml">apiVersion: autoscaling/v1kind: HorizontalPodAutoscalermetadata:  name: php-apachespec:  scaleTargetRef:    apiVersion: apps/v1    kind: Deployment    name: php-apache  minReplicas: 1  maxReplicas: 5  targetCPUUtilizationPercentage: 50</code></pre><blockquote><p>è¿™é‡Œçš„æ„æ€æ˜¯, cpu é˜ˆå€¼50%, æœ€å°podæ•°1, æœ€å¤§podæ•°5. hpaä¼šå°†æ‰€æœ‰podçš„å¹³å‡cpuåˆ©ç”¨ç‡ç»´æŒåœ¨50%, å¹¶ä¸”podæ•°é‡åœ¨1~5çš„èŒƒå›´å†…æ³¢åŠ¨</p></blockquote><p>âš ï¸åªå…è®¸æ‹¥æœ‰ä¸€ä¸ªè§„åˆ™</p><p>æŸ¥çœ‹å½“å‰cpuä½¿ç”¨ç‡</p><pre><code class="language-bash">âœ   kubectl get hpa --watchNAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   0%/50%    1         5         1          57m</code></pre><p>âš ï¸å¦‚æœ<code>TARGETS</code>æ˜¾ç¤º<code>unknown</code>æ²¡æœ‰è·å–åˆ°Deploymentçš„èµ„æºåˆ©ç”¨ç‡ï¼Œåˆ™è¯´æ˜Deploymentä¸­æ²¡æœ‰æ·»åŠ å¯¹åº”çš„èµ„æºé™åˆ¶ã€‚</p><p>é€šè¿‡busyboxä»¥æ­»å¾ªç¯æ–¹å¼è®¿é—®webæœåŠ¡ï¼Œå¿«é€Ÿå¢åŠ æµ‹è¯•æœåŠ¡çš„cpuä½¿ç”¨ç‡</p><pre><code class="language-bash">kubectl run -it --rm load-generator --image=busybox /bin/shwhile true; do wget -q -O- http://php-apache; done=== ä¼šè¾“å‡ºå¤§é‡OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!</code></pre><p>åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ç­‰å¾…å(ä¸ä¼šè¶…è¿‡1åˆ†é’Ÿ, é»˜è®¤ç›‘æ§æŠ“å–æ•°æ®é—´éš”æ—¶é—´æ˜¯1åˆ†é’Ÿ),æˆ‘ä»¬å¯ä»¥çœ‹åˆ° pod æ•°é‡å‘ç”Ÿå˜åŒ–</p><pre><code class="language-bash">âœ   kubectl get hpa --watchNAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   0%/50%    1         5         1          60mNAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   0%/50%    1         5         1          60mNAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   250%/50%   1         5         1          61mNAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   250%/50%   1         5         1          61mâœ   kubectl get deployment/php-apacheNAME         READY   UP-TO-DATE   AVAILABLE   AGEphp-apache   5/5     5            5           68m</code></pre><p>ç°åœ¨,å…³é—­å®¢æˆ·ç«¯è¯·æ±‚,ç­‰å¾…1åˆ†é’Ÿä»¥ä¸Š.å†æ¬¡çœ‹hpa, è¿™æ—¶å€™cpuåˆ©ç”¨ç‡å·²ç»ä¸‹é™</p><pre><code class="language-bash">âœ   kubectl get hpaNAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   11%/50%   1         5         5          64m</code></pre><p>å†çœ‹podæ•°é‡,å®ƒåº”è¯¥å·²ç»å¼€å§‹ç¼©å‡ã€‚</p><blockquote><p>ç¼©å‡å¹¶ä¸æ˜¯åœ¨cpuä½¿ç”¨ç‡ä¸‹é™ä¹‹åå°±ç«‹å³æ‰§è¡Œ,è€Œæ˜¯å†…éƒ¨æœ‰ä¸€ä¸ªç®—æ³•.å®ƒé¿å…å› ç«‹å³æ‰§è¡Œä»è€Œå¯¼è‡´èµ„æºå‡ºç°åå¤æ³¢åŠ¨.</p></blockquote><pre><code class="language-bash">âœ   kubectl get deployment php-apacheNAME         READY   UP-TO-DATE   AVAILABLE   AGEphp-apache   5/5     5            5           70mâœ   kubectl describe deployment/php-apacheName:                   php-apacheNamespace:              defaultCreationTimestamp:      Wed, 16 Sep 2020 10:22:32 +0800Labels:                 &lt;none&gt;Annotations:            deployment.kubernetes.io/revision: 1Selector:               run=php-apacheReplicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailableStrategyType:           RollingUpdateMinReadySeconds:        0RollingUpdateStrategy:  25% max unavailable, 25% max surgePod Template:  Labels:  run=php-apache  Containers:   php-apache:    Image:      k8s.gcr.io/hpa-example    Port:       80/TCP    Host Port:  0/TCP    Limits:      cpu:  500m    Requests:      cpu:        200m    Environment:  &lt;none&gt;    Mounts:       &lt;none&gt;  Volumes:        &lt;none&gt;Conditions:  Type           Status  Reason  ----           ------  ------  Progressing    True    NewReplicaSetAvailable  Available      True    MinimumReplicasAvailableOldReplicaSets:  &lt;none&gt;NewReplicaSet:   php-apache-5c4f475bf5 (1/1 replicas created)Events:  Type    Reason             Age    From                   Message  ----    ------             ----   ----                   -------  Normal  ScalingReplicaSet  14m    deployment-controller  Scaled up replica set php-apache-5c4f475bf5 to 4  Normal  ScalingReplicaSet  14m    deployment-controller  Scaled up replica set php-apache-5c4f475bf5 to 5  Normal  ScalingReplicaSet  6m50s  deployment-controller  Scaled down replica set php-apache-5c4f475bf5 to 4  Normal  ScalingReplicaSet  4m49s  deployment-controller  Scaled down replica set php-apache-5c4f475bf5 to 1</code></pre><hr><h1>å¸¸ç”¨çš„ä¹Ÿå°±ä¸Šé¢çš„åŸºäºCPUæŒ‡æ ‡</h1><h2 id="åŸºäºå…¶å®ƒéèµ„æºç±»å‹çš„æŒ‡æ ‡">åŸºäºå…¶å®ƒéèµ„æºç±»å‹çš„æŒ‡æ ‡</h2><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics</a></p><p>å½“å‰hpaçš„apiç‰ˆæœ¬æ˜¯autoscaling/v1ï¼Œå®ƒåªèƒ½æŠ“å–cpuæŒ‡æ ‡ã€‚</p><p>å¦‚æœä½ æƒ³æŠ“å–å†…å­˜æŒ‡æ ‡(å½“å‰ä¹Ÿåªæ”¯æŒå†…å­˜)å’Œéèµ„æºç±»å‹æŒ‡æ ‡,é‚£ä¹ˆéœ€è¦å°†ç‰ˆæœ¬å˜æ›´ä¸ºautoscaling/v2ã€‚</p><p>autoscaling/v2ç‰ˆæœ¬çš„é…ç½®æœ‰äº†ä¸€äº›å˜åŒ–,ä¸”å¯èƒ½éšæ—¶ä¼šæœ‰æ–°çš„å˜åŒ–.</p><p><a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/#HorizontalPodAutoscalerSpec">https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/#HorizontalPodAutoscalerSpec</a></p><pre><code class="language-yaml">apiVersion: autoscaling/v2kind: HorizontalPodAutoscalermetadata:  name: php-apachespec:  scaleTargetRef:    apiVersion: apps/v1    kind: Deployment    name: php-apache  minReplicas: 1  maxReplicas: 10  metrics:  - type: Resource    resource:      name: cpu      target:        type: AverageUtilization        averageUtilization: 50  - type: Pods    pods:      metric:        name: packets-per-second      target:        type: AverageValue        averageValue: 1k  - type: Object    object:      metric:        name: requests-per-second      describedObject:        apiVersion: networking.k8s.io/v1beta1        kind: Ingress        name: main-route      target:        kind: Value        value: 10k</code></pre><p>ä¸Šé¢çš„ä¾‹å­æ„æ€æ˜¯ï¼š</p><ol><li>ä¿æŒæ¯ä¸ªpodçš„cpuä½¿ç”¨ç‡ä¸è¶…è¿‡50%ï¼Œå¹¶ä¸”æ¯ç§’èƒ½æ‰¿å—1000ä¸ªæ•°æ®åŒ…ã€‚</li><li>æ‰€æœ‰ä½äºingressåé¢çš„podï¼Œæ¯ç§’èƒ½å¤„ç†10000ä¸ªè¯·æ±‚ã€‚</li></ol><blockquote><p>è¯·æ³¨æ„ï¼š</p><ol><li>æŒ‡æ ‡å­—æ®µtargetCPUUtilizationPercentageè¢«metricsæ•°ç»„ä»£æ›¿ï¼Œmetricsæ•°ç»„åŒ…å«äº†å¤šç§åº¦é‡æŒ‡æ ‡ã€‚</li><li>æŒ‡æ ‡åˆ†ä¸ºï¼šç›´æ¥èµ„æºç±» Resourceï¼ŒPodç±» Podsï¼Œç¬¬ä¸‰ç±» Objectï¼Œék8så¯¹è±¡ç±» Externalï¼Œå®¹å™¨èµ„æºç±» ContainerResource</li><li>æŒ‡æ ‡åˆ†ç±»ï¼š<ol><li>name æŒ‡å®šæŒ‡æ ‡æ ‡è¯†å</li><li>target.type æŒ‡å®šæŒ‡æ ‡ã€å€¼ã€‘ç±»å‹ï¼Œä¾‹å¦‚<code>AverageValue</code>è¡¨ç¤ºå¹³å‡å€¼ï¼Œå³æ¯ä¸€ä¸ªpodéƒ½éœ€è¦æ»¡è¶³æ­¤æŒ‡æ ‡å€¼</li></ol></li></ol></blockquote><p>âš ï¸å…³äº<code>Resource</code>ç±»å‹ï¼Œè¦ä¹ˆæ˜¯cpuï¼Œè¦ä¹ˆæ˜¯memoryï¼Œä¸¤è€…åº”äºŒé€‰ä¸€ã€‚</p><h2 id="åŸºäºæ ‡ç­¾çš„k8så¯¹è±¡æŒ‡æ ‡">åŸºäºæ ‡ç­¾çš„k8så¯¹è±¡æŒ‡æ ‡</h2><pre><code class="language-yaml">- type: Object  object:    metric:      name: `http_requests`      selector: `verb=GET`    target:      type: AverageValue      averageValue: 30</code></pre><blockquote><p>ä»ç›‘æ§ç³»ç»Ÿé‡Œè·å–æ ‡ç­¾verb=GETçš„å€¼</p></blockquote><p>ä¸Šè¿°ä¾‹å­çš„æ„æ€æ˜¯ï¼Œç¡®ä¿æ¯ä¸€ä¸ªpodéƒ½èƒ½æ»¡è¶³æ ‡ç­¾ä¸ºverb=GETçš„httpè¯·æ±‚æ•°é‡ã€‚</p><h2 id="åŸºäºék8så¯¹è±¡æŒ‡æ ‡">åŸºäºék8så¯¹è±¡æŒ‡æ ‡</h2><pre><code class="language-yaml">- type: External  external:    metric:      name: queue_messages_ready      selector: &quot;queue=worker_tasks&quot;    target:      type: AverageValue      averageValue: 30</code></pre><p>å½“ç±»å‹å˜ä¸ºExternalçš„æ—¶å€™ï¼Œå°±å¯ä»¥æŒ‡å®šç›‘æ§ç³»ç»Ÿé‡Œå­˜å‚¨çš„å…¶å®ƒç›‘æ§æŒ‡æ ‡ã€‚</p><p>ä¾‹å¦‚ï¼Œç›‘æ§ç³»ç»Ÿä»æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡é‡Œæ‹¿åˆ°äº†æ¶ˆæ¯æ•°é‡çš„æŒ‡æ ‡ï¼Œå¹¶é™„åŠ queue=worker_tasksã€‚é‚£ä¹ˆå°±å¯ä»¥å’Œä¸Šè¿°ä¾‹å­ä¸€æ ·ï¼Œæ ¹æ®æ¶ˆæ¯æ•°é‡æŒ‡æ ‡è¿›è¡Œç¼©æ”¾ã€‚</p><h1>åº¦é‡</h1><p>hpaå’Œåº¦é‡æŒ‡æ ‡APIé‡Œçš„æ•°æ®å‡ä½¿ç”¨k8sä¸­ç§°ä¸ºé‡çº²çš„ç‰¹æ®Šæ•´æ•°è¡¨ç¤ºã€‚</p><p>é‡çº²çš„æ„æ€å°±æ˜¯ï¼š</p><ul><li>æ•°å­—å¤ªå°å°±åŠ ä¸Šåç¼€å•ä½mï¼Œä¾‹å¦‚1.5å†™æˆ1500mã€‚</li><li>æ•°å­—åˆšå¥½å°±æ˜¯æ•´æ•°æ˜¾ç¤ºã€‚</li><li>æ•°å­—å¤§å°±åŠ ä¸Šåç¼€å•ä½ï¼Œæ¯”å¦‚kï¼ŒMã€‚</li><li>æ€»ä¹‹æ²¡æœ‰å°æ•°ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> deployment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜å¸¸ç”¨å‘½ä»¤</title>
      <link href="posts/e6ae9474/"/>
      <url>posts/e6ae9474/</url>
      
        <content type="html"><![CDATA[<h2 id="æŸ¥è¯¢åº“è¡¨å ç”¨ç©ºé—´">æŸ¥è¯¢åº“è¡¨å ç”¨ç©ºé—´</h2><pre><code class="language-mysql">SELECT    table_schema AS 'æ•°æ®åº“',    table_name AS 'è¡¨å',    table_rows AS 'è®°å½•æ•°',    TRUNCATE (data_length / 1024 / 1024 / 1024, 3) AS 'æ•°æ®å®¹é‡(GB)',    TRUNCATE (index_length / 1024 / 1024 / 1024 , 3) AS 'ç´¢å¼•å®¹é‡(GB)',TRUNCATE (DATA_FREE / 1024 / 1024 / 1024, 3) AS 'å·²å ç”¨ç©ºé—´ä½†æœªä½¿ç”¨(GB)'FROM    information_schema. TABLESWHERE    table_schema in ('new_data','megable_main','megable_active')ORDER BY    data_length DESC;</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜05å®¹å™¨ç”Ÿå‘½å‘¨æœŸ-å›è°ƒå’Œæ¢é’ˆ</title>
      <link href="posts/9aa66899/"/>
      <url>posts/9aa66899/</url>
      
        <content type="html"><![CDATA[<h1>å®¹å™¨ç”Ÿå‘½å‘¨æœŸ-å›è°ƒ</h1><p>å®¹å™¨çŠ¶æ€åŒ…å«3ä¸ªï¼š</p><ul><li>waitingï¼Œä¸€èˆ¬å¯¹åº”Podçš„pendingé˜¶æ®µ</li><li>runningï¼Œå®¹å™¨è¿è¡ŒOK</li><li>terminatedï¼Œå®¹å™¨é€€å‡º</li></ul><p>æˆ‘ä»¬åœ¨å®é™…å·¥ä½œä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°éœ€è¦åœ¨å®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸­æŒ‰é¢„å®šè®¡åˆ’æ‰§è¡ŒæŸä¸ªåŠ¨ä½œï¼Œä¾‹å¦‚å®¹å™¨ç¨‹åºçš„å‡†å¤‡å·¥ä½œï¼Œä»¥åŠå®¹å™¨ç»“æŸä¹‹å‰çš„å¤„ç†å·¥ä½œã€‚æ¯”å¦‚ï¼Œå®¹å™¨å¼€å§‹ä¹‹å‰ä¸‹è½½ä¸€äº›åŒ…ï¼Œæˆ–è€…å®¹å™¨ç»“æŸä¹‹å‰ä¸Šä¼ æ—¥å¿—ç­‰ã€‚</p><p>k8s ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªå›è°ƒç”¨äºå¤„ç†è¿™äº›å·¥ä½œï¼Œåˆ†åˆ«æ˜¯ postStartå’Œ preStop.</p><p><a href="https://kubernetes.io/zh/docs/concepts/containers/container-lifecycle-hooks/">https://kubernetes.io/zh/docs/concepts/containers/container-lifecycle-hooks/</a></p><h2 id="postStart">postStart</h2><ol><li>k8såœ¨åœ¨å®¹å™¨åˆ›å»ºåç«‹å³ã€å‘é€ã€‘postStartï¼Œä½†ã€ä¸ä¿è¯ã€‘åœ¨ ENTRYPOINT ä¹‹å‰è¿è¡Œ</li><li>å¦‚æœå®ƒå¡ä½ï¼Œã€å®¹å™¨ã€‘æ— æ³•è¾¾åˆ° running çŠ¶æ€ã€‚</li></ol><p>ç¤ºä¾‹ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: poststart-testspec:  containers:  - name: poststart-test    image: nginx    lifecycle:      postStart:        exec:          command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo This is postStart-test &gt; /usr/share/nginx/html/index.html&quot;]</code></pre><pre><code class="language-bash">[root@k8s00 ~]# kubectl apply -f poststart-test.yamlpod/poststart-test created[root@k8s00 ~]# kubectl get pod -o wideNAME             READY   STATUS              RESTARTS   AGE   IP       NODE    NOMINATED NODE   READINESS GATESpoststart-test   0/1     ContainerCreating   0          7s    &lt;none&gt;   k8s02   &lt;none&gt;           &lt;none&gt;[root@k8s00 ~]# kubectl get pod -o wideNAME             READY   STATUS    RESTARTS   AGE   IP          NODE    NOMINATED NODE   READINESS GATESpoststart-test   1/1     Running   0          10s   10.97.2.6   k8s02   &lt;none&gt;           &lt;none2[root@k8s00 ~]# curl 10.97.2.6This is postStart-test</code></pre><h2 id="preStop">preStop</h2><ol><li>k8så®ƒå°†åœ¨ã€å®¹å™¨ã€‘ç»“æŸå‰ç«‹å³ã€å‘é€ã€‘preStopï¼Œä½†æ‰§è¡Œæ—¶é—´å—é™äºã€Podã€‘ç»ˆæ­¢å®½é™æœŸã€‚</li><li>åº”è¯¥è®¾ç½®è¶³å¤Ÿé•¿çš„ç»ˆæ­¢å®½é™æœŸ<code>terminationGracePeriodSeconds</code>ï¼Œè¿™ä¸ªæœŸé™åº”è¯¥å¤§äºpreStopæ‰§è¡Œæ—¶é—´+kubeleté€šçŸ¥ã€container runtimeã€‘å‘å…³é—­ä¿¡å·ç»™ã€å®¹å™¨ã€‘+ã€å®¹å™¨ã€‘å…³é—­æ—¶é—´ã€‚</li><li>å®ƒæ‰§è¡ŒæœŸé—´ï¼ŒPodä¾ç„¶å¤„äºsvcçš„ç«¯ç‚¹åˆ—è¡¨å†…ã€‚</li></ol><blockquote><p>ã€å®¹å™¨ã€‘çš„ç»“æŸéœ€è¦è¢«k8sçŸ¥æ‚‰ï¼Œä»»ä½•k8sä¸çŸ¥æ‚‰çš„ç»“æŸåŠ¨ä½œï¼Œä¸ä¼šè§¦å‘preStopã€‚ä¾‹å¦‚å®¹å™¨å› æ‰§è¡Œå®Œè‡ªåŠ¨ç»“æŸï¼Œè¿™ç§çŠ¶æ€k8sæ— æ³•å¾—çŸ¥ã€‚</p></blockquote><p>ç¤ºä¾‹ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: prestop-testspec:  containers:  - name: prestop-test    image: nginx    volumeMounts:    - name: prestop-test-tmp      mountPath: /usr/share    lifecycle:      preStop:        exec:          command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo This is preStop &gt; /usr/share/message&quot;]  volumes:  - name: prestop-test-tmp    hostPath:      path: /tmp</code></pre><pre><code class="language-bash">[root@k8s00 ~]# kubectl delete pod prestop-test# è¿™é‡Œ prestop-test è¢«è°ƒåº¦åˆ° k8s02[root@k8s02 ~]# cat /tmp/messageThis is preStop</code></pre><h2 id="æ“ä½œ">æ“ä½œ</h2><p><a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/">https://kubernetes.io/zh/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/</a></p><h2 id="åˆ†æ­§">åˆ†æ­§</h2><p><strong>è¯´æ˜ï¼š</strong> Kubernetes åªæœ‰åœ¨ Pod æ‰‹åŠ¨ç»“æŸæˆ–å› æ§åˆ¶å™¨è°ƒåº¦çš„æ—¶å€™æ‰ä¼šå‘é€ preStop äº‹ä»¶ï¼Œ ä½†åœ¨ Podï¼ˆCompletedï¼‰æ—¶ preStop çš„äº‹ä»¶å¤„ç†é€»è¾‘ä¸ä¼šè¢«è§¦å‘ã€‚è¿™ä¸ªé™åˆ¶åœ¨ <a href="https://github.com/kubernetes/kubernetes/issues/55807">issue #55087</a> ä¸­è¢«è¿½è¸ªã€‚</p><p>å› æ­¤ï¼ŒJobç±»ä¸åº”è¯¥ä½¿ç”¨preStopæ¥æ‰§è¡Œç»“æŸé€»è¾‘ï¼Œè€Œæ˜¯åº”è¯¥å°†é€»è¾‘æ”¾åœ¨å®¹å™¨å†…æ‰§è¡Œã€‚k8sæ— æ³•æå‰è·æ‚‰å®¹å™¨é€€å‡ºä¿¡å·ï¼Œå› æ­¤æ— æ³•åœ¨å®¹å™¨é€€å‡ºå‰å‘é€preStopã€‚</p><h1>å®¹å™¨ç”Ÿå‘½å‘¨æœŸ-æ¢é’ˆ</h1><blockquote><p><a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes">https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes</a></p><p><a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/#lifecycle-1">https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/#lifecycle-1</a></p></blockquote><p>k8sé€šè¿‡æ¢æµ‹å™¨åˆ¤æ–­ä½•æ—¶é‡å¯å®¹å™¨ã€‚</p><p>æ¢æµ‹å™¨ç§ç±»ï¼šå¯åŠ¨æ¢æµ‹å™¨startupProbeã€å­˜æ´»æ¢æµ‹å™¨livenessProbeï¼Œå°±ç»ªæ¢æµ‹å™¨readinessProbeã€‚</p><p>æ¯ç§æ¢æµ‹å™¨æ¢æµ‹æ–¹å¼ï¼šå‘½ä»¤æ–¹å¼ï¼Œhttpæ–¹å¼ï¼Œtcpæ–¹å¼ã€‚</p><ul><li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#execaction-v1-core">ExecAction</a>ï¼š åœ¨å®¹å™¨å†…æ‰§è¡ŒæŒ‡å®šå‘½ä»¤ã€‚å¦‚æœå‘½ä»¤é€€å‡ºæ—¶è¿”å›ç ä¸º 0 åˆ™è®¤ä¸ºè¯Šæ–­æˆåŠŸã€‚</li><li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#tcpsocketaction-v1-core">TCPSocketAction</a>ï¼š å¯¹å®¹å™¨çš„ IP åœ°å€ä¸Šçš„æŒ‡å®šç«¯å£æ‰§è¡Œ TCP æ£€æŸ¥ã€‚å¦‚æœç«¯å£æ‰“å¼€ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚</li><li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#httpgetaction-v1-core">HTTPGetAction</a>ï¼š å¯¹å®¹å™¨çš„ IP åœ°å€ä¸ŠæŒ‡å®šç«¯å£å’Œè·¯å¾„æ‰§è¡Œ HTTP Get è¯·æ±‚ã€‚å¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº 200 ä¸”å°äº 400ï¼Œåˆ™è¯Šæ–­è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚</li></ul><p>ä¾‹å¦‚å‘½ä»¤æ–¹å¼ï¼š</p><pre><code class="language-yaml">    livenessProbe:      exec:        command:        - cat        - /tmp/healthy      initialDelaySeconds: 5      periodSeconds: 5</code></pre><p>ä¼˜å…ˆçº§ï¼šå¯åŠ¨æ¢æµ‹å™¨&gt;å­˜æ´»æ¢æµ‹å™¨&gt;å°±ç»ªæ¢æµ‹å™¨</p><p>é»˜è®¤è¡Œä¸ºï¼šä»»ä½•æ²¡æœ‰æ˜¾å¼æŒ‡å®šçš„æ¢é’ˆï¼Œè‡ªåŠ¨è®¾ä¸º<code>success</code>ã€‚</p><p>kubelet ä½¿ç”¨å¯åŠ¨æ¢æµ‹å™¨å¯ä»¥çŸ¥é“åº”ç”¨ç¨‹åºå®¹å™¨ä»€ä¹ˆæ—¶å€™å¯åŠ¨äº†ã€‚ å¦‚æœé…ç½®äº†è¿™ç±»æ¢æµ‹å™¨ï¼Œå°±å¯ä»¥æ§åˆ¶å®¹å™¨åœ¨å¯åŠ¨æˆåŠŸåå†è¿›è¡Œå­˜æ´»æ€§å’Œå°±ç»ªæ£€æŸ¥ï¼Œ ç¡®ä¿è¿™äº›å­˜æ´»ã€å°±ç»ªæ¢æµ‹å™¨ä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„å¯åŠ¨ã€‚ è¿™å¯ä»¥ç”¨äºå¯¹æ…¢å¯åŠ¨å®¹å™¨è¿›è¡Œå­˜æ´»æ€§æ£€æµ‹ï¼Œé¿å…å®ƒä»¬åœ¨å¯åŠ¨è¿è¡Œä¹‹å‰å°±è¢«æ€æ‰ã€‚</p><p>è‹¥å¯åŠ¨æ¢é’ˆå­˜åœ¨ï¼Œåˆ™å…¶å®ƒä¸¤ç±»æ¢é’ˆå°†å»¶åè¿è¡Œã€‚è¡Œä¸ºä¸Šï¼Œæ¢é’ˆå¤±è´¥åˆ™é‡å¯ã€å®¹å™¨ã€‘.ã€‚</p><p>è‹¥å­˜æ´»æ¢é’ˆå­˜åœ¨ï¼Œè¡Œä¸ºä¸Šï¼Œæ¢é’ˆå¤±è´¥é‡å¯ã€å®¹å™¨ã€‘ã€‚</p><p>è‹¥å°±ç»ªæ¢é’ˆå­˜åœ¨ï¼Œè¡Œä¸ºä¸Šï¼Œæ¢é’ˆæˆåŠŸPodåŠ å…¥svcç«¯ç‚¹åˆ—è¡¨ã€‚é»˜è®¤ä¸º<code>failure</code>ï¼Œå› æ­¤ï¼ŒæˆåŠŸä¹‹å‰svcä¼šå°†Podä»ç«¯ç‚¹åˆ—è¡¨ä¸­ç§»é™¤ã€‚</p><blockquote><p>é¦–å…ˆï¼Œå°±ç»ªæ¢é’ˆæ¯”è¾ƒç¬¦åˆå¸¸è§éœ€æ±‚ï¼Œå³æ¢é’ˆå¤±è´¥ï¼Œåˆ™ä¸ä¼šæä¾›æœåŠ¡ã€‚ä½†å®ƒä¸ä¼šé‡å¯å®¹å™¨ï¼Œå› æ­¤æ— æ³•è‡ªåŠ¨è§£å†³é—®é¢˜ã€‚</p><p>å…¶æ¬¡ï¼Œéœ€è¦å­˜æ´»æ¢é’ˆæ¥åˆ¤æ–­ç¨‹åºçš„åŸºæœ¬æ¡ä»¶ä»è€Œç¡®ä¿å®¹å™¨é‡å¯ã€‚</p><p>æœ€åï¼Œå¯åŠ¨æ¢é’ˆå¯ä»¥åˆ¤æ–­ç¯å¢ƒï¼Œç¯å¢ƒä¸æ»¡è¶³ç›´æ¥é‡å¯ã€‚</p></blockquote><h2 id="æ¢æµ‹å™¨çš„ä¸€äº›é…ç½®">æ¢æµ‹å™¨çš„ä¸€äº›é…ç½®</h2><ul><li><code>initialDelaySeconds</code>ï¼šå®¹å™¨å¯åŠ¨åè¦ç­‰å¾…å¤šå°‘ç§’åå­˜æ´»å’Œå°±ç»ªæ¢æµ‹å™¨å¼€å§‹ç¬¬ä¸€æ¬¡æ¢æµ‹ï¼Œé»˜è®¤æ˜¯ 0 ç§’ï¼Œæœ€å°å€¼æ˜¯ 0ã€‚</li><li><code>periodSeconds</code>ï¼šæ‰§è¡Œæ¢æµ‹çš„æ—¶é—´é—´éš”ï¼ˆå•ä½æ˜¯ç§’ï¼‰ã€‚é»˜è®¤æ˜¯ 10 ç§’ã€‚æœ€å°å€¼æ˜¯ 1ã€‚</li><li><code>timeoutSeconds</code>ï¼šæ¢æµ‹çš„è¶…æ—¶åç­‰å¾…å¤šå°‘ç§’ã€‚é»˜è®¤å€¼æ˜¯ 1 ç§’ã€‚æœ€å°å€¼æ˜¯ 1ã€‚</li><li><code>successThreshold</code>ï¼šæ¢æµ‹å™¨åœ¨å¤±è´¥åï¼Œè¢«è§†ä¸ºæˆåŠŸçš„æœ€å°è¿ç»­æˆåŠŸæ•°ã€‚é»˜è®¤å€¼æ˜¯ 1ã€‚ å­˜æ´»å’Œå¯åŠ¨æ¢æµ‹çš„è¿™ä¸ªå€¼å¿…é¡»æ˜¯ 1ã€‚æœ€å°å€¼æ˜¯ 1ã€‚</li><li><code>failureThreshold</code>ï¼šå½“æ¢æµ‹å¤±è´¥æ—¶ï¼ŒKubernetes çš„é‡è¯•æ¬¡æ•°ã€‚ å­˜æ´»æ¢æµ‹æƒ…å†µä¸‹çš„æ”¾å¼ƒå°±æ„å‘³ç€é‡æ–°å¯åŠ¨å®¹å™¨ã€‚ å°±ç»ªæ¢æµ‹æƒ…å†µä¸‹çš„æ”¾å¼ƒ Pod ä¼šè¢«æ‰“ä¸Šæœªå°±ç»ªçš„æ ‡ç­¾ã€‚é»˜è®¤å€¼æ˜¯ 3ã€‚æœ€å°å€¼æ˜¯ 1ã€‚</li></ul><h2 id="å¯åŠ¨æ¢æµ‹å™¨-startupProbe">å¯åŠ¨æ¢æµ‹å™¨ startupProbe</h2><p>ç›®çš„åœ¨äºè®¾ç½®ä¸€ä¸ªå®¹å™¨å¯åŠ¨å®½å®¹æœŸã€‚å½“å¯åŠ¨æ¢æµ‹å™¨ç¡®è®¤å®¹å™¨æ²¡é—®é¢˜åï¼Œåç»­çš„å¥åº·çŠ¶æ€å°†äº¤ç»™å­˜æ´»æ¢æµ‹å™¨ã€‚</p><p>å®ƒä»…åœ¨å®¹å™¨å¯åŠ¨åˆæœŸè¿è¡Œã€‚</p><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml">ports:- name: liveness-port  containerPort: 8080  hostPort: 8080startupProbe:  httpGet:    path: /healthz    port: liveness-port  failureThreshold: 30  # é”™è¯¯æ¬¡æ•°é˜ˆå€¼  periodSeconds: 10  # æ£€æµ‹é—´éš”å‘¨æœŸ  # å¯åŠ¨è¶…æ—¶æ—¶é—´=failureThreshold*periodSeconds</code></pre><p>ä¸Šè¿°ä¾‹å­æ„æ€æ˜¯ï¼škubelet æ£€æµ‹æ€»æ—¶é—´è¶…è¿‡ 300 ç§’åï¼Œå¦‚æœè¿˜æœªæ£€æµ‹æˆåŠŸï¼Œè®¤ä¸ºå¯åŠ¨å¤±è´¥ã€‚</p><h2 id="å­˜æ´»æ¢æµ‹å™¨-livenessProbe">å­˜æ´»æ¢æµ‹å™¨ livenessProbe</h2><p>ç›®çš„åœ¨äºç¡®è®¤å®¹å™¨æ˜¯å¦å¥åº·ï¼Œå¹¶åœ¨ä¸å¥åº·çš„æ—¶å€™é‡å¯å®¹å™¨ã€‚</p><p>å®ƒå°†åœ¨å®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œã€‚</p><p>å®ƒä¸å°±ç»ªæ¢æµ‹å™¨æœ€å¤§åŒºåˆ«å°±æ˜¯ï¼Œkubeletæ£€æµ‹å¤±è´¥åä¼šé‡å¯å®¹å™¨ã€‚</p><p>ä¾‹å­å¦‚ä¸‹ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  labels:    test: liveness  name: liveness-httpspec:  containers:  - name: liveness    image: k8s.gcr.io/liveness    args:    - /server    livenessProbe:      httpGet:        path: /healthz        port: 8080        httpHeaders:        - name: Custom-Header          value: Awesome      initialDelaySeconds: 3      periodSeconds: 3</code></pre><blockquote><p>æ¢æµ‹å™¨ä¼šè®¤ä¸º 200&lt;=x&lt;400 çš„çŠ¶æ€ç ä¸ºæ­£å¸¸ã€‚</p></blockquote><h2 id="å°±ç»ªæ¢æµ‹å™¨-readinessProbe">å°±ç»ªæ¢æµ‹å™¨ readinessProbe</h2><p>ç›®çš„åœ¨äºä»…ç¡®è®¤å®¹å™¨æ˜¯å¦å¥åº·ï¼Œä½†æ˜¯å¹¶ä¸åˆ é™¤å®¹å™¨ï¼Œã€ä¸å¥åº·æ—¶å€™ä¸æ¥æ”¶svcæµé‡ã€‘ ã€‚é€‚ç”¨äºä¸‹åˆ—åœºæ™¯ï¼š</p><ol><li>å®¹å™¨å¯åŠ¨åï¼ŒåŠ è½½æ•°æ®å¤šï¼ŒåŠ è½½å®Œä¹‹å‰æ— æ³•æä¾›æœåŠ¡</li></ol><p>å®ƒå°†åœ¨å®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œã€‚</p><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml:">apiVersion: v1kind: Podmetadata:  name: goproxy  labels:    app: goproxyspec:  containers:  - name: goproxy    image: k8s.gcr.io/goproxy:0.1    ports:    - containerPort: 8080    readinessProbe:      tcpSocket:        port: 8080      initialDelaySeconds: 5      periodSeconds: 10</code></pre><p>ä¸Šè¿°ä¾‹å­æ„æ€æ˜¯ï¼škubelet ç­‰å¾… initialDelaySeconds åå¼€å§‹ç¬¬ä¸€æ¬¡æ£€æµ‹ï¼Œæ¯æ¬¡æ£€æµ‹é—´éš”10ç§’ï¼Œæ£€æµ‹æˆåŠŸï¼Œè®¤ä¸ºå¯ä»¥æä¾›æœåŠ¡</p><h2 id="æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</h2><ol><li>å­˜æ´»å’Œå°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æ˜¯ä¸¤ä¸ªäº’ç›¸ç‹¬ç«‹çš„æ¥å£</li><li>å­˜æ´»æ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æ˜¯ç›´æ¥è¿”å›http codeï¼Œä¸åº”è¯¥æœ‰ä»»ä½•é€»è¾‘</li><li>å°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æä¾›å°±ç»ªæ‰€éœ€è¦çš„é€»è¾‘ã€‚ä½†æ˜¯ä¸åº”è¯¥æ·»åŠ é‡æ–°æ„å»ºå°±ç»ªçš„é€»è¾‘ã€‚ä¾‹å¦‚ï¼šå¤„ç†httpè¯·æ±‚çš„ç¨‹åºéœ€è¦ä¸€ä¸ªæ•°æ®åº“è¿æ¥çš„å°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨å°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£é‡Œæ·»åŠ æ•°æ®åº“è¿æ¥çš„æ£€æŸ¥é€»è¾‘ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜é¢„è­¦</title>
      <link href="posts/4ebbd3a8/"/>
      <url>posts/4ebbd3a8/</url>
      
        <content type="html"><![CDATA[<p>å®šä¹‰é¢„è­¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤</p><ol><li>å®šä¹‰é¢„è­¦åª’ä»‹</li><li>å®šä¹‰é¢„è­¦ç”¨æˆ·</li><li>å®šä¹‰é¢„è­¦åŠ¨ä½œ</li></ol><p>è§¦å‘å™¨è¾¾åˆ°é˜ˆå€¼ï¼Œè°ƒç”¨é¢„è­¦åŠ¨ä½œï¼Œé¢„è­¦åŠ¨ä½œè°ƒç”¨é¢„è­¦ç”¨æˆ·ï¼Œé¢„è­¦ç”¨æˆ·è°ƒç”¨é¢„è­¦åª’ä»‹</p><h2 id="é¢„è­¦åª’ä»‹">é¢„è­¦åª’ä»‹</h2><p>é…ç½®-æŠ¥è­¦åª’ä»‹ç±»å‹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªè¦ç´ </p><h3 id="æŠ¥è­¦åª’ä»‹ç±»å‹">æŠ¥è­¦åª’ä»‹ç±»å‹</h3><p>ç±»å‹æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚é‚®ä»¶ï¼Œè‡ªå®šä¹‰è„šæœ¬ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰è‡ªå®šä¹‰è„šæœ¬ï¼Œæ¥å®šä¹‰ä¸€ä¸ªä¼ä¸šå¾®ä¿¡é¢„è­¦</p><p><img src="/posts/4ebbd3a8/image-20200902144015196.png" alt="image-20200902144015196"></p><p>è„šæœ¬éœ€è¦æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><p>{ALERT.SENDTO}ï¼šæ”¶ä»¶äºº</p><p>{ALERT.SUBJECT}ï¼šä¸»é¢˜</p><p>{ALERT.MESSAGE}ï¼šå†…å®¹</p><p>æˆ‘ä»¬ä¸€èˆ¬åªç”¨{ALERT.SENDTO}å’Œ{ALERT.MESSAGE}å³å¯</p><h3 id="ä¿¡æ¯æ¨¡æ¿">ä¿¡æ¯æ¨¡æ¿</h3><p>å®šä¹‰ä¿¡æ¯æ¨¡æ¿ï¼Œä¸€èˆ¬æˆ‘ä»¬å®šä¹‰å‘Šè­¦æ¨¡æ¿/æ¢å¤æ¨¡æ¿/è‡ªåŠ¨æ³¨å†Œæ¨¡æ¿</p><p>å‘Šè­¦æ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144408513.png" alt="image-20200902144408513"></p><pre><code>ã€[éª·é«…]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ : &#123;EVENT.ID&#125;ã€é—®é¢˜æ—¶é—´ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125; ã€é—®é¢˜åå­—ã€‘: &#123;EVENT.NAME&#125;ã€é—®é¢˜ä¸»æœºã€‘: &#123;HOST.NAME&#125;ã€é—®é¢˜çº§åˆ«ã€‘: &#123;EVENT.SEVERITY&#125;ã€é˜ˆå€¼ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€é˜ˆå€¼é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;ã€Operational dataã€‘: &#123;EVENT.OPDATA&#125;&#123;TRIGGER.URL&#125;</code></pre><p>æ¢å¤æ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144504865.png" alt="image-20200902144504865"></p><pre><code>ã€[OK]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ : &#123;EVENT.ID&#125;ã€é—®é¢˜æ—¶é—´ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125; ã€é—®é¢˜æ¢å¤æ—¶é—´ã€‘: &#123;EVENT.RECOVERY.DATE&#125;  &#123;EVENT.RECOVERY.TIME&#125;ã€é—®é¢˜åå­—ã€‘: &#123;EVENT.NAME&#125;ã€é—®é¢˜ä¸»æœºã€‘: &#123;HOST.NAME&#125;ã€é—®é¢˜çº§åˆ«ã€‘: &#123;EVENT.SEVERITY&#125;ã€é˜ˆå€¼ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€é˜ˆå€¼é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;ã€Operational dataã€‘: &#123;EVENT.OPDATA&#125;&#123;TRIGGER.URL&#125;</code></pre><p>è‡ªåŠ¨æ³¨å†Œæ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144535568.png" alt="image-20200902144535568"></p><pre><code>è‡ªåŠ¨æ³¨å†Œ: ä¸»æœºå: &#123;HOST.HOST&#125;ä¸»æœºip: &#123;HOST.IP&#125;ä»£ç†ç«¯å£: &#123;HOST.PORT&#125;</code></pre><h3 id="æ”¾ç½®å‘é€ä¿¡æ¯çš„è„šæœ¬">æ”¾ç½®å‘é€ä¿¡æ¯çš„è„šæœ¬</h3><p>å…·ä½“ä½ç½®ä»¥zb serverçš„å®‰è£…å’Œé…ç½®ä¸ºåŸºå‡†.</p><pre><code class="language-python">#!/usr/bin/env python3&quot;&quot;&quot;@author: zyh@contact: aaa103439@hotmail.com@software: vscode@file: sendchat.py@time: 2020/02/05@use: pip3 install requests configparser&quot;&quot;&quot;import sys, os, requests, pathlib, json, configparserimport loggingimport logging.handlersfrom datetime import datetimeclass PySendchat():    def __init__(self, corpid, agentid, secret, touser, content):        self.corpid=corpid        self.agentid=agentid        self.secret=secret        self.touser=touser        self.content=content        LOG_PATHDIR=os.path.dirname(os.path.abspath(__file__))        LOG_FILENAME = '&#123;0&#125;/sendchat.log'.format(LOG_PATHDIR)        self.my_logger = logging.getLogger('SendChat')        self.my_logger.setLevel(logging.INFO)        # Add the log message handler to the logger        handler = logging.handlers.RotatingFileHandler(LOG_FILENAME, maxBytes=102400000, backupCount=5)        # create formatter and add it to the handlers        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')        handler.setFormatter(formatter)        self.my_logger.addHandler(handler)    def gettoken(self):        self.my_logger.info('-----------------------------------------------------------------------------------------')        pwd=os.path.dirname(os.path.abspath(__file__))        tokenfile='&#123;0&#125;/wechat.&#123;1&#125;'.format(pwd,self.agentid)        if pathlib.Path(tokenfile).exists():            tokenfilectime=os.path.getctime(tokenfile)            currenttime=datetime.now().timestamp()            dtime=currenttime-tokenfilectime            self.my_logger.info('&#123;0&#125; lived &#123;1&#125;s.'.format(tokenfile, dtime))            if dtime &gt;= 7200:                try:                    os.remove(tokenfile)                    self.my_logger.info('Token file &#123;0&#125;: delete success'.format(tokenfile))                except Exception as e:                    self.my_logger.error('Token file:&#123;0&#125; delete error.Reason:&#123;1&#125;'.format(tokenfile,e))                    exit        # check token file        try:            tokensize = os.path.getsize(tokenfile)        except Exception as e:            self.my_logger.info('Token file is not exist.Reason:&#123;0&#125;'.format(e))            tokensize = 0        # get token from token file        if tokensize != 0:            with open(tokenfile, 'rb') as fd:                token = fd.read() # get token success                self.my_logger.info('Get token from token file.')            jsonObject = json.loads(token.decode(encoding='utf8'))            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token        # get token from weixin api        else:            try:                self.my_logger.info('New Token Create.')                f = requests.get('https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#123;0&#125;&amp;corpsecret=&#123;1&#125;'.format(self.corpid, self.secret))                token = f.content                self.my_logger.info('Get token from weixin api.')                jsonObject = json.loads(token.decode(encoding='utf8'))                errcode=int(jsonObject.get(&quot;errcode&quot;))                if errcode != 0:                    errmsg=jsonObject.get(&quot;errmsg&quot;)                    self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(errmsg))                    exit()            except Exception as e:                self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(e))                exit()            try:                self.my_logger.info('Write token to &#123;0&#125;.'.format(tokenfile))                with open(tokenfile, 'wb') as fd:                    fd.write(token)            except Exception as e:                self.my_logger.error('Write &#123;0&#125; error!Reason:&#123;1&#125;'.format(tokenfile,e))                exit()            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token    def sendmsg(self):        accessToken = self.gettoken()        self.my_logger.info('Token:&#123;0&#125;'.format(accessToken))        sendMapDirectroy = &#123;&#125;        sendMapDirectroy[&quot;agentid&quot;] = self.agentid        sendMapDirectroy[&quot;touser&quot;] = self.touser        sendMapDirectroy[&quot;msgtype&quot;] = &quot;text&quot;        sendMapDirectroy[&quot;safe&quot;] = &quot;0&quot;        contentDirectory = &#123;&#125;        sendMapDirectroy[&quot;text&quot;] = contentDirectory        contentDirectory[&quot;content&quot;] = self.content        bodyStr = json.dumps(sendMapDirectroy, ensure_ascii=False).encode(encoding=&quot;utf-8&quot;)        try:            f = requests.post(url=&quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % accessToken,                          data=bodyStr, timeout=5)            self.my_logger.info(f.content)        except Exception as e:            self.my_logger.error('Send chat network error!Reason:&#123;0&#125;'.format(e))if __name__ == '__main__':    appname = sys.argv[1]    content = sys.argv[3]    # read conf.ini    conf = configparser.ConfigParser()    conf_path = os.path.dirname(os.path.abspath(__file__))    conf_ini = &quot;&#123;0&#125;/conf.ini&quot;.format(conf_path)    if pathlib.Path(conf_ini).exists():        conf.read(conf_ini)        corpid = conf.get(&quot;wechat&quot;, &quot;corpid&quot;)        appinfo = conf.get(&quot;app&quot;, appname)        agentid = appinfo.split(':')[0]        secret = appinfo.split(':')[1]        groupname = conf.get(&quot;group&quot;, appname)        touser = groupname.split(':')[0]        chatobj = PySendchat(corpid, agentid, secret, touser, content)    else:        print('conf.ini error')        exit()    try:        chatobj.sendmsg()    except:        chatobj.my_logger.error(&quot;Send chat failure!&quot;)</code></pre><pre><code class="language-ini"># conf.ini[wechat]corpid = [app]it = &lt;app_agent_id&gt;:&lt;app_secret&gt;[group]it = usera|userb</code></pre><p>eg:</p><p>python3 <a href="http://wechat.py">wechat.py</a> it â€˜â€™ &lt;é¢„è­¦å†…å®¹&gt;</p><p>å›  zabbix è°ƒç”¨è„šæœ¬å¹¶é root ç”¨æˆ·ï¼Œæ‰€ä»¥ç»™è„šæœ¬é™„åŠ  x æƒé™ï¼Œé¿å…æƒé™é—®é¢˜ã€‚</p><pre><code class="language-bash">chmod a+x wechat.py# å› è„šæœ¬ä¼šç”Ÿæˆå…¶å®ƒæ–‡ä»¶# æ‰€ä»¥è¿˜éœ€è¦ç»™è„šæœ¬æ‰€åœ¨çš„ç›®å½•æ·»åŠ å…¶å®ƒç”¨æˆ·çš„å†™å…¥æƒé™chmod 757 alertscripts</code></pre><h2 id="é¢„è­¦ç”¨æˆ·">é¢„è­¦ç”¨æˆ·</h2><p>ç®¡ç†-ç”¨æˆ·-æ·»åŠ ç”¨æˆ·ï¼Œè¿™é‡Œæœ‰ä¸‰è¦ç´ </p><h3 id="ç”¨æˆ·">ç”¨æˆ·</h3><p>ä½ æ— éœ€ç™»é™†è¿™ä¸ªç”¨æˆ·ï¼Œæ‰€ä»¥å¯†ç å¯ä»¥å°½é‡çš„å¤æ‚</p><p><img src="/posts/4ebbd3a8/image-20200902150131147.png" alt="image-20200902150131147"></p><h3 id="æŠ¥è­¦åª’ä»‹">æŠ¥è­¦åª’ä»‹</h3><p><img src="/posts/4ebbd3a8/image-20200902150145022.png" alt="image-20200902150145022"></p><blockquote><p>æˆ‘ä»¬å®šä¹‰è¿™ä¸ªç”¨æˆ·è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°†ä¼šå‘é€ä¿¡æ¯ç»™itç»„ï¼Œè‡³äºitç»„åŒ…å«å“ªäº›äººå‘˜ï¼Œåˆ™ç”±è„šæœ¬å®šä¹‰ã€‚</p></blockquote><h3 id="æƒé™">æƒé™</h3><p><img src="/posts/4ebbd3a8/image-20200902150153011.png" alt="image-20200902150153011"></p><h2 id="é¢„è­¦åŠ¨ä½œ">é¢„è­¦åŠ¨ä½œ</h2><p>é…ç½®-åŠ¨ä½œ-å·¦ä¸Šè§’ï¼ˆè§¦å‘å™¨åŠ¨ä½œTrigger actionsï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªè¦ç´ </p><ol><li>ä»€ä¹ˆæ¡ä»¶ä¸‹æ‰§è¡ŒåŠ¨ä½œ</li><li>åŠ¨ä½œçš„å®é™…è¡Œä¸º</li></ol><h3 id="æ¡ä»¶">æ¡ä»¶</h3><p>éœ€è¦æ³¨æ„çš„æ˜¯è®¡ç®—æ–¹å¼</p><blockquote><p>é—®é¢˜æ²¡æœ‰è¢«åˆ¶æ­¢çš„æ„æ€ï¼šæ²¡æœ‰äººä¸ºçš„å…³é—­é¢„è­¦</p></blockquote><p><img src="/posts/4ebbd3a8/image-20200902150806009.png" alt="image-20200902150806009"></p><h3 id="æ“ä½œ">æ“ä½œ</h3><p><img src="/posts/4ebbd3a8/image-20200902151037597.png" alt="image-20200902151037597"></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> wechat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜å®¹å™¨æ­å»º</title>
      <link href="posts/25f36846/"/>
      <url>posts/25f36846/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆ›å»ºç½‘ç»œ">åˆ›å»ºç½‘ç»œ</h2><pre><code class="language-bash">docker network create -d bridge zbnet</code></pre><h2 id="mysql">mysql</h2><pre><code class="language-bash">mkdir -p /export/docker-data-mysql/&#123;config,logs,data&#125;docker run --name mysql57 \-p 3306:3306 \--network zbnet \--restart=always \--mount 'type=bind,src=/export/docker-data-mysql/config,dst=/etc/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/logs,dst=/var/log/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/data,dst=/var/lib/mysql' \-e MYSQL_ROOT_PASSWORD=123456 \-d mysql:5.7</code></pre><h2 id="zabbix-server">zabbix-server</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-server-mysql">https://hub.docker.com/r/zabbix/zabbix-server-mysql</a></p></blockquote><p>å®‰è£… centos + server + mysql ç‰ˆæœ¬</p><p>é»˜è®¤ï¼Œç¯å¢ƒå˜é‡ <code>MYSQL_USER</code> and <code>MYSQL_PASSWORD</code> are <code>zabbix</code>, <code>zabbix</code>.</p><pre><code>mkdir -p /export/docker-data-zbserver/alertscriptsdocker volume create zabbixServerEtcdocker run --name=zabbix_server \-p 10051:10051 \--network zbnet \--restart=always \--mount 'type=volume,src=zabbixServerEtc,dst=/etc/zabbix' \--mount 'type=bind,src=/export/docker-data-zbserver/alertscripts,dst=/usr/lib/zabbix/alertscripts' \-e DB_SERVER_HOST=&quot;mysql57&quot; \-e MYSQL_DATABASE=&quot;zabbixserver&quot; \-e MYSQL_USER=&quot;zabbix&quot; \-e MYSQL_PASSWORD=&quot;zabbix&quot; \-e MYSQL_ROOT_PASSWORD=&quot;123456&quot; \-d zabbix/zabbix-server-mysql:centos-latest</code></pre><ol><li><p>é»˜è®¤å®‰è£…å®Œä¹‹åï¼Œå®¹å™¨å†…ç¼ºå°‘ä¸€äº›å¼€å‘ç¯å¢ƒï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬çš„å‘Šè­¦è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œæ¯”å¦‚æˆ‘æ˜¯ç”¨ python3 å†™çš„å¾®ä¿¡å‘Šè­¦ï¼Œè€Œç¯å¢ƒé‡Œæ²¡æœ‰ã€‚å› æ­¤éœ€è¦é¢å¤–åŠ è£…ã€‚</p><pre><code class="language-bash">docker logs -f zabbix_server # å¯ä»¥çœ‹åˆ°å¦‚ä¸‹é”™è¯¯203:20200831:030724.713 Failed to execute command &quot;/usr/lib/zabbix/alertscripts/wechat.py 'it' 'è‡ªåŠ¨æ³¨å†Œ: xxx-use-001-10-240-128-100' 'ä¸»æœºå: xxx-use-001-10-240-128-100ä¸»æœºip: xxxä»£ç†ç«¯å£: 10050'&quot;: env: 'python3': No such file or directory</code></pre><pre><code class="language-bash"># å®‰è£… python3 å’Œæ¨¡å—docker exec -it -u root zabbix_server yum install python3docker exec -it -u root zabbix_server pip3 install requests configparser</code></pre></li><li><p>alertscripts ç›®å½•éœ€è¦æœ‰ other å¯æ‰§è¡Œæƒé™</p><pre><code class="language-bash">chmod o+w /export/docker-data-zbserver/alertscripts</code></pre><p>å› ä¸º zabbix_server åœ¨æ‰§è¡Œå‘Šè­¦è„šæœ¬çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯æ™®é€šç”¨æˆ·</p></li></ol><h2 id="zabbix-server-web">zabbix-server-web</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-web-nginx-mysql">https://hub.docker.com/r/zabbix/zabbix-web-nginx-mysql</a></p></blockquote><pre><code class="language-bash"># å®‰è£…å­—ä½“yum install google-noto-sans-simplified-chinese-fonts.noarch -ydocker run --name zabbix_web \-p 80:8080 \-p 443:8443 \--restart=always \--network zbnet \--mount 'type=bind,src=/usr/share/fonts/google-noto/NotoSansSC-Regular.otf,dst=/usr/share/zabbix/assets/fonts/DejaVuSans.ttf' \-e DB_SERVER_HOST=&quot;mysql57&quot; \-e MYSQL_DATABASE=&quot;zabbixserver&quot; \-e MYSQL_USER=&quot;zabbix&quot; \-e MYSQL_PASSWORD=&quot;zabbix&quot; \-e MYSQL_ROOT_PASSWORD=&quot;123456&quot; \-e ZBX_SERVER_HOST=&quot;zabbix_server&quot; \-e PHP_TZ=&quot;Asia/Shanghai&quot; \-d zabbix/zabbix-web-nginx-mysql:latest</code></pre><blockquote><p><a href="http://ip">http://ip</a> å³å¯</p><p>åˆå§‹è´¦æˆ·å¯†ç æ˜¯ Admin/zabbix</p></blockquote><p>åˆ°è¿™é‡Œï¼Œä½ å°±å¯ä»¥è®¿é—®zabbixäº†ï¼Œä¸è¿‡è¿™æ—¶å€™ä½ ä¼šå‘ç°zabbixæç¤ºagentä¸å¯è¾¾</p><p><img src="/posts/25f36846/image-20200901172913999.png" alt="image-20200901172913999"></p><p>å…¶åŸå› æ˜¯æˆ‘ä»¬è¿˜æ²¡åˆ›å»ºagent</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºé»˜è®¤zabbix serverçš„ä¸»æœºé…ç½®é¡¹ç›‘å¬çš„æ˜¯ 127.0.0.1:10050, å¹¶ä¸”ä¸»æœºåé…ç½®çš„æ˜¯</p><p><code>zabbix server</code>. è¿™å’Œæˆ‘ä»¬æœ¬æ–‡æ¡£æœ‰ä¸€äº›å†²çªï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€äº›é…ç½®ã€‚</p><ol start="2"><li>ä¿®æ”¹ä¸»æœºé…ç½®ä¸­çš„ hostname ä¸º agent å®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡ ZBX_HOSTNAMEã€‚è¿™é‡Œæˆ‘ä»¬ä¸º zabbix_server</li><li>ä¿®æ”¹ä¸»æœºé…ç½®ä¸­çš„ç›‘å¬åœ°å€ä¸º zabbix_serverï¼Œä¸”ç›‘å¬æ–¹å¼ä¸º dns</li></ol><p>æœ€ç»ˆä¿®æ”¹å®Œå¦‚ä¸‹ï¼š</p><p><img src="/posts/25f36846/image-20200901175159400.png" alt="image-20200901175159400"></p><h2 id="zabbix-agent">zabbix-agent</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-agent">https://hub.docker.com/r/zabbix/zabbix-agent</a></p></blockquote><pre><code class="language-bash">docker volume create zbAgentEtcdocker run --name zabbix_agent \--network=container:zabbix_server \--mount 'type=volume,src=zbAgentEtc,dst=/etc/zabbix/zabbix_agentd.d' \-e ZBX_DEBUGLEVEL=&quot;3&quot; \-e ZBX_HOSTNAME=&quot;zabbix_server&quot; \-e ZBX_SERVER_HOST=&quot;zabbix_server&quot; \-d zabbix/zabbix-agent:latest</code></pre><p>è¿™é‡Œ zabbix_agent é‡‡ç”¨ç½‘ç»œæ¨¡å¼ä¸ºå®¹å™¨æ¨¡å¼ï¼Œå¹¶åŠ å…¥åˆ° zabbix_server å®¹å™¨ä¸­ï¼Œä»¥ä¾¿äº zabbix_server å¯ä»¥æ‰¾åˆ° zabbix_agent</p><p>å…¶å®ƒé…ç½®å˜é‡è¯¦è§ä¸Šé¢å®˜æ–¹æ–‡æ¡£</p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜ç¦»çº¿è¿ç§»è„šæœ¬</title>
      <link href="posts/c83ca575/"/>
      <url>posts/c83ca575/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash">databases=&quot;&quot;mysqltonew()&#123;    olddatabasehost=    olddatabaseport=    olddatabase=$1    oldUserName=    oldpassword=    newdatabasehost=    newolddatabaseport=    newdatabase=$&#123;olddatabase&#125;    newUserName=    newpassword=    # utf8 / utf8mb4    read -p &quot;character [utf8/utf8mb4/latin1]:&quot; Character    # å¯¼å‡ºè€åº“    mysqldump -u$&#123;oldUserName&#125; -p$&#123;oldpassword&#125; -h$&#123;olddatabasehost&#125; -P$&#123;olddatabaseport&#125; --default-character-set=$&#123;Character&#125; --single-transaction $&#123;olddatabase&#125; &gt; $&#123;olddatabase&#125;.sql    # åˆ›å»ºæ–°åº“    mysql -u$&#123;newUserName&#125; -p$&#123;newpassword&#125; -h$&#123;newdatabasehost&#125; -P$&#123;newolddatabaseport&#125; -e &quot;CREATE DATABASE $&#123;newdatabase&#125; DEFAULT CHARSET $&#123;Character&#125; COLLATE $&#123;Character&#125;_general_ci;&quot;    # å¯¼å…¥æ–°åº“    mysql -u$&#123;newUserName&#125; -p$&#123;newpassword&#125; -h$&#123;newdatabasehost&#125; -P$&#123;newolddatabaseport&#125; --default-character-set=$&#123;Character&#125; $&#123;newdatabase&#125; &lt; $&#123;olddatabase&#125;.sql&#125;for i in $&#123;databases&#125;;do        echo &quot;start $i&quot;        mysqltonew $idone</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> mysqldump </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜03Pod</title>
      <link href="posts/94518966/"/>
      <url>posts/94518966/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>pod å¯ä»¥è¯´æ˜¯ k8s çš„åŸºç¡€å•å…ƒ. æˆ‘è§‰å¾—å¯ä»¥ç±»æ¯”äº‘ç¯å¢ƒçš„ecs/ec2è¿™ä¸€ç±»çš„åŸºæœ¬è®¡ç®—å•å…ƒ.è€Œ pod ä¸Šè¿è¡Œçš„å®¹å™¨ï¼Œ å¯ä»¥ç±»æ¯”ä¸ºecs/ec2ä¸Šçš„appç¨‹åº.</p><p>ä½ æ€»èƒ½åœ¨k8sçš„å„ç±»èµ„æºä¸­æ‰¾åˆ°äº‘ç¯å¢ƒå¯¹åº”çš„èµ„æºå½±å­. å¦‚æœä½ ç”¨è¿‡GCPï¼Œä½ ä¼šæ›´æœ‰è¿™ç§æ„Ÿè§‰.</p><p><a href="https://kubernetes.io/docs/concepts/workloads/pods/">https://kubernetes.io/docs/concepts/workloads/pods/</a></p><h2 id="Podä¸å®¹å™¨">Podä¸å®¹å™¨</h2><p>ä¸€ä¸ªpodå¯ä»¥æ‹¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œå¹¶ä¸”åŒ…å«ä¸€ä¸ªinitçš„ç‰¹æ®Šå®¹å™¨ï¼Œå®ƒå§‹ç»ˆé¦–å…ˆè¿è¡Œã€‚</p><p>è‹¥podåªæœ‰ä¸€ä¸ªå®¹å™¨ï¼Œé‚£ä¹ˆpodå°±æ˜¯ä¸€ä¸ªåŒ…è£…å™¨</p><p>è‹¥podæœ‰å¤šä¸ªå®¹å™¨ï¼Œåˆ™ä¸€èˆ¬ä¸»å®¹å™¨æä¾›æœåŠ¡ï¼›è¾¹è½¦/æŒ‚æ–—/é™„å±å®¹å™¨æä¾›é¢å¤–åŠŸèƒ½ï¼Œä¾‹å¦‚åˆ·æ–°ä¸»å®¹å™¨çš„æ–‡ä»¶ã€‚</p><p>â„¹ï¸ä¸Šè¿°çš„åŠŸèƒ½çš„å®ç°åŸºäºpodå†…çš„å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´å’Œå­˜å‚¨ç©ºé—´.</p><p><img src="https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg" alt="example pod diagram"></p><blockquote><p>å¦‚æœä½ ç©è¿‡æ˜Ÿé™…äº‰éœ¸ï¼Œé‚£ä¹ˆåº”è¯¥çŸ¥é“ä¸€ä¸ªäººæ—å»ºç­‘ç‰©ï¼Œæ€»æ˜¯ä¼šæœ‰ä¸€ä¸ªé™„å±å»ºç­‘ç‰©ï¼Œå®ƒå¾ˆå°ï¼Œä½†æä¾›äº†ä¸»å»ºç­‘ç‰©æ‰€éœ€çš„ç§‘æŠ€ã€‚</p></blockquote><p>å› æ­¤ï¼Œé™¤éä½ ä¸¤ä¸ªå®¹å™¨å¿…é¡»æ”¾åœ¨ä¸€èµ·ï¼Œå¦åˆ™ä½ åº”è¯¥ç”¨å¤šä¸ªå•å®¹å™¨pod.</p><h2 id="Podä¸è´Ÿè½½æ§åˆ¶å™¨">Podä¸è´Ÿè½½æ§åˆ¶å™¨</h2><p>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œpod ä¸€èˆ¬ä¸å•ç‹¬ä½¿ç”¨ï¼Œå› ä¸ºå•ç‹¬ä½¿ç”¨æ„å‘³ç€æ²¡æœ‰é«˜å¯ç”¨ï¼Œä¸”éš¾ä»¥ç®¡ç†ã€‚k8så»ºè®® pod è¦å§‹ç»ˆå’Œè´Ÿè½½æ§åˆ¶å™¨ä¸€èµ·ä½¿ç”¨ã€‚è´Ÿè½½æ§åˆ¶å™¨å¯ä»¥æ‰¹é‡åˆ›å»ºpodã€‚</p><p>k8så°†è´Ÿè½½æ§åˆ¶å™¨ä¸»è¦åˆ†ä¸ºä¸‰ç§:</p><ul><li>Deployment æ— çŠ¶æ€ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></li><li>StatefulSet æœ‰çŠ¶æ€ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/</a></li><li>DaemonSet å®ˆæŠ¤æ€ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</a></li></ul><p>è¿˜æœ‰CronJobã€Jobsä»»åŠ¡ç±»å‹çš„.</p><p>è´Ÿè½½æ§åˆ¶å™¨éœ€è¦ä¾æ‰˜äºé•œåƒæ¨¡æ¿åˆ›å»º pod å’Œä¾æ‰˜äºç¼©æ”¾è§„åˆ™æ§åˆ¶ pod æ•°é‡ã€‚</p><p>é•œåƒæ¨¡æ¿å³ pod æ¨¡æ¿(pod template).</p><h2 id="è´Ÿè½½æ§åˆ¶å™¨-Podæ¨¡æ¿">è´Ÿè½½æ§åˆ¶å™¨ - Podæ¨¡æ¿</h2><p>ä¸€ä¸ªæ„å»ºnginxçš„ä¾‹å­</p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-deployment  labels:    app: nginxspec:  replicas: 3  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: nginx:1.14.2        ports:        - containerPort: 80</code></pre><h3 id="å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„kindæ‰€å±çš„apiVersion">å¦‚ä½•å¯»æ‰¾æœ€åˆé€‚çš„kindæ‰€å±çš„apiVersion</h3><p>åœ¨è¿™é‡Œå¯èƒ½æœ‰äººä¸çŸ¥é“å¦‚ä½•é€‰æ‹©apiVersionã€‚ä½ å¯ä»¥é€šè¿‡kubectl api-versionsæ¥æ‰¾åˆ°kindæ‰€å±çš„apiGroupï¼Œç„¶åå†é€šè¿‡</p><p>kubectl get --raw â€œ/apisâ€ çš„è¾“å‡ºæ‰¾ preferredVersionã€‚</p><pre><code class="language-bash">âœ   kubectl api-resources | grep deploymentdeployments                       deploy       apps/v1                                true         Deploymentâœ   kubectl get --raw &quot;/apis&quot;|jq '.groups[]|select(.name==&quot;apps&quot;)'&#123;  &quot;name&quot;: &quot;apps&quot;ï¼Œ  &quot;versions&quot;: [    &#123;      &quot;groupVersion&quot;: &quot;apps/v1&quot;ï¼Œ      &quot;version&quot;: &quot;v1&quot;    &#125;  ]ï¼Œ  &quot;preferredVersion&quot;: &#123;    &quot;groupVersion&quot;: &quot;apps/v1&quot;ï¼Œ    &quot;version&quot;: &quot;v1&quot;  &#125;&#125;</code></pre><p>å¦‚ä¸Šå‘½ä»¤æ‰€ç¤ºï¼Œåœ¨æˆ‘çš„k8sç‰ˆæœ¬ä¸­kind: Deploymentçš„æœ€åˆé€‚apiVersionæ˜¯apps/v1</p><h2 id="pod-å­˜å‚¨">pod å­˜å‚¨</h2><p>è¿™æ˜¯ä¸€ä¸ªå¤§é—®é¢˜. å¦‚æœä½ æƒ³çœŸæ­£çš„ä½¿ç”¨k8sçš„podèµ„æºï¼Œ é‚£ä¹ˆéœ€è¦å…ˆçœ‹è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹.</p><p>ç®€å•æ¥è¯´ï¼Œ å­˜å‚¨èµ„æºä¸»è¦åˆ†ç½‘ç»œå’Œæœ¬åœ°ä¸¤å¤§ç±».</p><ul><li><p>æœ¬åœ° ç”¨äºä¸´æ—¶æˆ–è€…ç‰¹æ®Šç¯å¢ƒ. å°±å¦‚åŒäº‘æœåŠ¡ä¸­çš„ã€å­˜å‚¨ç±»èŠ‚ç‚¹ã€‘é‡Œçš„é‚£ç§æœ¬åœ°ç›˜ï¼Œ å®ƒä¸å¯é . å› ä¸ºpodæœ¬èº«é»˜è®¤æ˜¯ä¸å¼ºåˆ¶ç»‘å®šæŸä¸ªèŠ‚ç‚¹çš„ï¼Œå› æ­¤å¦‚æœä½ podå¼‚å¸¸äº†ï¼Œé‚£ä¹ˆå®ƒæœ‰å¯èƒ½é‡å»ºçš„æ—¶å€™æ¼‚ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹.æ­¤æ—¶ä½ å¦‚æœç”¨æœ¬åœ°ç›˜ï¼Œé‚£ä¹ˆæ•°æ®å°†ä¸¢å¤±ã€‚</p></li><li><p>ç½‘ç»œ å¯ä»¥å¯¹æ¥çš„æœ‰äº‘æœåŠ¡å‚å®¶çš„å­˜å‚¨èµ„æºï¼Œä¹Ÿå¯ä»¥å¯¹æ¥è‡ªå»ºçš„nfsè¿™ä¸€ç±»ç½‘ç»œå­˜å‚¨ã€‚</p></li></ul><p>ç»†è‡´çš„è¯´æ˜ï¼Œ å‚è€ƒå®˜æ–¹æ–‡æ¡£https://kubernetes.io/docs/concepts/storage/</p><h2 id="pod-ç½‘ç»œ">pod ç½‘ç»œ</h2><p>é‰´äºå‰é¢æåˆ°çš„podç±»åŒäºecs/ec2. å› æ­¤. podä¸­çš„å®¹å™¨å°±å¦‚åŒecs/ec2é‡Œçš„appä¸€æ ·ï¼Œéƒ½æœ‰ç›¸åŒçš„ipï¼Œ ç«¯å£èŒƒå›´ï¼Œ ä¸»æœºå.</p><p>k8sçš„ç½‘ç»œåŸºäºå„ç§æ’ä»¶.æ¯ä¸€ç§æ’ä»¶çš„å®ç°è¯¦æƒ…è§å®˜ç½‘. <a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model">https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model</a></p><p>å¦‚æœä½ æ˜¯æœ¬åœ°æ­å»ºï¼Œ é‚£ä¹ˆå¸¸ç”¨çš„æ’ä»¶æ˜¯Flannel. å¦‚æœä½ æ˜¯åœ¨äº‘æœåŠ¡ä¸Šæ­å»ºï¼Œé‚£ä¹ˆå»ºè®®ä½¿ç”¨äº‘æœåŠ¡å·²æœ‰çš„k8sæœåŠ¡.</p><p>å¦‚æœä½ å¿…é¡»åœ¨äº‘æœåŠ¡ä¸Šè‡ªå·±æ­å»ºï¼Œé‚£ä¹ˆaws/azure/gcpéƒ½æœ‰å¯¹åº”çš„ç½‘ç»œæ’ä»¶.å®ƒå¯ä»¥è®©ä½ åœ¨k8sä¸­ç»“åˆä½¿ç”¨äº‘æœåŠ¡çš„ç½‘ç»œç»„ä»¶.</p><h2 id="é™æ€pod">é™æ€pod</h2><p>ç‰¹ç‚¹ï¼š</p><ol><li>æ°¸è¿œè¿è¡Œåœ¨å›ºå®šèŠ‚ç‚¹</li><li>ç”±æ‰€åœ¨èŠ‚ç‚¹çš„kubeletç®¡ç†ï¼Œä½†åªè´Ÿè´£ä¿æ´»ï¼Œå³podå´©æºƒé‡ç”Ÿ</li><li>kubeletä¼šè®©apiserveråˆ›å»ºä¸€ä¸ªé•œåƒpodï¼Œä¾¿äºå¯ä»¥é€šè¿‡kubectlæŸ¥è¯¢åˆ°é™æ€pod</li></ol><p>é…ç½®ï¼š</p><ol><li>å­˜æ”¾åœ¨ /etc/kubernetes/manifests å½“é‡‡ç”¨kubeadmå®‰è£…çš„æ—¶å€™ï¼Œä¸€èˆ¬ä½äºæ­¤ç›®å½•ã€‚å…·ä½“éœ€è¦å»çœ‹kubeleté…ç½®ã€‚</li><li>é…ç½®æœ¬èº«å¯ä»¥æŒ‰ç…§æ ‡å‡†podæ–¹å¼æ¥åˆ›å»º</li></ol><p>æ£€æµ‹ï¼š</p><ol><li>kubeletä¼šå®šæœŸæ£€æµ‹é…ç½®ç›®å½•åŠ è½½é…ç½®åˆ›å»º/é‡å»ºpod</li></ol><blockquote><p>å½“ä½ é€šè¿‡kubeadmåˆ›å»ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆk8sçš„å‡ ä¸ªé‡è¦ç»„ä»¶å‡ä¼šä»¥é™æ€podçš„æ–¹å¼åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œä½ å¯ä»¥åœ¨/etc/kubernetes/manifests/è¿™é‡Œæ‰¾åˆ°ä»–ä»¬çš„é…ç½®</p></blockquote><pre><code class="language-bash">âœ   ll /etc/kubernetes/manifests/total 16-rw------- 1 root root 1848 Aug 25 16:28 etcd.yaml-rw------- 1 root root 2709 Aug 25 16:28 kube-apiserver.yaml-rw------- 1 root root 2564 Aug 25 16:33 kube-controller-manager.yaml-rw------- 1 root root 1120 Aug 25 16:33 kube-scheduler.yaml</code></pre><h2 id="Pod-ç”Ÿå‘½å‘¨æœŸ">Pod-ç”Ÿå‘½å‘¨æœŸ</h2><p>podç”Ÿå‘½å‘¨æœŸåŒ…å«5ä¸ªçŠ¶æ€ï¼š</p><ul><li>pendingï¼Œè°ƒåº¦æ—¶é—´å’Œæ‹‰å–å®¹å™¨é•œåƒæ—¶é—´ï¼Œå®¹å™¨å‡å¤„äºwaitingçŠ¶æ€</li><li>runningï¼Œè‡³å°‘ä¸€ä¸ªå®¹å™¨å¤„äºå¯åŠ¨ã€é‡å¯ã€runningçŠ¶æ€</li><li>failedï¼Œpodé‡Œçš„å®¹å™¨å…¨é€€å‡ºï¼Œæœ‰éƒ¨åˆ†å®¹å™¨ä»¥é0çŠ¶æ€è¿›å…¥terminatedçŠ¶æ€</li><li>succeededï¼Œpodé‡Œçš„å®¹å™¨å…¨éƒ¨ä»¥0çŠ¶æ€è¿›å…¥terminatedçŠ¶æ€</li><li>unknownï¼Œpodæ‰€åœ¨èŠ‚ç‚¹å’Œä¸»èŠ‚ç‚¹ä¹‹é—´å¤±è”ï¼Œä¸è¿‡è¿™ç§çŠ¶æ€ä¼šå› k8sçš„ç­–ç•¥è½¬ä¸ºfailedçŠ¶æ€</li></ul><p>podæ˜¯é€šè¿‡uidæ¥é‰´åˆ«ï¼Œè€Œä¸æ˜¯podåï¼Œpodè¢«æ›¿æ¢æ—¶åç§°å¯ä»¥ä¸å˜ã€‚</p><h3 id="é‡å¯ç­–ç•¥">é‡å¯ç­–ç•¥</h3><p><a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/#lifecycle">https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/#lifecycle</a></p><p>podé‡å¯ç­–ç•¥çš„é—´éš”æ—¶é—´æ˜¯10sï¼ŒæˆæŒ‡æ•°ä¸Šæ¶¨ï¼Œä½†ä¸è¶…è¿‡5åˆ†é’Ÿã€‚ä¸€æ—¦é‡å¯æˆåŠŸä¸”è¿è¡Œ10åˆ†é’Ÿï¼Œåˆ™é‡ç½®ä¸º10sã€‚</p><h3 id="çŠ¶å†µ">çŠ¶å†µ</h3><p>é€šè¿‡<code>kubectl describe pod/&lt;pod_name&gt;</code>æŸ¥çœ‹<code>Conditions</code>å­—æ®µæ¡ä»¶</p><pre><code class="language-bash">Conditions:  Type              Status  Initialized       True  Ready             False  ContainersReady   False  PodScheduled      True</code></pre><blockquote><p>Readyä¸ºTrueï¼Œå³è¡¨ç¤ºã€åº”è¯¥ã€‘è¢«åŠ å…¥åˆ°svcçš„ç«¯ç‚¹åˆ—è¡¨ä¸­ã€‚</p><p>ä½†æç«¯æƒ…å†µä¸‹æœ‰å¯èƒ½å› ä¸ºå…¶å®ƒæœåŠ¡æ²¡å‡†å¤‡å¥½ï¼Œå¯¼è‡´åŠæ—¶Podçš„Readyä¸ºTrueï¼Œsvcä¹Ÿæ— æ³•æ­£å¸¸çš„è½¬å‘æµé‡åˆ°Podã€‚</p><p>è¿™ç§è¡Œä¸ºï¼Œå¯èƒ½åœ¨æ»šåŠ¨æ›´æ–°çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´ä¸¢æ•°æ®ã€‚</p></blockquote><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œkuberneteså…è®¸åœ¨ä¸Šé¢4ä¸ªé»˜è®¤çŠ¶æ€çš„åŸºç¡€ä¸Šè‡ªå®šä¹‰å°±ç»ªçŠ¶æ€ç±»å‹ã€‚</p><p><a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate">https://kubernetes.io/zh/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate</a></p><h3 id="ç»ˆæ­¢">ç»ˆæ­¢</h3><ol><li><p>Apiserveræ‹¿åˆ°åˆ é™¤è¯·æ±‚ã€Apiserveræ›´æ–°podçŠ¶æ€ï¼Œè½¬ä¸º<code>Terminating</code></p></li><li><p>kubeletæ¨é€preStopäº‹ä»¶åˆ°å®¹å™¨ä¸­æ‰§è¡Œï¼Œå¦‚æœè®¾ç½®äº†preStopçš„è¯</p></li><li><p>kubeleté€šè¿‡<code>container runtime</code>å‘é€ä¿¡å·ç»™æ¯ä¸ªå®¹å™¨ä¸­pidä¸º1çš„è¿›ç¨‹å·ï¼Œå¹¶åŒæ—¶å°†podä»svcç«¯ç‚¹ä¸­å‰¥ç¦»ã€‚</p></li><li><p>å®¹å™¨å…³é—­åï¼ŒApiserverå°†Podåˆ é™¤ã€‚</p></li></ol><blockquote><ul><li>2å’Œ3æ˜¯å¹¶è¡Œçš„ï¼Œå¹¶ä¸”æ‰§è¡Œæ—¶é—´å–å†³äºPodç»ˆæ­¢å®½é™æœŸ<code>terminationGracePeriodSeconds</code></li><li>kubectl æ·»åŠ <code>--grace-period=0 --force</code>å¯ä»¥ç«‹å³åˆ é™¤Pod</li></ul></blockquote><p>â„¹ï¸å¤±è´¥çš„podçŠ¶æ€ä¼šæ ¹æ®<code>kube-controller-manager</code> å‚æ•° <code>terminated-pod-gc-threshold</code>é˜ˆå€¼è®¾ç½®ä¿å­˜ä¸€å®šæ•°é‡ã€‚é»˜è®¤è¿™ä¸ªå€¼æ˜¯<code>12500</code>ï¼Œä¸æ¸…æ¥šä¸ºä½•è®¾ç½®è¿™ä¹ˆé«˜ã€‚<a href="https://github.com/kubernetes/kubernetes/pull/79047%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E8%A2%AB%E9%A9%B3%E5%9B%9E%E7%9A%84%E4%BF%AE%E6%AD%A3%EF%BC%8C%E5%AE%83%E6%8F%90%E8%AE%AE%E8%AE%BE%E7%BD%AE%E4%B8%BA">https://github.com/kubernetes/kubernetes/pull/79047è¿™æ˜¯ä¸€ä¸ªè¢«é©³å›çš„ä¿®æ­£ï¼Œå®ƒæè®®è®¾ç½®ä¸º</a><code>500</code>ã€‚</p><h2 id="å®¹å™¨Terminated">å®¹å™¨Terminated</h2><p>é€šè¿‡ä¸‹æ–¹å‘½ä»¤å¯ä»¥æŸ¥æ‰¾Terminatedçš„åŸå› ã€‚</p><pre><code class="language-bash">kubectl get pod -o go-template='&#123;&#123;range.status.containerStatuses&#125;&#125;&#123;&#123;"Container Name: "&#125;&#125;&#123;&#123;.name&#125;&#125;&#123;&#123;"\r\nLastState: "&#125;&#125;&#123;&#123;.lastState&#125;&#125;&#123;&#123;end&#125;&#125;'  &lt;pod_name:simmemleak&gt;simmemleakContainer Name: simmemleakLastState: map[terminated:map[exitCode:137 reason:OOM Killed startedAt:2015-07-07T20:58:43Z finishedAt:2015-07-07T20:58:43Z containerID:docker://0e4095bba1feccdfe7ef9fb6ebffe972b4b14285d5acdec6f0d3ae8a22fad8b2]]</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜04Pod-initå®¹å™¨ - å®¹å™¨ - k8s - pod</title>
      <link href="posts/3ec72f7e/"/>
      <url>posts/3ec72f7e/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨åœºæ™¯</h1><ul><li>Init å®¹å™¨å¯ä»¥åŒ…å«ä¸€äº›å®‰è£…è¿‡ç¨‹ä¸­åº”ç”¨å®¹å™¨ä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–ä¸ªæ€§åŒ–ä»£ç ã€‚ ä¾‹å¦‚ï¼Œæ²¡æœ‰å¿…è¦ä»…ä¸ºäº†åœ¨å®‰è£…è¿‡ç¨‹ä¸­ä½¿ç”¨ç±»ä¼¼ <code>sed</code>ã€<code>awk</code>ã€<code>python</code> æˆ– <code>dig</code> è¿™æ ·çš„å·¥å…·è€Œå» <code>FROM</code> ä¸€ä¸ªé•œåƒæ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„é•œåƒã€‚</li><li>Init å®¹å™¨å¯ä»¥å®‰å…¨åœ°è¿è¡Œè¿™äº›å·¥å…·ï¼Œé¿å…è¿™äº›å·¥å…·å¯¼è‡´åº”ç”¨é•œåƒçš„å®‰å…¨æ€§é™ä½ã€‚</li><li>åº”ç”¨é•œåƒçš„åˆ›å»ºè€…å’Œéƒ¨ç½²è€…å¯ä»¥å„è‡ªç‹¬ç«‹å·¥ä½œï¼Œè€Œæ²¡æœ‰å¿…è¦è”åˆæ„å»ºä¸€ä¸ªå•ç‹¬çš„åº”ç”¨é•œåƒã€‚</li><li>Init å®¹å™¨èƒ½ä»¥ä¸åŒäº Pod å†…åº”ç”¨å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾è¿è¡Œã€‚å› æ­¤ï¼ŒInit å®¹å™¨å¯ä»¥è®¿é—®åº”ç”¨å®¹å™¨ä¸èƒ½è®¿é—®çš„ <a href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">Secret</a> çš„æƒé™ã€‚</li><li>ç”±äº Init å®¹å™¨å¿…é¡»åœ¨åº”ç”¨å®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œå®Œæˆï¼Œå› æ­¤ Init å®¹å™¨ æä¾›äº†ä¸€ç§æœºåˆ¶æ¥é˜»å¡æˆ–å»¶è¿Ÿåº”ç”¨å®¹å™¨çš„å¯åŠ¨ï¼Œç›´åˆ°æ»¡è¶³äº†ä¸€ç»„å…ˆå†³æ¡ä»¶ã€‚ ä¸€æ—¦å‰ç½®æ¡ä»¶æ»¡è¶³ï¼ŒPod å†…çš„æ‰€æœ‰çš„åº”ç”¨å®¹å™¨ä¼šå¹¶è¡Œå¯åŠ¨ã€‚</li></ul><h1>ç¤ºä¾‹</h1><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: myapp-pod  labels:    app: myappspec:  containers:  - name: myapp-container    image: busybox:1.28    command: ['sh', '-c', 'echo The app is running! &amp;&amp; sleep 3600']  initContainers:  - name: init-myservice    image: busybox:1.28    command: ['sh', '-c', &quot;until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done&quot;]  - name: init-mydb    image: busybox:1.28    command: ['sh', '-c', &quot;until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done&quot;]</code></pre><p>é€šè¿‡æ·»åŠ initå®¹å™¨ï¼Œç­‰å¾…svcå¯¹è±¡åˆ›å»ºï¼Œå»¶è¿Ÿå¯åŠ¨åº”ç”¨å®¹å™¨ã€‚</p><h1>è¡Œä¸º</h1><p>initå®¹å™¨æŒ‰ç…§Pod.spec.initContainersä¸­å®šä¹‰çš„é¡ºåºå¯åŠ¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜kubectlå¤šé›†ç¾¤ç®¡ç†</title>
      <link href="posts/c15432fa/"/>
      <url>posts/c15432fa/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://github.com/sunny0826/kubecm">sunny0826/kubecm: Easier management of kubeconfig. (github.com)</a></p><h2 id="ä¸‹è½½ã€å®‰è£…">ä¸‹è½½ã€å®‰è£…</h2><pre><code class="language-bash">wget -O kubecm_release.tgz https://github.com/sunny0826/kubecm/releases/download/v0.15.3/kubecm_0.15.3_Linux_x86_64.tar.gztar xf kubecm_release.tgz &amp;&amp; rm -rf kubecm_release.tgzmv kubecm /usr/local/bin/</code></pre><h2 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h2><blockquote><p><a href="https://kubecm.cloud/#/en-us/cli/kubecm_add">add (kubecm.cloud)</a></p></blockquote><p>æ·»åŠ é…ç½®</p><pre><code class="language-bash">kubecm add -f qa.yaml # åˆå¹¶ qa.yaml åˆ° ~/.kube/config==é€‰æ‹© true ï¼Œå°±ä¼šå°†åå­—å« qa çš„é…ç½®è¿½åŠ åˆ° ~/.kube/config</code></pre><p>åˆ‡æ¢é…ç½®</p><pre><code class="language-bash">kubecm switch qa</code></pre><p>åˆ é™¤é…ç½®</p><pre><code class="language-bash">kubecm delete qa</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜02-1åˆ‡æ¢ä½¿ç”¨runtime-containerd</title>
      <link href="posts/c3c9f0f8/"/>
      <url>posts/c3c9f0f8/</url>
      
        <content type="html"><![CDATA[<h1>åŸºç¡€</h1><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ›¿æ¢runtimeï¼Œéœ€è¦é‡æ–°ä¸‹è½½é•œåƒã€‚è¿™ä¼šä¸¥é‡çš„åŠ å¤§Podçš„æ¢å¤æ—¶é—´ã€‚ç‰¹åˆ«æ˜¯åœ¨å›½å†…ï¼Œä¸€äº›é•œåƒå› ä¸ºæŸäº›ä¸å¯æè¿°çš„åŸå› ï¼Œå¯èƒ½ä¼šæ— æ³•ä¸‹è½½æˆåŠŸã€‚</p><p>å¦å¤–ï¼Œè™½ç„¶é•œåƒä¸€æ ·ï¼Œä½†æ˜¯containerdæ— æ³•å»æ‰¾åˆ°dockeræœ¬åœ°çš„é•œåƒç¼“å­˜ã€‚è‡³å°‘æˆ‘è¿˜æ²¡æ‰¾åˆ°è§£å†³æ–¹å¼ã€‚ã€‚ã€‚</p></blockquote><p>é…ç½®å¿…è¦ç³»ç»Ÿç¯å¢ƒ</p><pre><code class="language-bash">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.confoverlaybr_netfilterEOFsudo modprobe overlaysudo modprobe br_netfilter# Setup required sysctl params, these persist across reboots.cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.confnet.bridge.bridge-nf-call-iptables  = 1net.ipv4.ip_forward                 = 1net.bridge.bridge-nf-call-ip6tables = 1EOF# Apply sysctl params without rebootsudo sysctl --system</code></pre><h1>å®‰è£…</h1><p>containerdå¯ä»¥ä»dockeræºä¸­è·å–</p><pre><code class="language-bash"># add repoyum-config-manager \    --add-repo \    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo# installyum install containerd.io# modify containerd configsudo mkdir -p /etc/containerdcontainerd config default | sudo tee /etc/containerd/config.toml</code></pre><p>ä¿®æ­£é…ç½®/etc/containerd/config.tomlï¼Œæ›´æ”¹è·Ÿè·¯å¾„</p><pre><code class="language-yaml">root=&quot;&quot;</code></pre><p>ä¿®æ­£é…ç½®/etc/containerd/config.tomlï¼Œä½¿ç”¨ systemd cgroup driver</p><pre><code class="language-bash">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]  ...  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]    SystemdCgroup = true</code></pre><p>ä¿®æ­£é…ç½®/etc/containerd/config.tomlï¼Œä½¿ç”¨å›½å†…163é•œåƒæº</p><pre><code class="language-yaml">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]          endpoint = [&quot;http://hub-mirror.c.163.com&quot;,&quot;https://registry-1.docker.io&quot;]</code></pre><h1>æ›´æ”¹runtime</h1><p>å½“ä½¿ç”¨kubeadmå®‰è£…é›†ç¾¤çš„æ—¶å€™ï¼š</p><ul><li>kubeadm ä¼šå°†kubeletçš„é…ç½®å†™å…¥ /var/lib/kubelet/config.yamlå’Œcmå¯¹è±¡</li><li>kubeadm ä¼šå°†å¯åŠ¨å‚æ•°ä»¥ç¯å¢ƒå˜é‡çš„æ–¹å¼å†™å…¥/var/lib/kubelet/kubeadm-flags.env</li></ul><p>é…ç½®é€‰é¡¹å¯ä»¥å‚è€ƒhttps://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration</p><p>å¯åŠ¨å‚æ•°å¯ä»¥å‚è€ƒ <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/</a></p><pre><code class="language-bash"># æ‰‹åŠ¨è¿½åŠ runtimeå‚æ•°åˆ°kubeleté…ç½®/var/lib/kubelet/kubeadm-flags.env--cgroup-driver=systemd --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock</code></pre><h1>å®‰è£…å®¢æˆ·ç«¯å·¥å…·crictl</h1><p><a href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/crictl/">https://kubernetes.io/zh/docs/tasks/debug-application-cluster/crictl/</a></p><pre><code class="language-bash">wget 'https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.22.0/crictl-v1.22.0-linux-amd64.tar.gz'tar xf crictl-*.tar.gzcp crictl /usr/local/bin/</code></pre><h1>é…ç½®å®¢æˆ·ç«¯å·¥å…·</h1><pre><code class="language-yaml">runtime-endpoint: unix:///run/containerd/containerd.sockimage-endpoint: unix:///run/containerd/containerd.socktimeout: 10debug: true</code></pre><p>endpointçš„åœ°å€æ ¹æ®é€‰ç”¨çš„runtimeæŒ‡å®šï¼Œä¸å‡ºæ„å¤–åº”è¯¥æ˜¯ä¸‹é¢ä¸‰ä¸ªï¼š</p><ul><li>unix:///var/run/dockershim.sock</li><li>unix:///run/containerd/containerd.sock</li><li>unix:///run/crio/crio.sock</li></ul><h1>æŸ¥çœ‹å½“å‰æ‰€ç”¨çš„é•œåƒç‰ˆæœ¬</h1><pre><code class="language-bash">docker images | grep k8s.gcr.iok8s.gcr.io/kube-apiserver:v1.22.4k8s.gcr.io/kube-controller-manager:v1.22.4k8s.gcr.io/kube-scheduler:v1.22.4k8s.gcr.io/kube-proxy:v1.22.4k8s.gcr.io/pause:3.5k8s.gcr.io/etcd:3.5.0-0k8s.gcr.io/coredns/coredns:v1.8.4</code></pre><h1>æ‹‰å–é•œåƒåˆ°containerdæœ¬åœ°åº“</h1><p>æ ¹æ®ä¸Šé¢çš„æŒ‡ä»¤å¡«å……</p><pre><code class="language-bash">full_version=1.22.4cat&gt;crictl-pull-images.sh&lt;&lt;EOF#!/bin/bash# kubeadm config images listimages=(kube-apiserver:v$&#123;full_version&#125;kube-controller-manager:v$&#123;full_version&#125;kube-scheduler:v$&#123;full_version&#125;kube-proxy:v$&#123;full_version&#125;pause:3.5etcd:3.5.0-0coredns:1.8.4)for imageName in \$&#123;images[@]&#125;;do    crictl pull registry.aliyuncs.com/google_containers/\$&#123;imageName&#125;    ctr -n k8s.io images tag registry.aliyuncs.com/google_containers/\$&#123;imageName&#125; k8s.gcr.io/\$&#123;imageName&#125;doneEOF</code></pre><p>ä¿å­˜å…ˆä¸æ‰§è¡Œè„šæœ¬ã€‚</p><blockquote><p>ctr -n <a href="http://k8s.io">k8s.io</a> æŒ‡å®šä½äºk8s.ioå‘½åç©ºé—´çš„å¯¹è±¡</p></blockquote><h1>é€ä¸ªæ›´æ–°</h1><p>åƒä¸‡ä¸èƒ½dockerå’ŒcontainerdåŒæ—¶å¯åŠ¨</p><pre><code class="language-bash"># nodeName nodeName=k8s01# é©±é€nodekubectl drain $&#123;nodeName&#125; --ignore-daemonsets# æ ¡éªŒæ˜¯å¦åªæœ‰ daemonsets podkubectl get all --all-namespaces -o wide| grep $&#123;nodeName&#125;# å…³é—­kubeletsystemctl stop kubelet# å…³é—­runtimesystemctl stop docker &amp;&amp; systemctl disable docker# ç¡®ä¿èŠ‚ç‚¹ä¸Šå¼‚å¸¸çš„ä¿¡æ¯ï¼Œæ²¡æœ‰## åœ¨æœ¬æ–‡æ¡£å®æ–½è¿‡ç¨‹ä¸­ï¼Œå‡ºç° docker å’Œ kubelet å…³é—­çš„æƒ…å†µä¸‹ï¼Œå®¹å™¨è¿›è¡Œä¾ç„¶è¿è¡Œå ç”¨ç«¯å£ï¼Œå¯¼è‡´containerdå¯åŠ¨çš„æ—¶å€™æ— æ³•æ­£å¸¸è¿è¡ŒPod.ss -tnalp# å¯åŠ¨ containerdsystemctl start containerd &amp;&amp; systemctl enable containerd &amp;&amp; systemctl stop kubelet# æ‰§è¡Œæ‹‰å–å®¹å™¨é•œåƒçš„è„šæœ¬bash crictl-pull-images.sh# å¯åŠ¨ kubeletsystemctl restart kubelet# æ¢å¤ nodekubectl uncordon $&#123;nodeName&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜02å®‰è£…</title>
      <link href="posts/9602dad/"/>
      <url>posts/9602dad/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/">ä½¿ç”¨ kubeadm å¼•å¯¼é›†ç¾¤ | Kubernetes</a></p><h2 id="ç»“æ„">ç»“æ„</h2><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/ha-topology/">é«˜å¯ç”¨æ‹“æ‰‘é€‰é¡¹ | Kubernetes</a></p><p>æˆ‘ä»¬é€‰å †å ç»“æ„</p><p><img src="https://d33wubrfki0l68.cloudfront.net/d1411cded83856552f37911eb4522d9887ca4e83/b94b2/images/kubeadm/kubeadm-ha-topology-stacked-etcd.svg" alt="å †å çš„ etcd æ‹“æ‰‘"></p><p>ä¸è¿‡å› ä¸ºæˆ‘ç¯å¢ƒé‡Œæ²¡æœ‰ LB ç»„ä»¶ï¼Œå› æ­¤é€‰ç”¨ haproxy æ¥ä»£æ›¿ï¼Œåˆå› ä¸ºè¦ä¸º haproxy åšé«˜å¯ç”¨ï¼Œå› æ­¤ä¸º haproxy å†å¤–å¥—ä¸€å±‚ keepalivedã€‚</p><p>å¦‚æœåœ¨é˜¿é‡Œäº‘æ„å»ºï¼Œå¯ä»¥è®¤ä¸º LB æ˜¯å¥å£®çš„ã€‚</p><h2 id="æœºå™¨">æœºå™¨</h2><p>æœºå™¨ç³»ç»Ÿéƒ½æ˜¯ centos7,</p><p>ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå‡ä¸ºæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯NodeèŠ‚ç‚¹ï¼Œå¹¶åˆ©ç”¨ keepalived + haproxy è¿›è¡Œ <code>æ§åˆ¶å¹³é¢ç»„ä»¶ï¼šapiserver</code> é«˜å¯ç”¨</p><table><thead><tr><th>hostname</th><th>ip</th><th>type</th></tr></thead><tbody><tr><td>k8sapi</td><td>10.200.16.100</td><td>keepalived vip</td></tr><tr><td>k8s01</td><td>10.200.16.101</td><td>master keepalived(ä¸») haproxy</td></tr><tr><td>k8s02</td><td>10.200.16.102</td><td>master keepalived(å¤‡) haproxy</td></tr><tr><td>k8s03</td><td>10.200.16.103</td><td>master</td></tr></tbody></table><p>è¯·åŠ¡å¿…ç¡®ä¿å†…ç½‘å¯ä»¥é€šè¿‡è¡¨æ ¼é‡Œçš„ <code>hostname</code> è§£æåˆ°å¯¹åº”çš„ <code>ip</code></p><p>è¯·åŠ¡å¿…å°†ç³»ç»Ÿçš„ hostname æ”¹ä¸ºä¸Šè¿°è¡¨é‡Œçš„ hostname</p><p>æ•°æ®èµ°å‘ï¼š</p><p>client-&gt;keepalived(vip:8443)-&gt;haproxy(vip:8443)-&gt; all:6443</p><h2 id="æ‰€æœ‰èŠ‚ç‚¹">æ‰€æœ‰èŠ‚ç‚¹</h2><h3 id="æ—¶é—´åŒæ­¥">æ—¶é—´åŒæ­¥</h3><pre><code class="language-bash">yum install chrony -ysed -i  '1a server cn.pool.ntp.org prefer iburst' /etc/chrony.confsystemctl restart chronydsystemctl enable chronydchronyc activity</code></pre><h3 id="ç³»ç»Ÿé…ç½®">ç³»ç»Ÿé…ç½®</h3><pre><code class="language-bash"># åŠ è½½æ¨¡å—modprobe overlaymodprobe br_netfilter# æ·»åŠ é…ç½®cat &gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-iptables  = 1net.ipv4.ip_forward                 = 1net.bridge.bridge-nf-call-ip6tables = 1EOF# é…ç½®ç”Ÿæ•ˆsysctl --system# æ¸…ç©ºé˜²ç«å¢™systemctl stop firewalld.service iptables.servicesystemctl disable firewalld.servicesystemctl disable iptables.service;iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X# å…³é—­selinuxsetenforce 0sed -i 's@^\(SELINUX=\).*@\1disabled@' /etc/sysconfig/selinuxsed -i 's@^\(SELINUX=\).*@\1disabled@' /etc/selinux/config# å…³é—­ swapï¼Œkubelet 1.18 è¦æ±‚.å¦‚æœä½ fstabä¹Ÿæœ‰ï¼Œè¯·ä¸€å¹¶æ³¨é‡Šswapoff -a# å®‰è£… ipvsyum install ipvsadm -yipvsadm --clearcat&gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; 'EOF'ipvs_mods_dir=&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;for i in $(ls $ipvs_mods_dir | grep -o &quot;^[^.]*&quot;); do    /sbin/modinfo -F filename $i  &amp;&gt; /dev/null    if [ $? -eq 0 ]; then        /sbin/modprobe $i    fidoneEOFchmod +x /etc/sysconfig/modules/ipvs.modules/etc/sysconfig/modules/ipvs.modules</code></pre><h3 id="å®‰è£…å®¹å™¨">å®‰è£…å®¹å™¨</h3><pre><code class="language-bash">yum install -y yum-utils \  device-mapper-persistent-data \  lvm2yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repo</code></pre><h4 id="é€‰æ‹©ç‰ˆæœ¬">é€‰æ‹©ç‰ˆæœ¬</h4><p>ä¸€å®šè¦é€‰æ‹©æ‰€å®‰è£…çš„ k8s ç‰ˆæœ¬å…¼å®¹çš„æœ€æ–°å®¹å™¨ç‰ˆæœ¬</p><blockquote><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker</a></p></blockquote><pre><code class="language-bash">yum list docker-ce --showduplicates | sort -r===docker-ce.x86_64            3:20.10.7-3.el7                    docker-ce-stabledocker-ce.x86_64            3:20.10.6-3.el7                    docker-ce-stabledocker-ce.x86_64            3:20.10.5-3.el7                    docker-ce-stabledocker-ce.x86_64            3:20.10.4-3.el7                    docker-ce-stabledocker-ce.x86_64            3:20.10.3-3.el7                    docker-ce-stabledocker-ce.x86_64            3:20.10.2-3.el7                    docker-ce-stabledocker-ce.x86_64            3:20.10.1-3.el7                    docker-ce-stable#################### é€‰æ‹©å¥½æ‰€è¦å®‰è£…çš„ç‰ˆæœ¬ ####################docker_version=20.10.7  # ä¾‹å¦‚é€‰æ‹©20.10.7</code></pre><h4 id="å®‰è£…å¹¶å¯åŠ¨">å®‰è£…å¹¶å¯åŠ¨</h4><pre><code class="language-bash"># å®‰è£…å…¼å®¹k8sçš„dockerç‰ˆæœ¬yum install -y docker-ce-$&#123;docker_version&#125; docker-ce-cli-$&#123;docker_version&#125;#sed -i '/ExecStart=/a ExecStartPort=/usr/sbin/iptables -P FORWARD ACCEPT' /usr/lib/systemd/system/docker.service;mkdir -p /etc/docker;cat &gt; /etc/docker/daemon.json &lt;&lt;EOF&#123;  &quot;data-root&quot;: &quot;/export/docker-data-root&quot;,  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],  &quot;log-driver&quot;: &quot;json-file&quot;,  &quot;log-opts&quot;: &#123;    &quot;max-size&quot;: &quot;100m&quot;  &#125;,  &quot;storage-driver&quot;: &quot;overlay2&quot;,  &quot;storage-opts&quot;: [    &quot;overlay2.override_kernel_check=true&quot;  ]&#125;EOFsystemctl daemon-reloadsystemctl restart dockersystemctl enable docker</code></pre><h3 id="å®‰è£…-kubelet-kubeadm-kubectl">å®‰è£… kubelet kubeadm kubectl</h3><blockquote><p>é˜¿é‡Œå·´å·´é•œåƒç‚¹ï¼š</p><p><a href="https://developer.aliyun.com/mirror/kubernetes">https://developer.aliyun.com/mirror/kubernetes</a></p><p>google å®˜æ–¹å®‰è£…æ–‡æ¡£ <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p></blockquote><ol><li>google å®˜æ–¹æº</li></ol><pre><code class="language-bash">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearchenabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpgexclude=kubelet kubeadm kubectlEOF</code></pre><ol start="2"><li>é˜¿é‡Œæº</li></ol><pre><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF</code></pre><ol start="3"><li>å®‰è£…</li></ol><pre><code class="language-bash"># ç¡®å®š kube* ç‰ˆæœ¬yum list kube* --showduplicates --disableexcludes=kubernetes# é€‰æ‹©è¦å®‰è£…çš„ç‰ˆæœ¬full_verions=1.20.8-0# å®‰è£… kube ç®¡ç†ç»„ä»¶å’Œ kubeletyum install -y kubelet-$&#123;full_verions&#125; kubeadm-$&#123;full_verions&#125; kubectl-$&#123;full_verions&#125; --disableexcludes=kubernetessystemctl enable --now kubelet</code></pre><h2 id="é«˜å¯ç”¨ç»„ä»¶èŠ‚ç‚¹">é«˜å¯ç”¨ç»„ä»¶èŠ‚ç‚¹</h2><h3 id="å®‰è£…è´Ÿè½½å‡è¡¡ç»„ä»¶-haproxy-å’Œ-é«˜å¯ç”¨ç»„ä»¶-keepalived">å®‰è£…è´Ÿè½½å‡è¡¡ç»„ä»¶ haproxy å’Œ é«˜å¯ç”¨ç»„ä»¶ keepalived</h3><blockquote><p>k8s01ï¼Œk8s02 æ‰§è¡Œ</p></blockquote><ul><li>å®‰è£…</li></ul><pre><code class="language-bash">yum install haproxy keepalived -y</code></pre><ul><li>haproxyé…ç½®</li></ul><pre><code class="language-bash">cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.defaultcat&gt;/etc/haproxy/haproxy.cfg&lt;&lt;EOFglobal    log /dev/log local0    log /dev/log local1 notice    daemondefaults    mode                    http    log                     global    option                  httplog    option                  dontlognull    option http-server-close    option forwardfor       except 127.0.0.0/8    option                  redispatch    retries                 1    timeout http-request    10s    timeout queue           20s    timeout connect         5s    timeout client          20s    timeout server          20s    timeout http-keep-alive 10s    timeout check           10sfrontend apiserver    bind *:8443    mode tcp    option tcplog    default_backend apiserverbackend apiserver    option httpchk GET /healthz    http-check expect status 200    mode tcp    option ssl-hello-chk    balance     roundrobin        server k8sapivip 10.200.16.101:6443 check        server k8sapivip 10.200.16.102:6443 check        server k8sapivip 10.200.16.103:6443 checkEOF</code></pre><ul><li>keepalived ä¸»é…ç½®</li></ul><blockquote><p>ä¸¤èŠ‚ç‚¹é…ç½®ä¸ä¸€æ ·</p></blockquote><pre><code class="language-bash">cp /etc/keepalived/keepalived.conf  /etc/keepalived/keepalived.conf.default############## æ”¾åœ¨ k8s01 ################cat&gt;/etc/keepalived/keepalived.conf&lt;&lt;EOFglobal_defs &#123;    router_id LVS_DEVEL&#125;vrrp_script check_apiserver &#123;  script &quot;/etc/keepalived/check_apiserver.sh&quot;  interval 3  weight -2  fall 10  rise 2&#125;vrrp_instance VI_1 &#123;    state MASTER  #     interface ens192  # ç‰©ç†ç½‘å¡å    virtual_router_id 51    priority 101  #    authentication &#123;        auth_type PASS        auth_pass 42    &#125;    virtual_ipaddress &#123;        10.200.16.100    &#125;    track_script &#123;        check_apiserver    &#125;&#125;EOF############## æ”¾åœ¨ k8s02 ################cat&gt;/etc/keepalived/keepalived.conf&lt;&lt;EOFglobal_defs &#123;    router_id LVS_DEVEL&#125;vrrp_script check_apiserver &#123;  script &quot;/etc/keepalived/check_apiserver.sh&quot;  interval 3  weight -2  fall 10  rise 2&#125;vrrp_instance VI_1 &#123;    state BACKUP  #     interface ens192  # ç‰©ç†ç½‘å¡å    virtual_router_id 51    priority 100  #    authentication &#123;        auth_type PASS        auth_pass 42    &#125;    virtual_ipaddress &#123;        10.200.16.100    &#125;    track_script &#123;        check_apiserver    &#125;&#125;EOF</code></pre><ul><li>keepalived æ£€æµ‹è„šæœ¬</li></ul><blockquote><p>k8s01å’Œk8s02å‡éœ€è¦</p></blockquote><pre><code class="language-bash">cat&gt;/etc/keepalived/check_apiserver.sh&lt;&lt;'EOF'#!/bin/sherrorExit() &#123;    echo &quot;*** $*&quot; 1&gt;&amp;2    exit 1&#125;APISERVER_VIP=10.200.16.100APISERVER_DEST_PORT=6443curl --silent --max-time 2 --insecure https://localhost:$&#123;APISERVER_DEST_PORT&#125;/ -o /dev/null || errorExit &quot;Error GET https://localhost:$&#123;APISERVER_DEST_PORT&#125;/&quot;if ip addr | grep -q $&#123;APISERVER_VIP&#125;; then    curl --silent --max-time 2 --insecure https://$&#123;APISERVER_VIP&#125;:$&#123;APISERVER_DEST_PORT&#125;/ -o /dev/null || errorExit &quot;Error GET https://$&#123;APISERVER_VIP&#125;:$&#123;APISERVER_DEST_PORT&#125;/&quot;fiEOFchmod a+x /etc/keepalived/check_apiserver.sh</code></pre><ul><li>å¯åŠ¨keepalivedå’Œhaproxy</li></ul><pre><code class="language-bash">systemctl start keepalived haproxysystemctl enable keepalived haproxy</code></pre><h2 id="æ§åˆ¶å¹³é¢èŠ‚ç‚¹">æ§åˆ¶å¹³é¢èŠ‚ç‚¹</h2><h3 id="æ‹‰å–ç»„ä»¶é•œåƒ">æ‹‰å–ç»„ä»¶é•œåƒ</h3><blockquote><p>k8s01ï¼Œk8s02ï¼Œk8s03 æ‰§è¡Œ</p></blockquote><blockquote><p>é‰´äºç½‘ç»œé—®é¢˜ï¼Œæ‰€ä»¥å›½å†…ä¸€èˆ¬æ— æ³•ç›´æ¥è¿è¡Œåˆå§‹åŒ–å‘½ä»¤ï¼Œå› æ­¤æœ€å¥½å…ˆè‡ªè¡Œå®‰è£…å¥½åŒ…</p></blockquote><pre><code class="language-bash"># æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬ k8s æ‰€éœ€åŒ…yum list --showduplicates kubeadm --disableexcludes=kubernetes | grep $&#123;master_verions&#125;===kubeadm.x86_64                       1.20.8-0                        @kuberneteskubeadm.x86_64                       1.20.0-0                        kuberneteskubeadm.x86_64                       1.20.1-0                        kuberneteskubeadm.x86_64                       1.20.2-0                        kuberneteskubeadm.x86_64                       1.20.4-0                        kuberneteskubeadm.x86_64                       1.20.5-0                        kuberneteskubeadm.x86_64                       1.20.6-0                        kuberneteskubeadm.x86_64                       1.20.7-0                        kuberneteskubeadm.x86_64                       1.20.8-0                        kubernetes</code></pre><pre><code class="language-bash">full_version=1.20.8kubeadm config images list --kubernetes-version=$&#123;full_version&#125;===k8s.gcr.io/kube-apiserver:v1.20.8k8s.gcr.io/kube-controller-manager:v1.20.8k8s.gcr.io/kube-scheduler:v1.20.8k8s.gcr.io/kube-proxy:v1.20.8k8s.gcr.io/pause:3.2k8s.gcr.io/etcd:3.4.13-0k8s.gcr.io/coredns:1.7.0</code></pre><p>æ ¹æ®ä¸Šé¢çš„è¾“å‡ºç‰ˆæœ¬ï¼Œä¿®æ”¹ä¸‹é¢è„šæœ¬ä¸­ <code>pause</code> <code>etcd</code> <code>coredns</code> çš„ç‰ˆæœ¬å·</p><pre><code class="language-bash">cat&gt;images-pull.sh&lt;&lt;EOF#!/bin/bash# kubeadm config images listimages=(kube-apiserver:v$&#123;full_version&#125;kube-controller-manager:v$&#123;full_version&#125;kube-scheduler:v$&#123;full_version&#125;kube-proxy:v$&#123;full_version&#125;pause:3.2     # ä¿®æ”¹æˆ‘etcd:3.4.13-0 # ä¿®æ”¹æˆ‘coredns:1.7.0 # ä¿®æ”¹æˆ‘)for imageName in \$&#123;images[@]&#125;;do    docker pull registry.aliyuncs.com/google_containers/\$&#123;imageName&#125;    docker tag registry.aliyuncs.com/google_containers/\$&#123;imageName&#125; k8s.gcr.io/\$&#123;imageName&#125;    docker rmi registry.aliyuncs.com/google_containers/\$&#123;imageName&#125;doneEOF</code></pre><pre><code class="language-bash">bash images-pull.sh</code></pre><h3 id="ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹å®‰è£…ï¼ˆk8s01ï¼‰">ç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹å®‰è£…ï¼ˆk8s01ï¼‰</h3><p>(info: <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/%EF%BC%89">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/ï¼‰</a></p><h4 id="é‡‡å–é…ç½®æ–‡ä»¶å®‰è£…æ¨¡å¼">é‡‡å–é…ç½®æ–‡ä»¶å®‰è£…æ¨¡å¼</h4><pre><code class="language-bash">kubeadm config print init-defaults &gt; kubeadm.yaml.default</code></pre><p>é…ç½®æ–‡ä»¶è¯¦ç»†å‚æ•°ä»‹ç»</p><p><a href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration">https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration</a></p><p>æ ¹æ®ç”Ÿæˆçš„é»˜è®¤é…ç½®ï¼Œæ¥åŠ¨æ€çš„è°ƒæ•´ï¼Œå› ä¸º k8s ç‰ˆæœ¬å˜æ›´å¾ˆå¿«ï¼Œæ‰€ä»¥ä¸‹é¢çš„é…ç½®ä¸ä¸€å®šæ˜¯æ­£ç¡®çš„</p><pre><code class="language-bash">cat &gt; kubeadm.yaml &lt;&lt; EOF# kubeadm.yaml å°†é»˜è®¤çš„é…ç½®è¿›è¡Œä¿®æ”¹apiVersion: kubeadm.k8s.io/v1beta2bootstrapTokens:- groups:  - system:bootstrappers:kubeadm:default-node-token  token: abcdef.8272827282sksksu   # æ”¹æˆ‘ï¼Œæ”¹æˆä½ è‡ªå·±éšæ„çš„å­—ç¬¦ä¸²  ttl: 24h0m0s  usages:  - signing  - authenticationkind: InitConfigurationlocalAPIEndpoint:  advertiseAddress: 10.200.16.101  # æ”¹æˆ‘ï¼Œæ”¹æˆç¬¬ä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„ç‰©ç†ip  bindPort: 6443nodeRegistration:  criSocket: /var/run/dockershim.sock  # å¦‚æœæ˜¯containerdï¼Œåˆ™æ”¹ä¸º/run/containerd/containerd.sock  name: k8s01 # æ”¹æˆ‘ï¼Œç†è®ºä¸Šå®ƒä¼šè‡ªåŠ¨è·å–é…ç½®æ‰€åœ¨èŠ‚ç‚¹çš„ hostname  taints:  - effect: NoSchedule    key: node-role.kubernetes.io/master---apiServer:  timeoutForControlPlane: 4m0sapiVersion: kubeadm.k8s.io/v1beta2certificatesDir: /etc/kubernetes/pkiclusterName: kubernetescontrollerManager: &#123;&#125;controllerManagerExtraArgs:  address: 0.0.0.0  # å¼€æ”¾kube-controller-managerï¼Œä¾¿äºä¹‹åprometheusç›‘æ§scheduler: &#123;&#125;schedulerExtraArgs:  address: 0.0.0.0  # å¼€æ”¾kube-schedullerï¼Œä¾¿äºä¹‹åprometheusç›‘æ§controlPlaneEndpoint: &quot;k8sapi:8443&quot; # æ–°åŠ æˆ‘ï¼Œk8sapi æ˜¯ apiserver çš„è´Ÿè½½å‡è¡¡å™¨çš„åœ°å€dns:  type: CoreDNSetcd:  local:    dataDir: /var/lib/etcdimageRepository: k8s.gcr.io # å¦‚æœä½ æ— æ³•è®¿é—®k8s.gcr.ioï¼Œä¸”æ²¡æœ‰æå‰ä¸‹è½½é˜¿é‡Œäº‘é•œåƒï¼Œä½ å¯ä»¥æ¢æˆ registry.aliyuncs.com/google_containers è¯•è¯•, å»ºè®®æå‰ä¸‹è½½å¥½kind: ClusterConfigurationkubernetesVersion: v$&#123;full_version&#125; # æ”¹æˆ‘ï¼Œæ”¹æˆä½ æ‰€éœ€å®‰è£…çš„ç‰ˆæœ¬networking:  dnsDomain: cluster.local  serviceSubnet: 10.96.0.0/16 # æ”¹æˆ‘ï¼Œå®šä¹‰ svc çš„ç½‘æ®µ  podSubnet: 10.97.0.0/16 # æ”¹æˆ‘ï¼Œå®šä¹‰ pod çš„ç½‘æ®µ  --- # è¿½åŠ  KubeProxyConfigurationapiVersion: kubeproxy.config.k8s.io/v1alpha1kind: KubeProxyConfigurationmode: ipvsEOF--- # è¿½åŠ  KubeletConfigurationapiVersion: kubelet.config.k8s.io/v1beta1kind: KubeletConfigurationcgroupDriver: systemd</code></pre><pre><code class="language-bash"># è¿›è¡Œåˆå§‹åŒ–å®‰è£…kubeadm init --config kubeadm.yaml</code></pre><p>initè°ƒç”¨é…ç½®æµç¨‹ï¼š</p><p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#workflow-when-using-kubeadm-init">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#workflow-when-using-kubeadm-init</a></p><h4 id="é…ç½®é€šè¿‡-kubectl-è®¿é—®é›†ç¾¤">é…ç½®é€šè¿‡ kubectl è®¿é—®é›†ç¾¤</h4><pre><code class="language-bash">mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config# kubectl å‘½ä»¤è¡¥å…¨source &lt;(kubectl completion bash)# You should now deploy a pod network to the cluster.# Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:# https://kubernetes.io/docs/concepts/cluster-administration/addons/</code></pre><pre><code class="language-bash"># æ·»åŠ ç”¨æˆ·ä¸Šä¸‹æ–‡åˆ°é…ç½®é‡Œï¼Œæ–¹ä¾¿åˆ‡æ¢ç”¨æˆ·kubectl config set-context admin --cluster=kubernetes --user=kubernetes-admin</code></pre><h4 id="è°ƒæ•´-kube-controller-manager-å’Œ-scheduler-çš„é…ç½®">è°ƒæ•´ kube-controller-manager å’Œ scheduler çš„é…ç½®</h4><pre><code class="language-bash"># æ£€æŸ¥çŠ¶æ€kubectl get cs# ä½ å¯èƒ½ä¼šå‘ç°,å‡ºç°æœåŠ¡è¿æ¥æ‹’ç»é—®é¢˜controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refusedscheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused# åŸå› æ˜¯è¿™ä¸¤ä¸ªæœåŠ¡é…ç½®é»˜è®¤ç«¯å£æ˜¯0ã€‚è‡³äºä¸ºå•¥å°±ä¸æ™“å¾—äº†# ä½ éœ€è¦æ³¨é‡Šæ‰ä¸¤ä¸ªé…ç½®é‡Œçš„ç«¯å£ï¼ˆ- --port=0ï¼‰ï¼Œæ¢å¤ä¸ºé»˜è®¤ç«¯å£sed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-scheduler.yamlsed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-controller-manager.yaml# é‡å¯ kubeletsystemctl restart kubelet# å†æ¬¡æ£€æŸ¥kubectl get cs===NAME                 STATUS    MESSAGE             ERRORscheduler            Healthy   okcontroller-manager   Healthy   oketcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</code></pre><blockquote><p><code>kube-controller-manager</code> å‚æ•° <code>terminated-pod-gc-threshold</code>ç”¨äºè®¾ç½®ä¿ç•™å¤šå°‘å¤±è´¥çš„PodçŠ¶æ€ï¼Œé»˜è®¤æ˜¯12500ã€‚è¿™ä¹ˆé«˜ä¸æ¸…æ¥šæ˜¯å¦æœ‰æ€§èƒ½å½±å“æˆ–è€…èµ„æºæº¢å‡ºé£é™©ã€‚</p></blockquote><h4 id="é…ç½®ç½‘ç»œæ’ä»¶">é…ç½®ç½‘ç»œæ’ä»¶</h4><p>ç½‘ç»œæ’ä»¶å¸¸ç”¨çš„æœ‰ä¸¤ç§</p><p>ç¬¬ä¸€ç§æ˜¯ flannelï¼Œæ¶‰åŠåˆ°æ›´å¤šçš„ iptables è§„åˆ™</p><p>ç¬¬äºŒç§æ˜¯ calicoï¼Œæ¶‰åŠåˆ°æ›´å¤šçš„è·¯ç”±è§„åˆ™</p><ul><li>flannel (æœ¬æ–‡æ¡£é€‰ç”¨çš„æ’ä»¶)</li></ul><blockquote><p><a href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a> ä»£ç æ‰˜ç®¡åœ°å€</p></blockquote><pre><code class="language-bash">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml# ä¿®æ”¹é‡Œé¢çš„ &quot;Network&quot;: &quot;10.244.0.0/16&quot;, å˜æ›´ä¸ºä½ è‡ªå·±çš„ podSubnet ç½‘æ®µï¼Œå³kubeadmåˆå§‹åŒ–é˜¶æ®µçš„ --pod-network-cidrkubectl apply -f  kube-flannel.yml</code></pre><p>flannel å°†ä¼šåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª VTEP è®¾å¤‡<code>flannel.1</code>ï¼Œå¹¶å°†podSubnetä¸‹å‘ç»™æ‰€æœ‰çš„<code>flannel.1</code></p><ul><li>calico</li></ul><blockquote><p><a href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart">https://docs.projectcalico.org/getting-started/kubernetes/quickstart</a> å®‰è£…æ–‡æ¡£</p></blockquote><pre><code class="language-bash">kubectl apply -f https://docs.projectcalico.org/manifests/tigera-operator.yamlwget https://docs.projectcalico.org/manifests/custom-resources.yaml# custom-resources.yaml ä¿®æ”¹é‡Œé¢çš„ç½‘ç»œä¸º pod ç½‘æ®µkubectl apply -f custom-resources.yaml</code></pre><blockquote><p>æ³¨æ„ï¼Œå½“ä½ ä½¿ç”¨äº† calico åï¼Œ ä¼šç”Ÿæˆä¸€äº› cni çš„é…ç½®ï¼Œè¿™äº›é…ç½®ä¼šå¯¼è‡´ä½ è¿”å› flannel çš„æ—¶å€™å‡ºç°é—®é¢˜ã€‚ä¾‹å¦‚æ— æ³•åˆ›å»º cni</p><p>ä½ å¯ä»¥ä½¿ç”¨ find / -name â€˜*calico*â€™ æ‰¾åˆ°æ‰€æœ‰ä¿¡æ¯ï¼Œç„¶åéƒ½åˆ é™¤</p></blockquote><p>é»˜è®¤kubeadmå®‰è£…å®Œåï¼Œç¦æ­¢è°ƒåº¦podåˆ°masterä¸Šã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼Œå…³é—­æ‰€æœ‰masterèŠ‚ç‚¹çš„ç¦æ­¢è°ƒåº¦</p><pre><code class="language-bash"> kubectl taint nodes --all node-role.kubernetes.io/master-</code></pre><h4 id="é…ç½®webæ§åˆ¶å°dashboard">é…ç½®webæ§åˆ¶å°dashboard</h4><blockquote><p><a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a> ä»£ç æ‰˜ç®¡åœ°å€</p></blockquote><pre><code class="language-bash">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml &amp;&amp; mv recommended.yaml kubernetes-dashboard.yaml</code></pre><ul><li>å¦‚æœä½ éƒ¨ç½²äº† metallbï¼Œæˆ–è€…æœ‰äº‘æœåŠ¡çš„ lbï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹ kubernetes-dashboard.yaml é…ç½®ä¸­çš„ svc å¯¹è±¡ç±»å‹ä¸º  LoadBalancer</li></ul><pre><code class="language-yaml">kind: ServiceapiVersion: v1metadata:  labels:    k8s-app: kubernetes-dashboard  name: kubernetes-dashboard  namespace: kubernetes-dashboardspec:  ports:    - port: 443      targetPort: 8443  type: LoadBalancer   # è¿™é‡Œæ–°åŠ ä¸€æ¡  selector:    k8s-app: kubernetes-dashboard</code></pre><p>ä¹‹åé€šè¿‡ lb åœ°å€è®¿é—®å³å¯</p><ul><li>å¦‚æœä½ æ²¡æœ‰é…ç½® metallbï¼Œä¹Ÿæ²¡æœ‰éƒ¨ç½²åœ¨äº‘æœåŠ¡ä¸­ï¼ˆå³æ²¡æœ‰äº‘LBï¼‰ï¼Œé‚£ä¹ˆéœ€è¦ä¿®æ”¹ svc ç±»å‹ä¸º NodePortï¼Œå¹¶ä¸”å°† pod çš„éƒ¨ç½²åˆ°å›ºå®šçš„èŠ‚ç‚¹ä¸Šï¼Œä¾‹å¦‚ k8s01</li></ul><pre><code class="language-bash"># è¿™é‡Œæˆ‘ä»¬è¦ä¿®æ”¹ä¸€äº›ä¸œè¥¿# #---spec:  ports:    - port: 443      targetPort: 8443      nodePort: 30001  type: NodePort   # è¿™é‡Œæ–°åŠ ä¸€æ¡#---# è¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹éƒ¨ç½²çš„ä½ç½®ï¼Œå¦‚æœä½ é›†ç¾¤ä¸­å·²ç»åŠ å…¥äº†å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä¼šå¯¼è‡´ pod åˆ†å‘åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šã€‚è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶åˆ†å‘åˆ° master ä¸Š. æ‰¾åˆ° kind: Deployment é…ç½®ï¼Œå¹¶ä¿®æ”¹ä¸¤ä¸ª pod çš„åˆ†å‘ä½ç½®ä¸º nodeName: &lt;master èŠ‚ç‚¹ä¸»æœºå&gt;#---    spec:      nodeName: k8s01    # è¿™é‡Œæ–°åŠ ä¸€æ¡      containers:        - name: kubernetes-dashboard          image: kubernetesui/dashboard:v2.0.3              spec:      nodeName: k8s01    # è¿™é‡Œæ–°åŠ ä¸€æ¡      containers:        - name: dashboard-metrics-scraper          image: kubernetesui/metrics-scraper:v1.0.4          #---# ç„¶ååˆ›å»ºkubectl create -f kubernetes-dashboard.yaml</code></pre><p>ä¹‹åé€šè¿‡ <a href="https://k8s01:30001">https://k8s01:30001</a> è®¿é—®</p><ul><li>è·å–è®¿é—®webæœåŠ¡çš„token</li></ul><p>dashboardæœ¬èº«æ˜¯ä¸€ä¸ªpodï¼Œå¦‚æœä½ æƒ³è®©podå»è®¿é—®å…¶å®ƒçš„k8sèµ„æºï¼Œåˆ™éœ€è¦ç»™podåˆ›å»ºä¸€ä¸ªæœåŠ¡è´¦æˆ·(serviceaccount).</p><p>æ„å»ºä¸€ä¸ªæœåŠ¡è´¦æˆ·admin-userï¼Œå¹¶é€šè¿‡ClusterRoleBindingæˆæƒadminçº§åˆ«çš„ClusterRoleå¯¹è±¡</p><pre><code class="language-bash"># æ·»åŠ è®¿é—® token# å®˜æ–¹æ–‡æ¡£ï¼š https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md# é€šè¿‡ä¸‹é¢å†…å®¹åˆ›å»º kube-db-auth.yamlcat &gt; kube-db-auth.yaml &lt;&lt; EOFapiVersion: v1kind: ServiceAccountmetadata:  name: admin-user  namespace: kubernetes-dashboard---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:  name: admin-userroleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: cluster-adminsubjects:- kind: ServiceAccount  name: admin-user  namespace: kubernetes-dashboardEOFkubectl apply -f kube-db-auth.yaml# é€šè¿‡ä¸‹é¢å‘½ä»¤æ‹¿åˆ° tokenkubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '&#123;print $1&#125;')  </code></pre><p><img src="/posts/9602dad/image-20210711163654410.png" alt="image-20210711163654410"></p><h3 id="è·å–å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼ˆk8s01ï¼‰">è·å–å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼ˆk8s01ï¼‰</h3><h4 id="æ–°åŠ æ§åˆ¶å¹³é¢">æ–°åŠ æ§åˆ¶å¹³é¢</h4><pre><code class="language-bash"># å‘½ä»¤æ ¼å¼kubeadm join k8sapi:8443 \--token xxx \--discovery-token-ca-cert-hash xxx \--control-plane --certificate-key xxx</code></pre><h4 id="æ–°åŠ NodeèŠ‚ç‚¹">æ–°åŠ NodeèŠ‚ç‚¹</h4><pre><code class="language-bash"># å‘½ä»¤æ ¼å¼kubeadm join k8sapi:8443 \--token xxx \--discovery-token-ca-cert-hash xxx </code></pre><h4 id="å‘½ä»¤é‡å»º">å‘½ä»¤é‡å»º</h4><p>æ·»åŠ NodeèŠ‚ç‚¹å‘½ä»¤</p><pre><code class="language-bash"># æ·»åŠ NodeèŠ‚ç‚¹çš„å‘½ä»¤add_node_command=`kubeadm token create --print-join-command`echo $&#123;add_node_command&#125;</code></pre><p>æ·»åŠ æ§åˆ¶å¹³é¢èŠ‚ç‚¹å‘½ä»¤</p><pre><code class="language-bash"># åˆ›å»º --certificate-keyjoin_certificate_key=`kubeadm init phase upload-certs --upload-certs|tail -1`# å‘½ä»¤ç»„åˆecho &quot;$&#123;add_node_command&#125; --control-plane --certificate-key $&#123;join_certificate_key&#125;&quot;</code></pre><h3 id="k8s02å’Œk8s03ä½œä¸ºæ§åˆ¶å¹³é¢æ·»åŠ åˆ°é›†ç¾¤">k8s02å’Œk8s03ä½œä¸ºæ§åˆ¶å¹³é¢æ·»åŠ åˆ°é›†ç¾¤</h3><pre><code class="language-bash">kubeadm join k8sapi:8443 \--token h77qhb.cjj8ig4t2v15dncm \--discovery-token-ca-cert-hash sha256:b7138bb76d19d3d7baf832e46559c400f4fe544d8f0ee81a87f \--control-plane --certificate-key fd996c7c0c2047c9c10a377f25a332bf4b5b00ca# sed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-scheduler.yamlsed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-controller-manager.yaml# é‡å¯ kubeletsystemctl restart kubelet# æ ¹æ®æç¤ºï¼Œæ‰§è¡Œç›¸å…³å‘½ä»¤ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸‹é¢çš„å‘½ä»¤mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config# ç­‰å¾…ä¸€åˆ†é’Ÿï¼ŒæŸ¥çœ‹æ‰€æœ‰ pod æ˜¯å¦æ­£å¸¸kubectl get pod -n kube-system===NAME                            READY   STATUS    RESTARTS   AGEcoredns-74ff55c5b-9gkgk         1/1     Running   0          2d13hcoredns-74ff55c5b-tndb5         1/1     Running   0          15detcd-k8s01                      1/1     Running   0          15detcd-k8s02                      1/1     Running   0          7m12setcd-k8s03                      1/1     Running   0          15dkube-apiserver-k8s01            1/1     Running   0          26hkube-apiserver-k8s02            1/1     Running   0          7m11skube-apiserver-k8s03            1/1     Running   0          26hkube-controller-manager-k8s01   1/1     Running   0          15dkube-controller-manager-k8s02   1/1     Running   0          82skube-controller-manager-k8s03   1/1     Running   1          15dkube-flannel-ds-42hng           1/1     Running   0          15dkube-flannel-ds-b42qj           1/1     Running   0          15dkube-flannel-ds-ss8w5           1/1     Running   0          15dkube-proxy-2xxpn                1/1     Running   0          15dkube-proxy-pg7j7                1/1     Running   0          15dkube-proxy-txh2t                1/1     Running   0          15dkube-scheduler-k8s01            1/1     Running   0          15dkube-scheduler-k8s02            1/1     Running   0          82skube-scheduler-k8s03            1/1     Running   0          15d</code></pre><h4 id="é—®é¢˜ç‚¹ï¼šetcdå·²æœ‰èŠ‚ç‚¹ä¿¡æ¯">é—®é¢˜ç‚¹ï¼šetcdå·²æœ‰èŠ‚ç‚¹ä¿¡æ¯</h4><p>å¦‚æœetcdä¸­æ›¾ç»æœ‰k8s02å’Œk8s03çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œåˆ™ä½ éœ€è¦å…ˆä»etcdä¸­åˆ é™¤ï¼Œå¦åˆ™åŠ å…¥çš„æ—¶å€™ï¼Œä¼šå¡åœ¨æ£€æµ‹etcdå¤„ï¼Œå¹¶æœ€ç»ˆæŠ¥é”™.</p><p>åˆ é™¤etcdä¿¡æ¯æ–¹å¼ï¼š</p><pre><code class="language-bash"># è¾“å‡º etcd èŠ‚ç‚¹ idETCD=`docker ps|grep etcd|grep -v POD|awk '&#123;print $1&#125;'`docker exec \  -it $&#123;ETCD&#125; \  etcdctl \  --endpoints https://127.0.0.1:2379 \  --cacert /etc/kubernetes/pki/etcd/ca.crt \  --cert /etc/kubernetes/pki/etcd/peer.crt \  --key /etc/kubernetes/pki/etcd/peer.key \  member list===2f401672c9a538f1, started, k8s01, https://10.200.16.101:2380, https://10.200.16.101:2379, falsed6d9ca2a70f6638e, started, k8s02, https://10.200.16.102:2380, https://10.200.16.102:2379, falseee0e9340a5cfb4d7, started, k8s03, https://10.200.16.103:2380, https://10.200.16.103:2379, false# å‡è®¾è¿™é‡Œæˆ‘è¦åˆ é™¤ k8s03ETCD=`docker ps|grep etcd|grep -v POD|awk '&#123;print $1&#125;'`docker exec \  -it $&#123;ETCD&#125; \  etcdctl \  --endpoints https://127.0.0.1:2379 \  --cacert /etc/kubernetes/pki/etcd/ca.crt \  --cert /etc/kubernetes/pki/etcd/peer.crt \  --key /etc/kubernetes/pki/etcd/peer.key \  member remove ee0e9340a5cfb4d7</code></pre><h2 id="NodeèŠ‚ç‚¹">NodeèŠ‚ç‚¹</h2><blockquote><p>åŠ å…¥å‘½ä»¤ï¼Œä½äº k8s01åˆå§‹åŒ–å‘½ä»¤å°¾éƒ¨ï¼ŒworkeråŠ å…¥çš„æ—¶å€™ï¼Œä¸éœ€è¦æ·»åŠ  --control-plane --certificate-key</p></blockquote><pre><code class="language-bash">kubeadm join k8sapi:8443 \--token h77qhb.cjj8ig4t2v15dncm \--discovery-token-ca-cert-hash sha256:b7138bb76d19d3d7baf832e46559c400f4fe544d8f0ee81a87f</code></pre><h2 id="å…¶ä»–å†…å®¹">å…¶ä»–å†…å®¹</h2><h3 id="å®¹å™¨ä¸­æ˜¾ç¤ºæ­£ç¡®çš„å¯è§èµ„æº">å®¹å™¨ä¸­æ˜¾ç¤ºæ­£ç¡®çš„å¯è§èµ„æº</h3><p>é»˜è®¤æƒ…å†µä¸‹,ä¸ç®¡ä½ å¦‚ä½•è®¾ç½®èµ„æºé™åˆ¶,å®¹å™¨é‡Œçš„å¯è§èµ„æºéƒ½ç­‰äºèŠ‚ç‚¹èµ„æº.ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨å®¹å™¨é‡ŒæŸ¥çœ‹/proc/meminfoæ˜¾ç¤ºçš„èµ„æºå¹¶ä¸æ˜¯ä½ è®¾ç½®çš„.è¿™ä¸ªé—®é¢˜ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦.</p><p>å› ä¸ºå¾ˆå¤šç¨‹åºçš„å‚æ•°éƒ½æ˜¯æ ¹æ®å¯è§èµ„æºæ¥è®¾å®šçš„.ä¾‹å¦‚nginxçš„auto, æˆ–è€…jvmé‡Œçš„å†…å­˜å‚æ•°.</p><blockquote><p>ä» Java 8u191å¼€å§‹, jvm å·²ç»é»˜è®¤å®ç°äº†å®¹å™¨æ„ŸçŸ¥( -XX:+UseContainerSupport). å› æ­¤æ— éœ€å®‰è£…ä¸‹é¢çš„ lxcfs æ–¹æ¡ˆ.</p><p>å¹¶ä¸”, åœ¨å®¹å™¨ä¸­å»ºè®®åªè®¾ç½®å¦‚ä¸‹å†…å­˜å‚æ•°:</p><p>-XX:MaxRAMPercentage  æœ€å¤§å †å†…å­˜=ç‰©ç†å†…å­˜ç™¾åˆ†æ¯”, å»ºè®®ä¸ºå®¹å™¨é™åˆ¶çš„50%-75% . æ¯•ç«Ÿè¿˜éœ€è¦é¢„ç•™å…¶å®ƒå†…å­˜.</p></blockquote><p>è€Œç¤¾åŒºå¸¸è§çš„ä½œæ³•æ˜¯ç”¨<code>lxcfs</code> æ¥æå‡èµ„æºçš„å¯è§æ€§.<code>lxcfs</code> æ˜¯ä¸€ä¸ªå¼€æºçš„FUSEï¼ˆç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼‰å®ç°æ¥æ”¯æŒLXCå®¹å™¨, å®ƒä¹Ÿå¯ä»¥æ”¯æŒDockerå®¹å™¨.</p><p>LXCFSé€šè¿‡ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ, åœ¨å®¹å™¨ä¸­æä¾›ä¸‹åˆ— <code>procfs</code> çš„æ–‡ä»¶.</p><pre><code class="language-bash">/proc/cpuinfo/proc/diskstats/proc/meminfo/proc/stat/proc/swaps/proc/uptime</code></pre><p>ä¸æˆ‘ä»¬èµ„æºé™åˆ¶æœ‰å…³çš„, ä¸»è¦æ˜¯ cpuinfo å’Œ meminfo.</p><p>ç›®å‰ç¤¾åŒºçš„åšæ³•å¦‚ä¸‹:</p><ol><li><p>æ‰€æœ‰èŠ‚ç‚¹å®‰è£… fuse-libs åŒ….</p><pre><code class="language-bash">yum install -y fuse-libs</code></pre></li><li><p>é›†ç¾¤éƒ¨ç½² lxcfs çš„ deployment èµ„æºå¯¹è±¡</p><pre><code class="language-bash">git clone https://github.com/denverdino/lxcfs-admission-webhook.gitcd lxcfs-admission-webhookvim deployment/lxcfs-daemonset.yaml=== ä¿®æ­£é…ç½®é‡Œçš„ apiVersion=== å½“å‰gité‡Œçš„ä»£ç æ˜¯é™ˆæ—§çš„...ä»£ç é‡Œçš„ç‰ˆæœ¬åœ¨ 1.18 å·²ç»è¢«åºŸå¼ƒ). å…·ä½“å½’å±äºä»€ä¹ˆç‰ˆæœ¬, è¯·å‚è€ƒk8så®˜æ–¹apiæ–‡æ¡£ === https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#daemonset-v1-appsapiVersion:apps/v1  kubectl apply -f deployment/lxcfs-daemonset.yamlkubectl get pod#ç­‰å¾… lxcfs pod çŠ¶æ€æˆ running#å¦‚æœä½ å‘ç° pod å§‹ç»ˆå‡ºé”™ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼škubectl delete -f deployment/lxcfs-daemonset.yamlrm -rf /var/lib/lxcfskubectl apply -f deployment/lxcfs-daemonset.yamldeployment/install.shkubectl get secrets,pods,svc,mutatingwebhookconfigurations</code></pre></li><li><p>ç»™ç›¸å…³namespaceæ³¨å…¥lxcfsï¼Œä¾‹å¦‚default</p><pre><code class="language-bash">kubectl label namespace default lxcfs-admission-webhook=enabled</code></pre></li><li><p>é‡å¯æ·»åŠ äº†èµ„æºé™åˆ¶çš„pod, æ­¤æ—¶ /proc/cpuinfo å’Œ /proc/meminfo å°†ä¼šæ­£ç¡®æ˜¾ç¤º.</p></li></ol><h3 id="é›†ç¾¤æŒ‡æ ‡ç›‘æ§æœåŠ¡">é›†ç¾¤æŒ‡æ ‡ç›‘æ§æœåŠ¡</h3><p>æ·»åŠ  metrics-server  <a href="https://github.com/kubernetes-sigs/metrics-server#configuration">https://github.com/kubernetes-sigs/metrics-server#configuration</a></p><pre><code class="language-bash">wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml# ä¿®æ”¹metrics-serverå®¹å™¨å‚æ•°éƒ¨åˆ†ï¼Œæ·»åŠ é¢å¤–çš„å¯åŠ¨å‚æ•°(arg)args:  - --kubelet-preferred-address-types=InternalIP  - --kubelet-insecure-tlskubectl apply -f components.yamlkubectl get --raw &quot;/apis/metrics.k8s.io/v1beta1/nodes&quot;</code></pre><blockquote><p>kubectl top æŒ‡ä»¤éœ€è¦æŒ‡æ ‡æ‰èƒ½è¾“å‡º</p></blockquote><hr><h2 id="kubectl-å‘½ä»¤æ–‡æ¡£">kubectl å‘½ä»¤æ–‡æ¡£</h2><blockquote><p><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands</a></p></blockquote><p>ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤</p><ol><li>kubectl explain</li></ol><blockquote><p>éå¸¸æœ‰ç”¨çš„å‘½ä»¤ï¼Œå¸®åŠ©ä½ å†™é…ç½®æ–‡ä»¶</p></blockquote><p>è¾“å‡ºé…ç½®æŸä¸ªå­—æ®µçš„è¯¦ç»†è¯´æ˜,ä¾‹å¦‚ deployment.metadata</p><blockquote><p>å…¶ä¸­æ ‡æ³¨æœ‰ -required- çš„å­—æ®µæ˜¯å¿…é€‰å­—æ®µ</p></blockquote><pre><code class="language-bash">kubectl explain deployment.metadata</code></pre><ol start="2"><li>-o yaml --dry-run</li></ol><p>è¾“å‡ºcreateå‘½ä»¤çš„yamlé…ç½®</p><pre><code class="language-bash">kubectl create serviceaccount mysvcaccount -o yaml --dry-run</code></pre><ol start="3"><li>å¸¸ç”¨çš„å·¥å…·å®¹å™¨</li></ol><pre><code class="language-bash">kubectl run cirros-$RANDOM -it --rm --restart=Never --image=cirros -- /bin/shkubectl run dnstools-$RANDOM -it --rm --restart=Never --image=infoblox/dnstools:latest </code></pre><h3 id="kubectl-è°ƒç”¨çš„é…ç½®">kubectl è°ƒç”¨çš„é…ç½®</h3><pre><code class="language-yaml">âœ   kubectl config viewapiVersion: v1clusters:- cluster:    certificate-authority-data: DATA+OMITTED    server: https://&lt;api_server&gt;:8443  name: kubernetes-qa- cluster:    certificate-authority-data: DATA+OMITTED    server: https://&lt;api_server&gt;:6443  name: kubernetes-prod  contexts:- context:    cluster: kubernetes-prod    user: kubernetes-admin  name: prod- context:    cluster: kubernetes-qa    user: user-kfktf786bk  name: qa  current-context: qa           ## å½“å‰ä½¿ç”¨çš„é…ç½®kind: Configpreferences: &#123;&#125;users:- name: kubernetes-admin  user:    client-certificate-data: REDACTED    client-key-data: REDACTED- name: user-kfktf786bk  user:    client-certificate-data: REDACTED    client-key-data: REDACTED</code></pre><h2 id="åˆ é™¤ä¸æ¸…ç†">åˆ é™¤ä¸æ¸…ç†</h2><pre><code class="language-bash"># ä»é›†ç¾¤é‡Œåˆ é™¤æŸä¸ªèŠ‚ç‚¹# master execkubectl drain &lt;NODE_ID&gt; --delete-local-data --force --ignore-daemonsetskubectl delete node &lt;NODE_ID&gt;# worker execkubeadm resetiptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -Xipvsadm --clear;ip link set cni0 down &amp;&amp; ip link delete cni0;ip link set flannel.1 down &amp;&amp; ip link delete flannel.1;ip link set kube-ipvs0 down &amp;&amp; ip link delete kube-ipvs0;ip link set dummy0 down &amp;&amp; ip link delete dummy0;rm -rf /var/lib/cni/rm -rf $HOME/.kube;</code></pre><h2 id="èŠ‚ç‚¹ä¸€è‡´æ€§æµ‹è¯•">èŠ‚ç‚¹ä¸€è‡´æ€§æµ‹è¯•</h2><blockquote><p><a href="https://kubernetes.io/docs/setup/node-conformance/">https://kubernetes.io/docs/setup/node-conformance/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜è®°å½•ç‚¹</title>
      <link href="posts/e1096625/"/>
      <url>posts/e1096625/</url>
      
        <content type="html"><![CDATA[<h3 id="1-pvå’Œpvcçš„ç»‘å®šå…³ç³»æ˜¯ç»ˆç”Ÿçš„-ä¹Ÿå°±æ˜¯è¯´ä½ åˆ é™¤äº†å½“å‰pvc-pvä¾ç„¶ä¸èƒ½è¢«å…¶å®ƒpvcæ‰€ç»‘å®š">1. pvå’Œpvcçš„ç»‘å®šå…³ç³»æ˜¯ç»ˆç”Ÿçš„. ä¹Ÿå°±æ˜¯è¯´ä½ åˆ é™¤äº†å½“å‰pvc, pvä¾ç„¶ä¸èƒ½è¢«å…¶å®ƒpvcæ‰€ç»‘å®š.</h3><p>åˆ é™¤pvcå, pvçš„çŠ¶æ€å°†ä»boundè½¬ä¸ºReleased.</p><p>å¦‚æœä½ æƒ³è®©pvä»æ–°ç»‘å®šåˆ°åŸæ¥çš„pvcä¸Š, åˆ™éœ€è¦ä¸¤ä¸ªæ­¥éª¤:</p><ol><li>å…ˆåˆ›å»ºåŸæ¥çš„pvc.</li><li>åˆ é™¤å½“å‰pvå¹¶é‡æ–°åˆ›å»º, æˆ–è€…ä¿®æ”¹å½“å‰pvçš„é…ç½®, åˆ é™¤spec.claimRefä¿¡æ¯.</li></ol><h3 id="2-podæ— æ³•æ­£å¸¸å¯åŠ¨ï¼ŒæŠ¥é”™ï¼šâ€œmounting-â€œ-var-lib-lxcfs-proc-loadavg-â€">2. podæ— æ³•æ­£å¸¸å¯åŠ¨ï¼ŒæŠ¥é”™ï¼šâ€œmounting \â€œ/var/lib/lxcfs/proc/loadavg\â€</h3><p>to rootfs \&quot;/export/docker-data-root/overlay2/710d09a6715d88a01b417ba1a669dab69b67c3d57e576c1ae6d79aa03e1b294a/mergedâ€</p><p>æ ¹æ®ä¿¡æ¯å¯çŸ¥é—®é¢˜ç‚¹åº”è¯¥æ˜¯ lxcfs é—®é¢˜ã€‚</p><p>æŸ¥çœ‹æ•…éšœpodæ‰€åœ¨èŠ‚ç‚¹çš„ lxcfs pod æ—¥å¿—ï¼Œå¾—åˆ°ä¿¡æ¯</p><p>â€œfuse: mountpoint is not empty<br>fuse: if you are sure this is safe, use the â€˜nonemptyâ€™ mount optionâ€</p><p>å› æ­¤åˆ é™¤èŠ‚ç‚¹ lxcfs ç›®å½•ï¼Œå¹¶é‡å»º lxcfs pod</p><pre><code class="language-bash">rm -rf  /var/lib/lxcfs/ &amp;&amp; kubectl delete pod/lxcfs-hthgq</code></pre><h3 id="3-å˜æ›´pvå›æ”¶ç­–ç•¥">3. å˜æ›´pvå›æ”¶ç­–ç•¥</h3><pre><code class="language-bash">kubectl patch pv &lt;your-pv-name&gt; -p '&#123;&quot;spec&quot;:&#123;&quot;persistentVolumeReclaimPolicy&quot;:&quot;Retain&quot;&#125;&#125;'</code></pre><h3 id="4-kubernetes-qos">4. kubernetes qos</h3><p>kubernetes æœ‰ä¸‰ç§ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯Guaranteedå’ŒBurstableå’ŒBestEffort</p><p>Guaranteedï¼šä»»ä½•å®¹å™¨çš„cpuè¯·æ±‚å€¼å’Œé™åˆ¶å€¼å¿…é¡»ä¸€æ ·ã€‚å†…å­˜åŒæ ·å¦‚æ­¤</p><p>Burstableï¼šæœ€å°‘æœ‰ä¸€ä¸ªå®¹å™¨çš„cpuè¯·æ±‚å€¼å’Œé™åˆ¶å€¼å¿…é¡»ä¸€æ ·ã€‚å†…å­˜åŒæ ·å¦‚æ­¤</p><p>BestEffortï¼š æ²¡æœ‰ä»»ä½•é™åˆ¶</p><h3 id="5-kubeletæ— æ³•å¯åŠ¨ï¼ŒæŠ¥é”™ï¼škubelet-service-holdoff-time-over">5. kubeletæ— æ³•å¯åŠ¨ï¼ŒæŠ¥é”™ï¼š<code>kubelet.service holdoff time over</code></h3><p>ç¡®è®¤èŠ‚ç‚¹swapæ˜¯å¦å…³é—­</p><p>ä¸´æ—¶å…³é—­<code>swapoff -a</code></p><p>æ°¸ä¹…å…³é—­<code>æ³¨é‡Š/etc/fstabæ–‡ä»¶é‡Œçš„swapæŒ‚è½½è¡Œ</code></p><h3 id="6-æ‹‰å–ç§æœ‰é•œåƒ">6. æ‹‰å–ç§æœ‰é•œåƒ</h3><pre><code class="language-shell">kubectl create secret docker-registry &lt;secret_name&gt; --docker-server=&lt;FQDN:your-registry-server&gt; --docker-username=&lt;your-name&gt; --docker-password=&lt;your-pword&gt; --docker-email=&lt;your-email&gt;</code></pre><p>deployment å¯¹è±¡ä¸­è°ƒç”¨ï¼š<code>deployment.spec.template.spec.imagePullSecrets: [&lt;secret_name&gt;]</code></p><h3 id="7-pvä¸€ç›´æ— æ³•åˆ é™¤æ‰">7. pvä¸€ç›´æ— æ³•åˆ é™¤æ‰</h3><pre><code class="language-bash"># æ£€æŸ¥æ˜¯å¦å—ä¿æŠ¤kubectl describe pv &lt;pv&gt; | grep Finalizers # é‡ç½®ç­–ç•¥ä¸ºç©ºkubectl patch pv &lt;pv&gt; -p '&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;'</code></pre><h3 id="8-ç»Ÿè®¡èŠ‚ç‚¹å®¹å™¨ç£ç›˜ä½¿ç”¨æƒ…å†µ">8. ç»Ÿè®¡èŠ‚ç‚¹å®¹å™¨ç£ç›˜ä½¿ç”¨æƒ…å†µ</h3><pre><code class="language-bash">kubectl get --raw /api/v1/nodes/&lt;èŠ‚ç‚¹å&gt;/proxy/stats/summary | jq '.pods[0] | &quot;PodName: &quot;, .podRef.name, &quot;usedBytes: &quot;, .containers[].rootfs.usedBytes'</code></pre><h3 id="9-åœ¨-Kubernetes-ä¸­æŸ¥çœ‹å´©æºƒçš„-pod-çš„æ—¥å¿—">9. åœ¨ Kubernetes ä¸­æŸ¥çœ‹å´©æºƒçš„ pod çš„æ—¥å¿—</h3><p>å·²å´©æºƒçš„podæ— æ³•é€šè¿‡<code>kubectl logs</code>æŸ¥çœ‹.</p><pre><code class="language-bash">kubectl get events -n &lt;ns_name&gt; --sort-by='.metadata.createTimestamp''</code></pre><h3 id="10-Podä¸€ç›´å¤„äºåˆ é™¤çŠ¶æ€">10.Podä¸€ç›´å¤„äºåˆ é™¤çŠ¶æ€</h3><p>æ£€æŸ¥Podæ‰€åœ¨èŠ‚ç‚¹çš„kubeletæ—¥å¿—ï¼Œå‘ç°å‡ºç°<code>Error: &quot;UnmountVolume.TearDown failed for volume</code>æ— æ³•åæŒ‚è½½çš„é”™è¯¯ã€‚</p><p>è¿›ä¸€æ­¥æŸ¥çœ‹é”™è¯¯åé¢ä¿¡æ¯ï¼Œå¾—çŸ¥<code>Unmountçš„Pathï¼š/var/lib/kubelet/pods/aa104758-a3a0-4ec3-977b-be9ef8530e5c/volumes/kubernetes.io~projected/kube-api-access-6vltw/</code></p><pre><code class="language-bash">path=/var/lib/kubelet/pods/aa104758-a3a0-4ec3-977b-be9ef8530e5c/volumes/kubernetes.io~projected/kube-api-access-6vltwfind /proc/*/mounts -exec grep $&#123;path&#125; &#123;&#125; +ps -ef | grep &lt;pid å·&gt;</code></pre><p>ç¡®è®¤å ç”¨çš„è¿›ç¨‹ä¿¡æ¯ï¼Œæ˜¯å¦å±äºå¤„äºåˆ é™¤çŠ¶æ€çš„Podï¼Œå¦‚æœæ˜¯ï¼Œkillæ‰å³å¯.</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusâ˜æ­å»º</title>
      <link href="posts/65820315/"/>
      <url>posts/65820315/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>prometheus ç›‘æ§çš„æ„å»ºï¼Œç›¸æ¯” zabbix æ¥è¯´ï¼Œè¿˜æ˜¯è¦éº»çƒ¦ä¸€äº›ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœä½ å®Œå…¨ç†Ÿæ‚‰ä¹‹åï¼Œé…ç½®æ–‡ä»¶åŒ–ä¹Ÿæ›´å®¹æ˜“è¢«å…¶ä»–ç³»ç»Ÿæ‰€ä¿®æ”¹ã€‚</p><h1>ç›‘æ§ç«¯ç»„ä»¶</h1><p>æä¹‹å‰ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œ</p><pre><code class="language-bash">docker network create promsnet</code></pre><h2 id="Grafana-å±•ç¤º">Grafana å±•ç¤º</h2><p><a href="https://grafana.com/docs/grafana/latest/installation/docker/">https://grafana.com/docs/grafana/latest/installation/docker/</a></p><p><a href="https://hub.docker.com/r/grafana/grafana">https://hub.docker.com/r/grafana/grafana</a></p><blockquote><p>æ•°æ®å±•ç¤ºï¼Œéƒ¨ç½²åœ¨ proms ç«¯</p></blockquote><h3 id="é…ç½®">é…ç½®</h3><blockquote><p>/export/docker-data-grafana/conf/default.ini</p></blockquote><p>ä¸»é…ç½®é‡Œå‚æ•°éå¸¸å¤šï¼Œä¿®æ”¹ä¸‹åˆ—åŸºæœ¬é…ç½®å³å¯</p><pre><code class="language-ini">[server]domain = åŸŸåhttp_port = ç«¯å£[database]type = sqlite3host = 127.0.0.1:3306name = grafanauser = rootpassword =[smtp]enabled = truehost = smtp.feishu.cn:465user = password = skip_verify = truefrom_address = from_name = GrafanaAdmin</code></pre><h3 id="å®‰è£…å¯åŠ¨">å®‰è£…å¯åŠ¨</h3><pre><code class="language-bash">versionTag=8.3.6mkdir -p /export/docker-data-grafana/&#123;data,conf&#125;chmod 777 /export/docker-data-grafana/datadocker run --name grafana \--restart always \--network promsnet \--mount 'type=bind,src=/export/docker-data-grafana/data,dst=/var/lib/grafana' \--mount 'type=bind,src=/export/docker-data-grafana/conf,dst=/usr/share/grafana/conf' \-p 3000:3000 -d grafana/grafana:$&#123;versionTag&#125;cat &lt;&lt; EOF | tee grafana.docker.commanddocker run --name grafana \--restart always \--network promsnet \--mount 'type=bind,src=/export/docker-data-grafana/data,dst=/var/lib/grafana' \--mount 'type=bind,src=/export/docker-data-grafana/conf,dst=/usr/share/grafana/conf' \-p 3000:3000 -d grafana/grafana:$&#123;versionTag&#125;EOF</code></pre><p>æ­£å¼ç‰ˆæœ¬å·ï¼Œçº¯æ•°å­—ï¼Œæ²¡æœ‰ä»»ä½•testæˆ–è€…preåç¼€</p><blockquote><p>é»˜è®¤è´¦æˆ·/åˆå§‹å¯†ç éƒ½æ˜¯admin</p><p>é»˜è®¤é…ç½®åº“æ˜¯sqlite 3</p></blockquote><h3 id="å‡çº§">å‡çº§</h3><pre><code class="language-bash">dateTime=`date +%Y%m%d`cp -rp /export/docker-data-grafana /export/docker-data-grafana.$&#123;dateTime&#125;</code></pre><h2 id="Alertmanager-å‘Šè­¦ç®¡ç†">Alertmanager å‘Šè­¦ç®¡ç†</h2><p>å‘Šè­¦ç®¡ç†å™¨ï¼Œæ¥æ”¶ proms å‘æ¥çš„å‘Šè­¦ï¼Œç»è¿‡ã€åˆ†ç»„ã€‘=&gt;ã€æ”¶æ•›ã€‘=&gt;ã€é™é»˜ã€‘å¤„ç†åé€šè¿‡ã€receiverã€‘å‘å‡ºã€‚</p><p>å…¶é…ç½®ä¸­çš„æ ‡ç­¾å¯ä»¥æ˜¯prometheusåˆ®å–æ•°æ®ä¸­è‡ªå¸¦çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯prometheuså‘Šè­¦è§„åˆ™ä¸­è‡ªå®šä¹‰çš„labelsã€‚</p><h3 id="å‘Šè­¦åˆ†ç»„ã€æ”¶æ•›ã€é™é»˜">å‘Šè­¦åˆ†ç»„ã€æ”¶æ•›ã€é™é»˜</h3><p>åˆ†ç»„çš„æ„æ€ï¼Œå°±æ˜¯å°†æŸä¸€ä¸ªç»„å†…åŒä¸€æ—¶æœŸçš„å‘Šè­¦åˆå¹¶å‘é€ï¼Œä¾‹å¦‚æ ¹æ®å®ä¾‹æ¥åˆ†ç»„ã€‚</p><p>æ”¶æ•›çš„æ„æ€ï¼Œå°±æ˜¯å‘Šè­¦Aè§„åˆ™å’Œå‘Šè­¦Bè§„åˆ™åŒæ—¶è§¦å‘ï¼Œä½†æ˜¯å‘Šè­¦Aè§„åˆ™å‡ºç°çš„æ—¶å€™ï¼Œå¿…ç„¶ä¼šè§¦å‘å‘Šè­¦Bï¼Œæ­¤æ—¶åªå‘å‘Šè­¦Aï¼Œä¾‹å¦‚MYSQLæœºå™¨æŒ‚äº†ï¼Œé‚£ä¹ˆåªéœ€è¦å‘æœºå™¨æŒ‚æ‰çš„å‘Šè­¦ï¼ŒMYSQLçš„å‘Šè­¦å°±æ²¡å¿…è¦å‘é€äº†ã€‚</p><p>é™é»˜çš„æ„æ€ï¼Œå°±æ˜¯ç”¨æˆ·å·²çŸ¥è¿™ä¸ªæ—¶é—´ç‚¹ä¼šè§¦å‘å‘Šè­¦è§„åˆ™ï¼Œä½†æ˜¯æ— éœ€è§¦å‘ï¼Œä¾‹å¦‚é«˜å‹åŠ›å®šæ—¶ä»»åŠ¡å¼•èµ·ç£ç›˜IOå‘Šè­¦ï¼Œè™½ç„¶ä¼šè§¦å‘å¹³å‡æŒ‡æ ‡å‘Šè­¦ï¼Œä½†æ˜¯åœ¨ç”¨æˆ·è®¤å®šçš„å®‰å…¨èŒƒå›´å†…ï¼Œå› è€Œæ— éœ€è§¦å‘ã€‚</p><ul><li>åˆ†ç»„</li></ul><p>åœ¨ã€routeã€‘æ ¹è·¯ç”±ä¸Šé€šè¿‡ã€labelã€‘è¿›è¡Œåˆ†ç»„ï¼ŒåŒç»„çš„é¢„è­¦å°½é‡ä¸€æ¬¡æ€§å‘å‡º</p><pre><code class="language-yaml">route:  group_by: ['alertname']  # å‘Šè­¦åˆ†ç»„æŒ‡æ ‡, å¯ä»¥å†™å¤šä¸ªï¼Œä»è€Œè¿›ä¸€æ­¥åˆ†ç»„ã€‚  group_wait: 10s # åˆ†ç»„åï¼Œç»„å†…éœ€å‘Šè­¦çš„ç¬¬ä¸€æ¡è§„åˆ™éœ€è¦åœ¨ 10s å†…ç­‰å¾…å…¶å®ƒå¯èƒ½çš„å‘Šè­¦è§„åˆ™ï¼Œç­‰å¾…ç»“æŸåä¸€æ¬¡æ€§å‘å‡ºã€‚  group_interval: 5m # åœ¨å‘ç”Ÿå‘Šè­¦åï¼ŒåŒç»„å†…éœ€å‘Šè­¦çš„è§„åˆ™åˆ—è¡¨éœ€è¦åœ¨ 5m å†…ç­‰å¾…åˆ—è¡¨å¯èƒ½å‘ç”Ÿçš„å˜åŠ¨ï¼Œè‹¥æœ‰å˜åŒ–ï¼Œåˆ™ç­‰å¾…ç»“æŸåå†æ¬¡å‘é€ã€‚  repeat_interval: 1h # åœ¨å‘ç”Ÿå‘Šè­¦åï¼ŒåŒç»„éœ€å‘Šè­¦çš„è§„åˆ™åˆ—è¡¨è‹¥åœ¨ 1h å†…æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™å†æ¬¡å‘é€ã€‚</code></pre><p>ğŸ‘€<code>alertname</code>æ ‡ç­¾æŒ‡çš„æ˜¯prometheuså‘Šè­¦è§„åˆ™åç§°</p><p>æ ¹è·¯ç”±ã€routeã€‘ä¹‹åï¼Œè¿˜å¯ä»¥ç»§ç»­é€šè¿‡å­è·¯ç”±ã€routesã€‘æ¥å°†ä¸åŒã€labelã€‘çš„å‘Šè­¦å‘é€ç»™ä¸åŒçš„ã€receiverã€‘ã€‚</p><ul><li>æ”¶æ•›</li></ul><p>ä¸¾ä¾‹è¯´æ˜ï¼šå½“ä¸»æœºæŒ‚äº†ï¼Œæ­¤æ—¶åªéœ€è¦å‘é€ä¸»æœºæŒ‚æ‰çš„é¢„è­¦ï¼Œæ— éœ€å†å‘é€å› ä¸»æœºæŒ‚æ‰è€Œäº§å‡ºçš„å…¶å®ƒé¢„è­¦ã€‚</p><pre><code class="language-yaml">inhibit_rules:  - source_matchers: [severity=&quot;critical&quot;]    target_matchers: [severity=~&quot;error|warning&quot;]    equal: [cluster] # é’ˆå¯¹åŒ…å« cluster æ ‡ç­¾çš„å‘Šè­¦  - source_matchers: [severity=&quot;critical&quot;]    target_matchers: [severity=~&quot;error|warning&quot;]    equal: [instance] # é’ˆå¯¹åŒ…å« instance æ ‡ç­¾çš„å‘Šè­¦  - source_matchers: [severity=&quot;error&quot;]    target_matchers: [severity=&quot;warning&quot;]    equal: [name] # é’ˆå¯¹åŒ…å«å®¹å™¨æ ‡ç­¾ name çš„å‘Šè­¦</code></pre><p>source_matchers åˆ—å‡ºåŒ¹é…æ ‡ç­¾é”®å€¼å¯¹çš„ã€éœ€å‘Šè­¦ã€‘è§„åˆ™ï¼›</p><p>target_matchers  åˆ—å‡ºåŒ¹é…æ ‡ç­¾é”®å€¼å¯¹çš„ã€æ— éœ€å‘Šè­¦ã€‘è§„åˆ™ï¼›</p><p>å½“ equal çš„æ ‡ç­¾ã€åŒæ—¶ã€‘è¢« source_matchers å’Œ target_matchers åŒ¹é…çš„æ—¶å€™ï¼Œinhibit_rule è§„åˆ™ç”Ÿæ•ˆã€‚</p><ul><li>é™é»˜</li><li>æ¥æ”¶è€…</li></ul><p>ã€receiverã€‘ç»Ÿä¸€ç”±ã€receiversã€‘è¿›è¡Œé…ç½®ã€‚</p><h3 id="é…ç½®-2">é…ç½®</h3><p><a href="https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml">https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml</a></p><p>alertmanager.yml</p><pre><code class="language-bash">global:  resolve_timeout: 5m  smtp_smarthost: 'localhost:25'  smtp_require_tls: true  smtp_from: 'alertmanager@example.org'  smtp_auth_username: 'alertmanager'  smtp_auth_password: 'password'route:  group_by: ['alertname']  group_wait: 10s  group_interval: 10s  repeat_interval: 1h  receiver: 'wechat'  routes:    - matchers:        - app=~&quot;app1|app2&quot;      receiver: email      routes:        - matchers:            - severity=&quot;critical&quot;          receiver: wechatreceivers:- name: 'wechat'  wechat_configs:  - corp_id: ''    to_user: ''    agent_id: ''    api_secret: ''    send_resolved: true- name: 'email'  email_configs:  - to: &lt;tmpl_string&gt;inhibit_rules:  - source_matchers: [severity=&quot;critical&quot;]    target_matchers: [severity=~&quot;error|warning&quot;]    equal: [cluster] # é’ˆå¯¹åŒ…å« cluster æ ‡ç­¾çš„å‘Šè­¦  - source_matchers: [severity=&quot;critical&quot;]    target_matchers: [severity=~&quot;error|warning&quot;]    equal: [instance] # é’ˆå¯¹åŒ…å« instance æ ‡ç­¾çš„å‘Šè­¦  - source_matchers: [severity=&quot;error&quot;]    target_matchers: [severity=&quot;warning&quot;]    equal: [name] # é’ˆå¯¹åŒ…å«å®¹å™¨æ ‡ç­¾ name çš„å‘Šè­¦</code></pre><p>ä¸Šé¢æ˜¯å¾®ä¿¡çš„ï¼Œä½ ä¹Ÿå¯ä»¥webhookæ–¹å¼ï¼Œæ¥èµ°å…¶å®ƒæ–¹å¼ï¼Œä¾‹å¦‚é£ä¹¦/é’‰é’‰</p><pre><code class="language-bash">global:  resolve_timeout: 5m# å‘Šè­¦æ ¹è·¯ç”±route:  group_by: ['alertname']  group_wait: 10s  group_interval: 5m  repeat_interval: 60m  receiver: 'feishu'# é»˜è®¤çš„æ¥æ”¶é˜Ÿåˆ—receivers:- name: 'feishu'  webhook_configs:  - url: ''# æŠ‘åˆ¶è§„åˆ™inhibit_rules:  - source_matchers: [severity=&quot;critical&quot;]    target_matchers: [severity=~&quot;error|warning&quot;]    equal: [cluster] # é’ˆå¯¹åŒ…å« cluster æ ‡ç­¾çš„å‘Šè­¦  - source_matchers: [severity=&quot;critical&quot;]    target_matchers: [severity=~&quot;error|warning&quot;]    equal: [instance] # é’ˆå¯¹åŒ…å« instance æ ‡ç­¾çš„å‘Šè­¦  - source_matchers: [severity=&quot;error&quot;]    target_matchers: [severity=&quot;warning&quot;]    equal: [name] # é’ˆå¯¹åŒ…å«å®¹å™¨æ ‡ç­¾ name çš„å‘Šè­¦</code></pre><p>ğŸ’é£ä¹¦/é’‰é’‰ï¼Œå¯ä»¥ç”¨éƒ¨ç½² <a href="https://gitee.com/feiyu563/PrometheusAlert">PrometheusAlert</a></p><h3 id="å¯åŠ¨">å¯åŠ¨</h3><pre><code class="language-bash">mkdir -p /export/docker-data-alertmanagerdocker run --name alertmanager -d \  --restart always \  --network promsnet \  -p 9093:9093 \  --mount 'type=bind,src=/export/docker-data-alertmanager,dst=/etc/alertmanager' \  prom/alertmanager</code></pre><h2 id="Prometheus-ä¸»ç¨‹">Prometheus ä¸»ç¨‹</h2><pre><code class="language-bash">mkdir /export/docker-data-proms/&#123;data,conf&#125; -pchmod 777 /export/docker-data-proms/data</code></pre><h3 id="é…ç½®-3">é…ç½®</h3><h4 id="ä¸»é…ç½®">ä¸»é…ç½®</h4><p>/export/docker-data-proms/promethesu.yml</p><pre><code class="language-:"># my global configglobal:  scrape_interval:     15s # ä»æ•°æ®æºå¤„åˆ®å–æ•°æ®çš„é—´éš”å‘¨æœŸã€‚é»˜è®¤æ˜¯1åˆ†é’Ÿ  evaluation_interval: 15s # é‡æ–°è¯„ä¼°å‘Šè­¦è¡¨è¾¾å¼çš„é—´éš”å‘¨æœŸã€‚é»˜è®¤æ˜¯1åˆ†é’Ÿ  # scrape_timeout is set to the global default (10s).# Alertmanager configurationalerting:  alertmanagers:  - static_configs:    - targets:      - alertmanager:9093# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.rule_files:  - &quot;/etc/prometheus/conf/rules/*.yml&quot;# A scrape configuration containing exactly one endpoint to scrape:# Here it's Prometheus itself.scrape_configs:  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.#  - job_name: 'prometheus'#    static_configs:#    - targets: ['proms:9090']#  - job_name: &quot;grafana&quot;#    static_configs:#    - targets: ['grafana:3000']  - job_name: &quot;auto_discovery_dns&quot;    relabel_configs: # æ•°æ®è·å–ä¹‹å‰ï¼Œé’ˆå¯¹æ•°æ®æº target çš„æ ‡ç­¾ä¿®æ”¹    - source_labels: [&quot;__address__&quot;]  # å°† target ä¸­æ ‡ç­¾é”® __address__ = (.*):9100 å˜æ›´ä¸º instance = .*      regex: &quot;(.*):9100&quot; # åŒ¹é…åŸå§‹æ ‡ç­¾çš„å€¼      replacement: &quot;$1&quot; # æå– regex ä¸­æ‹¿åˆ°çš„å€¼      target_label: &quot;instance&quot; # è®¾å®šè¦ä¿®æ”¹çš„ç›®æ ‡æ ‡ç­¾      action: replace # å°†ç›®æ ‡æ ‡ç­¾çš„å€¼æ›¿æ¢ä¸º replacement æå–çš„å€¼    - source_labels: [&quot;__address__&quot;]  # è·å–åŸå§‹æ ‡ç­¾      regex: &quot;(.*):10052&quot; # åŒ¹é…åŸå§‹æ ‡ç­¾çš„å€¼      replacement: &quot;$1&quot; # æå– regex ä¸­æ‹¿åˆ°çš„å€¼      target_label: &quot;instance&quot; # è®¾å®šè¦ä¿®æ”¹çš„ç›®æ ‡æ ‡ç­¾      action: replace # å°†ç›®æ ‡æ ‡ç­¾çš„å€¼æ›¿æ¢ä¸º replacement æå–çš„å€¼    metric_relabel_configs: # æ•°æ®è·å–åï¼Œé’ˆå¯¹æ•°æ®æŒ‡æ ‡è½ç›˜å‰çš„ä¿®æ”¹    - source_labels: [&quot;__name__&quot;] # è·å–åŸå§‹æ ‡ç­¾      regex: &quot;^go_.*|^process_.*&quot; # åŒ¹é…æ ‡ç­¾å€¼      action: drop # åˆ é™¤ï¼Œä¸è®©æ•°æ®è½ç›˜    dns_sd_configs: # é€šè¿‡ dns srv è®°å½•è‡ªåŠ¨å‘ç°    - names: [&quot;_prometheus._tcp.zjk.pj&quot;]</code></pre><p>relabel_configsï¼šé’ˆå¯¹scrape target endpoint çš„æ ‡ç­¾ä¿®æ”¹</p><p>metric_relabel_configsï¼šé’ˆå¯¹scrape target endpointæ‹¿åˆ°çš„metricsæ•°æ®çš„æ ‡ç­¾ä¿®æ”¹</p><p><code>__name__</code>æ˜¯å†…ç½®çš„é’ˆå¯¹æ ‡ç­¾é”®çš„é€šç”¨å</p><h5 id="åŸå§‹æ ‡ç­¾å’Œç›®æ ‡æ ‡ç­¾">åŸå§‹æ ‡ç­¾å’Œç›®æ ‡æ ‡ç­¾</h5><p>å¯ä»¥åœ¨ä¸‹å›¾ä½ç½®ã€Statusã€‘-ã€Service Discoveryã€‘ä¸­çœ‹åˆ°è¯¦æƒ…</p><p><img src="/posts/65820315/image-20210316182617074.png" alt="image-20210316182617074"></p><h5 id="è‡ªåŠ¨å‘ç°">è‡ªåŠ¨å‘ç°</h5><p>dns srv è‡ªåŠ¨å‘ç°ï¼Œéœ€è¦ä¸€ä¸ªå†…éƒ¨çš„dnsæœåŠ¡å™¨ï¼Œä¾‹å¦‚é˜¿é‡Œäº‘çš„äº‘ç§æœ‰è§£æç­‰ã€‚</p><p>å¦‚ä½•æ·»åŠ  srv è®°å½•ï¼Œä¾‹å¦‚è®©promså‘ç°èŠ‚ç‚¹æœåŠ¡ all.it.zjk.pj:9100 å’Œ all.it.zjk.pj:10052</p><ol><li>æ·»åŠ ç§æœ‰åŸŸ zjk.pj</li><li>æ·»åŠ Aè®°å½• all.it.zjk.pj -&gt; 192.168.1.1</li><li>æ·»åŠ srvè®°å½• _prometheus._tcp.zjk.pj -&gt; 10 10 9100 all.it.zjk.pj</li><li>æ·»åŠ srvè®°å½• _prometheus._tcp.zjk.pj -&gt; 10 10 10052 all.it.zjk.pj</li></ol><p>å…³äºAè®°å½•å°±ä¸è¯´äº†ï¼Œsrvè®°å½•é‡Œ <code>10 10 9100 all.it.zjk.pj</code>çš„æ„æ€æ˜¯<code>ä¼˜å…ˆçº§ æƒé‡ æœåŠ¡ç«¯å£ æœåŠ¡å™¨åŸŸå</code></p><p>æœ€ç»ˆï¼Œä½ å¯ä»¥åœ¨ http://&lt;prometheus_ip&gt;:9090/classic/targets çœ‹åˆ°è‡ªåŠ¨å‘ç°çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚</p><h4 id="å®šä¹‰éœ€è¦å‘Šè­¦çš„æŒ‡æ ‡è§„åˆ™">å®šä¹‰éœ€è¦å‘Šè­¦çš„æŒ‡æ ‡è§„åˆ™</h4><p>å°†é‡‡é›†çš„æ•°æ®æŒ‡æ ‡é€šè¿‡ expr è¿›è¡Œè¿ç®—ï¼Œå¹¶é€šè¿‡ record è¿›è¡Œå‘½åã€‚</p><p>å…³äºè§„åˆ™é‡Œçš„è¡¨è¾¾å¼è¯­å¥çš„å†™æ³•æ¶‰åŠåˆ° PromQLï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æ–‡æ¡£ã€‚</p><p><a href="https://fuckcloudnative.io/prometheus/3-prometheus/basics.html">https://fuckcloudnative.io/prometheus/3-prometheus/basics.html</a></p><h5 id="ä¸»æœºç›‘æ§æŒ‡æ ‡è§„åˆ™">ä¸»æœºç›‘æ§æŒ‡æ ‡è§„åˆ™</h5><p>/export/docker-data-proms/conf/rules/node-exporter-record-rules.yml</p><pre><code class="language-bash"># node-exporter-record-rules.yml# æ ‡ç­¾ job å…³è”ä¸»é…ç½®å®šä¹‰çš„ä»»åŠ¡ auto_discovery_dnsï¼Œè·å–ä»»åŠ¡ä¼ é€’çš„æ•°æ®ï¼Œä»è€ŒæŠ½å–ä¿¡æ¯å®šä¹‰ expr# ç»™ expr è¡¨è¾¾å¼è®¾ç½®ä¸€ä¸ªåˆ«å record, åˆ«åå¯ä»¥è¢«å…¶å®ƒ rules è°ƒç”¨groups:  - name: node_exporter-record    rules:    - expr: up&#123;job=~&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:up      labels:        desc: &quot;èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿, åœ¨çº¿1,ä¸åœ¨çº¿0&quot;        unit: &quot; &quot;        job: &quot;auto_discovery_dns&quot;    - expr: time() - node_boot_time_seconds&#123;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:node_uptime      labels:        desc: &quot;èŠ‚ç‚¹çš„è¿è¡Œæ—¶é—´&quot;        unit: &quot;s&quot;        job: &quot;auto_discovery_dns&quot;###############################################################################################                              cpu                                                           #    - expr: (1 - avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:total:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpuæ€»æ¶ˆè€—ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:idle:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu idleç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;iowait&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:iowait:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu iowaitç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;system&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:system:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu systemç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;user&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:user:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu userç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=~&quot;softirq|nice|irq|steal&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:other:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu å…¶ä»–çš„ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;###############################################################################################                                    memory                                                  #    - expr: node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:total      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜æ€»é‡&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr: node_memory_MemFree_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:free      labels:        desc: &quot;èŠ‚ç‚¹çš„å‰©ä½™å†…å­˜é‡&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr: node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; - node_memory_MemFree_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:used      labels:        desc: &quot;èŠ‚ç‚¹çš„å·²ä½¿ç”¨å†…å­˜é‡&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr: node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; - node_memory_MemAvailable_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:actualused      labels:        desc: &quot;èŠ‚ç‚¹ç”¨æˆ·å®é™…ä½¿ç”¨çš„å†…å­˜é‡&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr: (1-(node_memory_MemAvailable_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: ((node_memory_MemAvailable_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:free:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜å‰©ä½™ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;###############################################################################################                                   load                                                     #    - expr: sum by (instance) (node_load1&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load1      labels:        desc: &quot;ç³»ç»Ÿ1åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;auto_discovery_dns&quot;    - expr: sum by (instance) (node_load5&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load5      labels:        desc: &quot;ç³»ç»Ÿ5åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;auto_discovery_dns&quot;    - expr: sum by (instance) (node_load15&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load15      labels:        desc: &quot;ç³»ç»Ÿ15åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;auto_discovery_dns&quot;###############################################################################################                                 disk                                                       #    - expr: node_filesystem_size_bytes&#123;job=&quot;auto_discovery_dns&quot; ,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:total      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜æ€»é‡&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr: node_filesystem_avail_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:free      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜å‰©ä½™ç©ºé—´&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr: node_filesystem_size_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125; - node_filesystem_avail_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:used      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜ä½¿ç”¨çš„ç©ºé—´&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr:  (1 - node_filesystem_avail_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜çš„ä½¿ç”¨ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: irate(node_disk_reads_completed_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:read:count:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜è¯»å–é€Ÿç‡&quot;        unit: &quot;æ¬¡/ç§’&quot;        job: &quot;auto_discovery_dns&quot;    - expr: irate(node_disk_writes_completed_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:write:count:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜å†™å…¥é€Ÿç‡&quot;        unit: &quot;æ¬¡/ç§’&quot;        job: &quot;auto_discovery_dns&quot;    - expr: (irate(node_disk_written_bytes_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:read:mb:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„è®¾å¤‡è¯»å–MBé€Ÿç‡&quot;        unit: &quot;MB/s&quot;        job: &quot;auto_discovery_dns&quot;    - expr: (irate(node_disk_read_bytes_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:write:mb:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„è®¾å¤‡å†™å…¥MBé€Ÿç‡&quot;        unit: &quot;MB/s&quot;        job: &quot;auto_discovery_dns&quot;###############################################################################################                                filesystem                                                  #    - expr:   (1 -node_filesystem_files_free&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_files&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filesystem:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„inodeçš„å‰©ä½™å¯ç”¨çš„ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;##############################################################################################                                filefd                                                     #    - expr: node_filefd_allocated&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filefd_allocated:count      labels:        desc: &quot;èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ä¸ªæ•°&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: node_filefd_allocated&#123;job=&quot;auto_discovery_dns&quot;&#125;/node_filefd_maximum&#123;job=&quot;auto_discovery_dns&quot;&#125; * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filefd_allocated:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;##############################################################################################                                network                                                    #    - expr: avg by (environment,instance,device) (irate(node_network_receive_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:bit:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡eth0æ¯ç§’æ¥æ”¶çš„æ¯”ç‰¹æ•°&quot;        unit: &quot;bit/s&quot;        job: &quot;auto_discovery_dns&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:bit:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡eth0æ¯ç§’å‘é€çš„æ¯”ç‰¹æ•°&quot;        unit: &quot;bit/s&quot;        job: &quot;auto_discovery_dns&quot;    - expr: avg by (environment,instance,device) (irate(node_network_receive_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:packet:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡æ¯ç§’æ¥æ”¶çš„æ•°æ®åŒ…ä¸ªæ•°&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;auto_discovery_dns&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:packet:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡å‘é€çš„æ•°æ®åŒ…ä¸ªæ•°&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;auto_discovery_dns&quot;    - expr: avg by (environment,instance,device) (irate(node_network_receive_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:error:rate      labels:        desc: &quot;èŠ‚ç‚¹è®¾å¤‡é©±åŠ¨å™¨æ£€æµ‹åˆ°çš„æ¥æ”¶é”™è¯¯åŒ…çš„æ•°é‡&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;auto_discovery_dns&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:error:rate      labels:        desc: &quot;èŠ‚ç‚¹è®¾å¤‡é©±åŠ¨å™¨æ£€æµ‹åˆ°çš„å‘é€é”™è¯¯åŒ…çš„æ•°é‡&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;auto_discovery_dns&quot;    - expr: node_tcp_connection_states&#123;job=&quot;auto_discovery_dns&quot;, state=&quot;established&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:established:count      labels:        desc: &quot;èŠ‚ç‚¹å½“å‰establishedçš„ä¸ªæ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;auto_discovery_dns&quot;    - expr: node_tcp_connection_states&#123;job=&quot;auto_discovery_dns&quot;, state=&quot;time_wait&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:timewait:count      labels:        desc: &quot;èŠ‚ç‚¹timewaitçš„è¿æ¥æ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;auto_discovery_dns&quot;    - expr: sum by (environment,instance) (node_tcp_connection_states&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:total:count      labels:        desc: &quot;èŠ‚ç‚¹tcpè¿æ¥æ€»æ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;auto_discovery_dns&quot;##############################################################################################                                process                                                    #    - expr: node_processes_state&#123;state=&quot;Z&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:process:zoom:total:count      labels:        desc: &quot;èŠ‚ç‚¹å½“å‰çŠ¶æ€ä¸ºzoomçš„ä¸ªæ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;auto_discovery_dns&quot;##############################################################################################                                other                                                    #    - expr: abs(node_timex_offset_seconds&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:time:offset      labels:        desc: &quot;èŠ‚ç‚¹çš„æ—¶é—´åå·®&quot;        unit: &quot;s&quot;        job: &quot;auto_discovery_dns&quot;##############################################################################################    - expr: count by (instance) ( count by (instance,cpu) (node_cpu_seconds_total&#123; mode='system'&#125;) ) * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:count</code></pre><h5 id="å®¹å™¨ç›‘æ§æŒ‡æ ‡è§„åˆ™">å®¹å™¨ç›‘æ§æŒ‡æ ‡è§„åˆ™</h5><p>/export/docker-data-proms/conf/rules/dockersInfo-record-rules.yml</p><pre><code class="language-yaml">groups:  - name: dockersInfo-record    rules:    - expr: count by (instance, name) (count_over_time(container_last_seen&#123;job=&quot;auto_discovery_dns&quot;, name!=&quot;&quot;, container_label_restartcount!=&quot;&quot;&#125;[15m]))      record: dockersInfo:container:restart      labels:        desc: &quot;15må‘¨æœŸå†…å®¹å™¨å‘ç”Ÿé‡å¯çš„æ¬¡æ•°&quot;        unit: &quot;&quot;        job: &quot;auto_discovery_dns&quot;###############################################################################################                              cpu                                                           #    - expr: rate(container_cpu_usage_seconds_total&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125;[5m])  * 100      record: dockersInfo:container:cpu:total:percent      labels:        desc: &quot;å®¹å™¨çš„cpuæ€»æ¶ˆè€—ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;    - expr: rate(container_fs_io_time_seconds_total&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125;[5m])  * 100      record: dockersInfo:cpu:iowait:percent      labels:        desc: &quot;å®¹å™¨çš„cpu iowaitç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;###############################################################################################                                    memory                                                  #    - expr: container_spec_memory_limit_bytes&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125;      record: dockersInfo:memory:total      labels:        desc: &quot;å®¹å™¨çš„å†…å­˜æ€»é‡&quot;        unit: byte        job: &quot;auto_discovery_dns&quot;    - expr: container_memory_usage_bytes&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125; / container_spec_memory_limit_bytes&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125; * 100      record: dockersInfo:memory:used:percent      labels:        desc: &quot;å®¹å™¨çš„å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;auto_discovery_dns&quot;</code></pre><h4 id="å®šä¹‰ç›‘æ§æŒ‡æ ‡é˜ˆå€¼è§„åˆ™">å®šä¹‰ç›‘æ§æŒ‡æ ‡é˜ˆå€¼è§„åˆ™</h4><h5 id="ä¸»æœºç›‘æ§æŒ‡æ ‡é˜ˆå€¼">ä¸»æœºç›‘æ§æŒ‡æ ‡é˜ˆå€¼</h5><p>/export/docker-data-proms/conf/rules/node-exporter-alert-rules.yml</p><pre><code class="language-bash"># node-exporter-alert-rules.yml# å®šä¹‰å‘Šè­¦è§„åˆ™# é€šè¿‡å‰ä¸€ä¸ª rules æ–‡ä»¶æ‹¿åˆ°å®šä¹‰çš„ record åˆ«åæ¥ç¼–å†™ expr åˆ¤æ–­å¼# è¿™é‡Œå®šä¹‰çš„å‘Šè­¦è§„åˆ™ï¼Œåœ¨è§¦å‘çš„æ—¶å€™ï¼Œéƒ½ä¼šä¼ é€’åˆ° alertmanagerï¼Œæœ€åä»ä¼ é€’çš„ä¿¡æ¯ä¸­æŠ½å–æ‰€éœ€æ•°æ®å‘é€ç»™ç›®æ ‡äººã€‚groups:  - name: node-alert    rules:    - alert: node-down      expr: node_exporter:up == 0      for: 1m      labels:        severity: critical      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; å®•æœºäº†&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-cpu-high      expr:  node_exporter:cpu:total:percent &gt; 80      for: 3m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; cpu ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-cpu-iowait-high      expr:  node_exporter:cpu:iowait:percent &gt;= 12      for: 3m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; cpu iowait ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-load-load1-high      expr:  (node_exporter:load:load1) &gt; (node_exporter:cpu:count) * 1.2      for: 3m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; load1 ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-memory-high      expr:  node_exporter:memory:used:percent &gt; 85      for: 3m      labels:        severity: info      annotations:        summary: &quot;å†…å­˜ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-high      expr:  node_exporter:disk:used:percent &gt; 80      for: 3m      labels:        severity: info      annotations:        summary: &quot;&#123;&#123; $labels.device &#125;&#125;:&#123;&#123; $labels.mountpoint &#125;&#125; ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-read:count-high      expr:  node_exporter:disk:read:count:rate &gt; 3000      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; iops read ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-write-count-high      expr:  node_exporter:disk:write:count:rate &gt; 3000      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; iops write ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-read-mb-high      expr:  node_exporter:disk:read:mb:rate &gt; 60      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; è¯»å–å­—èŠ‚æ•° é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-write-mb-high      expr:  node_exporter:disk:write:mb:rate &gt; 60      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; å†™å…¥å­—èŠ‚æ•° é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-filefd-allocated-percent-high      expr:  node_exporter:filefd_allocated:percent &gt; 80      for: 10m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-netin-error-rate-high      expr:  node_exporter:network:netin:error:rate &gt; 4      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åŒ…è¿›å…¥çš„é”™è¯¯é€Ÿç‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-netin-packet-rate-high      expr:  node_exporter:network:netin:packet:rate &gt; 35000      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åŒ…è¿›å…¥é€Ÿç‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-netout-packet-rate-high      expr:  node_exporter:network:netout:packet:rate &gt; 35000      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åŒ…æµå‡ºé€Ÿç‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-tcp-total-count-high      expr:  node_exporter:network:tcp:total:count &gt; 40000      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; tcpè¿æ¥æ•°é‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-process-zoom-total-count-high      expr:  node_exporter:process:zoom:total:count &gt; 10      for: 10m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åƒµæ­»è¿›ç¨‹æ•°é‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-time-offset-high      expr:  node_exporter:time:offset &gt; 0.03      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; &#123;&#123; $labels.desc &#125;&#125;  &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;</code></pre><h5 id="å®¹å™¨ç›‘æ§æŒ‡æ ‡é˜ˆå€¼">å®¹å™¨ç›‘æ§æŒ‡æ ‡é˜ˆå€¼</h5><p>/export/docker-data-proms/conf/rules/dockersInfo-alert-rules.yml</p><pre><code class="language-yaml">groups:  - name: container-alert    rules:    - alert: container-restart-times-high      expr: dockersInfo:container:restart &gt; 5      for: 1m      labels:        severity: warn      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; 15åˆ†é’Ÿå†…é‡å¯æ¬¡æ•°è¶…è¿‡5æ¬¡&quot;        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: container-cpu-usage-high      expr: dockersInfo:container:cpu:total:percent &gt; 90      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; cpu ä½¿ç”¨ç‡æŒç»­è¶…è¿‡90%.&quot;        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: container-cpu-iowait-high      expr: dockersInfo:cpu:iowait:percent &gt; 10      for: 1m      labels:        severity: warn      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; cpu iowait æŒç»­è¶…è¿‡10%&quot;        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;#    - alert: container-mem-usage-high#      expr: dockersInfo:memory:used:percent &gt; 80#      for: 1m#      labels:#        severity: warn#      annotations:#        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%&quot;#        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;#        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;#        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;#        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;#        type: &quot;aliyun_meta_ecs_info&quot;</code></pre><h4 id="å‘Šè­¦æµç¨‹è§£æ">å‘Šè­¦æµç¨‹è§£æ</h4><p>å…³äºå‘Šè­¦ï¼Œprometheuså­˜åœ¨ä¸‰ä¸ªçŠ¶æ€ï¼š</p><ul><li>inactive æœªè§¦å‘exprå‘Šè­¦è¡¨è¾¾å¼ã€‚</li><li>pending å·²è§¦å‘ expr å‘Šè­¦è¡¨è¾¾å¼ï¼Œä½†è¿˜æœªæ»¡è¶³å‘Šè­¦æŒç»­æ—¶é—´ï¼ˆå³ for è¯­æ³•å…³é”®è¯ï¼‰ã€‚</li><li>firing å·²è§¦å‘æœ€æ–°ä¸€æ¬¡expr å‘Šè­¦è¡¨è¾¾å¼ä¸”æ»¡è¶³å‘Šè­¦æŒç»­æ—¶é—´ã€‚</li></ul><p>ğŸ’¥éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸è®¾ç½®foræˆ–è€…å°†å…¶ç½®ä¸º0ï¼Œåˆ™ä¼šè·³è¿‡å‘Šè­¦æŒç»­æ—¶é—´ï¼Œç›´æ¥å‘Šè­¦ã€‚</p><p>å€Ÿç”¨ç½‘ä¸Šçš„ä¸€ä¸ªä¾‹å­æ¥ä»‹ç»ï¼š</p><pre><code class="language-yaml">groups:-  name: example   rules:   - alert: mysql_uptime      expr: mysql:server_status:uptime &lt; 30      for: 10s      labels:         level: &quot;CRITICAL&quot;      annotations:         detail: æ•°æ®åº“è¿ï¨ˆæ—¶é—´</code></pre><p><img src="/posts/65820315/image-20220217115556807.png" alt="image-20220217115556807"></p><p>æ¯5ç§’é‡‡é›†ä¸€ä¸ªæ•°æ®ç‚¹ï¼›é‡‡é›†ç¬¬ä¸‰ä¸ªç‚¹çš„æ—¶å€™ï¼Œå‘ç° mysql_uptime = 0; è¯´æ˜ mysql å‘ç”Ÿé‡å¯ã€‚</p><p>æ¯10ç§’è®¡ç®—è¡¨è¾¾å¼ server_status:uptime &lt; 30 æ˜¯å¦ä¸ºçœŸï¼›åœ¨ç¬¬ä¸‰ä¸ªé‡‡é›†ç‚¹ä¸ç¬¬å››ä¸ªé‡‡é›†ç‚¹ä¹‹é—´è§¦å‘äº†ä¸€æ¬¡è®¡ç®—ï¼Œè‡´ä½¿è§¦å‘å‘Šè­¦ã€‚</p><p>ç­‰å¾…å‘Šè­¦æŒç»­æ—¶é—´ 10 ç§’ï¼Œå†æ¬¡è®¡ç®—è¡¨è¾¾å¼ server_status:uptime &lt; 30 æ˜¯å¦ä¸ºçœŸã€‚æœ€ç»ˆæ»¡è¶³ã€å·²è§¦å‘æœ€æ–°ä¸€æ¬¡ expr å‘Šè­¦è¡¨è¾¾å¼ä¸”æ»¡è¶³å‘Šè­¦æŒç»­æ—¶é—´ã€‘ï¼Œä»è€Œè§¦å‘å‘Šè­¦å‘é€ç»™Altertmanagerå‘Šè­¦ç®¡ç†å™¨ã€‚</p><h3 id="éƒ¨ç½²">éƒ¨ç½²</h3><h4 id="docker-æ–¹å¼">docker æ–¹å¼</h4><pre><code class="language-bash">docker run -d \--name proms \--network promsnet \--restart always \-p 9090:9090 \--mount 'type=bind,src=/export/docker-data-proms/prometheus.yml,dst=/etc/prometheus/prometheus.yml'  \--mount 'type=bind,src=/export/docker-data-proms/data,dst=/prometheus' \--mount 'type=bind,src=/export/docker-data-proms/conf,dst=/etc/prometheus/conf' \prom/prometheus \--config.file=/etc/prometheus/prometheus.yml \--storage.tsdb.path=/prometheus \--storage.tsdb.retention=15d \--web.enable-admin-api \--web.enable-lifecycle</code></pre><p>âš ï¸</p><p><code>--web.enable-admin-api</code> å¦‚æœä¸å¼€å¯ï¼Œåˆ™æ— æ³•ä½¿ç”¨apiæ¥å£ï¼Œä¹Ÿå°±æ— æ³•è‡ªä¸»çš„åˆ é™¤æ•°æ®.</p><p><code>--web.enable-lifecycle</code>å¦‚æœä¸å¼€å¯ï¼Œåˆ™æ— æ³•é€šè¿‡ <code>curl -XPOST http://ip:9090/-/reload</code> é‡è½½ prometheus</p><h4 id="äºŒè¿›åˆ¶æ–¹å¼">äºŒè¿›åˆ¶æ–¹å¼</h4><pre><code class="language-bash">wget https://github.com/prometheus/prometheus/releases/download/v2.20.0/prometheus-2.20.0.linux-amd64.tar.gzmkdir prometheustar xf prometheus-2.20.0.linux-amd64.tar.gz --strip-components 1 -C prometheusrm -rf prometheus-2.20.0.linux-amd64.tar.gzcd prometheus &amp;&amp; baseDir=`pwd`cp prometheus.yml&#123;,.bak&#125; #---cat &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt;EOF[Unit]Description=prometheus server daemon[Service]Restart=on-failureExecStart=$&#123;baseDir&#125;/prometheus --config.file=$&#123;baseDir&#125;/prometheus.yml[Install]WantedBy=multi-user.targetEOF#---systemctl daemon-reloadsystemctl start prometheus</code></pre><h3 id="æŸ¥çœ‹">æŸ¥çœ‹</h3><p>è¢«ç›‘æ§ç«¯çŠ¶æ€ï¼š<a href="http://xxx:9090/targets">http://xxx:9090/targets</a></p><p>é€šè¿‡ä¸Šè¿°åœ°å€ï¼Œä½ å¯ä»¥çœ‹åˆ°é…ç½®ä¸­ job_name å®šä¹‰çš„è¢«ç›‘æ§ä»»åŠ¡çš„ç«¯ç‚¹çŠ¶æ€</p><p><img src="/posts/65820315/image-20210311110821675.png" alt="image-20210311110821675"></p><h3 id="æ•°æ®åˆ é™¤">æ•°æ®åˆ é™¤</h3><pre><code class="language-bash"># match[] è¡¨ç¤ºåŒ¹é…æ‰€æœ‰key, &#123;&#125;ç²¾ç¡®é€‰ä¸­ç›®æ ‡# å³åˆ é™¤åŒ…å«&#123;instance=&quot;10.3.128.202:15692&quot;&#125;çš„æ‰€æœ‰æ•°æ®curl -X POST -g 'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=&#123;instance=~&quot;10.3.128.202:15692&quot;&#125;'# æ·»åŠ åˆ é™¤æ—¶é—´èŒƒå›´curl -X POST -g 'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?start=2021-05-30T00:00:00Z&amp;end=2021-06-07T23:59:59Z'</code></pre><h2 id="pushgateway-æœªéªŒè¯">pushgateway (æœªéªŒè¯)</h2><blockquote><p>push æ¨¡å¼ä¸‹çš„ç½‘å…³</p><p>å½“å‰æ²¡æœ‰ç°æˆçš„æ¨é€æ¨¡å¼çš„ node-exporter</p></blockquote><pre><code class="language-bash"># dockerdocker run -d --name=pushgateway -p 9091:9091 prom/pushgateway</code></pre><pre><code class="language-bash"># ä¸€ä¸ªæ¨é€æ¨¡å¼çš„é‡‡é›†è„šæœ¬ç¤ºä¾‹# cat tcpestab.sh #!/bin/bash# æ·»åŠ è„šæœ¬åˆ°è®¡åˆ’ä»»åŠ¡ä¸­ï¼Œå®šæ—¶é‡‡é›†# pushgateway ippushgatewayIp=#è·å–ä¸»æœºåï¼Œå¸¸ä¼ è¾“åˆ°Prometheusæ ‡ç­¾ä»¥ä¸»æœºåinstance_name=`hostname -f | cut -d'.' -f1`#åˆ¤æ–­ä¸»æœºåä¸èƒ½æ˜¯localhostä¸ç„¶å‘é€è¿‡çš„æ•°æ®ä¸çŸ¥é“æ˜¯é‚£ä¸ªä¸»æœºçš„ if [ $instance_name == &quot;localhost&quot; ];thenecho &quot;Hostname must not localhost&quot;exit 1fi#è‡ªå®šä¹‰keyï¼Œåœ¨Prometheuså³å¯ä½¿ç”¨keyæŸ¥è¯¢label=&quot;count_estab_connections&quot; #è·å–TCP estab è¿æ¥æ•°count_estab_connections=`netstat -an | grep -i 'established' | wc -l`#å°†æ•°æ®å‘é€åˆ°pushgatewayå›ºå®šæ ¼å¼echo &quot;$label $count_estab_connections&quot;  | curl --data-binary @- http://$pushgatewayIp:9091/metrics/job/pushgateway/instance/$instance_name</code></pre><h1>è¢«ç›‘æ§ç«¯ç»„ä»¶</h1><h2 id="node-exporter-ç‰©ç†èŠ‚ç‚¹ç›‘æ§ç»„ä»¶">node-exporter ç‰©ç†èŠ‚ç‚¹ç›‘æ§ç»„ä»¶</h2><blockquote><p>å®¿ä¸»æ•°æ®é‡‡é›†ç«¯ï¼Œéƒ¨ç½²åœ¨è¢«ç›‘æ§ä¸»æœºçš„9100ç«¯å£</p></blockquote><h3 id="docker-ä¸å¤ªå»ºè®®">docker ä¸å¤ªå»ºè®®</h3><pre><code class="language-bash">docker run -d \  --name=node-exporter \  --restart=always \  --net=&quot;host&quot; \  --pid=&quot;host&quot; \  -v &quot;/:/host:ro,rslave&quot; \  quay.io/prometheus/node-exporter:latest \  --path.rootfs=/host</code></pre><h3 id="yum-æ–¹å¼-æ¨è">yum æ–¹å¼ æ¨è</h3><pre><code class="language-bash"># yumåŒ… https://copr.fedorainfracloud.org/coprs/ibotty/prometheus-exporters/curl -Lo /etc/yum.repos.d/_copr_ibotty-prometheus-exporters.repo https://copr.fedorainfracloud.org/coprs/ibotty/prometheus-exporters/repo/epel-7/ibotty-prometheus-exporters-epel-7.repo &amp;&amp; yum install node_exporter -y</code></pre><h3 id="æºç åŒ…">æºç åŒ…</h3><pre><code class="language-bash">cd /usr/local/wget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gzmkdir node_exportertar xf node_exporter-1.0.1.linux-amd64.tar.gz --strip-components 1 -C node_exportermv node_exporter-1.0.1.linux-amd64.tar.gz srccd node_exporter &amp;&amp; baseDir=`pwd`#---cat &gt; /usr/lib/systemd/system/node_exporter.service &lt;&lt;EOF[Unit]Description=node_exporter server daemon[Service]Restart=on-failureExecStart=$&#123;baseDir&#125;/node_exporter[Install]WantedBy=multi-user.targetEOF</code></pre><h3 id="yumå’Œæºç çš„å¯åŠ¨æ–¹å¼">yumå’Œæºç çš„å¯åŠ¨æ–¹å¼</h3><pre><code class="language-bash">systemctl daemon-reloadsystemctl start node_exportersystemctl status node_exportercurl http://localhost:9100/metrics # æŸ¥çœ‹è·å–çš„ç›‘æ§æ•°æ®systemctl enable node_exporter</code></pre><h2 id="cadvisor-å®¹å™¨ç›‘æ§ç»„ä»¶">cadvisor å®¹å™¨ç›‘æ§ç»„ä»¶</h2><blockquote><p>å®¹å™¨æ•°æ®é‡‡é›†ç«¯ï¼Œéƒ¨ç½²åœ¨è¢«ç›‘æ§å®¹å™¨æ‰€åœ¨å®¿ä¸»çš„10052ç«¯å£</p></blockquote><pre><code class="language-bash">dockerRoot=`docker info | awk -F':'  '/Docker Root Dir/&#123;print $2&#125;'|sed 's@^ *@@g'`echo $dockerRootdocker run \  --restart=always \  --volume=/:/rootfs:ro \  --volume=/var/run:/var/run:rw \  --volume=/sys:/sys:ro \  --volume=$&#123;dockerRoot&#125;/:/var/lib/docker:ro \  --volume=/dev/disk/:/dev/disk:ro \  --publish=10052:8080 \  --privileged=true \  --detach=true \  --name=cadvisor \  google/cadvisor:latest</code></pre><h1>ä½¿ç”¨</h1><h2 id="æ·»åŠ -grafana-æ•°æ®æº-proms">æ·»åŠ  grafana æ•°æ®æº : proms</h2><p><img src="/posts/65820315/image-20201218135400147.png" alt="image-20201218135400147"></p><h2 id="æ·»åŠ -grafana-ç›‘æ§æ¨¡æ¿">æ·»åŠ  grafana ç›‘æ§æ¨¡æ¿</h2><p><img src="/posts/65820315/image-20201218135502105.png" alt="image-20201218135502105"></p><p>nodeæ¨¡æ¿ï¼š<a href="https://grafana.com/grafana/dashboards/8919">https://grafana.com/grafana/dashboards/8919</a></p><p>dockeræ¨¡æ¿ï¼š<a href="https://grafana.com/grafana/dashboards/10566">https://grafana.com/grafana/dashboards/10566</a></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜serverå®‰è£…æ³¨æ„äº‹é¡¹</title>
      <link href="posts/ed865d2f/"/>
      <url>posts/ed865d2f/</url>
      
        <content type="html"><![CDATA[<ol><li><p>æ•°æ®åº“ç¼–ç ä¸€å®šè¦å®‰è£…å®˜æ–¹æ¥å‘½ä»¤æ¥è®¾ç½®ï¼Œä¾‹å¦‚zabbix5ç¼–ç æ˜¯ utf8å’Œutf8_bin</p></li><li><p>æœ€åwebæ§åˆ¶å°å®‰è£…ç•Œé¢ï¼Œè¦ç¡®ä¿zabbix-serverå¯ä»¥è®¿é—®è®¾ç½®çš„ hostname çš„ 10051 ç«¯å£ã€‚å¦‚æœhostnameå†™çš„åŸŸåï¼Œé‚£ä¹ˆè¦ç¡®ä¿zabbix-serverå¯ä»¥é€šè¿‡ hostsæœ¬åœ°è§£ææˆ–è€…å¤–ç½‘è®¿é—®10051ç«¯å£</p></li><li><p>zabbix-server çš„ agent è¦ä½¿ç”¨æ‹‰å–æ¨¡å¼ï¼Œå› ä¸ºå®˜æ–¹ç»™çš„æ¨¡æ¿æ— æ³•ç›´æ¥ä¿®æ­£ä¸ºæ¨æµæ¨¡å¼</p></li><li><p>æŠ¥è­¦åª’ä»‹è®¾ç½®</p><p>è„šæœ¬è®¾ç½®</p><pre><code class="language-bash">è„šæœ¬å‚æ•°&#123;ALERT.SENDTO&#125;&#123;ALERT.SUBJECT&#125;&#123;ALERT.MESSAGE&#125;</code></pre><p>é—®é¢˜æ¨¡æ¿</p><pre><code class="language-bash">æ•…éšœ: &#123;TRIGGER.NAME&#125;ã€[éª·é«…]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ID : &#123;EVENT.ID&#125;ã€UTC+0ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;ã€å‘Šè­¦ç­‰çº§ã€‘: &#123;TRIGGER.SEVERITY&#125;ã€ä¸»æœºä¿¡æ¯1ã€‘: &#123;HOST.NAME&#125;ã€ä¸»æœºä¿¡æ¯2ã€‘: &#123;HOSTNAME1&#125;ã€å‘Šè­¦ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€å‘Šè­¦é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</code></pre><p>æ¢å¤æ¨¡æ¿</p><pre><code class="language-bash">æ¢å¤: &#123;TRIGGER.NAME&#125;ã€[OK]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ID : &#123;EVENT.ID&#125;ã€UTC+0ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;ã€å‘Šè­¦ç­‰çº§ã€‘: &#123;TRIGGER.SEVERITY&#125;ã€ä¸»æœºä¿¡æ¯1ã€‘: &#123;HOST.NAME&#125;ã€ä¸»æœºä¿¡æ¯2ã€‘: &#123;HOSTNAME1&#125;ã€å‘Šè­¦ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€å‘Šè­¦é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</code></pre></li><li><p>é¢„è­¦ç”¨æˆ·æ·»åŠ è¶…ç®¡æƒé™</p></li><li><p>ä¸­æ–‡å­—ä½“</p><pre><code class="language-bash">yum install google-noto-sans-simplified-chinese-fonts.noarch -yrm -rf /etc/alternatives/zabbix-web-fontln -s /usr/share/fonts/google-noto/NotoSansSC-Regular.otf /etc/alternatives/zabbix-web-font</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜ä»å®¹å™¨ä¸­è®¿é—®å®¿ä¸»æœºdockerå‘½ä»¤</title>
      <link href="posts/3e0f2183/"/>
      <url>posts/3e0f2183/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æˆ‘çš„jenkinsæ˜¯è¿è¡Œåœ¨dockerä¸­ï¼Œä½†æ˜¯jenkinså®˜æ–¹çš„é•œåƒé‡Œå´æ²¡æœ‰dockerå‘½ä»¤ã€‚</p><p>ä»¥è‡³äºæ— æ³•åœ¨æµæ°´çº¿ä¸­æ‰“åŒ…dockeré•œåƒã€‚</p><h2 id="æ–¹æ³•">æ–¹æ³•</h2><p>é¦–å…ˆï¼Œéœ€è¦å°†dockerå‘½ä»¤ã€docker.sockæ–‡ä»¶ä»¥åŠç›¸å…³ä¾èµ–æ–‡ä»¶æ˜ å°„åˆ°å®¹å™¨å†…ã€‚</p><p>å…¶æ¬¡ï¼Œä»¥rootç”¨æˆ·è®¿é—®å®¹å™¨ï¼Œåœ¨å®¹å™¨ä¸­æ·»åŠ dockerç»„ï¼Œå¹¶ä¸”ç»„idéœ€è¦å’Œå®¿ä¸»æœºä¸­çš„dockerç»„idä¸€è‡´ã€‚</p><p>æœ€åï¼Œä»¥rootç”¨æˆ·è®¿é—®å®¹å™¨ï¼Œå¹¶å°†jenkinsç”¨æˆ·åŠ å…¥åˆ°å®¹å™¨ä¸­çš„dockerç»„ä¸­ã€‚</p><p>æœ€æœ€åï¼Œæœ€å…³é”®çš„æ¥äº†ï¼Œ ä¸€å®šè¦é‡å¯ä¸€ä¸‹ jenkins å®¹å™¨ã€‚ã€‚ã€‚</p><h2 id="ç›¸å…³å‘½ä»¤">ç›¸å…³å‘½ä»¤</h2><pre><code class="language-bash"># é¢å¤–çš„æ˜ å°„æ–‡ä»¶ï¼ˆå®¿ä¸»æœºæ–‡ä»¶å’Œå®¹å™¨å†…çš„æ˜ å°„è·¯å¾„ï¼Œä»¥å®é™…æƒ…å†µä¸ºå‡†ï¼‰-v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker -v /usr/lib64/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7# ä»¥ root ç”¨æˆ·è®¿é—® jenkins å®¹å™¨ï¼ˆå®¿ä¸»æœºçš„ç»„IDä»¥å®é™…æƒ…å†µä¸ºå‡†ï¼‰docker exec -it -u root jenkins /bin/bashgroupadd -g xxx dockerusermod -aG docker jenkins# é‡å¯ jenkins å®¹å™¨docker stop jenkins &amp;&amp; docker start jenkins</code></pre><h2 id="æ³¨æ„">æ³¨æ„</h2><p>åœ¨å®¹å™¨å†…æ‰§è¡Œçš„ groupadd å’Œ usermod å‘½ä»¤ï¼Œéœ€è¦åœ¨æ¯æ¬¡å˜æ›´å®¹å™¨é•œåƒåï¼Œé‡æ–°æ‰§è¡Œï¼Œå› ä¸ºå‘½ä»¤çš„ç›¸å…³ç»“æœéƒ½æ˜¯å®¹å™¨å†…æ•°æ®ï¼Œæ¸…ç†åä¸ä¼šä¿ç•™ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜ssh-MFAè‡ªåŠ¨ç™»é™†</title>
      <link href="posts/5db0cd07/"/>
      <url>posts/5db0cd07/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ssh å…³è”MFAå,å®‰å…¨åº¦å¢åŠ äº†å¾ˆå¤š,ä½†æ˜¯æ¯æ¬¡æ‰‹åŠ¨è¾“å…¥MFAåŠ¨æ€å£ä»¤æ¯”è¾ƒéº»çƒ¦.æ‰€ä»¥è®°å½•ä¸€ä¸‹è‡ªåŠ¨äº¤äº’è¾“å…¥MFAå£ä»¤</p><h2 id="å‘½ä»¤å®‰è£…">å‘½ä»¤å®‰è£…</h2><pre><code class="language-bash">sudo apt install oathtool gnupg2 expect</code></pre><blockquote><p>oathtool æ˜¯æˆ‘ä»¬ç”¨æ¥ç”ŸæˆMFAå£ä»¤çš„å·¥å…·.</p><p>expect ç”¨æ¥ç¼–å†™äº¤äº’ç¨‹åº</p></blockquote><h2 id="ç™»é™†äº¤äº’è„šæœ¬">ç™»é™†äº¤äº’è„šæœ¬</h2><pre><code class="language-bash">#!/usr/bin/expecttrap &#123; set rows [stty rows] set cols [stty columns] stty rows $rows columns $cols &lt; $spawn_out(slave,name)&#125; WINCHset timeout 5set MFAToken &quot;æˆ‘æ˜¯MFAçš„TOKEN&quot;spawn æˆ‘æ˜¯sshå‘½ä»¤expect &quot;MFA auth&quot;send &quot;[exec oathtool -b --totp $MFAToken]\r&quot;;interact</code></pre><blockquote><p>å°†è„šæœ¬ä¸­çš„TOKENå’Œå‘½ä»¤æ›¿æ¢ä¸ºè‡ªå·±çš„.</p></blockquote><h2 id="æ³¨æ„">æ³¨æ„</h2><p>å¦‚æœä½ å‘ç°ä½ ç™»é™†ä¸äº†, æ¯æ¬¡éƒ½éªŒè¯é”™è¯¯, é‚£ä¹ˆä½ åº”è¯¥æ£€æŸ¥ä¸‹ä½ æœºå™¨çš„æ—¶é—´æ˜¯å¦æ­£å¸¸.</p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> ssh </tag>
            
            <tag> mfa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jdkâ˜å®‰è£…å’Œé…ç½®</title>
      <link href="posts/ac6b3b36/"/>
      <url>posts/ac6b3b36/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>oracle jdk ç°åœ¨æ˜¯å•†ä¸šäº§å“äº†, æ‰€ä»¥çº¿ä¸Šæœ€å¥½è¿˜æ˜¯ç”¨ openjdk.</p><h2 id="æºå®‰è£…">æºå®‰è£…</h2><p><a href="https://adoptopenjdk.net/installation.html#linux-pkg">https://adoptopenjdk.net/installation.html#linux-pkg</a></p><p>rhelä¹‹ç±»çš„ï¼Œæœç´¢ã€RPM installation on Centos, RHEL, or Fedoraã€‘ä½ç½®ï¼Œåœ¨æ·»åŠ äº†repoæºä¹‹åï¼Œå¯ä»¥ç”¨ <code>yum list adoptopenjdk*</code>æ¥æŸ¥çœ‹æºåŒ…å«çš„ç‰ˆæœ¬</p><p>åŒ…å‘½åç¤ºä¾‹ï¼šadoptopenjdk-11-openj9.x86_64ï¼Œè¿™é‡Œ openj9 æŒ‡çš„æ˜¯ jvm ç‰ˆæœ¬ ï¼Œè¿˜æœ‰ hotspot ç‰ˆæœ¬çš„ jvm</p><hr><p>ubuntuä¹‹ç±»çš„ï¼Œæœç´¢ã€Deb installation on Debian or Ubuntuã€‘ä½ç½®ï¼Œåœ¨æ·»åŠ äº†æºä¹‹åï¼Œå¯ä»¥ç”¨<code>apt-show-versions -a adoptopenjdk* </code>æ¥æŸ¥çœ‹æºåŒ…å«çš„ç‰ˆæœ¬</p><p>å¦å¤–å¬è¯´ï¼Œopenj9 å†…å­˜ç®¡ç†æ¯” hotspot ç‰›é€¼å¾ˆå¤šï¼Œèƒ½å‡å°‘ä¸€èˆ¬çš„å†…å­˜å ç”¨ã€‚</p><h2 id="äºŒè¿›åˆ¶å®‰è£…">äºŒè¿›åˆ¶å®‰è£…</h2><p><a href="https://adoptopenjdk.net/installation.html?variant=openjdk11&amp;jvmVariant=hotspot#x64_linux-jdk">https://adoptopenjdk.net/installation.html?variant=openjdk11&amp;jvmVariant=hotspot#x64_linux-jdk</a></p><h2 id="äºŒè¿›åˆ¶é…ç½®">äºŒè¿›åˆ¶é…ç½®</h2><pre><code class="language-bash">tar xzf OpenJDK11U-jdk_x64_linux_hotspot_11.0.10_9.tar.gzexport PATH=$PWD/jdk-11.0.10+9/bin:$PATHjava -version</code></pre><h2 id="å®¹å™¨">å®¹å™¨</h2><p><a href="https://hub.docker.com/_/adoptopenjdk?tab=tags">https://hub.docker.com/_/adoptopenjdk?tab=tags</a></p><h2 id="æœ€å">æœ€å</h2><p>OpenJ9 è¢« IBM æ‹¿å›å»äº†ï¼Œæ‰€ä»¥adoptiumåŸºé‡‘ä¼šæ–°ç«™ç‚¹åˆä¸æä¾›äº†ã€‚ã€‚ã€‚<br><a href="https://adoptium.net/installation.html?variant=openjdk8&amp;jvmVariant=hotspot">https://adoptium.net/installation.html?variant=openjdk8&amp;jvmVariant=hotspot</a></p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> jdk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜fcgiä¸­aliasçš„ä½¿ç”¨</title>
      <link href="posts/58a1c0c7/"/>
      <url>posts/58a1c0c7/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¼—æ‰€å‘¨çŸ¥, nginx åœ¨é…ç½®é™æ€èµ„æºçš„æ—¶å€™, root å’Œ alias åˆ†åˆ«æ˜¯ä¸¤ç§æŒ‡å®šèµ„æºè·¯å¾„çš„æ–¹å¼.</p><p>å¦‚æœï¼š</p><p>â€‹url æ˜¯ <code>http://xxx.com/god/a.jpg</code>ï¼Œä¸” location åŒ¹é…çš„æ˜¯ <code>/god/</code>.</p><p>åˆ™ï¼š</p><p>â€‹å½“ç”¨ root å®šä½èµ„æºè·¯å¾„æ—¶, root é…ç½®çš„å€¼=åŸŸå<code>xxx.com</code> éƒ¨åˆ†æ‰€å¯¹åº”çš„è·¯å¾„, æ­¤æ—¶ a.jpg çš„ç‰©ç†è·¯å¾„å°±æ˜¯  $root/god/a.jpg</p><p>â€‹å½“ç”¨ alias å®šä½èµ„æºè·¯å¾„æ—¶, alias é…ç½®çš„å€¼=url<code>xxx.com/god/</code>éƒ¨åˆ†æ‰€å¯¹åº”çš„è·¯å¾„, æ­¤æ—¶ a.jpg çš„ç‰©ç†è·¯å¾„å°±æ˜¯ ${alias}a.jpg</p><p>å³</p><pre><code class="language-bash">location ^~ /god/ &#123;    root /export/webapps/xxx.com;&#125;# æˆ–è€…location ^~ /god/ &#123;    alias /export/webapps/xxx.com/god/;&#125;</code></pre><p>å½“æˆ‘é‡‡ç”¨ä¸Šè¿°è§„åˆ™, ä½¿ç”¨aliasé…ç½®fcgiçš„æ—¶å€™,ç°å®ç»™äº†æˆ‘æš´å‡»â€¦å¦¥å¦¥çš„404äº†.</p><h2 id="åœ¨fcgiç¯å¢ƒä¸‹-alias-çš„é…ç½®">åœ¨fcgiç¯å¢ƒä¸‹, alias çš„é…ç½®</h2><p>åºŸè¯ä¸å¤šè¯´, ç›´æ¥ä¸Šç»“æœ.</p><pre><code class="language-bash">location ^~ /god/ &#123;     index  index.php index.html index.htm;     root /export/webapps/xxx.com/;     location ~* &quot;\.php$&quot; &#123;         try_files      $uri =404;         fastcgi_pass   127.0.0.1:9000;         fastcgi_index  index.php;         include        fastcgi.conf;         fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;     &#125; &#125; location ^~ /god/ &#123;    index  index.php index.html index.htm;    alias /export/webapps/xxx.com/god/;    location ~* &quot;\.php$&quot; &#123;        try_files      $uri =404;        fastcgi_pass   127.0.0.1:9000;        include        fastcgi.conf;        fastcgi_param  SCRIPT_FILENAME  $request_filename;    &#125;&#125;</code></pre><blockquote><p>å®˜æ–¹çš„ä¾‹å­:</p><p><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#use-request-filename-for-script-filename">https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#use-request-filename-for-script-filename</a></p></blockquote><p>å…³é”®ç‚¹ï¼š</p><ol><li>å½“ä½ ç”¨ alias è€Œä¸æ˜¯ root çš„æ—¶å€™, ä½ éœ€è¦å°†$document_root$fastcgi_script_nameæ›¿æ¢æˆ$request_filename</li><li>å½“ä½ ä¸åœ¨ä½¿ç”¨$fastcgi_script_nameçš„æ—¶å€™ï¼Œä½ éœ€è¦æ˜¾æ€§çš„æ·»åŠ indexï¼Œè€Œä¸æ˜¯fastcgi_index ,å› ä¸º$request_filenameå¹¶ä¸èƒ½å…³è”fastcgi_indexã€‚</li></ol><p>åŸå› åœ¨äº$document_rootçš„å€¼ï¼Œæ¥è‡ªäºrootæˆ–è€…aliasï¼Œ$fastcgi_script_nameæ€»æ˜¯æ‹¿url_path</p><p>å‡è®¾ä½ è®¿é—® /god/api.php,  è€Œè¿™ä¸ªæ–‡ä»¶çš„ç‰©ç†è·¯å¾„æ˜¯/export/webapps/xxx.com/god/api.phpã€‚</p><p>æ­¤æ—¶ï¼Œ</p><p>å½“ä½ ç”¨ alias çš„æ—¶å€™</p><p>$document_root = alias = /export/webapps/xxx.com/god/</p><p>$fastcgi_script_name = /god/api.php</p><p>$document_root$fastcgi_script_name=/export/webapps/xxx.com/god//god/api.php</p><p>è€Œ$request_filenameå½“å‰æ–‡ä»¶çš„è¯·æ±‚è·¯å¾„ï¼Œç”±rootæˆ–è€…alias+uriç›¸å¯¹è·¯å¾„</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> fcgi </tag>
            
            <tag> php </tag>
            
            <tag> alias </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜è§’è‰²</title>
      <link href="posts/720afd15/"/>
      <url>posts/720afd15/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>è§’è‰²çš„ä½œç”¨å°±æ˜¯è§„èŒƒåŒ–ï¼Œå°†ä¸€ä¸ªplaybookå„éƒ¨åˆ†åˆ†é—¨åˆ«ç±»çš„æ”¾ç½®åœ¨è§„å®šå¥½çš„ç›®å½•ä¸­ã€‚å°±å¦‚åŒlinuxç³»ç»Ÿä¸€æ ·ï¼Œ/etc/å°±æ˜¯æ”¾é…ç½®çš„ï¼Œ/bin å°±æ˜¯æ”¾ç¨‹åºçš„ï¼Œ/tmp å°±æ˜¯æ”¾ä¸´æ—¶æ–‡ä»¶çš„ â€¦</p><p>ansible ä¼šåŸºäºå®˜æ–¹è§„å®šå¥½çš„ç›®å½•ç»“æ„, å»è‡ªåŠ¨åŠ è½½ç›®å½•ä¸­çš„æ–‡ä»¶. å½“ä¸€ä¸ªéœ€æ±‚å¾ˆå¤æ‚çš„æ—¶å€™, æˆ‘ä»¬å°±å¯ä»¥åŸºäºè§’è‰²å¯¹éœ€æ±‚è¿›è¡Œåˆ†ç»„.</p><p>æœ€å, å¦‚æœä½ ä¸æŒ‰ç…§è¿™ä¸ªè§„å®šæ¥èµ°, é‚£ä¹ˆansibleè§’è‰²æ¨¡å—å°±æ‰¾ä¸åˆ°ç›¸å…³ä¸œè¥¿.</p><h2 id="è§’è‰²ç»“æ„">è§’è‰²ç»“æ„</h2><p>è¿™æ˜¯ä¸€ä¸ªå®˜æ–¹é¡¹ç›®çš„ä¾‹å­</p><blockquote><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#</a>  å®˜æ–¹æ–‡æ¡£</p></blockquote><pre><code class="language-bash">site.ymlwebservers.ymlfooservers.ymlroles/    common/        tasks/        handlers/        files/        templates/        vars/        defaults/        meta/    webservers/        tasks/        defaults/        meta/</code></pre><p>ä¾‹å­ä¸­ï¼Œcommon å’Œ webservers å°±æ˜¯ä¸¤ä¸ªè§’è‰²<br>å…³äºè§’è‰²çš„ç›®å½•ï¼Œå¿…é¡»åŒ…å«ä¸‹é¢åˆ—ä¸¾å‡ºæ¥çš„ç›®å½•ä¹‹ä¸€ï¼Œç›®å½•å¯ä»¥ä¸ºç©ºã€‚ä½†æ˜¯å¦‚æœä½ ä½¿ç”¨åˆ°äº†æŸä¸ªç›®å½•ï¼Œé‚£ä¹ˆéƒ¨åˆ†ç›®å½•éœ€è¦åŒ…å«main.ymlæ–‡ä»¶ã€‚</p><ul><li>tasks è§’è‰²ç”¨åˆ°çš„ä¸»è¦ä»»åŠ¡åˆ—è¡¨</li><li>handlers è§’è‰²æˆ–è€…è§’è‰²å¤–ç”¨åˆ°çš„ä»»åŠ¡åç»­å¤„ç†</li><li>defaults è§’è‰²é»˜è®¤å˜é‡</li><li>vars è§’è‰²å…¶ä½™å˜é‡ï¼Œä¼˜å…ˆçº§å¤§äº defaults ä¸­å®šä¹‰çš„å˜é‡</li><li>files è§’è‰²éƒ¨ç½²ä¸­ç‰µæ‰¯åˆ°çš„æ–‡ä»¶</li><li>templates è§’è‰²çš„jinja2æ¨¡æ¿</li><li>meta è§’è‰²çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚è§’è‰²çš„å±æ€§(ä½œè€…, è¯´æ˜, ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ç­‰)</li></ul><p>æœ€åï¼Œç›®å½•ä¸­main.ymlç”¨æ¥å­˜å‚¨ä¸»é…ç½®ä¿¡æ¯ã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥åŒ…å«å…¶å®ƒçš„å­ä»»åŠ¡ï¼Œåœ¨å­ä»»åŠ¡ä¸­è¯¦ç»†æè¿°ã€‚<br>ä¾‹å¦‚ï¼Œåœ¨ tasks/main.yml ä¸­ï¼Œé€šè¿‡ import_tasksï¼ŒåŒ…å«å…¶å®ƒå­ä»»åŠ¡ï¼Œå°±åƒä¸‹é¢è¿™æ ·</p><blockquote><p>main åŒ…å« redhat å’Œ debianã€‚å½“ç³»ç»Ÿæ˜¯ redhat æ—¶ï¼Œå®‰è£… httpd åŒ…ï¼Œå½“ç³»ç»Ÿæ˜¯ debian æ—¶ï¼Œå®‰è£… apache2 åŒ…</p></blockquote><pre><code class="language-yaml"># roles/xxx/tasks/main.yml- name: added in 2.4, previously you used 'include'  import_tasks: redhat.yml  when: ansible_facts['os_family']|lower == 'redhat'- import_tasks: debian.yml  when: ansible_facts['os_family']|lower == 'debian'# roles/xxx/tasks/redhat.yml- yum:    name: &quot;httpd&quot;    state: present# roles/xxx/tasks/debian.yml- apt:    name: &quot;apache2&quot;    state: present</code></pre><h2 id="ä½¿ç”¨è§’è‰²">ä½¿ç”¨è§’è‰²</h2><pre><code class="language-yaml">---# file: site.yml- include: webservers.yml- include: fooservers.yml</code></pre><pre><code class="language-yaml">---# file: webservers.yml- hosts: webservers  roles:    - common    - webservers</code></pre><p>åªè¿è¡Œ webservers è§’è‰²ï¼Œå¯ä»¥é€šè¿‡ site.yml æ·»åŠ  limit é™åˆ¶æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨</p><pre><code class="language-bash">ansible-playbook site.yml --limit webserversansible-playbook webservers.yml</code></pre><h2 id="è§’è‰²ä¼˜å…ˆçº§">è§’è‰²ä¼˜å…ˆçº§</h2><p>è§’è‰²ä¸­é’ˆå¯¹ tasks, handlers, vars æœ‰ä¸€ä¸ªä¼˜å…ˆçº§æ¦‚å¿µ. ä¼˜å…ˆçº§å¤§çš„ä¼šè¦†ç›–æ‰ä¼˜å…ˆçº§å°çš„é…ç½®.</p><p>ä¼˜å…ˆçº§ç”±å¤§åˆ°å°å¦‚ä¸‹:</p><p><code>cli å±‚é¢å‚æ•° &gt; role-xxx-dir &gt; playbook-xxx &gt; role-defaults-dir</code></p><p>è¿™é‡Œ cli å±‚é¢å‚æ•°æŒ‡çš„æ˜¯ ansible-playbook -e vara=â€˜aâ€™ test.play è¿™ç§å¤–éƒ¨ä¼ é€’å˜é‡çš„è¡Œä¸º</p><p>è¿™é‡Œ role-xxx-dir æŒ‡çš„æ˜¯ role ç‰¹å®šç›®å½•é‡Œçš„é…ç½®, ä¾‹å¦‚ tasks, handlers, vars</p><p>è¿™é‡Œ playbook-xxx æŒ‡çš„æ˜¯ç›´æ¥å†™å…¥ ploybook ä¸­çš„éƒ¨åˆ†</p><p>è¿™é‡Œ role-defaults-dir æŒ‡çš„æ˜¯è§’è‰²ç›®å½•ä¸­çš„ defaults é»˜è®¤å˜é‡ç›®å½•</p><h2 id="è§’è‰²å¤åˆ¶">è§’è‰²å¤åˆ¶</h2><p>å¦‚æœä½ æƒ³è®©ä¸€ä¸ªè§’è‰²å¤šæ¬¡æ‰§è¡Œï¼Œå°±å¦‚åŒä¸‹é¢è¿™æ ·</p><pre><code class="language-yaml">---- hosts: webservers  roles:    - moo    - moo</code></pre><p>æœ‰ä¸‹åˆ—ä¸¤ç§æ–¹å¼:</p><ol><li>mooï¼Œæ‹¥æœ‰ä¸åŒçš„å‚æ•°</li><li>å°†<code>allow_duplicates: true</code>å†™å…¥ moo/meta/main.yml</li></ol><h2 id="è§’è‰²æ ‡ç­¾">è§’è‰²æ ‡ç­¾</h2><p>æˆ‘ä»¬ä¸€å®šè¦é’ˆå¯¹è§’è‰²ä¸­çš„tasksæ·»åŠ æ ‡ç­¾(tags). åŸå› åœ¨äº, æœ‰äº›æ—¶å€™, å½“æˆ‘ä»¬åªæƒ³ä¿®æ”¹éƒ¨ç½²å¾ˆä¹…çš„ä¸€å †æœºå™¨çš„æŸä¸ªæœåŠ¡æ—¶, æˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œè§’è‰²çš„ playbook çš„æ—¶å€™,è¿½åŠ  --tags å³å¯å¸®åŠ©æˆ‘ä»¬æ‰§è¡Œé¡¹ç›®ä¸­æŸä¸€ä¸ªä»»åŠ¡ï¼Œè€Œä¸å¿…æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡.</p><p>æ¯”å¦‚, æˆ‘ä»¬æœ‰ä¸ªéƒ¨ç½²é¡¹ç›®, å…¶ä¸­æœ‰ä¸€ä¸ªåˆå§‹åŒ–è§’è‰²( common ). common ä¸­æœ‰ä¼—å¤šçš„åˆå§‹åŒ–ä»»åŠ¡, å…¶ä¸­ä¸€ä¸ªä»»åŠ¡æ˜¯ ntp æœåŠ¡çš„ å®‰è£…/é…ç½®/å¯åŠ¨/é‡å¯ .</p><p>ntp æœåŠ¡é…ç½®å¦‚ä¸‹:</p><pre><code class="language-yaml">---# file: roles/common/tasks/main.yml- name: be sure ntp is installed  yum: pkg=ntp state=installed  tags: ntp- name: be sure ntp is configured  template: src=ntp.conf.j2 dest=/etc/ntp.conf  notify:    - restart ntpd  tags: ntp- name: be sure ntpd is running and enabled  service: name=ntpd state=running enabled=yes  tags: ntp  ---# file: roles/common/handlers/main.yml- name: restart ntpd  service: name=ntpd state=restarted</code></pre><p>ç°åœ¨, æˆ‘ä»¬åªæƒ³ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒçš„ ntp æœåŠ¡çš„é…ç½®, é‚£ä¹ˆåªéœ€è¦å°† ntp.conf.j2 æ¨¡æ¿é…ç½®å¥½ä¹‹å, é‡æ–°æ‰§è¡Œè¿™ä¸ªplaybookså³å¯. å°±æƒ³ä¸‹é¢è¿™æ ·:</p><pre><code class="language-bash">ansible-playbook -i production site.yml --tags ntp</code></pre><h2 id="å†™å¥½çš„playbook">å†™å¥½çš„playbook</h2><p><a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/</a></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜æ¨¡æ¿</title>
      <link href="posts/724fda19/"/>
      <url>posts/724fda19/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å½“ä½ ç”¨ansibleè¿›è¡Œå¤šæœºå™¨çš„é…ç½®è°ƒæ•´ï¼Œä¸”è°ƒæ•´çš„ä¸œè¥¿éƒ½ä¸€æ¨¡ä¸€æ ·ï¼Œæ­¤æ—¶ä½ ä¸ä¼šæ‹’ç»æ¨¡æ¿çš„è¯±æƒ‘ã€‚</p><p>ansibleçš„æ¨¡æ¿æ˜¯jinja2ï¼Œæ‰€ä»¥jinja2çš„ç‰¹æ€§ï¼Œåœ¨è¿™é‡Œéƒ½å¯ä»¥ç”¨ã€‚</p><blockquote><p>æ¨¡æ¿ä¸­ï¼Œä¸è¦å‡ºç°ä»»ä½•ä½ è§‰å¾—æ¨¡æ¿ä¼šå¿½ç•¥çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºç©ºæ ¼</p></blockquote><h2 id="æ¨¡å—-template">æ¨¡å— template</h2><p>å‚æ•°ï¼š</p><ul><li>src æ¨¡æ¿æ–‡ä»¶è·¯å¾„</li><li>dest ç›®çš„æ–‡ä»¶è·¯å¾„</li></ul><p>ç‰µæ‰¯åˆ°ç›®çš„è·¯å¾„ï¼Œå¿…ç„¶æœ‰æƒé™å‚æ•°</p><ul><li>owner ç›®çš„å±ä¸»</li><li>group ç›®çš„å±ç»„</li><li>mode ç›®çš„æƒé™</li></ul><p>è¦†ç›–ä¸å¤‡ä»½</p><ul><li>force è¦†ç›–ï¼Œyes / no</li><li>backup å¤‡ä»½ï¼Œ yes / no ï¼Œ è‹¥ä¸º yes ï¼Œåˆ™ç›®çš„é‡åæ–‡ä»¶ä¼šå…ˆæ”¹å</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - template:        src: ~/test.j2        dest: ~/test.info</code></pre><h2 id="æ¨¡æ¿åˆ†éš”ç¬¦">æ¨¡æ¿åˆ†éš”ç¬¦</h2><pre><code class="language-bash">&#123;&#123; &#125;&#125; ä¸€èˆ¬ç”¨æ¥å¡«å……å˜é‡ï¼Œå¯ä»¥æ˜¯è¿‡æ»¤å™¨ï¼Œä¹Ÿå¯ä»¥å¡«å……è¡¨è¾¾å¼ï¼Œä»è€Œè¿”å›ç›¸åº”çš„å€¼ï¼Œä¾‹å¦‚ &#123;&#123; 1==1 &#125;&#125; è¿”å› True&#123;% %&#125; ä¸€èˆ¬ç”¨æ¥å¡«å……æ§åˆ¶è¯­å¥&#123;# #&#125; æ¨¡æ¿æ³¨é‡Šè¯­å¥ï¼Œå¹¶éæ¸²æŸ“åä¼šå‡ºç°#  ... ## è¿™ä¸€ç§ ansible è²Œä¼¼ä¸æ”¯æŒï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥</code></pre><h3 id="åˆ†éš”ç¬¦1">åˆ†éš”ç¬¦1</h3><pre><code class="language-jinja2"># &#123;&#123; &#125;&#125;&#123;# æ™®é€šå˜é‡ #&#125;&#123;&#123; foo.bar &#125;&#125;&#123;&#123; foo['bar'] &#125;&#125;&#123;# ä»¥è¿‡æ»¤å™¨ lookup ä¸ºä¾‹ #&#125;&#123;&#123; lookup('file', '~/test.file') &#125;&#125;&#123;&#123; lookup('env', 'PATH' )&#125;&#125;</code></pre><p>æœ€ç»ˆç›®çš„æ–‡ä»¶ï¼Œä¼šè¾“å‡º<code>~/test.file</code> å†…å®¹å’Œ <code>$PATH</code> å†…å®¹</p><blockquote><p>å­—ç¬¦ä¸²æ‹¼æ¥éœ€è¦ä½¿ç”¨<code>~</code>ï¼Œä¾‹å¦‚ <code>&quot;name:&quot;~name</code></p></blockquote><h3 id="åˆ†éš”ç¬¦2">åˆ†éš”ç¬¦2</h3><pre><code class="language-bash"># &#123;% %&#125;# å®˜ç½‘æ‰€æœ‰çš„æ§åˆ¶åˆ—è¡¨https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures</code></pre><h4 id="æ¡ä»¶æ§åˆ¶è¯­å¥-if">æ¡ä»¶æ§åˆ¶è¯­å¥ if</h4><pre><code class="language-jinja2">&#123;% if æ¡ä»¶1 %&#125;  pass&#123;% elif æ¡ä»¶2 %&#125;  pass&#123;% else %&#125;  pass &#123;% endif %&#125;</code></pre><h4 id="å¾ªç¯è¯­å¥-for">å¾ªç¯è¯­å¥ for</h4><pre><code class="language-jinja2">&#123;% for i in å¯è¿­ä»£å¯¹è±¡ %&#125;  &#123;&#123; i &#125;&#125;&#123;% endfor %&#125;</code></pre><blockquote><p>é»˜è®¤å¾ªç¯åï¼Œæ¯ä¸€ä¸ªå¾ªç¯å•ä½“ç‹¬å ä¸€è¡Œï¼Œå¦‚æœéœ€è¦åˆ é™¤ç‹¬å ï¼Œåˆ™éœ€è¦ç»™ç¬¬äºŒä¸ª%}å’Œç¬¬ä¸‰ä¸ªæ§åˆ¶ç¬¦{%åŠ å‡å·ï¼Œæœ€ç»ˆå˜ä¸º-%}å’Œ{%-ã€‚</p></blockquote><p>å…³äºå­—å…¸ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ iteritems() å‡½æ•°ï¼Œä»è€Œæ–¹ä¾¿çš„è·å–åˆ°å­—å…¸çš„ k å’Œ vã€‚ä¾‹å¦‚</p><pre><code class="language-jinja2">&#123;% for k,v in &#123;'name':'zhangsan', 'gender':'male'&#125;.iteritems() %&#125;  &#123;&#123; k &#125;&#125;:&#123;&#123; v &#125;&#125;&#123;% endfor %&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“åname:zhangsangender:male</code></pre><h4 id="æ¡ä»¶å’Œå¾ªç¯ç»„åˆè¯­å¥">æ¡ä»¶å’Œå¾ªç¯ç»„åˆè¯­å¥</h4><pre><code class="language-jinja2">&#123;% for i in å¯è¿­ä»£å¯¹è±¡ if æ¡ä»¶ %&#125;  æ»¡è¶³æ¡ä»¶è¯­å¥&#123;% else %&#125;  ä¸æ»¡è¶³æ¡ä»¶è¯­å¥&#123;% endfor %&#125;</code></pre><p>ä¾‹å¦‚</p><pre><code class="language-jinja2">&#123;% for i in [1,2,3,4] if i>2 %&#125;&#123;&#123; i &#125;&#125;'s index is &#123;&#123; loop.index &#125;&#125;&#123;% endfor %&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“å3's index is 14's index is 2</code></pre><blockquote><p>loop.index æ˜¯å¾ªç¯ä½“ç´¢å¼•ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸ªç–‘é—®ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œ3å’Œ4çš„ç´¢å¼•åº”è¯¥å°±æ˜¯3å’Œ4ï¼Œä¹‹æ‰€ä»¥æ˜¯1å’Œ2ï¼ŒåŸå› åœ¨äºå½“æ¡ä»¶æ§åˆ¶å’Œå¾ªç¯æ§åˆ¶ä½äºåŒä¸€è¡Œçš„æ—¶å€™ï¼Œå…ˆè¡Œè¿ç®—çš„æ˜¯ <code>[1,2,3,4] if i&gt;2</code>ï¼Œä¹‹åæ‰å¼€å§‹èµ°<code>for</code>å¾ªç¯ã€‚</p><p>å¦‚æœä½ æƒ³è¾“å‡ºåŸå§‹å¾ªç¯ä½“ï¼Œåˆ™éœ€è¦å°†æ¡ä»¶æ§åˆ¶è¯­å¥å¦èµ·ä¸€è¡Œï¼Œæ”¾åœ¨<code>for</code>å¾ªç¯å†…éƒ¨</p></blockquote><pre><code class="language-jinja2">&#123;% for i in [1,2,3,4] %&#125;&#123;% if i>2 %&#125;&#123;&#123; i &#125;&#125;'s index is &#123;&#123; loop.index &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“å3's index is 34's index is 4</code></pre><blockquote><p>ä¸Šè¿°çš„ loop.index åªæ˜¯jinja2çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œå…¶å®ƒæ–¹å¼å…·ä½“å¯è§å®˜ç½‘æ–‡æ¡£</p><p><a href="https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures">https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures</a></p></blockquote><h4 id="å®-macro">å® macro</h4><p>å®å°±æ˜¯ç±»ä¼¼äºå‡½æ•°çš„ä¸€ä¸ªä¸œè¥¿ã€‚</p><pre><code class="language-jinja2">&#123;# ç¼–å†™å® #&#125;&#123;% macro func() %&#125;å‡½æ•°ä½“&#123;% endmacro %&#125;&#123;# è°ƒç”¨å® #&#125;&#123;&#123; func() &#125;&#125;</code></pre><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-jinja2">&#123;% macro func(a,b,c=3,d=4) %&#125;&#123;# å®ç¼–å†™çš„æ—¶å€™ï¼Œå®å‚æ•°ï¼Œè¦éµå¾ªé»˜è®¤å‚æ•°åœ¨å&#123;&#123; a &#125;&#125;&#123;&#123; b &#125;&#125;&#123;&#123; c &#125;&#125;&#123;&#123; d &#125;&#125;&#123;% endmacro %&#125;&#123;&#123; func(1,2,5) &#125;&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“å1254</code></pre><blockquote><p>å½“ç»™å‡ºå‚æ•°è¶…å‡ºäº†å®æ‰€å®šä¹‰çš„å‚æ•°æ—¶ï¼Œæ ¹æ®æƒ…å†µï¼Œå®ä¼šå°†å¤šä½™çš„å‚æ•°å­˜åœ¨å˜é‡ä¸­ï¼Œå³ï¼š</p><p>è¶…å‡ºçš„ä¸ºéå…³é”®å­—å‚æ•°ï¼Œåˆ™å­˜æ”¾åœ¨ä¸€ä¸ªå«<code>varargs</code>çš„å…ƒç»„ä¸­</p><p>è¶…å‡ºçš„ä¸ºå…³é”®å­—å‚æ•°ï¼Œåˆ™å­˜æ”¾åœ¨ä¸€ä¸ªå«<code>kwargs</code>çš„å­—å…¸ä¸­</p></blockquote><h4 id="call-æ–¹æ³•">call æ–¹æ³•</h4><p>å¦‚åŒå½“å‰å‡½æ•°çš„è£…é¥°å™¨ï¼Œå¯ä»¥æ‰©å±•å½“å‰å®çš„åŠŸèƒ½</p><pre><code class="language-jinja2">&#123;# ç¼–å†™å® funcï¼Œå¹¶è°ƒç”¨ caller #&#125;&#123;% macro func(a) %&#125;æˆ‘æœ‰ä¸€ä¸ª&#123;&#123; a &#125;&#125;ã€‚&#123;&#123; caller(a) &#125;&#125;&#123;% endmacro %&#125;&#123;# ç¼–å†™å® func_ext #&#125;&#123;% macro func_ext(a,b) %&#125;ä½†&#123;&#123; b &#125;&#125;æ¯”&#123;&#123; a &#125;&#125;å¥½åƒã€‚&#123;% endmacro %&#125;&#123;# é€šè¿‡ call å…³è” funcï¼ŒåŠ è½½ func_ext #&#125;&#123;% call(a) func('æ±‰å ¡') %&#125;&#123;&#123; func_ext(a,'ä¸‰æ˜æ²»') &#125;&#125;&#123;% endcall %&#125;</code></pre><blockquote><p>calleræ˜¯callçš„å¯¹è±¡ï¼Œå› æ­¤callerä¹Ÿæ˜¯å¯ä»¥ç»™callä¼ å‚</p></blockquote><pre><code class="language-bash"># æ¸²æŸ“åæˆ‘æœ‰ä¸€ä¸ªæ±‰å ¡ã€‚ä½†ä¸‰æ˜æ²»æ¯”æ±‰å ¡å¥½åƒ</code></pre><h2 id="æ‰©å±•">æ‰©å±•</h2><blockquote><p>æ‰©å±•å®˜æ–¹æ–‡æ¡£ï¼Œå¯è§ <a href="https://jinja.palletsprojects.com/en/master/extensions/">https://jinja.palletsprojects.com/en/master/extensions/</a></p></blockquote><p>è¿™é‡Œæˆ‘åªç®€å•çš„è¯´ä¸€ä¸‹å¦‚ä½•å¯åŠ¨ <code>for</code> å¾ªç¯ä¸­çš„ <code>break</code> å’Œ <code>continue</code>ã€‚</p><p><code>ansible</code> ä¸­æ·»åŠ  <code>jinja2</code> æ‰©å±•ï¼Œéœ€è¦ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶ <code>/etc/ansible/ansible.cfg</code>ï¼Œæ‰¾åˆ° <code>jinja2_extensions </code>ï¼Œåœ¨åé¢è¿½åŠ æ‰©å±•é…ç½®å³å¯ï¼Œæ¯ä¸€ä¸ªæ‰©å±•ç”¨é€—å·<code>,</code>åˆ†å‰²ã€‚</p><p><code>break</code>å’Œ<code>continue</code> çš„æ‰©å±•åå«ï¼š<code>jinja2.ext.loopcontrols</code></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-include</title>
      <link href="posts/6ce01f58/"/>
      <url>posts/6ce01f58/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•å…¥é¢å¤–ä»»åŠ¡">å¼•å…¥é¢å¤–ä»»åŠ¡</h2><pre><code class="language-yaml">tasks:  - include: add.yml</code></pre><h2 id="ç»‘å®š-kv-å¯¹ï¼Œä»è€Œæ”¹å˜é¢å¤–ä»»åŠ¡é‡Œçš„å˜é‡">ç»‘å®š kv å¯¹ï¼Œä»è€Œæ”¹å˜é¢å¤–ä»»åŠ¡é‡Œçš„å˜é‡</h2><pre><code class="language-yaml">tasks:  - include: add.yml    var1=hello    var2=world</code></pre><h2 id="ç»‘å®š-tags-æ ‡è®°">ç»‘å®š tags æ ‡è®°</h2><blockquote><p>å¯ä»¥é€šè¿‡tagsæ‰§è¡Œç›¸åº”çš„é¢å¤–ä»»åŠ¡</p></blockquote><pre><code class="language-yaml:">tasks:  - include: add1.yml    tags: add1  - include: add2.yml    tags: add2</code></pre><pre><code class="language-bash">ansible-playbook test.play --tags add1 # ä»…æ‰§è¡Œ add1.yml ä»»åŠ¡</code></pre><h2 id="ç»‘å®š-loop-å¾ªç¯">ç»‘å®š loop å¾ªç¯</h2><pre><code class="language-yaml">tasks:  - include: add.yml    loop:      - [1,2,3]# add.yml- debug:  msg: &quot;loop-item: &#123;&#123; item &#125;&#125; in add.yml &quot;</code></pre><h2 id="ç»‘å®š-when-æ¡ä»¶">ç»‘å®š when æ¡ä»¶</h2><pre><code class="language-yaml">tasks:  - include: add.yml    when: 1 &lt; 2</code></pre><hr><p>ansible åœ¨å½“å‰ç‰ˆæœ¬2.9ä¸­ï¼Œæ¨èä½¿ç”¨ import_tasks å’Œ include_tasks æ¥æ›¿æ¢ includeï¼Œinclude æœªæ¥æœ‰å¯èƒ½ä¸åœ¨æ”¯æŒã€‚ï¼ˆä¸ºå•¥æ€»æ„Ÿè§‰ ansible å„ç§å˜å‘¢ï¼‰</p><p>import_tasks é™æ€ä»»åŠ¡å¯¼å…¥ï¼Œé™æ€ä»»åŠ¡ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸èƒ½ä»ä»»åŠ¡å¤–ä¼ é€’å˜é‡åˆ°ä»»åŠ¡ä¸­ã€‚</p><p>include_tasks åŠ¨æ€ä»»åŠ¡å¯¼å…¥ã€‚æ”¯æŒå¾ªç¯ä¼ é€’å˜é‡</p><p>import_tasks ç»‘å®š when çš„æ—¶å€™ï¼Œä¼šå°† when çš„æ¡ä»¶ä¸€å¯¹ä¸€çš„åº”ç”¨åˆ°ä»»åŠ¡æ–‡ä»¶ä¸­åˆ—å‡ºçš„æ‰€æœ‰ä»»åŠ¡</p><p>include_tasks ç»‘å®š when çš„æ—¶å€™ï¼Œä¼šå°† when çš„æ¡ä»¶ä»…åº”ç”¨åˆ°ä»»åŠ¡æ–‡ä»¶ã€‚å³åªè¦æ¡ä»¶ä¸ºçœŸï¼Œä»»åŠ¡æ–‡ä»¶é‡Œçš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šæ‰§è¡Œã€‚</p><p>å…³äºæ–°ç‰ˆå†™æ³•ï¼Œç»‘å®š tags çš„æ–¹å¼ï¼Œå’Œæ—§ç‰ˆå·®å¼‚æ¯”è¾ƒå¤§ï¼Œä¾‹å¦‚</p><h4 id="include-tasks">include_tasks</h4><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: test      include_tasks:         file: add.yml        apply:          tags:            - add      tags:        - always        # add.yml- debug:    msg: &quot;&#123;&#123; item &#125;&#125; is ok&quot;  loop: [1,2,3]</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> include </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoâ˜æœ¬åœ°æœç´¢</title>
      <link href="posts/f5c218d/"/>
      <url>posts/f5c218d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å®‰è£…å®Œ hexo-generator-search åï¼Œå‘ç°æœç´¢ç»“æœå§‹ç»ˆæ˜¯æ‰€æœ‰æ–‡ç« .</p><p>å¦‚æœä½ ç”¨çš„ä¹Ÿæ˜¯ <a href="https://github.com/Molunerfinn/hexo-theme-melody">Melody</a> ä¸»é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥å‚è€ƒå¦‚ä¸‹ä¿¡æ¯ï¼Œæ¥ç¡®è®¤ã€‚</p><h2 id="æ•ˆæœå›¾">æ•ˆæœå›¾</h2><p><img src="/posts/f5c218d/image-20200518121421437.png" alt="image-20200518121421437"></p><h2 id="è½¯ä»¶åŒ…">è½¯ä»¶åŒ…</h2><blockquote><p>æˆªè‡³ï¼š2020.05.18ï¼Œè½¯ä»¶åŒ…å¦‚ä¸‹</p></blockquote><pre><code class="language-bash">  &quot;dependencies&quot;: &#123;    &quot;gitalk&quot;: &quot;^1.6.2&quot;,    &quot;hexo&quot;: &quot;^4.0.0&quot;,    &quot;hexo-asset-image&quot;: &quot;^1.0.0&quot;,    &quot;hexo-deployer-git&quot;: &quot;^2.1.0&quot;,    &quot;hexo-generator-archive&quot;: &quot;^1.0.0&quot;,    &quot;hexo-generator-category&quot;: &quot;^1.0.0&quot;,    &quot;hexo-generator-index&quot;: &quot;^1.0.0&quot;,    &quot;hexo-generator-search&quot;: &quot;^2.4.0&quot;,    &quot;hexo-generator-tag&quot;: &quot;^1.0.0&quot;,    &quot;hexo-renderer-ejs&quot;: &quot;^1.0.0&quot;,    &quot;hexo-renderer-marked&quot;: &quot;^2.0.0&quot;,    &quot;hexo-renderer-pug&quot;: &quot;^1.0.0&quot;,    &quot;hexo-renderer-stylus&quot;: &quot;^1.1.0&quot;,    &quot;hexo-server&quot;: &quot;^1.0.0&quot;,    &quot;react&quot;: &quot;^15.3.1&quot;,    &quot;react-dom&quot;: &quot;^15.3.1&quot;  &#125;</code></pre><h2 id="config-yml">_config.yml</h2><blockquote><p>è¿½åŠ å†…å®¹å¦‚ä¸‹</p></blockquote><pre><code class="language-yaml">search:  path: search.xml  field: post  content: true</code></pre><h2 id="ä¸»é¢˜é…ç½®">ä¸»é¢˜é…ç½®</h2><blockquote><p>ä¿®æ”¹å†…å®¹</p></blockquote><pre><code class="language-yaml">local_search:  enable: true</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜å®‰è£…</title>
      <link href="posts/6209085/"/>
      <url>posts/6209085/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æ­¤è„šæœ¬ç”¨äºå®‰è£… nginx;tengine;openresty. å®‰è£…ç‰ˆæœ¬ä¸ºï¼š</p><ul><li>nginx: 1.14</li><li>openresty: 1.15.8.3</li><li>tengine: 2.1.2 # è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„ç‰ˆæœ¬â€¦</li></ul><h4 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h4><p>å› ä¸ºæ˜¯ç¼–è¯‘å®‰è£…ï¼Œæ‰€ä»¥äº§å‡ºç›®å½•å‡åœ¨ /usr/local/&lt;nginx/openresty/tengine&gt;ï¼Œé™¤äº† logs åšäº†è½¯é“¾<code> /usr/local/xxx/logs -&gt; /export/logs/nginx</code></p><p><code>/usr/local/xxx/conf ç›®å½•ç»“æ„</code></p><p><img src="/posts/6209085/image-20200515120037239.png" alt="image-20200515120037239"></p><pre><code class="language-bash"># ä¸‹é¢ä¸¤ä¸ªä¸»é…ç½®æ–‡ä»¶ä¼šå‘Šè¯‰ä½ ï¼Œç›¸åº”çš„ä¸Šä¸‹æ–‡é…ç½®ï¼Œåº”è¯¥ä»¥ä»€ä¹ˆç»“å°¾ï¼ï¼ï¼include /usr/local/$&#123;NginxVer&#125;/nginx/conf/server/*.server;include /usr/local/$&#123;NginxVer&#125;/nginx/conf/upstream/*.upstream;</code></pre><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><pre><code class="language-bash">#!/bin/bashbasedir=/usr/local/srccd $basedirrunuser=`whoami`[[ $runuser == 'root' ]] || &#123;     echo &quot;ERROR:æ‰§è¡Œç”¨æˆ·ä¸æ˜¯$runuser&quot; &amp;&amp; exit &#125;[[ -d /export/logs/nginx ]] || &#123;     echo &quot;/export/logs/nginx/ç›®å½•ä¸å­˜åœ¨&quot; &amp;&amp; exit &#125;CpuNum=`cat /proc/cpuinfo | grep processor | wc -l`read -p &quot;è¾“å…¥å®‰è£…çš„Nginxç‰ˆæœ¬:(nginx;tengine;openresty):&quot; NginxVerread -p &quot;è¾“å…¥å¼€å‘æ—¥å¸¸æ“ä½œç”¨æˆ·:&quot; KaifaUserread -p &quot;è¾“å…¥nginx workerç”¨æˆ·:&quot; NginxWorkerUseruseradd -s /sbin/nologin $&#123;NginxWorkerUser&#125;usermod -a -G $&#123;KaifaUser&#125; $&#123;NginxWorkerUser&#125;cd /usr/local/srcrm -rf $&#123;NginxVer&#125; &amp;&amp; mkdir $&#123;NginxVer&#125;cat&gt;&gt;$basedir/test.com.server&lt;&lt;EOFserver &#123;    listen 80;    server_name test.com;    root /export/$&#123;NginxWorkerUser&#125;/test.com;    #charset koi8-r;    access_log logs/nginx-test.com.access.log main;    error_log logs/nginx-test.com.error.log;    # å…³é—­æ—¥å¿—    location = /favicon.ico &#123;        log_not_found off;        access_log off;    &#125;    # å…³é—­æ—¥å¿—    location = /robots.txt &#123;        auth_basic off;        allow all;        log_not_found off;        access_log off;    &#125;    # æ‹’ç»æ¢æµ‹ç½‘ç«™æ ¹ä¸‹çš„éšè—æ–‡ä»¶ Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).    location ~ /\. &#123;        deny all;        access_log off;        log_not_found off;    &#125;    location / &#123;        #######è¿™ä¸ªæ˜¯ä¸€ä¸ªthinkphpæ¡†æ¶çš„ä¼ªé™æ€è§„åˆ™ï¼Œè¯·å¿½ç•¥        if (!-e \$request_filename) &#123;           rewrite ^(.*)\$ /index.php?s=\$1 last;           break;        &#125;        #######        index index.php;    &#125;    #å¼€å¯æµè§ˆå™¨é™æ€æ–‡ä»¶ç¼“å­˜    location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)\$ &#123;         expires 3h;     &#125;     # è‹¥php-fpm,è¯·ä¿ç•™è¿™é‡Œä¿®æ”¹    location ~ \.php &#123;        fastcgi_pass 127.0.0.1ï¼š9000;        fastcgi_index index.php;        include fastcgi.conf;        fastcgi_connect_timeout 10s;        fastcgi_send_timeout 10s;        fastcgi_read_timeout 10s;        fastcgi_buffers 8 256k;                                   fastcgi_buffer_size 256k;        fastcgi_busy_buffers_size 256k;        fastcgi_intercept_errors on;    &#125;    # è‹¥ httpï¼Œè¯·ä¿ç•™è¿™é‡Œä¿®æ”¹    location / &#123;        proxy_pass http://127.0.0.1:8080;        proxy_connect_timeout 300ms;        proxy_send_timeout 300ms;        proxy_read_timeout 300ms;        proxy_max_temp_file_size 1024m;        proxy_set_header   Host         $host;        proxy_set_header   X-Real-IP    $remote_addr;        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;        proxy_buffers 256 4k;        proxy_intercept_errors on;    &#125;&#125;EOFcat&gt;&gt;nginx_status.server&lt;&lt;EOFserver &#123;    listen 80;    server_name 127.0.0.1;   # charset koi8-r;    access_log off;    location /server_status &#123;        stub_status on;        access_log off;        allow 127.0.0.1;        deny all;    &#125;&#125;EOF###################if [[ $NginxVer == 'nginx' ]];then    [[ -d /usr/local/$NginxVer ]] &amp;&amp; echo '/usr/local/$NginxVer å·²å­˜åœ¨' &amp;&amp; exit    yum install readline-devel pcre-devel openssl-devel gcc    wget http://$&#123;NginxVer&#125;.org/download/$&#123;NginxVer&#125;-1.14.0.tar.gz -O $&#123;NginxVer&#125;.tar.gz    tar xf $&#123;NginxVer&#125;.tar.gz --strip-components 1 -C $&#123;NginxVer&#125;    cd $&#123;NginxVer&#125; &amp;&amp; ./configure --prefix=/usr/local/$&#123;NginxVer&#125; --user=$&#123;NginxWorkerUser&#125; --group=$&#123;NginxWorkerUser&#125; --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_v2_module || exit    make    make install    cd /usr/local/$&#123;NginxVer&#125; &amp;&amp; rm -rf logs    ln -s /export/logs/nginx logs    cd /usr/local/$&#123;NginxVer&#125;/conf    mkdir &#123;location,ssl,upstream,server&#125;    mv $basedir/&#123;test.com.server,nginx_status.server&#125; server/    rm -rf nginx.conf    cat &gt;&gt;nginx.conf&lt;&lt;EOFuser $&#123;NginxWorkerUser&#125;;worker_processes auto;worker_rlimit_nofile 65535;events &#123;    use epoll;    worker_connections 65535; &#125;error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;http &#123;    include mime.types;    default_type application/octet-stream;    log_format main '\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; '                      '\$status \$body_bytes_sent &quot;\$http_referer&quot; '                      '&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status';    access_log logs/access.log main;    sendfile on;    keepalive_timeout 65;    gzip on;    gzip_min_length 1k;    gzip_buffers 4 16k;    gzip_comp_level 2;    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;    gzip_vary off;    gzip_disable &quot;MSIE [1-6]\.&quot;;    #è·¨åŸŸè®¿é—®    #add_header Access-Control-Allow-Origin *;     #add_header Access-Control-Allow-Headers X-Requested-With;    #add_header Access-Control-Allow-Methods GET,POST,OPTIONS;    server &#123;        listen 80 backlog=8092;        location / &#123;        deny all;        &#125;        error_page 500 502 503 504 /50x.html;        location = /50x.html &#123;            root html;        &#125;    &#125;    include /usr/local/$&#123;NginxVer&#125;/conf/server/*.server;    include /usr/local/$&#123;NginxVer&#125;/conf/upstream/*.upstream;&#125;EOFelif [[ $NginxVer == 'openresty' ]];then    [[ -d /usr/local/$NginxVer ]] &amp;&amp; echo '/usr/local/$NginxVer å·²å­˜åœ¨' &amp;&amp; exit    yum install readline-devel pcre-devel openssl-devel gcc    wget https://openresty.org/download/openresty-1.15.8.3.tar.gz -O $&#123;NginxVer&#125;.tar.gz    tar xf $&#123;NginxVer&#125;.tar.gz --strip-components 1 -C $&#123;NginxVer&#125;    cd $&#123;NginxVer&#125; &amp;&amp; ./configure --prefix=/usr/local/$&#123;NginxVer&#125; --user=$&#123;NginxWorkerUser&#125; --group=$&#123;NginxWorkerUser&#125; --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_v2_module || exit    make    make install    cd /usr/local/$&#123;NginxVer&#125;/nginx &amp;&amp; rm -rf logs    ln -s /export/logs/nginx logs    cd /usr/local/$&#123;NginxVer&#125;/nginx/conf    mkdir &#123;location,ssl,upstream,server&#125;    mv $basedir/&#123;test.com.server,nginx_status.server&#125; server/    rm -rf nginx.conf    cat &gt;&gt;nginx.conf&lt;&lt;EOFuser $&#123;NginxWorkerUser&#125;;worker_processes auto;worker_rlimit_nofile 65535;events &#123;    use epoll;    worker_connections 65535; &#125;error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;http &#123;    include mime.types;    default_type application/octet-stream;    log_format main '\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; '                      '\$status \$body_bytes_sent &quot;\$http_referer&quot; '                      '&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status';    access_log logs/access.log main;    sendfile on;    keepalive_timeout 65;    gzip on;    gzip_min_length 1k;    gzip_buffers 4 16k;    gzip_comp_level 2;    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;    gzip_vary off;    gzip_disable &quot;MSIE [1-6]\.&quot;;    #è·¨åŸŸè®¿é—®    #add_header Access-Control-Allow-Origin *;     #add_header Access-Control-Allow-Headers X-Requested-With;    #add_header Access-Control-Allow-Methods GET,POST,OPTIONS;    server &#123;        listen 80 backlog=8092;        location / &#123;            return 444;        &#125;        error_page 500 502 503 504 /50x.html;        location = /50x.html &#123;            root html;        &#125;    &#125;    include /usr/local/$&#123;NginxVer&#125;/nginx/conf/server/*.server;    include /usr/local/$&#123;NginxVer&#125;/nginx/conf/upstream/*.upstream;&#125;EOFelif [[ $NginxVer == 'tengine' ]];then    [[ -d /usr/local/$NginxVer ]] &amp;&amp; echo '/usr/local/$NginxVer å·²å­˜åœ¨' &amp;&amp; exit    yum install readline-devel pcre-devel openssl-devel gcc jemalloc-devel    wget http://tengine.taobao.org/download/tengine-2.1.2.tar.gz -O $&#123;NginxVer&#125;.tar.gz    tar xf $&#123;NginxVer&#125;.tar.gz --strip-components 1 -C $&#123;NginxVer&#125;    cd $&#123;NginxVer&#125; &amp;&amp; ./configure --prefix=/usr/local/$&#123;NginxVer&#125; --user=$&#123;NginxWorkerUser&#125; --group=$&#123;NginxWorkerUser&#125; --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-jemalloc || exit    make    make install    cd /usr/local/$&#123;NginxVer&#125; &amp;&amp; rm -rf logs    ln -s /export/logs/nginx logs    cd /usr/local/$&#123;NginxVer&#125;/conf    mkdir &#123;location,ssl,upstream,server&#125;    mv $basedir/&#123;test.com.server,nginx_status.server&#125; server/    rm -rf nginx.conf    cat &gt;&gt;nginx.conf&lt;&lt;EOFuser $&#123;NginxWorkerUser&#125;;worker_processes auto;worker_rlimit_nofile 65535;events &#123;    use epoll;    worker_connections 65535; &#125;error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;http &#123;    include mime.types;    default_type application/octet-stream;    log_format main '\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; '                      '\$status \$body_bytes_sent &quot;\$http_referer&quot; '                      '&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status';    access_log logs/access.log main;    sendfile on;    keepalive_timeout 65;    gzip on;    gzip_min_length 1k;    gzip_buffers 4 16k;    gzip_comp_level 2;    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;    gzip_vary off;    gzip_disable &quot;MSIE [1-6]\.&quot;;    #è·¨åŸŸè®¿é—®    #add_header Access-Control-Allow-Origin *;     #add_header Access-Control-Allow-Headers X-Requested-With;    #add_header Access-Control-Allow-Methods GET,POST,OPTIONS;    server &#123;        listen 80 backlog=8092;        location / &#123;            deny all;        &#125;        error_page 500 502 503 504 /50x.html;        location = /50x.html &#123;            root html;        &#125;    &#125;    include /usr/local/$&#123;NginxVer&#125;/conf/server/*.server;    include /usr/local/$&#123;NginxVer&#125;/conf/upstream/*.upstream;&#125;EOFfi</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoâ˜å›¾ç‰‡æ˜¾ç¤º404é”™è¯¯çš„è§£å†³åŠæ³•</title>
      <link href="posts/662e9d4d/"/>
      <url>posts/662e9d4d/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>å†™ä½œå·¥å…·ï¼štypora</p><p>éƒ¨ç½²ç«¯ï¼šgithub</p><p>éƒ¨ç½²åŒ…ï¼š</p><pre><code># ä½ å¯ä»¥é€šè¿‡hexoçš„æ ¹ç›®å½•ä¸‹çš„package.jsonæ¥ç¡®è®¤ç‰ˆæœ¬&quot;hexo&quot;: &quot;^4.0.0&quot;,&quot;hexo-asset-image&quot;: &quot;^1.0.0&quot;</code></pre><p>ç›®å‰ç½‘ä¸Šå¤§å¤šæ•°çš„åšæ–‡æè¿°çš„åœºæ™¯ï¼Œå‡ä¸æ˜¯å½“å‰åœºæ™¯ï¼ˆæˆªè‡³åˆ°2020.05.14ï¼‰ï¼Œæ‰€ä»¥åšæ–‡é‡Œè™½ç„¶å±•ç¤ºéƒ½æ­£å¸¸ï¼Œä½†æ˜¯æŒ‰ç…§åšæ–‡çš„æ“ä½œå´ä¼šæœ‰è·¯å¾„é—®é¢˜ï¼Œå…·ä½“è¡¨ç°æ˜¯å›¾ç‰‡å‰å¤šäº†ä¸€çº§è·¯å¾„ï¼ˆè·¯å¾„åº”è¯¥æ˜¯1çº§åŸŸåï¼Œ<a href="http://xn--bvs393b.com">æ¯”å¦‚.com</a>ï¼Œ.ioç­‰ï¼Œæ ¹æ®ä½ çš„åŸŸåæ¥å®šï¼‰</p><p>é‚£ä¹ˆï¼Œè¯·æŒ‰ç…§ä¸‹é¢æˆ‘çš„æ­¥éª¤æ¥æ“ä½œï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œé‚£å°±ä¸æ˜¯ä¸Šè¿°æˆ‘æ‰€è¯´çš„æƒ…å†µäº†ã€‚</p><h4 id="æµç¨‹">æµç¨‹</h4><ol><li><p>ä¿®æ”¹ hexo-asset-imageï¼Œä¿®æ”¹å†…å®¹å¦‚å›¾æ‰€ç¤º</p><p><img src="/posts/662e9d4d/image-20200901195338475.png" alt="image-20200901195338475">ä¿®æ”¹typoraçš„å›¾ç‰‡å­˜æ”¾è·¯å¾„ï¼Œä¿®æ”¹å†…å®¹å¦‚å›¾æ‰€ç¤º</p><p><img src="/posts/662e9d4d/image-20200514185631903.png" alt="image-20200514185631903"></p><blockquote><p>è¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯æˆ‘æƒ³æ²¡äººä¼šæ‹’ç»æ–¹ä¾¿çš„æ“ä½œã€‚ typora åœ¨è¿›è¡Œå¦‚ä¸Šæ“ä½œåï¼Œå°±å¯ä»¥åœ¨ä½ å¾€æ–‡ç« é‡Œç²˜è´´å›¾ç‰‡çš„æ—¶å€™ï¼Œè‡ªåŠ¨ç”Ÿæˆä»¥æ–‡ä»¶åå‰ç¼€å‘½åçš„ç›®å½•ï¼ˆæ•ˆæœå°±å¦‚åŒä½ å¼€å¯äº†hexoçš„post_asset_folder: trueå‚æ•°ï¼‰ï¼Œå¹¶å°†å›¾ç‰‡å­˜æ”¾åœ¨æ­¤ç›®å½•ä¸­ã€‚</p></blockquote></li><li><p>å¼€å¯ hexo çš„ _config.yml ä¸­ post_asset_folder: true å‚æ•°é…ç½®</p></li></ol><h4 id="ç»“è®º">ç»“è®º</h4><p>ç»è¿‡ä¸Šè¿°æ“ä½œï¼Œæˆ‘æƒ³ä½ å·²ç»å¯ä»¥åœ¨æœ¬åœ° md æ–‡ä»¶å’Œçº¿ä¸ŠåŒæ—¶çœ‹åˆ°å›¾ç‰‡äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜æ—¥å¿—åˆ‡å‰²</title>
      <link href="posts/9fb0f3a1/"/>
      <url>posts/9fb0f3a1/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æœ¬è„šæœ¬ç”¨äºå°† nginx æ—¥å¿—è¿›è¡Œæ—¶é—´å‘¨æœŸåˆ‡å‰²ï¼Œå¹¶ lzo å‹ç¼©ï¼Œæœ€ç»ˆä¸Šä¼ åˆ° s3ã€‚<br>è„šæœ¬åˆ†ä¸ºä¸‰ä¸ªå‡½æ•°ï¼Œåˆ‡å‰²å‡½æ•°ï¼Œå‹ç¼©ä¸Šä¼ å‡½æ•°ï¼Œåˆ é™¤å‡½æ•°ï¼Œéœ€è¦æ‰§è¡Œå“ªä¸ªï¼Œå°±å¡«å†™ç›¸å¯¹åº”å˜é‡ã€‚<br>è¯¦æƒ…å¯ä»¥çœ‹è„šæœ¬æ³¨é‡Šã€‚</p><blockquote><p>è¯·åŠ¡å¿…æ‰§è¡Œå‰ï¼Œç¡®è®¤å®‰è£…äº† lzop å’Œ jq å‘½ä»¤ ï¼Œä¸”æœºå™¨æ˜¯ aws EC2</p></blockquote><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><pre><code class="language-bash">#!/bin/bash# by zyh# time: 2019-12-13# warning: ä½¿ç”¨ä¹‹å‰ yum install -y lzop jq# crontab (æ‰§è¡Œæ—¶é—´å‘¨æœŸéœ€è¦å’Œåˆ‡å‰²æ—¶é—´å‘¨æœŸä¸€è‡´) é‡è¦!!!!!!!# */10 * * * * root bash /export/shell/nginxlog2s3/start.sh &gt; /export/shell/nginxlog2s3/start.log 2&gt;&amp;1# æ ‡è¯†æ—¥å¿—åå‰ç¼€localtag=`curl -sq http://169.254.169.254/latest/dynamic/instance-identity/document/ | jq -r .&quot;accountId&quot;,.&quot;availabilityZone&quot;,.&quot;privateIp&quot; | sed 'N;N;s@\n@_@g'`# ----------------------------------äººä¸ºå˜é‡å¡«å†™å¼€å§‹åŒºåŸŸ----------------------------------# åˆ‡å‰²æ—¶é—´å‘¨æœŸï¼Œå®šä½åˆ‡å‰²åæ—¥æœŸçš„åˆå§‹å†™å…¥æ—¶é—´ï¼ˆä»…é€‚ç”¨äºè¿ç»­åˆ‡å‰²ï¼Œä¸”ä¸é€‚ç”¨äºç¬¬ä¸€æ¬¡åˆ‡å‰²ï¼‰todaytime=$(date -d &quot;-10 mins&quot; +%Y%m%d)todayhour=$(date -d &quot;-10 mins&quot; +%H)todaytimestr=$(date  -d &quot;-10 mins&quot; +%s)# ä¼ä¸šå¾®ä¿¡æœºå™¨äººwx_api=''# nginx æ—¥å¿—ç›®å½• logs æ‰€åœ¨è·¯å¾„, å¤‡ä»½æ—¥å¿—ç›®å½•æ˜¯ logs/logsbak# ä¾‹å¦‚æ—¥å¿—ç›®å½•æ˜¯ /usr/local/nginx/logsï¼Œåˆ™å¡«å†™ /usr/loca/nginx, åˆ™åˆ‡å‰²åæœ¬åœ°å¤‡ä»½è·¯å¾„æ˜¯ /usr/local/nginx/logs/logsbaknginx_base=# æ—¥å¿—ä½äºS3çš„æ ¹è·¯å¾„ï¼Œä¾‹å¦‚ s3://xxx/logs/xxxdays/nginxS3Base=&quot;&quot;# MvLogList=&quot;a.log b.log c.log&quot;  éœ€è¦åˆ‡å‰²çš„æ—¥å¿—ï¼Œè¿™æ˜¯å¿…é¡»çš„MvLogList=&quot;&quot;# LzopS3LogList=&quot;a.log b.log c.log&quot; éœ€è¦å‹ç¼©å¹¶ä¸Šä¼ S3çš„æ—¥å¿—ï¼Œå¦‚æœä½ éœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤# S3ç›®å½•æ ¼å¼ï¼š$&#123;S3Base&#125;/$&#123;æ—¥å¿—å&#125;/$&#123;todaytime&#125;/$&#123;todayhour&#125;/ LzopS3LogList=&quot;&quot;# DeleteLocalLog=&quot;a.log b.log c.log&quot; éœ€è¦æœ¬åœ°è®¾ç½®ä¿ç•™æ—¶é—´çš„æ—¥å¿—ï¼Œå¦‚æœä½ éœ€è¦æ‰§è¡Œæ­¤æ­¥DeleteLocalLog=&quot;&quot;# æœ¬åœ°ä¿å­˜æ—¶é—´deletetime=$(date -d &quot;72 hours ago&quot; +%s)# ----------------------------------äººä¸ºå˜é‡å¡«å†™ç»“æŸåŒºåŸŸ----------------------------------# æ—¥å¿—åŸå§‹è·¯å¾„nginx_logs=&quot;$&#123;nginx_base&#125;/logs&quot;# æ—¥å¿—ä½äºæœ¬åœ°çš„åˆ‡å‰²åå¤‡ä»½è·¯å¾„backup_logs=&quot;$&#123;nginx_logs&#125;/logsbak&quot;[[ -d $&#123;backup_logs&#125; ]] || mkdir -p $&#123;backup_logs&#125;# nginx pid æ–‡ä»¶è·¯å¾„nginx_pid=&quot;$&#123;nginx_logs&#125;/nginx.pid&quot;[[ -f $&#123;nginx_pid&#125; ]] || &#123;  echo &quot;$&#123;nginx_pid&#125; is not exist!!!!&quot; &amp;&amp; exit&#125;mvlog()&#123;  [[ -z $1 ]] &amp;&amp; continue  NginxLogName=$1  [[ -d $&#123;backup_logs&#125;/$&#123;NginxLogName&#125; ]] || mkdir -p $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;  mv $&#123;nginx_logs&#125;/$&#123;NginxLogName&#125; $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;/$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125; &amp;&amp; echo &quot;MV: $&#123;nginx_logs&#125;/$&#123;NginxLogName&#125; to $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;/$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;&quot;&#125;lzops3log()&#123;  [[ -z $1 ]] &amp;&amp; continue  NginxLogName=$1  S3Path=$2  cd $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;  lzop $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125; &amp;&amp; aws s3 cp $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo $&#123;S3Path&#125;/$&#123;todaytime&#125;/$&#123;todayhour&#125;/ --quiet &amp;&amp; rm -rf $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo &amp;&amp; echo &quot;UPLOAD: $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo to $&#123;S3Path&#125;/$&#123;todaytime&#125;/$&#123;todayhour&#125;/&quot; || curl &quot;$wx_api&quot; -H 'Content-Type: application/json' -d '&#123;&quot;msgtype&quot;: &quot;markdown&quot;,&quot;markdown&quot;: &#123;&quot;content&quot;: &quot;# `'&quot;$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo&quot;'` æ—¥å¿—ä¸Šä¼ å¤±è´¥!!!!!!&quot;&#125;&#125;'&#125;deletelocallog()&#123;  [[ -z $1 ]] &amp;&amp; continue  NginxLogName=$1  cd $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;  for logname in `ls`;do    if [[ $&#123;deletetime&#125; -ge $&#123;logname##*_&#125; ]];then      rm -rf $&#123;logname&#125; &amp;&amp; echo &quot;DELETE: $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;/$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;deletetime&#125;&quot;    fi  done&#125;#MVfor i in $&#123;MvLogList&#125;;do  mvlog $&#123;i&#125;done#nginx log reloadkill -USR1 `cat $&#123;nginx_pid&#125;`#lzop and to s3for i in $&#123;LzopS3LogList&#125;;do  lzops3log $&#123;i&#125; $&#123;S3Base&#125;/$&#123;i&#125;done#Deletefor i in $&#123;DeleteLocalLog&#125;;do  deletelocallog $&#123;i&#125;done</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜å®‰è£…</title>
      <link href="posts/65ab632a/"/>
      <url>posts/65ab632a/</url>
      
        <content type="html"><![CDATA[<h4 id="docker-å®‰è£…">docker å®‰è£…</h4><p><a href="https://registry.hub.docker.com/_/redis">Docker Hub</a></p><pre><code class="language-bash">redisName=redisversionTag=6dataPath=/export/docker-data-redismkdir -p $&#123;dataPath&#125;# redis.conf è¯·å‚è€ƒå®˜æ–¹é»˜è®¤é…ç½®æ–‡æ¡£ï¼Œé»˜è®¤é…ç½®æ–‡æ¡£åœ°å€ï¼š https://redis.io/topics/configwget -P $&#123;dataPath&#125; https://raw.githubusercontent.com/redis/redis/$&#123;versionTag&#125;.0/redis.confdocker run --name $&#123;redisName&#125;_$&#123;versionTag&#125; \--mount &quot;type=bind,src=$&#123;dataPath&#125;,dst=/data&quot; \-p 6379:6379 \--restart always \-d redis:$&#123;versionTag&#125; redis-server /data/redis.conf</code></pre><p>â„¹ï¸é…ç½®æ”¹åŠ¨ï¼š<code>bind 0.0.0.0</code></p><h4 id="ç¼–è¯‘å®‰è£…">ç¼–è¯‘å®‰è£…</h4><pre><code class="language-shell">#!/bin/bash# by zyh# 2018-06-21# DownUrl: redisæºç åŒ…# RedisBaseDirï¼š rediså®‰è£…è·¯å¾„# RedisPort: redisç«¯å£# RedisMaxMemï¼šrediså†…å­˜é™åˆ¶# ZabbixBase: zabbix æ ¹è·¯å¾„# å®‰è£…å®Œæ¯•åï¼Œä¼šè¾“å‡º# 1. redisä¿¡æ¯# 2. zabbixéœ€è¦é¢å¤–æ‰‹åŠ¨æ·»åŠ çš„å‘½ä»¤ï¼Œ å¹¶åœ¨zabbix_server_webé‡Œï¼Œç»™æœºå™¨å…³è”ä¸Š &lt;Template Redis Auto Discovert Active mode&gt; æ¨¡æ¿# 3. monitéœ€è¦é¢å¤–æ‰‹åŠ¨æ·»åŠ çš„é…ç½®BaseDir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`DownUrl=http://download.redis.io/releases/redis-stable.tar.gzRedisMaxMem=1gRedisPort=6379RedisBaseDir=/export/redis_$&#123;RedisPort&#125;ZabbixBase=/etc/zabbixif [[ $&#123;ZabbixBase&#125; == '/usr/local/zabbix' ]];then    ZabbixShell=$&#123;ZabbixBase&#125;/shell    ZabbixEtc=$&#123;ZabbixBase&#125;/etc/zabbix_agentd.conf.d/redis.confelse    ZabbixShell=/etc/zabbix/shell    ZabbixEtc=/etc/zabbix/zabbix_agentd.d/redis.conffiRedisBaseName=$&#123;RedisBaseDir##*/&#125;export TOP_PID=$$trap 'exit 1' TERMexit_script()&#123;    kill -s TERM $TOP_PID&#125;yum install gcc-c++ -y[[ -d $&#123;RedisBaseDir&#125; ]] &amp;&amp; echo &quot;$&#123;RedisBaseDir&#125;å·²å­˜åœ¨&quot; &amp;&amp; exit_scriptss -tnalp | grep redis | awk '&#123;print $4&#125;' | awk -F':' '&#123;print $2&#125;' | while read line;do    [[ $line -eq $&#123;RedisPort&#125; ]] &amp;&amp; echo &quot;$&#123;RedisPort&#125;å·²è¢«å ç”¨&quot; &amp;&amp; exit_scriptdonecd $&#123;BaseDir&#125; &amp;&amp; mkdir rediswget $&#123;DownUrl&#125; -O redis.tar.gztar xf redis.tar.gz --strip-components 1 -C rediscd redismake PREFIX=$&#123;RedisBaseDir&#125; installmkdir $&#123;RedisBaseDir&#125;/&#123;etc,data,logs&#125;cat&gt;$&#123;RedisBaseDir&#125;/etc/redis.conf &lt;&lt;EOFbind 0.0.0.0protected-mode yesport $&#123;RedisPort&#125;tcp-backlog 511timeout 0tcp-keepalive 300daemonize yessupervised nopidfile $&#123;RedisBaseDir&#125;/redis.pidloglevel warninglogfile &quot;$&#123;RedisBaseDir&#125;/logs/redis.log&quot;databases 16always-show-logo yessave 900 1save 300 10save 60 10000stop-writes-on-bgsave-error yesrdbcompression yesrdbchecksum yesdbfilename redis_$&#123;RedisPort&#125;.rdbdir $&#123;RedisBaseDir&#125;/data/slave-serve-stale-data yesslave-read-only yesrepl-diskless-sync norepl-diskless-sync-delay 5repl-disable-tcp-nodelay noslave-priority 100rename-command FLUSHDB GOD_FLUSHDBrename-command FLUSHALL GOD_FLUSHALLrename-command CONFIG GOD_CONFIGrename-command KEYS GOD_KEYSmaxmemory $&#123;RedisMaxMem&#125;maxmemory-policy allkeys-lrulazyfree-lazy-eviction nolazyfree-lazy-expire nolazyfree-lazy-server-del noslave-lazy-flush noappendonly noappendfilename &quot;appendonly.aof&quot;appendfsync everysecno-appendfsync-on-rewrite noauto-aof-rewrite-percentage 100auto-aof-rewrite-min-size 64mbaof-load-truncated yesaof-use-rdb-preamble nolua-time-limit 5000slowlog-log-slower-than 10000slowlog-max-len 128latency-monitor-threshold 0notify-keyspace-events &quot;&quot;hash-max-ziplist-entries 512hash-max-ziplist-value 64list-max-ziplist-size -2list-compress-depth 0set-max-intset-entries 512zset-max-ziplist-entries 128zset-max-ziplist-value 64hll-sparse-max-bytes 3000activerehashing yesclient-output-buffer-limit normal 0 0 0client-output-buffer-limit slave 256mb 64mb 60client-output-buffer-limit pubsub 32mb 8mb 60hz 10aof-rewrite-incremental-fsync yesEOFcat&gt;$&#123;RedisBaseDir&#125;/redis.sh &lt;&lt; EOF#!/bin/bash# Simple Redis init.d script conceived to work on Linux systems# as it does use of the /proc filesystem.BASEDIR=$&#123;RedisBaseDir&#125;REDISPORT=$&#123;RedisPort&#125;EXEC=\$BASEDIR/bin/redis-serverCLIEXEC=\$BASEDIR/bin/redis-cliPIDFILE=\$BASEDIR/redis.pidCONF=&quot;\$BASEDIR/etc/redis.conf&quot;case &quot;\$1&quot; in    start)        [[ -f \$PIDFILE ]] &amp;&amp; kill -0 \`cat \$PIDFILE\` 2&gt;&gt;\$BASEDIR/crash.log &amp;&amp; echo &quot;\$PIDFILE exists, process is already running or crashed&quot; || &#123;                echo &quot;Starting Redis server...&quot;                \$EXEC \$CONF        &#125;        ;;    stop)        if [ ! -f \$PIDFILE ]        then                echo &quot;\$PIDFILE does not exist, process is not running&quot;        else                PID=\$(cat \$PIDFILE)                echo &quot;Stopping ...&quot;                \$CLIEXEC -p \$REDISPORT shutdown                while [ -x /proc/\$&#123;PID&#125; ]                do                    echo &quot;Waiting for Redis to shutdown ...&quot;                    sleep 1                done                echo &quot;Redis stopped&quot;        fi        ;;    *)        echo &quot;Please use start or stop as first argument&quot;        ;;esacEOFchmod u+x $&#123;RedisBaseDir&#125;/redis.sh#ä¿®æ”¹å†…æ ¸å‚æ•°grep -q net.core.somaxconn /etc/sysctl.conf || echo &quot;net.core.somaxconn = 511&quot; &gt;&gt; /etc/sysctl.confgrep -q vm.overcommit_memory /etc/sysctl.conf || &#123;    echo &quot;vm.overcommit_memory = 1&quot; &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -p&#125;grep -q '/sys/kernel/mm/transparent_hugepage/enabled' /etc/rc.local || &#123;    echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled    echo 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' &gt;&gt; /etc/rc.local&#125;#ä¿®æ”¹zabbixç›‘æ§cat&gt;$&#123;ZabbixEtc&#125;&lt;&lt;EOF##redis monitorUserParameter=redis_info[*],$&#123;ZabbixShell&#125;/redis_info.sh \$1 \$2 \$3 \$4UserParameter=ip_port_discovery[*],$&#123;ZabbixShell&#125;/ip_port_discovery.sh \$1EOFmkdir $&#123;ZabbixShell&#125;cat&gt;$&#123;ZabbixShell&#125;/redis_info.sh&lt;&lt;&quot;EOF&quot;#!/bin/bashREDISPATH=&quot;/export/redis/bin/redis-cli&quot;HOST=$1PORT=$2REDIS_INFO=&quot;$REDISPATH -h $HOST -p $PORT info&quot;[[ $# -ne 3 ]] &amp;&amp; [[ $# -ne 4 ]] &amp;&amp; &#123; exit&#125;if [[ $# -eq 3 ]];thencase $3 inexist) result=`$REDISPATH -h $HOST -p $PORT ping 2&gt;/dev/null |grep -c PONG` echo $result;;cluster)        result=`$REDIS_INFO|/bin/grep cluster|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;uptime_in_seconds)        result=`$REDIS_INFO|/bin/grep uptime_in_seconds|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;connected_clients)        result=`$REDIS_INFO|/bin/grep connected_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_longest_output_list)        result=`$REDIS_INFO|/bin/grep client_longest_output_list|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_biggest_input_buf)        result=`$REDIS_INFO|/bin/grep client_biggest_input_buf|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;blocked_clients)        result=`$REDIS_INFO|/bin/grep blocked_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#å†…å­˜maxmemory)        result=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory)        result=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_rss)        result=`$REDIS_INFO|/bin/grep -w used_memory_rss|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk -F'k' '&#123;print $1&#125;'`        echo $result;;used_memory_pct) A=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` B=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` result=`echo $A $B | awk '&#123;printf&quot;%0.2f&quot;,$1/$2&#125;'`        echo $result;;used_memory_peak)        result=`$REDIS_INFO|/bin/grep used_memory_peak|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_lua)        result=`$REDIS_INFO|/bin/grep used_memory_lua|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;mem_fragmentation_ratio)        result=`$REDIS_INFO|/bin/grep mem_fragmentation_ratio|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#rdbrdb_changes_since_last_save)        result=`$REDIS_INFO|/bin/grep rdb_changes_since_last_save|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_bgsave_in_progress)        result=`$REDIS_INFO|/bin/grep rdb_bgsave_in_progress|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_save_time)        result=`$REDIS_INFO|/bin/grep rdb_last_save_time|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_bgsave_status)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_last_bgsave_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;rdb_current_bgsave_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_current_bgsave_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#rdbinfoaof_enabled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_enabled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_scheduled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_scheduled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_last_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_current_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_last_bgrewrite_status)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_bgrewrite_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;#aofinfoaof_current_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_base_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_base_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_rewrite)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_rewrite&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_bio_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_bio_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_delayed_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_delayed_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#statstotal_connections_received)        result=`$REDIS_INFO|/bin/grep -w &quot;total_connections_received&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;total_commands_processed)        result=`$REDIS_INFO|/bin/grep -w &quot;total_commands_processed&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;instantaneous_ops_per_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;instantaneous_ops_per_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;rejected_connections)        result=`$REDIS_INFO|/bin/grep -w &quot;rejected_connections&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;expired_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;expired_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;evicted_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;evicted_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_hits)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_hits&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_misses)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_misses&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_patterns)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_patterns&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;latest_fork_usec)        result=`$REDIS_INFO|/bin/grep -w &quot;latest_fork_usec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;connected_slaves)        result=`$REDIS_INFO|/bin/grep -w &quot;connected_slaves&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;master_link_status)        result=`$REDIS_INFO|/bin/grep -w &quot;master_link_status&quot;|awk -F':' '&#123;print $2&#125;'|/bin/grep -c up`        echo $result;;master_last_io_seconds_ago)        result=`$REDIS_INFO|/bin/grep -w &quot;master_last_io_seconds_ago&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;master_sync_in_progress)        result=`$REDIS_INFO|/bin/grep -w &quot;master_sync_in_progress&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;slave_priority)        result=`$REDIS_INFO|/bin/grep -w &quot;slave_priority&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;#cpuused_cpu_sys)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_sys_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;*) echo &quot;argu error&quot;;;esac#db0:key   elif [[ $# -eq 4 ]];thencase $4 inkeys)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;keys&quot; | awk -F'=|,' '&#123;print $2&#125;'`        echo $result;;expires)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;expires&quot; | awk -F'=|,' '&#123;print $4&#125;'`        echo $result;;avg_ttl)        result=`$REDIS_INFO|/bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;avg_ttl&quot; | awk -F'=|,' '&#123;print $6&#125;'`        echo $result;;*)     echo &quot;argu error&quot; ;;esacfiEOFcat&gt;$&#123;ZabbixShell&#125;/ip_port_discovery.sh&lt;&lt;&quot;EOF&quot;#!/bin/bash#$1æ˜¯è¦å‘ç°çš„è¿›ç¨‹éƒ¨åˆ†è¯æ±‡portarray=(`sudo ss -tnlp|egrep -i &quot;$1&quot;|awk &#123;'print $4'&#125;|awk -F':' '&#123;if ($NF~/^[0-9]*$/) print $NF&#125;'|sort|uniq`)iparray=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`length=$&#123;#portarray[@]&#125;printf &quot;&#123;\n&quot;printf '\t'&quot;\&quot;data\&quot;:[&quot;for ((i=0;i&lt;$length;i++))  do     printf '\n\t\t&#123;'     printf &quot;\&quot;&#123;#IP&#125;\&quot;:\&quot;$&#123;iparray&#125;\&quot;,\&quot;&#123;#TCP_PORT&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;     if [ $i -lt $[$length-1] ];then                printf ','     fi  doneprintf &quot;\n\t]\n&quot;printf &quot;&#125;\n&quot;EOFchmod a+x $&#123;ZabbixShell&#125;/redis_info.shchmod a+x $&#123;ZabbixShell&#125;/ip_port_discovery.shsed -i '2s#/export/redis#'&quot;$&#123;RedisBaseDir&#125;&quot;'#' $&#123;ZabbixShell&#125;/redis_info.shecho '--------------------------------------------------æˆ‘æ˜¯ redis ä¿¡æ¯-----------------------------------------------------------'echo 'redisç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š'echo &quot;æ ¹è·¯å¾„ï¼š$&#123;RedisBaseDir&#125;å¯åŠ¨è„šæœ¬ï¼š$&#123;RedisBaseDir&#125;/redis.sh&quot;echo '--------------------------------------------------æˆ‘æ˜¯ zabbix ç›‘æ§ä¿¡æ¯----------------------------------------------------------'echo 'è¯·å…ˆå®‰è£… zabbix.'echo 'zabbixç›‘æ§å› ä½¿ç”¨äº†sså‘½ä»¤ï¼Œæ•…è€Œéœ€è¦å¼€å¯sudoç›¸å…³ä¿¡æ¯'echo &quot;#zabbixç”¨æˆ·å¯ä»¥ä»¥sudoæ‰§è¡Œsszabbix ALL = NOPASSWD: /usr/sbin/ss#zabbixç”¨æˆ·ä½¿ç”¨sudoæ— éœ€ttyDefaults:zabbix    !requiretty&quot;echo '---------------------------------------------------æˆ‘æ˜¯ monit ç›‘æ§ä¿¡æ¯----------------------------------------------------------'echo 'è¯·å…ˆå®‰è£… monit.'echo 'monité…ç½®æ–‡ä»¶å¦‚ä¸‹:'echo &quot;check process $&#123;RedisBaseName&#125; with pidfile $&#123;RedisBaseDir&#125;/redis.pid  start program = \&quot;$&#123;RedisBaseDir&#125;/redis.sh start\&quot;  stop program = \&quot;$&#123;RedisBaseDir&#125;/redis.sh stop\&quot;if changed pid then alert&quot;</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜logrotateå®‰è£…</title>
      <link href="posts/421d605e/"/>
      <url>posts/421d605e/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>logrotate å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ—¥å¿—åˆ‡å‰²ï¼Œæ­é… cron æœåŠ¡ï¼Œå°±å¯ä»¥è‡ªåŠ¨çš„è¿›è¡Œè½®è½¬</p><h4 id="logrotate-ç‰ˆæœ¬æ›´æ–°">logrotate ç‰ˆæœ¬æ›´æ–°</h4><blockquote><p>ç¡®ä¿ logrotate æ”¯æŒå°æ—¶çº§åˆ«çš„ç®¡ç†ï¼Œæ›¿æ¢/usr/sbin/logrotate,å¹¶é™„åŠ xæƒé™ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶ç‰ˆæœ¬<a href="D:%5Czyh.cool%5Csource_posts%5C%E6%97%A5%E5%BF%97%5C%E5%85%B6%E5%AE%83%5C%E6%97%A5%E5%BF%97%E2%98%9Elogrotate%E5%AE%89%E8%A3%85%5Clogrotate">logrotate</a></p><p>æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥å» github ä¸Šæ‹‰å–https://github.com/logrotate/logrotate</p></blockquote><h4 id="æ·»åŠ -logrotate-é…ç½®">æ·»åŠ  logrotate é…ç½®</h4><pre><code class="language-bash"># æ·»åŠ æ‰€éœ€åˆ‡å‰²çš„æ—¥å¿—é…ç½®cat &gt; /etc/logrotate.d/nginx &lt;&lt; 'EOF'/usr/local/nginx/logs/access.log &#123;  # å®šä¹‰æ—¥å¿—ä½ç½® hourly    # æŒ‰ç…§å°æ—¶åˆ‡å‰² rotate 2  # æœ€å¤šä¿ç•™ä¸¤ä»½åˆ‡å‰²æ—¥å¿— missingok nocompress sharedscripts postrotate  /bin/kill -USR1 `cat /usr/local/nginx/logs/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || true endscript&#125;EOF</code></pre><h4 id="æ·»åŠ -crontab-é…ç½®">æ·»åŠ  crontab é…ç½®</h4><pre><code class="language-bash"># æ·»åŠ logrotateæ‰§è¡Œè„šæœ¬cp /etc/cron.daily/logrotate /etc/cron.hourly/</code></pre><h4 id="é‡è½½-crond-æœåŠ¡">é‡è½½ crond æœåŠ¡</h4><pre><code class="language-bash">systemctl reload crond</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> logrotate </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§â˜ä¼ä¸šå¾®ä¿¡æœºå™¨äºº</title>
      <link href="posts/8c33f887/"/>
      <url>posts/8c33f887/</url>
      
        <content type="html"><![CDATA[<h4 id="shell">shell</h4><pre><code class="language-bash">wechatUrl=wechatData=curl $&#123;wechatUrl&#125; -H 'Content-Type: application/json' -d '&#123;&quot;msgtype&quot;: &quot;markdown&quot;,&quot;markdown&quot;: &#123;&quot;content&quot;: &quot;`'&quot;$wechatData&quot;'`&quot;&#125;&#125;'</code></pre><h4 id="python">python</h4><pre><code class="language-python">import json, requestswechatData=&#123;&quot;msgtype&quot;: &quot;text&quot;,&quot;text&quot;: &#123;&quot;content&quot;: &quot;&quot;&#125;&#125;wechatData['text']['content']='å¹¿å·ä»Šæ—¥å¤©æ°”ï¼š29åº¦ï¼Œå¤§éƒ¨åˆ†å¤šäº‘ï¼Œé™é›¨æ¦‚ç‡ï¼š60%'wechatData['text']['mentioned_list']=[&quot;zyh&quot;]  # all ä»£è¡¨ç¾¤ç»„æ‰€æœ‰äººwechatData=json.dumps(wechatData)wechatUrl=requests.post(url=wechatUrl, headers=&#123;&quot;Content-Type&quot;: &quot;application/json&quot;&#125;, data=wechatData, timeout=5)</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ä¼ä¸šå¾®ä¿¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ å¾®ä¿¡é¢„è­¦</title>
      <link href="posts/f9b08c30/"/>
      <url>posts/f9b08c30/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># conf.ini[wechat]corpid = [app]it = &lt;app_agent_id&gt;:&lt;app_secret&gt;[group]it = usera|userb</code></pre><pre><code class="language-python">#!/usr/bin/env python3&quot;&quot;&quot;@author: zyh@contact: aaa103439@hotmail.com@software: vscode@file: sendchat.py@time: 2020/02/05&quot;&quot;&quot;import sys, os, requests, pathlib, json, configparserimport loggingimport logging.handlersfrom datetime import datetimeclass PySendchat():    def __init__(self, corpid, agentid, secret, touser, content):        self.corpid=corpid        self.agentid=agentid        self.secret=secret        self.touser=touser        self.content=content        LOG_PATHDIR=os.path.dirname(os.path.abspath(__file__))        LOG_FILENAME = '&#123;0&#125;/sendchat.log'.format(LOG_PATHDIR)        self.my_logger = logging.getLogger('SendChat')        self.my_logger.setLevel(logging.INFO)        # Add the log message handler to the logger        handler = logging.handlers.RotatingFileHandler(LOG_FILENAME, maxBytes=102400000, backupCount=5)        # create formatter and add it to the handlers        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')        handler.setFormatter(formatter)        self.my_logger.addHandler(handler)    def gettoken(self):        self.my_logger.info('-----------------------------------------------------------------------------------------')        pwd=os.path.dirname(os.path.abspath(__file__))        tokenfile='&#123;0&#125;/wechat.&#123;1&#125;'.format(pwd,self.agentid)        if pathlib.Path(tokenfile).exists():            tokenfilectime=os.path.getctime(tokenfile)            currenttime=datetime.now().timestamp()            dtime=currenttime-tokenfilectime            self.my_logger.info('&#123;0&#125; lived &#123;1&#125;s.'.format(tokenfile, dtime))            if dtime &gt;= 7200:                try:                    os.remove(tokenfile)                    self.my_logger.info('Token file &#123;0&#125;: delete success'.format(tokenfile))                except Exception as e:                    self.my_logger.error('Token file:&#123;0&#125; delete error.Reason:&#123;1&#125;'.format(tokenfile,e))                    exit        # check token file        try:            tokensize = os.path.getsize(tokenfile)        except Exception as e:            self.my_logger.info('Token file is not exist.Reason:&#123;0&#125;'.format(e))            tokensize = 0        # get token from token file        if tokensize != 0:            with open(tokenfile, 'rb') as fd:                token = fd.read() # get token success                self.my_logger.info('Get token from token file.')            jsonObject = json.loads(token.decode(encoding='utf8'))            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token        # get token from weixin api        else:            try:                self.my_logger.info('New Token Create.')                f = requests.get('https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#123;0&#125;&amp;corpsecret=&#123;1&#125;'.format(self.corpid, self.secret))                token = f.content                self.my_logger.info('Get token from weixin api.')                jsonObject = json.loads(token.decode(encoding='utf8'))                errcode=int(jsonObject.get(&quot;errcode&quot;))                if errcode != 0:                    errmsg=jsonObject.get(&quot;errmsg&quot;)                    self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(errmsg))                    exit()            except Exception as e:                self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(e))                exit()            try:                self.my_logger.info('Write token to &#123;0&#125;.'.format(tokenfile))                with open(tokenfile, 'wb') as fd:                    fd.write(token)            except Exception as e:                self.my_logger.error('Write &#123;0&#125; error!Reason:&#123;1&#125;'.format(tokenfile,e))                exit()            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token    def sendmsg(self):        accessToken = self.gettoken()        self.my_logger.info('Token:&#123;0&#125;'.format(accessToken))        sendMapDirectroy = &#123;&#125;        sendMapDirectroy[&quot;agentid&quot;] = self.agentid        sendMapDirectroy[&quot;touser&quot;] = self.touser        sendMapDirectroy[&quot;msgtype&quot;] = &quot;text&quot;        sendMapDirectroy[&quot;safe&quot;] = &quot;0&quot;        contentDirectory = &#123;&#125;        sendMapDirectroy[&quot;text&quot;] = contentDirectory        contentDirectory[&quot;content&quot;] = self.content        bodyStr = json.dumps(sendMapDirectroy, ensure_ascii=False).encode(encoding=&quot;utf-8&quot;)        try:            f = requests.post(url=&quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % accessToken,                          data=bodyStr, timeout=5)            self.my_logger.info(f.content)        except Exception as e:            self.my_logger.error('Send chat network error!Reason:&#123;0&#125;'.format(e))if __name__ == '__main__':    appname = sys.argv[1]    content = sys.argv[3]    # read conf.ini    conf = configparser.ConfigParser()    conf_path = os.path.dirname(os.path.abspath(__file__))    conf_ini = &quot;&#123;0&#125;/conf.ini&quot;.format(conf_path)    if pathlib.Path(conf_ini).exists():        conf.read(conf_ini)        corpid = conf.get(&quot;wechat&quot;, &quot;corpid&quot;)        appinfo = conf.get(&quot;app&quot;, appname)        agentid = appinfo.split(':')[0]        secret = appinfo.split(':')[1]        groupname = conf.get(&quot;group&quot;, appname)        touser = groupname.split(':')[0]        chatobj = PySendchat(corpid, agentid, secret, touser, content)    else:        print('conf.ini error')        exit()    try:        chatobj.sendmsg()    except:        chatobj.my_logger.error(&quot;Send chat failure!&quot;)</code></pre><p>eg:</p><p>python <a href="http://sendchat.py">sendchat.py</a> it â€˜â€™ &lt;é¢„è­¦å†…å®¹&gt;</p><blockquote><p>åˆ›å»ºå¥½appï¼Œå¹¶å…³è”ç”¨æˆ·åˆ°app</p><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œä¼šå°†é¢„è­¦å†…å®¹é€šè¿‡&lt;app_agent_id&gt; åº”ç”¨å‘é€ç»™ç”¨æˆ·useraå’Œuserb</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ä¼ä¸šå¾®ä¿¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ é‚®ä»¶é¢„è­¦</title>
      <link href="posts/f8f9b4d0/"/>
      <url>posts/f8f9b4d0/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># $1 æ”¶ä»¶äºº# $2 ä¸»é¢˜# $3 å†…å®¹smtpServer=  # smtp æœåŠ¡å™¨åœ°å€ï¼Œä¾‹å¦‚ smtp.gmail.com:xxxsendUserEmail='it@abc.com'sendUserPassword=  # ä¸€èˆ¬å‘ä»¶äººé‚®ç®±å¯†ç éƒ½æ˜¯ä¸“ç”¨å¯†ç ï¼Œå¹¶éwebå¯†ç /usr/local/bin/sendEmail -f $&#123;sendUserEmail&#125; -t $1 -u &quot;$2&quot; -m &quot;$3&quot; -s $&#123;smtpServer&#125; -xu $&#123;sendUserEmail&#125; -xp $&#123;sendUserPassword&#125; -o message-charset=utf-8</code></pre><pre><code class="language-python">#!/usr/bin/python#coding:utf-8# by zyh# python sendmail.py 'æ”¶ä»¶äººé‚®ç®±åœ°å€'  'ä¸»é¢˜' 'é‚®ä»¶å†…å®¹' 'æŠ„é€é‚®ç®±åœ°å€' 'é™„ä»¶ç»å¯¹è·¯å¾„'import smtplibfrom email.header import Headerfrom email.mime.text import MIMETextfrom email.mime.multipart import MIMEMultipartimport sysreload(sys)sys.setdefaultencoding('utf8')mail_host = 'smtpæœåŠ¡å™¨åœ°å€'  # ä¾‹å¦‚ smtp.gmail.com:587mail_user = 'å‘ä»¶äººé‚®ç®±'      # ä¾‹å¦‚ it@gmail.commail_pass = 'å‘ä»¶äººå¯†ç 'def send_mail(*args):    argsNum=len(args[0])    if argsNum == 4:        filename,to_list, subject, content=args[0]    elif argsNum == 5:        filename,to_list, subject, content, cc_list=args[0]    elif argsNum == 6:        filename,to_list, subject, content, cc_list, subfile=args[0]    me = mail_user+&quot;&lt;&quot;+mail_user+&quot;&gt;&quot;    #åˆå§‹åŒ–é‚®ä»¶å¯¹è±¡ msg    msg = MIMEMultipart()    msg['From'] = me    msg['to'] = to_list    emailList=to_list    # ä¸»é¢˜    msg['Subject'] = Header(subject, 'utf-8').encode()    # å†…å®¹    msg.attach(MIMEText(content, 'plain', 'utf-8'))    # æŠ„é€    if 'cc_list' in vars():        msg['Cc'] = cc_list        emailstring = to_list+','+cc_list        emailList=emailstring.split(&quot;,&quot;)    # é™„ä»¶    if 'subfile' in vars():        att1 = MIMEText(open((&quot;%s&quot;%subfile),'rb').read(), 'base64', 'utf8')        att1[&quot;Content-Type&quot;] = 'text/plain'        att1[&quot;Content-Disposition&quot;] = 'attachment; filename='+subfile.split('/')[-1] # è¿™é‡Œçš„filenameå¯ä»¥ä»»æ„å†™ï¼Œå†™ä»€ä¹ˆåå­—ï¼Œé‚®ä»¶ä¸­æ˜¾ç¤ºä»€ä¹ˆåå­—        msg.attach(att1)    # å‘é€    try:        print &quot;start sendmail&quot;        s = smtplib.SMTP(mail_host)        print &quot;connect mail server suesscc&quot;        s.starttls()        s.login(mail_user,mail_pass)        print &quot;login mail server suesscc&quot;        s.sendmail(me,emailList,msg.as_string())        s.close()        return True    except Exception,e:        print &quot;%s\t%s&quot;%(to_list,str(e))        return Falseif __name__ == &quot;__main__&quot;:    if len(sys.argv) &lt; 4:        exit()    send_mail(sys.argv)</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> é‚®ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ è¿œç¨‹ç£ç›˜æ£€æµ‹</title>
      <link href="posts/1fac36d/"/>
      <url>posts/1fac36d/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash">#!/bin/bash # æ–‡ä»¶åï¼šdisklog.sh # ç”¨é€”ï¼šç›‘è§†è¿œç¨‹ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ BaseDir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`cd $BaseDirlogfile=&quot;disk.log&quot; if [[ -n $1 ]];then     logfile=$1 fishellexecuser=`whoami`if [[ $shellexecuser == root ]];then    rm -rf /root/.ssh/known_hostselse    rm -rf /home/$shellexecuser/.ssh/known_hostsfiprintf &quot;%-8s %-14s %-9s %-8s %-6s %-6s %-6s %s\r\n&quot; &quot;Date&quot; &quot;IP ADDRESS&quot; &quot;Device&quot; &quot;Capacity&quot; &quot;Used&quot; &quot;Free&quot; &quot;Percent&quot; &quot;Status&quot; &gt; $logfile ##################### æ‰‹åŠ¨å¡«å†™åŒº# æä¾›è¿œç¨‹ä¸»æœºIPåœ°å€åˆ—è¡¨ 1.1.1.1 2.2.2.2 3.3.3.3IP_LIST=# ç›‘æ§é˜ˆå€¼(ç™¾åˆ†æ¯”) åªå¡«å†™æ•°å­— 1 åˆ° 100DiskPct=# æ‰§è¡Œç”¨æˆ·UserName=''# æ‰§è¡Œç”¨æˆ·æ‰€éœ€ç§é’¥, æ­¤æ–‡ä»¶éœ€è¦ä¸è„šæœ¬åŒçº§ç›®å½•PemName=''# ä¼ä¸šå¾®ä¿¡botæœºå™¨äººåœ°å€wx_api=''##################### æ‰‹åŠ¨å¡«å†™åŒºfor ip in $IP_LIST;do     ssh -i $PemName -o StrictHostKeyChecking=no $&#123;UserName&#125;@$ip 'df -H' | grep ^/dev/ &gt; /tmp/$$.df     while read line;do         cur_date=`date  &quot;+%F_%R&quot;`        printf &quot;%-8s %-14s &quot; $cur_date $ip         echo $line | awk '&#123; printf(&quot;%-9s %-8s %-6s %-6s %-8s&quot;, $1,$2,$3,$4,$5); &#125;'         pusg=$(echo $line | egrep -o &quot;[0-9]+%&quot;)         pusg=$&#123;pusg/\%/&#125;;         if [ $pusg -lt $DiskPct ];then             echo OK        else             echo ALERT         fi     done &lt; /tmp/$$.df     rm -rf /tmp/$$.dfdone &gt;&gt; $&#123;logfile&#125;sed -n '1p' $&#123;logfile&#125; &gt; alert.logawk '$NF == &quot;ALERT&quot;&#123;print $0&#125;' $&#123;logfile&#125; &gt;&gt; alert.log#sed -i '1i &quot;ç£ç›˜é˜ˆå€¼ï¼š'&quot;$DiskPct&quot;'&quot;' alert.logcontent=`cat alert.log`grep -q 'ALERT' alert.log &amp;&amp; &#123;curl &quot;$wx_api&quot;  -H 'Content-Type: application/json'  \-d '   &#123;        &quot;msgtype&quot;: &quot;text&quot;,        &quot;text&quot;: &#123;            &quot;content&quot;: &quot;'&quot;$content&quot;'&quot;        &#125;   &#125;'&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ç£ç›˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜webç›‘æ§</title>
      <link href="posts/3d20f83e/"/>
      <url>posts/3d20f83e/</url>
      
        <content type="html"><![CDATA[<h2 id="1-æ„å»º-zabbix-agentd-ç«¯é…ç½®">1. æ„å»º zabbix_agentd ç«¯é…ç½®</h2><p>é€‰æ‹©ä¸€ä¸ªä¸»æœºç”¨äºå‘èµ·ç›‘æ§</p><pre><code class="language-bash"># ç›®å½•ç»“æ„[root@ip-10-230-10-105 zabbix]# pwd/etc/zabbix[root@ip-10-230-10-105 zabbix]# tree &#123;etc,shell&#125;etcâ”œâ”€â”€ zabbix_agentd.confâ”œâ”€â”€ zabbix_agentd.conf.bakâ””â”€â”€ zabbix_agentd.conf.d    â””â”€â”€ http_status.conf # æˆ‘æ˜¯ zabbix_agentd æ•°æ®é¡¹é…ç½®shellâ””â”€â”€ web    â”œâ”€â”€ http_status.py # æˆ‘æ˜¯è‡ªåŠ¨å‘ç°è„šæœ¬ + æ•°æ®é‡‡é›†è„šæœ¬    â””â”€â”€ WEB.txt  # æˆ‘æ˜¯è‡ªåŠ¨å‘ç°çš„æ•°æ®æº2 directories, 5 files</code></pre><pre><code class="language-bash"># zabbix_agentd é…ç½® http_status.confUserParameter=web.site.code[*],/usr/bin/python /etc/zabbix/shell/web/http_status.py web_site_code $1UserParameter=web.site.discovery,/usr/bin/python /etc/zabbix/shell/web/http_status.py web_site_discovery</code></pre><pre><code class="language-bash"># è‡ªåŠ¨å‘ç°è§„åˆ™é…ç½®æ–‡ä»¶ WEB.txt# ä¸€è¡Œä¸€ä¸ªç›‘æ§åœ°å€# get åŸæ ·å†™å…¥# post æ¨¡ä»¿getå¤šåŠ ä¸€ä¸ª?https://abc.com??&lt;post_kv&gt;https://abc.com?&lt;get_kv&gt;https://abc.com</code></pre><pre><code class="language-python">#!/usr/bin/env python#encoding=utf-8# python2.7# è‡ªåŠ¨å‘ç°è„šæœ¬ + æ•°æ®é‡‡é›†è„šæœ¬ http_status.py# è¯·å°†æˆ‘æ·»åŠ  o+x æƒé™# ConfigParser æ¨¡å—æ˜¯éœ€è¦å®‰è£…çš„import urllib2, sys, json, ConfigParser, os a1 = sys.argv[1]def web_site_code(args):    response = None    WEB_TXT = &quot;%s/WEB.txt&quot; % (os.path.dirname(os.path.realpath(__file__)))    with open(WEB_TXT, 'ro') as f:        for line in f.readlines():            line = line.strip()            if args in line:                if &quot;??&quot; in line:                    line = line.split(&quot;??&quot;)                elif &quot;?&quot; in line:                    line = line.split(&quot;?&quot;)                else:                    pass                try:                    try:                        response = urllib2.urlopen(line[0], data=line[1], timeout=5)                        print response.code                    except IndexError:                        response = urllib2.urlopen(line[0], timeout=5)                        print response.code                    finally:                        response = urllib2.urlopen(line, timeout=5)                        print response.code                except urllib2.URLError,e:                    if hasattr(e, 'code'):                        print e.code                    elif hasattr(e, 'reason'):                        print 500                    else:                        print 500                finally:                    if response:                        response.close()                    exit()def web_site_discovery():    Dict = &#123;&quot;data&quot;:[]&#125;    WEB_TXT = &quot;%s/WEB.txt&quot; % (os.path.dirname(os.path.realpath(__file__)))    for line in open(WEB_TXT):        if &quot;??&quot; in line:            line = line.strip('\n').split(&quot;??&quot;)            line = &#123;&quot;&#123;#SITENAME&#125;&quot;:line[0]&#125;        elif &quot;?&quot; in line:            line = line.strip('\n').split(&quot;?&quot;)            line = &#123;&quot;&#123;#SITENAME&#125;&quot;:line[0]&#125;        else:            line = line.strip('\n')            line = &#123;&quot;&#123;#SITENAME&#125;&quot;:line&#125;        Dict[&quot;data&quot;].append(line)    print json.dumps(Dict, indent=2)if a1 == 'web_site_code':    url = sys.argv[2]    web_site_code(url)elif a1 == 'web_site_discovery':    web_site_discovery()</code></pre><blockquote><p>{ #SITENAME} è‡ªåŠ¨å‘ç°è„šæœ¬è¾“å‡ºçš„é‡è¦å˜é‡ servername åœ°å€ï¼Œå°†ä¼šç”¨äº web æ§åˆ¶å°é…ç½®</p></blockquote><h2 id="2-æ„å»º-web-æ§åˆ¶å°é…ç½®">2. æ„å»º web æ§åˆ¶å°é…ç½®</h2><ul><li><p>é€‰æ‹©ä½ é…ç½®å¥½çš„zabbix_agentdç«¯çš„ä¸»æœºæ‰€åœ¨çš„ web æ§åˆ¶å°é…ç½®é¡¹ï¼Œæ·»åŠ ä¸€ä¸ªè‡ªåŠ¨å‘ç°è§„åˆ™</p><p><img src="/posts/3d20f83e/image-20210524165435984.png" alt="image-20210524165435984"></p></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºç›‘æ§é¡¹åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20210524165539770.png" alt="image-20210524165539770"></p><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºè§¦å‘å™¨åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20210524165609439.png" alt="image-20210524165609439"></p><blockquote><p>100ç§’ä»¥å†…ï¼ŒçŠ¶æ€ä¸º200çš„æ¬¡æ•°å°‘äº3æ¬¡å‘Šè­¦</p></blockquote></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºå›¾å½¢åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20210524165635429.png" alt="image-20210524165635429"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜agentå’Œproxyï¼ˆyumï¼‰</title>
      <link href="posts/1587f6e8/"/>
      <url>posts/1587f6e8/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://repo.zabbix.com/zabbix/">https://repo.zabbix.com/zabbix/</a></p></blockquote><h2 id="å¯¼å…¥-zabbix-æº">å¯¼å…¥ zabbix æº</h2><pre><code class="language-bashï¼š">rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</code></pre><h2 id="agent-å®‰è£…">agent å®‰è£…</h2><pre><code class="language-shell">yum install zabbix-agent -ysystemctl enable zabbix-agent</code></pre><h2 id="agentä¸»åŠ¨æ¨¡å¼é…ç½®æ–‡ä»¶">agentä¸»åŠ¨æ¨¡å¼é…ç½®æ–‡ä»¶</h2><h3 id="å˜é‡">å˜é‡</h3><pre><code class="language-bash"># ä¸»æœºåå‰ç¼€name_prefix=# è‡ªåŠ¨å‘ç°ç”¨çš„å…ƒæ•°æ®host_meta_data=''# serveræˆ–è€…proxyåœ°å€server_proxy_addr=# æœ¬æœºip## è‹¥æ˜¯ awsï¼š local_ip=`curl -sq http://169.254.169.254/latest/meta-data/local-ipv4`local_ip=</code></pre><pre><code>mv /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak;cat &gt; /etc/zabbix/zabbix_agentd.conf.xxx &lt;&lt; EOFHostname=$&#123;name_prefix&#125;_$&#123;local_ip&#125;StartAgents=0ServerActive=$&#123;server_proxy_addr&#125;PidFile=/var/run/zabbix/zabbix_agentd.pidLogFile=/var/log/zabbix/zabbix_agentd.log#DebugLevel=4Include=/etc/zabbix/zabbix_agentd.d/*.conf#è¢«ç›‘æ§ç«¯åˆ°æœåŠ¡å™¨è·å–ç›‘æ§é¡¹çš„å‘¨æœŸRefreshActiveChecks=60#è¢«ç›‘æ§ç«¯å­˜å‚¨ç›‘æ§ä¿¡æ¯çš„ç©ºé—´å¤§å°BufferSize=1000MaxLinesPerSecond=200#è¶…æ—¶æ—¶é—´Timeout=10#è‡ªåŠ¨å‘ç°ç”¨çš„å…ƒä¿¡æ¯HostMetadata=$&#123;host_meta_data&#125;EOFvi  /etc/zabbix/zabbix_agentd.confsystemctl start zabbix-agent</code></pre><blockquote><p>å¦‚æœæ— æ³•è¢« zabbix_server å‘ç°ï¼Œåˆ™å¯èƒ½æ˜¯ä¸Šè¿°ç”Ÿæˆçš„é…ç½®æœ‰ç‰¹æ®Šå­—ç¬¦ã€‚</p></blockquote><h2 id="proxy-å®‰è£…å‘½ä»¤">proxy å®‰è£…å‘½ä»¤</h2><pre><code class="language-bash:">yum install zabbix-proxy-mysql -y# è§£å‹æ•°æ®åº“æ–‡ä»¶, å¹¶è‡ªè¡Œå¯¼å…¥zcat /usr/share/doc/zabbix-proxy-mysql-*/schema.sql.gz &gt; schema.sql</code></pre><h2 id="proxy-é…ç½®">proxy é…ç½®</h2><pre><code class="language-bash">mv /etc/zabbix/zabbix_proxy.conf /etc/zabbix/zabbix_proxy.conf.bak;cat &gt; /etc/zabbix/zabbix_proxy.conf  &lt;&lt; 'EOF'Server=ServerPort=10051Hostname=LogFile=/var/log/zabbix/zabbix_proxy.logPidFile=/var/run/zabbix/zabbix_proxy.pidDBHost=DBPort=DBName=DBUser=DBPassword=Timeout=4LogSlowQueries=3000ConfigFrequency=60DataSenderFrequency=60StartDiscoverers=5CacheSize=128MStartDBSyncers=20HistoryCacheSize=256MHistoryIndexCacheSize=32MEOFvi /etc/zabbix/zabbix_proxy.conf</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix â˜ nginx</title>
      <link href="posts/b35b5965/"/>
      <url>posts/b35b5965/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç¡®ä¿ç›¸å…³ç›®å½•åœ°å€å¦‚ä¸‹ï¼š</p><p>/etc/zabbix/shell</p><p>/etc/zabbix/zabbix_agentd.d</p><p>/usr/local/nginx/conf/server</p></blockquote><ul><li>1ï¼Œnginxå¢åŠ é…ç½® server_status.server</li></ul><pre><code class="language-bash:">cat &gt; /usr/local/nginx/conf/server/server_status.server &lt;&lt; 'EOF'server &#123;    listen       80;    server_name  127.0.0.1;    #charset koi8-r;    access_log  off;    location /server_status &#123;        stub_status on;        access_log off;        allow 127.0.0.1;        deny all;    &#125;&#125;EOF/usr/local/nginx/sbin/nginx -t &amp;&amp; /usr/local/nginx/sbin/nginx -s reload</code></pre><hr><ul><li>2ï¼Œ<a href="http://xn--nginx-e86hk14jmnl025b.sh">æ·»åŠ è„šæœ¬nginx.sh</a>  (ç¡®ä¿a+xæƒé™)</li></ul><pre><code class="language-bash:">mkdir /etc/zabbix/shell -p;cat &gt; /etc/zabbix/shell/nginx.sh &lt;&lt; 'EOF'#!/bin/bash  function active &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| grep 'Active' | awk '&#123;print $NF&#125;'&#125;function reading &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| grep 'Reading' | awk '&#123;print $2&#125;'&#125;function writing &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt;/dev/null| grep 'Writing' | awk '&#123;print $4&#125;'&#125;function waiting &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| grep 'Waiting' | awk '&#123;print $6&#125;'&#125;function accepts &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| awk NR==3 | awk '&#123;print $1&#125;'&#125;function handled &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| awk NR==3 | awk '&#123;print $2&#125;'&#125;function requests &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| awk NR==3 | awk '&#123;print $3&#125;'&#125;function qps &#123;        NGINX_STATUS_URL=&quot;http://127.0.0.1/server_status&quot;        #è‹¥æ˜¯tnginxï¼Œåˆ™æœ€ååº”è¾“å‡ºd[length(d)-1]        requestold=`/usr/bin/curl -s $&#123;NGINX_STATUS_URL&#125; | /usr/bin/awk '/server accepts handled requests/&#123;getline a;split(a,d);print d[length(d)]&#125;'`        TimeWait=1        sleep $TimeWait        requestnew=`/usr/bin/curl -s $&#123;NGINX_STATUS_URL&#125; | /usr/bin/awk '/server accepts handled requests/&#123;getline a;split(a,d);print d[length(d)]&#125;'`        if [ $requestnew -gt 0 ];then                QPS=`echo &quot;( $requestnew - $requestold ) / $TimeWait&quot; | /usr/bin/bc`        fi        echo $QPS&#125;# Run the requested function  $1EOFchmod a+x /etc/zabbix/shell/nginx.sh</code></pre><hr><ul><li>3ï¼Œé…ç½®zabbixå®¢æˆ·ç«¯zabbix_agentd.conf</li></ul><pre><code class="language-bash:">cat &gt; /etc/zabbix/zabbix_agentd.d/nginx.conf &lt;&lt; 'EOF'#monitor nginx  UserParameter=nginx.accepts,/etc/zabbix/shell/nginx.sh acceptsUserParameter=nginx.handled,/etc/zabbix/shell/nginx.sh handledUserParameter=nginx.requests,/etc/zabbix/shell/nginx.sh requestsUserParameter=nginx.connections.active,/etc/zabbix/shell/nginx.sh activeUserParameter=nginx.connections.reading,/etc/zabbix/shell/nginx.sh readingUserParameter=nginx.connections.writing,/etc/zabbix/shell/nginx.sh writingUserParameter=nginx.connections.waiting,/etc/zabbix/shell/nginx.sh waitingUserParameter=nginx.connections.qps,/etc/zabbix/shell/nginx.sh qpsEOF</code></pre><hr><ul><li>4ï¼Œåœ¨æœåŠ¡çš„å¯¹åº”ä¸»æœºä¸Šæ·»åŠ æ¨¡æ¿</li></ul>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜redis</title>
      <link href="posts/6c093771/"/>
      <url>posts/6c093771/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-æ¨¡æ¿">zabbix æ¨¡æ¿</h2><ol><li>è‡ªåŠ¨å‘ç°è§„åˆ™</li></ol><p><img src="/posts/6c093771/image-20200520152740815.png" alt="image-20200520152740815"></p><ol start="2"><li><p>è¿‡æ»¤å™¨</p><p><img src="/posts/6c093771/image-20200520152922570.png" alt="image-20200520152922570"></p></li><li><p>ç›‘æ§é¡¹åŸå‹</p><table><thead><tr><th>åç§°</th><th>é”®å€¼</th><th>é—´éš”</th><th>å†å²è®°å½•</th><th>è¶‹åŠ¿</th><th>ç±»å‹</th></tr></thead><tbody><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; connected_clients[å®¢æˆ·ç«¯è¿æ¥æ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,connected_clients]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; maxmemory[redisé…ç½®çš„å†…å­˜ä¸Šé™]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,maxmemory]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; mem_fragmentation_ratio[å†…å­˜ç¢ç‰‡ç‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; redis_instantaneous_ops_per_sec[æ¯ç§’æ‰§è¡Œçš„å‘½ä»¤ä¸ªæ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,instantaneous_ops_per_sec]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; redis å­˜æ´»çŠ¶æ€</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,exist]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; rejected_connections[è¢«æ‹’ç»çš„å®¢æˆ·ç«¯è¿æ¥æ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,rejected_connections]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_sys[redis-master sys-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_sys]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_sys_children[redis-children sys-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_sys_children]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_user[redis-master user-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_user]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_user_children[redis-children user-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_user_children]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory[rediså±‚é¢å·²ä½¿ç”¨å†…å­˜-ä¸å«ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_pct[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜ç™¾åˆ†æ¯”]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_peak[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜å†å²å³°å€¼-å«å†…å­˜ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_peak]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_rss[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜-å«å†…å­˜ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_rss]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr></tbody></table></li><li><p>è§¦å‘å™¨åŸå‹</p><table><thead><tr><th>ä¸¥é‡æ€§</th><th>åç§°</th><th>è¡¨è¾¾å¼</th></tr></thead><tbody><tr><td>ä¸€èˆ¬ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  å†…å­˜ç¢ç‰‡åŒ–è¶…è¿‡50%, å‰©ä½™å¯ç”¨å†…å­˜ä½äº30%</code></td><td><code>&#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio].last()&#125;&gt;1.5  and &#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  å¯ç”¨å†…å­˜ä½, å­˜åœ¨ä½¿ç”¨äº¤æ¢åˆ†åŒº</code></td><td><code>&#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio].last()&#125;&lt;1  and &#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ä¸€èˆ¬ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  æ“ä½œç³»ç»Ÿå±‚é¢å†…å­˜å ç”¨ç™¾åˆ†æ¯”è¿‡é«˜</code></td><td><code>&#123;Template  Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ç¾éš¾</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis ç«¯å£æ— æ³•è®¿é—®</code></td><td><code>&#123;Template  Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,exist].last()&#125;&lt;&gt;1</code></td></tr></tbody></table></li><li><p>å›¾å½¢åŸå‹ï¼Œå°±ä¸è¯¦ç»†å†™äº†ï¼Œè¿™é‡Œåªåˆ—å‡ºæˆ‘è‡ªå·±çš„åˆ†ç±»</p><table><thead><tr><th>åç§°</th><th>å®½</th><th>é«˜</th><th>å›¾å½¢ç±»åˆ«</th></tr></thead><tbody><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis è¿æ¥æ•°ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis å…¶ä»–ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis qps ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis mem ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis cpu ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr></tbody></table></li></ol><h2 id="è„šæœ¬">è„šæœ¬</h2><p>è„šæœ¬ä¼šç”Ÿæˆè‡ªåŠ¨å‘ç°è¿›ç¨‹è„šæœ¬å’Œredisæ£€æµ‹è„šæœ¬</p><p>zabbixçš„redisé…ç½®è·¯å¾„ï¼šZabbixEtc</p><p>zabbixçš„è„šæœ¬è·¯å¾„ï¼šZabbixShell</p><p>redisçš„cliå‘½ä»¤è·¯å¾„ï¼šRedisCli</p><p>è‡ªåŠ¨å‘ç°è„šæœ¬ï¼šip_port_discovery.sh</p><ul><li>bash ip_port_discovery.sh è¿›ç¨‹åæˆ–è€…ç«¯å£</li></ul><p>redisæ£€æµ‹è„šæœ¬ï¼šredis_info.sh</p><ul><li>bash redis_info.sh ip port item</li></ul><pre><code class="language-redis">ZabbixEtc=/etc/zabbix/zabbix_agentd.dZabbixShell=/etc/zabbix/shellRedisCli='docker exec -t redis redis-cli'[[ -d $&#123;ZabbixShell&#125; ]] || mkdir -p $&#123;ZabbixShell&#125;[[ -z $&#123;ZabbixEtc&#125; ]] &amp;&amp; [[ -z $&#123;ZabbixShell&#125; ]] || [[ -z $&#123;RedisCli&#125; ]] &amp;&amp; exitcat&gt;$&#123;ZabbixEtc&#125;/redis.conf&lt;&lt;EOF##redis monitorUserParameter=redis_info[*],$&#123;ZabbixShell&#125;/redis_info.sh \$1 \$2 \$3 \$4UserParameter=ip_port_discovery[*],$&#123;ZabbixShell&#125;/ip_port_discovery.sh \$1EOFcat&gt;$&#123;ZabbixShell&#125;/redis_info.sh&lt;&lt;&quot;EOF&quot;#!/bin/bashRedisCli=HOST=$1PORT=$2REDIS_INFO=&quot;$RedisCli -h $HOST -p $PORT info&quot;[[ $# -ne 3 ]] &amp;&amp; [[ $# -ne 4 ]] &amp;&amp; &#123; exit&#125;if [[ $# -eq 3 ]];thencase $3 inexist) result=`$RedisCli -h $HOST -p $PORT ping 2&gt;/dev/null |grep -c PONG` echo $result;;cluster)        result=`$REDIS_INFO|/bin/grep cluster|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;uptime_in_seconds)        result=`$REDIS_INFO|/bin/grep uptime_in_seconds|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;connected_clients)        result=`$REDIS_INFO|/bin/grep connected_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_longest_output_list)        result=`$REDIS_INFO|/bin/grep client_longest_output_list|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_biggest_input_buf)        result=`$REDIS_INFO|/bin/grep client_biggest_input_buf|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;blocked_clients)        result=`$REDIS_INFO|/bin/grep blocked_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#å†…å­˜maxmemory)        result=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory)        result=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_rss)        result=`$REDIS_INFO|/bin/grep -w used_memory_rss|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk -F'k' '&#123;print $1&#125;'`        echo $result;;used_memory_pct) A=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` B=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` result=`echo $A $B | awk '&#123;printf&quot;%0.2f&quot;,$1/$2&#125;'`        echo $result;;used_memory_peak)        result=`$REDIS_INFO|/bin/grep used_memory_peak|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_lua)        result=`$REDIS_INFO|/bin/grep used_memory_lua|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;mem_fragmentation_ratio)        result=`$REDIS_INFO|/bin/grep mem_fragmentation_ratio|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#rdbrdb_changes_since_last_save)        result=`$REDIS_INFO|/bin/grep rdb_changes_since_last_save|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_bgsave_in_progress)        result=`$REDIS_INFO|/bin/grep rdb_bgsave_in_progress|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_save_time)        result=`$REDIS_INFO|/bin/grep rdb_last_save_time|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_bgsave_status)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_last_bgsave_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;rdb_current_bgsave_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_current_bgsave_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#rdbinfoaof_enabled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_enabled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_scheduled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_scheduled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_last_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_current_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_last_bgrewrite_status)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_bgrewrite_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;#aofinfoaof_current_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_base_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_base_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_rewrite)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_rewrite&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_bio_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_bio_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_delayed_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_delayed_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#statstotal_connections_received)        result=`$REDIS_INFO|/bin/grep -w &quot;total_connections_received&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;total_commands_processed)        result=`$REDIS_INFO|/bin/grep -w &quot;total_commands_processed&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;instantaneous_ops_per_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;instantaneous_ops_per_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;rejected_connections)        result=`$REDIS_INFO|/bin/grep -w &quot;rejected_connections&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;expired_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;expired_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;evicted_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;evicted_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_hits)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_hits&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_misses)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_misses&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_patterns)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_patterns&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;latest_fork_usec)        result=`$REDIS_INFO|/bin/grep -w &quot;latest_fork_usec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;connected_slaves)        result=`$REDIS_INFO|/bin/grep -w &quot;connected_slaves&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;master_link_status)        result=`$REDIS_INFO|/bin/grep -w &quot;master_link_status&quot;|awk -F':' '&#123;print $2&#125;'|/bin/grep -c up`        echo $result;;master_last_io_seconds_ago)        result=`$REDIS_INFO|/bin/grep -w &quot;master_last_io_seconds_ago&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;master_sync_in_progress)        result=`$REDIS_INFO|/bin/grep -w &quot;master_sync_in_progress&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;slave_priority)        result=`$REDIS_INFO|/bin/grep -w &quot;slave_priority&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;#cpuused_cpu_sys)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_sys_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;*) echo &quot;argu error&quot;;;esac#db0:key   elif [[ $# -eq 4 ]];thencase $4 inkeys)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;keys&quot; | awk -F'=|,' '&#123;print $2&#125;'`        echo $result;;expires)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;expires&quot; | awk -F'=|,' '&#123;print $4&#125;'`        echo $result;;avg_ttl)        result=`$REDIS_INFO|/bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;avg_ttl&quot; | awk -F'=|,' '&#123;print $6&#125;'`        echo $result;;*)     echo &quot;argu error&quot; ;;esacfiEOFcat&gt;$&#123;ZabbixShell&#125;/ip_port_discovery.sh&lt;&lt;&quot;EOF&quot;#!/bin/bash#$1æ˜¯è¦å‘ç°çš„è¿›ç¨‹éƒ¨åˆ†è¯æ±‡portarray=(`sudo ss -tnlp|egrep -i &quot;$1&quot;|awk &#123;'print $4'&#125;|awk -F':' '&#123;if ($NF~/^[0-9]*$/) print $NF&#125;'|sort|uniq`)iparray=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`length=$&#123;#portarray[@]&#125;printf &quot;&#123;\n&quot;printf '\t'&quot;\&quot;data\&quot;:[&quot;for ((i=0;i&lt;$length;i++))  do     printf '\n\t\t&#123;'     printf &quot;\&quot;&#123;#IP&#125;\&quot;:\&quot;$&#123;iparray&#125;\&quot;,\&quot;&#123;#TCP_PORT&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;     if [ $i -lt $[$length-1] ];then                printf ','     fi  doneprintf &quot;\n\t]\n&quot;printf &quot;&#125;\n&quot;EOFchmod a+x $&#123;ZabbixShell&#125;/redis_info.shchmod a+x $&#123;ZabbixShell&#125;/ip_port_discovery.shsed -i 's#RedisCli=#RedisCli=\&quot;'&quot;$&#123;RedisCli&#125;&quot;'\&quot;#' $&#123;ZabbixShell&#125;/redis_info.shecho '------------------------------------æˆ‘æ˜¯ zabbix ç›‘æ§ä¿¡æ¯----------------------------------'echo 'ç¼–è¾‘ visudoï¼Œæ·»åŠ å¦‚ä¸‹ä¿¡æ¯'echo &quot;#zabbixç”¨æˆ·å¯ä»¥ä»¥sudoæ‰§è¡Œsszabbix ALL = NOPASSWD: /usr/sbin/ss#zabbixç”¨æˆ·ä½¿ç”¨sudoæ— éœ€ttyDefaults:zabbix    !requiretty&quot;echo 'è‹¥redisè¿è¡Œåœ¨dockerä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤'echo 'usermod -a -G docker zabbix'</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-è¿‡æ»¤å™¨</title>
      <link href="posts/f43dca37/"/>
      <url>posts/f43dca37/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä¸ç®¡æ˜¯è¿‡æ»¤å™¨ï¼Œlookupï¼Œqueryï¼Œwith_xxxï¼Œå¾ˆå¤šéƒ½æ˜¯è·å–æˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ã€‚</p><h4 id="è¿‡æ»¤å™¨">è¿‡æ»¤å™¨</h4><blockquote><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</a></p></blockquote><blockquote><p>å¤„ç†å˜é‡å€¼ï¼Œä»è€Œè·å–æƒ³è¦çš„ä¿¡æ¯.</p><p>è¿‡æ»¤å™¨æœ¬èº«æ˜¯ jinja2 æˆ–è€… ansible å®˜æ–¹å®šä¹‰çš„</p></blockquote><h4 id="ç®€ä¾‹">ç®€ä¾‹</h4><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars:    vara: abcde    varb: [1,2,3,A,b,C,d]    varc: 123    vard: [ 1,2,3,[4,5,6],4,5 ]  tasks:    - name: show upper      debug:        msg: &quot;&#123;&#123; vara | upper&#125;&#125;&quot;</code></pre><blockquote><p>ç®€ä¾‹ä¸­çš„ upper å³æ˜¯è¿‡æ»¤å™¨ï¼Œå®ƒå¯ä»¥å°† vara ä¸­çš„æ‰€æœ‰å­—æ¯å…ƒç´ å¤§å†™ï¼Œæœ€ç»ˆè¾“å‡º ABCDE</p></blockquote><h4 id="å¸¸ç”¨çš„è¿‡æ»¤å™¨">å¸¸ç”¨çš„è¿‡æ»¤å™¨</h4><pre><code class="language-yaml">#å°†å­—ç¬¦ä¸²å¼€å¤´å’Œç»“å°¾çš„ç©ºæ ¼å»é™¤msg:Â &quot;&#123;&#123;Â varaÂ |Â trimÂ &#125;&#125;&quot;#è¿”å›å­—ç¬¦ä¸²æˆ–åˆ—è¡¨é•¿åº¦,lengthä¸countç­‰æ•ˆ,å¯ä»¥å†™ä¸ºcountmsg:Â &quot;&#123;&#123;Â varbÂ |Â lengthÂ &#125;&#125;&quot;# ç»å¯¹å€¼msg: &quot;&#123;&#123; varc | abs &#125;&#125;&quot;# æ’åº(é™åºæ’åº)msg: &quot;&#123;&#123; varb | sort(reverse=true) &#125;&#125;&quot;# å°†åˆ—è¡¨ä¸­ç¬¬ä¸€å±‚åµŒå¥—åˆ—è¡¨å…ƒç´ å±•å¼€å¹¶å…¥åˆ—è¡¨ä¸­,å¹¶å–å‡ºæ–°åˆ—è¡¨ä¸­çš„æœ€å¤§å…ƒç´ msg: &quot;&#123;&#123; vard | flatten(levels=1) | max &#125;&#125;&quot;# éšæœºè¿”å›ä¸€ä¸ªå…ƒç´ msg: &quot;&#123;&#123; varb | random &#125;&#125;&quot;# å»é‡msg: &quot;&#123;&#123; vard | unique &#125;&#125;&quot;# å¹¶é›†msg: &quot;&#123;&#123; varb | union(vard) &#125;&#125;&quot;# äº¤é›†msg: &quot;&#123;&#123; varb | intersect(vard) &#125;&#125;&quot;# è¡¥é›†ï¼Œå–å‡ºå­˜åœ¨äº varbï¼Œä½†ä¸å­˜åœ¨äº vard ä¸­çš„å…ƒç´ msg: &quot;&#123;&#123; varb | difference(vard) &#125;&#125;&quot;# å»é™¤ä¸¤ä¸ªåˆ—è¡¨äº¤é›†åçš„å…ƒç´ msg: &quot;&#123;&#123; varb | symmetric_difference(vard) &#125;&#125;&quot;# å˜é‡æœªå®šä¹‰ï¼Œè¿”å›é»˜è®¤å€¼ newmsg: &quot;&#123;&#123; vare | default('new')&#125;&#125;&quot;# å˜é‡æœªå®šä¹‰æˆ–è€…å®šä¹‰ä½†ä¸ºç©ºï¼Œè¿”å›é»˜è®¤å€¼ newmsg: &quot;&#123;&#123; vare | default('new', boolean=true)&#125;&#125;&quot;# å˜é‡æœªå®šä¹‰æ—¶ï¼Œå¿½ç•¥æŸä¸ªå‚æ•°file: xxxx  mode=&#123;&#123; vare | default(omit)&#125;&#125;&quot;  # è‹¥ vare ä¸å­˜åœ¨ï¼Œåˆ™å¿½ç•¥modeå‚æ•°</code></pre><h4 id="json-query">json_query</h4><blockquote><p>è·å–ç‰¹å®šæ•°æ®</p></blockquote><pre><code>1. æŸ¥è¯¢å­—ç¬¦ä¸²å¯ç”¨å˜é‡ä»£æ›¿ï¼Œå¢åŠ å¯è¯»æ€§ loop: &quot;&#123;&#123; domain_definition | json_query(server_name_cluster1_query) &#125;&#125;&quot; vars:    server_name_cluster1_query: &quot;domain.server[?cluster=='cluster1'].port&quot;</code></pre><ol start="2"><li>æŸ¥è¯¢æ¡ä»¶</li></ol><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars:    users:    - name: zhangsan      gender: male    - name: lisi      gender: female  tasks:    - name: test 1      debug:        msg: &quot;&#123;&#123; users | json_query('[?name==`zhangsan`].gender') &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        &quot;male&quot;    ]&#125;</code></pre><h4 id="map">map</h4><blockquote><p>æ˜ å°„</p></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars:    users:    - name: zhangsan      gender: male    - name: lisi      gender: female  tasks:    - name: test 1      debug:        msg: &quot;&#123;&#123; users|map(attribute='name') | list &#125;&#125;&quot;    - name: test 2      debug:        msg: &quot;&#123;&#123; users | json_query('[*].name') &#125;&#125;&quot;</code></pre><pre><code class="language-bash"># test 2 æ˜¯é‡‡ç”¨ json_query æ–¹å¼ï¼Œtest1å’Œtest2ç»“æœä¸€æ ·ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        &quot;zhangsan&quot;,         &quot;lisi&quot;    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-æ–‡æœ¬æ–‡ä»¶æ“ä½œ</title>
      <link href="posts/4235ddf4/"/>
      <url>posts/4235ddf4/</url>
      
        <content type="html"><![CDATA[<h4 id="var-å®šä¹‰">var å®šä¹‰</h4><blockquote><p>é€šè¿‡å˜é‡ï¼Œä¿®æ”¹playbook</p><p>å¯ç›´æ¥å†™å…¥ playbookï¼Œ ä¹Ÿå¯ä»¥å†™å…¥æ–‡ä»¶ï¼Œç„¶å playbook é€šè¿‡ vars_files å¼•ç”¨</p><p>å…³é”®è¯:</p><ul><li>vars</li><li>vars_files # ä¸€æ¬¡æ€§åŠ è½½æ–‡ä»¶å†…éƒ¨æ•°æ®ï¼Œä¸æ”¯æŒæ–‡ä»¶åŠ¨æ€ä¿®æ”¹æˆ–æ·»åŠ æ–°å˜é‡</li></ul></blockquote><h4 id="ç®€ä¾‹">ç®€ä¾‹</h4><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  vars_files: ~/vars.yml  vars:    father: Zhang San  tasks:    - name: test vars      shell: echo &quot;&#123;&#123; father &#125;&#125; - &#123;&#123; children.son_name &#125;&#125; success&quot; &gt;&gt; ~/son.log</code></pre><pre><code class="language-yaml">children:  son_name: Zhang Xiaosan</code></pre><pre><code class="language-bash"># son.log å†…å®¹Zhang San - Zhang Xiaosan success</code></pre><h4 id="var-æ³¨å†Œ">var æ³¨å†Œ</h4><blockquote><p>å½“æˆ‘ä»¬æƒ³å°†æŸä¸ªä»»åŠ¡çš„ç»“æœå†™å…¥ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨registeræ¥è¿›è¡Œæ³¨å†Œ</p><p>å…³é”®è¯:</p><ul><li>register</li><li>debug<ul><li>var è¾“å‡ºå˜é‡å€¼</li><li>msg è¾“å‡ºå­—ç¬¦ä¸²</li></ul></li></ul></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  tasks:    - name: test register      shell: echo &quot;register success&quot; &gt; ~/register.log      register: resultInfo    - name: show register result      debug:        msg: &quot;Oh my god&quot;        var: resultInfo</code></pre><h4 id="var-äº¤äº’">var äº¤äº’</h4><blockquote><p>æä¾›ä¸€ä¸ªç”¨æˆ·è¾“å…¥ä¿¡æ¯çš„æœºä¼šï¼Œå’Œ shell é‡Œé¢çš„ read -p ä¸€è‡´ã€‚</p><p>å…³é”®è¯ï¼š</p><ul><li>vars_prompt</li></ul></blockquote><pre><code class="language-bash">---- hosts: localhost  remote_user: zyh  vars_prompt:    - name: &quot;fatherName&quot;      prompt: &quot;What's your father name&quot;      default: ZhangSan      private: no  tasks:    - name: show father name      shell: echo &quot;&#123;&#123; fatherName &#125;&#125;&quot; &gt; ~/prompt.log</code></pre><blockquote><p>private yes=éšè—è¾“å…¥å†…å®¹ no=æ˜¾ç¤ºè¾“å…¥å†…å®¹</p><p>default é»˜è®¤å€¼</p><p>encrypt â€œsha512_cryptâ€ å°†å˜é‡å€¼åŠ å¯†ï¼Œä¸€èˆ¬ç”¨äºä¼ é€’å¯†ç ï¼Œæ¯”å¦‚ä¼ é€’ç»™ user æ¨¡å—çš„ password å‚æ•°</p></blockquote><h4 id="var-å‘½ä»¤è¡Œä¼ å…¥">var å‘½ä»¤è¡Œä¼ å…¥</h4><blockquote><p>ä¸€èˆ¬ç”¨äºä¸´æ—¶å¼ºåˆ¶è¦†ç›–playbookä¸­å®šä¹‰å¥½çš„å˜é‡</p><p>å…³é”®è¯ï¼š</p><ul><li>-e æˆ–è€… --extra-vars<ul><li>å‚æ•°åé¢ï¼Œå¯ä»¥è·Ÿéšå¤šä¸ªå˜é‡kvå¯¹ï¼Œæ¯ä¸€ä¸ªkvå¯¹ç”¨ç©ºæ ¼éš”å¼€</li><li>å‚æ•°åé¢ï¼Œ@filePath å¯ä»¥ä¼ å…¥å˜é‡æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­çš„å˜é‡å‡å¯ä»¥è¢«å¼•ç”¨</li></ul></li></ul></blockquote><pre><code class="language-bash">ansible-play test.play -e &quot;fatherName=Laowang&quot;</code></pre><h4 id="var-ä½œç”¨åŸŸ">var ä½œç”¨åŸŸ</h4><table><thead><tr><th>åˆ›å»ºæ–¹å¼</th><th>è°ƒç”¨ä½ç½®</th><th>ä½œç”¨åŸŸ</th></tr></thead><tbody><tr><td>vars</td><td>playå’Œtasks</td><td>å½“å‰playæˆ–è€…å½“å‰tasksï¼Œæ— æ³•è·¨ä¸»æœº</td></tr><tr><td>set_fact</td><td>tasks</td><td>è·¨playï¼Œé»˜è®¤æ— æ³•è·¨ä¸»æœº</td></tr><tr><td>register</td><td>tasks</td><td>è·¨playï¼Œé»˜è®¤æ— æ³•è·¨ä¸»æœº</td></tr></tbody></table><p>è‹¥è¦ä½¿å¾— set_fact å’Œ register è·¨ä¸»æœºä½¿ç”¨ï¼Œåˆ™éœ€è¦å¼•å…¥å†…ç½®å˜é‡ <code>hostvars</code> ä¾‹å¦‚ hostvars.&lt;ä¸»æœºå&gt;.&lt;å˜é‡å&gt;</p><blockquote><p>å…¶å®ƒå†…ç½®å˜é‡ï¼š</p><ul><li><p>ansible_version # ç‰ˆæœ¬</p></li><li><p>hostvars # å­˜å‚¨playä¸­çš„æ‰€æœ‰ä¸»æœºå˜é‡</p></li><li><p>play_hosts # å­˜å‚¨playä¸­çš„æ‰€æœ‰ä¸»æœºå</p></li><li><p>inventory_hostname  # å­˜å‚¨å½“å‰ä¸»æœºå</p></li><li><p>inventory_hostname_short  # å­˜å‚¨å½“å‰ä¸»æœºåç®€ç§°ï¼ˆå…¶å®å°±æ˜¯è·å–ä¸»æœºåç¬¬ä¸€çº§ï¼Œä¾‹å¦‚001.localhostï¼Œé‚£ä¹ˆè·å–çš„å°±æ˜¯001ï¼‰</p></li><li><p>groups # å­˜å‚¨æ‰€æœ‰åˆ†ç»„ä¿¡æ¯ï¼ŒåŒ…æ‹¬allå’Œungrouped</p></li><li><p>group_names # å­˜å‚¨å½“å‰playä¸­ä¸»æœºçš„æ‰€å±ç»„å</p></li><li><p>inventory_dir # å­˜å‚¨ä¸»æœºæ¸…å•æ–‡ä»¶æ‰€åœ¨è·¯å¾„</p></li></ul></blockquote><h4 id="var-åŠ¨æ€è·å–æ–°å˜é‡">var åŠ¨æ€è·å–æ–°å˜é‡</h4><blockquote><p>å…³é”®è¯ï¼šinclude_vars</p><p>ç”¨äºä»»åŠ¡é‡è½½å˜é‡æ–‡ä»¶ï¼Œä»è€Œè·å–ä»»åŠ¡æœŸé—´å˜é‡æ–‡ä»¶ä¿®æ”¹çš„æ•°æ®</p></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars_files: ~/test.yaml  tasks:    - name: get varb - max      debug:        msg: &quot;&#123;&#123; varb |  max &#125;&#125;&quot;    - name: lineinfile      lineinfile:        regexp: ^varb        line: &quot;varb: [1,2,3,4]&quot;        path: ~/test.yaml    - include_vars: ~/test.yaml    - name: get varb - max again      debug:        msg: &quot;&#123;&#123; varb |  max &#125;&#125;&quot;</code></pre><pre><code class="language-bash">#### test.yaml å˜é‡æ–‡ä»¶åˆå§‹å†…å®¹:vara: 123                                                                 varb: [1,2,3]  #### æœ€ç»ˆç»“æœï¼šç¬¬ä¸€æ¬¡ get varb ä»»åŠ¡è¾“å‡º 3, ç¬¬äºŒæ¬¡ get varb ä»»åŠ¡è¾“å‡º 4</code></pre><blockquote><p>include_vars æ¨¡å—å¸¸ç”¨å‚æ•°ï¼š</p><ul><li><p>file è¯»å–æŸä¸ªå˜é‡æ–‡ä»¶</p></li><li><p>dir è¯»å–æŸä¸ªç›®å½•çš„æ‰€æœ‰å˜é‡æ–‡ä»¶</p></li><li><p>depth é€’å½’å±‚æ·±ï¼Œä»…åœ¨ dir å¯ç”¨çš„æ—¶å€™æœ‰æ„ä¹‰</p></li><li><p>files_matching æ­£åˆ™åŒ¹é…æ–‡ä»¶åï¼Œä»…åœ¨ dir å¯ç”¨çš„æ—¶å€™æœ‰æ„ä¹‰</p></li><li><p>ignore_files å¿½ç•¥æŸä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„å…ƒç´ å¯ä»¥ä¸ºæ­£åˆ™è¡¨è¾¾å¼</p></li><li><p>name: å˜é‡ x  å°†è¯»å–çš„æ–‡ä»¶å†…å®¹é›†ä¸­å¤åˆ¶ç»™å˜é‡ xï¼Œä¾‹å¦‚ä¸Šä¾‹ä¸­å˜é‡ x ä¸º {vara: 123, varb: [1,2,3,4]}</p></li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜è¾“å‡ºä¸ªæ€§åŒ–å¼€æœºçŠ¶æ€</title>
      <link href="posts/3988a5f2/"/>
      <url>posts/3988a5f2/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰æ²¿">å‰æ²¿</h4><p>è§‰å¾—é»˜è®¤çš„ç™»é™†ä¸å¤Ÿç»™åŠ›ï¼Œæ— æ³•å¿½æ‚ æœºå™¨ï¼Œç”¨wowerçš„è¯æ¥è¯´ï¼Œå°±æ˜¯å…ˆç¥–å¿½æ‚ ç€ä½ </p><h4 id="æ•ˆæœå›¾åœ¨æ­¤">æ•ˆæœå›¾åœ¨æ­¤</h4><p><img src="/posts/3988a5f2/image-20200515110044304.png" alt="image-20200515110044304"></p><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><blockquote><p>å°†è„šæœ¬æ”¾ç½®åˆ° /etc/profile.d/status.sh</p></blockquote><pre><code class="language-bash">#!/bin/bash# Author: zyh# éœ€å…ˆå®‰è£… toilet å’Œ cowsay å‘½ä»¤# yum install epel-release -y# yum install https://rpmfind.net/linux/openmandriva/4.1/repository/x86_64/unsupported/release/toilet-0.2-3-omv4000.x86_64.rpm cowsay -yuser=$USERhome=$HOME## blue to echofunction blue()&#123;    echo -e &quot;\033[34m[Info] $1\033[0m&quot;    &#125;## green to echofunction green()&#123;    echo -e &quot;\033[32m[Success] $1\033[0m&quot;    &#125;## Errorfunction red()&#123;    echo -e &quot;\033[31m\033[01m[Error] $1\033[0m&quot;    &#125;# warningfunction yellow()&#123;    echo -e &quot;\033[33m\033[01m[Warn] $1\033[0m&quot;    &#125;## Error to warning with blinkfunction bred()&#123;    echo -e &quot;\033[31m\033[01m\033[05m[Error] $1\033[0m&quot;    &#125;# Error to warning with blinkfunction byellow()&#123;    echo -e &quot;\033[33m\033[01m\033[05m[Warn] $1\033[0m&quot;    &#125;publicip=`curl -s http://169.254.169.254/latest/meta-data/public-ipv4`localip=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`echo -e &quot;$publicip $localip&quot; | cowsay -f tux | toilet -f term  --gay# * Check if we're somewhere in /homeif [ ! -d $&#123;home&#125; ];then    return 0fi# * Calculate last loginlastlog=`lastlog -u $&#123;user&#125; | grep $&#123;user&#125; | awk '&#123;for(i=3;i&lt;=NF;++i) printf(&quot;%s &quot;,$i)&#125;'`# * Print Outputecho &quot; ::::::::::::::::::::::::::::::::::-STATUS-::::::::::::::::::::::::::::::::::&quot;#  * Check RAM Usagesfree_mem_usages=$(awk '/MemTotal/&#123;total=$2&#125;/MemAvailable/&#123;free=$2&#125;END&#123;print free/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;' /proc/meminfo)app_mem_usages=$(awk '/MemTotal/&#123;total=$2&#125;/MemFree/&#123;free=$2&#125;/Buffers/&#123;buffers=$2&#125;/^Cached/&#123;cached=$2&#125;END&#123;print (total-free-buffers-cached)/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;'  /proc/meminfo)all_mem_usages=$(awk '/MemTotal/&#123;total=$2&#125;/MemFree/&#123;free=$2&#125;END&#123;print (total-free)/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;'  /proc/meminfo)blue &quot; Free Memory : $&#123;free_mem_usages&#125;&quot;blue &quot; Application Memory Usages : $&#123;app_mem_usages&#125;&quot;blue &quot; System Memory Usages : $&#123;all_mem_usages&#125;&quot;# * Check Disk Usagesdiskusages=$(df -PH | awk '&#123;printf &quot;%-40s%-15s%-15s%-15s%-15s%-15s\n&quot;, $1,$2,$3,$4,$5,$6&#125;')blue &quot; Disk Usages :&quot;echo &quot;$&#123;diskusages&#125;&quot; | toilet -f term --metal -w 200# * Check Load Averageloadaverage=$(top -n 1 -b | grep &quot;load average:&quot; | awk '&#123;print $(NF-2) $(NF-1) $NF&#125;')blue &quot; Load Average: $loadaverage&quot;</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é—®é¢˜è®°å½•</title>
      <link href="posts/1ddb9d4e/"/>
      <url>posts/1ddb9d4e/</url>
      
        <content type="html"><![CDATA[<h3 id="Q-åŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶å‡ºç°">Q:åŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶å‡ºç°</h3><pre><code class="language-bash">insserv:  loop involving service xxx at depth 2</code></pre><h4 id="A-åˆ é™¤-xxx-æœåŠ¡ï¼Œå¦‚æœ-xxx-æœåŠ¡å·²åˆ é™¤ï¼Œæ¸…ç†-xxx-æœåŠ¡çš„å¯åŠ¨è„šæœ¬-etc-init-d-xxx">A:åˆ é™¤ xxx æœåŠ¡ï¼Œå¦‚æœ xxx æœåŠ¡å·²åˆ é™¤ï¼Œæ¸…ç† xxx æœåŠ¡çš„å¯åŠ¨è„šæœ¬ /etc/init.d/xxx</h4><hr><h3 id="Q-crontab-å¦‚ä½•ä¿®æ”¹æ—¶åŒº">Q:crontab å¦‚ä½•ä¿®æ”¹æ—¶åŒº</h3><h4 id="A-åœ¨crontabæ–‡ä»¶æœ€ä¸Šæ–¹æ·»åŠ å‘½ä»¤ï¼Œä¾‹å¦‚èŠåŠ å“¥æ—¶åŒº">A:åœ¨crontabæ–‡ä»¶æœ€ä¸Šæ–¹æ·»åŠ å‘½ä»¤ï¼Œä¾‹å¦‚èŠåŠ å“¥æ—¶åŒº</h4><pre><code class="language-bash">TZ='America/Chicago'                                          CRON_TZ='America/Chicago'  `</code></pre><hr><h3 id="Q-su-user-c-â€œcommandâ€-å‘½ä»¤å‡ºé”™">Q:su - user -c â€œcommandâ€ å‘½ä»¤å‡ºé”™</h3><h4 id="A-éœ€è¦ç”¨æˆ·å¼€å¯ç™»é™†æƒé™ï¼Œå³-etc-passwd-ä¸­ä¸èƒ½ä½¿-sbin-nologin">A:éœ€è¦ç”¨æˆ·å¼€å¯ç™»é™†æƒé™ï¼Œå³ /etc/passwd ä¸­ä¸èƒ½ä½¿ /sbin/nologin</h4><hr><h3 id="Q-zabbix-è‡ªåŠ¨å‘ç°å¼‚å¸¸ï¼Œè¡¨é¢çœ‹ä¸å‡ºé—®é¢˜">Q:zabbix è‡ªåŠ¨å‘ç°å¼‚å¸¸ï¼Œè¡¨é¢çœ‹ä¸å‡ºé—®é¢˜</h3><h4 id="A-zabbix-agent-ç«¯å¼€å¯-debug-æ¨¡å¼ï¼Œé…ç½®åŠ å…¥å‚æ•°-DebugLevel-4">A:zabbix-agent ç«¯å¼€å¯ debug æ¨¡å¼ï¼Œé…ç½®åŠ å…¥å‚æ•° DebugLevel=4</h4><hr><h3 id="Q-adminer-æ— æ•ˆçš„CSRFä»¤ç‰Œ-Invalid-CSRF-token">Q:adminer: æ— æ•ˆçš„CSRFä»¤ç‰Œ(Invalid CSRF token)</h3><h4 id="A-nginx-worker-user-ç”¨æˆ·æ— æ³•è®¿é—®-php-session-ç›®å½•">A:nginx worker user ç”¨æˆ·æ— æ³•è®¿é—® php session ç›®å½•.</h4><pre><code class="language-bash">chgrp $&#123;nginxWorkerUser&#125; $&#123;phpSessionDir&#125;# å¦‚æœæ˜¯yumæˆ–è€…aptå®‰è£…,é‚£ä¹ˆphpçš„sessionä¸€èˆ¬æ˜¯ /var/lib/php/session</code></pre><hr><h3 id="Q-python3-No-module-named-â€˜PILâ€™">Q:python3 : No module named â€˜PILâ€™</h3><h4 id="A-pip3-install-pillow">A:pip3 install pillow</h4><hr><h3 id="Q-python-workon-å‘½ä»¤æ‰¾ä¸åˆ°">Q:python: workon å‘½ä»¤æ‰¾ä¸åˆ°</h3><h4 id="A">A:</h4><pre><code class="language-bash:">pip install virtualenvwrapperecho 'export PATH=~/.local/bin:$PATH' &gt;&gt; ~/.bashrc # æ ¹æ®æ‰€ç”¨shellæ¥å†³å®šæ–‡ä»¶è·¯å¾„</code></pre><hr><h3 id="Q-jiraé…ç½®163çš„smtpè¿æ¥è¶…æ—¶-ä½†æ˜¯æœåŠ¡å™¨ç»ˆç«¯telnetæ­£å¸¸">Q:jiraé…ç½®163çš„smtpè¿æ¥è¶…æ—¶,ä½†æ˜¯æœåŠ¡å™¨ç»ˆç«¯telnetæ­£å¸¸</h3><h4 id="A-2">A:</h4><p><img src="/posts/1ddb9d4e/image-20200917111208620.png" alt="image-20200917111208620"></p><h3 id="Q-tomcat-æ·»åŠ -pid-æ–‡ä»¶">Q: tomcat æ·»åŠ  pid æ–‡ä»¶</h3><h4 id="A-catalina-sh-æ–‡ä»¶çš„-PRGDIR-dirname-PRG-ä¸‹é¢æ·»åŠ æ–°è¡Œ-CATALINA-PID-PRGDIR-tomcat-pid-æ­¤æ—¶å°†åœ¨-bin-ç›®å½•ä¸‹åˆ›å»º-tomcat-pid">A:  <a href="http://catalina.sh">catalina.sh</a> æ–‡ä»¶çš„ <code>PRGDIR=dirname &quot;$PRG&quot;</code>ä¸‹é¢æ·»åŠ æ–°è¡Œ <code>CATALINA_PID=$PRGDIR/tomcat.pid</code> æ­¤æ—¶å°†åœ¨ bin/ ç›®å½•ä¸‹åˆ›å»º tomcat.pid</h4><h3 id="Qï¼švimä¸­æ–‡ä¹±ç ">Qï¼švimä¸­æ–‡ä¹±ç </h3><h4 id="Aï¼š-etc-vimrc-ä¸­æ·»åŠ ">Aï¼š/etc/vimrc ä¸­æ·»åŠ </h4><pre><code class="language-bash">set fileencodings=utf-8,ucs-bom,gb18030,gbk,gb2312,cp936set termencoding=utf-8set encoding=utf-8</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> é—®é¢˜è®°å½• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-tags</title>
      <link href="posts/960fc783/"/>
      <url>posts/960fc783/</url>
      
        <content type="html"><![CDATA[<h4 id="tagsçš„å®šä¹‰">tagsçš„å®šä¹‰</h4><blockquote><p>tags å¯ä»¥è®©ä½ åœ¨æ‰§è¡Œplaybookçš„æ—¶å€™ï¼Œæœ‰é€‰æ‹©åœ°æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œå› æ­¤ tags æ˜¯ tasks ä¸‹çš„å…³é”®è¯</p></blockquote><pre><code class="language-bash">ansible-playbook test.play &lt;--tags-args&gt;</code></pre><h4 id="tagsçš„å‚æ•°">tagsçš„å‚æ•°</h4><blockquote><ul><li>â€“tags=tag_name  æ‰§è¡Œå…·æœ‰ tag_name ä»»åŠ¡</li><li>â€“skip-tags=tag_name å¿½ç•¥å…·æœ‰ tag_name ä»»åŠ¡</li><li>â€“list-tags è¾“å‡ºæ‰€æœ‰</li></ul></blockquote><blockquote><p>tag_name å†…ç½®å€¼ ï¼š</p><ul><li>tagged æœ‰tagçš„taskï¼Œè¡¨ç¤ºæ‰§è¡Œå…·æœ‰æ ‡è®°çš„ä»»åŠ¡</li><li>untagged æ²¡æœ‰tagçš„taskï¼Œè¡¨ç¤ºæ‰§è¡Œä¸å…·æœ‰æ ‡è®°çš„ä»»åŠ¡</li><li>all æ‰€æœ‰taskï¼Œè¡¨ç¤ºæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡</li></ul></blockquote><h4 id="tagsçš„å†…ç½®æ ‡è®°">tagsçš„å†…ç½®æ ‡è®°</h4><blockquote><ul><li>always æ€»æ˜¯æ‰§è¡ŒæŸä¸ª task</li><li>never æ°¸è¿œä¸æ‰§è¡ŒæŸä¸ª task</li></ul></blockquote><h4 id="tags-çš„ä½ç½®">tags çš„ä½ç½®</h4><blockquote><p>ä½äºplayæˆ–è€…taskséƒ½å¯ä»¥ï¼Œæœ¬èº«å…·æœ‰ç»§æ‰¿å±æ€§ï¼Œä¹Ÿå°±æ˜¯tasksé‡Œçš„tagsä¼šç»§æ‰¿playçš„tags</p></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  tags: father  tasks:    - name: test tag son      tags: son,children      shell: echo &quot;son is here!&quot; &gt; ~/son.log    - name: test tag daughter      tags: daughter,children      shell: echo &quot;daughter is here!&quot; &gt; ~/daughter.log</code></pre><pre><code class="language-bash">ansible-playbook test.play --tags=son # åªä¼šç”Ÿæˆ son.logansible-playbook test.play --tags=father  # å› ç»§æ‰¿æœºåˆ¶ï¼Œä¼šç”Ÿæˆ son.log å’Œ daughter.logansible-playbook test.play --tags=children # å› éƒ½å«æœ‰ï¼ŒåŒæ ·ä¼šç”Ÿæˆ son.log å’Œ daughter.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-é”™è¯¯æ•è·</title>
      <link href="posts/c4126d5a/"/>
      <url>posts/c4126d5a/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ç±»ä¼¼äº python ä¸­çš„ tryâ€¦exceptâ€¦finallyï¼Œansible å¯ä»¥ç”¨ blockâ€¦rescueâ€¦always</p><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - block:        - shell: mkdir /file      rescue:        - debug:            msg: &quot;No operation permission&quot;      always:        - debug:            msg: &quot;Task End!&quot;</code></pre><blockquote><p>åˆ›å»º file ç›®å½•å¤±è´¥ï¼Œåˆ™è¾“å‡º&quot;No operation permission&quot;, æœ€ç»ˆæ€»æ˜¯è¾“å‡ºâ€œTask End!â€</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-æ¡ä»¶åˆ¤æ–­</title>
      <link href="posts/29683589/"/>
      <url>posts/29683589/</url>
      
        <content type="html"><![CDATA[<h4 id="å…³é”®è¯">å…³é”®è¯</h4><ul><li>when</li></ul><h4 id="è¿ç®—ç¬¦">è¿ç®—ç¬¦</h4><ul><li>==  !=  &gt;  &lt;  &gt;=  &lt;=</li><li>and or not</li><li>( ) ç»„åˆï¼Œä¾‹å¦‚ ( a and b ) or c</li></ul><blockquote><p>ansible æŸä¸ª task æŠ¥é”™ï¼Œä¼šå¯¼è‡´ä»»åŠ¡ç»ˆæ­¢ï¼Œè€Œignore_errors: true å¯ä»¥å¿½ç•¥æŸä¸ªä»»åŠ¡çš„æ¡ä»¶ä¸æ»¡è¶³</p></blockquote><h4 id="is-è¯­å¥-æˆ–è€…-is-not-è¯­å¥">is è¯­å¥ æˆ–è€… is not è¯­å¥</h4><pre><code class="language-yaml">tasks:  - name: show is xxx    debug:      msg: &quot;xxx is ok&quot;    when: var is xxx</code></pre><blockquote><p>åˆ¤æ–­æ–‡ä»¶</p><ul><li>xxx æ˜¯ exists ï¼Œè¡¨ç¤ºè‹¥ var å­˜åœ¨ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ file, è¡¨ç¤ºè‹¥ var æ˜¯æ–‡ä»¶ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ directoryï¼Œ è¡¨ç¤ºè‹¥ var æ˜¯ç›®å½•ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ linkï¼Œè¡¨ç¤ºè‹¥ var æ˜¯è½¯è¿æ¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ mountï¼Œè¡¨ç¤ºè‹¥ var æ˜¯æŒ‚è½½ç‚¹ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­å˜é‡</p><ul><li>è‹¥ xxx æ˜¯ defined, è¡¨ç¤ºè‹¥ var å·²å®šä¹‰ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ undefinedï¼Œ è¡¨ç¤ºè‹¥ var æœªå®šä¹‰ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ noneï¼Œ è¡¨ç¤ºè‹¥ var æ˜¯ç©ºï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­ä»»åŠ¡çŠ¶æ€</p><ul><li>è‹¥ xxx æ˜¯ successï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€æˆåŠŸï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ failureï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ changeï¼Œè‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€æ”¹å˜ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ skipï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡è¢«å¿½ç•¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­å­—ç¬¦ä¸²</p><ul><li><p>è‹¥ xxx æ˜¯ stringï¼Œè‹¥ var æ˜¯å­—ç¬¦ä¸²ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ lowerï¼Œè‹¥ var æ˜¯çº¯å°å†™ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ upperï¼Œè‹¥ var æ˜¯çº¯å¤§å†™ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li></ul></blockquote><blockquote><p>åˆ¤æ–­æ•°å­—</p><ul><li><p>è‹¥ xxx æ˜¯ numberï¼Œ è‹¥ var æ˜¯æ•°å­—ï¼Œæ¡ä»¶ä¸ºçœŸã€‚ var: â€œ123â€ ,è¿™é‡Œ var æ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°å­—</p></li><li><p>è‹¥ xxx æ˜¯ evenï¼Œè‹¥ var æ˜¯å¶æ•°ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ oddï¼Œ è‹¥ var æ˜¯å¥‡æ•°ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ divisibleby(num), è‹¥ var å¯ä»¥è¢« num æ•´é™¤ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li></ul></blockquote><blockquote><p>åˆ¤æ–­é›†åˆ</p><ul><li>è‹¥ xxx æ˜¯ subset(list)ï¼Œè‹¥ var æ˜¯ list çš„å­é›†ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ superset(list), è‹¥ var æ˜¯ list çš„çˆ¶é›†ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-å¾ªç¯</title>
      <link href="posts/14bc184e/"/>
      <url>posts/14bc184e/</url>
      
        <content type="html"><![CDATA[<h4 id="å¸¸è§çš„å¾ªç¯">å¸¸è§çš„å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show debug info      debug:        msg: &quot;&#123;&#123; item &#125;&#125;&quot;      with_items:        - [ a,b ]        - [ A,B, [ D,E,F ]]</code></pre><blockquote><ul><li><p>with_list è¾“å‡ºæœ€è¡¨å±‚å…ƒç´ ï¼Œåœ¨ç®€ä¾‹ä¸­ï¼Œä¼šè¾“å‡º [ a,b ] å’Œ [ A,B, [ D,E,F ] ]</p></li><li><p>with_item é€’å½’è¾“å‡ºæ‰€æœ‰å±‚å…ƒç´ </p></li><li><p>with_together åˆå¹¶ä¸¤ä¸ªåˆ—è¡¨ï¼Œå…ƒç´ æŒ‰ç…§å¯¹åº”ä¸‹æ ‡ç»“åˆï¼Œå¦‚æœæŸä¸€æ–¹åˆ—è¡¨å…ƒç´ ç¼ºå¤±ï¼Œåˆ™ç”¨nullä»£æ›¿</p></li><li><p>with_indexed_items æœ€è¡¨å±‚æ‰€æœ‰åˆ—è¡¨åˆå¹¶ä¸ºä¸€ä¸ªæ–°åˆ—è¡¨å¹¶å¾ªç¯ã€‚itemç”±{ list.index: list.value } æ„æˆã€‚åœ¨ç®€ä¾‹ä¸­ï¼Œæ–°åˆ—è¡¨æ˜¯[ a,b,A,B, [ D,E,F ]]</p><pre><code class="language-yaml"></code></pre></li></ul><p>msg: â€œIndex:&#123;&#123; item.0 &#125;&#125;, Value:&#123;&#123; item.1 &#125;&#125;â€</p><pre><code>```bashok: [localhost] =&gt; (item=[0, u'a']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:0, Vaule:a&quot;&#125;ok: [localhost] =&gt; (item=[1, u'b']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:1, Vaule:b&quot;&#125;ok: [localhost] =&gt; (item=[2, u'A']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:2, Vaule:A&quot;&#125;ok: [localhost] =&gt; (item=[3, u'B']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:3, Vaule:B&quot;&#125;ok: [localhost] =&gt; (item=[4, [u'D', u'E', u'F']]) =&gt; &#123;    &quot;msg&quot;: &quot;Index:4, Vaule:[u'D', u'E', u'F']&quot;&#125;</code></pre><ul><li>with_random_choice éšæœºè¾“å‡ºä¸€ä¸ªæœ€è¡¨å±‚åˆ—è¡¨å…ƒç´ ï¼Œç®€ä¾‹ä¸­è¾“å‡º [a,b] æˆ–è€… [ A,B, [ D,E,F ]]</li></ul></blockquote><h4 id="dict-å­—å…¸å¾ªç¯">dict å­—å…¸å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show debug info      debug:        msg: &quot;Name:&#123;&#123; item.key &#125;&#125;, gender:&#123;&#123; item.value &#125;&#125;&quot;      with_dict:        Zhangsan: male        Lisi: female</code></pre><blockquote><p>è¾“å‡ºæ‰€æœ‰å­—å…¸</p></blockquote><h4 id="sequence-åºåˆ—å¾ªç¯">sequence åºåˆ—å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show sequence info      debug:        msg: &quot;&#123;&#123; item &#125;&#125;&quot;      with_sequence:        start=1        end=5        stride=2        format=&quot;I'm %0.4f&quot;</code></pre><blockquote><ul><li>with_sequence è·å–å¥‡å¶æ•°ï¼Œstartå’Œendæ˜¯èµ·æ­¢ç‚¹ï¼Œstride æ˜¯æ­¥é•¿ï¼ˆæ­¥é•¿å¯ä»¥ä¸ºè´Ÿå€¼ï¼‰ï¼Œformatæ˜¯æ ¼å¼åŒ–</li></ul></blockquote><h4 id="nested-åµŒå¥—å¾ªç¯">nested åµŒå¥—å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show nested info      debug:        msg: &quot;mkdir /mnt/&#123;&#123; item.0 &#125;&#125;/&#123;&#123; item.1 &#125;&#125;&quot;      with_nested:        - [ a,b ]        - [ A,B,C ]</code></pre><blockquote><p>ä¸¤ä¸ªåˆ—è¡¨åšç¬›å¡å°”ç§¯, ä¾‹å¦‚æ„å»ºç¯å¢ƒç›®å½•</p></blockquote><h4 id="subelements-å­å…ƒç´ å¾ªç¯">subelements å­å…ƒç´ å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  gather_facts: no  connection: local  vars:          users:                  - name: Bob                    gender: male                    age: 18                    content:                            - eating                            - sleeping                            - play ogre                  - name: Maris                    gender: female                    age: 20                    content:                            - eating                            - sleeping                            - shopping  tasks:          - name: test vars 2            debug:                    msg: &quot;&#123;&#123; item.0.name &#125;&#125; - &#123;&#123; item.0.gender &#125;&#125; - &#123;&#123; item.1 &#125;&#125;&quot;            with_subelements:              - &quot;&#123;&#123; users &#125;&#125;&quot;              - content</code></pre><blockquote><p>åˆ†è§£ , é€‰ä¸­åˆ—è¡¨å†…æŸä¸€ä¸ªåˆ—è¡¨å…ƒç´  content, ä¸ä½œä¸ºä¸€ä¸ªä¸´æ—¶æ•´ä½“çš„å‰©ä½™å…ƒç´ æ„å»ºç¬›å¡å°”ç§¯ï¼Œå½¢æˆ item</p></blockquote><h4 id="file-æ–‡ä»¶å¾ªç¯">file æ–‡ä»¶å¾ªç¯</h4><pre><code class="language-yaml">with_file:  /mnt/a.ini  /mnt/b.ini</code></pre><blockquote><p>å§‹ç»ˆå¾ªç¯è·å–ansibleä¸»æœºé‡Œæ–‡ä»¶çš„å†…å®¹ã€‚ï¼ˆä¸ç›®æ ‡ä¸»æœºæ— å…³ï¼‰</p></blockquote><h4 id="fileglob-å¯»æ‰¾é€šé…ç¬¦åŒ¹é…çš„æ–‡ä»¶">fileglob å¯»æ‰¾é€šé…ç¬¦åŒ¹é…çš„æ–‡ä»¶</h4><pre><code class="language-yaml">with_fileglob:  - /home/zyh/test/dirA/*  - /home/zyh/test/dirB/[0-9].ini</code></pre><blockquote><p>å§‹ç»ˆå¾ªç¯è·å–ansibleä¸»æœºæŒ‡å®šç›®å½•ä¸­åŒ¹é…çš„æ–‡ä»¶åå’Œè·¯å¾„ã€‚ï¼ˆä¸ç›®æ ‡ä¸»æœºæ— å…³ï¼‰</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>djangoâ˜ç®¡ç†é™æ€æ–‡ä»¶</title>
      <link href="posts/6a4df400/"/>
      <url>posts/6a4df400/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://docs.djangoproject.com/zh-hans/3.1/howto/static-files/">ç®¡ç†é™æ€æ–‡ä»¶ï¼ˆæ¯”å¦‚å›¾ç‰‡ã€JavaScriptã€CSSï¼‰ | Django æ–‡æ¡£ | Django (djangoproject.com)</a></p><p><a href="https://docs.djangoproject.com/zh-hans/3.1/ref/views/">å†…ç½®è§†å›¾ | Django æ–‡æ¡£ | Django (djangoproject.com)</a></p><h2 id="é€šç”¨è®¾ç½®">é€šç”¨è®¾ç½®</h2><p>é¡¹ç›®.settings.pyä¸­</p><pre><code class="language-python">STATIC_URL = '/static/'if DEBUG:    STATICFILES_DIRS = [        BASE_DIR / &quot;static&quot;,    ]else:    STATIC_ROOT = BASE_DIR / &quot;static&quot;MEDIA_URL = '/media/'MEDIA_ROOT = BASE_DIR / &quot;media</code></pre><h2 id="DEBUGå¼€å¯">DEBUGå¼€å¯</h2><p>æ— éœ€å…¶å®ƒæ”¹åŠ¨</p><h2 id="DEBUGå…³é—­">DEBUGå…³é—­</h2><p>é¡¹ç›®.urls.pyä¸­</p><pre><code class="language-python">from django.views.static import servefrom django.urls import path, include, re_pathfrom . import settingsif not settings.DEBUG:    urlpatterns += [        re_path(r'^media/(?P&lt;path&gt;.*)$', serve, &#123;            'document_root': settings.MEDIA_ROOT,        &#125;),        re_path(r'^static/(?P&lt;path&gt;.*)$', serve, &#123;            'document_root': settings.STATIC_ROOT,        &#125;),    ]</code></pre><h2 id="éƒ¨ç½²é™æ€æ–‡ä»¶">éƒ¨ç½²é™æ€æ–‡ä»¶</h2><pre><code class="language-bash">python manage.py collectstatic --noinput</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>djangoâ˜è®°å¿†ç‚¹</title>
      <link href="posts/3f8b5448/"/>
      <url>posts/3f8b5448/</url>
      
        <content type="html"><![CDATA[<h2 id="gitæ–‡ä»¶">.gitæ–‡ä»¶</h2><pre><code class="language-bash"># Django #*.log*.pot*.pyc__pycache__mediastatic# Backup files #*.bak# other.vscode.gitdblog</code></pre><h2 id="Dockerfile">Dockerfile</h2><pre><code class="language-bash">FROM python:3.8-alpineLABEL maintainer=&quot;aaa103439@hotmail.com&quot;WORKDIR /app COPY . /appRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories &amp;&amp; \    apk update &amp;&amp; \    apk add gcc musl-dev jpeg-dev zlib-dev freetype-dev lcms2-dev openjpeg-dev tiff-dev tk-dev tcl-dev libffi-dev openssl-dev &amp;&amp; \    pip install --upgrade pip &amp;&amp; pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/CMD [&quot;sh&quot;,&quot;/app/start.sh&quot;]</code></pre><h2 id="ç”Ÿæˆ-settings-SECRET-KEY">ç”Ÿæˆ settings.SECRET_KEY</h2><pre><code class="language-python">#!/usr/bin/env python# coding=utf-8from django.core.management.utils import  get_random_secret_keyprint(&quot;åŠ¡å¿…å¦¥å–„ä¿ç®¡å¥½æ­¤å¯†ç &quot;)print(get_random_secret_key())</code></pre><h2 id="è°ƒç”¨-fontawesome-free-å›¾æ ‡åº“">è°ƒç”¨ fontawesome-free å›¾æ ‡åº“</h2><pre><code class="language-bash">pip install fontawesome-free</code></pre><p><code>settings.INSTALLED_APPS</code> ä¸­åŠ å…¥<code>fontawesome-free</code></p><h2 id="å¤–é”®">å¤–é”®</h2><p>å¤–é”®ï¼Œé¡¾åæ€ä¹‰ä¸æ˜¯è‡ªå·±çš„å­—æ®µï¼Œè€Œæ˜¯å¼•ç”¨å…¶å®ƒè¡¨çš„å­—æ®µã€‚</p><blockquote><p>å¤–é”®ä¸æ˜¯é€šè¿‡å­—æ®µåå®šä¹‰çš„ï¼Œè€Œæ˜¯é€šè¿‡ã€å¤–é”®çº¦æŸã€‘å®šä¹‰</p></blockquote><p>å¤–é”®å¯ä»¥å®ç°ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå’Œä¸€å¯¹ä¸€çš„å…³ç³»ã€‚</p><p>å¤–é”®æ—¢å¯ä»¥é€šè¿‡æ•°æ®åº“æ¥çº¦æŸï¼Œä¹Ÿå¯ä»¥ä¸è®¾ç½®çº¦æŸï¼Œä»…ä¾é åº”ç”¨ç¨‹åºçš„é€»è¾‘æ¥ä¿è¯ã€‚</p><p>å­¦ç”Ÿè¡¨ã€studentã€‘æœ‰ä¸»é”®ã€sidã€‘ï¼Œæˆç»©è¡¨ä¹Ÿæœ‰ä¸»é”®ã€sidã€‘, å­¦ç”Ÿè¡¨å’Œæˆç»©è¡¨æ˜¯1å¯¹1çš„å…³ç³»</p><p><img src="/posts/3f8b5448/image-20210716114155366.png" alt="image-20210716114155366"></p><p>å¦‚æœæ²¡æœ‰ã€å¤–é”®çº¦æŸã€‘çš„è§„åˆ™å»ºç«‹ï¼Œåˆ™ä¸¤ä¸ªè¡¨åœ¨æ•°æ®åº“çœ‹æ¥æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œå³ï¼šè¦ä¿æŒä¸¤ä¸ªè¡¨çš„å…³ç³»ï¼Œåˆ™éœ€è¦åº”ç”¨ç¨‹åºå»ä¿è¯é€»è¾‘æ­£ç¡®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåº”ç”¨ç¨‹åºä¸èƒ½æ’å…¥ç›¸åŒå­¦å·çš„æ•°æ®åˆ°è¡¨é‡Œã€‚</p><p>è‹¥åº”ç”¨ç¨‹åºä¸æƒ³å»ç»´æŒï¼Œåˆ™å°±éœ€è¦æ•°æ®åº“ã€å¤–é”®çº¦æŸã€‘å»ç»´æŒã€‚</p><p>åœ¨æ²¡æœ‰djangoçš„æ—¶å€™ï¼Œä½ éœ€è¦ç›´æ¥å†™å…¥SQLè¯­å¥å»å®ç°ã€å¤–é”®çº¦æŸã€‘ï¼Œä¾‹å¦‚</p><pre><code class="language-sql">ALTER TABLE scoresADD CONSTRAINT fk_student_sidFOREIGN KEY (student_sid)REFERENCES student (sid);</code></pre><p>djangoåˆ›å»ºå¤–é”®çº¦æŸçš„æ–¹å¼å¦‚ä¸‹ï¼Œæˆç»©è¡¨çš„ã€sidã€‘å­—æ®µå®šä¹‰å¦‚ä¸‹</p><pre><code class="language-python">sid = models.OneToOneField('student', null=True, on_delete=models.CASCADE)</code></pre><h3 id="ä¸€å¯¹ä¸€-models-OneToOneField">ä¸€å¯¹ä¸€ models.OneToOneField()</h3><p>å¸¸ç”¨äºâ€œæ‰©å±•â€å¦ä¸€ä¸ªæ¨¡å‹çš„ä¸»é”®ï¼Œå°±å¦‚åŒä¸Šè¿°ä¾‹å­ï¼Œæ‰©å±•äº†å­¦ç”Ÿçš„é¢å¤–å±æ€§ã€æˆç»©ã€‘</p><h3 id="ä¸€å¯¹å¤š-models-ForeignKey">ä¸€å¯¹å¤š models.ForeignKey()</h3><p>å¸¸ç”¨äºAåŒ…å«Bï¼Œå¤–é”®å®šä¹‰åœ¨Bè¡¨ä¸­ï¼Œå¼•ç”¨Aè¡¨çš„ä¸»é”®</p><h3 id="å¤šå¯¹å¤š-ManyToManyField">å¤šå¯¹å¤š ManyToManyField()</h3><p>ä½ ä¸­æœ‰æˆ‘ï¼Œæˆ‘ä¸­æœ‰ä½ ï¼Œä¸€ä¸ªç­æœ‰å¤šä¸ªè€å¸ˆï¼Œä¸€ä¸ªè€å¸ˆå¯ä»¥æ•™å¤šä¸ªç­</p><h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3><h3 id="on-delete">on_delete</h3><p>å­—é¢æ„æ€ï¼Œå½“åˆ é™¤çš„æ—¶å€™ï¼Œåº”è¯¥æ€ä¹ˆåš</p><p><code>CASCADE</code>ï¼šåˆ é™¤</p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-ç³»ç»Ÿç›¸å…³</title>
      <link href="posts/84eb900/"/>
      <url>posts/84eb900/</url>
      
        <content type="html"><![CDATA[<h4 id="cron">cron</h4><blockquote><p>crontab è®¡åˆ’ä»»åŠ¡</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>name è®¡åˆ’ä»»åŠ¡æ³¨é‡Šï¼Œå¤šæ¬¡æ“ä½œåŒåä»»åŠ¡ï¼Œåªä¼šä¿®æ”¹ï¼Œè€Œä¸ä¼šæ–°åŠ </p><p>æ—¶é—´å‚æ•°ï¼š</p><ul><li><p>minute hour day month weekday</p></li><li><p>special_time : @reboot @yearly @monthly @weekly @daily @hourly (æ¯xxxæ‰§è¡Œ)</p></li></ul><p>user æ·»åŠ åˆ°æŒ‡å®šç”¨æˆ·è®¡åˆ’ä»»åŠ¡ä¸­</p><p>job è®¡åˆ’ä»»åŠ¡æ‰§è¡Œå‘½ä»¤</p><p>state å½“å€¼ä¸ºabsentæ—¶ï¼ŒæŒ‡åˆ é™¤ä»»åŠ¡. åªéœ€æŒ‡å®š name.</p><p>disabled æ³¨é‡Šä»»åŠ¡ï¼Œè‹¥ä»»åŠ¡ä¿¡æ¯å’Œä¹‹å‰ä¸ä¸€è‡´ï¼Œä¼šåŒæ—¶ä¿®æ”¹ä»»åŠ¡</p><p>backup å…ˆå¤‡ä»½å†æ“ä½œ, å¤‡ä»½æ–‡ä»¶ä½äº /tmp/crontabxxxx</p></blockquote><pre><code class="language-bash">ansible localhost -m cron -a &quot;name='test cron module' user=zyh special_time=hourly job='ls /home/zyh &gt; /home/zyh/cron.log 2&gt;&amp;1'&quot;ansible localhost -m cron -a &quot;name='test cron module' state=absent&quot;</code></pre><h4 id="service">service</h4><blockquote><p>è°ƒç”¨è¿œç¨‹ç³»ç»Ÿè‡ªèº«çš„æœåŠ¡ç®¡ç†æ¨¡å—ï¼Œä¾‹å¦‚ centos6 çš„ service ï¼Œæˆ–è€… centos7 çš„ systemctl</p><p>å‚æ•°ä»‹ç»:</p><p>name æœåŠ¡å</p><p>state æ‰§è¡ŒåŠ¨ä½œ started, stopped, restarted, reloaded</p><p>enabled å¼€æœºè‡ªå¯åŠ¨</p></blockquote><h4 id="user">user</h4><blockquote><p>ç”¨æˆ·ç®¡ç†</p><p>å¸¸ç”¨å‚æ•°ä»‹ç»ï¼š</p><p>name ç”¨æˆ·å</p><p>group ç”¨æˆ·ç»„ groups ç”¨æˆ·é™„åŠ ç»„</p><ul><li>append é¢å¤–é™„åŠ ç”¨æˆ·é™„åŠ ç»„</li></ul><p>shell æŒ‡å®šé»˜è®¤shellï¼Œæ¯”å¦‚/usr/sbin/nologin</p><p>state å€¼ä¸º absent è¡¨ç¤ºåˆ é™¤ç”¨æˆ·ï¼Œå€¼ä¸º present è¡¨ç¤ºç”¨æˆ·å¿…é¡»å­˜åœ¨</p><ul><li>remove åˆ é™¤ç”¨æˆ·æ—¶ï¼ŒåŒæ—¶åˆ é™¤ç”¨æˆ·å®¶ç›®å½•</li></ul><p>password ç”¨æˆ·å¯†ç ã€‚ï¼ˆéœ€è¦ä¼ é€’åŠ å¯†å¯†ç ï¼Œä¸èƒ½æ˜¯æ˜æ–‡å¯†ç ï¼‰</p><pre><code class="language-python">import crypt:passwd=print(crypt.crypt(passwd))</code></pre><p>generate_ssh_key ç›¸å½“äºè¿œç¨‹æ‰§è¡Œ ssh-keygen å‘½ä»¤ï¼ˆä¸åŠ ä»»ä½•å‚æ•°ï¼Œä¸€è·¯å›è½¦ï¼‰ã€‚è‹¥å·²ç»å­˜åœ¨~/.ssh/{id_rsa, id_rsa.pub}, åˆ™ä¸æ‰§è¡Œ</p><ul><li>ssh_key_file è‡ªå®šä¹‰ç§é’¥åå’Œç§é’¥å­˜æ”¾è·¯å¾„, å…¬é’¥ä¹Ÿä¼šåœ¨è‡ªå®šä¹‰è·¯å¾„ä¸‹ç”Ÿæˆ</li></ul></blockquote><h4 id="group">group</h4><blockquote><p>ç®¡ç†ç”¨æˆ·ç»„</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>name ç»„å</p><p>state ç»„çŠ¶æ€, å€¼ä¸º absent æŒ‡åˆ é™¤(ç»„æœ¬èº«å¹¶éç”¨æˆ·ä¸»è¦ç»„)</p></blockquote><h4 id="setup">setup</h4><blockquote><p>è·å–æœºå™¨ä¿¡æ¯</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>gather_subset è·å–æŸä¸ªå­é›†ï¼ˆall, min, hardware, network, virtual, ohai, facterï¼‰</p><p>filter è·å–æŸä¸ªé›†åˆçš„æŸä¸ªkey</p><p>fact_path è‡ªå®šä¹‰ä¿¡æ¯å­˜æ”¾ç›®å½•</p></blockquote><pre><code class="language-ini"># setup é»˜è®¤ä¼šæœç´¢ç›®æ ‡ä¸»æœº/etc/ansible/facts.d ä¸‹çš„è‡ªå®šä¹‰ä¿¡æ¯,ä¾‹å¦‚ family.ini[family]father=Zhangsanson=Zhangxiaosan</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-handle</title>
      <link href="posts/b0929188/"/>
      <url>posts/b0929188/</url>
      
        <content type="html"><![CDATA[<h4 id="åŠŸèƒ½">åŠŸèƒ½</h4><p>ç”¨ä¸€ä¸ªçŸ­è·¯åˆ¤æ–­æ¥è¯´ï¼Œå°±æ˜¯ä¸¤è€…æ˜¯ä¸²è”å…³ç³»ï¼Œhandlers ç”¨æ¥å¤„ç†ä»»åŠ¡åç»­</p><p>tasks &amp;&amp; handlers</p><p>tasks &amp;&amp; handlers - listen ï¼ˆhandlers ç»„ï¼‰</p><h4 id="handlers-çš„-playbook-æ ·æœ¬">handlers çš„ playbook æ ·æœ¬</h4><pre><code class="language-yaml">---- hosts: localhost  become: true  remote_user: root  tasks:  - name: check nginx    shell: /usr/sbin/nginx -t    notify:      log        - meta: flush_handlers     handlers:  - name: log    shell: echo &quot;nginx check success&quot; &gt; ~/playbook.log</code></pre><blockquote><p>å¤šä¸ªtasksçš„æ—¶å€™ï¼Œtasksåé¢çš„ <code>meta: flush_handlers</code> å¯ä»¥è®©tasksæ‰§è¡Œå®Œï¼Œç«‹é©¬æ‰§è¡Œå…³è”çš„handlersã€‚å¦åˆ™handlersä¼šåœ¨æ‰€æœ‰tasksæ‰§è¡Œå®Œåï¼Œæ‰å¼€å§‹æ‰§è¡Œ</p></blockquote><h4 id="handlers-listen-çš„-playbook-æ ·æœ¬">handlers-listen çš„ playbook æ ·æœ¬</h4><pre><code class="language-yaml">---- hosts: localhost  become: true  remote_user: root  tasks:  - name: check nginx    shell: /usr/sbin/nginx -t    notify:      log group    handlers:  - name: log1    listen: log group    shell: echo &quot;nginx check success 1&quot; &gt; ~/playbook.log  - name: log2    listen: log group    shell: echo &quot;nginx check success 2&quot; &gt;&gt; ~/playbook.log</code></pre><blockquote><p>handlers é€šè¿‡ listen ç»‘å®šåœ¨ä¸€èµ·ï¼Œ tasks å…³è” liasten ç»‘å®š handlers ç»„ï¼Œæœ€ç»ˆ playbook.log å°†ä¼šå†™å…¥ä¸¤è¡Œä¿¡æ¯</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> handle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜å¤‡ä»½</title>
      <link href="posts/2c2d50a0/"/>
      <url>posts/2c2d50a0/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æœ¬æ–‡ä¸»è¦è®°å½• redis çš„ä¸¤ç§æ•°æ®ç£ç›˜å›ºåŒ–æ–¹å¼ã€‚<br>æ¶‰åŠåˆ°ç›¸å…³å‚æ•°ï¼Œç®€å•çš„å‘½ä»¤æ“ä½œç­‰ã€‚</p><h4 id="rdb">rdb</h4><blockquote><p>é€šè¿‡forkä¸€ä¸ªå­è¿›ç¨‹æ¥å­˜å‚¨æŸä¸€æ—¶åˆ»redisæ•°æ®(bgsaveæ–¹å¼)ã€‚rdbæŒä¹…åŒ–æ˜¯é»˜è®¤æ–¹å¼ã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><p>å°å¹…åº¦ä¸¢å¤±æ•°æ®(å–å†³äºsaveæˆ–è€…bgsaveå‘½ä»¤çš„æ‰§è¡Œå‘¨æœŸ)ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è¯´saveï¼Œåº”è¯¥ä¸ä¼šç”¨åˆ°è¿™ä¸ª</p></li><li><p>æ¢å¤é€Ÿåº¦å¿«</p></li></ul></blockquote><pre><code class="language-bash"># å‹ç¼©rdbæ–‡ä»¶rdbcompression yes# rdb æ–‡ä»¶åç§°dbfilename redis-6379.rdb# rdbæ–‡ä»¶ä¿å­˜ç›®å½•dir /redis/data/</code></pre><ul><li>æ•°æ®è‡ªåŠ¨å†™å…¥ç­–ç•¥ (æ»¡è¶³ä¸‹åˆ—è§„åˆ™ï¼Œå°±æ‰§è¡Œbgsave)</li></ul><pre><code class="language-bash"># 900så†…è‡³å°‘è¾¾åˆ°ä¸€æ¡å†™å‘½ä»¤save 900 1# 300så†…è‡³å°‘è¾¾è‡³10æ¡å†™å‘½ä»¤save 300 10# 60så†…è‡³å°‘è¾¾åˆ°10000æ¡å†™å‘½ä»¤save 60 10000</code></pre><ul><li>æ•°æ®äººå·¥å†™å…¥ç­–ç•¥ (æ¯10åˆ†é’Ÿè®¡åˆ’ä»»åŠ¡è°ƒç”¨ä¸€æ¬¡bgsave)</li></ul><pre><code class="language-bash">*/10 * * * * root /export/redis/bin/redis-cli -h 127.0.0.1 bgsave &gt;&gt; /export/redis/bgsave.log 2&gt;&amp;1  </code></pre><blockquote><p>bgsave å› éœ€è¦forkå­è¿›ç¨‹ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–é¢„ç•™ç©ºé—²çš„ç‰©ç†å†…å­˜ï¼Œåœ¨overcommit_memory=1å¼€å¯çš„æƒ…å†µä¸‹ï¼Œé¢„ç•™å†…å­˜å¤§å° &gt; å‘¨æœŸå˜åŒ–æ•°æ®å¤§å°</p></blockquote><h4 id="aof">aof</h4><blockquote><p>è®°å½•çš„æ˜¯redisæ¯ä¸€æ¬¡çš„å†™å…¥æ“ä½œè®°å½•</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>æ¢å¤é€Ÿåº¦æ…¢</li><li>ä¸¢å¤±æ•°æ®å°</li></ul></blockquote><pre><code class="language-bash"># å¼€å¯aofæœºåˆ¶appendonly yes# aofæ–‡ä»¶åappendfilename &quot;appendonly.aof&quot;# å†™å…¥ç­–ç•¥,alwaysè¡¨ç¤ºæ¯ä¸ªå†™æ“ä½œéƒ½ä¿å­˜åˆ°aofæ–‡ä»¶ä¸­,ä¹Ÿå¯ä»¥æ˜¯everysecæˆ–noã€‚ everysec æ¯ç§’ä¸€æ¬¡appendfsync everysec# é»˜è®¤ä¸é‡å†™aofæ–‡ä»¶,æ„æ€å°±æ˜¯æ¯æ¬¡ appendfsync å°±å‹ç¼©æ•´åˆaofæ–‡ä»¶ï¼Œé¿å…aofè¿‡å¤§ï¼Œä¸æ¨èå¼€å¯ï¼Œå½±å“æ€§èƒ½no-appendfsync-on-rewrite no# ä¿å­˜ç›®å½•dir /redis/data/</code></pre><ul><li>äººå·¥è®¡åˆ’ä»»åŠ¡é‡å†™</li></ul><pre><code class="language-bash">*/10 * * * * root /export/redis/bin/redis-cli -h 127.0.0.1 bgrewriteaof &gt;&gt; /export/redis/bgrewriteaof.log 2&gt;&amp;1</code></pre><ul><li>aof å› æœåŠ¡å™¨æŒ‚æ‰æŸåå¯ä»¥ä¿®å¤</li></ul><pre><code class="language-bash">redis-check-aof -fix file.aof</code></pre><h4 id="ç»“è®º">ç»“è®º</h4><p>rdb æˆ–è€… aof æ ¹æ®ä¸šåŠ¡äºŒé€‰ä¸€å³å¯ï¼Œæ²¡å¿…è¦éƒ½å¼€å¯ï¼Œä½†æ˜¯ä¸ç®¡æ˜¯å“ªä¸€ç§ï¼Œéƒ½å¯ä»¥åœ¨äººå·¥è®¡åˆ’ä»»åŠ¡ä¹‹åï¼Œå¤åˆ»ä¸€ä»½å¤‡ä»½æ–‡ä»¶åˆ°äº‘ç«¯å¯¹è±¡å­˜å‚¨ä¸­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> å¤‡ä»½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-è½¯ä»¶åŒ…ç®¡ç†</title>
      <link href="posts/3d9b9ec1/"/>
      <url>posts/3d9b9ec1/</url>
      
        <content type="html"><![CDATA[<h4 id="apt-repository">apt_repository</h4><blockquote><p>ubuntu ä¸‹ï¼š</p><p>repo æŒ‡å®šåº“åœ°å€ï¼Œä¾‹å¦‚ nginx åœ°å€ ppa:nginx/stable</p><p>state å€¼ä¸º absent æ—¶ä¸ºåˆ é™¤</p></blockquote><pre><code class="language-bash">ansible localhost -m apt_repository -a &quot;repo=ppa:nginx/stable&quot; -b --ask-become-pass</code></pre><pre><code class="language-bash">localhost | CHANGED =&gt; &#123;    &quot;changed&quot;: true,     &quot;repo&quot;: &quot;ppa:nginx/stable&quot;,     &quot;state&quot;: &quot;present&quot;&#125;#( 04/24/20@ 3:10PM )( zyh@zyh ):~   cat  /etc/apt/sources.list.d/ppa_nginx_stable_bionic.listdeb http://ppa.launchpad.net/nginx/stable/ubuntu bionic main</code></pre><h4 id="apt">apt</h4><blockquote><p>å¸¸ç”¨å‚æ•°ï¼š</p><p>name åŒ…å</p><p>state åŒ…çŠ¶æ€ ï¼ˆabsent-åˆ é™¤ï¼Œlatest-æœ€æ–°åŒ…,  present-é»˜è®¤å®‰è£…ï¼‰ latest ç›¸å½“äºå‡çº§åŒ…</p><p>upgrade å‡çº§ ï¼ˆyesï¼Œdistï¼Œfullï¼Œno-é»˜è®¤ï¼‰</p><p><a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html#apt-module">https://docs.ansible.com/ansible/latest/modules/apt_module.html#apt-module</a></p></blockquote><pre><code class="language-bash">ansible localhost -m apt -a &quot;name=nginx state=present&quot; -b --ask-become-pass</code></pre><pre><code class="language-bash">localhost | CHANGED =&gt; &#123;    &quot;cache_update_time&quot;: 1587713114,     &quot;cache_updated&quot;: false,     &quot;changed&quot;: true,     &quot;stderr&quot;: &quot;&quot;,     &quot;stderr_lines&quot;: [],     &quot;stdout&quot;: &quot;Reading package lists...\nBuilding dependency tree.......</code></pre><h4 id="yum-repository">yum_repository</h4><blockquote><p>name ä»“åº“å</p><p>baseurl ä»“åº“åœ°å€</p><p>enabled ï¼ˆyes-é»˜è®¤ï¼Œno)</p><p>gpgcheck (yes, no)</p><p>gpgcakey æŒ‡å®š gpg ca å…¬é’¥</p><p>state (present-é»˜è®¤ï¼Œabsent-åˆ é™¤)</p></blockquote><pre><code class="language-bash">ansible localhost -m yum_repository -a &quot;name=epel baseurl=https://download.fedoraproject.org/pub/epel/$releasever/$basearch/&quot;</code></pre><h4 id="yum">yum</h4><blockquote><p>name åŒ…å</p><p>state (absent-åˆ é™¤ï¼Œpresent-å®‰è£…-é»˜è®¤å€¼ï¼Œlatest-æ›´æ–°)</p><p>disable_gpg_check å…³é—­gpgæ£€æŸ¥ï¼ˆç”¨äºæºgpgæ£€æŸ¥æ²¡æœ‰çš„æƒ…å†µï¼‰</p><p>enablerepo å®‰è£…åŒ…çš„æ—¶å€™ï¼Œå…ˆä¸´æ—¶å¯ç”¨æŸä¸ªæº</p><p>disablerepo å®‰è£…åŒ…çš„æ—¶å€™ï¼Œå…ˆä¸´æ—¶ç¦ç”¨æŸä¸ªæº</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-å‘½ä»¤è°ƒç”¨</title>
      <link href="posts/1e274151/"/>
      <url>posts/1e274151/</url>
      
        <content type="html"><![CDATA[<h4 id="shell">shell</h4><blockquote><p>è¿œç¨‹æ‰§è¡Œä¸€ä¸ªå‘½ä»¤</p><p>éƒ¨åˆ†å‚æ•°è§£æï¼š</p><p>chdir è¿œç¨‹å·¥ä½œç›®å½•</p><p>executable è¿œç¨‹æ‰§è¡Œshellï¼Œéœ€è¦ç»å¯¹è·¯å¾„</p></blockquote><pre><code class="language-bash">ansible localhost -m shell -a &quot;chdir=/ ls&quot;</code></pre><pre><code class="language-bash">localhost | CHANGED | rc=0 &gt;&gt;binbootdevetchome...</code></pre><h4 id="script">script</h4><blockquote><p>è¿œç¨‹æ‰§è¡Œä¸€ä¸ªansibleä¸»æœºç¯å¢ƒçš„è„šæœ¬</p><p>éƒ¨åˆ†å‚æ•°è§£æï¼š</p><p>chdir è¿œç¨‹å·¥ä½œç›®å½•</p></blockquote><pre><code class="language-bash">cat test.sh#!/bin/bashfor i in `ls /export`;do        echo $idone#-------------ansible -i hosts test -m script -a &quot;/home/zyh/test.sh&quot;</code></pre><pre><code class="language-bash">10.200.10.212 | CHANGED =&gt; &#123;    &quot;changed&quot;: true,     &quot;rc&quot;: 0,     &quot;stderr&quot;: &quot;Shared connection to 10.200.10.212 closed.\r\n&quot;,     &quot;stderr_lines&quot;: [        &quot;Shared connection to 10.200.10.212 closed.&quot;    ],     &quot;stdout&quot;: &quot;jdk1.8.0_191\r\njdk8\r\nsen\r\n&quot;,     &quot;stdout_lines&quot;: [        &quot;jdk1.8.0_191&quot;,         &quot;jdk8&quot;,         &quot;sen&quot;    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-æ–‡æœ¬æ–‡ä»¶æ“ä½œ</title>
      <link href="posts/4235ddf4/"/>
      <url>posts/4235ddf4/</url>
      
        <content type="html"><![CDATA[<h2 id="æ–‡æœ¬æ“ä½œ">æ–‡æœ¬æ“ä½œ</h2><h4 id="file">file</h4><blockquote><p>path æ–‡ä»¶å¯¹è±¡åœ°å€<br>state æ–‡ä»¶ç±»å‹æˆ–è€…åŠ¨ä½œçŠ¶æ€ ï¼ˆtouch: é’ˆå¯¹æ–‡ä»¶, directoryï¼šé’ˆå¯¹ç›®å½•, linkï¼šé’ˆå¯¹è½¯è¿æ¥, hardï¼šé’ˆå¯¹ç¡¬é“¾æ¥)</p><p>src è½¯ç¡¬é“¾æ¥çš„æºæ–‡ä»¶</p><p>owner å±ä¸»</p><p>group å±ç»„</p><p>mode æ•°å­—æƒé™</p><p>recurse é€’å½’æ“ä½œ</p></blockquote><h4 id="blockinfile">blockinfile</h4><blockquote><p>åœ¨æŒ‡å®šä½ç½®ï¼Œæ’å…¥æ–‡æœ¬å—ï¼Œå¹¶åœ¨æ–‡æœ¬å—å¼€å¤´å’Œç»“å°¾æ·»åŠ æ ‡è®°. æ ‡è®°ç”¨æ¥ç¡®è®¤æ–‡æœ¬å—çš„ä½ç½®ï¼Œä¸€äº›å‚æ•°ä¼šé€šè¿‡æ ‡è®°ä½ç½®æ¥ä¿®æ”¹æ–‡æœ¬å—ã€‚</p><p>æ³¨é‡Šæ ¼å¼:</p><p># BEGIN xxx</p><p># END xxx</p><p>å‚æ•°ç®€ä»‹ï¼š</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€</p><p>block éœ€è¦æ·»åŠ çš„æ–‡æœ¬å—</p><p>marker è‡ªå®šä¹‰æ ‡è®° xxx éƒ¨åˆ†ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒæ ‡è®°ï¼Œåˆ™ä¼˜å…ˆå¤„ç†ç›¸åŒæ ‡è®°çš„æ–‡æœ¬å—ã€‚</p><p>state çŠ¶æ€ä¸ºabsentæ—¶ï¼Œåˆ é™¤æ ‡è®°åŒ…æ‹¬çš„æ–‡æœ¬å—</p><p>insertafter æ­£åˆ™æˆ–è€…EOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å</p><p>insertbefore æ­£åˆ™æˆ–è€…BOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å‰</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œï¼Œå¤‡ä»½æ–‡ä»¶åç¼€æ˜¯æ—¶é—´æˆ³</p><p>create æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</p></blockquote><pre><code class="language-bash"># è¿™æ¡å‘½ä»¤ä¸­ï¼Œå¦‚æœmarkeræ ‡è®°å·²ç»å­˜åœ¨ï¼Œåˆ™insertafterå°†æ— æ•ˆ-m blockinfile -a 'path= block=&quot; &quot; marker=&quot;#&#123;mark&#125; xxx&quot; insertafter=&quot;æ­£åˆ™&quot;'</code></pre><h4 id="lineinfile">lineinfile</h4><blockquote><p>æ ¹æ®æŒ‡å®šçš„å†…å®¹ï¼Œè¿›è¡Œæ›¿æ¢æˆ–åˆ é™¤</p><p>å‚æ•°ç®€ä»‹ï¼š</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€ã€‚</p><p>line æŒ‡å®šè¡Œå†…å®¹ï¼ˆåœ¨æ²¡æœ‰æ­£åˆ™çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å…¨åŒ¹é…ï¼‰ã€‚</p><p>regexp é€šè¿‡æ­£åˆ™åŒ¹é…è¡Œï¼Œå¹¶å°†æ­¤è¡Œæ›¿æ¢æˆ line æŒ‡å®šçš„å†…å®¹ï¼Œregexpæœ‰é¢å¤–æ‰©å±•å‚æ•°ï¼Œä¾‹å¦‚ backrefã€‚</p><ul><li><p>line  è‹¥lineåŒ¹é…åˆ°æŸè¡Œï¼Œåˆ™ä¸ä¿®æ”¹ï¼Œè‹¥æ— åŒ¹é…ï¼Œåˆ™æ·»åŠ lineè‡³æœ«å°¾ã€‚</p></li><li><p>regexp + line  è‹¥æœ‰regexpåŒ¹é…åˆ°æŸè¡Œï¼Œæ›¿æ¢åŒ¹é…è¡Œä¸ºlineï¼›å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™å°†lineè¿½åŠ åˆ°è¡Œå°¾ã€‚æ­¤æ—¶ï¼Œregexpä¸æ”¯æŒåˆ†ç»„ã€‚</p></li><li><p>regexp + backrefs ï¼ˆtrueï¼‰+ line  è‹¥æœ‰regexpåŒ¹é…åˆ°æŸè¡Œï¼Œæ›¿æ¢åŒ¹é…è¡Œä¸ºlineï¼›å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™ä¿æŒæºæ–‡ä»¶ä¸å˜ï¼›æ­¤æ—¶ï¼Œregexpæ”¯æŒåˆ†ç»„ã€‚</p></li></ul><p>state çŠ¶æ€ä¸ºabsentæ—¶ï¼Œåˆ é™¤åŒ¹é…è¡Œ</p><p>insertafter æ­£åˆ™æˆ–è€…EOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å</p><p>insertbefore æ­£åˆ™æˆ–è€…BOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å‰</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œ</p><p>create æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</p></blockquote><pre><code class="language-bash">-m lineinfile -a 'path= line=&quot; &quot; insertafter=&quot;æ­£åˆ™&quot;'</code></pre><h4 id="replace">replace</h4><blockquote><p>æ›¿æ¢æ–‡ä»¶å¯¹è±¡ä¸­ç¬¦åˆåŒ¹é…çš„å­—ç¬¦ä¸²</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€</p><p>regexp æ­£åˆ™åŒ¹é…</p><p>replace æ›¿æ¢åçš„å­—ç¬¦ä¸²</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œ</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-aws</title>
      <link href="posts/15aa7d2e/"/>
      <url>posts/15aa7d2e/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://github.com/ansible/ansible/blob/stable-2.9/contrib/inventory/">https://github.com/ansible/ansible/blob/stable-2.9/contrib/inventory/</a></p><p><a href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html">https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html</a></p><p><a href="https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#inventory-script-example-aws-ec2">https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#inventory-script-example-aws-ec2</a> ï¼ˆæ·±å‘ï¼Œè„šæœ¬404ï¼Œæ‰¾åˆ°äº†è„šæœ¬ï¼Œå„ç§é”™è¯¯ï¼Œè¯·æ‰”ä¸€è¾¹ï¼‰</p></blockquote><h3 id="å‰è¨€">å‰è¨€</h3><p>é€šè¿‡ ansible è·å–å¤§åŒºä¸‹ ec2 èµ„æºä¿¡æ¯</p><h3 id="æˆæƒ">æˆæƒ</h3><pre><code class="language-shell">export AWS_ACCESS_KEY_ID='AK123'export AWS_SECRET_ACCESS_KEY='abc123'export EC2_INI_PATH=ec2.ini</code></pre><h3 id="åº“å­˜-inventory">åº“å­˜(inventory)</h3><pre><code class="language-ini">[local]localhost</code></pre><h3 id="Playbook">Playbook</h3><pre><code class="language-yaml">---  - name: test ec2    hosts: local    gather_facts: no   # æˆ‘ä»¬è¦è¿™ä¿¡æ¯å¹²ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æ˜¯æœ‰ç›®æ ‡çš„    connection: local # æœ¨æœ‰å®šä¹‰èµ„æº    tasks:      - name: get ec2 info        ec2_instance_info:          region: cn-north-1        register: data_output      - name: show ec2 info        debug:          msg: &quot;&#123;&#123; data_output|json_query('instances[*].network_interfaces[*].private_ip_address') &#125;&#125;&quot;</code></pre><h3 id="æ‰§è¡Œ">æ‰§è¡Œ</h3><pre><code class="language-shell">ansible-playbook -i hosts ec2.yml</code></pre><h3 id="è¾“å‡º">è¾“å‡º</h3><pre><code class="language-shell">TASK [show ec2 info] ******************************************************************************************************************************************************ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        [            &quot;10.100.10.250&quot;        ],         [            &quot;10.100.10.252&quot;        ],         [            &quot;10.100.10.210&quot;        ],         [            &quot;10.100.10.251&quot;        ]    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aws </tag>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows åŒ…ç®¡ç†å·¥å…· scoop</title>
      <link href="posts/22b82d75/"/>
      <url>posts/22b82d75/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-powershell">Set-ExecutionPolicy RemoteSigned -scope CurrentUseriwr -useb get.scoop.sh | iexscoop install aria2scoop config aria2-max-connection-per-server 16scoop config aria2-split 16scoop config aria2-min-split-size 1Mscoop install git scoop bucket add extrasscoop install windows-terminal</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows </tag>
            
            <tag> scoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜å®‰è£…å’ŒåŸºæœ¬é…ç½®</title>
      <link href="posts/d9cdb70/"/>
      <url>posts/d9cdb70/</url>
      
        <content type="html"><![CDATA[<h1>å®‰è£…Jenkins Master</h1><blockquote><p><a href="https://github.com/jenkinsci/docker/blob/master/README.md">https://github.com/jenkinsci/docker/blob/master/README.md</a></p></blockquote><h2 id="é€šè¿‡äºŒè¿›åˆ¶å®‰è£…">é€šè¿‡äºŒè¿›åˆ¶å®‰è£…</h2><p>ç•¥è¿‡ã€‚ã€‚ã€‚</p><h2 id="é€šè¿‡å®¹å™¨å®‰è£…">é€šè¿‡å®¹å™¨å®‰è£…</h2><p>é€šè¿‡ <a href="https://hub.docker.com/r/jenkins/jenkins/tags?page=1&amp;name=2.318">https://hub.docker.com/r/jenkins/jenkins/tags?page=1&amp;name=2.318</a> è¿‡æ»¤ç‰ˆæœ¬</p><pre><code class="language-bash"># å®šä¹‰ç‰ˆæœ¬ï¼Œä¾‹å¦‚centos7+jdk8çš„jenkinsjenkinsTag=2.318-centos7-jdk8# å®šä¹‰jenkinsä¸»æœåŠ¡è®¿é—®ç«¯å£jenkinsPort=18080# å®šä¹‰å®¹å™¨æ‰€ç”¨çš„dnsjenkinsDns=119.29.29.29# å®šä¹‰jenkinsçš„webåŸŸåjenkinsDomain=docker volume create jenkins_homedocker run --name jenkins_$&#123;jenkinsTag&#125; \--hostname $&#123;jenkinsDomain&#125; \--restart always \--mount 'type=volume,src=jenkins_home,dst=/var/jenkins_home' \-p $&#123;jenkinsPort&#125;:8080 \-p 50000:50000 \--dns $&#123;jenkinsDns&#125; \-d jenkins/jenkins:$&#123;jenkinsTag&#125;echo &quot;docker run --name jenkins_$&#123;jenkinsTag&#125; --hostname $&#123;jenkinsDomain&#125;  --restart always --mount 'type=volume,src=jenkins_home,dst=/var/jenkins_home' -p $&#123;jenkinsPort&#125;:8080 -p 50000:50000 --dns $&#123;jenkinsDns&#125; -d jenkins/jenkins:$&#123;jenkinsTag&#125;&quot; &gt; docker-jenkins-install.command</code></pre><ol><li>è°ƒç”¨å®¿ä¸»æœº docker å‘½ä»¤æ‰€éœ€çš„ä¾èµ–(ä¸ä¸€å®šå¯ç”¨ï¼Œç‰¹åˆ«æ˜¯æœ€åä¸€ä¸ªåº“æ–‡ä»¶ï¼Œä¸åŒç‰ˆæœ¬ä½ç½®ä¸ä¸€å®šä¸€è‡´)</li></ol><blockquote><p>ä¸æ¨èåœ¨Masterä¸Šè¿›è¡Œæ­¤æ“ä½œï¼›</p><p>æ¨èå»ºè®®åœ¨é¢å¤–Nodeä¸Šå®‰è£…dockerï¼Œå¹¶å·²äºŒè¿›åˆ¶æ–¹å¼è¿è¡Œagent.jarï¼Œæˆæƒagent.jaræ‰§è¡Œç”¨æˆ·è®¿é—®dockerå‘½ä»¤ï¼Œä»è€Œé¿å…æ­¤é—®é¢˜</p></blockquote><pre><code class="language-bash">--mount 'type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock' \--mount 'type=bind,src=/usr/bin/docker,dst=/usr/bin/docker' \--mount 'type=bind,src=/usr/lib64/libltdl.so.7,dst=/usr/lib/x86_64-linux-gnu/libltdl.so.7'</code></pre><ol start="2"><li>å¦‚æœç§æœ‰gitä¸å¯¹å¤–ï¼Œåˆ™æ·»åŠ é¢å¤–çš„hostè§£æ</li></ol><pre><code class="language-bash">#å®šä¹‰ç§æœ‰gitæœåŠ¡çš„åŸŸågitlabDomain=#å®šä¹‰ç§æœ‰gitæœåŠ¡çš„ipgitlabWanIP=--add-host $gitlabDomain&#125;:$&#123;gitlabWanIP&#125;</code></pre><ol start="3"><li>å®¿ä¸»æœºæ·»åŠ hostså†…ç½‘è§£æ</li></ol><pre><code class="language-bash">localIP=`curl http://100.100.100.200/latest/meta-data/private-ipv4`echo &quot;$&#123;localIP&#125; $&#123;jenkinsDomain&#125;&quot; &gt;&gt; /etc/hosts</code></pre><blockquote><p>ä¸Šè¿°localIPçš„è·å–ä»…é€‚ç”¨äºé˜¿é‡Œäº‘ecsï¼Œå¦‚æœä½ ä¸æ˜¯ï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤è·å–ï¼Œä¸ä¸€å®šä¿è¯å¯è¡Œ<br>localIP=<code>ip addr show | grep -A3 &quot; eth0&quot; | grep &quot;inet &quot; | awk -F&quot;/&quot; '&#123;print $1&#125;' | awk '&#123;print $NF&#125;'</code></p></blockquote><h2 id="é€šè¿‡è®¿é—®WEBç•Œé¢åˆå§‹åŒ–å®‰è£…è¿‡ç¨‹">é€šè¿‡è®¿é—®WEBç•Œé¢åˆå§‹åŒ–å®‰è£…è¿‡ç¨‹</h2><p>æµè§ˆå™¨è®¿é—®ï¼šhttp://<jenkinsDomain>:18080</jenkinsDomain></p><ol><li>è§£é”ç§˜é’¥ï¼š</li></ol><p>æ ¹æ®é¡µé¢æç¤ºè®¿é—®ã€å®¹å™¨é‡Œçš„ã€‘<code>/var/jenkins_home/secrets/initialAdminPassword</code>è·å¾—è§£é”ç§˜é’¥</p><pre><code class="language-bash">docker exec -it jenkins_$&#123;jenkinsTag&#125; /bin/bash cat /var/jenkins_home/secrets/initialAdminPassword</code></pre><ol start="2"><li>æ’ä»¶å®‰è£…ï¼šé€‰æ‹©ã€å®‰è£…æ¨èçš„æ’ä»¶ã€‘</li><li>ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºï¼Œå¹¶ç‚¹å‡»ã€ä½¿ç”¨adminè´¦æˆ·ç»§ç»­ã€‘ï¼Œå¹¶ç‚¹å‡»ã€ä¿å­˜å®Œæˆã€‘</li></ol><h2 id="æ·»åŠ é¢å¤–çš„Jenkins-NodeèŠ‚ç‚¹">æ·»åŠ é¢å¤–çš„Jenkins NodeèŠ‚ç‚¹</h2><p>é»˜è®¤æ²¡æœ‰ç‹¬ç«‹çš„NodeèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤æƒ…å†µä¸‹æ„å»ºæ˜¯è¿è¡Œåœ¨Jenkins Masteræœ¬èº«æ‰€åœ¨å®¹å™¨ä¸Šã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªé¢å¤–çš„NodeèŠ‚ç‚¹ï¼Œå¹¶å®‰è£…æ„å»ºæ‰€éœ€çš„ç¯å¢ƒã€‚</p><p>è·¯å¾„ï¼š[manage jenkins]-[manage nodes and clouds]-[create node]</p><p><img src="/posts/d9cdb70/image-20211102164349471.png" alt="image-20211102164349471"></p><p>ä¿å­˜ä¹‹åï¼Œåœ¨åˆ—è¡¨é‡Œç‚¹å‡»åˆ›å»ºçš„ã€agent01ã€‘å³å¯ä»¥çœ‹åˆ°å¦‚ä½•åœ¨æ–°Nodeé‡Œè¿è¡Œã€‚ä¾‹å¦‚ï¼š</p><pre><code class="language-bash"># åˆ›å»ºç›®å½•(æˆªå›¾é‡Œå¡«å…¥çš„åœ°å€)mkdir -p &lt;è¿œç¨‹å·¥ä½œç›®å½•&gt;/&lt;å†…éƒ¨æ•°æ®ç›®å½•&gt;# æˆæƒå¯†ç echo 6ffa296c09a3bee21e7217d &gt; secret-file# è¿è¡Œå‘½ä»¤nohup java -jar agent.jar -jnlpUrl http://$&#123;jenkinsDomain&#125;:18080/computer/agent01/jenkins-agent.jnlp -secret @secret-file -workDir &quot;/export/jenkins_agent_home&quot; -failIfWorkDirIsMissing &gt;&gt; agent.log &amp;# å°†è¿è¡Œå‘½ä»¤å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼Œæ–¹ä¾¿ä¹‹åå¯åŠ¨echo &quot;nohup java -jar agent.jar -jnlpUrl http://$&#123;jenkinsDomain&#125;:18080/computer/agent01/jenkins-agent.jnlp -secret @secret-file -workDir &quot;/export/jenkins_agent_home&quot; -failIfWorkDirIsMissing &gt;&gt; agent.log &amp;&quot; &gt; jenkins_agent.command</code></pre><blockquote><ol><li>ä½ éœ€è¦æå‰åœ¨NodeèŠ‚ç‚¹ä¸Šå®‰è£…ä¸€ä¸ªjdkç¯å¢ƒ</li><li>ä½ éœ€è¦å…ˆä¸‹è½½ä»£ç†ç¨‹åº agent.jarï¼Œä¸‹è½½åœ°å€ä½äºJenkins MasteræœåŠ¡ï¼š<a href="http://$">http://$</a>{jenkinsDomain}:18080/jnlpJars/agent.jar</li></ol></blockquote><h1>é…ç½®Jenkins Nodeæ„å»ºç¯å¢ƒ</h1><ol><li>å®‰è£…awscliã€ansibleã€aliyun</li></ol><pre><code class="language-bash">cd /export/jenkins_agent_home[[ -d src ]] || mkdir srccd srccurl https://bootstrap.pypa.io/get-pip.py -o get-pip.pymkdir ~/.pip/cat &gt; ~/.pip/pip.conf &lt;&lt; EOF[global]index-url = https://mirrors.aliyun.com/pypi/simple/[install]trusted-host=mirrors.aliyun.comEOFyum install python3python3 get-pip.pypip install awsclipip install ansiblecurl 'https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz' -o aliyun-cli-linux-latest-amd64.tgztar xf aliyun-cli-linux-latest-amd64.tgzcp aliyun /usr/bin/</code></pre><blockquote><p>å¦‚æœ <a href="http://get-pip.py">get-pip.py</a> æ— æ³•ä¸‹è½½ï¼Œå¯ä»¥è®¿é—®é“¾æ¥ï¼š<a href="https://www.aliyundrive.com/s/aVJppvovbCf">https://www.aliyundrive.com/s/aVJppvovbCf</a> ä¸‹è½½</p></blockquote><ol start="2"><li>è°ƒç”¨å®¿ä¸»æœºdockerå‘½ä»¤</li></ol><pre><code class="language-bash">usermod -aG docker jenkins</code></pre><h1>WEBç•Œé¢çš„é¢å¤–é…ç½®</h1><h2 id="å…¶å®ƒæ’ä»¶å®‰è£…">å…¶å®ƒæ’ä»¶å®‰è£…</h2><p>è¾“å‡ºç€è‰²ï¼š<a href="https://plugins.jenkins.io/ansicolor"> AnsiColor</a></p><p>æ–°ç•Œé¢ï¼š<a href="https://plugins.jenkins.io/blueocean">Blue Ocean</a></p><p>æ„å»ºè¶…æ—¶ï¼š<a href="https://plugins.jenkins.io/build-timeout">Build Timeout</a></p><p>æ„å»ºæœŸé—´ç”¨æˆ·ä¿¡æ¯ï¼š<a href="https://plugins.jenkins.io/build-user-vars-plugin">build user vars plugin</a></p><p>HTTPè¯·æ±‚æ’ä»¶ï¼š<a href="https://plugins.jenkins.io/http_request">HTTP Request</a></p><p>Kubernetesï¼š<a href="https://plugins.jenkins.io/kubernetes">Kubernetes</a></p><p>ä¸­æ–‡åŒ…ï¼š<a href="https://plugins.jenkins.io/localization-zh-cn">Localization: Chinese (Simplified)</a></p><p>ç”¨æˆ·è§’è‰²ç®¡ç†ï¼š<a href="https://plugins.jenkins.io/role-strategy">Role-based Authorization Strategy</a></p><p>æ—¶é—´æˆ³ï¼š<a href="https://plugins.jenkins.io/timestamper">Timestamper</a></p><p>å·¥ä½œç©ºé—´æ¸…é“å¤«ï¼š<a href="https://plugins.jenkins.io/ws-cleanup">Workspace Cleanup</a></p><h2 id="ç”¨æˆ·å’Œè§’è‰²ç®¡ç†">ç”¨æˆ·å’Œè§’è‰²ç®¡ç†</h2><ol><li><p>å®‰è£…æ’ä»¶ Role-based Authorization Strategy</p></li><li><p>å¯ç”¨æ’ä»¶ Configure Global Security ä¸­å¯ç”¨ Role-Based Strategy ç­–ç•¥</p><p><img src="/posts/d9cdb70/image-20200515180703925.png" alt="image-20200515180703925"></p></li><li><p>é…ç½®å…¨å±€è§’è‰²å’Œé¡¹ç›®è§’è‰² Manage and Assign Roles - Manage Roles</p><p>å…¨å±€è§’è‰²<strong>Global roles</strong> è®¾ç½®ä¸¤ä¸ªï¼š admin å’Œ read</p><p><img src="/posts/d9cdb70/image-20200515181449965.png" alt="image-20200515181449965"></p><p>é¡¹ç›®è§’è‰²<strong>Project roles</strong>ï¼šæ¯ä¸€ä¸ªé¡¹ç›®è®¾ç½®ä¸€ä¸ª</p><p>Pattern: <code>.*\.&lt;é¡¹ç›®å&gt; </code></p><p>æƒé™: çœ‹å›¾</p><p><img src="/posts/d9cdb70/image-20200515181359533.png" alt="image-20200515181359533"></p></li><li><p>åˆ›å»ºé¡¹ç›®ç”¨æˆ·</p></li><li><p>åˆ†é…è§’è‰² Manage and Assign Roles - Assign Roles</p><p>ç»™ç®¡ç†å‘˜åˆ†é… adminï¼Œç»™é¡¹ç›®ç”¨æˆ·åˆ†é… read å’Œ cp (cpæ˜¯æˆ‘è®¾ç½®çš„é¡¹ç›®è§’è‰²)</p><p><img src="/posts/d9cdb70/image-20200515181740598.png" alt="image-20200515181740598"></p></li></ol><ul><li><p>å®‰è£…é…ç½®æ–‡ä»¶æ’ä»¶ Config File Provider</p></li><li><p>è‡ªåŠ¨å®‰è£… git ï¼Œjdkï¼Œmaven ï¼ˆè¿™ç§æ–¹å¼åªæœ‰åœ¨è¿›è¡Œäº†ä¸€æ¬¡æ„å»ºåï¼Œæ‰ä¼šå®‰è£…ï¼‰</p></li><li><p>maven ç§æœé…ç½®æ–‡ä»¶</p><ol><li><p>é€šè¿‡ Config File Provider æ·»åŠ ä¸€ä¸ªé¡¹ç›®mavené…ç½®</p></li><li><pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;          xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;          xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt;  &lt;servers&gt;    &lt;server&gt;     &lt;id&gt;&lt;Repository Policyå&gt;&lt;/id&gt;     &lt;username&gt;&lt;/username&gt;     &lt;password&gt;&lt;/password&gt;    &lt;/server&gt;    &lt;server&gt;     &lt;id&gt;&lt;Repository Policyå&gt;&lt;/id&gt;      &lt;username&gt;&lt;/username&gt;      &lt;password&gt;&lt;/password&gt;    &lt;/server&gt;  &lt;/servers&gt;  &lt;profiles&gt;  &lt;profile&gt;&lt;id&gt;&lt; ä»“åº“å &gt;&lt;/id&gt;&lt;repositories&gt;  &lt;repository&gt;&lt;id&gt;&lt;maven ä»“åº“ç»„æˆ–ä»“åº“ID&gt;&lt;/id&gt;&lt;url&gt;&lt;maven ç§æœå…·ä½“ä»“åº“ç»„æˆ–ä»“åº“åœ°å€&gt;&lt;/url&gt;&lt;releases&gt;  &lt;enabled&gt;true&lt;/enabled&gt;&lt;/releases&gt;&lt;snapshots&gt;  &lt;enabled&gt;true&lt;/enabled&gt;&lt;/snapshots&gt;  &lt;/repository&gt;&lt;/repositories&gt;  &lt;/profile&gt;  &lt;/profiles&gt;  &lt;activeProfiles&gt; &lt;activeProfile&gt;é¡¹ç›®å&lt;/activeProfile&gt;  &lt;/activeProfiles&gt;&lt;/settings&gt;</code></pre></li><li><p>ç„¶åæ„å»ºé¡¹ç›®çš„æ—¶å€™ï¼Œæ„å»ºç¯å¢ƒ-Provide Configuration files-Filesï¼Œå¹¶ä¸”Build-é«˜çº§-Settings file-Provided settings.xml</p></li></ol></li></ul>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fpmâ˜å®‰è£…-åŒ…ç®¡ç†æ–¹å¼</title>
      <link href="posts/b73a61bf/"/>
      <url>posts/b73a61bf/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä»‹ç»å¦‚ä½•é€šè¿‡yumæˆ–è€…apt-getå®‰è£…phpå’Œphp-fpm<br>é€‚åˆphp7.2</p><h4 id="centos">centos</h4><blockquote><p>å®‰è£…æº <a href="https://webtatic.com/">https://webtatic.com/</a></p></blockquote><pre><code class="language-bash">yum install epel-releaserpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpmyum install gcc-c++ geoip-devel -yyum install php72w-cli php72w-devel mod_php72w php72w-fpm php72w-opcache php72w-gd php72w-bcmath php72w-xml -y# php72w-lzo php72w-yaf æ²¡æœ‰ç›´æ¥çš„åŒ…mkdir /export/logs/php -pcd /etc/php-fpm.d/ &amp;&amp; mv www.conf www.conf.bakwebName=wwwcat &gt; www.conf &lt;&lt; EOF[$&#123;webName&#125;]user = webappsgroup = webappslisten = 0.0.0.0:9000pm = staticpm.max_children = 20pm.max_requests = 1024pm.status_path = /php-fpm_statusrequest_slowlog_timeout = 2sslowlog = /export/logs/php/php-slow.logphp_admin_value[error_log] = /export/logs/php/www-error.logphp_admin_flag[log_errors] = onphp_value[session.save_handler] = filesphp_value[session.save_path]    = /var/lib/php/sessionphp_value[soap.wsdl_cache_dir]  = /var/lib/php/wsdlcacheEOF# å®‰è£…æºä¸­æ²¡æœ‰çš„æ¨¡å—, å‡è®¾æ¨¡å—æ˜¯rediscd /usr/local/srcphpModule=yafwget https://pecl.php.net/get/$&#123;phpModule&#125; &amp;&amp; mkdir $&#123;phpModule&#125;-src &amp;&amp; tar xf $&#123;phpModule&#125; --strip-components 1 -C $&#123;phpModule&#125;-srccd $&#123;phpModule&#125;-src &amp;&amp; phpize &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make installcat &gt; /etc/php.d/$&#123;phpModule&#125;.ini &lt;&lt; EOF; Enable zip extension moduleextension=$&#123;phpModule&#125;.soEOF</code></pre><h4 id="ubuntu">ubuntu</h4><pre><code class="language-bash">add-apt-repository ppa:ondrej/phpapt-get install php7.2 php7.2-dev php7.2-fpm php7.2-mysql php7.2-curl php7.2-json php7.2-mbstring php7.2-xml  php7.2-intl php7.2-yac php7.2-yaf php7.2-redis php7.2-lzo php7.2-geoip php7.2-pecl php7.2-pear php7.2-dev php7.2-gd php7.2-zip php7.2-xml php7.2-bcmath</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> fpm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜åŸºç¡€ä¿¡æ¯</title>
      <link href="posts/d3e413b7/"/>
      <url>posts/d3e413b7/</url>
      
        <content type="html"><![CDATA[<h3 id="å®‰è£…">å®‰è£…</h3><pre><code class="language-shell">apt-get install python3-pippip3 install ansible --user -i https://pypi.tuna.tsinghua.edu.cn/simple</code></pre><blockquote><p>pip å®‰è£…æ–¹å¼ï¼Œä¸ä¼šç”Ÿæˆé»˜è®¤é…ç½®<br><a href="https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg">https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg</a></p></blockquote><h3 id="å…³é—­-known-hosts-æ£€æŸ¥">å…³é—­ known_hosts æ£€æŸ¥</h3><pre><code class="language-ini"># /etc/ansible/ansible.cfg or ~/.ansible.cfg[defaults]host_key_checking = False</code></pre><h3 id="åº“å­˜å’Œå˜é‡">åº“å­˜å’Œå˜é‡</h3><pre><code class="language-ini"># /etc/ansible/hosts é»˜è®¤ä½ç½®ï¼Œä½†å¯è‡ªå®šä¹‰ï¼Œå¹¶é€šè¿‡ -i æ¥è°ƒç”¨############################################################################# å•ä¸»æœºmail.example.com# http_port ä¸»æœºå˜é‡[webservers]www[01:50].example.comhttp_port=80[dbservers]db-[a:f].example.comansible_connection=ssh        ansible_ssh_user=mysql# ç»„å˜é‡ ==&gt; ç»„å:vers[dbservers:vars]mysql_port=3306# åµŒå¥—ç»„ ==&gt; çˆ¶ç»„:children[webproject:children]webserversdbservers</code></pre><blockquote><p>ä¸­æ‹¬å·è¡¨ç¤ºåˆ†ç»„ï¼Œå¯ä»¥ç”¨ç»„åä»£æ›¿ç»„èµ„æº ;</p></blockquote><h3 id="ç»“æ„åŒ–å˜é‡">ç»“æ„åŒ–å˜é‡</h3><blockquote><p>é‡‡ç”¨ yaml é…ç½®ï¼Œæ ¼å¼ï¼š</p><pre><code class="language-yaml">---  å˜é‡:å€¼</code></pre></blockquote><pre><code class="language-shell">/etc/ansible/group_vars/&lt;ç»„å&gt; # &lt;ç»„å&gt;æ–‡ä»¶æˆ–è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œå‡ä¼šè¢«è®¤ä¸ºæ˜¯&lt;ç»„å&gt;å˜é‡/etc/ansible/host_vars/&lt;ä¸»æœºå&gt; # &lt;ä¸»æœºå&gt;æ–‡ä»¶æˆ–è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œå‡ä¼šè¢«è®¤ä¸ºæ˜¯&lt;ç»„å&gt;å˜é‡</code></pre><h4 id="å¸¸ç”¨çš„å˜é‡">å¸¸ç”¨çš„å˜é‡</h4><pre><code class="language-shell">ansible_ssh_host      å°†è¦è¿æ¥çš„è¿œç¨‹ä¸»æœºå.ä¸ä½ æƒ³è¦è®¾å®šçš„ä¸»æœºçš„åˆ«åä¸åŒçš„è¯,å¯é€šè¿‡æ­¤å˜é‡è®¾ç½®.ansible_ssh_port      sshç«¯å£å·.å¦‚æœä¸æ˜¯é»˜è®¤çš„ç«¯å£å·,é€šè¿‡æ­¤å˜é‡è®¾ç½®.ansible_ssh_user      é»˜è®¤çš„ ssh ç”¨æˆ·åansible_ssh_pass      ssh å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨,æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-pass æˆ– SSH å¯†é’¥)ansible_sudo_pass      sudo å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨,æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨ -b --ask-become-pass)ansible_sudo_exe (new in version 1.8)      sudo å‘½ä»¤è·¯å¾„(é€‚ç”¨äº1.8åŠä»¥ä¸Šç‰ˆæœ¬)ansible_connection      ä¸ä¸»æœºçš„è¿æ¥ç±»å‹.æ¯”å¦‚:local, ssh æˆ–è€… paramiko. Ansible 1.2 ä»¥å‰é»˜è®¤ä½¿ç”¨ paramiko.1.2 ä»¥åé»˜è®¤ä½¿ç”¨ 'smart','smart' æ–¹å¼ä¼šæ ¹æ®æ˜¯å¦æ”¯æŒ ControlPersist, æ¥åˆ¤æ–­'ssh' æ–¹å¼æ˜¯å¦å¯è¡Œ.ansible_ssh_private_key_file      ssh ä½¿ç”¨çš„ç§é’¥æ–‡ä»¶.é€‚ç”¨äºæœ‰å¤šä¸ªå¯†é’¥,è€Œä½ ä¸æƒ³ä½¿ç”¨ SSH ä»£ç†çš„æƒ…å†µ.ansible_shell_type      ç›®æ ‡ç³»ç»Ÿçš„shellç±»å‹.é»˜è®¤æƒ…å†µä¸‹,å‘½ä»¤çš„æ‰§è¡Œä½¿ç”¨ 'sh' è¯­æ³•,å¯è®¾ç½®ä¸º 'csh' æˆ– 'fish'.ansible_python_interpreter      ç›®æ ‡ä¸»æœºçš„ python è·¯å¾„.é€‚ç”¨äºçš„æƒ…å†µ: ç³»ç»Ÿä¸­æœ‰å¤šä¸ª Python, æˆ–è€…å‘½ä»¤è·¯å¾„ä¸æ˜¯&quot;/usr/bin/python&quot;,æ¯”å¦‚  \*BSD, æˆ–è€… /usr/bin/python      ä¸æ˜¯ 2.X ç‰ˆæœ¬çš„ Python.æˆ‘ä»¬ä¸ä½¿ç”¨ &quot;/usr/bin/env&quot; æœºåˆ¶,å› ä¸ºè¿™è¦æ±‚è¿œç¨‹ç”¨æˆ·çš„è·¯å¾„è®¾ç½®æ­£ç¡®,ä¸”è¦æ±‚ &quot;python&quot; å¯æ‰§è¡Œç¨‹åºåä¸å¯ä¸º pythonä»¥å¤–çš„åå­—(å®é™…æœ‰å¯èƒ½åä¸ºpython26).      ä¸ ansible_python_interpreter çš„å·¥ä½œæ–¹å¼ç›¸åŒ,å¯è®¾å®šå¦‚ ruby æˆ– perl çš„è·¯å¾„....</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å·¥å…·åº“</title>
      <link href="posts/3827a60a/"/>
      <url>posts/3827a60a/</url>
      
        <content type="html"><![CDATA[<p><a href="https://encycolorpedia.cn/323e4e">åå…­è¿›åˆ¶é¢œè‰²ä»£ç è¡¨ï¼Œå›¾è¡¨ï¼Œè°ƒè‰²æ¿ï¼Œç»˜å›¾&amp;æ²¹æ¼†</a></p><p><a href="http://gosspublic.alicdn.com/ram-policy-editor/index.html">é˜¿é‡Œäº‘ ram ç­–ç•¥ç”Ÿæˆå™¨</a></p><p><a href="https://develop.aliyun.com/tools/sdk?#/python">é˜¿é‡Œäº‘SDKé¢‘é“</a></p><p><a href="https://app.xuty.tk/static/app/index.html">è¡¨æƒ…é”…</a></p><p><a href="https://whoer.net/zh">æµ‹è¯•å›½å¤–å‡ºå£ip</a></p><p><a href="http://www.ip-api.com/">æµ‹è¯•å›½å¤–å‡ºå£ip</a></p><p><a href="https://www.wondercv.com/">è¶…çº§ç®€å†WonderCV - HRæ¨èç®€å†æ¨¡æ¿,æ™ºèƒ½ç®€å†åˆ¶ä½œå·¥å…·,ä¸“ä¸šä¸­è‹±æ–‡ç®€å†æ¨¡æ¿å…è´¹ä¸‹è½½</a></p><p><a href="https://help.aliyun.com/knowledge_detail/50270.html?spm=a2c4g.11186623.6.621.483534bfFo31Sm">å„åœ°åŒºç®¡å±€å¤‡æ¡ˆè§„åˆ™</a></p><p><a href="https://www.ipplus360.com/">æ›´ç²¾å‡†çš„å…¨çƒIPåœ°å€å®šä½å¹³å°_IPé—®é—® -åŸƒæ–‡ç§‘æŠ€(ipplus360.com)</a></p><p><a href="http://xn--eqrt2g.xn--vuq861b/">å·¥ä¿¡éƒ¨-åŸŸå.ä¿¡æ¯</a></p><p><a href="http://explainshell.com/">è§£æå‘½ä»¤ explainshell.com - match command-line arguments to their help text</a></p><p><a href="https://haveibeenpwned.com/Passwords">å¯†ç æ³„éœ²æ£€æµ‹</a></p><p><a href="https://tuna.moe/">æ¸…åå¤§å­¦ TUNA åä¼š - Home</a></p><p><a href="http://zh.thetimenow.com/time-zone-converter.php">æ—¶åŒºè½¬æ¢ç”Ÿæˆ</a></p><p><a href="https://help.aliyun.com/document_detail/116378.html?spm=a2c4g.11186623.2.17.6f36578flUOrcy#concept-188715">ä½¿ç”¨redis-shakeè¿ç§»RDBæ–‡ä»¶å†…çš„æ•°æ®</a></p><p><a href="https://www.17ce.com/">ç½‘ç«™æµ‹é€Ÿ|ç½‘ç«™é€Ÿåº¦æµ‹è¯•|ç½‘é€Ÿæµ‹è¯•|ç”µä¿¡|è”é€š|ç½‘é€š|å…¨å›½|ç›‘æ§|CDN|PING|DNS 17CE.COM</a></p><p><a href="https://devhints.io/">è¯­è¨€/å·¥å…·è¯­æ³•å¸¸ç”¨æ‘˜è¦</a></p><p><a href="https://ipchaxun.com/">åŸŸååæŸ¥ip</a></p><p><a href="https://www.whatsmydns.net/">åŸŸåè§£ææ£€æŸ¥</a></p><p><a href="https://intodns.com/">åŸŸåçŠ¶æ€æŠ¥å‘Š</a></p><p><a href="https://github.com/ireaderlab/alex">alex:webå‹åŠ›æµ‹è¯•å·¥å…·</a></p><p><a href="http://www.kammerl.de/ascii/AsciiSignature.php">Ascii Text / Signature Generator motdåŠ¨æ€å¼€æœºæé†’</a></p><p><a href="https://www.json2yaml.com/convert-yaml-to-json">Convert YAML to JSON</a></p><p><a href="https://csr.chinassl.net/generator-csr.html">CSRæ–‡ä»¶ç”Ÿæˆå·¥å…·-ä¸­å›½æ•°å­—è¯ä¹¦CHINASSL</a></p><p><a href="https://apps.evozi.com/apk-downloader/">gp apk ä¸‹è½½</a></p><p><a href="http://tool.520101.com/wangluo/ipjisuan/">ipåœ°å€åœ¨çº¿è®¡ç®—å™¨</a></p><p><a href="https://ipv6-test.com/validate.php">IPv6 ç«™ç‚¹æµ‹è¯•</a></p><p><a href="http://grokconstructor.appspot.com/do/match#result">logstash grok æµ‹è¯•</a></p><p><a href="https://github.com/DoubleLabyrinth/MobaXterm-keygen">MobaXterm-keygen å¯†é’¥</a></p><p><a href="http://msdn.itellyou.cn/">MSDN, æˆ‘å‘Šè¯‰ä½ </a></p><p><a href="https://api.aliyun.com/#/cli">OpenAPI Explorer</a></p><p><a href="https://www.pyman.com.cn/">pymanç½‘å€å¯¼èˆª</a></p><p><a href="http://rpm.pbone.net/">RPM Search</a></p><p><a href="https://www.cnblogs.com/zhaoruiqing/articles/12870209.html">Typoraçš„EmojiæŒ‡ä»¤</a></p><p><a href="https://paste.ubuntu.com/">Ubuntu Pastebin</a></p><p><a href="http://www.92csz.com/study/UnixToolbox-zh_CN.html">Unix Toolbox - ä¸­æ–‡ç‰ˆ</a></p><p><a href="https://www.dotcom-tools.com/">Website Performance Test Tools</a></p>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>djangoâ˜adminç®¡ç†è§†å›¾</title>
      <link href="posts/86059ffb/"/>
      <url>posts/86059ffb/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://docs.djangoproject.com/zh-hans/3.2/ref/contrib/admin/">Django ç®¡ç†ç«™ç‚¹ | Django æ–‡æ¡£ | Django (djangoproject.com)</a></p><h2 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h2><p>è‹¥è¦åœ¨ç®¡ç†è§†å›¾ä¸­çœ‹åˆ°æŸä¸ªæ¨¡å‹ï¼Œåˆ™éœ€è¦å…ˆæ³¨å†Œ</p><p><code>&lt;app&gt;.admin</code></p><p>ä¾‹å¦‚æ³¨å†Œ<code>Author</code></p><pre><code class="language-python">from django.contrib import adminfrom myproject.myapp.models import Authorclass AuthorAdmin(admin.ModelAdmin):    list_display = []    list_filter = []    search_fileds = ()admin.site.register(Author, AuthorAdmin)</code></pre><p>å…¶ä¸­ç±»<code>AuthorAdmin</code>é€šè¿‡ç»§æ‰¿<code>admin.ModelAdmin</code>è·å–é»˜è®¤çš„ä¸€äº›æ–¹æ³•ï¼Œè¿™äº›é»˜è®¤æ–¹æ³•å¯ä»¥æŸ¥çœ‹ï¼š</p><p><a href="https://docs.djangoproject.com/zh-hans/3.2/ref/contrib/admin/#custom-template-options">è‡ªå®šä¹‰|Django ç®¡ç†ç«™ç‚¹ | Django æ–‡æ¡£ | Django (djangoproject.com)</a></p><h2 id="è‡ªå®šä¹‰">è‡ªå®šä¹‰</h2><h3 id="è‡ªå®šä¹‰ä¾§è¾¹æ è¿‡æ»¤å™¨">è‡ªå®šä¹‰ä¾§è¾¹æ è¿‡æ»¤å™¨</h3><p><a href="https://docs.djangoproject.com/zh-hans/3.2/ref/contrib/admin/#django.contrib.admin.ModelAdmin.list_filter">list_filter | Django ç®¡ç†ç«™ç‚¹ | Django æ–‡æ¡£ | Django (djangoproject.com)</a></p><p>ä¾‹å¦‚èµ„æºè¡¨æœ‰å­—æ®µ<code>user</code>,<code>user</code>æ˜¯ User è¡¨çš„å¤–é”®ï¼Œç¡®ä¿è¿‡æ»¤å™¨é‡Œä»…æ˜¾ç¤ºæ‹¥æœ‰èµ„æºçš„ç”¨æˆ·ã€‚</p><p>åˆ™éœ€è¦è®¾ç½®ä¸€ä¸ªå…ƒç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å­—æ®µ<code>user</code>ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯<code>admin.RelatedOnlyFieldListFilter</code>ã€‚</p><p>ç¬¬äºŒä¸ªå…ƒç´ ç»§æ‰¿è‡ª <code>django.contrib.admin.FieldListFilter</code></p><pre><code class="language-python">    list_filter = (        ('user', admin.RelatedOnlyFieldListFilter),    )</code></pre><blockquote><p>åˆ—è¡¨è¿‡æ»¤å™¨é€šå¸¸åªæœ‰åœ¨è¿‡æ»¤å™¨æœ‰å¤šä¸ªé€‰æ‹©æ—¶æ‰ä¼šå‡ºç°</p></blockquote><h3 id="è¿‡æ»¤å±•ç¤ºæ•°æ®">è¿‡æ»¤å±•ç¤ºæ•°æ®</h3><p>ä¾‹å¦‚ç™»å½•ç”¨æˆ·å¦‚æœæ˜¯è¶…çº§ç”¨æˆ·ï¼Œåˆ™å±•ç¤ºæ‰€æœ‰æ•°æ®ï¼›</p><p>ç™»å½•ç”¨æˆ·å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼Œåˆ™å±•ç¤ºè‡ªå·±çš„æ•°æ®</p><pre><code class="language-python">class MyModelAdmin(admin.ModelAdmin):    def get_queryset(self, request):        qs = super().get_queryset(request)         if request.user.is_superuser:            return qs        return qs.filter(user=request.user)</code></pre><p>è¿™é‡Œåˆ©ç”¨<code>super()</code>è°ƒç”¨çˆ¶ç±»<code>ModelAdmin</code>çš„<code>get_queryset</code>æ–¹æ³•è¿”å›<a href="https://docs.djangoproject.com/zh-hans/3.2/ref/models/querysets/#queryset-api">QuerySet</a>çš„æ‰€æœ‰æ¨¡å‹å®ä¾‹.</p><p><code>QuerySet</code>æœ‰å¾ˆå¤šç»†åŒ–æ–¹æ³•ï¼Œä¾‹å¦‚ä¸Šè¿°ä»£ç é‡Œçš„<code>filter</code>ï¼Œå…³äºç»†åŒ–æ–¹æ³•é‡Œçš„å‚æ•°æ ¼å¼ï¼Œåˆ™å‚è€ƒ<a href="https://docs.djangoproject.com/zh-hans/3.2/ref/models/querysets/#field-lookups">Field | QuerySet</a></p><h3 id="è¡¨æ ¼ä¿å­˜å‰åæ·»åŠ é¢å¤–é€»è¾‘">è¡¨æ ¼ä¿å­˜å‰åæ·»åŠ é¢å¤–é€»è¾‘</h3><p><code>save_model</code>æ–¹æ³•è¢«èµ‹äºˆ <code>HttpRequest</code>ã€ä¸€ä¸ªæ¨¡å‹å®ä¾‹ã€ä¸€ä¸ª <code>ModelForm</code> å®ä¾‹å’Œä¸€ä¸ªåŸºäºæ˜¯å¦æ·»åŠ æˆ–æ›´æ”¹å¯¹è±¡çš„å¸ƒå°”å€¼ã€‚è¦†ç›–è¿™ä¸ªæ–¹æ³•å¯ä»¥è¿›è¡Œä¿å­˜å‰æˆ–ä¿å­˜åçš„æ“ä½œã€‚</p><p>ä¾‹å¦‚ä¿å­˜å‰ï¼Œè‡ªåŠ¨å°†æ¨¡å‹<code>user</code>å­—æ®µè®¾ç½®ä¸ºç™»å½•ç”¨æˆ·</p><pre><code class="language-python">    def save_model(self, request, obj, form, change):        obj.user = request.user  # ä¿å­˜å‰çš„é€»è¾‘        super().save_model(request, obj, form, change)        pass # ä¿å­˜åçš„é€»è¾‘</code></pre><h3 id="è®¾å®šè¡¨æ ¼æ“ä½œæƒé™">è®¾å®šè¡¨æ ¼æ“ä½œæƒé™</h3><p>è®¾å®šæ™®é€šç™»å½•ç”¨æˆ·ä¹Ÿæ‹¥æœ‰è¡¨æ ¼ä¿®æ”¹å’Œåˆ é™¤æƒé™</p><pre><code class="language-python">    def has_change_permission(self, request, obj=None):        if not obj:            return True # So they can see the change list page        if request.user.is_superuser or obj.user == request.user:            return True        else:            return False        has_delete_permission = has_change_permission  </code></pre><p><code>if not obj</code>è¿”å›<code>True</code>ï¼Œç¡®ä¿æ¨¡å‹æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥çœ‹åˆ°</p><p><code>if request.user.is_superuser or obj.user == request.user:</code>ï¼Œç¡®ä¿è¶…çº§ç”¨æˆ·å’Œç™»å½•ç™»å½•ç”¨æˆ·ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹</p><p>æœ€åå…¶å®ƒç”¨æˆ·æ²¡æœ‰æƒé™è®¿é—®é¡µé¢</p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>djangoâ˜æ—¥å¿—</title>
      <link href="posts/26bd5165/"/>
      <url>posts/26bd5165/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://docs.djangoproject.com/zh-hans/3.1/topics/logging/">https://docs.djangoproject.com/zh-hans/3.1/topics/logging/</a></p><p><a href="https://docs.python.org/3/library/logging.config.html#configuration-dictionary-schema">https://docs.python.org/3/library/logging.config.html#configuration-dictionary-schema</a></p><p><a href="https://docs.python.org/3/library/logging.html">https://docs.python.org/3/library/logging.html</a></p><p>django é‡‡ç”¨ python çš„ logger æ¨¡å—ï¼Œé…ç½®æ–¹å¼é€‰æ‹©å­—å…¸æ–¹å¼</p><h2 id="å­—å…¸æ–¹å¼åŸºæœ¬ä»‹ç»">å­—å…¸æ–¹å¼åŸºæœ¬ä»‹ç»</h2><p>æœ‰ä¸€äº›å¿…é€‰çš„é”®å€¼å¯¹ <a href="https://docs.python.org/3/library/logging.config.html#dictionary-schema-details">https://docs.python.org/3/library/logging.config.html#dictionary-schema-details</a></p><p>ä¾‹å¦‚<code>version</code>ï¼Œ<code>formatters</code>ç­‰ï¼Œå…·ä½“çœ‹ä¸Šé¢å®˜æ–¹æ–‡æ¡£å’Œä¸‹é¢çš„ä¾‹å­</p><h2 id="å…³é”®å¯¹è±¡ä»‹ç»">å…³é”®å¯¹è±¡ä»‹ç»</h2><p><code>loggers</code>æ ¹æ®æ¶ˆæ¯ç•Œåˆ«æ¥æ”¶æ—¥å¿—ï¼Œä½†ä¸è´Ÿè´£è¾“å‡º</p><p><code>LogRecord</code><code>logger</code>æ¥æ”¶ä¸€æ¡æ—¥å¿—ï¼Œå°±åˆ›å»ºä¸€ä¸ª<code>logrecord</code>å¯¹è±¡</p><p><code>handlers</code>ç»‘å®šåœ¨<code>logger</code>ï¼Œç”¨äºå¤„ç†æ—¥å¿—<code>logrecord</code>å¯¹è±¡ï¼Œä¾‹å¦‚è¾“å‡ºåˆ°å“ªé‡Œ. å¯ä»¥å°†å¤šä¸ª<code>handler</code>ç»‘å®šåˆ°åŒä¸€ä¸ª<code>logger</code></p><p><code>formatters</code>ç»‘å®šåœ¨<code>handler</code>ï¼Œç”¨æ¥æ ¼å¼åŒ–æ—¥å¿—<code>logrecord</code>å¯¹è±¡</p><p><code>filters</code>é€šè¿‡è®¾å®šè¿‡æ»¤æ¡ä»¶ï¼Œè¿‡æ»¤ä»<code>logger</code>åˆ°<code>handler</code>çš„æ—¥å¿—<code>logrecord</code>å¯¹è±¡ã€‚éå¿…é¡»</p><h3 id="é¢å¤–çš„">é¢å¤–çš„</h3><p><code>LoggerAdapter(logger, extra)</code>ç”¨æ¥åŒ…è£…<code>logger</code>ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª<code>logger</code>å’Œä¸€ä¸ªå­—å…¸<code>extra</code>ï¼Œä»è€Œå°†<code>extra</code>æ·»åŠ åˆ°<code>logrecord</code></p><p>ä¹‹åï¼Œé€šè¿‡<code>LoggerAdapter</code>å¯¹è±¡æ¥æ”¶çš„æ—¥å¿—ï¼Œå†ç»è¿‡<code>formatter</code>å¯¹<code>extra.key</code>çš„ç¼–æ’ï¼Œå°±å®ç°äº†æ·»åŠ ä¿¡æ¯åˆ°åŸå§‹æ—¥å¿—çš„åŠŸèƒ½.</p><h2 id="æ—¥å¿—çº§åˆ«">æ—¥å¿—çº§åˆ«</h2><ul><li><code>DEBUG</code>ï¼šæ’æŸ¥æ•…éšœæ—¶ä½¿ç”¨çš„ä½çº§åˆ«ç³»ç»Ÿä¿¡æ¯</li><li><code>INFO</code>ï¼šä¸€èˆ¬çš„ç³»ç»Ÿä¿¡æ¯</li><li><code>WARNING</code>ï¼šæè¿°ç³»ç»Ÿå‘ç”Ÿäº†ä¸€äº›å°é—®é¢˜çš„ä¿¡æ¯</li><li><code>ERROR</code>ï¼šæè¿°ç³»ç»Ÿå‘ç”Ÿäº†å¤§é—®é¢˜çš„ä¿¡æ¯</li><li><code>CRITICAL</code>ï¼šæè¿°ç³»ç»Ÿå‘ç”Ÿä¸¥é‡é—®é¢˜çš„ä¿¡æ¯</li></ul><h2 id="æµç¨‹">æµç¨‹</h2><p>ç»™æ¥æ”¶çš„æ—¥å¿—å®šçº§åˆ«ï¼š<code>logger.&lt;level&gt;(&quot;log message&quot;)</code></p><p><code>logger</code>åˆ¤æ–­æ¥æ”¶çš„æ—¥å¿—çº§åˆ«æ˜¯å¦ç¬¦åˆ<code>logger</code>å®šä¹‰çš„çº§åˆ«</p><p>å¦‚æœç¬¦åˆï¼Œ<code>logger</code>æ— å·®åˆ«çš„æ¨é€æ¶ˆæ¯åˆ°å¤šä¸ª<code>handler</code>ï¼Œå¦‚æœä¸ç¬¦åˆï¼Œåˆ™å¿½ç•¥ï¼›å¦å¤–ï¼Œå¦‚æœ<code>logger.propagate</code>ä¸ºçœŸï¼Œåˆ™æ¶ˆæ¯ä¼šå¤åˆ¶ä¸€ä»½åˆ°æ›´é«˜çº§åˆ«çš„<code>logger</code></p><p><code>handler</code>åˆ¤æ–­æ¥æ”¶çš„æ—¥å¿—çº§åˆ«æ˜¯å¦ç¬¦åˆ<code>handler</code>å®šä¹‰çš„çº§åˆ«</p><p>å¦‚æœç¬¦åˆï¼Œ<code>handler</code>é€šè¿‡<code>formatter</code>æ’åˆ—<code>logrecord</code>å¯¹è±¡å±æ€§ï¼Œå¹¶é€šè¿‡<code>handler.class</code>å°†æ—¥å¿—è¾“å‡ºï¼Œå¦‚æœä¸ç¬¦åˆï¼Œåˆ™å¿½ç•¥ï¼›å¦å¤–ï¼Œå¦‚æœ<code>handler</code>æœ‰<code>filter</code>ï¼Œåˆ™åªä¼šè¾“å‡ºæ»¡è¶³<code>filter</code>çš„æ—¥å¿—</p><h2 id="ä¾‹å­">ä¾‹å­</h2><p>å†™å…¥ <a href="http://settings.py">settings.py</a> ä¸­</p><pre><code class="language-python"># LoggingLOGGING = &#123;    'version': 1,  # æŒ‡æ˜ç‰ˆæœ¬ï¼Œç›®å‰å°±åªæœ‰ä¸€ä¸ªç‰ˆæœ¬    'disable_existing_loggers': False,  # è¡¨ç¤ºæ˜¯å¦ç¦ç”¨æ‰€æœ‰çš„å·²ç»å­˜åœ¨çš„æ—¥å¿—é…ç½®    # å£°æ˜ä¸¤ä¸ªæ ¼å¼åŒ–id    'formatters': &#123;  # æ ¼å¼å™¨        'verbose': &#123;  # è¯¦ç»†            'format': '%(levelname)s %(asctime)s %(module)s %(process)d %(thread)d %(message)s'        &#125;,        'standard': &#123;  # æ ‡å‡†            'format': '[%(asctime)s] [%(levelname)s] %(message)s'        &#125;,    &#125;,    # å®šä¹‰è¿‡æ»¤å™¨ special,å®ƒæœ‰ä¸€ä¸ªæ¡ä»¶å‡½æ•° project.logging.SpecialFilter(foo), å‡½æ•°è¢«å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œfoo='bar'    # project.logging.SpecialFilter éœ€è¦è‡ªå·±å®ç°, åˆ¤æ–­ logrecord å¯¹è±¡,æˆ–è€…æ»¡è¶³ä¸€äº›æ¡ä»¶æ‰è¾“å‡ºæ—¥å¿—    'filters': &#123;        'special': &#123;            '()': 'project.logging.SpecialFilter',            'foo': 'bar',        &#125;,    &#125;,    # handlersï¼šç”¨æ¥å®šä¹‰å…·ä½“å¤„ç†æ—¥å¿—çš„æ–¹å¼ï¼Œå¯ä»¥å®šä¹‰å¤šç§ï¼Œ&quot;console&quot;å°±æ˜¯æ‰“å°åˆ°æ§åˆ¶å°æ–¹å¼ã€‚fileæ˜¯å†™å…¥åˆ°æ–‡ä»¶çš„æ–¹å¼ï¼Œ&quot;mail_admins&quot;æ˜¯é‚®ä»¶é€šçŸ¥    # è¿™é‡Œçš„ console/file/mail_admins ä»…ä»…æ˜¯è‡ªå®šä¹‰çš„åç§°    'handlers': &#123; # å¤„ç†å™¨        'console': &#123;            'level': 'DEBUG',            'class': 'logging.StreamHandler',            'stream': 'ext://sys.stdout',   # æ–‡ä»¶é‡å®šå‘çš„é…ç½®ï¼Œå°†æ‰“å°åˆ°æ§åˆ¶å°çš„ä¿¡æ¯éƒ½é‡å®šå‘å‡ºå»            'formatter': 'standard'   # åˆ¶å®šè¾“å‡ºçš„æ ¼å¼ï¼Œæ³¨æ„ åœ¨ä¸Šé¢çš„formattersé…ç½®é‡Œé¢é€‰æ‹©ä¸€ä¸ªï¼Œå¦åˆ™ä¼šæŠ¥é”™        &#125;,        'file_all': &#123;            'level': 'DEBUG',            'class': 'logging.handlers.TimedRotatingFileHandler',            'filename': os.path.dirname(os.path.dirname(os.path.realpath(__file__)))+'/log/all.log',              'formatter': 'standard'            'maxBytes': 1024            'when': 'midnight'            'interval': 1            'backupCount': 3                 'utc': False            'encoding': 'utf-8'                    &#125;,        'file_request': &#123;            'level': 'DEBUG',            'class': 'logging.handlers.TimedRotatingFileHandler',            'filename': os.path.dirname(os.path.dirname(os.path.realpath(__file__)))+'/log/request.log',              'formatter': 'standard'            'maxBytes': 1024            'when': 'midnight'            'interval': 1            'backupCount': 3                 'utc': False            'encoding': 'utf-8'                    &#125;,        'file_db': &#123;            'level': 'DEBUG',            'class': 'logging.handlers.TimedRotatingFileHandler',            'filename': os.path.dirname(os.path.dirname(os.path.realpath(__file__)))+'/log/db.log',              'formatter': 'standard'            'maxBytes': 1024            'when': 'midnight'            'interval': 1            'backupCount': 3                 'utc': False            'encoding': 'utf-8'                    &#125;,        'mail_admins': &#123;            'level': 'ERROR',            'class': 'django.utils.log.AdminEmailHandler',            'filters': ['special']        &#125;,    &#125;,    'loggers': &#123;  # logè®°å½•å™¨ï¼Œé…ç½®ä¹‹åå°±ä¼šå¯¹åº”çš„è¾“å‡ºæ—¥å¿—        'django': &#123;            'handlers': ['file_all'],            'level': 'INFO',            'propagate': False,        &#125;,        'django.request ':&#123;            'handlers': ['file_request','mail_admins'],            'level': 'INFO',            'propagate': False,        &#125;,         'django.server ':&#123;            'handlers': ['console'],            'level': 'INFO',            'propagate': False,        &#125;,               'django.db.backends': &#123;            'handlers': ['file_db'],            'level':'INFO',            'propagate': False,        &#125;,        # æ ¹è®°å½•å™¨        'root': &#123;        'handlers': ['console'],        'level': 'WARNING',        &#125;,    &#125;,&#125;</code></pre><h2 id="logger">logger</h2><p><a href="https://docs.python.org/3/library/logging.html#logger-objects">https://docs.python.org/3/library/logging.html#logger-objects</a></p><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œ<code>logger</code>æœ‰ä¸€ä¸ªå±æ€§æ˜¯<code>propagate</code>ï¼Œè¿™ä¸ªå±æ€§çš„ä½œç”¨æ˜¯å°†æ”¶åˆ°çš„æ¶ˆæ¯å¤åˆ¶ä¸€ä»½åˆ°æ›´é«˜çº§åˆ«çš„<code>logger</code></p><p>å…³äº<code>logger</code>çš„å±‚çº§æ„æ€æ˜¯ï¼šé€šè¿‡<code>.</code>åˆ†å‰²çš„<code>logger_name</code></p><p>ä¸Šè¿°åˆ—å­ä¸­ï¼Œå±‚çº§é«˜ä½æ’åºæ˜¯ï¼š</p><p><code>root</code>&gt;<code>django</code>&gt;<code>django.request</code>=<code>django.server</code></p><p><code>root</code>&gt;<code>django</code>&gt;``django.db.backends`</p><h2 id="handler">handler</h2><p><a href="https://docs.python.org/3/library/logging.handlers.html#module-logging.handlers">https://docs.python.org/3/library/logging.handlers.html#module-logging.handlers</a></p><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œ<code>handler</code>çš„<code>class</code>éƒ½æ˜¯<code>python</code>çš„å†…ç½®ç±»å‹</p><h2 id="formatter">formatter</h2><p>æ ¼å¼åŒ–<code>logrecord</code>å¯¹è±¡ï¼Œæ’ç‰ˆ<code>logrecord</code>çš„å±æ€§</p><h2 id="logrecord">logrecord</h2><p><a href="https://docs.python.org/zh-cn/3.9/library/logging.html#logrecord-attributes">https://docs.python.org/zh-cn/3.9/library/logging.html#logrecord-attributes</a></p><h2 id="LoggerAdapter">LoggerAdapter</h2><p><a href="https://docs.python.org/zh-cn/3.9/library/logging.html#loggeradapter-objects">https://docs.python.org/zh-cn/3.9/library/logging.html#loggeradapter-objects</a></p><h2 id="è°ƒç”¨">è°ƒç”¨</h2><pre><code class="language-python">import logging, logging.configlogging.config.dictConfig(LOGGING) # django æ— éœ€æ­¤æ­¥éª¤ï¼Œdjango ä¼šè‡ªåŠ¨åŠ è½½logger = logging.getLogger(__name__)  # è¿™é‡Œçš„loggeråç§°è¦åŒ¹é…ä¸Š dictConfig å®šä¹‰çš„ logger, åŒ¹é…éµå¾ªåç§°å±‚çº§è§„åˆ™logger.info(&quot;message&quot;)</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jqueryâ˜ä¼ªè¿›åº¦æ¡</title>
      <link href="posts/5d527900/"/>
      <url>posts/5d527900/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ç‚¹å‡»-&gt;è§¦å‘è„šæœ¬jquery-&gt;è„šæœ¬è®¿é—®url-&gt;django view(show_progress)-&gt;viewè¿”å›æ•°æ®ç»™è„šæœ¬jquery-&gt;è„šæœ¬jqueryæ‹¿åˆ°è¿›åº¦æ•°æ®ç™¾åˆ†æ¯”-&gt;æ›´æ–°è¿›åº¦æ¡-&gt;é‡å¤è®¿é—®url-&gt;ç›´è‡³è¿›åº¦æ¡æ•°æ®100%-&gt;ç»ˆæ­¢è®¿é—®url.</p><h2 id="å…·ä½“æ­¥éª¤">å…·ä½“æ­¥éª¤</h2><h3 id="ç‚¹å‡»">ç‚¹å‡»</h3><blockquote><p>ç‚¹å‡»æäº¤æŒ‰é’®ï¼Œé€šè¿‡id â€œsubmitâ€ æ‰¾åˆ°è„šæœ¬</p></blockquote><pre><code class="language-html">        &lt;div class=&quot;item1&quot;&gt;          &lt;a href=&quot;&#123;% url 'assets:ssllist' %&#125;&quot;&gt;è¿”å›&lt;/a&gt;          &lt;button id=&quot;submit&quot; class=&quot;mybtn&quot; type=&quot;submit&quot;&gt;æäº¤&lt;/button&gt;        &lt;/div</code></pre><h3 id="è„šæœ¬jquery">è„šæœ¬jquery</h3><pre><code class="language-javascript">    &lt;script&gt;    $(function () &#123;      $('#submit').on('click', function () &#123;     // è§¦å‘ click åŠ¨ä½œï¼Œæ‰§è¡Œ function        $('#prog_out').attr(&quot;class&quot;,&quot;progress&quot;);      var sitv = setInterval(function()&#123;    // æ·»åŠ ä¸€ä¸ªé—´éš”æœŸå‡½æ•°setIntervalï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•°1æ˜¯æ‰§è¡Œå‡½æ•°functionï¼Œå‚æ•°2æ˜¯é—´éš”æ—¶é—´              var show_progress_url = &quot;&#123;% url 'assets:showprogress' %&#125;&quot;; // å˜é‡ show_progress_url                $.getJSON(show_progress_url, function(res)&#123;    // è®¿é—® show_progress_urlï¼Œå¹¶å°†viewè§†å›¾çš„ç»“æœresä¼ é€’ç»™ function å‡½æ•°ï¼Œå¹¶æ‰§è¡Œ function(res)                 if(res === 100)&#123;       // è‹¥ viewè§†å›¾è¿”å›100ï¼Œåˆ™ä¿®æ”¹åŠ¨ä½œæ¡é¢œè‰²ä¸º successï¼Œå¹¶ä¸”æ¸…ç©ºè®¡æ—¶å™¨å¹¶é€€å‡º                  $('#prog_out').attr(&quot;class&quot;, &quot;progress progress-bar bg-success&quot;);                  clearInterval(sitv);                &#125;                console.log(&quot;currect progresspct:&quot;+res);  // æ‰“å°å½“å‰è¿›åº¦                  $('#prog_in').width(res + '%');     // æ”¹å˜è¿›åº¦æ¡è¿›åº¦ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å†…å±‚çš„divï¼Œ resæ˜¯åå°è¿”å›çš„è¿›åº¦                  $('#prog_in').val(res);   //æ”¹å˜è¿›åº¦æ¡çš„å€¼                &#125;);              &#125;,           1000);   // é—´éš”æœŸå‡½æ•°setInterval,ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡åå°è¿›åº¦      &#125;);    &#125;)    &lt;/script&gt;</code></pre><h3 id="è„šæœ¬è®¿é—®URL">è„šæœ¬è®¿é—®URL</h3><p>é€šè¿‡ä¸Šè¿°JSè„šæœ¬ï¼Œè®¿é—®show_progress_urlå˜é‡</p><h3 id="django-viewè§†å›¾">django viewè§†å›¾</h3><pre><code class="language-python">def show_progress(request):    if request.user.is_authenticated:        loginuser = request.user.username        #progresspct = cache.get_or_set(loginuser,0)        print('å½“å‰åˆ›å»ºè¯ä¹¦çš„ç”¨æˆ·æ˜¯:' + loginuser)        progresspct = cache.get(loginuser)        print(&quot;ç™¾åˆ†æ¯”:&#123;0&#125;&quot;.format(progresspct))        if progresspct == 100:            print('åˆ é™¤ç¼“å­˜')            cache.delete(loginuser)            return JsonResponse(progresspct, safe=False)        progresspct += 1        cache.set(loginuser,progresspct)        return JsonResponse(progresspct, safe=False)</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> jquery </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jquery </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>djangoâ˜restfulç®€å•ä½¿ç”¨</title>
      <link href="posts/dd4c9efa/"/>
      <url>posts/dd4c9efa/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å®˜æ–¹å¿«é€Ÿæ•™ç¨‹ï¼š<a href="https://www.django-rest-framework.org/tutorial/quickstart/">Quickstart - Django REST framework (django-rest-framework.org)</a></p><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash">pip install djangorestframework</code></pre><h2 id="é…ç½®">é…ç½®</h2><p><code>settings.INSTALLED_APPS</code>åŠ å…¥<code>'rest_framework.authtoken','rest_framework'</code></p><blockquote><p>å…¶ä¸­<code>rest_framework.authtoken</code>æ˜¯ç®€å•çš„ Token è®¤è¯</p></blockquote><p><code>settings.py</code> ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š</p><pre><code class="language-python">REST_FRAMEWORK = &#123;    'DEFAULT_AUTHENTICATION_CLASSES': [        'rest_framework.authentication.BasicAuthentication',        'rest_framework.authentication.SessionAuthentication',        'rest_framework.authentication.TokenAuthentication'  # å¼€å¯ Token è®¤è¯    ],    'DEFAULT_PERMISSION_CLASSES': [        'rest_framework.permissions.IsAuthenticated', # å…¨å±€æ¥å£æƒé™ï¼šå¼€å¯å…¨å±€è®¤è¯    ],    # 'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination', # æ¥å£åˆ†é¡µ    # 'PAGE_SIZE': 10&#125;</code></pre><h2 id="å…·ä½“">å…·ä½“</h2><p><img src="/posts/dd4c9efa/image-20210805152047616.png" alt="image-20210805152047616"></p><p>å¤§æ¦‚çš„ç•Œé¢å°±å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š</p><ol><li>å³ä¸Šè§’æ˜¯ä¸€ä¸ªç™»å½•UI</li><li>æ­£é¢æ˜¯è¯·æ±‚åœ°å€/æ–¹æ³•ä¹‹ç±»çš„ï¼Œä»¥åŠè¿”å›çš„æ•°æ®</li></ol><h3 id="å…³äºå³ä¸Šè§’çš„ç™»å½•UI">å…³äºå³ä¸Šè§’çš„ç™»å½•UI</h3><pre><code class="language-python"># é¡¹ç›®æ ¹APPé‡Œçš„ urls.pyfrom django.urls import path, includeurlpatterns += [    path('api-auth/', include('rest_framework.urls')), ]</code></pre><h3 id="å¤§è‡´çš„ä¸€ä¸ªæµç¨‹">å¤§è‡´çš„ä¸€ä¸ªæµç¨‹</h3><p>Requestâ˜DjangoUrLsâ˜AppRootUrLâ˜APIUrLâ˜APIViewâ˜APIåºåˆ—åŒ–â˜DjangoModel</p><p>å‡è®¾ä½ çš„APIåœ°å€æ˜¯ /api-user/user</p><h3 id="DjangoUrLsè·¯ç”±">DjangoUrLsè·¯ç”±</h3><blockquote><p>é¡¹ç›®æ ¹è·¯ç”±</p></blockquote><pre><code class="language-python">urlpatterns += [    path('api-user/', include(loginurls, namespace=&quot;login&quot;)),]</code></pre><h3 id="AppRoutUrL">AppRoutUrL</h3><blockquote><p>loginurlsæ–‡ä»¶ï¼šAppæ ¹è·¯ç”±</p></blockquote><pre><code class="language-python">app_name=&quot;login&quot;from rest_framework.decorators import api_viewfrom rest_framework.response import Responsefrom rest_framework.reverse import reverse@api_view(['GET'])def api_root(request, format=None):    return Response(&#123;        'users': reverse('login:user-list', request=request, format=format),        'snippets': reverse('login:asset-list', request=request, format=format)    &#125;)# APIæ ¹è·¯ç”±urlpatterns += [    path('', api_root),]</code></pre><h3 id="APIURL">APIURL</h3><pre><code class="language-python">user_list = views.UserViewSet.as_view(&#123;    'get': 'list'&#125;)user_detail = views.UserViewSet.as_view(&#123;    'get': 'retrieve'&#125;)urlpatterns += [    path('user/', user_list, name='user-list'),    path('user/&lt;int:pk&gt;/', user_detail, name='user-detail')]</code></pre><h3 id="APIViews">APIViews</h3><pre><code class="language-python">from login import models as loginmodelsfrom login.serializers import UserSerializerfrom django.contrib.auth.models import Userfrom rest_framework import permissionsfrom rest_framework import viewsetsclass UserViewSet(viewsets.ModelViewSet):    &quot;&quot;&quot;    This viewset automatically provides `list` and `retrieve` actions.    &quot;&quot;&quot;    queryset = User.objects.all()    serializer_class = UserSerializer    permission_classes = [permissions.IsAdminUser]</code></pre><h3 id="APIåºåˆ—åŒ–">APIåºåˆ—åŒ–</h3><pre><code class="language-python">from rest_framework import serializersfrom login import models as loginmodelsfrom django.contrib.auth.models import Userclass UserSerializer(serializers.HyperlinkedModelSerializer):    # æ˜¾ç¤ºçš„å®šä¹‰ä¸¤ä¸ªæ•°æ®å­—æ®µçš„æŸ¥æ‰¾æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯userçš„å…³è”å¤–é”® user_assetï¼Œä¸€ä¸ªæ˜¯ HyperlinkedModelSerializer æ‰€éœ€çš„é“¾æ¥å­—æ®µ url    user_asset = serializers.HyperlinkedRelatedField(     # user_asset æ˜¯ Userä¸»è¡¨çš„å¤–é”®å(related_name)        view_name=&quot;login:asset-detail&quot;, read_only=True    )    url = serializers.HyperlinkedIdentityField(        view_name='login:user-detail',   # é»˜è®¤ HyperlinkedModelSerializer çš„ url å­—æ®µæŸ¥æ‰¾çš„è§†å›¾åæ˜¯ &#123;model_name&#125;-detailã€‚ è¿™é‡Œæ˜¾ç¤ºæŒ‡å®šè§†å›¾    )    class Meta:        model = User        fields = ['url', 'id', 'username', 'user_asset']  # apiè¿”å›çš„æ•°æ®</code></pre><h2 id="ç®€å•çš„Tokenè®¤è¯">ç®€å•çš„Tokenè®¤è¯</h2><blockquote><p>é€šè¿‡APIæ‹¿åˆ°æ•°æ®ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šå¼€å¯è®¤è¯ï¼Œä¾‹å¦‚Tokenæ–¹å¼</p></blockquote><pre><code class="language-python">&quot;&quot;&quot;Token URL&quot;&quot;&quot;from login import views as loginviewsurlpatterns += [    path('api/gettoken/', loginviews.CustomAuthToken.as_view()), # é€šè¿‡å‘èµ·POSTè·å–tokenï¼Œ&#123;&quot;username&quot;: &quot;xxx&quot;, &quot;password&quot;:xxx&#125;]</code></pre><pre><code class="language-python">&quot;&quot;&quot;views&quot;&quot;&quot;from rest_framework.authtoken.views import ObtainAuthTokenfrom rest_framework.authtoken.models import Tokenfrom rest_framework.response import Responseclass CustomAuthToken(ObtainAuthToken):    #throttle_classes =     def post(self, request, *args, **kwargs):        serializer = self.serializer_class(data=request.data,                                        context=&#123;'request': request&#125;)        serializer.is_valid(raise_exception=True)        user = serializer.validated_data['user']        token, created = Token.objects.get_or_create(user=user)        return Response(&#123;            'token': token.key,            'user_id': user.pk,            'email': user.email        &#125;)</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>djangoâ˜éªŒè¯ç </title>
      <link href="posts/d60c38c/"/>
      <url>posts/d60c38c/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://django-simple-captcha.readthedocs.io/en/latest/advanced.html#configuration-toggles">é«˜çº§ä¸»é¢˜ â€” Django Simple Captcha 0.5.14 æ–‡æ¡£ (django-simple-captcha.readthedocs.io)</a></p><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-python">pip install django-simple-captcha</code></pre><p><code>settings.INSTALLED_APPS</code>åŠ å…¥<code>captcha</code></p><h2 id="é…ç½®">é…ç½®</h2><p><code>settings.py</code>æœ«å°¾ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š</p><pre><code class="language-python"># éªŒè¯ç è®¾ç½®CAPTCHA_FIELD_TEMPLATE = &quot;captcha/field.html&quot; # å­—æ®µæ’åˆ—CAPTCHA_TEXT_FIELD_TEMPLATE = &quot;captcha/text_field.html&quot; # æ–‡æœ¬è¾“å…¥æ¡†#CAPTCHA_HIDDEN_FIELD_TEMPLATE = &quot;captcha/hidden_field.html&quot; CAPTCHA_IMAGE_TEMPLATE = &quot;captcha/image.html&quot; # éªŒè¯ç å›¾æ ‡æ¡†CAPTCHA_CHALLENGE_FUNCT = 'captcha.helpers.random_char_challenge' # éªŒè¯ç ç±»å‹CAPTCHA_IMAGE_SIZE=(100,36) # éªŒè¯ç å°ºå¯¸CAPTCHA_TIMEOUT=1#CAPTCHA_OUTPUT_FORMAT=u'%(text_field)s %(hidden_field)s %(image)s'</code></pre><h2 id="å…·ä½“">å…·ä½“</h2><p>ä»¥<code>app:login</code>ä¸ºä¾‹ï¼Œåœ¨å…¶æ ¹ç›®å½•æ„å»ºä»¥ä¸‹å†…å®¹</p><ol><li>æ„å»º<code>templates/captcha</code>ç›®å½•ï¼Œå¹¶åˆ›å»º<code>field.html</code>ã€<code>text_field.html</code>ã€<code>image.html</code>æ¨¡æ¿</li></ol><pre><code class="language-bash">â¯ cat field.html&#123;&#123; text_field &#125;&#125;&#123;&#123; hidden_field &#125;&#125;&#123;&#123; image &#125;&#125;â¯ cat text_field.html&lt;input id=&quot;id_&#123;&#123; name &#125;&#125;_1&quot; name=&quot;&#123;&#123; name &#125;&#125;_1&quot; type=&quot;text&quot; placeholder=&quot;captcha&quot; /&gt;â¯ cat image.html&lt;img src=&quot;&#123;&#123; image &#125;&#125;&quot; alt=&quot;&#123;&#123; name &#125;&#125;&quot; class=&quot;&#123;&#123; name &#125;&#125;&quot;/&gt;</code></pre><ol start="2"><li>æ„å»º<code>static/login/js</code>ç›®å½•ï¼Œå¹¶åˆ›å»º<code>captcha.js</code>ï¼Œç”¨äºåŠ¨æ€åˆ·æ–°éªŒè¯ç </li></ol><pre><code class="language-bash">â¯ cat captcha.js$('img.captcha').click(function() &#123;  $.getJSON('/captcha/refresh/',function(json) &#123; // This should update your captcha image src and captcha hidden input      console.log(json);      $(&quot;img.captcha&quot;).attr(&quot;src&quot;,json.image_url);      $(&quot;#id_captcha_0&quot;).val(json.key);    &#125;);    return false;&#125;);</code></pre><ol start="3"><li>åˆ›å»º<code>form</code>è¡¨å•è°ƒç”¨<code>captcha</code></li></ol><pre><code>â¯ cat forms.py&quot;&quot;&quot;å¯¼å…¥è¡¨å•æ¨¡å—&quot;&quot;&quot;from django import formsfrom captcha.fields import CaptchaField, CaptchaTextInputclass UserForm(forms.Form):    &quot;&quot;&quot;    ç”¨æˆ·è¡¨å•    &quot;&quot;&quot;    username = forms.CharField(label='ç”¨æˆ·å', max_length=128, widget=forms.TextInput(attrs=&#123;'class': 'form-control'&#125;))    password = forms.CharField(label='å¯†ç ', max_length=256, widget=forms.PasswordInput(attrs=&#123;'class': 'form-control'&#125;))    captcha = CaptchaField(label='éªŒè¯ç ')</code></pre><ol start="4"><li>æ„å»º<code>templates/login</code>ç›®å½•ï¼Œå¹¶åˆ›å»º<code>login.html</code>æ¨¡æ¿è°ƒç”¨<code>caphtcha</code></li></ol><pre><code class="language-html">&#123;% load static %&#125;&lt;!doctype html&gt;&lt;html lang=&quot;en&quot;&gt;  &lt;head&gt;    &lt;!-- Required meta tags --&gt;    &lt;meta charset=&quot;utf-8&quot;&gt;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;    &lt;!-- ä¸Šè¿°metaæ ‡ç­¾*å¿…é¡»*æ”¾åœ¨æœ€å‰é¢ï¼Œä»»ä½•å…¶ä»–å†…å®¹éƒ½*å¿…é¡»*è·Ÿéšå…¶åï¼ --&gt;    &lt;!-- Bootstrap CSS --&gt;    &lt;link href=&quot;&#123;% static 'login/css/login.css' %&#125;&quot; rel=&quot;stylesheet&quot; /&gt;    &lt;link href=&quot;&#123;% static 'fontawesome_free/css/all.min.css' %&#125;&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;    &lt;title&gt;ç™»å½•&lt;/title&gt;  &lt;/head&gt;  &lt;body&gt;    &lt;div id=&quot;container&quot;&gt;      &lt;h1&gt;ç™»å½•&lt;/h1&gt;      &#123;% if login_form.captcha.errors %&#125;        &#123;% for error in login_form.captcha.errors %&#125;        <small>ğŸ˜¢ğŸ˜¢ğŸ˜¢&#123;&#123; error &#125;&#125;ğŸ˜¢ğŸ˜¢ğŸ˜¢</small>        &#123;% endfor %&#125;      &#123;% elif message %&#125;        <small>ğŸ˜¢ğŸ˜¢ğŸ˜¢&#123;&#123; message &#125;&#125;ğŸ˜¢ğŸ˜¢ğŸ˜¢</small>      &#123;% else %&#125;        <small>ğŸ˜ŠğŸ˜ŠğŸ˜Šæ¬¢è¿æ‚¨çš„åˆ°æ¥ğŸ˜ŠğŸ˜ŠğŸ˜Š</small>      &#123;% endif %&#125;      &lt;form class=&quot;form&quot; action=&quot;/login/&quot; method=&quot;post&quot;&gt;&#123;% csrf_token %&#125;        &lt;!-- åˆ¤æ–­ç”¨æˆ·è¾“å…¥ä¿¡æ¯ï¼Œå¹¶è¿”å›é”™è¯¯ä¿¡æ¯ --&gt;        &#123;% for item in login_form %&#125;          &#123;% if item.html_name == "username" %&#125;          <div class="item">            <i class="far fa-user"></i>            <input id="&#123;&#123; item.id_for_label &#125;&#125;" name="&#123;&#123; item.html_name &#125;&#125;" type="&#123;&#123; item.field.widget.input_type &#125;&#125;" placeholder="&#123;&#123; item.html_name &#125;&#125;">            <text>            &#123;% for error in item.errors %&#125;                &#123;&#123; error &#125;&#125;            &#123;% endfor %&#125;            &lt;/text&gt;          &lt;/div&gt;          &#123;% endif %&#125;          &#123;% if item.html_name == "password" %&#125;          <div class="item">            <i class="fas fa-key"></i>            <input id="&#123;&#123; item.id_for_label &#125;&#125;" name="&#123;&#123; item.html_name &#125;&#125;" type="&#123;&#123; item.field.widget.input_type &#125;&#125;" placeholder="&#123;&#123; item.html_name &#125;&#125;">            <text>            &#123;% for error in item.errors %&#125;                &#123;&#123; error &#125;&#125;            &#123;% endfor %&#125;            </text>          </div>          &#123;% endif %&#125;          &#123;% if item.html_name == "captcha" %&#125;          <div class="item">            <i class="fas fa-robot"></i>            &#123;&#123; login_form.captcha &#125;&#125;            </div>            &#123;% endif %&#125;        &#123;% endfor %&#125;        &lt;div class=&quot;item1&quot;&gt;          &lt;button type=&quot;submit&quot;&gt;Go~~~~&lt;/button&gt;          &lt;a href=&quot;/register/&quot;&gt;Register&lt;/a&gt;        &lt;/div&gt;      &lt;/form&gt;    &lt;/div&gt;    &lt;script src=&quot;https://cdn.bootcss.com/jquery/3.5.1/jquery.js&quot;&gt;&lt;/script&gt;    &lt;script src=&quot;https://cdn.bootcss.com/popper.js/1.16.0/umd/popper.js&quot;&gt;&lt;/script&gt;    &lt;script src=&quot;https://cdn.bootcss.com/twitter-bootstrap/4.5.3/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;    &lt;script src=&quot;&#123;% static 'login/js/captcha.js' %&#125;&quot;&gt;&lt;/script&gt;  &lt;/body&gt;&lt;/html&gt;</text></div></code></pre><ol start="5"><li>æ„å»º<code>static/login/css</code>ç›®å½•ï¼Œå¹¶åˆ›å»º<code>login.css</code></li></ol><pre><code class="language-bash">â¯ cat login.cssbody &#123;background: url('../image/backend.jpg') center center no-repeat;background-attachment: fixed;background-size: cover;&#125;input::-webkit-input-placeholder&#123;    color:#000000;&#125;input::-moz-placeholder&#123;   /* Mozilla Firefox 19+ */    color:#000000;&#125;input:-moz-placeholder&#123;    /* Mozilla Firefox 4 to 18 */    color:#000000;&#125;input:-ms-input-placeholder&#123;  /* Internet Explorer 10-11 */    color:#000000;&#125;#container &#123;    width: 35%;    height: 400px;    margin: 0 auto;    margin-top: 15%;    padding: 20px 50px;    text-align: center;    background: #ffffff50;&#125;#container .alert &#123;    margin: 0 auto;    width: 350px;    text-align: left;&#125;#container .form &#123;    margin-top: 30px;&#125;#container .form .item &#123;    margin-top: 15px;    position: relative;&#125;#container .form .item i &#123;    font-size: 20px;&#125;#container .form .item input &#123;    border: 0;    border-bottom: 2px solid #000;    padding: 10px 30px;    background: #ffffff00;    font-size: 20px;    padding-left: 11px;&#125;#container .form .item text &#123;    position: absolute;    text-size: 5px;    text-align: left;    padding-top: 10px;&#125;#container .form .item img &#123;    position: absolute;&#125;#container .form .item1 &#123;    display: flex;    justify-content: space-between;    margin-top: 15px;    padding-top: 5%;    padding-left: 22%;    padding-right: 22%;&#125;#container .form .item1 button &#123;    width: 180px;    height: 30px;    font-size: 20px;    font-weight: 600;    color: #ffffff;    background-image: linear-gradient(60deg, #64b3f4 0%, #c2e59c 100%);    border-radius: 15px;    border: 0;&#125;#container .form .item1 a &#123;    text-decoration:none;    width: 100px;    font-size: 20px;    font-weight: 600;    color: #ffffff;    background-image: linear-gradient(60deg, #64b3f4 0%, #c2e59c 100%);    border-radius: 15px;    border: 0;&#125;</code></pre><ol start="6"><li>æ·»åŠ è·¯ç”±</li></ol><p><code>é¡¹ç›®.urls.urlpatterns</code>ä¸­æ·»åŠ <code>path('captcha/', include('captcha.urls')),</code></p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonâ˜json</title>
      <link href="posts/876c5852/"/>
      <url>posts/876c5852/</url>
      
        <content type="html"><![CDATA[<h2 id="Jsonä¸pythonä¹‹é—´ç±»å‹å…³ç³»">Jsonä¸pythonä¹‹é—´ç±»å‹å…³ç³»</h2><table><thead><tr><th><strong>JSONç±»å‹</strong></th><th><strong>pythonç±»å‹</strong></th></tr></thead><tbody><tr><td><strong>{}</strong></td><td><strong>dict</strong></td></tr><tr><td><strong>[]</strong></td><td><strong>list</strong></td></tr><tr><td><strong>â€œstringâ€</strong></td><td><strong>str</strong></td></tr><tr><td><strong>â€œ123456â€</strong></td><td><strong>intæˆ–float</strong></td></tr><tr><td><strong>true/false</strong></td><td><strong>True/False</strong></td></tr><tr><td><strong>null</strong></td><td><strong>None</strong></td></tr></tbody></table><h2 id="åºåˆ—åŒ–">åºåˆ—åŒ–</h2><pre><code class="language-python">import jsonjson.dumps(python_dict)  # å°†pyç±»å‹è½¬ä¸ºjsonå­—ç¬¦ä¸²ç±»å‹</code></pre><h2 id="ååºåˆ—åŒ–">ååºåˆ—åŒ–</h2><pre><code class="language-python">import jsonjson.loads(json_str)  # å°†jsonå­—ç¬¦ä¸²ç±»å‹è½¬ä¸ºpyç±»å‹</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> json </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜æ—¶é—´</title>
      <link href="posts/cd32aa48/"/>
      <url>posts/cd32aa48/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬æ–‡ä¸­æè¿°çš„å¹¶ä¸èƒ½æ¶µç›–æ‰€æœ‰æ—¶é—´è®¾ç½®å‘½ä»¤ï¼Œåªæ˜¯è®°å½•äº†ç»å¸¸ç”¨åˆ°çš„ä¸€äº›ã€‚</p><h2 id="æ—¶é—´åŒæ­¥">æ—¶é—´åŒæ­¥</h2><pre><code>sudo yum erase ntp*sudo yum -y install chronysudo service chronyd startsed -i '1i server 10.200.16.101 prefer iburst' /etc/chrony.conf</code></pre><blockquote><p>10.200.16.101 æ›¿æ¢æˆntpæœåŠ¡å™¨</p></blockquote><h2 id="æ—¶åŒºä¿®æ”¹">æ—¶åŒºä¿®æ”¹</h2><p>å¦‚æœä½ ç”¨çš„æ˜¯7ä»¥ä¸Šçš„centosæˆ–è€…ubuntu</p><p>é‚£ä¹ˆå¯ä»¥ç”¨ timedatectl å‘½ä»¤æ¥è®¾ç½®æ—¶åŒº</p><p>timedatectl --list-timezones</p><p>timedatectl --set-timezone Asia/Shanghai</p><hr><h2 id="æ²¡æœ‰timedatectlå‘½ä»¤çš„è¯">æ²¡æœ‰timedatectlå‘½ä»¤çš„è¯</h2><h4 id="ä¿®æ”¹ä¼šè¯æ—¶åŒº">ä¿®æ”¹ä¼šè¯æ—¶åŒº</h4><pre><code class="language-bash">echo &quot;TZ='UTC+0'; export TZ&quot; &gt;&gt; ~/.bash_profile</code></pre><blockquote><p>éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>UTC8 è¡¨ç¤ºè¥¿8åŒº</li><li>tzselect å¯ä»¥å¸®ä½ æŸ¥çœ‹æ—¶åŒºæœ‰å“ªäº›</li><li>UTC æ–¹å¼ï¼Œæ— æ³•è¯†åˆ«å†¬ä»¤æ—¶å’Œå¤ä»¤æ—¶ï¼Œæ‰€ä»¥å»ºè®®ç”¨åœ°åŒºåç§°ï¼Œä¾‹å¦‚ asia/shanghai</li></ol></blockquote><h4 id="ä¿®æ”¹crontabæ—¶åŒº">ä¿®æ”¹crontabæ—¶åŒº</h4><p>åœ¨ crontab ç”¨æˆ·é…ç½®æœ€ä¸Šé¢åŠ å…¥ï¼Œä¾‹å¦‚æ·»åŠ èŠåŠ å“¥æ—¶åŒº</p><pre><code class="language-bash">TZ='America/Chicago'CRON_TZ='America/Chicago'</code></pre><blockquote><p>å…³äºæ—¶åŒºè®¾ç½®æ–¹é¢ï¼Œä¸å»ºè®®ä¿®æ”¹é…ç½®ï¼Œå› ä¸ºä¸å¤Ÿçµæ´»</p></blockquote><h4 id="ä¿®æ­£æ—¶é—´-å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ">ä¿®æ­£æ—¶é—´, å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</h4><pre><code class="language-bash">yum install ntp -yntpdate cn.ntp.org.cnhwclock -wecho '0 12 * * * /usr/sbin/ntpdate cn.ntp.org.cn &gt; /dev/null 2&gt;&amp;1' &gt;&gt; /etc/crontab</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> æ—¶åŒº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>05ELKåŸºæœ¬ä½¿ç”¨-kibana</title>
      <link href="posts/d8390732/"/>
      <url>posts/d8390732/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…">å®‰è£…</h2><p><a href="https://www.elastic.co/guide/en/kibana/current/targz.html">https://www.elastic.co/guide/en/kibana/current/targz.html</a></p><pre><code class="language-bash">appName=kibanaesVersion=7.15.1cd /export/srccurl &quot;https://mirrors.huaweicloud.com/$&#123;appName&#125;/$&#123;esVersion&#125;/$&#123;appName&#125;-$&#123;esVersion&#125;-linux-x86_64.tar.gz&quot; -o $&#123;appName&#125;.tgztar xf $&#123;appName&#125;.tgzmv $&#123;appName&#125;-$&#123;esVersion&#125;-linux-x86_64 ../$&#123;appName&#125; &amp;&amp; cd ..useradd -U $&#123;appName&#125;chown -R $&#123;appName&#125;:$&#123;appName&#125; /export/$&#123;appName&#125;cd /export/$&#123;appName&#125;</code></pre><h2 id="é…ç½®">é…ç½®</h2><p><a href="https://www.elastic.co/guide/en/kibana/current/settings.html">https://www.elastic.co/guide/en/kibana/current/settings.html</a></p><pre><code class="language-yaml">cp /export/kibana/config/kibana.yml /export/kibana/config/kibana.yml.defaultcat &gt; /export/kibana/config/kibana.yml &lt;&lt; EOFserver.name: kibanaserver.host: 0.0.0.0server.port: 5601elasticsearch.hosts: [&quot;http://hadoop001:9200&quot;,&quot;http://hadoop002:9200&quot;,&quot;http://hadoop003:9200&quot;]xpack.monitoring.ui.container.elasticsearch.enabled: truei18n.locale: zh-CNEOF</code></pre><pre><code class="language-bash">bin/kibana-encryption-keys generate# å°†è¾“å‡ºçš„ `Settings` é…ç½®è¿½åŠ åˆ° kibana.ymlxpack.encryptedSavedObjects.encryptionKey: 40233b82c57c14127363xpack.reporting.encryptionKey: f5550ba4b241b820bxpack.security.encryptionKey: 9732d0b256555b</code></pre><h2 id="ç³»ç»Ÿç”¨æˆ·-å¯é€‰">ç³»ç»Ÿç”¨æˆ·(å¯é€‰)</h2><p>ä»…å½“ESå¼€å¯å®‰å…¨é…ç½®åéœ€è¦.</p><p>è¿½åŠ ä¸‹åˆ—é…ç½®åˆ°<code>kibana.yml</code>ï¼Œkibanaé€šè¿‡kibana_systemç”¨æˆ·è®¿é—®elasticsearchæ‰§è¡Œåå°ä»»åŠ¡.</p><pre><code class="language-bash">elasticsearch.username: &quot;kibana_system&quot;</code></pre><p>æ‰§è¡Œä¸‹åˆ—å‘½ä»¤,å°†å¯†ç åŠ å¯†å­˜æ”¾.</p><pre><code class="language-bash">./bin/kibana-keystore create./bin/kibana-keystore add elasticsearch.password=&gt;è¾“å…¥ESå®‰å…¨é…ç½®æœŸé—´ï¼Œç”Ÿæˆçš„`kibana_system`å¯†ç </code></pre><h2 id="å¯åŠ¨">å¯åŠ¨</h2><pre><code class="language-bash">su - kibanacd /export/kibananohup ./bin/kibana &amp;</code></pre><p>â„¹ï¸å¦‚æœå¯ç”¨å®‰å…¨è®¾ç½®å’Œç”¨æˆ·é…ç½®ï¼Œåˆ™kibanaçš„webè®¿é—®éœ€è¦<code>elastic</code>ç”¨æˆ·æƒé™.</p><h2 id="ç”¨æˆ·æƒé™ç®¡ç†">ç”¨æˆ·æƒé™ç®¡ç†</h2><p><a href="https://www.elastic.co/guide/en/kibana/7.15/tutorial-secure-access-to-kibana.html">https://www.elastic.co/guide/en/kibana/7.15/tutorial-secure-access-to-kibana.html</a></p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>04ELKåŸºæœ¬ä½¿ç”¨-elasticsearch</title>
      <link href="posts/41bf4066/"/>
      <url>posts/41bf4066/</url>
      
        <content type="html"><![CDATA[<h2 id="å‡†å¤‡">å‡†å¤‡</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.15/system-config.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.15/system-config.html</a></p><pre><code class="language-bash"># elasticsearch å…·ä½“å®‰è£…å‘½ä»¤å’Œç‰ˆæœ¬è¯·ä»¥ä¸‹è½½é¡µä¸­å¯¹åº”çš„dockerå®‰è£…æ–¹å¼é¡µé‡Œå‘½ä»¤ä¸ºåŸºå‡†sysctl -a | egrep &quot;(vm.max_map_count|net.ipv4.tcp_retries2)&quot;  # æŸ¥çœ‹æ˜¯å¦è¿‡å°, å¦‚æœè¿‡å°æ‰§è¡Œä¸‹ä¸€æ¡echo 'vm.max_map_count=262144' &gt;&gt; /etc/sysctl.confecho 'net.ipv4.tcp_retries2=5' &gt;&gt; /etc/sysctl.confsysctl -p## https://www.elastic.co/guide/en/elasticsearch/reference/7.15/setting-system-settings.htmlcat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF  *           soft   nofile       102400  *           hard   nofile       102400  *           soft   nproc        102400  *           hard   nproc        102400  *           soft  memlock      unlimited  *           hard  memlock      unlimitedEOF## å…³é—­swap åŒæ—¶åº”è¯¥åœ¨ /etc/fstab ä¸­å–æ¶ˆ swap çš„æŒ‚è½½sudo swapoff -a</code></pre><h2 id="å®‰è£…">å®‰è£…</h2><p><a href="https://mirrors.huaweicloud.com/elasticsearch/">https://mirrors.huaweicloud.com/elasticsearch/</a></p><pre><code>esVersion=7.15.1cd /export/srccurl &quot;https://mirrors.huaweicloud.com/elasticsearch/$&#123;esVersion&#125;/elasticsearch-$&#123;esVersion&#125;-linux-x86_64.tar.gz&quot; -o es.tgztar xf es.tgzmv elasticsearch-$&#123;esVersion&#125; ../elasticsearchuseradd -U elasticsearchchown -R elasticsearch:elasticsearch /export/elasticsearchsu - elasticsearchcd /export/elasticsearch</code></pre><h2 id="é…ç½®">é…ç½®</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.15/important-settings.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.15/important-settings.html</a></p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.15/configuring-stack-security.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.15/configuring-stack-security.html</a></p><h3 id="è§’è‰²">è§’è‰²</h3><p>è§’è‰²ä»‹ç»çš„å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles</a></p><p>elasticsearch å¯ä»¥é€šè¿‡<code>node.roles: [xxx]</code>æ¥è®¾å®šèŠ‚ç‚¹è§’è‰²ã€‚å¦‚æœä¸è®¾ç½®<code>node.roles</code>ï¼Œåˆ™é»˜è®¤èŠ‚ç‚¹æ‹¥æœ‰æ‰€æœ‰è§’è‰²ã€‚</p><p>è§’è‰²å¯åˆ†ä¸ºï¼šmasterã€dataå’Œdata_xxxç³»åˆ—ã€ingestã€mlã€remote_cluster_clientã€transformã€‚</p><p>ğŸ’¢åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œmasterå’Œdataæ˜¯å¿…é¡»çš„è§’è‰²ã€‚</p><h3 id="ä¸€ä»½é€šç”¨èŠ‚ç‚¹é…ç½®">ä¸€ä»½é€šç”¨èŠ‚ç‚¹é…ç½®</h3><p>é…ç½®ä¸­<code>discovery.seed_hosts</code>æ›¿æ¢æˆæ‰€æœ‰èŠ‚ç‚¹çš„hostname</p><pre><code class="language-bash">cp config/elasticsearch.yml config/elasticsearch.yml.defaulthostName=`hostname`cat &gt; /export/elasticsearch/config/elasticsearch.yml &lt;&lt; EOFcluster.name: es-clusterdiscovery.seed_hosts: xxx1,xxx2,xxx3node.name: $&#123;hostName&#125;#node.master: true#node.data: falsehttp.port: 9200network.host: 0.0.0.0http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot;bootstrap.memory_lock: truexpack.security.enabled: truexpack.security.transport.ssl.enabled: truexpack.security.transport.ssl.verification_mode: certificate xpack.security.transport.ssl.client_authentication: requiredxpack.security.transport.ssl.keystore.path: elastic-certificates.p12xpack.security.transport.ssl.truststore.path: elastic-certificates.p12resource.reload.interval.high: 5sEOF</code></pre><p>â„¹ï¸<code>xpack.security.transport.ssl.keystore.pathã€xpack.security.transport.ssl.truststore.path</code>æŒ‡å®šçš„æ–‡ä»¶åä¸ä¸‹é¢å¯ç”¨TLSä¸­çš„é»˜è®¤æ–‡ä»¶åä¸€è‡´ã€‚</p><p>ğŸ’ å¦‚æœæ˜¯å•èŠ‚ç‚¹ï¼Œåˆ™åº”è¯¥åŠ å…¥<code>discovery.type: single-node</code>ï¼Œå¹¶åˆ é™¤<code>discovery.seed_hosts</code>ã€‚</p><h2 id="å¯ç”¨TLS">å¯ç”¨TLS</h2><p>å½“å¯ç”¨äº†<code>xpack.security.enabled: true</code>åï¼Œå¤šèŠ‚ç‚¹ç”Ÿäº§æ¨¡å¼é›†ç¾¤å¿…é¡»å¯ç”¨TLSï¼Œå¦åˆ™æ— æ³•å¯åŠ¨é›†ç¾¤ã€‚</p><p>åˆ›å»ºCAè¯ä¹¦å’ŒèŠ‚ç‚¹è¯ä¹¦</p><pre><code class="language-bash">./bin/elasticsearch-certutil ca=&gt;å›è½¦ï¼Œæ¥å—é»˜è®¤æ–‡ä»¶å elastic-stack-ca.p12=&gt;è¾“å…¥CAè¯ä¹¦å¯†ç ./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12=&gt;è¾“å…¥CAè¯ä¹¦å¯†ç =&gt;å›è½¦ï¼Œæ¥å—é»˜è®¤æ–‡ä»¶å elastic-certificates.p12=&gt;è¾“å…¥èŠ‚ç‚¹è¯ä¹¦å¯†ç ï¼ˆå¯é€‰ï¼‰</code></pre><p>å°†ç”Ÿæˆçš„<code>elastic-certificates.p12</code>å¤åˆ¶åˆ°æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„<code>config</code>ç›®å½•ä¸­ï¼Œå¹¶ç¡®ä¿æˆæƒ<code>600</code></p><p>ğŸ’”æˆ‘æ·»åŠ äº†èŠ‚ç‚¹è¯ä¹¦å¯†ç åï¼ŒESæ ¡éªŒè¯ä¹¦å¤±è´¥ï¼Œä¸çŸ¥åŸå› ã€‚</p><p>ğŸ’¢å¦‚æœèŠ‚ç‚¹è¯ä¹¦å¼€å¯äº†å¯†ç ï¼Œåˆ™éœ€è¦å­˜åœ¨ESä¸­ï¼Œé€šè¿‡ä¸‹åˆ—å‘½ä»¤å­˜å‚¨ï¼Œä¼šå­˜æ”¾åœ¨<code>config/elasticsearch.keystore</code></p><pre><code class="language-bash">./bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password=&gt;è¾“å…¥èŠ‚ç‚¹è¯ä¹¦å¯†ç ./bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password=&gt;è¾“å…¥èŠ‚ç‚¹è¯ä¹¦å¯†ç </code></pre><h2 id="å¯åŠ¨ã€å…³é—­">å¯åŠ¨ã€å…³é—­</h2><h3 id="å¯åŠ¨">å¯åŠ¨</h3><p>ESé»˜è®¤ä¼šè‡ªåŠ¨è°ƒæ•´JVMå‚æ•°ï¼Œéå¿…è¦æƒ…å†µä¸‹æ— éœ€è°ƒæ•´.</p><p>å‘½ä»¤ä¸­<code>-Ecluster.initial_master_nodes</code>æ›¿æ¢æˆæ‰€æœ‰èŠ‚ç‚¹çš„hostname</p><pre><code class="language-bash">## export ES_JAVA_OPTS=&quot;$ES_JAVA_OPTS xxx&quot;export ES_TMPDIR=&quot;/export/elasticsearch/tmp&quot;mkdir -p /export/elasticsearch/tmpsu - elasticsearchcd /export/elasticsearch &amp;&amp; ./bin/elasticsearch -d -p es.pid -Ecluster.initial_master_nodes=xxx1,xxx2,xxx3</code></pre><p>ğŸ’¢<code>-Ecluster.initial_master_nodes=xxx1,xxx2,xxx3</code> ä»…å½“é¦–æ¬¡å¯åŠ¨çš„æ—¶å€™éœ€è¦æ·»åŠ ã€‚å½“é›†ç¾¤æˆåŠŸå¯åŠ¨åï¼Œåº”åˆ é™¤æ­¤é…ç½®ã€‚é‡å¯é›†ç¾¤ã€æ–°èŠ‚ç‚¹å…¥é›†ç¾¤éƒ½ä¸åº”è¯¥åŠ å…¥æ­¤é…ç½®ã€‚</p><h3 id="å…³é—­">å…³é—­</h3><pre><code class="language-bash">su - elasticsearchcd /export/elasticsearch &amp;&amp; pkill -F es.pid</code></pre><h2 id="å†…ç½®ç”¨æˆ·å¯†ç ç”Ÿæˆ">å†…ç½®ç”¨æˆ·å¯†ç ç”Ÿæˆ</h2><p>é€šè¿‡è®¾ç½®ç”¨æˆ·å¯†ç åï¼Œkibanaå°±éœ€è¦é…ç½®<code>elastic</code>è´¦æˆ·æ¥è®¿é—®web.<code>elastic</code>æ˜¯è¶…çº§ç”¨æˆ·.</p><ol><li>éœ€è¦eså¯åŠ¨çŠ¶æ€</li><li>å½“ä½ é€šè¿‡<code>bin/elasticsearch-setup-passwords</code>è®¾ç½®äº†<code>elastic</code>ç”¨æˆ·å¯†ç åï¼Œä½ å°†æ— æ³•å†æ¬¡è¿è¡Œ<code>bin/elasticsearch-setup-passwords</code></li></ol><pre><code class="language-bash">./bin/elasticsearch-setup-passwords autoChanged password for user apm_systemPASSWORD apm_system = hpYNFwXxubBoAK910LVNChanged password for user kibana_systemPASSWORD kibana_system = ZQQz8FpPeyElvrOLdMSeChanged password for user kibanaPASSWORD kibana = ZQQz8FpPeyElvrOLdMSeChanged password for user logstash_systemPASSWORD logstash_system = LeWxPOQp6u0yZ6ELkJxlChanged password for user beats_systemPASSWORD beats_system = olPcjTe7dKbI1EqYG9D7Changed password for user remote_monitoring_userPASSWORD remote_monitoring_user = 0VxbZ0GjZk5aUcQhs2pEChanged password for user elasticPASSWORD elastic = rMknnbJxRh5qWDGVZQ2R</code></pre><p>åœ¨è¿™ä¹‹åï¼Œä½ å¯ä»¥é€šè¿‡kibanaä»è€Œæ–¹ä¾¿çš„è¿›è¡Œå›¾å½¢åŒ–ç”¨æˆ·ç®¡ç†.</p><p>å…³äºå†…ç½®ç”¨æˆ·å¯¹åº”çš„æƒé™ï¼Œå¯ä»¥çœ‹ç›¸å…³å†…ç½®è§’è‰²çš„æƒé™èŒƒå›´ï¼š</p><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.15/built-in-roles.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.15/built-in-roles.html</a></p><h2 id="å¤‡ä»½é›†ç¾¤">å¤‡ä»½é›†ç¾¤</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.15/backup-cluster.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.15/backup-cluster.html</a></p><h2 id="é—®é¢˜ç‚¹">é—®é¢˜ç‚¹</h2><ol><li>å¦‚æœç£ç›˜ä¸å¤Ÿç”¨ï¼Œåˆ™å› æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯æ·»åŠ æ–°ç£ç›˜è·¯å¾„</li><li><code>cluster.name</code>æ˜¯é›†ç¾¤çš„å”¯ä¸€æ ‡è¯†ï¼Œä»»ä½•ä¸ä¸€è‡´çš„<code>cluster.name</code>èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤</li><li><code>node.name</code>æ˜¯èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†åï¼Œé»˜è®¤å–å€¼ä¸»æœºå</li><li><code>network.host</code>çš„è®¾ç½®æ˜¯ESåˆ¤æ–­å¼€å‘æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼çš„ä¾æ®ï¼Œé»˜è®¤å€¼æ˜¯å›ç¯åœ°å€ï¼ŒESå°†è®¤ä¸ºæ˜¯å¼€å‘æ¨¡å¼ã€‚</li><li>æ²¡æœ‰<code>data</code>è§’è‰²çš„èŠ‚ç‚¹å¦‚æœåœ¨å¯åŠ¨æ—¶åœ¨ç£ç›˜ä¸Šæ‰¾åˆ°ä»»ä½•åˆ†ç‰‡æ•°æ®å°†æ‹’ç»å¯åŠ¨ï¼Œè€Œæ²¡æœ‰è§’è‰²<code>master</code>å’Œ<code>data</code>è§’è‰²çš„èŠ‚ç‚¹å¦‚æœåœ¨å¯åŠ¨æ—¶ç£ç›˜ä¸Šæœ‰ä»»ä½•ç´¢å¼•å…ƒæ•°æ®å°†æ‹’ç»å¯åŠ¨ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜03ELKåŸºæœ¬ä½¿ç”¨-logstashç»„ä»¶02-æ’ä»¶ä»‹ç»</title>
      <link href="posts/56da51f2/"/>
      <url>posts/56da51f2/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2><p>logstashçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è½¬æ¢æ•°æ®ã€‚</p><p>å®˜æ–¹å°†ä¸€äº›ä¸»æµçš„æ’ä»¶åˆ†ä¸ºäº†å››ç±»å¹¶è¿›è¡Œäº†ä»‹ç»ã€‚</p><p><a href="https://www.elastic.co/guide/en/logstash/7.15/transformation.html">https://www.elastic.co/guide/en/logstash/7.15/transformation.html</a></p><h2 id="æ ¸å¿ƒæ“ä½œ">æ ¸å¿ƒæ“ä½œ</h2><p>â„¹ï¸ ä»¥ä¸‹å„ç§æ’ä»¶å¹¶éå…¨éƒ¨åŠŸèƒ½ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£.</p><h3 id="date-filter">date filter</h3><pre><code class="language-yaml">filter &#123;  date &#123;    match =&gt; [ &quot;logdate&quot;, &quot;MMM dd yyyy HH:mm:ss&quot; ]  &#125;&#125;</code></pre><p>æŒ‰ç…§<code>MMM dd yyyy HH:mm:ss</code>æ ¼å¼åŒ–<code>logdate</code>äº‹ä»¶å­—æ®µï¼Œå¹¶å°†æ ¼å¼åŒ–åçš„æ—¶é—´ä½œä¸ºäº‹ä»¶çš„ã€logstashã€‘æ—¶é—´æˆ³ã€‚é€šå¸¸ç”¨æ¥ä¸ºesç´¢å¼•æ·»åŠ çœŸå®çš„äº‹ä»¶æ—¶é—´æˆ³.</p><h3 id="drop-filter">drop filter</h3><pre><code class="language-yaml">filter &#123;  if [loglevel] == &quot;debug&quot; &#123;    drop &#123; &#125;  &#125;&#125;</code></pre><p>é€šè¿‡ifæ¡ä»¶åˆ é™¤åŒ…å«<code>loglevel: debug</code>å­—æ®µçš„äº‹ä»¶.</p><h3 id="fingerprint-filter">fingerprint filter</h3><pre><code class="language-yaml">filter &#123;  fingerprint &#123;    source =&gt; [&quot;IP&quot;, &quot;@timestamp&quot;, &quot;message&quot;]    method =&gt; &quot;SHA1&quot;    key =&gt; &quot;0123&quot;    target =&gt; &quot;[@metadata][generated_id]&quot;  &#125;&#125;</code></pre><p>é€šè¿‡äº‹ä»¶åŸå§‹å­—æ®µåŠ é¢å¤–çš„keyï¼Œä»¥<code>method</code>åŠ å¯†æ–¹å¼æ„æˆ<code>[@metadata][generated_id]</code>å”¯ä¸€IDã€‚</p><h3 id="mutate-filter">mutate filter</h3><pre><code class="language-yaml">filter &#123;  mutate &#123;    rename =&gt; &#123; &quot;HOSTORIP&quot; =&gt; &quot;client_ip&quot; &#125;  &#125;&#125;</code></pre><p>é’ˆå¯¹å­—æ®µæ‰§è¡Œrename, remove, replace, modifyï¼Œstripç­‰æ“ä½œè¡Œä¸º.</p><h3 id="ruby-filter">ruby filter</h3><pre><code class="language-yaml">filter &#123;  ruby &#123;    code =&gt; &quot;event.cancel if rand &lt;= 0.90&quot;  &#125;&#125;</code></pre><p>æ‰§è¡Œrubyä»£ç ï¼Œä¾‹å­ä¸­çš„æ„æ€æ˜¯ï¼šå–æ¶ˆ90%çš„äºº.</p><h2 id="åºåˆ—æ“ä½œ">åºåˆ—æ“ä½œ</h2><h3 id="csv-filter">csv filter</h3><pre><code class="language-yaml">filter &#123;  csv &#123;    separator =&gt; &quot;,&quot;    columns =&gt; [ &quot;Transaction Number&quot;, &quot;Date&quot;, &quot;Description&quot;, &quot;Amount Debit&quot;, &quot;Amount Credit&quot;, &quot;Balance&quot; ]  &#125;&#125;</code></pre><p>å°†csvæ•°æ®ï¼ŒæŒ‰ç…§<code>separator</code>è¿›è¡Œåˆ†å‰²ï¼Œä¸”å­—æ®µåé€šè¿‡<code>columns</code>å®šä¹‰</p><h3 id="xml-filter">xml filter</h3><pre><code class="language-yaml">filter &#123;  xml &#123;    source =&gt; &quot;message&quot;  &#125;&#125;</code></pre><p>è§£æäº‹ä»¶ä¸­çš„<code>message</code>å­—æ®µï¼ˆmessageå­—æ®µå­˜å‚¨çš„æ˜¯xmlæ–‡æ¡£ï¼‰</p><h3 id="json-coder">json coder</h3><pre><code class="language-yaml">input &#123;  file &#123;    path =&gt; &quot;/path/to/myfile.json&quot;    codec =&gt;&quot;json&quot;&#125;</code></pre><p>coderç¼–è§£ç å™¨ä¸€èˆ¬ç”¨äºinputæˆ–è€…outputï¼Œè¿˜æœ‰protobuf/fluent/avroç­‰ã€‚</p><h2 id="æå–å­—æ®µã€æ•´ç†æ•°æ®">æå–å­—æ®µã€æ•´ç†æ•°æ®</h2><h3 id="dissect-filter">dissect filter</h3><p>æ—¥å¿—æ•°æ®</p><pre><code class="language-bash">Apr 26 12:20:02 localhost systemd[1]: Starting system activity accounting tool...</code></pre><pre><code class="language-yaml">filter &#123;  dissect &#123;    mapping =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;ts&#125; %&#123;+ts&#125; %&#123;+ts&#125; %&#123;src&#125; %&#123;prog&#125;[%&#123;pid&#125;]: %&#123;msg&#125;&quot; &#125;  &#125;&#125;</code></pre><p>åˆ†ç»„æ˜ å°„<code>message</code>ï¼Œæ–°çš„äº‹ä»¶å­—æ®µå¦‚ä¸‹ï¼š</p><pre><code class="language-json">&#123;  &quot;msg&quot;        =&gt; &quot;Starting system activity accounting tool...&quot;,  &quot;@timestamp&quot; =&gt; 2017-04-26T19:33:39.257Z,  &quot;src&quot;        =&gt; &quot;localhost&quot;,  &quot;@version&quot;   =&gt; &quot;1&quot;,  &quot;host&quot;       =&gt; &quot;localhost.localdomain&quot;,  &quot;pid&quot;        =&gt; &quot;1&quot;,  &quot;message&quot;    =&gt; &quot;Apr 26 12:20:02 localhost systemd[1]: Starting system activity accounting tool...&quot;,  &quot;type&quot;       =&gt; &quot;stdin&quot;,  &quot;prog&quot;       =&gt; &quot;systemd&quot;,  &quot;ts&quot;         =&gt; &quot;Apr 26 12:20:02&quot;&#125;</code></pre><h3 id="kv-filter">kv filter</h3><p>æ—¥å¿—æ•°æ®ï¼š</p><pre><code class="language-bash">ip=1.2.3.4 error=REFUSED</code></pre><p>é…ç½®ï¼š</p><pre><code class="language-yaml">filter &#123;  kv &#123; &#125;&#125;</code></pre><p>æ–°äº‹ä»¶å­—æ®µï¼š</p><pre><code class="language-bash">ip: 1.2.3.4error: REFUSED</code></pre><h3 id="grok-filter">grok filter</h3><p>ç±»ä¼¼äº dissect filterã€‚</p><p>æ—¥å¿—æ•°æ®ï¼š</p><pre><code class="language-bash">55.3.244.1 GET /index.html 15824 0.043</code></pre><p>é…ç½®ï¼š</p><pre><code class="language-yaml">filter &#123;  grok &#123;    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client&#125; %&#123;WORD:method&#125; %&#123;URIPATHPARAM:request&#125; %&#123;NUMBER:bytes&#125; %&#123;NUMBER:duration&#125;&quot; &#125;  &#125;&#125;</code></pre><p>æ–°äº‹ä»¶å­—æ®µï¼š</p><pre><code class="language-bash">client: 55.3.244.1method: GETrequest: /index.htmlbytes: 15824duration: 0.043</code></pre><p>é€šè¿‡kibana-å¼€å‘å·¥å…·-Grok Debuggeræ¥è°ƒè¯•</p><p><img src="/posts/56da51f2/image-20211115151242262.png" alt="image-20211115151242262"></p><h2 id="ä¸°å¯Œæ•°æ®">ä¸°å¯Œæ•°æ®</h2><h3 id="dns-filter">dns filter</h3><p>å°†å­—æ®µipè¿›è¡Œåå·®ï¼Œå¹¶æ‰§è¡Œåç»­åŠ¨ä½œï¼Œä¾‹å¦‚replaceï¼Œç”¨åæŸ¥çš„åŸŸåæ›¿æ¢æ‰ip</p><pre><code class="language-yaml">filter &#123;  dns &#123;    reverse =&gt; [ &quot;source_host&quot; ]    action =&gt; &quot;replace&quot;  &#125;&#125;</code></pre><h3 id="geoip-filter">geoip filter</h3><p>é€šè¿‡å¯¹ipè¿›è¡Œåœ°ç†ä½ç½®æŸ¥è¯¢ï¼Œæ·»åŠ ä¸€ä¸ªé¢å¤–çš„<code>geoip</code>å­—æ®µ</p><pre><code class="language-yaml">filter &#123;  geoip &#123;    source =&gt; &quot;clientip&quot;  &#125;&#125;</code></pre><h3 id="jdbc-static-filter">jdbc_static filter</h3><p>é€šè¿‡å¤–éƒ¨æ•°æ®åº“çš„æ•°æ®æ„å»ºæœ¬åœ°ç¼“å­˜åº“ï¼Œå¹¶é€šè¿‡æœ¬åœ°ç¼“å­˜åº“æŸ¥è¯¢æ•°æ®ä¸°å¯Œäº‹ä»¶</p><pre><code class="language-yaml">filter &#123;  jdbc_static &#123;    loaders =&gt; [       &#123;        id =&gt; &quot;remote-servers&quot;        query =&gt; &quot;select ip, descr from ref.local_ips order by ip&quot;        local_table =&gt; &quot;servers&quot;      &#125;,      &#123;        id =&gt; &quot;remote-users&quot;        query =&gt; &quot;select firstname, lastname, userid from ref.local_users order by userid&quot;        local_table =&gt; &quot;users&quot;      &#125;    ]    local_db_objects =&gt; [       &#123;        name =&gt; &quot;servers&quot;        index_columns =&gt; [&quot;ip&quot;]        columns =&gt; [          [&quot;ip&quot;, &quot;varchar(15)&quot;],          [&quot;descr&quot;, &quot;varchar(255)&quot;]        ]      &#125;,      &#123;        name =&gt; &quot;users&quot;        index_columns =&gt; [&quot;userid&quot;]        columns =&gt; [          [&quot;firstname&quot;, &quot;varchar(255)&quot;],          [&quot;lastname&quot;, &quot;varchar(255)&quot;],          [&quot;userid&quot;, &quot;int&quot;]        ]      &#125;    ]    local_lookups =&gt; [       &#123;        id =&gt; &quot;local-servers&quot;        query =&gt; &quot;select descr as description from servers WHERE ip = :ip&quot;        parameters =&gt; &#123;ip =&gt; &quot;[from_ip]&quot;&#125;        target =&gt; &quot;server&quot;      &#125;,      &#123;        id =&gt; &quot;local-users&quot;        query =&gt; &quot;select firstname, lastname from users WHERE userid = :id&quot;        parameters =&gt; &#123;id =&gt; &quot;[loggedin_userid]&quot;&#125;        target =&gt; &quot;user&quot;       &#125;    ]    # using add_field here to add &amp; rename values to the event root    add_field =&gt; &#123; server_name =&gt; &quot;%&#123;[server][0][description]&#125;&quot; &#125;    add_field =&gt; &#123; user_firstname =&gt; &quot;%&#123;[user][0][firstname]&#125;&quot; &#125;     add_field =&gt; &#123; user_lastname =&gt; &quot;%&#123;[user][0][lastname]&#125;&quot; &#125;    remove_field =&gt; [&quot;server&quot;, &quot;user&quot;]    jdbc_user =&gt; &quot;logstash&quot;    jdbc_password =&gt; &quot;example&quot;    jdbc_driver_class =&gt; &quot;org.postgresql.Driver&quot;    jdbc_driver_library =&gt; &quot;/tmp/logstash/vendor/postgresql-42.1.4.jar&quot;    jdbc_connection_string =&gt; &quot;jdbc:postgresql://remotedb:5432/ls_test_2&quot;  &#125;&#125;</code></pre><p><code>loaders</code> æŸ¥è¯¢å¤–éƒ¨åº“</p><p><code>local_db_objects</code> æ˜ å°„<code>loaders</code>çš„åº“ï¼Œæ„å»ºæœ¬åœ°è¡¨</p><p><code>local_lookups</code> é€šè¿‡æœ¬åœ°è¡¨æŸ¥è¯¢æ•°æ®ï¼Œå­˜æ”¾äº<code>target</code>æŒ‡å®šçš„å˜é‡</p><p><code>add_field</code> æ·»åŠ æ–°å­—æ®µ</p><p><code>remove_field</code> åˆ é™¤è€å­—æ®µ</p><h3 id="translate-filter">translate filter</h3><p>é’ˆå¯¹æŸä¸ªäº‹ä»¶å­—æ®µç¿»è¯‘ï¼Œéœ€è¦æä¾›å­—å…¸ã€‚</p><pre><code class="language-yaml">filter &#123;  translate &#123;    field =&gt; &quot;response_code&quot;    target =&gt; &quot;http_response&quot;    dictionary =&gt; &#123;      &quot;200&quot; =&gt; &quot;OK&quot;      &quot;403&quot; =&gt; &quot;Forbidden&quot;      &quot;404&quot; =&gt; &quot;Not Found&quot;      &quot;408&quot; =&gt; &quot;Request Timeout&quot;    &#125;    remove_field =&gt; &quot;response_code&quot;  &#125;&#125;</code></pre><p><code>field</code> æŒ‡å®šåŸå­—æ®µ</p><p><code>target</code> æŒ‡å®šç¿»è¯‘åçš„å­—æ®µ</p><p><code>dictionary</code> æŒ‡å®šç¿»è¯‘å­—å…¸.å·¦è¾¹æ˜¯åŸå­—æ®µï¼Œå³è¾¹æ˜¯ç¿»è¯‘åå­—æ®µ</p><h3 id="useragent-filter">useragent filter</h3><p>å°†agentå­—ç¬¦ä¸²è½¬åŒ–æˆkvå¯¹</p><pre><code class="language-yaml">filter &#123;  useragent &#123;    source =&gt; &quot;agent&quot;    target =&gt; &quot;user_agent&quot;    remove_field =&gt; &quot;agent&quot;  &#125;&#125;</code></pre><p>äº‹ä»¶çš„æ–°å­—æ®µï¼š</p><pre><code class="language-json">        &quot;user_agent&quot;: &#123;          &quot;os&quot;: &quot;Mac OS X 10.12&quot;,          &quot;major&quot;: &quot;50&quot;,          &quot;minor&quot;: &quot;0&quot;,          &quot;os_minor&quot;: &quot;12&quot;,          &quot;os_major&quot;: &quot;10&quot;,          &quot;name&quot;: &quot;Firefox&quot;,          &quot;os_name&quot;: &quot;Mac OS X&quot;,          &quot;device&quot;: &quot;Other&quot;        &#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜02ELKåŸºæœ¬ä½¿ç”¨-logstashç»„ä»¶01-å®‰è£…</title>
      <link href="posts/f73d84da/"/>
      <url>posts/f73d84da/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2><p>logstash ä½¿ç”¨<code>inputs</code>æ¥æ”¶åˆ›å»ºæ•°æ®ï¼Œ<code>filters</code>è¿‡æ»¤ä¿®æ”¹æ•°æ®ï¼Œ<code>outputs</code>è¾“å‡ºæ•°æ®ã€‚ä¸‰ç§åŠ¨ä½œå‡é€šè¿‡æ’ä»¶å®ç°ã€‚</p><p>å…¶ä¸­ï¼Œinputså’Œoutputsæ”¯æŒå°†<code>codecs</code>ç¼–ç å™¨ä½œä¸ºè‡ªèº«çš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="inputs">inputs</h3><p>inputsæ”¯æŒå¤šä¸ªæ’ä»¶ç±»å‹ï¼Œä¸ºäº†ç¼“è§£è‡ªèº«å‹åŠ›ï¼Œä¸€èˆ¬æˆ‘ä»¬é€šè¿‡beatsæ’ä»¶ï¼Œä»beatsç»„ä»¶è·å–</p><p>â„¹ï¸å…·ä½“æ’ä»¶ä»‹ç»æŸ¥çœ‹ï¼š<a href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html">https://www.elastic.co/guide/en/logstash/current/input-plugins.html</a></p><p>inputsè´Ÿè´£åˆ›å»ºæ‘„å…¥ç®¡é“(pipeline)ï¼Œæ¯ä¸€ä¸ªç®¡é“ä¼šå¯¹åº”å¼€å¯ä¸€ä¸ªç«¯å£ï¼Œç«¯å£ã€ä¸å¯é‡å¤ã€‘.</p><h3 id="filters">filters</h3><p>filtersæ”¯æŒå¤šä¸ªæ’ä»¶ç±»å‹ï¼Œå¸¸ç”¨çš„æœ‰ï¼š</p><ul><li>grok ç”¨äºå°†éç»“æ„åŒ–äº‹ä»¶å¡‘é€ æˆç»“æ„åŒ–äº‹ä»¶</li><li>mutate é’ˆå¯¹äº‹ä»¶å­—æ®µè¿›è¡Œå¢åˆ æ”¹</li><li>drop å®Œå…¨åˆ é™¤ä¸€ä¸ªäº‹ä»¶</li><li>geoip ç»™äº‹ä»¶æ·»åŠ åœ°ç†ä½ç½®</li></ul><p>â„¹ï¸å…·ä½“æ’ä»¶ä»‹ç»æŸ¥çœ‹ï¼š<a href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html">https://www.elastic.co/guide/en/logstash/current/filter-plugins.html</a></p><h3 id="outputs">outputs</h3><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥å§‹ç»ˆç”¨elasticsearchä½œä¸ºoutputè¾“å‡ºå¯¹è±¡ã€‚</p><p>â„¹ï¸å…·ä½“æ’ä»¶ä»‹ç»æŸ¥çœ‹ï¼š<a href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html">https://www.elastic.co/guide/en/logstash/current/output-plugins.html</a></p><h3 id="codecs">codecs</h3><p>æ¯”è¾ƒå¸¸ç”¨çš„æ’ä»¶æœ‰ï¼Œjsonã€json_lines</p><p>â„¹ï¸å…·ä½“æ’ä»¶ä»‹ç»æŸ¥çœ‹ï¼š<a href="https://www.elastic.co/guide/en/logstash/current/codec-plugins.html">https://www.elastic.co/guide/en/logstash/current/codec-plugins.html</a></p><p>ä¸‰è€…çš„åˆä½œæ–¹å¼æ˜¯ï¼š</p><p>inputså°†æ¥æ”¶äº‹ä»¶ï¼Œå¹¶å°†äº‹ä»¶å†™å…¥å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸€ä¸ªç®¡é“çš„å·¥ä½œçº¿ç¨‹ä»é˜Ÿåˆ—é‡Œè·å–æ•°æ®ï¼Œäº¤ç»™filterså¤„ç†ï¼Œæœ€åé€šè¿‡outputè¾“å‡ºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½äºå†…å­˜ä¸­çš„æ—¶é—´é˜Ÿåˆ—æ— æ³•ä¿è¯å¯é æ€§ï¼Œå› æ­¤å¦‚æœä¸è®¾ç½®æŒä¹…é˜Ÿåˆ—ï¼Œåˆ™ä¸€æ—¦å‡ºç°æ„å¤–ï¼Œæ•°æ®å°†ä¸¢å¤±ã€‚</p><p>å…³äºé˜Ÿåˆ—æŒä¹…ï¼Œæœ‰ä¸¤å¤§ç±»ï¼Œç¬¬ä¸€ç±»æ˜¯inputså°†äº‹ä»¶å†™å…¥åˆ°æœ¬åœ°ç£ç›˜å­˜å‚¨ï¼Œç¬¬äºŒç±»æ˜¯åœ¨logstashå‰æ”¾ä¸€ä¸ªå…¶å®ƒæœåŠ¡ï¼Œä¾‹å¦‚kafkaæˆ–è€…redisï¼Œé€šè¿‡å…¶å®ƒæœåŠ¡æ¥æå‰æ„å»ºé«˜å¯ç”¨çš„äº‹ä»¶é˜Ÿåˆ—.</p><p>å…·ä½“å‚è€ƒï¼š<a href="https://www.elastic.co/guide/en/logstash/current/persistent-queues.html">https://www.elastic.co/guide/en/logstash/current/persistent-queues.html</a></p><h2 id="å®‰è£…">å®‰è£…</h2><p>è¯¦ç»†çš„å®‰è£…æ–‡æ¡£å‚è€ƒ <a href="https://www.elastic.co/guide/en/logstash/current/installing-logstash.html#_yum">https://www.elastic.co/guide/en/logstash/current/installing-logstash.html#_yum</a></p><p>ä»¥äºŒè¿›åˆ¶å®‰è£…ä¸ºä¾‹</p><h3 id="äºŒè¿›åˆ¶">äºŒè¿›åˆ¶</h3><p><a href="https://mirrors.huaweicloud.com/logstash/">https://mirrors.huaweicloud.com/logstash/</a></p><pre><code class="language-bash">lsVersion=7.15.1curl &quot;https://mirrors.huaweicloud.com/logstash/$&#123;lsVersion&#125;/logstash-$&#123;lsVersion&#125;-linux-x86_64.tar.gz&quot; -o logstash.tgztar xf logstash.tgzmv logstash-$&#123;lsVersion&#125; ../logstash &amp;&amp; cd ..cd logstash</code></pre><h3 id="docker">docker</h3><pre><code class="language-bash">version: '2.3'services:  logstash:    image: docker.elastic.co/logstash/logstash:7.15.1    container_name: logstash    volumes:      - /export/logstash/pipeline:/usr/share/logstash/pipeline      - /export/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml      - /export/logstash/config/pipelines.yml:/usr/share/logstash/config/pipelines.yml      - /export/logstash/data:/usr/share/logstash/data    ports:      - &quot;5044:5044&quot;      - &quot;9600:9600&quot;    networks:      - esnet    cpus: 1    mem_limit: 1g    memswap_limit: 1g    mem_reservation: 1g    healthcheck:      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:9600&quot;]      interval: 1m30s      timeout: 10s      retries: 3      start_period: 120s    restart: on-failurenetworks:  esnet:</code></pre><p>â„¹ï¸é€šè¿‡è‡ªå®šä¹‰çš„pipelinesè¦†ç›–æ‰é»˜è®¤çš„pipelinesï¼Œ<a href="http://xn--pipelinespipeline-ys50a2w950g962gzf7c2s7e7kqe.id">é»˜è®¤çš„pipelinesåªæœ‰ä¸€ä¸ªpipeline.id</a>:main</p><h2 id="ä¸»é…ç½®">ä¸»é…ç½®</h2><pre><code class="language-bash">cp /export/logstash/config/logstash.yml /export/logstash/config/logstash.yml.defaulthostName=`hostname`cat &gt; /export/logstash/config/logstash.yml &lt;&lt; EOFnode.name: hadoop001http.host: 0.0.0.0http.port: 9600log.level: infoconfig.reload.automatic: trueconfig.reload.interval: 10sconfig.support_escapes: false#xpack.monitoring.elasticsearch.username: logstash_system#xpack.monitoring.elasticsearch.password: $&#123;ES_PWD&#125;EOF</code></pre><p>logstash ä¸»é…ç½®å†™æ³•ï¼š<a href="https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html">https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html</a></p><p>â„¹ï¸logstash é€šè¿‡ path.settings æ¥å¯»æ‰¾ç›®å½•ä¸‹çš„ pipelines.yml é…ç½®</p><h2 id="ä¸»é…ç½®-å®‰å…¨">ä¸»é…ç½®(å®‰å…¨)</h2><ol><li><p>å¼€é€šESçš„å®‰å…¨é…ç½®ï¼Œå¹¶åˆå§‹åŒ–å†…ç½®ç”¨æˆ·</p></li><li><p>åˆ›å»ºå¯†é’¥åº“ï¼Œå­˜æ”¾åŠ å¯†å¯†ç </p></li></ol><pre><code class="language-bash">bin/logstash-keystore create=&gt;è¾“å…¥y,è¡¨ç¤ºä¸è®¾ç½®å¯†é’¥åº“çš„å¯†ç bin/logstash-keystore add ES_PWD=&gt;è¾“å…¥ES_PWD</code></pre><ol start="3"><li>åˆ é™¤ä¸»é…ç½®é‡Œçš„xpackä¸¤ä¸ªé€‰é¡¹çš„æ³¨é‡Š</li></ol><h2 id="ç®¡é“é…ç½®">ç®¡é“é…ç½®</h2><p>ç®¡é“é…ç½®çš„ç¼–å†™ä¸€èˆ¬æ˜¯éœ€è¦ä¾æ‰˜äºbeatsç»„ä»¶ï¼Œæˆ–è€…beatsç»„ä»¶åçš„æ¶ˆæ¯é˜Ÿåˆ—ç»„ä»¶.</p><p>ç®¡é“é…ç½®åˆ†å¤šä¸ªæ­¥éª¤ï¼š<code>input</code>ã€<code>filter</code>ã€<code>output</code></p><p><a href="https://www.elastic.co/guide/en/logstash/current/input-plugins.html">https://www.elastic.co/guide/en/logstash/current/input-plugins.html</a></p><p><a href="https://www.elastic.co/guide/en/logstash/current/filter-plugins.html">https://www.elastic.co/guide/en/logstash/current/filter-plugins.html</a></p><p><a href="https://www.elastic.co/guide/en/logstash/current/output-plugins.html">https://www.elastic.co/guide/en/logstash/current/output-plugins.html</a></p><p>é…ç½®æ–‡ä»¶ï¼šconfig/pipelines.yml</p><pre><code class="language-yaml">- pipeline.id: upstream_server  config.string: |    input &#123;      kafka &#123;        topics_pattern =&gt; &quot;zz.it.elk\..*&quot;        group_id =&gt; &quot;logstash&quot;        bootstrap_servers =&gt; &quot;hadoop001:8123,hadoop002:8123,hadoop003:8123&quot;        security_protocol =&gt; &quot;SASL_PLAINTEXT&quot;        sasl_mechanism =&gt; &quot;SCRAM-SHA-256&quot;        sasl_jaas_config =&gt; &quot;org.apache.kafka.common.security.scram.ScramLoginModule required username='elk'  password='123456';&quot;        codec =&gt;&quot;json&quot;      &#125;    &#125;    output &#123;      if [fields][log_topic] == &quot;zz.it.elk.syslog.secure&quot; &#123;        pipeline &#123; send_to =&gt; syslog &#125;      &#125; else &#123;        pipeline &#123; send_to =&gt; apache &#125;      &#125;    &#125;- pipeline.id: apache  pipeline.workers: 3  queue.type: persisted  #path.config: &quot;/usr/share/logstash/pipeline/beats-5044.conf&quot;  config.string: |    input &#123;      pipeline &#123;        address =&gt; apache      &#125;    &#125;    filter &#123;      mutate &#123;        remove_tag =&gt; [&quot;beats_input_codec_plain_applied&quot;]      &#125;    &#125;    output &#123;      elasticsearch &#123;          hosts =&gt; [&quot;hadoop001:9200&quot;,&quot;hadoop002:9200&quot;,&quot;hadoop003:9200&quot;]          user =&gt; &quot;index_admin&quot;          password =&gt; &quot;$&#123;INDEX_PWD&#125;&quot;          manage_template =&gt; false          index =&gt; &quot;%&#123;[tags][0]&#125;-%&#123;[tags][1]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;        &#125;    &#125;- pipeline.id: syslog  pipeline.workers: 1  queue.type: persisted  #path.config: &quot;/usr/share/logstash/pipeline/beats-5045.conf&quot;  config.string: |    input &#123;      pipeline &#123;        address =&gt; syslog      &#125;    &#125;    filter &#123;      mutate &#123;        remove_tag =&gt; [&quot;beats_input_codec_plain_applied&quot;]      &#125;    &#125;    output &#123;      elasticsearch &#123;          hosts =&gt; [&quot;hadoop001:9200&quot;,&quot;hadoop002:9200&quot;,&quot;hadoop003:9200&quot;]          user =&gt; &quot;index_admin&quot;          password =&gt; &quot;$&#123;INDEX_PWD&#125;&quot;          manage_template =&gt; false          index =&gt; &quot;%&#123;[tags][0]&#125;-%&#123;[tags][1]&#125;-all-%&#123;+YYYY.MM.dd&#125;&quot;        &#125;    &#125;</code></pre><p>âš ï¸æ•°æ®è¿›kafkaåï¼Œä¼šè½¬ä¸ºjsonæ ¼å¼ï¼Œå› æ­¤éœ€è¦åœ¨inputä¸­åŠ å…¥jsonç¼–ç å™¨</p><p>âš ï¸<code>output.elasticsearch.user</code>çš„ç”¨æˆ·éœ€è¦åœ¨ESä¸­åˆ›å»ºã€‚å¯ä»¥ä½¿ç”¨kibanaç”¨æˆ·ç®¡ç†ä¸­å»åˆ›å»ºï¼Œå…¶ç”¨æˆ·çš„è§’è‰²æƒé™ç¤ºä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a href="https://www.elastic.co/guide/en/logstash/current/ls-security.html">https://www.elastic.co/guide/en/logstash/current/ls-security.html</a></p><p><img src="/posts/f73d84da/image-20211129164142226.png" alt="image-20211129164142226"></p><h2 id="æµ‹è¯•">æµ‹è¯•</h2><pre><code class="language-bash">cd /export/logstashbin/logstash --config.test_and_exit</code></pre><h3 id="æ•°æ®debug">æ•°æ®debug</h3><p>pipelines.outputé…ç½®<code>stdout</code>æ’ä»¶</p><pre><code class="language-bash">    output &#123;      stdout &#123;&#125;    &#125;</code></pre><pre><code class="language-bash">bin/logstash -e</code></pre><p>å¯ä»¥è§‚å¯Ÿ logstash è·å–çš„äº‹ä»¶</p><h2 id="å¯åŠ¨">å¯åŠ¨</h2><pre><code class="language-bash">cd /export/logstashnohup bin/logstash &amp;</code></pre><h2 id="é…ç½®è‡ªåŠ¨é‡è½½">é…ç½®è‡ªåŠ¨é‡è½½</h2><p>dockeræ¨¡å¼ä¸‹çš„logstashå·²ç»æ˜¯è‡ªåŠ¨é‡è½½ï¼Œå¦‚æœä½ æ˜¯äºŒè¿›åˆ¶æ–¹å¼ï¼Œåˆ™å¯åŠ¨çš„æ—¶å€™è¿½åŠ <code>--config.reload.automatic</code></p><p>å½“ Logstash æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶ä¸­çš„æ›´æ”¹æ—¶ï¼Œå®ƒä¼šé€šè¿‡åœæ­¢æ‰€æœ‰è¾“å…¥æ¥åœæ­¢å½“å‰ç®¡é“ï¼Œå¹¶å°è¯•åˆ›å»ºä½¿ç”¨æ›´æ–°é…ç½®çš„æ–°ç®¡é“ã€‚åœ¨éªŒè¯æ–°é…ç½®çš„è¯­æ³•åï¼ŒLogstash ä¼šéªŒè¯æ‰€æœ‰è¾“å…¥å’Œè¾“å‡ºæ˜¯å¦éƒ½å¯ä»¥åˆå§‹åŒ–ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰å¿…éœ€çš„ç«¯å£éƒ½å·²æ‰“å¼€ï¼‰ã€‚å¦‚æœæ£€æŸ¥æˆåŠŸï¼ŒLogstash ä¼šå°†ç°æœ‰ç®¡é“ä¸æ–°ç®¡é“äº¤æ¢ã€‚å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œæ—§ç®¡é“å°†ç»§ç»­è¿è¡Œï¼Œå¹¶å°†é”™è¯¯ä¼ æ’­åˆ°æ§åˆ¶å°ã€‚</p><p>åœ¨è‡ªåŠ¨é…ç½®é‡æ–°åŠ è½½æœŸé—´ï¼ŒJVM ä¸ä¼šé‡æ–°å¯åŠ¨ã€‚ç®¡é“çš„åˆ›å»ºå’Œäº¤æ¢éƒ½å‘ç”Ÿåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚</p><p>å¯¹filter-grokéƒ¨åˆ†çš„æ›´æ”¹ä¹Ÿä¼šé‡æ–°åŠ è½½ï¼Œä½†ä»…åœ¨é…ç½®æ–‡ä»¶ä¸­çš„æ›´æ”¹è§¦å‘é‡æ–°åŠ è½½ï¼ˆæˆ–ç®¡é“é‡æ–°å¯åŠ¨ï¼‰æ—¶æ‰ä¼šé‡æ–°åŠ è½½ã€‚</p><h2 id="ç®¡é“é…ç½®ï¼šå¤šé‡ç®¡é“">ç®¡é“é…ç½®ï¼šå¤šé‡ç®¡é“</h2><p><a href="https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html">https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html</a></p><p>åœ¨ä¸€ä¸ªlogstashå®ä¾‹ä¸­é…ç½®å¤šä¸ª<code>pipeline</code>ï¼Œç”šè‡³ï¼Œè¿˜å¯ä»¥ç®¡é“åˆ°ç®¡é“</p><p><a href="https://www.elastic.co/guide/en/logstash/current/pipeline-to-pipeline.html#pipeline-to-pipeline">https://www.elastic.co/guide/en/logstash/current/pipeline-to-pipeline.html#pipeline-to-pipeline</a></p><p>ç®¡é“åˆ°ç®¡é“æ¶‰åŠä¸€ä¸ªæ¦‚å¿µï¼šã€è™šæ‹Ÿåœ°å€ã€‘ï¼Œä»¥ä¸‹é¢ä¾‹å­è¯´æ˜ï¼š</p><pre><code class="language-yaml"># config/pipelines.yml- pipeline.id: upstream  config.string: input &#123; stdin &#123;&#125; &#125; output &#123; pipeline &#123; send_to =&gt; [myVirtualAddress] &#125; &#125;- pipeline.id: downstream  config.string: input &#123; pipeline &#123; address =&gt; myVirtualAddress &#125; &#125;</code></pre><p>â„¹ï¸<code>send_to</code>è¿æ¥è™šæ‹Ÿåœ°å€ï¼Œ<code>address</code>åˆ›å»ºè™šæ‹Ÿåœ°å€</p><ol><li>ä¸‹æ¸¸ç®¡é“è¾“å…¥å……å½“è™šæ‹ŸæœåŠ¡å™¨ï¼Œä¾¦å¬æœ¬åœ°è¿›ç¨‹ä¸­çš„å•ä¸ªè™šæ‹Ÿåœ°å€ã€‚</li><li>åªæœ‰åœ¨åŒä¸€ä¸ª Logstash ä¸Šè¿è¡Œçš„ä¸Šæ¸¸ç®¡é“è¾“å‡ºæ‰èƒ½å°†äº‹ä»¶å‘é€åˆ°æ­¤è™šæ‹Ÿåœ°å€åˆ—è¡¨ã€‚</li><li>å¦‚æœä¸‹æ¸¸ç®¡é“è¢«é˜»å¡æˆ–ä¸å¯ç”¨ï¼Œåˆ™ä¸Šæ¸¸ç®¡é“è¾“å‡ºå°†è¢«é˜»å¡ã€‚</li><li>å½“äº‹ä»¶è·¨ç®¡é“å‘é€æ—¶ï¼Œå®ƒä»¬çš„æ•°æ®è¢«å®Œå…¨å¤åˆ¶ï¼Œå› æ­¤å¯¹ä¸‹æ¸¸ç®¡é“ä¸­äº‹ä»¶çš„ä¿®æ”¹ä¸ä¼šå½±å“ä¸Šæ¸¸ç®¡é“ä¸­çš„è¯¥äº‹ä»¶ã€‚</li><li>ç®¡é“æ’ä»¶å¯èƒ½æ˜¯ç®¡é“ä¹‹é—´é€šä¿¡çš„æœ€æœ‰æ•ˆæ–¹å¼ï¼Œä½†å®ƒä»ç„¶ä¼šäº§ç”Ÿæ€§èƒ½æˆæœ¬ã€‚å› ä¸º Logstash å¿…é¡»åœ¨ Java å †ä¸Šä¸ºæ¯ä¸ªä¸‹æ¸¸ç®¡é“å®Œæ•´å¤åˆ¶æ¯ä¸ªäº‹ä»¶ã€‚ä½¿ç”¨æ­¤åŠŸèƒ½å¯èƒ½ä¼šå½±å“ Logstash çš„å †å†…å­˜åˆ©ç”¨ç‡ã€‚</li></ol><h3 id="å¤šé‡åˆ†é”€å•†æ¨¡å¼">å¤šé‡åˆ†é”€å•†æ¨¡å¼</h3><p>é€šè¿‡ beats-server.input ç®¡é“æ¥æ”¶ï¼Œåœ¨ beats-server.output ä¸­è¿›è¡Œäº‹ä»¶å­—æ®µåˆ¤æ–­åï¼Œé€šè¿‡è™šæ‹Ÿåœ°å€åˆ†å‘åˆ°å¤šä¸ªç®¡é“</p><p>ç¼ºç‚¹ï¼šåˆ†å‘çš„æ•°æ®æ˜¯å¤åˆ¶çš„ï¼Œå› æ­¤å†…å­˜ä½¿ç”¨ä¼šå¢å¤§ã€‚</p><pre><code class="language-yaml">cat &gt; /export/docker-compose-data/logstash/pipelines.yml &lt;&lt; EOF- pipeline.id: beats_server  config.string: |    input &#123;      beats &#123;        port =&gt; 5044      &#125;    &#125;    output &#123;      if [tags][1] == &quot;access&quot; &#123;        pipeline &#123; send_to =&gt; access &#125;      &#125; else &#123;        pipeline &#123; send_to =&gt; error &#125;      &#125;    &#125;- pipeline.id: apache_access  pipeline.workers: 3  pipeline.batch.size: 500  queue.type: persisted  config.string: |    input &#123;      pipeline &#123;        address =&gt; access      &#125;    &#125;    filter &#123;      mutate &#123;        remove_tag =&gt; [&quot;beats_input_codec_plain_applied&quot;]      &#125;    &#125;    output &#123;      elasticsearch &#123;          hosts =&gt; [&quot;es01:9200&quot;]          manage_template =&gt; false          index =&gt; &quot;%&#123;[tags][0]&#125;-%&#123;[tags][1]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;        &#125;    &#125;- pipeline.id: apache_error  pipeline.workers: 1  pipeline.batch.size: 125  queue.type: persisted  config.string: |    input &#123;      pipeline &#123;        address =&gt; error      &#125;    &#125;    filter &#123;      mutate &#123;        remove_tag =&gt; [&quot;beats_input_codec_plain_applied&quot;]      &#125;    &#125;    output &#123;      elasticsearch &#123;          hosts =&gt; [&quot;es01:9200&quot;]          manage_template =&gt; false          index =&gt; &quot;%&#123;[tags][0]&#125;-%&#123;[tags][1]&#125;-all-%&#123;+YYYY.MM.dd&#125;&quot;        &#125;    &#125;EOF</code></pre><p>â„¹ï¸</p><p>æ¯ä¸€ä¸ªç®¡é“çš„å†…å­˜é˜Ÿåˆ—å¤§å°=pipeline.workers*pipeline.batch.size, å†…å­˜é˜Ÿåˆ—å¤§å°å†³å®šäº†åŒä¸€æ—¶é—´å¯å¤„ç†çš„äº‹ä»¶æ•°.</p><p>é»˜è®¤æƒ…å†µä¸‹,pipeline.workers = vcpu , pipeline.batch.size = 125.</p><p>âš ï¸å½“é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œlogstashä¼šé˜»å¡input,é˜²æ­¢æ–°äº‹ä»¶æµå…¥ã€‚</p><h3 id="åˆ†å‰è·¯å¾„æ¨¡å¼">åˆ†å‰è·¯å¾„æ¨¡å¼</h3><p>è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œbeats_server.input æ”¶åˆ°æ•°æ®åï¼Œbeats_server.outputä¼šä¸ç»æ¡ä»¶åˆ¤æ–­ï¼Œç›´æ¥å°†æ•°æ®é€šè¿‡è™šæ‹Ÿåœ°å€ï¼ˆes,httpï¼‰å¤åˆ¶åˆ°é¢å¤–çš„ä¸¤ä¸ªç®¡é“ï¼ˆbufferd-es,bufferd-httpï¼‰ã€‚</p><p>ä¼˜ç‚¹ï¼šbufferd-es å’Œ bufferd-httpç®¡é“äº’ä¸å¹²æ‰°ï¼Œä¸”å¯ä»¥åˆ†åˆ«è®¾å®šè¿‡æ»¤è§„åˆ™.</p><p>ç¼ºç‚¹ï¼šèµ„æºæ¶ˆè€—æ–¹é¢æ˜¯æˆå€æ•°å¢åŠ çš„ï¼Œæ¯å¤šä¸€ä¸ªç®¡é“ï¼Œå°±éœ€è¦å¤šä¸€å€çš„èµ„æº.ä¾‹å¦‚ä¸‹åˆ—é…ç½®ä¸­ï¼Œbufferd-eså’Œbufferd-httpå‡å¼€å¯äº†æŒä¹…åŒ–ï¼ˆqueue.type: persistedï¼‰ï¼Œè¿™æ„å‘³ç€é¢å¤–çš„åŒå€ç£ç›˜æ¶ˆè€—ã€‚</p><pre><code class="language-yaml">cat &gt; /export/docker-compose-data/logstash/pipelines.yml &lt;&lt; EOF- pipeline.id: beats_server  config.string: |    input &#123;      beats &#123;        port =&gt; 5044      &#125;    &#125;    output &#123;        pipeline &#123; send_to =&gt; [es, s3] &#125;    &#125;- pipeline.id: es  pipeline.workers: 3  queue.type: persisted  config.string: |    input &#123;      pipeline &#123;        address =&gt; es      &#125;    &#125;    filter &#123;      mutate &#123;        remove_tag =&gt; [&quot;beats_input_codec_plain_applied&quot;]      &#125;    &#125;    output &#123;      elasticsearch &#123;          hosts =&gt; [&quot;es01:9200&quot;]          manage_template =&gt; false          index =&gt; &quot;%&#123;[tags][0]&#125;-%&#123;[tags][1]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;        &#125;    &#125;- pipeline.id: s3  pipeline.workers: 1  queue.type: persisted  config.string: |    input &#123;      pipeline &#123;        address =&gt; s3      &#125;    &#125;    filter &#123;      mutate &#123;        remove_tag =&gt; [&quot;beats_input_codec_plain_applied&quot;]      &#125;    &#125;    output &#123;      s3 &#123;&#125;    &#125;EOF</code></pre><p>âš ï¸æ ¹æ® input çš„ç±»å‹ï¼Œinput æ’ä»¶å¯èƒ½æ˜¯ client ä¹Ÿå¯èƒ½æ˜¯ serverï¼Œåœ¨å……å½“ server è§’è‰²çš„æ—¶å€™ï¼Œåº”è¯¥ä¿è¯ç«¯å£å”¯ä¸€ã€‚</p><h2 id="ç®¡é“é…ç½®ï¼šæŒä¹…é˜Ÿåˆ—">ç®¡é“é…ç½®ï¼šæŒä¹…é˜Ÿåˆ—</h2><p>é»˜è®¤äº‹ä»¶é˜Ÿåˆ—æ˜¯å†…å­˜çº§åˆ«ï¼Œå› æ­¤æ•°æ®å¯èƒ½ä¸¢å¤±ï¼Œè€ŒæŒä¹…é˜Ÿåˆ—æ˜¯å®šæœŸå°†å†…å­˜æ•°æ®å†™å…¥åˆ°ç£ç›˜ã€‚</p><p>å·¥ä½œæµæ˜¯ï¼šè¾“å…¥â†’é˜Ÿåˆ—(ç£ç›˜)â†’è¿‡æ»¤å™¨+è¾“å‡º</p><p>å½“è¾“å…¥æœ‰äº‹ä»¶å‡†å¤‡å¥½å¤„ç†æ—¶ï¼Œå®ƒä¼šå°†äº‹ä»¶å†™å…¥é˜Ÿåˆ—ã€‚å½“å†™å…¥é˜Ÿåˆ—æˆåŠŸæ—¶ï¼Œè¾“å…¥å¯ä»¥å‘å…¶æ•°æ®æºå‘é€ç¡®è®¤ã€‚å› æ­¤ï¼Œè¦æ±‚è¾“å…¥æºå¿…é¡»æ”¯æŒäº‹ä»¶ç¡®è®¤ã€‚ï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰çš„inputæ’ä»¶éƒ½æ”¯æŒï¼Œä½†beatså’Œhttpæ’ä»¶æ˜¯æ”¯æŒçš„ï¼‰.</p><p>ç»è¿‡è¿‡æ»¤å™¨å’Œè¾“å‡ºæˆåŠŸåï¼Œäº‹ä»¶å°†è¢«æ ‡è®°ä¸ºã€ç¡®è®¤(ACKed)ã€‘.</p><p>âš ï¸ å¦‚æœäº‹ä»¶åœ¨ç»å†è¿‡æ»¤å™¨å’Œè¾“å‡ºæˆåŠŸåï¼Œä¸”è¿˜æœªæ¥å¾—åŠæ ‡è®°ä¸ºã€ç¡®è®¤(ACKed)ã€‘çš„æƒ…å†µä¸‹ï¼Œlogstashçªç„¶æŒ‚äº†ï¼Œé‚£ä¹ˆåœ¨logstashå¯åŠ¨åï¼Œäº‹ä»¶ä¼šè¢«é‡å¤å‘é€ï¼Œè¿™ä¼šå¯¼è‡´è¾“å‡ºç«¯æ¥æ”¶åˆ°é‡å¤äº‹ä»¶ã€‚</p><p>æŒä¹…é˜Ÿåˆ—åˆ†ä¸ºä¸¤éƒ¨åˆ†æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ä¿å­˜äº‹ä»¶çš„å¤šä»½æ•°æ®é˜Ÿåˆ—æ–‡ä»¶<code>page.&lt;num&gt;</code>ï¼Œä¸€ä¸ªæ˜¯è®°å½•äº‹ä»¶ä¿¡æ¯çš„å•ä¸ªæ£€æŸ¥ç‚¹æ–‡ä»¶<code>checkpoint.xxx</code>ã€‚</p><ul><li>æ¯æœ‰xä¸ªäº‹ä»¶è¢«å†™å…¥åˆ°é˜Ÿåˆ—æ–‡ä»¶ï¼Œæ£€æŸ¥ç‚¹æ–‡ä»¶å°±ä¼šæ›´æ–°ä¸€æ¬¡ã€‚</li><li>æ¯æœ‰xä¸ªäº‹ä»¶è¢«ç¡®è®¤ï¼Œæ£€æŸ¥ç‚¹æ–‡ä»¶ä¹Ÿä¼šæ›´æ–°ä¸€æ¬¡ã€‚</li></ul><p>æ•°æ®é˜Ÿåˆ—æ–‡ä»¶: æŒ‰ç…§<code>queue.page_capacity</code>å®šä¹‰çš„å¤§å°è¿›è¡Œåˆ‡åˆ†ã€‚ã€æœ€æ–°ã€‘çš„ä¸€ä»½æ•°æ®æ–‡ä»¶è¢«ç§°ä¹‹ä¸ºå¤´æ–‡ä»¶ï¼ˆæ¥æ”¶inputäº‹ä»¶,åªå¯è¿½åŠ ï¼‰ï¼Œå…¶ä½™çš„å«å°¾æ–‡ä»¶ï¼ˆåªè¯»ä¸å¯å˜ï¼‰ï¼Œäº‹ä»¶ç¡®è®¤å®Œçš„å°¾é¡µå°†è¢«åˆ é™¤ã€‚</p><p>æ£€æŸ¥ç‚¹æ–‡ä»¶: åŒ…å«äº‹ä»¶æ‰€åœ¨çš„æ•°æ®æ–‡ä»¶ï¼Œæ˜¯å¦ç¡®è®¤ç­‰ä¿¡æ¯ã€‚å‡¡æ˜¯æ²¡æœ‰è¢«æ£€æŸ¥ç‚¹è®°å½•çš„äº‹ä»¶ï¼Œå‡å¯ä»¥è®¤ä¸ºæš‚ä¸å®‰å…¨.</p><p>æœ€åï¼Œä¸€ä¸ªè‡³å…³é‡è¦çš„ç‚¹ï¼Œlogstashå§‹ç»ˆé€šè¿‡ã€æ£€æŸ¥ç‚¹æ–‡ä»¶ã€‘æ¥åˆ¤æ–­äº‹ä»¶ã€‚</p><p>âš ï¸ logstashçªç„¶æ•…éšœï¼š</p><ul><li>ä¼šå¯¼è‡´æ²¡æœ‰è®°å½•åœ¨æ£€æŸ¥ç‚¹æ–‡ä»¶é‡Œçš„<code>buffered</code>äº‹ä»¶ä¸¢å¤±ã€‚(è¿™ä¸ªbufferedä¸ç¡®å®šæ˜¯ä¸æ˜¯æŒ‡çš„æ•°æ®é˜Ÿåˆ—ï¼Œä¹Ÿå¯èƒ½æŒ‡çš„æ˜¯å†…å­˜çš„bufferç©ºé—´)</li><li>ä¼šå¯¼è‡´å·²ç»å®Œæˆå¤„ç†ä½†å´æ¥ä¸åŠæ›´æ–°è¿›æ£€æŸ¥ç‚¹æ–‡ä»¶çš„äº‹ä»¶è¢«é‡å¤è¾“å‡ºã€‚</li></ul><p><code>pipelines.yml</code>ç¤ºä¾‹é…ç½®ï¼š</p><pre><code class="language-yaml">- pipeline.id: bufferd-to-disk  queue.type: persisted  queue.drain: false # å…³é—­logstashçš„æ—¶å€™ï¼Œä¸ç­‰å¾…ã€æŒä¹…é˜Ÿåˆ—ã€‘çš„äº‹ä»¶ç¡®è®¤å®Œæˆ  queue.page_capacity: 250mb  queue.max_bytes: 1024mb # æ‰€æœ‰ã€åŒ…å«ã€‘æœªå¤„ç†äº‹ä»¶çš„æ•°æ®é˜Ÿåˆ—é¡µæ€»å¤§å°ï¼Œè¿‡å¤§ä¼šå½±å“æ€§èƒ½ï¼Œè¿‡å°ä¼šåœ¨outputå‹åŠ›å¤§çš„æ—¶å€™é˜»å¡input  queue.checkpoint.writes: 1024 # æ•°æ®é˜Ÿåˆ—ã€å¤´é¡µã€‘æ¯å†™å…¥1024ä¸ªäº‹ä»¶ï¼Œå°±åˆ·æ–°ä¸€æ¬¡æ£€æŸ¥ç‚¹æ–‡ä»¶ã€‚å€¼è¶Šå°ï¼Œæ•…éšœåä¸¢å¤±çš„äº‹ä»¶å°±è¶Šå°‘ï¼Œç£ç›˜ioå‹åŠ›è¶Šå¤§ã€‚ä¸¢å¤±æ•°&lt;=å€¼ã€‚  queue.checkpoint.acks: 1024 # æ•°æ®é˜Ÿåˆ—ã€å°¾é¡µã€‘æ¯ç¡®è®¤1024ä¸ªäº‹ä»¶ï¼Œå°±åˆ·æ–°ä¸€æ¬¡æ£€æŸ¥ç‚¹æ–‡ä»¶ã€‚å€¼è¶Šå°ï¼Œæ•…éšœåé‡å¤å‘é€çš„äº‹ä»¶å°±è¶Šå°‘ï¼Œç£ç›˜ioå‹åŠ›è¶Šå¤§ã€‚é‡å¤æ•°&lt;=å€¼</code></pre><h2 id="ä¸»é…ç½®ï¼šæ­»ä¿¡é˜Ÿåˆ—">ä¸»é…ç½®ï¼šæ­»ä¿¡é˜Ÿåˆ—</h2><p><a href="https://www.elastic.co/guide/en/logstash/7.15/dead-letter-queues.html">https://www.elastic.co/guide/en/logstash/7.15/dead-letter-queues.html</a></p><p>å½“logstashæ— æ³•è§£æäº‹ä»¶çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹logstashä¼šä¸¢å¼ƒæˆ–è€…æŒ‚èµ·ã€‚</p><p>å¼€å¯æ­»ä¿¡é˜Ÿåˆ—å¯ä»¥æ”¶é›†è¿™äº›å¼‚å¸¸äº‹ä»¶ï¼Œç¡®ä¿logstashæ­£å¸¸è¿è¡Œã€‚ä¹‹åï¼Œæ­»ä¿¡é˜Ÿåˆ—çš„äº‹ä»¶éœ€è¦ã€äººå·¥ã€‘å¤„ç†ã€‚</p><p>âš ï¸å“ªæ€•ä½ å¼€å¯äº†æ­»ä¿¡é˜Ÿåˆ—ï¼Œä¹Ÿè¦ç¡®ä¿pipeline.outputæ˜¯elasticsearchï¼Œå› ä¸ºlogstashé€šè¿‡elasticsearchè¿”å›çš„çŠ¶æ€ç æ¥å®šæ€§æ­»ä¿¡ï¼Œå½“å‰åˆ¤æ–­å€¼ä¸º400/404ã€‚</p><p><img src="/posts/f73d84da/image-20211112170234694.png" alt="image-20211112170234694"></p><p>æ­»ä¿¡é˜Ÿåˆ—å¼€å¯æ–¹å¼ï¼š<code>dead_letter_queue.enable: true</code>ï¼Œå®ƒä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨ï¼Œä½äº<code>path.dead_letter_queue</code>/&lt;<a href="http://pipeline.id">pipeline.id</a>&gt;ã€‚ä»»æ„è¾“å‡º</p><p>âš ï¸ä¸¤ä¸ªlogstashå®ä¾‹ä¸èƒ½è®¾ç½®ç›¸åŒçš„<code>path.dead_letter_queue</code></p><p>æ–‡ä»¶åˆ‡åˆ†åˆ†ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>è¾¾åˆ°äº†æ–‡ä»¶å¤§å°ä¸Šé™<code>dead_letter_queue.max_bytes</code>ã€‚é»˜è®¤å€¼ï¼š1024mb</li><li>è¾¾åˆ°äº†åˆ·æ–°æ—¶é—´<code>dead_letter_queue.flush_interval</code>ã€‚é»˜è®¤å€¼: 5000msï¼Œä¸èƒ½ä½äº 1000ms</li></ol><p>â„¹ï¸ä¸Šé¢å‡ ä¸ª<code>dead_letter_queue</code>å‡ä¸ºä¸»é…ç½®</p><h3 id="äººå·¥å¤„ç†æ­»ä¿¡">äººå·¥å¤„ç†æ­»ä¿¡</h3><p><a href="https://www.elastic.co/guide/en/logstash/7.15/plugins-inputs-dead_letter_queue.html">https://www.elastic.co/guide/en/logstash/7.15/plugins-inputs-dead_letter_queue.html</a></p><p>å¤„ç†æ­»ä¿¡ï¼Œå°±æ˜¯æ–°æ„å»ºä¸€ä¸ªpipelineï¼Œä»æ­»ä¿¡ä¸­è¯»å–å¼‚å¸¸äº‹ä»¶ï¼Œå¹¶å†æ¬¡å¤„ç†çš„è¿‡ç¨‹.è¿™æœŸé—´éœ€è¦ç”¨åˆ°<code>Dead_letter_queue input plugin</code></p><p>å‡è®¾å¼‚å¸¸äº‹ä»¶æ˜¯<code>&#123;&quot;geoip&quot;:&#123;&quot;location&quot;:&quot;home&quot;&#125;&#125;</code> å¯ä»¥çœ‹å‡º<code>home</code>æ˜¯ä¸å¯¹çš„ï¼Œä¸ç¬¦åˆgeoipæ‰€éœ€è¦å€¼ç±»å‹.</p><pre><code class="language-yaml">input &#123;  dead_letter_queue &#123;    path =&gt; &quot;/path/to/data/dead_letter_queue&quot; # path.dead_letter_queue    start_timestamp =&gt; &quot;2017-06-06T23:40:37&quot;    commit_offsets =&gt; true     pipeline_id =&gt; &quot;main&quot;   &#125;&#125;filter &#123;  mutate &#123;    remove_field =&gt; &quot;[geoip][location]&quot;   &#125;&#125;output &#123;  elasticsearch&#123;    hosts =&gt; [ &quot;localhost:9200&quot; ]   &#125;&#125;</code></pre><p><code>commit_offsets</code> è¡¨ç¤ºè®°å½•åç§»ç‚¹ï¼Œæ„æ€å°±æ˜¯<code>input.dead_letter_queue</code>æ¯æ¬¡ä¸ä¼šä»å¼€å¤´é‡æ–°å¤„ç†ï¼Œè€Œæ˜¯ä»ä¸Šä¸€æ¬¡çš„å°¾ç«¯å¼€å§‹ã€‚</p><p><code>start_timestamp</code> è¡¨ç¤ºä»…å¤„ç†æŒ‡å®šæ—¶é—´ç‚¹ä¹‹åè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—çš„äº‹ä»¶.</p><p><code>pipeline_id</code> æŒ‡çš„æ˜¯å¾€æ­»ä¿¡é˜Ÿåˆ—é‡Œå†™å¼‚å¸¸äº‹ä»¶çš„ç®¡é“ã€‚é»˜è®¤æ˜¯main</p><p>é€šè¿‡<code>remove_field</code>åˆ é™¤å¼‚å¸¸çš„å­—æ®µï¼Œä»è€Œè§£å†³ã€‚</p><h3 id="åˆ é™¤æ­»ä¿¡æ•°æ®">åˆ é™¤æ­»ä¿¡æ•°æ®</h3><p>å…³æ‰pipelineï¼Œç„¶åç›´æ¥ç‰©ç†å±‚é¢åˆ é™¤<code>path.dead_letter_queue</code>/&lt;<a href="http://pipeline.id">pipeline.id</a>&gt;å³å¯</p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜01ELKåŸºæœ¬ä½¿ç”¨-beatsç»„ä»¶</title>
      <link href="posts/3475106c/"/>
      <url>posts/3475106c/</url>
      
        <content type="html"><![CDATA[<h2 id="Beats">Beats</h2><p>ä»¥filebeatä¸ºä¾‹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äºŒè¿›åˆ¶æ–¹å¼</p><p>å½“ç„¶è¿˜æœ‰æŒ‡æ ‡æ”¶é›†å™¨ï¼šMerticbeat</p><h3 id="å®‰è£…">å®‰è£…</h3><p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html</a></p><pre><code class="language-bash">mkdir -p /export/src &amp;&amp; cd /export/srccurl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.15.1-linux-x86_64.tar.gztar xzvf filebeat-7.15.1-linux-x86_64.tar.gzmv filebeat-7.15.1-linux-x86_64 ../filebeat &amp;&amp; cd ..cd filebeat</code></pre><h3 id="é…ç½®">é…ç½®</h3><p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/configuration-general-options.html#libbeat-configuration-fields">https://www.elastic.co/guide/en/beats/filebeat/current/configuration-general-options.html#libbeat-configuration-fields</a></p><pre><code class="language-bash"># æ·»åŠ é…ç½®æ–‡ä»¶cat &gt; filebeat.yml &lt;&lt; EOFfilebeat.config:  modules:    path: $&#123;path.config&#125;/modules.d/*.yml    reload.enabled: false#filebeat.autodiscover:#  providers:#    - type: docker#      hints.enabled: true#processors:#- add_cloud_metadata: ~filebeat.shutdown_timeout: 5s # Filebeat åœ¨å…³é—­æ—¶ç­‰å¾…å‘å¸ƒè€…å®Œæˆå‘é€äº‹ä»¶çš„æ—¶é—´# æ³¨å†Œè¡¨è®°å½•äº†æ”¶å‰²æœºè¯»å–æ–‡ä»¶çš„ä¿¡æ¯ä»¥åŠè¯»å–çš„æœ€åæŒ‡é’ˆä½ç½®close_removed: true # å¼€å¯çŠ¶æ€ä¸‹ï¼Œå¦‚æœæ–‡ä»¶è¢«åˆ é™¤æˆ–è€…æ”¹åï¼Œåˆ™æ”¶å‰²è¿›ç¨‹å°†ç«‹å³å…³é—­æ–‡ä»¶æè¿°ç¬¦å¹¶ç»ˆæ­¢è¯»å–ã€‚åä¹‹ï¼Œæ”¶å‰²è¿›ç¨‹å°†ä¼šåœ¨å®Œå…¨è¯»å–å®Œæ¯•åï¼Œæ‰ä¼šå…³é—­æ–‡ä»¶æè¿°ç¬¦ã€‚ï¼ˆå¦‚æœä½ è¦å…³é—­è¿™ä¸ªé€‰é¡¹ï¼Œåˆ™ clean_removed ä¹Ÿéœ€è¦å…³é—­ï¼‰.clean_removed: true # åªè¦æ³¨å†Œè¡¨é‡Œçš„æ–‡ä»¶ååœ¨ç£ç›˜ä¸Šæ‰¾ä¸åˆ°ï¼Œåˆ™æ¸…é™¤å¯¹åº”çš„æ³¨å†Œè¡¨é¡¹ã€‚å¼€å¯å®ƒï¼ˆé»˜è®¤å¼€å¯ï¼‰å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³æ³¨å†Œè¡¨è¿‡å¤§ã€‚ä½†è¿™ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“å…±äº«æ•°æ®ç›˜çŸ­æ—¶é—´å†…å–æ¶ˆæŒ‚è½½å¹¶é‡æ–°æŒ‚è½½ï¼Œåˆ™æ³¨å†Œè¡¨ä¼šé‡æ–°æ³¨å†Œæ–‡ä»¶ï¼Œè¿™å°†å¯¼è‡´æ–‡ä»¶è¢«é‡æ–°è¯»å–å‘é€ï¼ˆå³é‡å¤è¯»å–ï¼‰.filebeat.inputs:- type: log  enabled: true  paths:    - /var/log/secure-*  tags: [&quot;syslog&quot;,&quot;secure&quot;]  fields:    log_topic: zz.it.elk.syslog.secure- type: log  enabled: true  paths:    - /export/logs/*.log  tags: [&quot;apache&quot;,&quot;access&quot;]  fields:    log_topic: zz.it.elk.apache.access#- type: log#  enabled: true#  paths:#    - /export/logs/*.json#  tags: [&quot;apache&quot;,&quot;error&quot;]###  keys_under_rootå¯ä»¥è®©å­—æ®µä½äºæ ¹èŠ‚ç‚¹ï¼Œé»˜è®¤ä¸ºfalse#  json.keys_under_root: true##  å¯¹äºåŒåçš„keyï¼Œè¦†ç›–åŸæœ‰keyå€¼#  json.overwrite_keys: true#  json.message_key: message##  å°†è§£æé”™è¯¯çš„æ¶ˆæ¯è®°å½•å‚¨å­˜åœ¨error.messageå­—æ®µä¸­#  json.add_error_key: true##  æ—¥å¿—å¤šè¡Œåˆå¹¶é‡‡é›†ï¼ˆé…ç½®çš„æ—¶å€™ä¸€å®šè¦é¡¶æ ¼å†™ï¼‰#  multiline.pattern: '^&#123;'#  multiline.negate: true#  multiline.match: after# ecs å­—æ®µåˆ é™¤processors:  - drop_fields:      fields: [&quot;ecs&quot;,&quot;input&quot;,&quot;agent&quot;,&quot;log&quot;]output.kafka:  # initial brokers for reading cluster metadata  hosts: [&quot;hadoop001:8123&quot;, &quot;hadoop002:8123&quot;, &quot;hadoop003:8123&quot;]  username: elk  password: 123456  sasl.mechanism: SCRAM-SHA-256  # message topic selection + partitioning  topic: '%&#123;[fields.log_topic]&#125;'  partition.round_robin:    reachable_only: false  required_acks: 1  compression: gzip  max_message_bytes: 1000000EOF</code></pre><p>â„¹ï¸</p><ol><li>é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª<code>$&#123;path.config&#125;</code> è¿™æ˜¯å¼•ç”¨äº†é…ç½®<code>path.config</code>.å…³äºé¡¹ç›®è·¯å¾„çš„é…ç½®ï¼Œå¯ä»¥ä»https://www.elastic.co/guide/en/beats/filebeat/current/configuration-path.htmlä¸­è·å–.</li><li><code>reload.enabled</code>è¡¨ç¤ºå¼€å¯åŠ¨æ€é‡è½½ï¼Œå¼€å¯ä¹‹åï¼Œæ¯é—´éš”<code>reload.period</code>æ—¶é—´ï¼ŒBeatså°±ä¼šé‡è½½ä¸€æ¬¡<code>path</code>æŒ‡å®šçš„é…ç½®.å¯ä»¥ä»https://www.elastic.co/guide/en/beats/filebeat/current/_live_reloading.htmlä¸­è·å–.</li><li><code>filebeat.inputs</code>ä¸­æˆ‘ä»¬æ·»åŠ äº†é¢å¤–çš„<code>tags</code>ï¼Œè¿™ä¸ª<code>tags</code>å­—æ®µä¼šå‡ºç°åœ¨äº‹ä»¶çš„æ ¹ä¸‹ï¼Œå› æ­¤å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡<code>tags</code>æ¥åŠ¨æ€çš„ç”Ÿæˆç´¢å¼•å.</li></ol><h3 id="outputè´Ÿè½½å‡è¡¡">outputè´Ÿè½½å‡è¡¡</h3><p>ä»…æ”¯æŒredis/logstash/esï¼Œkafkaæ˜¯å†…éƒ¨è‡ªèº«è´Ÿè½½</p><pre><code class="language-yaml">output.logstash:  hosts: [&quot;localhost:5044&quot;, &quot;localhost:5045&quot;]  loadbalance: true  worker: 2</code></pre><p>ä¸å¼€å¯loadbalanceï¼Œä¸»æœºåˆ—è¡¨é‡Œéšæœºé€‰ä¸€ä¸ªä½œä¸ºè¾“å‡ºï¼Œè‹¥æ•…éšœå°±åˆ‡æ¢å¦ä¸€ä¸ªã€‚</p><p>å¼€å¯loadbalanceï¼Œå°†äº‹ä»¶å¹³è¡¡å‘é€åˆ°ä¸»æœºåˆ—è¡¨ï¼Œå…·ä½“é€»è¾‘å®˜ç½‘æ²¡è¯´ï¼Œåº”è¯¥æ˜¯è½®è¯¢å§ã€‚</p><h3 id="æµ‹è¯•-output-æ˜¯å¦å¯ç”¨">æµ‹è¯• output æ˜¯å¦å¯ç”¨</h3><pre><code class="language-bash">./filebeat test output</code></pre><h3 id="å¯åŠ¨">å¯åŠ¨</h3><ol><li>æµ‹è¯•æ•°æ®(ä¸€å®šä¸è¦é’ˆå¯¹å¤§æ–‡ä»¶ä½¿ç”¨)</li></ol><pre><code class="language-bash">./filebeat -e -d &quot;*&quot;# -e è¡¨ç¤ºå…³é—­æ–‡ä»¶æ—¥å¿—ï¼Œè¾“å‡ºåˆ°æ§åˆ¶å°# -d è¡¨ç¤ºå¼€å¯debugï¼Œåé¢&quot;*&quot;æŒ‡è¾“å‡ºæ‰€æœ‰debug</code></pre><blockquote><p>å¦‚æœä¸Šé¢çš„å‘½ä»¤æœ‰äº‹ä»¶è¾“å‡ºï¼Œåˆ™è¯´æ˜filebeaté…ç½®åŸºæœ¬æ— è¯¯ï¼Œå¦‚æœæ²¡æœ‰å®é™…æ•°æ®å¯¹è±¡è¾“å‡ºï¼Œåˆ™ç›´æ¥æ£€æŸ¥filebeaté…ç½®æˆ–è€…æ—¥å¿—æ–‡ä»¶æœ¬èº«ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œfilebeat çš„æ¯ä¸€ä¸ªäº‹ä»¶éƒ½ä¼šåŒ…å«ä»¥ä¸‹äº‹ä»¶å­—æ®µï¼š</p><pre><code class="language-json">&#123;    ...    &quot;@metadata&quot;: &#123;       &quot;beat&quot;: &quot;filebeat&quot;,       &quot;version&quot;: &quot;7.15.1&quot;     &#125;&#125;</code></pre></blockquote><ol start="2"><li>åå°å¯åŠ¨</li></ol><pre><code class="language-bash">nohup ./filebeat &amp; 2&gt;&amp;1</code></pre><p>â„¹ï¸ å¯åŠ¨ä¹‹åï¼Œä¼šåœ¨<code>$&#123;home.config&#125;/data</code>ä¸‹ç”Ÿæˆæ³¨å†Œè¡¨ã€‚æ³¨å†Œè¡¨ä¸èƒ½éšæ„åˆ é™¤ï¼Œåˆ é™¤æ„å‘³ç€filebeatæ— æ³•ç¡®å®šæ˜¯å¦å·²è¯»è¿‡æ–‡ä»¶ï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®é‡å¤å¯¼å…¥.</p><h3 id="æ¨¡å—åŒ–">æ¨¡å—åŒ–</h3><p>é™¤äº†ç©å®¶è‡ªå®šä¹‰outputï¼Œå¹¶æ­é…logstashçš„pipelineè¿›è¡Œäº‹ä»¶è¿‡æ»¤è½¬æ¢ã€‚Beatsç»„ä»¶ä¸€èˆ¬è¿˜å†…ç½®äº†ä¸€äº›é€šç”¨åœºæ™¯çš„æ¨¡å—ï¼Œè¿™äº›æ¨¡å—å·²ç»åŒ…å«äº†å¯¹åº”çš„é»˜è®¤é…ç½®ï¼Œelasticsearchçš„ingest pipelineã€ç´¢å¼•æ¨¡æ¿ä»¥åŠkibanaä»ªè¡¨ï¼Œå½“ä½ å¼€å¯è¿™äº›æ¨¡å—ï¼ŒBeatså°±å¯ä»¥è‡ªåŠ¨å°†è¿™äº›å¯¹è±¡å¸®ä½ åˆ›å»ºå¥½ã€‚</p><p>è¯¦æƒ…å‚è§ï¼š<a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html</a></p><p>â„¹ï¸æ¨¡å—çš„åŠŸèƒ½è¦æƒ³ä½¿ç”¨ï¼Œoutputå¿…é¡»æ˜¯elasticsearchï¼Œå¦åˆ™ä½ å³ä¾¿å¯ç”¨ï¼Œä¹Ÿæ— æ³•å®‰è£….</p><p>å®˜æ–¹CSDNä¹Ÿæœ‰ä¸€ä¸ªåšæ–‡ï¼Œè¿›è¡Œäº†ä½¿ç”¨ç®€ä»‹ <a href="https://elasticstack.blog.csdn.net/article/details/109178666">https://elasticstack.blog.csdn.net/article/details/109178666</a></p><p>ç°åœ¨ï¼Œä»¥é‡‡é›†ç³»ç»Ÿæ—¥å¿—ä¸ºä¾‹.</p><p>â„¹ï¸ æ¨¡å—çš„é‡‡é›†å¯ä»¥å•ç‹¬ç”¨ä¸€ä¸ªfilebeatå»è·‘ã€‚</p><p>åœ¨ä½ æ‰§è¡Œä¸‹é¢çš„æ“ä½œä¹‹å‰ï¼Œè¯·å…ˆç¡®è®¤ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ol><li>filebeatçš„outputæ˜¯Elasticsearch</li><li>filebeaté…ç½®äº†kibanaåœ°å€</li></ol><p>é¦–å…ˆï¼Œåœ¨kibanaä¸­åˆ›å»ºå›¾è¡¨ï¼Œåœ¨elasticsearchä¸­åˆ›å»ºç´¢å¼•ç®¡ç†æ¨¡æ¿</p><pre><code class="language-bash">./filebeat setup --dashboards --index-management </code></pre><p>å…¶æ¬¡ï¼Œå¼€å¯æ¨¡å—</p><pre><code class="language-bash">./filebeat modules enable system</code></pre><p>ç„¶åï¼Œåœ¨elasticsearchä¸­åˆ›å»ºingest pipeline</p><pre><code class="language-bash">./filebeat setup --pipelines --modules system</code></pre><p>æ­¤æ—¶ï¼Œä½ å¯ä»¥åœ¨kibanaåå°æ‰¾åˆ°</p><ol><li>ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç­–ç•¥ï¼šfilebeat</li><li>ç´¢å¼•æ¨¡å¼ï¼šfilebeat-*</li><li>å„ç§dashboard</li><li>ä»¥åŠingest pipeline</li></ol><p>â„¹ï¸æ¨¡å—é»˜è®¤åˆ›å»ºçš„ç´¢å¼•éƒ½æ˜¯filebeat-xxxï¼Œå› æ­¤ç´¢å¼•æ¨¡å¼ä¹Ÿæ˜¯ filebeat-*ï¼Œå…¶ dashboard æ•°æ®è®¾ç½®çš„æ—¶å€™é€šè¿‡å†…ç½®çš„å­—æ®µæ¥åŒºåˆ†ï¼Œä¾‹å¦‚systemæ˜¯é€šè¿‡ event.dataset:system.syslog è¿‡æ»¤.</p><p>æœ€åï¼Œé’ˆå¯¹å¼€å¯çš„æ¨¡å—ï¼Œé…ç½®ç›¸å…³æ–‡ä»¶ã€‚é»˜è®¤è¿™äº›æ–‡ä»¶éƒ½åœ¨models.d,åœ¨æ²¡æœ‰ enable çš„æ—¶å€™ï¼Œæ–‡ä»¶åç¼€éƒ½æ˜¯ disabledã€‚</p><pre><code class="language-yml"># Module: system# Docs: https://www.elastic.co/guide/en/beats/filebeat/7.x/filebeat-module-system.html- module: system  syslog:    enabled: true    var.paths: [&quot;/path/to/log/syslog*&quot;]  auth:    enabled: true    var.paths: [&quot;/path/to/log/auth.log*&quot;]</code></pre><p>æœ€åå¯åŠ¨filebeatï¼ŒæŸ¥çœ‹æ•°æ®æ˜¯å¦æœ‰å½•å…¥</p><pre><code class="language-bash">./filebeat -e -d &quot;*&quot;</code></pre><p>â„¹ï¸å› ä¸ºé€šè¿‡æ¨¡å—åˆ›å»ºçš„é»˜è®¤ç´¢å¼•åå­—éƒ½æ˜¯ filebeat-å¼€å¤´çš„ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…ç´¢å¼•æ¨¡å¼åŒ¹é…åˆ°å…¶å®ƒç´¢å¼•ï¼Œå»ºè®®éæ¨¡å—åˆ›å»ºçš„ç´¢å¼•åä¸ä»¥Beatsç»„ä»¶åå¼€å¤´.</p><p>å¦‚æœä½¿ç”¨æ¨¡å—çš„æ—¶å€™ï¼Œfilebeat.output æŒ‡å‘äº† logstashï¼Œé‚£ä¹ˆlogstash.outputåº”è¯¥å‚ç…§å¦‚ä¸‹é…ç½®</p><pre><code class="language-conf">output &#123;  if [@metadata][pipeline] &#123;    elasticsearch &#123;      hosts =&gt; &quot;https://myEShost:9200&quot;      manage_template =&gt; false      index =&gt; &quot;%&#123;[@metadata][beat]&#125;-%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;      pipeline =&gt; &quot;%&#123;[@metadata][pipeline]&#125;&quot;       user =&gt; &quot;elastic&quot;      password =&gt; &quot;secret&quot;    &#125;  &#125; else &#123;    elasticsearch &#123;      hosts =&gt; &quot;https://myEShost:9200&quot;      manage_template =&gt; false      index =&gt; &quot;%&#123;[@metadata][beat]&#125;-%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;      user =&gt; &quot;elastic&quot;      password =&gt; &quot;secret&quot;    &#125;  &#125;</code></pre><p>â„¹ï¸pipeline =&gt; â€œ%{[@metadata][pipeline]}â€ ç¡®ä¿äº† logstash.output å¯ä»¥æ­£ç¡®çš„æ‰¾åˆ° elasticsearch ä¸­çš„ ingest pipeline.</p><h3 id="é‡åˆ°çš„é—®é¢˜ç‚¹">é‡åˆ°çš„é—®é¢˜ç‚¹</h3><p>âš ï¸filebeatè¯»å–çš„æ–‡ä»¶ï¼Œä¸€å®šè¦æœ‰è¡Œç»“å°¾ç¬¦ï¼Œå¦åˆ™å°†æ— æ³•è½½å…¥ã€‚</p><pre><code class="language-bash">[root@es logs]# file 16033741222_2021_11_04_09_33_23_1703_15_1.6.13.json16033741222_2021_11_04_09_33_23_1703_15_1.6.13.json: ASCII text, with very long lines, with no line terminators</code></pre><p>ä¸Šè¿°æ–‡ä»¶ä¸­ï¼Œé€šè¿‡fileæŒ‡ä»¤å¯ä»¥çœ‹åˆ°æç¤º<code>with no line terminators</code></p><p>âš ï¸æ¨¡å—å¹¶ä¸èƒ½é€‚é…æ‰€æœ‰æƒ…å†µï¼Œä¾‹å¦‚systemæ¨¡å—è¯»å–centosçš„authçº§åˆ«æ—¥å¿—ï¼ˆsecure)å°±æ— æ³•é€‚é…dashboardï¼Œå¯èƒ½åªé€‚é…ubuntuçš„æ—¥å¿—ã€‚</p><p>âš ï¸filebeatå½“å‰çš„output.logstashæ’ä»¶æ— æ³•å®ç°æ ¹æ®fieldså­—æ®µæ¥åŠ¨æ€é€‰æ‹©ç®¡é“.</p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜00ELKåŸºæœ¬ä½¿ç”¨-ç®€ä»‹</title>
      <link href="posts/f8ca35d2/"/>
      <url>posts/f8ca35d2/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><ul><li>å„ç»„ä»¶æ€»ä¸‹è½½é¡µ: <a href="https://www.elastic.co/cn/downloads/">https://www.elastic.co/cn/downloads/</a></li><li>å®¹å™¨ä¸‹è½½é¡µ: <a href="https://www.docker.elastic.co">https://www.docker.elastic.co</a></li></ul><ol><li>Elasticsearch æœç´¢åˆ†æ <a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></li><li>Logstash è½¬æ¢è¾“å‡º <a href="https://www.elastic.co/cn/downloads/logstash">https://www.elastic.co/cn/downloads/logstash</a></li><li>Beats æ”¶é›† <a href="https://www.elastic.co/cn/downloads/beats/">https://www.elastic.co/cn/downloads/beats/</a></li><li>Kibana å±•ç¤º <a href="https://www.elastic.co/cn/downloads/kibana">https://www.elastic.co/cn/downloads/kibana</a></li></ol><h2 id="æ•°æ®è¿‡ç¨‹">æ•°æ®è¿‡ç¨‹:</h2><p>data â˜ beats â˜ kafka â˜ Logstash â˜ Elasticsearch (master node) + data node â˜ Kibana</p><p>beats æ˜¯è½»é‡çš„æ•°æ®æå–ç«¯ï¼Œå®ƒæœ‰å¾ˆå¤šç±»å‹ï¼Œä¾‹å¦‚ï¼šæ—¥å¿—æ–‡ä»¶ï¼ˆFilebeatï¼‰ï¼Œç½‘ç»œæ•°æ®ï¼ˆPacketbeatï¼‰ï¼ŒæœåŠ¡å™¨æŒ‡æ ‡ï¼ˆMetricbeatï¼‰ï¼Œè¿™äº› beats éƒ½ä¾èµ–<a href="https://github.com/elastic/beats/tree/master/libbeat">libbeat</a></p><p>logstash ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†å½“ä½ éœ€è¦å……å½“beatsçš„èšåˆå™¨æˆ–è€…è¿‡æ»¤æ•°æ®çš„æ—¶å€™ï¼Œlogstashå¯ä»¥å¸®ä½ .</p><p>â„¹ï¸beats å‘é€æ•°æ®ä»¥äº‹ä»¶ä¸ºä¸€ä¸ªå•ä½ï¼Œä¾‹å¦‚ä¸€è¡Œå°±æ˜¯ä¸€ä¸ª<code>äº‹ä»¶</code></p><h2 id="ç»“æ„">ç»“æ„</h2><p><img src="https://www.elastic.co/guide/en/logstash/7.15/static/images/deploy4.png" alt="éƒ¨ç½²4"></p><p>ä¸Šå›¾æ˜¯logstashå®˜æ–¹çš„ä¸€ä¸ªå›¾ã€‚kafkaä½œä¸ºæ•°æ®ä¸­å¿ƒï¼Œæ¥ä¿è¯æ¶ˆæ¯çš„æŒä¹…æ€§ã€‚Beatså°†æ•°æ®æŒä¹…å­˜å‚¨åœ¨kafkaï¼Œlogstashä»kafkaä¸­æ¶ˆè´¹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜åŸºæœ¬è®¤è¯</title>
      <link href="posts/18de0eed/"/>
      <url>posts/18de0eed/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># å®‰è£… htpasswd å·¥å…·yum install httpd-tools -y# ç”Ÿæˆå¯†ç æ–‡ä»¶htpasswd -bc /usr/local/nginx/conf/.passwd usera pwd # åˆ›å»ºç”¨æˆ·usera, å¹¶å†™å…¥ .passwdhtpasswd -b /usr/local/nginx/conf.passwd userb pwd  # è¿½åŠ ç”¨æˆ· userbhtpasswd -D /usr/local/nginx/conf/.passwd usera # åˆ é™¤ç”¨æˆ·# nginxé…ç½®server &#123;    listen       80;    server_name  xxx.com;    index index.html;    location /auth &#123;        auth_basic &quot;nginx auth&quot;;        auth_basic_user_file /usr/local/nginx/conf/.passwd;        alias /export/webapps/xxx.com;    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜è½¯raidåˆ›å»º</title>
      <link href="posts/a7611bc1/"/>
      <url>posts/a7611bc1/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-â˜-è½¯-raid-åˆ›å»º">linux â˜ è½¯ raid åˆ›å»º</h2><ul><li>åˆ›å»º</li></ul><pre><code class="language-bash"># ç£ç›˜åˆ†åŒºfdisk /dev/sdafdisk /dev/sdb# æ„å»ºraid0# --level raidçº§åˆ«# --raid-devices ç›˜æ•°# --chunk æ¡å¸¦æ·±åº¦ï¼Œå†³å®šäº†æ•°æ®åˆ†å‰²çš„æ ‡å‡†å•ä½å¤§å°ï¼Œæ•°å€¼è¶Šå°ï¼Œåˆ™æ•°æ®è¶Šåˆ†æ•£ï¼Œæ€§èƒ½è¶Šä½(å¦‚è‹¥æ²¡æœ‰ç‰¹æ®Šä¼˜åŒ–éœ€æ±‚ï¼Œå»ºè®®é€‰é»˜è®¤å€¼å³å¯)mdadm -Cv /dev/md0 --level=0 --raid-devices=2 /dev/sda1 /dev/sdb1# å·²ä¸Šé…ç½®ä¸­, ä¹Ÿå¯ä»¥ä¸åˆ†åŒº, ç›´æ¥è¿›è¡Œ raid æ„å»ºmdadm --create --verbose /dev/md0 --level=0 --name=MY_RAID --raid-devices=number_of_volumes device_name1 device_name2# è§‚å¯Ÿå’Œç­‰å¾…é˜µåˆ—åˆå§‹åŒ–cat /proc/mdstat# è§‚å¯Ÿåˆå§‹åŒ–åçš„é˜µåˆ—ä¿¡æ¯mdadm --detail /dev/md0# æ ¼å¼åŒ– ï¼ˆåŠ å·æ ‡ï¼‰mke2fs -t ext4 -L raid0 /dev/md0# å†™å…¥é…ç½®# ä¸åŒçš„æ“ä½œç³»ç»Ÿ mdadm.conf ä½ç½®ä¸åŒ, å…·ä½“ä»¥ man mdadm.conf ä¸ºå‡†mdadm --detail --scan | tee -a /etc/mdadm.conf# echo &quot;DEVICE /dev/sda1 /dev/sdb1 &quot; &gt;&gt; /etc/mdadm/mdadm.conf# mdadm -Ds &gt;&gt; /etc/mdadm/mdadm.conf# åˆ›å»ºæ–°çš„ Ramdisk Image ä»¥ä¸ºæ–°çš„ RAID é…ç½®æ­£ç¡®åœ°é¢„åŠ è½½å—å‚¨å­˜è®¾å¤‡æ¨¡å—sudo dracut -H -f /boot/initramfs-$(uname -r).img $(uname -r)# å†™å…¥æŒ‚è½½ ï¼ˆç”¨å·æ ‡æŒ‚è½½ï¼Œæœ‰äº›ç³»ç»Ÿé‡å¯åï¼Œè®¾å¤‡åä¼šä»md0å˜æˆmd127ï¼‰echo &quot;LABEL=raid0 /data ext4 defaults,nofail 0 2&quot; &gt;&gt; /etc/fstabmkdir /datamount -a# ç¡®è®¤æŒ‚è½½æˆåŠŸdf -h</code></pre><ul><li>åˆ é™¤</li></ul><pre><code class="language-bash"># åˆ é™¤/etc/fstabçš„æŒ‚è½½ä¿¡æ¯$ mdadm -S /dev/md0$ mdadm --misc --zero-superblock /dev/sda$ mdadm --misc --zero-superblock /dev/sdb# åˆ é™¤/etc/mdadm/mdadm.confæ–‡ä»¶ä¸­æ·»åŠ çš„DEVICEè¡Œå’ŒARRAYè¡Œ</code></pre><ul><li>é¢å¤–ä¿¡æ¯</li></ul><pre><code class="language-bash">#2Tä»¥ä¸Šå¤§å°åˆ†åŒºparted /dev/sda mklabel gpt mkpart primary1 0% 100%partprobe</code></pre><ul><li>å…³äºäº‘</li></ul><pre><code class="language-bash">å½“ä½¿ç”¨äº‘ç«¯ç£ç›˜æ„å»ºraidçš„æ—¶å€™,ä¸”åˆæƒ³è¿›è¡Œ raid å¤‡ä»½,åˆ™åŠ¡å¿…å…ˆåœæ­¢ioæ“ä½œ,åœæ­¢ioæ“ä½œçš„æ–¹æ³•æœ€å¥½æ˜¯ umount æˆ–è€…åœæœº. å¦åˆ™ä¼šå¯¼è‡´ raid æ•°æ®å®Œæ•´æ€§å‡ºç°é—®é¢˜.</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> raid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜s3 åˆå§‹åŒ–å®‰è£…</title>
      <link href="posts/2c5a64ff/"/>
      <url>posts/2c5a64ff/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€">å‰è¨€</h3><p>è„šæœ¬çš„ç›®çš„ï¼š</p><ol><li>åˆ›å»ºS3</li><li>æ·»åŠ ç”Ÿå‘½å‘¨æœŸ</li><li>åˆ›å»ºiamè§„åˆ™</li></ol><blockquote><p>s3å®˜æ–¹æˆæƒç¤ºä¾‹ï¼š<a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/example-policies-s3.html">https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/example-policies-s3.html</a></p></blockquote><h3 id="ä¸»ä½“è„šæœ¬">ä¸»ä½“è„šæœ¬</h3><pre><code class="language-bash">#!/bin/bash# http://docs.amazonaws.cn/general/latest/gr/rande.html#s3_region# us-east-1 us-west-1 ç­‰# éœ€è¦s3æƒé™å’Œiamæƒé™# éœ€è¦å…ˆç¼–å†™ s3-lifecycle.json#æ¡¶åread -p &quot;è¾“å…¥s3æ¡¶å=&quot; S3BucketName#æ‰€å±é¡¹ç›®read -p &quot;è¾“å…¥é¡¹ç›®å=&quot; TeamNameread -p &quot;è¾“å…¥AWS_ACCESS_KEY_ID=&quot; AWS_ACCESS_KEY_IDread -p &quot;è¾“å…¥AWS_SECRET_ACCESS_KEY=&quot; AWS_SECRET_ACCESS_KEYread -p &quot;è¾“å…¥AWS_DEFAULT_REGION=&quot; AWS_DEFAULT_REGIONexport AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_IDexport AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEYexport AWS_DEFAULT_REGION=$AWS_DEFAULT_REGIONS3LocationConstraint=$&#123;AWS_DEFAULT_REGION&#125;[[ $&#123;S3LocationConstraint&#125; == 'us-east-1' ]] &amp;&amp; aws s3api create-bucket --bucket $&#123;S3BucketName&#125; --region $&#123;S3LocationConstraint&#125; || aws s3api create-bucket --bucket $&#123;S3BucketName&#125; --region $&#123;S3LocationConstraint&#125; --create-bucket-configuration LocationConstraint=$&#123;S3LocationConstraint&#125;aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'conf/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'data/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'backup/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/7days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/15days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/30days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/60days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/90days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/longlasting/'aws s3api put-bucket-tagging --bucket $&#123;S3BucketName&#125; --tagging &quot;TagSet=[&#123;Key=Team,Value=$&#123;TeamName&#125;&#125;]&quot;aws s3api put-bucket-lifecycle-configuration --bucket $&#123;S3BucketName&#125; --lifecycle-configuration file://s3-lifecycle.jsoncat &gt; s3-program.rule &lt;&lt; EOF&#123;    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Sid&quot;: &quot;VisualEditor0&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;s3:PutObject&quot;,                &quot;s3:GetObject&quot;,                &quot;s3:DeleteObject&quot;,                &quot;s3:PutObjectAcl&quot;,                &quot;s3:GetObjectAcl&quot;            ],            &quot;Resource&quot;: [                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/7days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/15days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/30days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/60days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/90days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/longlasting/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/conf/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/data/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/backup/*&quot;            ]        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor1&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:ListBucket&quot;,            &quot;Resource&quot;: &quot;arn:aws:s3:::$&#123;S3BucketName&#125;&quot;        &#125;    ]&#125;EOFcat &gt; s3-local.rule &lt;&lt; EOF&#123;    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Sid&quot;: &quot;VisualEditor0&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:ListBucket&quot;,            &quot;Resource&quot;: &quot;arn:aws:s3:::$&#123;S3BucketName&#125;&quot;,            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor1&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;s3:PutObject&quot;,                &quot;s3:GetObject&quot;,                &quot;s3:DeleteObject&quot;            ],            &quot;Resource&quot;: [                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/7days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/15days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/30days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/60days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/90days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/longlasting/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/conf/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/data/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/backup/*&quot;            ],            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor2&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:GetBucketLocation&quot;,            &quot;Resource&quot;: &quot;arn:aws:s3:::$&#123;S3BucketName&#125;&quot;,            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor3&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:ListAllMyBuckets&quot;,            &quot;Resource&quot;: &quot;*&quot;,            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;    ]&#125;EOFaws iam create-policy --policy-name s3-$&#123;S3BucketName&#125;-role --description &quot;For role use only!!!!!!!!!!!!&quot; --policy-document  file://s3-program.ruleaws iam create-policy --policy-name s3-$&#123;S3BucketName&#125;-local --description &quot;Limit the source IP!!!!!!!!!!!!&quot; --policy-document file://s3-local.ruleecho &quot;ç¨‹åºç”¨æˆ·è§„åˆ™: s3-$&#123;S3BucketName&#125;-role å·²ç”Ÿæˆ&quot;echo &quot;æœ¬åœ°ç”¨æˆ·è§„åˆ™ï¼šs3-$&#123;S3BucketName&#125;-local å·²ç”Ÿæˆ&quot;echo &quot;è¯·å°† local è§„åˆ™å…³è”åˆ°å¯¹åº”ä¸ªäººç”¨æˆ·æˆ–ç»„&quot;echo &quot;è¯·å°† role è§„åˆ™å…³è”åˆ°è§’è‰²&quot;</code></pre><h3 id="ç”Ÿå‘½å‘¨æœŸè§„åˆ™-s3-lifecycle-json">ç”Ÿå‘½å‘¨æœŸè§„åˆ™ s3-lifecycle.json</h3><blockquote><p>è§„åˆ™è¯´æ˜ï¼š</p><ol><li>æ‰€æœ‰å¯¹è±¡ï¼Œ30å¤©ä¹‹åè½¬ä¸ºONEZONE_IA;</li><li>logs å‰ç¼€å•ç‹¬å®šä¹‰ï¼š<ul><li>days è·¯å¾„ä¸‹çš„å¯¹è±¡ä¿å­˜å¯¹åº”çš„å¤©æ•°</li><li>longlasting è·¯å¾„ä¸‹çš„å¯¹è±¡æ°¸ä¹…ä¿å­˜ï¼Œä½†æ˜¯ 90 å¤©ä¹‹åçš„å¯¹è±¡è½¬æ¢ä¸º GLACIER</li></ul></li></ol></blockquote><pre><code class="language-shell">&#123;  &quot;Rules&quot;: [      &#123;          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;&quot;          &#125;,           &quot;Status&quot;: &quot;Enabled&quot;,           &quot;Transitions&quot;: [              &#123;                  &quot;Days&quot;: 30,                   &quot;StorageClass&quot;: &quot;ONEZONE_IA&quot;              &#125;          ],           &quot;NoncurrentVersionTransitions&quot;: [              &#123;                  &quot;NoncurrentDays&quot;: 30,                   &quot;StorageClass&quot;: &quot;ONEZONE_IA&quot;              &#125;          ],           &quot;ID&quot;: &quot;30days_onezone_ia&quot;      &#125;,      &#123;          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/longlasting/&quot;          &#125;,           &quot;Status&quot;: &quot;Enabled&quot;,           &quot;Transitions&quot;: [              &#123;                  &quot;Days&quot;: 90,                   &quot;StorageClass&quot;: &quot;GLACIER&quot;              &#125;          ],           &quot;ID&quot;: &quot;logs_90day_glacier&quot;      &#125;,       &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;: 1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/7days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 7          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_7days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;:  1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/15days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 15          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_15days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;:  1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/30days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 30          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_30days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;: 1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/60days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 60          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_60days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;: 1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/90days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 90          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_90days_before&quot;      &#125;  ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aws </tag>
            
            <tag> s3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerâ˜01å®‰è£…</title>
      <link href="posts/b7cf7b1f/"/>
      <url>posts/b7cf7b1f/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¾èµ–">ä¾èµ–</h2><pre><code class="language-bash">yum install -y yum-utils \  device-mapper-persistent-data \  lvm2</code></pre><h2 id="ä»“åº“">ä»“åº“</h2><blockquote><p>å®˜æ–¹ repo: <a href="https://download.docker.com/linux/centos/docker-ce.repo">https://download.docker.com/linux/centos/docker-ce.repo</a></p></blockquote><pre><code class="language-bash:">yum-config-manager \    --add-repo \    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash">yum install docker-ce -y### å®‰è£… compose ï¼Œ å¯é€‰yum install python3-pip -ypip3 install --upgrade pip &amp;&amp; pip3 install docker-composepip3 install docker-compose### å¼€æœºè‡ªå¯åŠ¨systemctl enable docker</code></pre><h3 id="å®‰è£…-runlike-å‘½ä»¤">å®‰è£… runlike å‘½ä»¤</h3><p>runlikeå‘½ä»¤å¯ä»¥è¾“å‡ºdockerå¯åŠ¨çš„æ—¶å€™çš„æŒ‡ä»¤</p><pre><code class="language-bash">pip3 install runlikerunlike &lt;container_id&gt; # è¾“å‡ºrunæŒ‡ä»¤ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå‘½ä»¤å¹¶ä¸å®Œç¾ï¼Œæ¯”å¦‚è¾“å‡ºä¸äº†mountå‚æ•°ï¼Œå› ä¸ºä½ è¿˜éœ€è¦é€šè¿‡docker inspect &lt;container_id&gt;æ¥æŸ¥çœ‹mountæŒ‡ä»¤</code></pre><h2 id="ä¿®æ”¹-docker-é»˜è®¤æ•°æ®ç›®å½•">ä¿®æ”¹ docker é»˜è®¤æ•°æ®ç›®å½•</h2><pre><code class="language-bash">[[ -f /etc/docker/daemon.json ]] &amp;&amp; mv /etc/docker/daemon.json /etc/docker/daemon.json.default || &#123; mkdir -p /etc/docker/ &amp;&amp;  touch /etc/docker/daemon.json &#125;cat &gt;  /etc/docker/daemon.json &lt;&lt; EOF&#123;  &quot;registry-mirrors&quot;: [&quot;http://hub-mirror.c.163.com&quot;],  &quot;data-root&quot;: &quot;/export/docker-data-root&quot;&#125;EOF</code></pre><h2 id="å¯åŠ¨">å¯åŠ¨</h2><pre><code class="language-bash">systemctl start docker</code></pre><h2 id="é•œåƒåº“">é•œåƒåº“</h2><pre><code class="language-bash">docker hubquay.io</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜01å¸¸è§æœ¯è¯­æ¦‚å¿µ</title>
      <link href="posts/aaf9b7/"/>
      <url>posts/aaf9b7/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p><a href="https://kubernetes.io/zh/docs/concepts/overview/components/">Kubernetes ç»„ä»¶ | Kubernetes</a></p><p><a href="https://kubernetes.io/zh/docs/reference/glossary/?all=true">è¯æ±‡è¡¨ | Kubernetes</a></p><h2 id="ç»“æ„å›¾">ç»“æ„å›¾</h2><p><img src="https://d33wubrfki0l68.cloudfront.net/2475489eaf20163ec0f54ddc1d92aa8d4c87c96b/e7c81/images/docs/components-of-kubernetes.svg" alt="Kubernetes ç»„ä»¶"></p><ol><li><p>Control Plane æ˜¯ k8s çš„ master èŠ‚ç‚¹ï¼Œè´Ÿè´£åè°ƒé›†ç¾¤ä¸­çš„æ‰€æœ‰æ´»åŠ¨ï¼Œä¾‹å¦‚è°ƒåº¦åº”ç”¨ç¨‹åºã€ç»´æŠ¤åº”ç”¨ç¨‹åºçš„æ‰€éœ€çŠ¶æ€ã€æ‰©å±•åº”ç”¨ç¨‹åºå’Œæ»šåŠ¨æ›´æ–°ã€‚</p><blockquote><p>control plane å’Œ master æ˜¯åŒä¹‰</p></blockquote></li><li><p>Node æ˜¯ k8s çš„å·¥ä½œèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å®é™…ä¸»è¦è·‘å®¹å™¨çš„èŠ‚ç‚¹ã€‚</p></li></ol><h2 id="ç»„ä»¶">ç»„ä»¶</h2><p><a href="https://kubernetes.io/docs/concepts/overview/components/">https://kubernetes.io/docs/concepts/overview/components/</a></p><p><a href="https://kubernetes.io/docs/reference/command-line-tools-reference/">https://kubernetes.io/docs/reference/command-line-tools-reference/</a></p><p>Control Plane èŠ‚ç‚¹ç»„ä»¶</p><ol><li>kube-apiserver  æ˜¯k8s çš„ api æœåŠ¡ï¼Œæ˜¯é›†ç¾¤å…¥å£ï¼Œæä¾› http rset æœåŠ¡ã€‚</li><li>kube-controller-manager ç»´æŠ¤é›†ç¾¤çŠ¶æ€ï¼ˆæ•…éšœæ£€æµ‹/æ»šåŠ¨å‡çº§/nodeæ‰©å±•ç­‰ï¼‰ï¼Œæ˜¯é›†ç¾¤æ‰€æœ‰èµ„æºå¯¹è±¡çš„è‡ªåŠ¨åŒ–ç®¡ç†ä¸­å¿ƒã€‚</li><li>kube-scheduler æ˜¯è´Ÿè´£ pod çš„è°ƒåº¦, å³å¦‚ä½•å°† pod åˆ†å‘åˆ° node</li><li>etcd æ³¨å†Œä¸­å¿ƒï¼Œä¿å­˜é›†ç¾¤çŠ¶æ€ã€‚</li></ol><p>Node èŠ‚ç‚¹ç»„ä»¶</p><ol><li><p>kubelet æ˜¯èŠ‚ç‚¹ä»£ç†ç¨‹åºï¼Œéƒ¨ç½²åœ¨ node ä¸Šã€‚å®ƒæ˜¯k8s masterå’Œk8s nodeä¹‹é—´çš„çº½å¸¦ã€‚å¤„ç† pod åˆ›å»º/å¯åŠ¨/ç›‘æ§/é‡å¯/é”€æ¯ç­‰å·¥ä½œã€‚</p><p>å¼€å¯ register-node = true çš„æƒ…å†µä¸‹ ä¼šè‡ªåŠ¨å‘ apiserver æœåŠ¡æ³¨å†Œè‡ªå·±ã€‚</p></li><li><p>kube-proxy æ˜¯èŠ‚ç‚¹çš„ç½‘ç»œä»£ç†ï¼Œæ˜¯ service èµ„æºå¯¹è±¡çš„ä¸€éƒ¨åˆ†åŠŸèƒ½å®ç°ï¼Œè§£å†³èŠ‚ç‚¹ä¸Šå„èµ„æºçš„é€šä¿¡</p></li><li><p>Container Runtime æ˜¯èŠ‚ç‚¹ä¸Šè´Ÿè´£è¿è¡Œå®¹å™¨çš„ç¯å¢ƒã€‚å®ƒå¯ä»¥æ˜¯Dockerã€containerdç­‰ã€‚</p></li></ol><p>æ’ä»¶</p><p>å¸¸ç”¨çš„æœ‰DNSæ’ä»¶CoreDNSã€ç½‘ç»œæ’ä»¶Flannelã€å¯è§†åŒ–æ’ä»¶DashBoardç­‰</p><p><a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/addons/">https://kubernetes.io/zh/docs/concepts/cluster-administration/addons/</a></p><h2 id="å¯¹è±¡">å¯¹è±¡</h2><p>kubernetes é€šè¿‡å®ä½“åŒ–çš„å¯¹è±¡æ¥è¡¨è¿°èµ„æºã€ç­–ç•¥ã€çŠ¶æ€ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œkubernetes å°†ä¼šå°½å¯èƒ½çš„è¾¾åˆ°å¯¹è±¡çš„æœŸæœ›çŠ¶æ€ã€‚</p><p>ä¸Šå¥è¯çš„æ„æ€å°±æ˜¯ï¼Œå¯¹è±¡åŸºæœ¬éƒ½åŒ…å«ä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯ spec å’Œ statusã€‚</p><ul><li><p>spec è¡¨ç¤ºå¯¹è±¡åº”è¯¥æ‹¥æœ‰çš„çŠ¶æ€ç‰¹æ€§</p></li><li><p>status è¡¨ç¤ºå¯¹è±¡å½“å‰æ‹¥æœ‰çš„çŠ¶æ€ç‰¹æ€§</p></li></ul><p>kubernetes æ€»æ˜¯æƒ³å°½åŠæ³•å°† status å‘ spec é æ‹¢ã€‚</p><p>åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦ä¸€ä»½ yaml é…ç½®ï¼Œé…ç½®é‡ŒåŒ…å«å¦‚ä¸‹å¿…å¤‡ä¿¡æ¯ï¼š</p><ul><li><code>apiVersion</code> - åˆ›å»ºè¯¥å¯¹è±¡æ‰€ä½¿ç”¨çš„ Kubernetes API çš„ç‰ˆæœ¬</li><li><code>kind</code> - æƒ³è¦åˆ›å»ºçš„å¯¹è±¡çš„ç±»åˆ«</li><li><code>metadata</code> - å¸®åŠ©å”¯ä¸€æ€§æ ‡è¯†å¯¹è±¡çš„ä¸€äº›æ•°æ®ï¼ŒåŒ…æ‹¬ä¸€ä¸ª <code>name</code> å­—ç¬¦ä¸²ã€UID å’Œå¯é€‰çš„ <code>namespace</code></li><li><code>spec</code> - ä½ æ‰€æœŸæœ›çš„è¯¥å¯¹è±¡çš„çŠ¶æ€</li></ul><p>kubectl å‘½ä»¤è°ƒç”¨é…ç½®ï¼Œå¹¶å°†ä¿¡æ¯è½¬æ¢ä¸º json å‘ç»™ Apiserverã€‚</p><p>ä¸€ä¸ª yaml é…ç½®ä¾‹å­å¦‚ä¸‹ï¼š</p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-deploymentspec:  selector:    matchLabels:      app: nginx  replicas: 2 # tells deployment to run 2 pods matching the template  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: nginx:1.14.2        ports:        - containerPort: 80</code></pre><blockquote><p>ä¸åŒå¯¹è±¡çš„ spec å¿…ç„¶æ˜¯ä¸ä¸€æ ·çš„ï¼Œé€šè¿‡ API æ–‡æ¡£å¯ä»¥è·å–</p><p><a href="https://kubernetes.io/docs/reference/kubernetes-api/">https://kubernetes.io/docs/reference/kubernetes-api/</a></p></blockquote><p>ä»‹ç»ä¸€äº›å¸¸ç”¨çš„å¯¹è±¡ï¼š</p><ol><li><p>Namespace</p><p>å‘½åç©ºé—´æ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œèµ·åˆ°äº†éš”ç¦»ä½œç”¨ã€‚é€šè¿‡å®ƒï¼Œä½ å¯ä»¥æ‰¾åˆ°å®ƒå†…éƒ¨çš„å…¶å®ƒèµ„æºå¯¹è±¡ï¼Œä¾‹å¦‚ podï¼Œsvcï¼Œdeploymentç­‰</p></li><li><p>Pod</p><p>pod å†…åŒ…å«å¤šä¸ªå®¹å™¨ï¼Œæ‰€ä»¥å¤šä¸ªå®¹å™¨å…±äº«ä»¥ä¸‹èµ„æºã€‚</p><ul><li>PIDå‘½åç©ºé—´: podå†…çš„è¿›ç¨‹èƒ½äº’ç›¸çœ‹åˆ°PID</li><li>ç½‘ç»œå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªip (å”¯ä¸€)</li><li>IPCå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡</li><li>UTSå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªä¸»æœºå (å”¯ä¸€)</li><li>å­˜å‚¨å·: podå¤šä¸ªå®¹å™¨å¯ä»¥å…±åŒè®¿é—®podå®šä¹‰çš„å­˜å‚¨å·</li></ul></li><li><p>Label</p><p>labelç”¨äºè¡¨ç¤ºèµ„æºï¼Œä»è€Œæ–¹ä¾¿çš„è¢«å…¶å®ƒèµ„æºæ‰¾åˆ°ã€‚å®ƒå¾ˆé‡è¦ã€‚</p><p>æ ‡ç­¾å®šä¹‰ <code>key: value</code></p><p>é€‰æ‹©å™¨: <code>key &lt;= !=&gt; value</code>  <code>key &lt;not&gt; in (value1, value2)</code></p><p>ReplicaSet  å’Œ Service é€šè¿‡ selector é€‰æ‹©å™¨æ¥é€‰æ‹© Pod å¯¹è±¡, ä»è€Œç²¾ç»†åŒ–çš„å°† Pod è¿›è¡Œåˆ†ç»„ã€‚ä¸€æ—¦æŸä¸ª pod çš„ Label è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ª pod å°†ä» ReplicaSet ä¸­è„±ç¦»ï¼Œè€Œ ReplicaSet ä¼šé‡æ–°åˆ›å»ºæ–°çš„ pod è¡¥è¶³ ReplicaSet å®šä¹‰çš„å‰¯æœ¬æ•°ã€‚</p></li><li><p>Deployment</p><p>æ— çŠ¶æ€å‰¯æœ¬é›†ã€‚ç”¨æ¥éƒ¨ç½²ä¸€ä¸ª pod ç»„ï¼Œå®ƒé€šè¿‡ ReplicaSet æ¥è¿›è¡Œç¼©æ”¾ï¼Œ å¹¶éœ€è¦ pod æ¨¡æ¿åˆ›å»º podï¼Œ éœ€è¦ Label ç›‘æ§ podã€‚Deployment é€šè¿‡ ReplicaSet ä¸¥æ ¼æ‰§è¡Œé…ç½®æ‰€å®šä¹‰çš„podå‰¯æœ¬æ•°é‡ã€‚åº”è¯¥å§‹ç»ˆä½¿ç”¨ ReplicaSet æ¥åˆ›å»º podï¼Œå› ä¸ºé€šè¿‡ ReplicaSet å¯ä»¥æ–¹ä¾¿çš„æ§åˆ¶ podã€‚Deployment å¯ä»¥ç®€å•çš„æ¯”å–»ä¸º aws çš„ç›®æ ‡ç»„æˆ–è€…nginxçš„upstreamç»„ã€‚</p></li><li><p>Satefulset</p><p>æœ‰çŠ¶æ€å‰¯æœ¬é›†ã€‚</p></li><li><p>Service</p><p>svc ç”¨æ¥æ„å»ºä¸€ä¸ªè´Ÿè½½é…ç½®ã€‚å¯ä»¥æ¯”å–»ä¸ºawsçš„elbå†…ç½‘è´Ÿè½½å‡è¡¡å™¨æˆ–è€…nginxçš„service proxyé…ç½®ã€‚</p><p>svc é€šè¿‡ pod å®šä¹‰çš„ label å‘ç°ä¸€ç»„ podã€‚è¿™äº› pod æœ¬èº«æœ‰ endpoint åœ°å€ã€‚</p><p>svc åˆ›å»ºåï¼Œä¼šæ‹¿åˆ°ä¸€ä¸ªé›†ç¾¤å†…éƒ¨ipå’Œdnsã€‚kube-proxy æœåŠ¡ä¼šå°† svc çš„ ip å’Œ pod çš„ endpoint åœ°å€å…³è”èµ·æ¥ã€‚</p><p>æœ€ç»ˆï¼Œå…¶å®ƒå®¹å™¨å¯ä»¥é€šè¿‡è¿™ä¸ªipå’Œdnsæ¥è®¿é—®svcå…³è”çš„podèµ„æºã€‚</p></li><li><p>Ingress</p><p>ç®¡ç†é›†ç¾¤æœåŠ¡å¤–éƒ¨è®¿é—®çš„APIå¯¹è±¡ï¼Œå…¸å‹çš„è®¿é—®æ–¹å¼æ˜¯ HTTP</p></li></ol><h2 id="å¯¹è±¡æ“ä½œå®é™…è½¬åŒ–">å¯¹è±¡æ“ä½œå®é™…è½¬åŒ–</h2><p>å®¢æˆ·ç«¯å¯¹ api server å‘èµ·çš„è¯·æ±‚ï¼Œéƒ½ä¼šè½¬åŒ–ä¸º http è¯·æ±‚</p><p>ä¾‹å¦‚å‘èµ·ä¸€ä¸ªé’ˆå¯¹ deployment.default å¯¹è±¡çš„è¯·æ±‚ï¼Œ</p><p>å…¶ request path æ˜¯ï¼š</p><p>http://<apiserver>:6443/apis/apps/v1/namespaces/default/deployments/my-deployment/</apiserver></p><blockquote><p>è¿™é‡Œ /apps/v1 æŒ‡çš„æ˜¯ kubectl api-versions åˆ—å‡ºçš„ versionsã€‚</p></blockquote><p>å¯ä»¥é’ˆå¯¹å¯¹è±¡å‘èµ·çš„httpè¯·æ±‚åŠ¨ä½œæ˜¯ï¼š</p><p>GET/POST/PUT/DELETE</p><p>è½¬åŒ–ä¸ºAPIçš„åŠ¨ä½œæ˜¯ï¼šï¼ˆå³ä½ ç”¨kubectlè°ƒç”¨çš„åŠ¨ä½œï¼‰</p><p>get/list/create/update/patch/watch/proxy/redirect/delete/deletecollection</p><h2 id="æœåŠ¡ç»„ä»¶æµç¨‹å›¾">æœåŠ¡ç»„ä»¶æµç¨‹å›¾</h2><blockquote><ul><li>apiserver å¯¹å†…ï¼ˆé›†ç¾¤ä¸­çš„å…¶ä»–ç»„ä»¶ï¼‰å’Œå¯¹å¤–ï¼ˆç”¨æˆ·ï¼‰æä¾›ç»Ÿä¸€çš„ REST APIï¼Œå…¶ä»–ç»„ä»¶è¡Œä¸ºå‡é€šè¿‡ apiserver è¿›è¡Œé€šä¿¡</li><li>apiserver ä¹Ÿä¼šç›´æ¥è°ƒç”¨ kubelet APIï¼ˆå¦‚ logs, exec, attach ç­‰ï¼‰ï¼Œé»˜è®¤ä¸æ ¡éªŒ kubelet è¯ä¹¦ï¼Œä½†å¯ä»¥é€šè¿‡ <code>--kubelet-certificate-authority</code> å¼€å¯</li></ul></blockquote><p><img src="/posts/aaf9b7/image-20200823103640732.png" alt="image-20200823103640732"></p><blockquote><p>ä»¥ä¸€ä¸ªpodçš„æ„å»ºä¸ºä¾‹:</p><ul><li>ç”¨æˆ·é€šè¿‡æäº¤è¯·æ±‚åˆ°Apiserveråˆ›å»ºä¸€ä¸ª Podï¼Œapiserver å°† pod çŠ¶æ€å†™å…¥ etcdã€‚</li><li>scheduluer é€šè¿‡ etcd æ£€æµ‹åˆ°æœªç»‘å®š Node çš„ Podï¼Œå¼€å§‹è°ƒåº¦å¹¶ç»™podåˆ†é…nodeï¼Œå¹¶æ›´æ–°etcdçš„podç»‘å®šçŠ¶æ€ã€‚</li><li>kubelet é€šè¿‡ etcd æ£€æµ‹åˆ°æœ‰æ–°çš„ Pod è°ƒåº¦è¿‡æ¥ï¼Œé€šè¿‡ container runtime è¿è¡Œè¯¥ Podï¼Œå¹¶æ›´æ–°Podè¿è¡ŒçŠ¶æ€ã€‚</li></ul></blockquote><p><img src="/posts/aaf9b7/image-20200823102430144.png" alt="image-20200823102430144"></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>007-kafkaåŸºæœ¬ä¿æ´»</title>
      <link href="posts/41d19ce/"/>
      <url>posts/41d19ce/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿æ´»å·¥å…·">ä¿æ´»å·¥å…·</h2><p>monit</p><h3 id="é…ç½®">é…ç½®</h3><pre><code class="language-bash">check process zookeeper with pidfile /export/kafka/zookeeper.pid  start program = &quot;/bin/bash -c 'source /etc/profile &amp;&amp; cd /export/kafka &amp;&amp; ./zookeeper.start'&quot;    as uid &quot;root&quot; and gid &quot;root&quot;  stop program = &quot;/bin/bash -c 'source /etc/profile &amp;&amp; cd /export/kafka &amp;&amp; ./bin/zookeeper-server-stop.sh &amp;&amp; rm -rf zookeeper.pid'&quot;    as uid &quot;root&quot; and gid &quot;root&quot;if failed port 2181 then alertcheck process kafka with pidfile /export/kafka/kafka.pid  depends on zookeeper  start program = &quot;/bin/bash -c 'source /etc/profile &amp;&amp; cd /export/kafka &amp;&amp; ./kafka.start'&quot;    as uid &quot;root&quot; and gid &quot;root&quot;  stop program = &quot;/bin/bash -c 'source /etc/profile &amp;&amp; cd /export/kafka &amp;&amp; ./bin/kafka-server-stop.sh &amp;&amp; rm -rf kafka.pid'&quot;    as uid &quot;root&quot; and gid &quot;root&quot;</code></pre><h3 id="è„šæœ¬">è„šæœ¬</h3><p>/export/kafka/zookeeper.start</p><pre><code class="language-bash">#!/bin/bashset -eucd /export/kafka[[ -d zk_data ]] &amp;&amp; nohup bin/zookeeper-server-start.sh config/zookeeper.properties &gt;&gt; zookeeper.nohup &amp;sleep 1ps aux | grep 'zookeeper.properties' | grep -v grep | awk '&#123;print $2&#125;' &gt; zookeeper.pid</code></pre><p>/export/kafka/kafka.start</p><pre><code class="language-bash">#!/bin/bashset -eucd /export/kafka[[ -d data ]] &amp;&amp; nohup bin/kafka-server-start.sh config/server.properties &gt;&gt; kafka.nohup &amp;sleep 1ps aux | grep 'server.properties' | grep -v grep | awk '&#123;print $2&#125;' &gt; kafka.pid</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> monit </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>006-kafkaåŸºæœ¬ç›‘æ§</title>
      <link href="posts/1a545f72/"/>
      <url>posts/1a545f72/</url>
      
        <content type="html"><![CDATA[<h2 id="é‡‡é›†å·¥å…·">é‡‡é›†å·¥å…·</h2><p><a href="https://github.com/danielqsj/kafka_exporter">https://github.com/danielqsj/kafka_exporter</a></p><h3 id="å®‰è£…">å®‰è£…</h3><pre><code class="language-bash">appVersion=1.4.2mkdir -p /export/srccd /export/srccurl &quot;https://github.com/danielqsj/kafka_exporter/releases/download/v$&#123;appVersion&#125;/kafka_exporter-$&#123;appVersion&#125;.linux-amd64.tar.gz&quot; -o kafka_exporter.tgz &amp;&amp; tar xf kafka_exporter.tgz &amp;&amp; mv kafka_exporter-$&#123;appVersion&#125;.linux-amd64 ../kafka_exportercd ../kafka_exporter./kafka_exporter \--kafka.server=kafka001:8123 \--sasl.enabled \--sasl.username=&quot;broker&quot; \--sasl.password=&quot;broker&quot; \--sasl.mechanism=&quot;scram-sha256&quot;</code></pre><p>â„¹ï¸é»˜è®¤<code>kafka_exporter</code>ç›‘å¬åœ¨<code>9308</code>ç«¯å£ä¸Š.</p><p>âš ï¸åœ¨1.4.2ç‰ˆæœ¬ä¸­ï¼Œkafka_exporteråœ¨éƒ¨åˆ†ç³»ç»Ÿä¸­å­˜åœ¨æ— æ³•æ­£ç¡®çš„è§£æhostnameçš„é—®é¢˜ï¼Œéœ€ç›´æ¥æŒ‡æ˜IPã€‚</p><h3 id="æ·»åŠ åˆ°å¼€æœºå¯åŠ¨">æ·»åŠ åˆ°å¼€æœºå¯åŠ¨</h3><p>/etc/crontab</p><pre><code class="language-bash">@reboot root sleep 120;/export/kafka_exporter/kafka_exporter --kafka.server=kafka001:8123 --sasl.enabled --sasl.username=&quot;broker&quot; --sasl.password=&quot;broker&quot; --sasl.mechanism=&quot;scram-sha256&quot; &gt;&gt; /export/kafka_exporter/kafka_exporter.nohup 2&gt;&amp;1</code></pre><h2 id="ç›‘æ§ç³»ç»Ÿ">ç›‘æ§ç³»ç»Ÿ</h2><h3 id="Prometheus">Prometheus</h3><p>ä¸»é…ç½®é‡ŒåŠ å…¥</p><pre><code class="language-yml">  - job_name: &quot;kafka_exporter&quot;    metrics_path: /metrics    static_configs:      - targets: ['kafka001:9038'] # kafka_exporteråœ°å€å’Œç«¯å£        labels:          instance: it-zz-kafka-cluster</code></pre><p>å‘Šè­¦è§„åˆ™é‡ŒåŠ å…¥</p><p><a href="https://awesome-prometheus-alerts.grep.to/rules#kafka-1">https://awesome-prometheus-alerts.grep.to/rules#kafka-1</a></p><pre><code class="language-yml">  - alert: KafkaTopicsReplicas    expr: sum(kafka_topic_partition_in_sync_replica) by (topic) &lt; 3    for: 0m    labels:      severity: critical    annotations:      summary: Kafka topics replicas (instance &#123;&#123; $labels.instance &#125;&#125;)      description: &quot;Kafka topic in-sync partition\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;  - alert: KafkaConsumersGroup    expr: sum(kafka_consumergroup_lag) by (consumergroup) &gt; 50    for: 1m    labels:      severity: critical    annotations:      summary: Kafka consumers group (instance &#123;&#123; $labels.instance &#125;&#125;)      description: &quot;Kafka consumers group\n  VALUE = &#123;&#123; $value &#125;&#125;\n  LABELS = &#123;&#123; $labels &#125;&#125;&quot;</code></pre><h3 id="grafana">grafana</h3><p>Grafana Dashboard ID: 7589, name: Kafka Exporter Overview.</p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>005-kafkaåŸºæœ¬ç»´æŠ¤</title>
      <link href="posts/124a3d6d/"/>
      <url>posts/124a3d6d/</url>
      
        <content type="html"><![CDATA[<h1>åˆ†åŒºé‡æ–°åˆ†é…å·¥å…·</h1><p>bin/kafka-reassign-partitions.sh å¯ä»¥ç”¨æ¥è°ƒæ•´åˆ†åŒºå‰¯æœ¬çš„é‡æ–°åˆ†å¸ƒï¼ŒåŒ…æ‹¬å¢åŠ å‰¯æœ¬ï¼Œè¿ç§»å‰¯æœ¬ç­‰ã€‚</p><p>æ­¤å·¥å…·æœ‰ä¸‰å¤§é€‰é¡¹ï¼š</p><ul><li>â€“generateï¼šåˆ›å»ºåˆ†é…è®¡åˆ’ï¼Œç”¨æˆ·é€šè¿‡æŒ‡å®štopicåˆ—è¡¨å’Œbrokeråˆ—è¡¨æ¥ç”ŸæˆæŒ‡å®štopicåˆ—è¡¨çš„ã€åˆ†åŒºé‡æ–°åˆ†é…è®¡åˆ’ã€‘ã€‚</li><li>â€“execute:  æ‰§è¡Œåˆ†é…è®¡åˆ’ï¼Œé€šè¿‡ã€åˆ†åŒºé‡æ–°åˆ†é…è®¡åˆ’ã€‘æˆ–è€…è‡ªå®šä¹‰åˆ†é…è®¡åˆ’è¿›è¡Œå®é™…è¡ŒåŠ¨ã€‚</li><li>â€“verify: æ ¸å®è®¡åˆ’æ‰§è¡Œæƒ…å†µï¼Œè¿”å›è®¡åˆ’æ‰§è¡ŒçŠ¶æ€ï¼Œä¹Ÿå¯ä»¥é‡å¤çš„æ·»åŠ /åˆ é™¤åˆ†é…è¿‡ç¨‹ä¸­çš„ç½‘ç»œé™æµã€‚</li></ul><h2 id="æ‰©å±•é›†ç¾¤">æ‰©å±•é›†ç¾¤</h2><p>é›†ç¾¤æ‰©å±•æ„å‘³ç€å¢åŠ ä¸€ä¸ªæ–°çš„brokerã€‚</p><p>kafkaä¸ä¼šè‡ªåŠ¨å¹³è¡¡æ•°æ®ã€‚</p><p>éœ€è¦æ‰‹åŠ¨å¯åŠ¨åˆ†åŒºé‡æ–°åˆ†é…å·¥å…·ï¼ˆbin/kafka-reassign-partitions.shï¼‰æ¥è¿›è¡Œè‡ªåŠ¨åŒ–åˆ†é…ã€‚</p><h3 id="åˆ›å»ºåˆ†é…è®¡åˆ’">åˆ›å»ºåˆ†é…è®¡åˆ’</h3><p>ç¼–å†™ã€æŒ‡å®šè¦è¿ç§»ã€‘çš„topicåˆ—è¡¨æ–‡ä»¶<code>topics-to-move.json</code></p><pre><code class="language-json"> &#123;&quot;topics&quot;: [&#123;&quot;topic&quot;: &quot;foo1&quot;&#125;,              &#123;&quot;topic&quot;: &quot;foo2&quot;&#125;],  &quot;version&quot;:1  &#125;</code></pre><p>å°†topicåˆ—è¡¨é‡Œçš„topicè¿ç§»åˆ°<code>broker.id</code>ä¸º&quot;5å’Œ6&quot;çš„èŠ‚ç‚¹ä¸Š.</p><pre><code class="language-bash">bin/kafka-reassign-partitions.sh \--command-config config/my.tools.properties \--bootstrap-server kafka1:8123 \--topics-to-move-json-file topics-to-move.json \--broker-list &quot;5,6&quot; \--generate</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼šå…ˆè¾“å‡ºå½“å‰topicåˆ†åŒºçš„åˆ†å¸ƒé…ç½®ï¼Œç„¶åè¾“å‡ºè°ƒæ•´åçš„åˆ†å¸ƒé…ç½®</p><pre><code class="language-json">Current partition replica assignment  &#123;&quot;version&quot;:1,  &quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;foo1&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[1,2]&#125;,                &#123;&quot;topic&quot;:&quot;foo1&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[3,4]&#125;,                &#123;&quot;topic&quot;:&quot;foo2&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[1,2]&#125;,                &#123;&quot;topic&quot;:&quot;foo2&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[3,4]&#125;,                &#123;&quot;topic&quot;:&quot;foo1&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[2,3]&#125;,                &#123;&quot;topic&quot;:&quot;foo2&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[2,3]&#125;]  &#125;Proposed partition reassignment configuration  &#123;&quot;version&quot;:1,  &quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;foo1&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[5,6]&#125;,                &#123;&quot;topic&quot;:&quot;foo1&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[5,6]&#125;,                &#123;&quot;topic&quot;:&quot;foo2&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[5,6]&#125;,                &#123;&quot;topic&quot;:&quot;foo2&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[5,6]&#125;,                &#123;&quot;topic&quot;:&quot;foo1&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[5,6]&#125;,                &#123;&quot;topic&quot;:&quot;foo2&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[5,6]&#125;]  &#125;</code></pre><p>å°†ä¸Šé¢è¾“å‡ºçš„ä¸¤éƒ¨åˆ†é…ç½®ï¼Œåˆ†åˆ«ä¿å­˜ä¸ºå½“å‰topicåˆ†åŒºè½ç‚¹é…ç½®<code>topics-current-plan.json</code>å’Œé¢„æœŸtopicåˆ†åŒºè½ç‚¹é…ç½®<code>topics-expect-plan.json</code></p><h3 id="æ‰§è¡Œåˆ†é…è®¡åˆ’">æ‰§è¡Œåˆ†é…è®¡åˆ’</h3><pre><code class="language-bash">bin/kafka-reassign-partitions.sh \--command-config config/my.tools.properties \--bootstrap-server kafka1:8123 \--reassignment-json-file topics-expect-plan.json \--execute</code></pre><p>â„¹ï¸è‡ªå®šä¹‰åˆ†é…è®¡åˆ’åªéœ€è¦æ»¡è¶³ä¸Šé¢åˆ†é…è®¡åˆ’çš„æ–‡ä»¶æ ¼å¼å³å¯.</p><blockquote><p>æ·»åŠ é™é€Ÿï¼šâ€“throttle 50000000  é™é€Ÿ50MB/s  ä½ å¯ä»¥å¤šæ¬¡é‡å¤æ‰§è¡Œä¸Šè¿°å‘½ä»¤å¹¶é€šè¿‡æ–°çš„é™é€Ÿå€¼æ¥åŠ¨æ€è°ƒæ•´é™é€Ÿ.</p></blockquote><h3 id="æ£€æŸ¥åˆ†é…è®¡åˆ’">æ£€æŸ¥åˆ†é…è®¡åˆ’</h3><pre><code class="language-bash">bin/kafka-reassign-partitions.sh \--command-config config/my.tools.properties \--bootstrap-server kafka1:8123 \--reassignment-json-file topics-expect-plan.json \--verify</code></pre><p>â„¹ï¸å¦‚æœâ€“executeæœŸé—´æ·»åŠ äº†â€“throttleï¼Œåˆ™â€“verifyä¼šåœ¨è¿ç§»å®Œæˆåæ¸…ç©ºâ€“throttle</p><h2 id="åˆ†åŒºå‰¯æœ¬å› å­è°ƒæ•´">åˆ†åŒºå‰¯æœ¬å› å­è°ƒæ•´</h2><p>è°ƒæ•´å‰¯æœ¬å› å­ï¼Œå…¶å®å°±æ˜¯è‡ªå®šä¹‰åˆ†åŒºé…ç½®ï¼Œå‚è€ƒä¸Šé¢çš„é…ç½®ï¼Œä»…é’ˆå¯¹éœ€è¦è°ƒæ•´çš„topicçš„åˆ†åŒºè‡ªå®šä¹‰é…ç½®å¹¶æ‰§è¡Œå³å¯ã€‚</p><h2 id="é—®é¢˜ç‚¹">é—®é¢˜ç‚¹</h2><h3 id="é™é€Ÿå¸¦æ¥çš„é—®é¢˜">é™é€Ÿå¸¦æ¥çš„é—®é¢˜</h3><p>ä½¿ç”¨é™é€Ÿå¯èƒ½ä¼šå¯¼è‡´å¤åˆ¶é€Ÿåº¦è¿‡æ…¢ï¼Œä»¥è‡³äºå¤åˆ¶é€Ÿåº¦ä½äºç”Ÿäº§è€…å†™å…¥é€Ÿåº¦ã€‚è¿™ä¼šå¯¼è‡´å¤åˆ¶æ•°æ®æ»åè¶Šæ¥è¶Šå¤§ã€‚å› æ­¤ï¼Œåº”è¯¥åœ¨å¤åˆ¶æœŸé—´ï¼Œç›‘æ§æ»åçŠ¶æ€ã€‚è¿™é‡Œçš„å¤åˆ¶é€Ÿåº¦ï¼Œå°±æ˜¯æ¶ˆè´¹é€Ÿåº¦ã€‚</p><p>æ»åæŒ‡æ ‡å¦‚ä¸‹ï¼š</p><pre><code class="language-bash">kafka.server:type=FetcherLagMetrics,name=ConsumerLag,clientId=([-.\w]+),topic=([-.\w]+),partition=([0-9]+)</code></pre><p>å¦‚æœå‘ç°æŒ‡æ ‡æ²¡æœ‰é™ä½ï¼Œåˆ™åº”è¯¥æ”¾å®½é™é€Ÿã€‚</p><p>å…³äºæ¶ˆè´¹é€Ÿåº¦æ»åç›‘æ§ï¼Œå¯ä»¥é‡‡å–prometheus+grafanaã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>004-kafkaç”¨æˆ·é…é¢</title>
      <link href="posts/14fdb3fd/"/>
      <url>posts/14fdb3fd/</url>
      
        <content type="html"><![CDATA[<h1>ç®€è¦</h1><p>é…é¢å¯ä»¥åº”ç”¨äºè®¤è¯ç”¨æˆ·ï¼ˆuserï¼‰ã€å®¢æˆ·ç«¯IDï¼ˆ<a href="http://client.id">client.id</a>ï¼‰</p><p>é…é¢ä¿¡æ¯å­˜å‚¨åœ¨zkä¸­ï¼Œè®¤è¯ç”¨æˆ·çš„é…é¢ä¿¡æ¯ä½äº<code>/config/users</code>ï¼Œå®¢æˆ·ç«¯IDçš„é…é¢ä¿¡æ¯ä½äº<code>/config/clients</code></p><p>ä¸»è¦è¯´ä¸‹ç½‘ç»œé™é€Ÿã€‚</p><h2 id="æ·»åŠ é…é¢">æ·»åŠ é…é¢</h2><ul><li>producer_byte_rate ç”Ÿäº§é€Ÿç‡ï¼Œå•ä½æ˜¯å­—èŠ‚/s</li><li>consumer_byte_rate æ¶ˆè´¹é€Ÿç‡ï¼Œå•ä½æ˜¯å­—èŠ‚/s</li></ul><pre><code class="language-bash">bin/kafka-configs.sh --bootstrap-server kafka1:8123 --alter --add-config 'producer_byte_rate=1024,consumer_byte_rate=2048' --entity-type users --entity-name user1 --entity-type clients --entity-name clientA --command-config config/my.tools.properties</code></pre><p>é€šè¿‡<code>user1</code>è®¤è¯ï¼Œä¸”ç¬¦åˆ<code>client.id=clientA</code>çš„å®¢æˆ·ç«¯ï¼Œåœ¨ç”Ÿäº§å’Œæ¶ˆè´¹çš„æ—¶å€™ï¼Œé€Ÿåº¦å‡é™åˆ¶åœ¨1KB/s</p><h2 id="åˆ—å‡ºé…é¢">åˆ—å‡ºé…é¢</h2><pre><code class="language-bash">bin/kafka-configs.sh --bootstrap-server kafka1:8123 --describe --entity-type users --entity-name user1 --entity-type clients --command-config config/my.tools.properties</code></pre><h2 id="åˆ é™¤é…é¢">åˆ é™¤é…é¢</h2><pre><code class="language-bash">bin/kafka-configs.sh --bootstrap-server kafka1:8123 --alter --delete-config 'producer_byte_rate' --entity-type users --entity-name user1 --entity-type clients --entity-name clientA --command-config config/my.tools.properties</code></pre><p>åˆ é™¤<code>user-principal 'user1', client-id 'clientA'</code>é…é¢è§„åˆ™ä¸­çš„ç”Ÿäº§ç½‘ç»œé™åˆ¶<code>producer_byte_rate</code></p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>003-kafkaåŸºæœ¬è®¤è¯</title>
      <link href="posts/2fb0e26c/"/>
      <url>posts/2fb0e26c/</url>
      
        <content type="html"><![CDATA[<p>kafkaçš„è®¤è¯æ˜¯é€šè¿‡javaè®¤è¯æŠ€æœ¯JAASå®ç°ã€‚</p><p><a href="http://kafka.apache.org/documentation/#security_sasl_plain">http://kafka.apache.org/documentation/#security_sasl_plain</a></p><h1>æœåŠ¡ç«¯</h1><h2 id="æ·»åŠ ç”¨æˆ·é…ç½®">æ·»åŠ ç”¨æˆ·é…ç½®</h2><ol><li>æ·»åŠ ç”¨æˆ·</li></ol><pre><code class="language-bash"># åˆ›å»ºè¶…çº§ç”¨æˆ·bin/kafka-configs.sh --zookeeper kafka001:2181 --alter --add-config 'SCRAM-SHA-256=[password=broker]' --entity-type users --entity-name broker</code></pre><ol start="2"><li>è¶…ç®¡å®¢æˆ·ç«¯é…ç½®<code>config/my.tools.properties</code></li></ol><pre><code class="language-properties">security.protocol=SASL_PLAINTEXTsasl.mechanism=SCRAM-SHA-256sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \  username=&quot;broker&quot; \  password=&quot;broker&quot;;</code></pre><h2 id="è¿½åŠ kafkaé…ç½®-è®¤è¯ç«¯å£">è¿½åŠ kafkaé…ç½®:è®¤è¯ç«¯å£</h2><p>æ·»åŠ brokerä¹‹é—´çš„è®¤è¯ä¿¡æ¯å’Œè®¤è¯ç«¯å£é…ç½®åˆ°<code>config/server.properties</code></p><pre><code class="language-properties"># ç”¨æˆ·è®¤è¯listeners=SASL_PLAINTEXT://kafka001:8123security.inter.broker.protocol=SASL_PLAINTEXTsasl.enabled.mechanisms=SCRAM-SHA-256sasl.mechanism.inter.broker.protocol=SCRAM-SHA-256listener.name.sasl_plaintext.scram-sha-256.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \    username=&quot;broker&quot; \    password=&quot;broker&quot;;</code></pre><p>æ ¼å¼ï¼š<code>listener.name.sasl_plaintext.scram-sha-256.sasl.jaas.config</code>=<code>listener.name.&lt;protocol&gt;.&lt;sasl_mechanisms&gt;.sasl.jaas.config</code></p><p><code>listeners</code>å¯ä»¥æ”¯æŒå¤šç«¯å£é…ç½®ï¼Œä¾‹å¦‚åŒæ—¶å¼€å¯è®¤è¯å’Œéè®¤è¯ç«¯å£ï¼Œä¸¤ä¸ªç«¯å£ä¹‹é—´é€—å·åˆ†å‰²ã€‚</p><ul><li><p><code>SASL_PLAINTEXT://kafka001:8123</code>éSSLçš„SASLè®¤è¯ç«¯å£.</p></li><li><p><code>PLAINTEXT://&lt;æœåŠ¡å™¨å&gt;:9092</code>éè®¤è¯ç«¯å£</p></li></ul><p><code>security.inter.broker.protocol</code> é…ç½®brokerä¹‹é—´çš„é€šä¿¡åè®®</p><p><code>sasl.enabled.mechanisms</code> å¼€å¯è®¿é—®brokerçš„è®¤è¯é€šä¿¡æœºåˆ¶saslï¼Œä»¥åŠé…ç½®æ‰€ç”¨çš„æœºåˆ¶ç®—æ³•</p><p><code>sasl.mechanism.inter.broker.protocol</code> å¼€å¯brokerä¹‹é—´è®¤è¯é€šä¿¡æœºåˆ¶saslï¼Œä»¥åŠé…ç½®æ‰€ç”¨çš„æœºåˆ¶ç®—æ³•</p><p>â„¹ï¸ç›¸å¯¹äº<a href="http://kafka.apache.org/documentation/#security_sasl_plain">SASL/PLAIN</a>ç®—æ³•å°†ç”¨æˆ·æ•°æ®æ”¾åœ¨æœ¬åœ°ï¼Œ<a href="http://kafka.apache.org/documentation/#security_sasl_scram">SASL/SCRAM</a>ç®—æ³•å°†ç”¨æˆ·æ•°æ®å­˜æ”¾åœ¨zkã€‚å› æ­¤<a href="http://kafka.apache.org/documentation/#security_sasl_scram">SASL/SCRAM</a>ç®—æ³•å¯ä»¥åŠ¨æ€çš„å¢åˆ ç”¨æˆ·.</p><ol start="3"><li>åˆ›å»ºå®¢æˆ·ç«¯è®¿é—®kafkaçš„ç”¨æˆ·</li></ol><pre><code class="language-bash">bin/kafka-configs.sh --bootstrap-server kafka001:8123  --command-config config/my.tools.properties --alter --add-config 'SCRAM-SHA-256=[password=123456]' --entity-type users --entity-name elk</code></pre><p>âš ï¸<code>broker</code>ç”¨æˆ·ç”¨äºbrokersä¹‹é—´é€šä¿¡ï¼Œæ­¤ç”¨æˆ·å¿…é¡»åœ¨kafkaå¯åŠ¨ä¹‹å‰åˆ›å»ºã€‚</p><ol start="4"><li>åˆ—å‡ºå½“å‰æŸä¸ªç”¨æˆ·é…ç½®</li></ol><pre><code class="language-bash">bin/kafka-configs.sh --bootstrap-server kafka001:8123  --command-config config/my.tools.properties --describe --entity-type users --entity-name elk</code></pre><ol start="5"><li>åˆ é™¤ç”¨æˆ·</li></ol><pre><code class="language-bash">bin/kafka-configs.sh --bootstrap-server kafka001:8123  --command-config config/my.tools.properties --alter --delete-config 'SCRAM-SHA-512' --entity-type users --entity-name elk</code></pre><h2 id="æˆæƒACL">æˆæƒACL</h2><p><a href="http://kafka.apache.org/documentation/#security_authz">http://kafka.apache.org/documentation/#security_authz</a></p><ol><li>ACLè§„åˆ™æ˜¯é’ˆå¯¹<code>topic</code>æˆ–è€…<code>æ¶ˆè´¹è€…ç»„ID</code>æ·»åŠ è§„åˆ™</li><li>è§„åˆ™ç”±<code>principal</code>+<code>host</code>+<code>operation</code>+<code>permissionType</code>ç»„æˆ</li></ol><p><code>principal</code>å°±æ˜¯Useræˆ–è€…Group</p><p><code>host</code>æ˜¯å…è®¸çš„ä¸»æœº</p><p><code>operation</code>æ˜¯å…è®¸çš„æ“ä½œ</p><p><code>permissionType</code>å…è®¸æˆ–æ‹’ç»</p><h3 id="è¿½åŠ kafkaé…ç½®ï¼šé»˜è®¤ACLè§„åˆ™">è¿½åŠ kafkaé…ç½®ï¼šé»˜è®¤ACLè§„åˆ™</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸åšé™åˆ¶ï¼Œä»»ä½•ç”¨æˆ·éƒ½æ˜¯è¶…çº§æƒé™ã€‚å› æ­¤é»˜è®¤æˆ‘ä»¬éœ€è¦å¼€å¯ACLçº§åˆ«çš„é™åˆ¶</p><pre><code class="language-properties"># ACLé»˜è®¤è§„åˆ™# è®¾ç½®èº«ä»½éªŒè¯ä½¿ç”¨çš„ç±»authorizer.class.name=kafka.security.authorizer.AclAuthorizer# è®¾ç½®è¶…çº§è´¦å·ï¼Œå¦‚æœæ˜¯å¤šä¸ªéœ€è¦åˆ†å·åˆ†å‰²ï¼Œä¾‹å¦‚ï¼šUser:admin;User:rootsuper.users=User:broker# false çš„æ„æ€æ˜¯ï¼šå¦‚æœtopicæ²¡æœ‰ACLè§„åˆ™ï¼Œåˆ™ä»»ä½•ç”¨æˆ·æ— æ³•è®¿é—®topicã€‚allow.everyone.if.no.acl.found=false</code></pre><p>ä¸Šè¿°é…ç½®é»˜è®¤æƒ…å†µä¸‹ä»…å…è®¸<code>broker</code>ç”¨æˆ·æ— éœ€ä»»ä½•ACLè§„åˆ™å°±æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚</p><blockquote><p>è®°å¾—é‡æ–°å¯åŠ¨kafkaæœåŠ¡ï¼Œåº”ç”¨æ–°é…ç½®</p></blockquote><h3 id="å·¥å…·">å·¥å…·</h3><p><a href="http://kafka.apache.org/documentation/#security_authz_cli">http://kafka.apache.org/documentation/#security_authz_cli</a></p><p><code>bin/kafka-acls.sh</code>ç”¨æ¥æˆæƒçš„å·¥å…·</p><p>å¸¸ç”¨çš„å‚æ•°ï¼š</p><p>â€“bootstrap-server æŒ‡å®šbrokeråˆ—è¡¨</p><p>â€“add æ·»åŠ </p><p>â€“remove åˆ é™¤</p><p>â€“producer æŒ‡å®šç”Ÿäº§è€…è§„åˆ™ï¼Œåœ¨æ²¡æœ‰operationå‚æ•°æ—¶ï¼Œé»˜è®¤å°±æ˜¯åªå†™</p><p>â€“consumer æŒ‡å®šæ¶ˆè´¹è€…è§„åˆ™ï¼Œåœ¨æ²¡æœ‰operationå‚æ•°æ—¶ï¼Œé»˜è®¤å°±æ˜¯åªè¯»</p><p>â€“operation æˆæƒåˆ—è¡¨ï¼ˆREADã€WRITEã€DELETEã€CREATEã€ALTERã€DESCRIBEã€ALLï¼‰</p><p>â€“allow-principal User:[ç”¨æˆ·å] å…è®¸æŒ‡å®šç”¨æˆ·</p><p>â€“deny-prinicipal User:[ç”¨æˆ·å] æ‹’ç»æŒ‡å®šç”¨æˆ·</p><p>â€“allow-host [Host] å…è®¸çš„ä¸»æœºç½‘ç»œ</p><p>â€“deny-host [Host] æ‹’ç»çš„ä¸»æœºç½‘ç»œ</p><p>â€“group [group_name] æ­¤è§„åˆ™ä»…èƒ½ç”¨äºæ­¤æ¶ˆè´¹è€…ç»„</p><p>â€“resource-pattern-type åŒ¹é…ç±»å‹ï¼Œå¸¸ç”¨çš„æœ‰å‰ç¼€åŒ¹é… prefixed</p><p>â€“topic ä»¥å­—ç¬¦ä¸²åŒ¹é…çš„ä¸»é¢˜</p><p>â€“command-config æŒ‡å®šç®¡ç†å‘˜é…ç½®æ–‡ä»¶</p><h3 id="ç»‘å®šå†™å…¥æƒé™">ç»‘å®šå†™å…¥æƒé™</h3><pre><code class="language-bash">bin/kafka-acls.sh \--bootstrap-server kafka1:8123 \--command-config config/my.tools.properties \--add \--allow-principal User:elk \--producer \--resource-pattern-type prefixed \--topic zz.it.elk.</code></pre><p>é’ˆå¯¹<code>zz.it.elk.</code>å¼€å¤´çš„ topic æ·»åŠ ç”¨æˆ·<code>elk</code>åªå†™æƒé™</p><h3 id="ç»‘å®šåªè¯»æƒé™">ç»‘å®šåªè¯»æƒé™</h3><pre><code class="language-bash">bin/kafka-acls.sh \--bootstrap-server kafka1:8123 \--command-config config/my.tools.properties \--add \--allow-principal User:* \--group logstash \--consumer \--resource-pattern-type prefixed \--topic zz.it.elk.</code></pre><p>é’ˆå¯¹<code>zz.it.elk.</code>å¼€å¤´çš„ topicï¼Œæ·»åŠ æ¶ˆè´¹è€…ç»„å¿…é¡»æ˜¯<code>logstash</code>çš„åªè¯»æƒé™ï¼Œä½†æ— éœ€ç”¨æˆ·è®¤è¯ã€‚</p><blockquote><p>å³å¯ä»¥ä½¿ç”¨éè®¤è¯ç«¯å£9092+æ¶ˆè´¹è€…ç»„<code>logstash</code>å»æ¶ˆè´¹<code>zz.it.elk.</code>å¼€å¤´çš„ topic</p></blockquote><h3 id="åˆ—å‡ºACLè§„åˆ™">åˆ—å‡ºACLè§„åˆ™</h3><p>åˆ—å‡ºæ‰€æœ‰æˆæƒè§„åˆ™</p><blockquote><p>å¯ä»¥é€šè¿‡è¿½åŠ  --principal User:elk åˆ—å‡ºæŸä¸ªè®¤è¯ç”¨æˆ·ä½¿ç”¨çš„è§„åˆ™.</p></blockquote><pre><code class="language-bash">bin/kafka-acls.sh \--bootstrap-server kafka1:8123 \--command-config config/my.tools.properties \--list Current ACLs for resource `ResourcePattern(resourceType=TOPIC, name=zz.it.elk., patternType=PREFIXED)`:        (principal=User:elk, host=*, operation=READ, permissionType=ALLOW)        (principal=User:elk, host=*, operation=ALL, permissionType=ALLOW)        (principal=User:elk, host=*, operation=DESCRIBE, permissionType=ALLOW)Current ACLs for resource `ResourcePattern(resourceType=GROUP, name=logstash, patternType=PREFIXED)`:        (principal=User:elk, host=*, operation=READ, permissionType=ALLOW)</code></pre><blockquote><p>resource å°±æ˜¯ ACL ç»‘å®šçš„å¯¹è±¡ã€‚ACLæ˜¯é’ˆå¯¹ resource çš„ï¼Œä¸æ˜¯é’ˆå¯¹ç”¨æˆ·çš„</p></blockquote><h3 id="åˆ é™¤æˆæƒ">åˆ é™¤æˆæƒ</h3><p>é’ˆå¯¹ resource åˆ é™¤ ACL è§„åˆ™ã€‚</p><ul><li>åˆ é™¤<code>Current ACLs for resource ResourcePattern(resourceType=TOPIC, name=zz.it., patternType=PREFIXED)</code>ä¸‹çš„ACLè§„åˆ™</li></ul><pre><code class="language-bash">bin/kafka-acls.sh --bootstrap-server kafka1:8123 --command-config config/my.tools.properties --remove --topic zz.it.elk. --resource-pattern-type prefixed</code></pre><ul><li>åˆ é™¤<code>Current ACLs for resource ResourcePattern(resourceType=GROUP, name=logstash, patternType=PREFIXED)</code>ä¸‹çš„ACLè§„åˆ™</li></ul><pre><code class="language-bash">bin/kafka-acls.sh --bootstrap-server kafka1:8123 --command-config config/my.tools.properties --remove --group logstash --resource-pattern-type prefixed</code></pre><h1>å®¢æˆ·ç«¯</h1><h2 id="kafkaè‡ªå¸¦çš„å®¢æˆ·ç«¯å·¥å…·">kafkaè‡ªå¸¦çš„å®¢æˆ·ç«¯å·¥å…·</h2><p>ç”Ÿäº§å®¢æˆ·ç«¯é…ç½®<code>config/my.producer.properties</code></p><pre><code class="language-properties">security.protocol=SASL_PLAINTEXTsasl.mechanism=SCRAM-SHA-256sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \    username=&quot;elk&quot; \    password=&quot;123456&quot;;</code></pre><p>æ¶ˆè´¹å®¢æˆ·ç«¯é…ç½®<code>config/my.consumer.properties</code></p><pre><code class="language-properties">group.id=logstashsecurity.protocol=SASL_PLAINTEXTsasl.mechanism=SCRAM-SHA-256sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required \    username=&quot;elk&quot; \    password=&quot;123456&quot;;</code></pre><h2 id="æµ‹è¯•">æµ‹è¯•</h2><pre><code class="language-bash"># åˆ›å»ºä¸»é¢˜bin/kafka-topics.sh --bootstrap-server kafka1:8123 --command-config config/my.tools.properties --create --replication-factor 3 --partitions 8 --topic zz.it.elk.syslog</code></pre><pre><code class="language-bash"># ç”Ÿäº§è¿æ¥brokerbin/kafka-console-producer.sh --bootstrap-server kafka1:8123 --producer.config config/my.producer.properties  --topic zz.it.elk.syslog</code></pre><pre><code class="language-bash"># æ¶ˆè´¹è€…è¿æ¥brokerbin/kafka-console-consumer.sh --bootstrap-server kafka1:8123 --consumer.config config/my.consumer.properties  --topic zz.it.elk.syslog</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>002-kafkaåŸºæœ¬å®‰è£…</title>
      <link href="posts/bd4c8d1c/"/>
      <url>posts/bd4c8d1c/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…">å®‰è£…</h2><p><a href="http://kafka.apache.org/downloads">http://kafka.apache.org/downloads</a></p><p>ä¸‹è½½äºŒè¿›åˆ¶åŒ…</p><pre><code class="language-bash">cd /export &amp;&amp; mkdir src &amp;&amp; cd srccurl https://dlcdn.apache.org/kafka/3.0.0/kafka_2.13-3.0.0.tgz -o kafka.tgztar xf kafka.tgz -C ../ &amp;&amp; cd .. &amp;&amp; mv kafka_* kafka &amp;&amp; cd kafka</code></pre><p>è®¾ç½®hostnameï¼škafka1ã€kafka2ã€kafka3</p><pre><code class="language-bash">hostName=hostnamectl set-hostname $&#123;hostName&#125;</code></pre><p>æ·»åŠ <code>$int_ip $hostName</code>åˆ°<code>/etc/hosts</code></p><h2 id="é…ç½®å’Œå¯åŠ¨">é…ç½®å’Œå¯åŠ¨</h2><h3 id="zk">zk</h3><p>ä¸€ä»½é›†ç¾¤ï¼ˆ3èŠ‚ç‚¹ï¼‰æ¨¡å¼ä¸‹çš„zké…ç½®</p><pre><code class="language-properties">dataDir=/export/kafka/zk_dataclientPort=2181maxClientCnxns=0admin.enableServer=false# å¿ƒè·³## mså•ä½ï¼Œ2ç§’ä¸€æ¬¡æ£€æµ‹tickTime=2000## ä¸»ä»é—´åˆå§‹åŒ–æ—¶å€™å…è®¸å¿ƒè·³æ£€æµ‹å¤±è´¥çš„æ¬¡æ•°initLimit=10## ä¸»ä»é—´åŒæ­¥æ—¶å€™å…è®¸å¿ƒè·³æ£€æµ‹å¤±è´¥çš„æ¬¡æ•°syncLimit=5# èŠ‚ç‚¹åˆ—è¡¨server.1=kafka1:2888:3888server.2=kafka2:2888:3888server.3=kafka3:2888:3888</code></pre><p>åˆ†åˆ«åœ¨ä¸‰ä¸ªèŠ‚ç‚¹ä¸Šï¼Œåˆ›å»ºzkçš„myidæ–‡ä»¶</p><pre><code class="language-bash"># node01mkdir -p /export/kafka/zk_dataecho '1' &gt; /export/kafka/zk_data/myid# node02mkdir -p /export/kafka/zk_dataecho '2' &gt; /export/kafka/zk_data/myid# node03mkdir -p /export/kafka/zk_dataecho '3' &gt; /export/kafka/zk_data/myid</code></pre><p>å¯åŠ¨zk</p><pre><code class="language-bash">cd /export/kafka/nohup bin/zookeeper-server-start.sh config/zookeeper.properties &gt;&gt; zookeeper.nohup &amp;</code></pre><h3 id="kafka">kafka</h3><p>ä¸€ä»½é›†ç¾¤ï¼ˆ3èŠ‚ç‚¹ï¼‰æ¨¡å¼ä¸‹çš„kafkaé…ç½®</p><pre><code class="language-properties"># kafka1å†™1ï¼Œkafka2å†™2ï¼Œkafka3å†™3broker.id=1# æ— éœ€è®¾ç½®çš„listernersï¼Œä¼šè‡ªåŠ¨è·å–hostname#listeners=PLAINTEXT://:9092#advertised.listeners=PLAINTEXT://your.host.name:9092num.network.threads=3num.io.threads=8socket.send.buffer.bytes=102400socket.receive.buffer.bytes=102400socket.request.max.bytes=104857600# æ•°æ®ç›®å½•ã€‚å­˜å‚¨ä¸»é¢˜åˆ†åŒºæ—¥å¿—ï¼Œä¸»é¢˜æ•°æ®ä»¥æ–‡ä»¶å¤¹æ–¹å¼ç¨‹åºï¼Œæ–‡ä»¶å¤¹åç§°ï¼š&lt;ä¸»é¢˜å&gt;-&lt;åˆ†åŒºID&gt;log.dirs=/export/kafka/data# å¤šå°‘vcpuï¼Œå°±è®¾ç½®å¤šå°‘num.partitions=8num.recovery.threads.per.data.dir=1offsets.topic.replication.factor=1transaction.state.log.replication.factor=1transaction.state.log.min.isr=1log.retention.hours=168log.segment.bytes=1073741824log.retention.check.interval.ms=300000zookeeper.connect=kafka1:2181,kafka2:2181,kafka3:2181zookeeper.connection.timeout.ms=18000group.initial.rebalance.delay.ms=0</code></pre><p>å¯åŠ¨</p><pre><code class="language-bash">cd /export/kafka/nohup bin/kafka-server-start.sh config/server.properties &gt;&gt; kafka.nohup &amp;</code></pre><p>è¿œç¨‹ä¸€é”®å¯åŠ¨è„šæœ¬ï¼ˆéœ€æå‰sshä¿¡ä»»ï¼‰</p><p><a href="http://start-kafka.sh">start-kafka.sh</a></p><pre><code class="language-bash">brokers=(kafka1kafka2kafka3)for broker in $&#123;brokers[@]&#125;;&#123;echo $brokerssh $broker &quot;cd /export/kafka &amp;&amp; nohup bin/kafka-server-start.sh config/server.properties &gt;/dev/null 2&gt;&amp;1 &amp;&quot;&#125;&amp;waitdone</code></pre><h2 id="åˆ›å»ºä¸»é¢˜">åˆ›å»ºä¸»é¢˜</h2><pre><code class="language-bash">bin/kafka-topics.sh --bootstrap-server kafka1:9092 --create --replication-factor 3 --partitions 8 --topic zz.it.monit</code></pre><ul><li>â€“bootstrap-server ä½ å¯ä»¥å†™é›†ç¾¤é‡Œçš„ä»»æ„èŠ‚ç‚¹.</li><li>â€“replication-factor å¤åˆ¶å› å­æ•°&lt;=brokeræ•°é‡.</li><li>â€“partitions ä¸»é¢˜åˆ†åŒºæ•°ï¼Œå†³å®šäº†ä¸»é¢˜ä¸‹çš„æ—¥å¿—åˆ†æˆå¤šå°‘ä»½.</li></ul><p>â„¹ï¸</p><ol><li>ä¸»é¢˜ä¸€ç»åˆ›å»ºï¼Œåˆ™ä¸å¯é‡å‘½åï¼Œåªèƒ½é€šè¿‡æ–°å»ºä¸»é¢˜å¹¶è¿ç§»æ•°æ®ã€‚</li><li>ä¸»é¢˜åï¼Œåº”éµå¾ªä¸€å®šçš„å±‚æ¬¡ç»“æ„ï¼Œä»¥ä¾¿äºé€šè¿‡å‰ç¼€æ¥è¿›è¡Œæƒæ§ã€‚ä¾‹å¦‚ï¼š<ul><li><code>&lt;organization&gt;.&lt;team&gt;.&lt;dataset&gt;.&lt;event-name&gt;</code> æŒ‰ç…§ç»„ç»‡ç»“æ„å‘½å</li><li><code>&lt;project&gt;.&lt;product&gt;.&lt;event-name&gt;</code> æŒ‰ç…§é¡¹ç›®ç»“æ„å‘½å</li></ul></li><li>å½“å¤åˆ¶å› å­æ•°&lt;brokerçš„æ—¶å€™ï¼Œä¸€ä¸ªä¸»é¢˜çš„å‰¯æœ¬åˆ†åŒºå°†ã€æ— åºï¼ˆåˆ†åŒºIDï¼‰ã€‘ã€å°½é‡å¹³å‡ã€‘çš„å†™å…¥æ‰€æœ‰çš„brokerä¸­ã€‚</li><li>å½“å¤åˆ¶å› å­æ•°=brokerçš„æ—¶å€™ï¼Œä¸€ä¸ªä¸»é¢˜çš„å‰¯æœ¬åˆ†åŒºå°†ã€æœ‰åºï¼ˆåˆ†åŒºIDï¼‰ã€‘ã€å®Œå…¨ä¸€è‡´ã€‘çš„å†™å…¥æ‰€æœ‰çš„brokerä¸­ã€‚</li></ol><h2 id="äº‹ä»¶è¯»å†™">äº‹ä»¶è¯»å†™</h2><p>ç”Ÿäº§è€…å†™å…¥ä¸¤æ¡äº‹ä»¶ï¼Œäº‹ä»¶å°†è¢«æ°¸ä¹…å­˜å‚¨</p><pre><code class="language-bash">bin/kafka-console-producer.sh --bootstrap-server kafka1:9092 --topic zz.it.monit&gt;This is my first eventThis is my second event</code></pre><blockquote><p>å¦‚æœå¼€å¯äº†ç”¨æˆ·è®¤è¯ï¼Œåˆ™åŠ  --producer.config config/my.properties --bootstrap-server  kafka1:8123</p></blockquote><p>æ¶ˆè´¹è€…è¯»å–ä¸¤æ¡äº‹ä»¶ï¼Œå› äº‹ä»¶è¢«æ°¸ä¹…å­˜å‚¨ï¼Œæ•…è€Œå¯ä»¥å¤šæ¬¡æ¶ˆè´¹</p><pre><code class="language-bash">bin/kafka-console-consumer.sh --bootstrap-server kafka1:9092 --topic zz.it.monit --from-beginningThis is my first eventThis is my second event</code></pre><blockquote><p>å¦‚æœå¼€å¯äº†ç”¨æˆ·è®¤è¯ï¼Œåˆ™åŠ  --consumer.config config/my.properties --bootstrap-server kafka1:8123</p></blockquote><p>â„¹ï¸ç”Ÿäº§è€…çš„æ•°æ®å¯ä»¥ç«‹å³åœ¨æ¶ˆè´¹è€…ç«¯è¯»å–æ˜¾ç¤º.</p><h2 id="ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯">ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯</h2><p><a href="https://github.com/edenhill/kcat">https://github.com/edenhill/kcat</a></p><p><code>kcat</code>æ˜¯ä¸€ä¸ªæ›´åŠ å¼ºå¤§çš„å®¢æˆ·ç«¯ï¼ŒåŒ…å«äº†æ¶ˆè´¹å’Œç”Ÿäº§ï¼Œæ”¯æŒæŒ‰ç…§æ—¶é—´æˆ³æ¥æ¶ˆè´¹ï¼Œæ–¹ä¾¿é‡æ–°æ¶ˆè´¹å› æŸäº›åŸå› å¯¼è‡´ä¸¢å¤±çš„æ•°æ®ã€‚</p><p>â„¹ï¸ä»¥å‰å®ƒå«<code>kafkacat</code>ğŸ™„</p><h3 id="æŸ¥çœ‹topicåˆ—è¡¨å…ƒä¿¡æ¯">æŸ¥çœ‹topicåˆ—è¡¨å…ƒä¿¡æ¯</h3><pre><code class="language-bash">docker run -it --rm --network=host edenhill/kcat:1.7.0 \-b kafka1:8123 \-X security.protocol=&quot;SASL_PLAINTEXT&quot; \-X sasl.mechanism=SCRAM-SHA-256 \-X sasl.username=&quot;elk&quot; \-X sasl.password=&quot;123456&quot; \-L</code></pre><h3 id="è·å–æŸä¸ªæ—¶é—´èŒƒå›´å†…çš„äº‹ä»¶">è·å–æŸä¸ªæ—¶é—´èŒƒå›´å†…çš„äº‹ä»¶</h3><pre><code class="language-bash">docker run -it --rm --network=host edenhill/kcat:1.7.0 \-b kafka1:8123 \-X security.protocol=&quot;SASL_PLAINTEXT&quot; \-X sasl.mechanism=SCRAM-SHA-256 \-X sasl.username=&quot;elk&quot; \-X sasl.password=&quot;123456&quot; \-G logstash \-t zz.it.elk.syslog.secure \-C \-o s@`date -d &quot;20211129 16:57&quot; +%s`000 \-o e@`date -d &quot;20211129 18:00&quot; +%s`000</code></pre><pre><code class="language-bash">-G æ¶ˆè´¹ç»„-o æŒ‡å®šåç§»s@&lt;value&gt; (timestamp in ms to start at)e@&lt;value&gt; (timestamp in ms to stop at (not included))</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>001-kafkaåŸºæœ¬ä¿¡æ¯</title>
      <link href="posts/9bd7430f/"/>
      <url>posts/9bd7430f/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºæœ¬ç»“æ„">åŸºæœ¬ç»“æ„</h2><p>æœåŠ¡ç«¯ï¼š</p><ul><li>broker å­˜å‚¨æ•°æ®ï¼Œä¸€ä¸ªkafkaå®ä¾‹èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ª broker</li><li>kafka connect è¿æ¥å…¶å®ƒç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶å®ƒkafkaé›†ç¾¤ï¼‰ï¼Œä»è€Œå¯¼å…¥å¯¼å‡ºäº‹ä»¶æµ</li><li>zookeeper zké›†ç¾¤ç”¨æ¥å­˜å‚¨kafkaä¸­brokerå’Œtopicçš„ä¿¡æ¯</li></ul><p>å®¢æˆ·ç«¯ï¼š</p><p><a href="https://cwiki.apache.org/confluence/display/KAFKA/Clients">https://cwiki.apache.org/confluence/display/KAFKA/Clients</a></p><h2 id="åŸºæœ¬æ¦‚å¿µå¯¹è±¡">åŸºæœ¬æ¦‚å¿µå¯¹è±¡</h2><h3 id="äº‹ä»¶">äº‹ä»¶</h3><p>åŒ…å«é”®ï¼ˆå¯é€‰ï¼‰ï¼Œå€¼ï¼Œæ—¶é—´æˆ³ï¼Œå…ƒæ•°æ®æ ‡å¤´ï¼ˆå¯é€‰ï¼‰ï¼Œå­˜å‚¨åœ¨<code>ä¸»é¢˜</code>çš„<code>åˆ†åŒº</code>ä¸­</p><h3 id="æ‰¹æ¬¡">æ‰¹æ¬¡</h3><p>kafkaæ¯æ¬¡ç§¯æ”’äº‹ä»¶ï¼Œè¾¾åˆ°å½¢æˆä¸€ä¸ªæ‰¹æ¬¡çš„æ¡ä»¶åï¼ŒæŒ‰æ‰¹æ¬¡æ‰“åŒ…å‘é€</p><h3 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…</h3><p>å°†äº‹ä»¶å†™å…¥åˆ°æœåŠ¡ç«¯çš„å®¢æˆ·ç«¯ç¨‹åº</p><h3 id="æ¶ˆè´¹è€…">æ¶ˆè´¹è€…</h3><p>ä»æœåŠ¡ç«¯è·å–äº‹ä»¶çš„å®¢æˆ·ç«¯ç¨‹åº</p><h3 id="æ¶ˆè´¹è€…ç»„">æ¶ˆè´¹è€…ç»„</h3><p>å¤šä¸ªæ¶ˆè´¹è€…å…±ç”¨ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç»„ID</p><h3 id="ä¸»é¢˜">ä¸»é¢˜</h3><p>ä¸»é¢˜æ˜¯å­˜å‚¨äº‹ä»¶çš„é€»è¾‘å±‚ã€‚ä¸€ä¸ªä¸»é¢˜å°±å¦‚åŒä¸€ä¸ªç®¡é“ï¼Œç®¡é“å·¦è¾¹æ˜¯å¤šä¸ªç”Ÿäº§è€…ï¼Œç®¡é“å³è¾¹æ˜¯å¤šä¸ªæ¶ˆè´¹è€…ã€‚æˆ‘ä»¬é€šè¿‡ä¸»é¢˜åˆ†ç±»äº‹ä»¶ã€‚</p><p>æ¯ä¸ªä¸»é¢˜çš„äº‹ä»¶å­˜å‚¨å‘¨æœŸï¼Œå–å†³äºé…ç½®ã€‚ä¸ç®¡å­˜å‚¨å­˜å¤šå°‘ï¼Œkafkaçš„æ€§èƒ½éƒ½æ˜¯o(1)çº§åˆ«ï¼Œä¹Ÿå°±æ˜¯æ€§èƒ½ä¸ä¼šå˜ã€‚</p><p>ä¸»é¢˜æ•£åˆ—åœ¨å¤šä¸ª<code>broker</code>çš„å¤šä¸ª<code>buckets</code>ã€‚</p><h3 id="åˆ†åŒº">åˆ†åŒº</h3><p>æ¯ä¸€ä¸ªä¸»é¢˜åŒ…å«å¤šä¸ªåˆ†åŒºï¼Œåˆ†åŒºä¼šè‡ªåŠ¨å°½é‡å¹³å‡çš„åˆ†æ•£åœ¨å¤šä¸ªbrokerä¸Š.</p><p>å¤šåˆ†åŒºå…è®¸å®¢æˆ·ç«¯å¹¶å‘è®¿é—®ä¸»é¢˜ä¸­çš„æ•°æ®.</p><p>åŒä¸€ä¸ªä¸»é¢˜ä¸‹çš„ç›¸åŒkeyçš„äº‹ä»¶å°†å§‹ç»ˆå†™å…¥åŒä¸€ä¸ªåˆ†åŒºã€é€šè¿‡hash(key)æ¥è½ç‚¹ã€‘ã€‚</p><p>åŒä¸€ä¸ªä¸»é¢˜ä¸‹çš„æ²¡æœ‰å®šä¹‰keyçš„äº‹ä»¶éµå¾ªä¸¤ä¸ªåˆ†å‘ç­–ç•¥ï¼šè½®è¯¢ç­–ç•¥å’Œç²˜æ€§ç­–ç•¥ã€‚ç²˜æ€§ç­–ç•¥æ€§èƒ½æ›´å¥½ã€‚</p><p>â„¹ï¸åˆ†åŒºå†…äº‹ä»¶è¯»å–çš„æ—¶å€™éµå¾ªå…ˆå…¥å…ˆå‡ºåŸåˆ™ã€‚</p><p>â„¹ï¸æ·»åŠ æ–°åˆ†åŒºä¸ä¼šå¯¼è‡´ç°æœ‰åˆ†åŒºçš„æ•°æ®å‘ç”Ÿæ”¹å˜ã€‚</p><p>ä¸ºäº†é˜²æ­¢é‡å¤æ¶ˆè´¹ï¼š</p><ol><li><p>åŒä¸€ä¸ªåˆ†åŒºé‡Œçš„äº‹ä»¶åŒä¸€æ—¶é—´ä¸ä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…ç»„é‡Œçš„å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</p></li><li><p>åŒä¸€ä¸ªåˆ†åŒºé‡Œçš„äº‹ä»¶åŒä¸€æ—¶é—´å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</p></li><li><p>æ¶ˆè´¹è€…æ¶ˆè´¹å®Œä¼šè§¦å‘ä½ç§»æäº¤ï¼Œåˆ·æ–°ä¸»é¢˜ä¸‹æ¬¡æ¶ˆè´¹çš„èµ·å§‹ç‚¹ã€‚</p></li></ol><h3 id="å‰¯æœ¬å› å­">å‰¯æœ¬å› å­</h3><p>æ¯ä¸€ä¸ªåˆ†åŒºæœ‰å‡ ä¸ªå‰¯æœ¬</p><h2 id="èŠ‚ç‚¹å­˜æ´»">èŠ‚ç‚¹å­˜æ´»</h2><ol><li>èŠ‚ç‚¹æ—¶åˆ»ä¸zkä¿æŒæ²Ÿé€šã€‚</li><li>è¿½éšèŠ‚ç‚¹çš„æ•°æ®å§‹ç»ˆä¸ä¼šè½åä¸»èŠ‚ç‚¹å¤ªå¤šã€‚</li></ol><p>æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶çš„èŠ‚ç‚¹ï¼ŒçŠ¶æ€æ ‡è®°ä¸º<code>in sync</code>ï¼Œä¹Ÿå°±æ˜¯å­˜æ´»ä¸­ã€‚</p><h2 id="æ¶ˆæ¯å‘é€æœºåˆ¶">æ¶ˆæ¯å‘é€æœºåˆ¶</h2><p>å½“ä¸€ä¸ªäº‹ä»¶è¢«åˆ†åŒºæ‰€æœ‰å‰¯æœ¬å†™å…¥åï¼Œkafkaæ‰ä¼šå°†äº‹ä»¶å‘é€ç»™æ¶ˆè´¹è€…ã€‚</p><h2 id="rebalanceæœºåˆ¶">rebalanceæœºåˆ¶</h2><p>è¿™ä¸ªæ¦‚å¿µæ˜¯é’ˆå¯¹æ¶ˆè´¹è€…ç»„ï¼Œæ„æ€æ˜¯æ¶ˆè´¹è€…ç»„å°†ä¸€ä¸ªtopicçš„æ‰€æœ‰åˆ†åŒºå°½å¯èƒ½çš„åˆ†å‘ç»™æ‰€æœ‰æ¶ˆè´¹è€…ã€‚</p><p>å¦å¤–ï¼Œæ¶ˆè´¹è€…å‡ºç°æ¶ˆè´¹ä¸å®Œï¼Œæˆ–è€…æ²¡æœ‰å‘é€å¿ƒè·³ï¼Œéƒ½ä¼šè¢«è¸¢å‡ºæ¶ˆè´¹è€…ç»„ï¼Œå¯¼è‡´æ¶ˆè´¹è€…ç»„æˆå‘˜å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå¼•å‘rebalanceã€‚</p><p>åœ¨ä¸Šè¿°æƒ…å†µä¸­ï¼Œè¢«è¸¢å‡ºçš„æ¶ˆè´¹è€…åˆå› ä¸ºæ— æ³•æ‰§è¡Œæäº¤ä½ç§»ï¼Œè¿™ä¼šå¯¼è‡´ç›¸å½“äºæ²¡æœ‰æ¶ˆè´¹ï¼Œæœ€ç»ˆäº§ç”Ÿé‡å¤æ¶ˆè´¹é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ¶ˆæ¯ </category>
          
          <category> kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜å®‰è£….</title>
      <link href="posts/b824edd8/"/>
      <url>posts/b824edd8/</url>
      
        <content type="html"><![CDATA[<p><a href="https://hub.docker.com/_/mysql?tab=description">https://hub.docker.com/_/mysql?tab=description</a></p><pre><code class="language-bash">mkdir -p /export/docker-data-mysql/&#123;config,logs,mysql,mysql-files&#125;docker run --name mysql8 \-p 3306:3306 \--restart=always \--mount 'type=bind,src=/export/docker-data-mysql/config,dst=/etc/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/logs,dst=/var/log/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/mysql,dst=/var/lib/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/mysql-files,dst=/var/lib/mysql-files' \-e MYSQL_ROOT_PASSWORD=123456 \-d mysql:8 \--character-set-server=utf8mb4 \--collation-server=utf8mb4_general_ci</code></pre><blockquote><p>-d mysql:5.6</p></blockquote><p>å¼€å¯è¿œç¨‹è®¿é—®</p><pre><code class="language-sql">alter user 'root'@'%' identified with mysql_native_password by '123456';</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜rds-mysqlå‚æ•°</title>
      <link href="posts/438aa722/"/>
      <url>posts/438aa722/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># ä¸‹åˆ—æ˜¯éé»˜è®¤å€¼character_set_client: utf8character_set_connection: utf8character_set_database: utf8character_set_filesystem: utf8character_set_results: utf8character_set_server: utf8collation_connection: utf8_general_cislow_query_log: 1long_query_time: 10log_output: FILE# ä¸‹åˆ—æ˜¯é»˜è®¤å€¼explicit_defaults_for_timestamp: '1'innodb_buffer_pool_size: '&#123;DBInstanceClassMemory*3/4&#125;'innodb_file_per_table: '1'innodb_flush_method: O_DIRECTbinlog_cache_size: '32768'binlog_format: MIXED</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rds </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜EC2å›½å†…å¤–ä¹‹é—´è¿ç§»</title>
      <link href="posts/2e304ad6/"/>
      <url>posts/2e304ad6/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬</h1><p>aws å›½å†…å’Œå›½å¤–ä¹‹é—´æ— æ³•ç›´æ¥å¤åˆ¶ AMIï¼Œæ‰€ä»¥ç»å’¨è¯¢ aws æŠ€æœ¯äººå‘˜ï¼Œå°±æœ‰äº†è¿™ä¹ˆä¸€é“æ‰‹å·¥é¥­ã€‚ã€‚ã€‚</p><h1>æ­¥éª¤</h1><ol><li>é€šè¿‡å›½å¤–å¾…è¿ç§»çš„AMIåˆ›å»ºä¸€ä¸ªEC2ï¼Œå¹¶æŒ‚è½½ä¸€ä¸ªæ–°EBSï¼ˆ/dev/xvdbï¼‰ï¼ŒEBSå¤§å°ç•¥å¤§äºEC2çš„æ ¹åˆ†åŒºï¼Œå¦‚10GBã€‚</li><li>ç™»å½•EC2ï¼Œå¹¶æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ã€‚</li></ol><pre><code class="language-shell">mke2fs -t ext4 /dev/xvdbmount -t ext4 /dev/xvdb /mnt# å…‹éš†æ ¹åˆ†åŒºåˆ° /mnt/root.imgdd if=/dev/xvda of=/mnt/root.img bs=1M# å°† /mnt/root.img ä¸‹è½½åˆ°å›½å†…</code></pre><ol start="3"><li>æ–°å»ºå›½å†…EC2ï¼Œå¹¶æŒ‚è½½ä¸€ä¸ªæ–°EBSï¼ˆ/dev/xvdbï¼‰ï¼ŒEBSå¤§å°10GBã€‚</li><li>å°†å›½å¤–çš„ root.img ä¸Šä¼ åˆ°å›½å†… EC2ã€‚</li><li>ç™»å½•EC2ï¼Œå¹¶æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ã€‚</li></ol><pre><code class="language-bash">dd if=/mnt/root.img of=/dev/xvdb bs=1M oflag=direct</code></pre><ol start="6"><li>å¯¹/dev/xvdbæ‰“å¿«ç…§ï¼Œå¹¶é’ˆå¯¹è¿™ä¸ªå¿«ç…§ç”ŸæˆAMIå³å¯ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ec2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜åˆ©ç”¨cfæœåŠ¡åˆå§‹åŒ–awsç¯å¢ƒ</title>
      <link href="posts/ddc4c969/"/>
      <url>posts/ddc4c969/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å› å…¬å¸å°é¡¹ç›®å¤šï¼Œè´¦æˆ·å¤šï¼Œæ¯æ¬¡æ„å»ºawsåˆå§‹åŒ–ç¯å¢ƒå‡å¾ˆéº»çƒ¦ï¼Œä¸”æ¯ä¸ªäººæ“ä½œçš„æ—¶å€™ï¼Œæƒ³æ³•éƒ½ä¸ä¸€æ ·ï¼Œè§„åˆ™ä¸ç»Ÿä¸€ï¼Œå¯¼è‡´ç¯å¢ƒä¿¡æ¯æ— æ³•é€šç”¨.</p><p>æ‰€ä»¥å‡†å¤‡ä½¿ç”¨ cf æ¥æ„å»ºä¸€ä¸ªé€šç”¨æ¨¡æ¿ï¼Œä¿æŒç¯å¢ƒä¸€è‡´æ€§.</p><p>ä¹‹å‰ä¸€ç›´æ²¡æœ‰ä½¿ç”¨ï¼Œæ˜¯å› ä¸º cf æœ¬èº«ç¼–å†™ä¸æ˜¯å¤ªæ–¹ä¾¿ï¼Œç„¶è€Œæˆ‘ä½ä¼°äº† aws çš„ç‰›é€¼ï¼Œä»”ç»†çœ‹äº†æ–‡æ¡£æ‰çŸ¥é“ï¼Œ æœ‰ä¸ª cf æœ¬èº«æœ‰ä¸ªå †æ ˆï¼Œå¯ä»¥ç›´æ¥å¤åˆ»å½“å‰ç¯å¢ƒ.</p><p>è¿™ä¸ªå·¥å…·å°±æ˜¯ <code>cloudformer</code></p><p>å®˜æ–¹æ–‡æ¡£æ˜¯: <a href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/cfn-using-cloudformer.html#launch-cloudformer">https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/cfn-using-cloudformer.html#launch-cloudformer</a></p></blockquote><h2 id="é‚£ä¹ˆæ­¥éª¤æ¥äº†">é‚£ä¹ˆæ­¥éª¤æ¥äº†~</h2><ul><li><p>å…ˆé€šè¿‡ web æ§åˆ¶å°ç”Ÿæˆä¸€ä¸ªé€‚åˆæœ¬åœ°åŒ–çš„é€šç”¨ç¯å¢ƒï¼Œæ¯”å¦‚ vpcï¼Œå­ç½‘ï¼Œå®‰å…¨ç»„ï¼Œæ•°æ®åº“å­ç½‘ç»„ï¼Œå‚æ•°ç»„ï¼Œs3ä»¥åŠç›¸åº”çš„s3ç”Ÿå‘½å‘¨æœŸè§„åˆ™ç­‰ç­‰</p></li><li><p>æ„å»º cloudformer å †æ ˆï¼Œå¹¶é€šè¿‡ cloudformer æœåŠ¡ç”Ÿæˆå½“å‰ç¯å¢ƒæ¨¡æ¿</p></li><li><p>å°†å½“å‰ç¯å¢ƒæ¨¡æ¿çš„ä¸€äº›éé€šç”¨å†…å®¹ï¼Œæ¢æˆå˜é‡ï¼Œå¹¶æ„å»ºæˆ cf å‚æ•°æˆ–è€…è„šæœ¬</p></li><li><p>æœ€åé€šè¿‡æ‰§è¡Œè„šæœ¬ï¼Œå¹¶è¾“å…¥å˜é‡å€¼ï¼Œæ¥ç”Ÿæˆæ–°æ¨¡æ¿</p></li><li><p>åœ¨æ–°ç¯å¢ƒé‡Œè°ƒç”¨æ–°æ¨¡æ¿æ¥åˆå§‹åŒ–ç¯å¢ƒ</p></li></ul><h2 id="ä¸‹é¢æ˜¯æˆ‘è´´å‡ºçš„ä¸€ä¸ªåŸºç¡€ç¯å¢ƒç”Ÿæˆè„šæœ¬">ä¸‹é¢æ˜¯æˆ‘è´´å‡ºçš„ä¸€ä¸ªåŸºç¡€ç¯å¢ƒç”Ÿæˆè„šæœ¬</h2><ul><li><p>vpc: x.x.0.0/16</p></li><li><p>prod: x.x.128.0/17</p><ul><li>prod å­ç½‘é»˜è®¤æœ‰å››ä¸ª, åˆ†åˆ«æ˜¯ EC2 ä¸¤ä¸ªå¯ç”¨åŒº, Database ä¸¤ä¸ªå¯ç”¨åŒº</li></ul></li><li><p>qa: x.x.0.0/19</p><ul><li>qa å­ç½‘é»˜è®¤æœ‰å››ä¸ª, åˆ†åˆ«æ˜¯ EC2 ä¸¤ä¸ªå¯ç”¨åŒº, Database ä¸¤ä¸ªå¯ç”¨åŒº</li></ul></li><li><p>prod å’Œ qa é€šè¿‡å®‰å…¨ç»„æ¥åˆ†å‰²</p><ul><li><p>prod è§„åˆ™ç¤ºä¾‹å¦‚ä¸‹(qaä¸€æ ·):</p></li><li><p>Prod-EC2-common:</p><table><thead><tr><th>è§„åˆ™å</th><th>åè®®</th><th>å¼€æ”¾ç«¯å£</th><th>æºipæˆ–è€…å…¶å®ƒå®‰å…¨ç»„ID</th><th></th></tr></thead><tbody><tr><td>æ‰€æœ‰æµé‡</td><td>å…¨éƒ¨</td><td>å…¨éƒ¨</td><td>10.130.128.0/17</td><td></td></tr></tbody></table></li></ul><p>| SSH      | TCP  | 22       | ${src_allow_ssh_ip}  |      |</p><ul><li><p>Prod-Database-common:</p><table><thead><tr><th>è§„åˆ™å</th><th>åè®®</th><th>å¼€æ”¾ç«¯å£</th><th>æºipæˆ–è€…å…¶å®ƒå®‰å…¨ç»„ID</th><th></th></tr></thead><tbody><tr><td>è‡ªå®šä¹‰ TCP è§„åˆ™</td><td>TCP</td><td>1025 - 65535</td><td>${src_allow_rds_ip}</td><td></td></tr><tr><td>è‡ªå®šä¹‰ TCP è§„åˆ™</td><td>TCP</td><td>1025 - 65535</td><td>Prod-EC2-common-Group-ID</td><td></td></tr></tbody></table></li></ul></li><li><p>SNS é»˜è®¤é¢„è­¦ä¸»é¢˜</p></li><li><p>mysql å­ç½‘ç»„</p></li><li><p>redis å­ç½‘ç»„</p></li><li><p>s3ä»¥åŠåˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸè§„åˆ™</p></li><li><p>vpc è·¯ç”±è¡¨ä¸ä¼šæ·»åŠ é»˜è®¤è·¯ç”±, è¿˜è¯·è‡ªè¡Œæ·»åŠ (Internet ç½‘å…³ä¼šè‡ªåŠ¨ç”Ÿæˆ)</p></li></ul><pre><code class="language-bash">#!/bin/bash# æœ¬è„šæœ¬ç”¨æ¥ç”Ÿæˆä¸€ä»½åŸºç¡€ç¯å¢ƒçš„ cf æ¨¡æ¿# ç½‘ç»œAå’ŒBæ®µï¼Œä¾‹å¦‚ 10.10 é‚£ä¹ˆ vpc å°±æ˜¯ 10.10.0.0/16VpcCidrBlockAB=# å¤§åŒºåŒºåŸŸ, ä¾‹å¦‚ æ–°åŠ å¡ é‚£ä¹ˆåŒºåŸŸå°±å†™ ap-southeast-1Region=# é¡¹ç›®åï¼Œç”¨äºåŒºåˆ†èµ„æºä»¥åŠæ·»åŠ  Team æ ‡ç­¾ (åªèƒ½æ˜¯å­—æ¯æ•°å­—ç»„åˆ)TagTeamValue=# å…è®¸è®¿é—®EC2çš„22å·ç«¯å£çš„ip (æŒ‡çš„æ˜¯évpcå†…ç½‘)ï¼Œé€šå¸¸åº”è¯¥æ˜¯å ¡å’æœºæˆ–è€…å…¬å¸å¤–ç½‘src_allow_ssh_ip=# å…è®¸è®¿é—®æ•°æ®åº“ç«¯å£çš„ip (æŒ‡çš„æ˜¯évpcå†…ç½‘)ï¼Œé€šå¸¸åº”è¯¥æ˜¯å ¡å’æœºæˆ–è€…å…¬å¸å¤–ç½‘src_allow_rds_ip=# é»˜è®¤ SNS æœåŠ¡ä¸»ä½“å SNSThemeNameSNSThemeName=$&#123;TagTeamValue&#125;# é»˜è®¤ SNS æœåŠ¡ä¿¡æ¯æ¥æ”¶ç”¨æˆ·é‚®ç®±, cf æ¨¡æ¿æ‰§è¡Œå®Œåï¼Œéœ€è¦ç”¨æˆ·é‚®ç®±è¯»å–é‚®ä»¶è‡ªè¡Œç¡®è®¤æ¶ˆæ¯SNSEmail=# è®¾ç½® vpc ä»»æ„ä¸¤ä¸ªå¯ç”¨åŒº å­—æ¯æ ‡è¯†, æ¯”å¦‚ a bAvailabilityZoneOne=aAvailabilityZoneTwo=b######## æœ¬æ¨¡æ¿, ä¸ä¼šæ·»åŠ  vpc é»˜è®¤è·¯ç”±, è¯·è‡ªè¡ŒåŠ   #########cat &gt; cf-common.yml &lt;&lt; EOFAWSTemplateFormatVersion: 2010-09-09Resources:  vpc12345:    Type: 'AWS::EC2::VPC'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.0.0/16      InstanceTenancy: default      EnableDnsSupport: 'true'      EnableDnsHostnames: 'true'      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 84f85642-9390-4126-b347-95ca2ebf1c15  subnet0qa0database0$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.3.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-database-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 864ecf93-1ce6-4b4d-9b29-c3d89f07141b  subnet0prod0database0$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.131.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-database-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 7ef6daea-3bcd-4913-ab55-ba4f7bced319  subnet0qa0ec20$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.2.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-ec2-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: bc2b5a08-f7b8-4699-a7ba-5c9c6c021bd8  subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.4.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-database-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: b4738f0a-11a6-4d75-b9f0-a24072e53228  subnet0prod0ec20$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.129.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-ec2-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 2ffb24f6-49fd-4d3a-bdfe-69e90e228517  subnet0prod0ec20$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.128.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-ec2-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 9a2789fc-b7d2-4532-811b-be3455ab7d7d  subnet0qa0ec20$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.1.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-ec2-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 5c6c2638-a7b5-4185-a7a3-08d5901c252a  subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.132.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-database-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 00a78a8b-fd72-4613-bf09-8319b876ba2b  igw088b65cb430bc5ca0:    Type: 'AWS::EC2::InternetGateway'    Properties:      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-internet-gw    Metadata:      'AWS::CloudFormation::Designer':        id: e60ac13b-274d-46db-ac2a-5afaf975e1eb  dopt8128ece5:    Type: 'AWS::EC2::DHCPOptions'    Properties:      DomainName: $&#123;Region&#125;.compute.internal      DomainNameServers:        - AmazonProvidedDNS    Metadata:      'AWS::CloudFormation::Designer':        id: 909e6481-ccca-40fe-a1b1-4abe15a2ba18  acl03e81a4f65756520d:    Type: 'AWS::EC2::NetworkAcl'    Properties:      VpcId: !Ref vpc12345    Metadata:      'AWS::CloudFormation::Designer':        id: 93e06538-fe9e-49a7-8549-e2efb97dfab7  dbsubnet$&#123;TagTeamValue&#125;prod:    Type: 'AWS::RDS::DBSubnetGroup'    Properties:      DBSubnetGroupDescription: $&#123;TagTeamValue&#125;-prod      SubnetIds:        - !Ref subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;        - !Ref subnet0prod0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 16096ba6-c5de-4a73-a083-07b2c0573362  dbsubnet$&#123;TagTeamValue&#125;qa:    Type: 'AWS::RDS::DBSubnetGroup'    Properties:      DBSubnetGroupDescription: $&#123;TagTeamValue&#125;-qa      SubnetIds:        - !Ref subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;        - !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 186893f8-59ef-4d56-880f-d62294d25780  dbpg$&#123;TagTeamValue&#125;prod:    Type: 'AWS::RDS::DBParameterGroup'    Properties:      Description: $&#123;TagTeamValue&#125;-prod-mysql5.6      Family: mysql8.0      Parameters:        binlog_cache_size: '32768'        binlog_format: MIXED        character_set_client: utf8mb4        character_set_connection: utf8mb4        character_set_database: utf8mb4        character_set_filesystem: utf8mb4        character_set_results: utf8mb4        character_set_server: utf8mb4        collation_connection: utf8mb4_general_ci        explicit_defaults_for_timestamp: '1'        innodb_buffer_pool_size: '&#123;DBInstanceClassMemory*3/4&#125;'        innodb_file_per_table: '1'        innodb_flush_method: O_DIRECT    Metadata:      'AWS::CloudFormation::Designer':        id: 87a954ed-d1b2-4626-87fe-f2515f4479b4  dbpg$&#123;TagTeamValue&#125;qa:    Type: 'AWS::RDS::DBParameterGroup'    Properties:      Description: $&#123;TagTeamValue&#125;-qa-mysql5.6      Family: mysql8.0      Parameters:        binlog_cache_size: '32768'        binlog_format: MIXED        character_set_client: utf8        character_set_connection: utf8        character_set_database: utf8        character_set_filesystem: utf8        character_set_results: utf8        character_set_server: utf8        collation_connection: utf8_general_ci        explicit_defaults_for_timestamp: '1'        innodb_buffer_pool_size: '&#123;DBInstanceClassMemory*3/4&#125;'        innodb_file_per_table: '1'        innodb_flush_method: O_DIRECT    Metadata:      'AWS::CloudFormation::Designer':        id: 6c4c2e1e-ec99-4e7f-b254-0f09145a0d87  cachesubnet$&#123;TagTeamValue&#125;databaseprod:    Type: 'AWS::ElastiCache::SubnetGroup'    Properties:      Description: '$&#123;TagTeamValue&#125;_prod'      SubnetIds:        - !Ref subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;        - !Ref subnet0prod0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: bdfb3d49-78d8-40df-84b6-63bf65616f5c  cachesubnet$&#123;TagTeamValue&#125;databaseqa:    Type: 'AWS::ElastiCache::SubnetGroup'    Properties:      Description: '$&#123;TagTeamValue&#125;_qa'      SubnetIds:        - !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;        - !Ref subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 70367616-0a11-4bc9-9373-a23be1690a59  topicIT:    Type: 'AWS::SNS::Topic'    Properties:      DisplayName: $&#123;SNSThemeName&#125;      Subscription:        - Endpoint: $&#123;SNSEmail&#125;          Protocol: email    Metadata:      'AWS::CloudFormation::Designer':        id: 343cc3f4-4380-47e5-850e-cc3fb560f22a  $&#123;TagTeamValue&#125;qacommon:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-qa-common      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  QA-EC2-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: d31db020-e702-41e5-8ccc-d71a5a26f565  $&#123;TagTeamValue&#125;prodcommon:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-prod-common      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  Prod-EC2-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: f54456ef-e984-4b00-b04d-64b16a2057ea  ITLinshi:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: IT-Linshi      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  I'm god    Metadata:      'AWS::CloudFormation::Designer':        id: 182b7e60-f895-4519-8845-4d32a8591340  $&#123;TagTeamValue&#125;proddatabase:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-prod-database      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  Prod-database-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: 44f0485a-2575-4eab-82b3-bc7507cd5820  $&#123;TagTeamValue&#125;qadatabase:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-qa-database      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  QA-database-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: f903102a-c394-4301-a08d-5625293ac23f  snspolicyIT:    Type: 'AWS::SNS::TopicPolicy'    Properties:      Topics:        - !Ref topicIT      PolicyDocument:        Version: 2008-10-17        Id: __default_policy_ID        Statement:          - Sid: __default_statement_ID            Effect: Allow            Principal:              AWS: '*'            Action:              - 'SNS:GetTopicAttributes'              - 'SNS:SetTopicAttributes'              - 'SNS:AddPermission'              - 'SNS:RemovePermission'              - 'SNS:DeleteTopic'              - 'SNS:Subscribe'              - 'SNS:ListSubscriptionsByTopic'              - 'SNS:Publish'              - 'SNS:Receive'            Resource: !Ref topicIT            Condition:              StringEquals:                'AWS:SourceOwner': '705452591009'    Metadata:      'AWS::CloudFormation::Designer':        id: 66a45d1a-3c99-4ef8-9c4e-db9ba717e17e  acl1:    Type: 'AWS::EC2::NetworkAclEntry'    Properties:      CidrBlock: 0.0.0.0/0      Egress: 'true'      Protocol: '-1'      RuleAction: allow      RuleNumber: '100'      NetworkAclId: !Ref acl03e81a4f65756520d    Metadata:      'AWS::CloudFormation::Designer':        id: de76822e-cddc-40d9-ba6f-4de20d1188ec  acl2:    Type: 'AWS::EC2::NetworkAclEntry'    Properties:      CidrBlock: 0.0.0.0/0      Protocol: '-1'      RuleAction: allow      RuleNumber: '100'      NetworkAclId: !Ref acl03e81a4f65756520d    Metadata:      'AWS::CloudFormation::Designer':        id: eb6e0bf9-3c84-4991-a037-64e2a368650b  subnetacl1:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0ec20$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 2801f8a7-901b-43b6-b4d9-9275d5639b86  subnetacl2:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0ec20$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 67641cac-39f6-4ee1-8410-60eaba963c27  subnetacl3:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0ec20$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 4b480f9d-e7b8-4034-b253-1c254fd83758  subnetacl4:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 1792de63-b1da-4c31-bab9-9925de98de6c  subnetacl5:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: e62f3e81-63f0-4f5e-b3e0-aa733ba6f323  subnetacl6:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0ec20$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 28228fcf-5649-4e5e-bf03-d636ca28bffe  subnetacl8:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 00ab0d37-3e37-427e-ac06-e94663719fcf  subnetacl9:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: ee93485d-3df4-416d-ab61-4f77c46441f1  subnetacl10:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: a4208016-e7cf-4acf-a718-104a25fef4c3  gw1:    Type: 'AWS::EC2::VPCGatewayAttachment'    Properties:      VpcId: !Ref vpc12345      InternetGatewayId: !Ref igw088b65cb430bc5ca0    Metadata:      'AWS::CloudFormation::Designer':        id: 3071b8a9-f4ab-4d61-83d8-d2792481e135  dchpassoc1:    Type: 'AWS::EC2::VPCDHCPOptionsAssociation'    Properties:      VpcId: !Ref vpc12345      DhcpOptionsId: !Ref dopt8128ece5    Metadata:      'AWS::CloudFormation::Designer':        id: 69a63971-39fa-45c9-8a17-cc730730083d  ingress1:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qacommon      IpProtocol: '-1'      CidrIp: $&#123;VpcCidrBlockAB&#125;.0.0/19  ingress2:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      IpProtocol: '-1'      CidrIp: $&#123;VpcCidrBlockAB&#125;.128.0/17  ingress3:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;proddatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      SourceSecurityGroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      SourceSecurityGroupOwnerId: '705452591009'    Metadata:      'AWS::CloudFormation::Designer':        id: 8972689f-9301-4538-b493-bd1956559ecd  ingress4:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qadatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      SourceSecurityGroupId: !Ref $&#123;TagTeamValue&#125;qacommon      SourceSecurityGroupOwnerId: '705452591009'    Metadata:      'AWS::CloudFormation::Designer':        id: 236a8060-da9c-4be7-af29-fb6758a764a9  ingress5:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref ITLinshi      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  ingress6:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qacommon      IpProtocol: tcp      FromPort: '22'      ToPort: '22'      CidrIp: $&#123;src_allow_ssh_ip&#125;  ingress8:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      IpProtocol: tcp      FromPort: '22'      ToPort: '22'      CidrIp: $&#123;src_allow_ssh_ip&#125;  ingress11:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;proddatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      CidrIp: $&#123;src_allow_rds_ip&#125;  ingress14:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qadatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      CidrIp: $&#123;src_allow_rds_ip&#125;  egress1:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qacommon      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress2:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress3:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref ITLinshi      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress4:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;proddatabase      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress5:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qadatabase      IpProtocol: '-1'      CidrIp: 0.0.0.0/0Description: ''EOF</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ec2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlabâ˜æ‰¹é‡ä¿®æ”¹ç”¨æˆ·å¯†ç </title>
      <link href="posts/5edc3545/"/>
      <url>posts/5edc3545/</url>
      
        <content type="html"><![CDATA[<pre><code>export OldToken=export OldDomain=# å¯¼å‡º ç”¨æˆ·ID ç”¨æˆ·å ç”¨æˆ·çŠ¶æ€ ç”¨æˆ·é‚®ç®±curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/users?per_page=100&amp;page=1&quot;  | jq '.[] | .id,.username,.state,.email' | sed 'N;N;N;s#\n# #g;s#&quot;##g' | grep 'active' &gt;&gt; user.id;curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/users?per_page=100&amp;page=2&quot;  | jq '.[] | .id,.username,.state,.email' | sed 'N;N;N;s#\n# #g;s#&quot;##g' | grep 'active' &gt;&gt; user.id;# ä¿®æ”¹ç”¨æˆ·å¯†ç , å¹¶ç”Ÿæˆå¯†ç è®°å½•æ–‡ä»¶ user.passwordwhile read userid username state email;do    Pwd=`cat /proc/sys/kernel/random/uuid | cut -d'-' -f1`    curl --request  PUT --header &quot;PRIVATE-TOKEN:$&#123;OldToken&#125;&quot; --data &quot;password=$&#123;username&#125;@$&#123;Pwd&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/users/$&#123;userid&#125;&quot;    echo &quot;$&#123;email&#125; $&#123;username&#125; $&#123;username&#125;@$&#123;Pwd&#125;&quot; &gt;&gt; user.passworddone &lt; user.id</code></pre><pre><code>#!/usr/bin/python #coding:utf-8   import smtplib from email.mime.text import MIMEText import sys  mail_host = 'smtp.gmail.com:587'mail_user = 'it-ops@altamob.com'mail_pass = 'hoqmefjrmkvkukth'def send_mail(to_list,subject,content):     me = mail_user+&quot;&lt;&quot;+mail_user+&quot;&gt;&quot;     msg = MIMEText(content)     msg['Subject'] = subject     msg['From'] = me     msg['to'] = to_list          try:     print &quot;start sendmail&quot;        s = smtplib.SMTP(mail_host)    print &quot;connect mail server suesscc&quot;     s.starttls()        s.login(mail_user,mail_pass)     print &quot;login mail server suesscc&quot;        s.sendmail(me,to_list,msg.as_string())         s.close()         return True     except Exception,e:         print str(e)         return False      if __name__ == &quot;__main__&quot;:     send_mail(sys.argv[1], sys.argv[2], sys.argv[3])</code></pre><pre><code>while read email username pwd;do python sendmail.py &quot;$&#123;email&#125;&quot; &quot;gitlab $&#123;username&#125;æ–°å¯†ç &quot; &quot;$&#123;pwd&#125;&quot;;done &lt; user.password</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶ä»– </category>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜æ³›åŸŸå_å˜é‡æˆªå–</title>
      <link href="posts/78ceb386/"/>
      <url>posts/78ceb386/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash">server &#123;    listen       80;    listen       [::]:80;    server_name ~^(?&lt;userName&gt;.*)\.apple\.com\.cn$;    root /export/webapps/apple.com/$userName;    access_log  /var/log/nginx/access.log  main;    #å¼€å¯æµè§ˆå™¨é™æ€æ–‡ä»¶ç¼“å­˜    location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)$ &#123;        expires      3h;    &#125;        # https://&lt;username&gt;.apple.com/api -&gt; /export/webapps/apple.com/api.php #####    location ~* ^/(api|event_api)$ &#123;        root /export/webapps/apple.com;        rewrite ^/(.*)$ /$1.php break;        fastcgi_pass     127.0.0.1:9001;        fastcgi_index    index.php;        include      fastcgi.conf;        fastcgi_connect_timeout    600s;        fastcgi_send_timeout       600s;        fastcgi_read_timeout       600s;        fastcgi_buffers 8 256k;        fastcgi_buffer_size 256k;        fastcgi_busy_buffers_size 256k;        fastcgi_intercept_errors on;    &#125;        # https://&lt;username&gt;.apple.com/&lt;uri&gt; -&gt; /export/webapps/apple.com/&lt;username&gt;/&lt;uri&gt;.php    location ~* ^/[0-9a-zA-Z]+$ &#123;        rewrite ^/(.*)$ /$1.php break;        fastcgi_pass     127.0.0.1:9001;        fastcgi_index    index.php;        include      fastcgi.conf;        fastcgi_connect_timeout    600s;        fastcgi_send_timeout       600s;        fastcgi_read_timeout       600s;        fastcgi_buffers 8 256k;        fastcgi_buffer_size 256k;        fastcgi_busy_buffers_size 256k;        fastcgi_intercept_errors on;    &#125;&#125;</code></pre><blockquote><p>location ä¼˜å…ˆçº§ä»ä¸Šå¾€ä¸‹ä¾æ¬¡é€’å‡ï¼š<br>location =      ä»…åŒ¹é…å­—ç¬¦ä¸²è‡ªèº«<br>location ^~    åŒ¹é…æŸä¸ªå­—ç¬¦ä¸²å¼€å¤´çš„uri<br>location ~      æ­£åˆ™åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™<br>location ~*    æ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™<br>location /      è¡¨ç¤ºåŒ¹é…â€œåŸŸå/ä¹‹åçš„uriâ€ï¼Œå†æ¯”å¦‚localtion /imagesï¼Œè¡¨ç¤ºåŒ¹é…â€œåŸŸå/imagesä¹‹åçš„uri</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlabâ˜å¤§ç‰ˆæœ¬è¿ç§»</title>
      <link href="posts/a38d0013/"/>
      <url>posts/a38d0013/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><ul><li>ç°åœ¨ gitlab å®˜æ–¹åŒ…å‡çº§å¾ˆå®¹æ˜“ï¼Œç›´æ¥ yum ä¹‹ç±»çš„å°±å¯ä»¥ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ç¯‡æ–‡ç« ï¼Œæ˜¯å› ä¸ºæˆ‘è¦ä» v7 å‡çº§åˆ° v11, æ•°æ®åº“ä¹Ÿä» mysql è½¬å˜ä¸ºäº† pgsql;è€Œä¸” v7 å½“æ—¶ç”¨çš„æ˜¯ bitnami å®‰è£…çš„ã€‚æ‰€ä»¥æ— å¥ˆä¹‹ä¸‹ï¼Œå°±å‡†å¤‡ç”¨ api è¿›è¡Œè¿ç§»ï¼Œå› è€Œé—æ¼ä¹‹å¤„æ˜¯è‚¯å®šæœ‰çš„ã€‚</li></ul><h1>æ­£æ–‡</h1><ul><li><p>Tokenå˜é‡å®šä¹‰[Tokenä¸åŒç‰ˆæœ¬è·å–æ–¹å¼ä¸ä¸€æ ·ï¼Œä½†æ˜¯æ€»å½’éƒ½æ˜¯ä»webç”¨æˆ·ç•Œé¢èƒ½ç›´æ¥æ‹¿åˆ°çš„], Tokenéœ€è¦æ˜¯æœ€å¤§æƒé™ç”¨æˆ·ï¼Œä¸”æ‹¥æœ‰æ‰€æœ‰çš„é¡¹ç›®æƒé™</p><pre><code>export OldToken=su2GwpNeVQexport NewToken=yTVZTPeussexport OldDomain=git.a.comexport NewDomain=git.b.com</code></pre><blockquote><p>gitlab ä¸åŒç‰ˆæœ¬çš„ api ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œæœ¬æ–‡æ¡£æ˜¯ä» 7 è¿ç§»åˆ° 11ï¼Œæ‰€ä»¥ api ç‰ˆæœ¬ä¹Ÿæ˜¯ä» v3 åˆ° v4<br>gitlab çš„ api é»˜è®¤ä¸€æ¬¡æœ€å¤šè·å–100æ¡ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œåˆ†é¡µè·å–<br>per_page æ¯é¡µä¿¡æ¯æ¡æ•° page é¡µæ•°<br>æ‰€ä»¥ä¿¡æ¯å¤ªå¤šçš„è‡ªè¡Œåˆ†é¡µå³å¯</p></blockquote></li><li><p>è¿ç§»ç”¨æˆ·</p><blockquote><p>ä¸‹é¢ä»£ç ï¼Œå¹¶ä¸è¿ç§»ç”¨æˆ·çš„å…¬é’¥ä¿¡æ¯</p></blockquote><pre><code>mkdir create_user &amp;&amp; cd create_user;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/users?per_page=100&amp;page=$i&quot; | jq '.[] |.name, .username, .state, .email, .can_create_group, .can_create_project' | sed 'N;N;N;N;N;s#\n# #g;s#&quot;##g';done &gt;&gt; users.list;while read name username state email can_create_group can_create_project;do    curl --header &quot;PRIVATE-TOKEN:$&#123;NewToken&#125;&quot; --data &quot;name=$name&amp;username=$username&amp;password=$&#123;username&#125;@123456&amp;state=$state&amp;email=$email&amp;can_create_group=$can_create_group&amp;can_create_project=$can_create_project&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/users&quot;done &lt; users.listcd ..</code></pre></li><li><p>åˆ›å»ºé¡¹ç›®ç»„</p><pre><code>mkdir create_group &amp;&amp; cd create_group;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/groups?per_page=100&amp;page=$i&quot; | jq '.[] |.name, .path' | sed 'N;s#\n# #;s#&quot;##g';done &gt; group.list;echo 'repo repo' &gt;&gt; group.list;cat group.list | while read name path;do curl --request POST --header &quot;PRIVATE-TOKEN:$&#123;NewToken&#125;&quot; --data &quot;name=$name&amp;path=$path&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/groups&quot;;donecd ..</code></pre></li><li><p>åˆ›å»ºé¡¹ç›®åˆ°å¯¹åº”ç»„</p><pre><code>mkdir create_project &amp;&amp; cd create_project;</code></pre><pre><code>for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/projects?per_page=100&amp;page=$i&quot;  | jq '.[] |.name, .namespace.name, .description' | sed 'N;N;s#\n#\t#g;s# #-#g;s#&quot;##g';done  &gt;&gt; project.list;mv  project.list project.list.tmp;cat project.list.tmp | sort | uniq &gt; project.list;rm -rf project.list.tmp;</code></pre><pre><code># è¿™é‡Œ pre_page ä¸èµ·ä½œç”¨for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/groups?page=$i&quot; | jq '.[] | .id, .name' | sed 'N;s#\n# #g;s#&quot;##g';done &gt;&gt; group.id</code></pre><pre><code>cat project.list | while read projectname groupname des;do    newgroupid=`egrep &quot;\b$&#123;groupname&#125;\b&quot; ./group.id | awk '&#123;print $1&#125;'`    curl --request POST --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot;  --data &quot;name=$&#123;projectname&#125;&amp;namespace_id=$&#123;newgroupid&#125;&amp;description=$des&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/projects&quot;donecd ..</code></pre></li><li><p>æ·»åŠ ç”¨æˆ·åˆ°ç»„</p><pre><code>mkdir add_user_group &amp;&amp; cd add_user_group;</code></pre><pre><code>for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/groups?page=$i&quot; | jq '.[] | .id, .name' | sed 'N;s#\n# #g;s#&quot;##g';done &gt;&gt; group.old.id;cp ../create_project/group.id ./group.new.id;#curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/groups&amp;page=1&quot; | jq '.[] | .id, .name' | sed 'N;s#\n# #g;s#&quot;##g' &gt;&gt; group.new.id;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/users?per_page=100&amp;page=$i&quot;  | jq '.[] | .id,.username' | sed 'N;s#\n# #g;s#&quot;##g';done &gt;&gt; new_user.id;</code></pre><pre><code>cat ./group.old.id | while read groupid groupname;do    curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; http://$&#123;OldDomain&#125;/api/v3/groups/$&#123;groupid&#125;/members | jq '.[] | .id, .username, .access_level' |sed 'N;N;s#\n# #g;s#&quot;##g' | while read nameid username level;do        newid=`egrep &quot;\b$&#123;username&#125;\b&quot; ./new_user.id| awk '&#123;print $1&#125;'`        newgid=`egrep &quot;\b$&#123;groupname&#125;\b&quot; ./group.new.id|awk '&#123;print $1&#125;'`curl --request POST --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; --data &quot;user_id=$&#123;newid&#125;&amp;access_level=$&#123;level&#125;&quot; http://$&#123;NewDomain&#125;/api/v4/groups/$&#123;newgid&#125;/members    donedonecd ..</code></pre></li><li><p>æ·»åŠ ç”¨æˆ·åˆ°é¡¹ç›®</p><pre><code>mkdir add_user_project &amp;&amp; cd add_user_project;</code></pre><pre><code>for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/projects?per_page=100&amp;page=$i&quot;  | jq '.[] |.id, .name, .namespace.name' | sed 'N;N;s#\n# #g;s#&quot;##g';done  &gt;&gt; project.old.id;mv  project.old.id project.old.id.tmp;cat project.old.id.tmp | sort | uniq &gt; project.old.id;rm -rf project.old.id.tmp;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/projects?per_page=100&amp;page=$i&quot;  | jq '.[] |.id, .name, .namespace.name' | sed 'N;N;s#\n# #g;s#&quot;##g';done  &gt;&gt; project.new.id;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/users?per_page=100&amp;page=$i&quot;  | jq '.[] | .id,.username' | sed 'N;s#\n# #g;s#&quot;##g';done &gt;&gt; new_user.id;</code></pre><pre><code>cat ./project.old.id | while read projectid projectname groupname;do    curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; http://$&#123;OldDomain&#125;/api/v3/projects/$&#123;projectid&#125;/members | jq '.[] | .id, .username, .access_level' |sed 'N;N;s#\n# #g;s#&quot;##g' | while read nameid username level;do        newid=`egrep &quot;\b$&#123;username&#125;\b&quot; ./new_user.id| awk '&#123;print $1&#125;'`        newpid=`egrep &quot;\b$&#123;projectname&#125; $&#123;groupname&#125;\b&quot; ./project.new.id|awk '&#123;print $1&#125;'`        #echo &quot;$projectid $projectname $groupname $username &gt; $newpid $projectname $groupname&quot;curl --request POST --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; --data &quot;user_id=$&#123;newid&#125;&amp;access_level=$&#123;level&#125;&quot; http://$&#123;NewDomain&#125;/api/v4/projects/$&#123;newpid&#125;/members    donedonecd ..</code></pre></li><li><p>ä»£ç è¿ç§»</p><pre><code>mkdir sync_code &amp;&amp; cd sync_code;#for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/projects?per_page=100&amp;page=$i&quot;  | jq '.[] |.name, .namespace.name, .description' | sed 'N;N;s#\n#\t#g;s# #-#g;s#&quot;##g';done  &gt;&gt; project.list;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/projects?per_page=100&amp;page=$i&quot; | jq '.[] |.path_with_namespace' | sed 's#&quot;##g';done &gt;&gt; project.path;</code></pre><pre><code># å°†æœ¬ä»£ç æ¡†çš„ä»£ç ä¿å­˜åˆ° start.sh å¹¶æ‰§è¡Œ(ç¡®ä¿sync_code_baseå˜é‡è·¯å¾„å‡†ç¡®)num=1sync_code_base=/export/sync/sync_codenohup while read line;do     echo &quot;$num: -------------------------$line-------------------------&quot; &gt;&gt; $&#123;sync_code_base&#125;/sync.log    [[ -d $&#123;line%%/*&#125; ]] || mkdir $&#123;line%%/*&#125;    cd $&#123;line%%/*&#125;    git clone --mirror git@$&#123;OldDomain&#125;:$&#123;line&#125;.git &gt;&gt; $&#123;sync_code_base&#125;/sync.log 2&gt;&amp;1 || echo &quot;clone:$line&quot; &gt;&gt; $&#123;sync_code_base&#125;/clone_error.log    cd $&#123;line##*/&#125;.git    git remote set-url origin git@$&#123;NewDomain&#125;:$&#123;line&#125;.git    git push -f origin &gt;&gt; $&#123;sync_code_base&#125;/sync.log 2&gt;&amp;1 || echo &quot;sync:$line&quot; &gt;&gt; $&#123;sync_code_base&#125;/sync_error.log    cd /export/sync/sync_code    let num++done &lt; $&#123;sync_code_base&#125;/project.path &amp;</code></pre><pre><code>cd ..</code></pre></li><li><p>åˆå§‹åŒ–æ–°ç”¨æˆ·å¯†ç </p><pre><code>mkdir init_password; cd init_password;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/users?per_page=100&amp;page=$i&quot; |  jq '.[] |.id, .name, .username' |  sed 'N;N;s#\n# #g;s#&quot;##g';done &gt;&gt; user.id;cat user.id | while read id name nameuser;do  curl --request PUT --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; --data &quot;password=$&#123;nameuser&#125;@123&quot; http://$&#123;NewDomain&#125;/api/v4/users/$&#123;id&#125;;donecd ..</code></pre></li><li><p>åŒæ­¥ç”¨æˆ·å…¬é’¥ä¿¡æ¯</p><pre><code>mkdir sync_user_pub &amp;&amp; cd sync_user_pub;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; &quot;http://$&#123;OldDomain&#125;/api/v3/users?per_page=100&amp;page=$i&quot;  |  jq '.[] |.id, .name, .username' |  sed 'N;N;s#\n# #g;s#&quot;##g';done &gt;&gt; old_users.id;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/users?per_page=100&amp;page=$i&quot;  |  jq '.[] |.id, .name, .username' |  sed 'N;N;s#\n# #g;s#&quot;##g';done &gt;&gt; new_users.id;cat old_users.id | while read old_current_id name username;do    new_current_id=`grep $username new_users.id | awk '&#123;print $1&#125;'`    curl -s --header &quot;PRIVATE-TOKEN: $&#123;OldToken&#125;&quot; http://$&#123;OldDomain&#125;/api/v3/users/$&#123;old_current_id&#125;/keys | jq '.[]|.title,.key' | sed 'N;s/\n/\t/;s/&quot;//g' | while read  current_title current_key;do        curl --request POST --header &quot;PRIVATE-TOKEN:$&#123;NewToken&#125;&quot; --data-urlencode &quot;title=$&#123;current_title&#125;&quot; --data-urlencode &quot;key=$&#123;current_key&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/users/$&#123;new_current_id&#125;/keys&quot;    donedone</code></pre></li><li><p>å¦‚æœå‡ºç°pushæ•…éšœï¼Œåˆ™åˆ é™¤æ–°æœåŠ¡å™¨çš„é¡¹ç›®, å¹¶é‡æ–°push</p><pre><code>sync_code_base=/export/sync/sync_codecd $&#123;sync_code_base&#125;# å‡†å¤‡å¥½ delete.path æ–‡ä»¶ï¼Œå†…éƒ¨ä¸€è¡Œä¸€ä¸ª project.path_with_namespacefor i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/projects?per_page=100&amp;page=$i&quot; | jq '.[]|.id, .path_with_namespace'| sed 'N;s#\n#\t#g;s# #-#g;s#&quot;##g';done &gt; project-path-id.allwhile read line;do grep $line project-path-id.all ;done &lt; delete.path &gt; delete.path.idwhile read id path;do curl -s --request DELETE --header &quot;PRIVATE-TOKEN:$&#123;NewToken&#125;&quot; http://$&#123;NewDomain&#125;/api/v4/projects/$&#123;id&#125;;sleep 5;cd $&#123;path&#125;.git;git push -f origin ;cd $&#123;sync_code_base&#125;;done &lt; delete.path.id</code></pre></li><li><p>åˆ é™¤æ–°æœåŠ¡å™¨çš„é¡¹ç›®ç»„</p><pre><code>mkdir delete_group &amp;&amp; cd delete_group;for i in `seq 1 15`;do curl -s --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; &quot;http://$&#123;NewDomain&#125;/api/v4/groups?per_page=100&amp;page=$i&quot; | jq '.[] | .id';done &gt;&gt; group.id;cat group.id | while read id;do curl -s --request DELETE --header &quot;PRIVATE-TOKEN: $&#123;NewToken&#125;&quot; http://$&#123;NewDomain&#125;/api/v4/groups/$&#123;id&#125;;done;</code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> å…¶ä»– </category>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fpmâ˜å®‰è£…-ç¼–è¯‘æ–¹å¼</title>
      <link href="posts/3321a2dc/"/>
      <url>posts/3321a2dc/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ç”¨äºç¼–è¯‘å®‰è£…php7.1</p><h4 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h4><p>æ ¹ç›®å½•ï¼š/usr/local/php<br>æ—¥å¿—ç›®å½•ï¼š/usr/local/php/var/log -&gt; /export/logs/php</p><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><pre><code class="language-bash">#!/bin/bash# è„šæœ¬, é€‚ç”¨äº php 7.1basedir=/usr/local/srccd $basedirrunuser=`whoami`[[ $runuser == 'root' ]] || &#123;        echo &quot;ERROR:æ‰§è¡Œç”¨æˆ·ä¸æ˜¯$runuser&quot; &amp;&amp; exit&#125;#åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒ[[ -d /export/logs/php ]] || &#123;        echo &quot;/export/logs/phpç›®å½•ä¸å­˜åœ¨&quot; &amp;&amp; exit&#125;yum install libmcrypt-devel ncurses-devel recode-devel aspell-devel curl-devel readline-devel openldap-devel enchant-devel pcre-devel net-snmp-devel libicu-devel libtool-ltdl-devel libjpeg-devel libpng-devel libxml2-devel bzip2-devel freetype-devel gcc-c++ mysql-develcp -p /usr/lib64/libldap* /usr/libln -s /usr/lib64/mysql /usr/lib/mysqlwget http://sg2.php.net/distributions/php-7.1.25.tar.gz -O php.tar.gzrm -rf php &amp;&amp; mkdir phptar xf php.tar.gz --strip-components 1 -C phpcd php &amp;&amp; ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-config-file-scan-dir=/usr/local/php/etc/php.d --with-curl --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl --enable-mbstring --with-freetype-dir --with-jpeg-dir --with-png-dir --with-gd --with-libxml-dir --with-zlib --with-mcrypt --with-bz2 --enable-sysvshm --enable-sysvsem --enable-soap --with-recode --with-snmp --with-readline --enable-intl --enable-dba --enable-bcmath --with-enchant --with-pspell --enable-xml --enable-sockets --enable-exif --enable-inline-optimization --enable-fpm || exitmake &amp;&amp; make install || exitcp sapi/fpm/init.d.php-fpm /etc/rc.d/init.d/php-fpmchkconfig --add php-fpmchkconfig php-fpm offchmod u+x /etc/rc.d/init.d/php-fpmcp php.ini-production /usr/local/php/etc/php.inicd /usr/local/php/var &amp;&amp; rm -rf logln -s /export/logs/php logcat&gt;&gt;/usr/local/php/etc/php.ini&lt;&lt;EOF; å…³é—­phpæ— ç”¨æ—¥å¿—ä¿¡æ¯error_reporting = E_COMPILE_ERROR|E_RECOVERABLE_ERROR|E_ERROR|E_CORE_ERROR; å¼€å¯php opcache ç¼“å­˜åŠŸèƒ½[opcache]zend_extension=opcache.so; å¯åŠ¨æ“ä½œç ç¼“å­˜opcache.enable=1; é’ˆå¯¹æ”¯æŒCLIç‰ˆæœ¬PHPå¯åŠ¨æ“ä½œç ç¼“å­˜ ä¸€èˆ¬è¢«ç”¨æ¥æµ‹è¯•å’Œè°ƒè¯•opcache.enable_cli=0; å…±äº«å†…å­˜å¤§å°ï¼Œå•ä½ä¸ºMBopcache.memory_consumption=128; å­˜å‚¨ä¸´æ—¶å­—ç¬¦ä¸²ç¼“å­˜å¤§å°ï¼Œå•ä½ä¸ºMBï¼ŒPHP5.3.0ä»¥å‰ä¼šå¿½ç•¥æ­¤é¡¹é…ç½®opcache.interned_strings_buffer=8; ç¼“å­˜æ–‡ä»¶æ•°æœ€å¤§é™åˆ¶ï¼Œå‘½ä¸­ç‡ä¸åˆ°100%ï¼Œå¯ä»¥è¯•ç€æé«˜è¿™ä¸ªå€¼opcache.max_accelerated_files=4000; ä¸€å®šæ—¶é—´å†…æ£€æŸ¥æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´, è¿™é‡Œè®¾ç½®æ£€æŸ¥çš„æ—¶é—´å‘¨æœŸ, é»˜è®¤ä¸º 2, å•ä½ä¸ºç§’opcache.revalidate_freq=60; å¼€å¯å¿«é€Ÿåœæ­¢ç»­å‘äº‹ä»¶ï¼Œä¾èµ–äºZendå¼•æ“çš„å†…å­˜ç®¡ç†æ¨¡å—ï¼Œä¸€æ¬¡é‡Šæ”¾å…¨éƒ¨è¯·æ±‚å˜é‡çš„å†…å­˜ï¼Œè€Œä¸æ˜¯ä¾æ¬¡é‡Šæ”¾å†…å­˜å—opcache.fast_shutdown=1;å¯ç”¨æ£€æŸ¥ PHP è„šæœ¬å­˜åœ¨æ€§å’Œå¯è¯»æ€§çš„åŠŸèƒ½ï¼Œæ— è®ºæ–‡ä»¶æ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œéƒ½ä¼šæ£€æŸ¥æ“ä½œç ç¼“å­˜,å¯ä»¥æå‡æ€§èƒ½ã€‚ ä½†æ˜¯å¦‚æœç¦ç”¨äº† opcache.validate_timestampsé€‰é¡¹ï¼Œ å¯èƒ½å­˜åœ¨è¿”å›è¿‡æ—¶æ•°æ®çš„é£é™©ã€‚opcache.enable_file_override=1EOFcat&gt;&gt;/usr/local/php/etc/php-fpm.conf&lt;&lt;EOF[global]log_level =errordaemonize = yesevents.mechanism = epollrlimit_files = 10240emergency_restart_threshold = 60emergency_restart_interval = 60s[fcgi]user = webappsgroup = webappslisten = 0.0.0.0:9000pm = staticpm.max_children = 100pm.max_requests = 1024request_slowlog_timeout = 1sslowlog = /usr/local/php/var/log/php-slow.logpm.status_path = /php-fpm_statusEOF</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> fpm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlabâ˜å®‰è£…åŠå¤‡ä»½</title>
      <link href="posts/3f38f454/"/>
      <url>posts/3f38f454/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://docs.gitlab.com/omnibus/docker/">https://docs.gitlab.com/omnibus/docker/</a></p><p><a href="https://hub.docker.com/r/gitlab/gitlab-ce">https://hub.docker.com/r/gitlab/gitlab-ce</a></p><p><a href="https://docs.gitlab.com/14.0/ee/update/index.html#community-to-enterprise-edition">Upgrading GitLab | GitLab</a></p></blockquote><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash"># ç¡®ä¿ /export å­˜åœ¨mkdir -p /export/docker-data-gitlab/&#123;config, logs, data&#125;gitlabtag=# createdomainName=docker pull gitlab/gitlab-ce:$&#123;gitlabtag&#125;docker run --detach   --hostname $&#123;domainName&#125;   --publish 443:443 --publish 80:80 --publish 2222:22   --name gitlab   --restart always   --volume /export/docker-data-gitlab/config:/etc/gitlab   --volume /export/docker-data-gitlab/logs:/var/log/gitlab   --volume /export/docker-data-gitlab/data:/var/opt/gitlab   gitlab/gitlab-ce:$&#123;gitlabtag&#125;# startdocker start gitlab# stopdocker stop gitlab</code></pre><h2 id="åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</h2><pre><code class="language-bash"># configure# https://docs.gitlab.com/omnibus/settings/README.htmlcp /export/docker-data-gitlab/config/gitlab.rb /export/docker-data-gitlab/config/gitlab.rb.bak</code></pre><pre><code class="language-bash">## /export/docker-data-gitlab/config/gitlab.rb# å†³å®šå„ä¸ªä½ç½® url é“¾æ¥å†…å®¹external_url 'http://$&#123;domainName&#125;'# å†³å®šå„ä¸ªä½ç½® ssh é“¾æ¥å†…å®¹gitlab_rails['gitlab_shell_ssh_port'] = 2222gitlab_rails['gitlab_email_enabled'] = truegitlab_rails['gitlab_email_from'] = 'ew@xxx.com'gitlab_rails['gitlab_email_display_name'] = 'GitLab Admin'gitlab_rails['gitlab_email_reply_to'] = 'ew@xxx.com'gitlab_rails['gitlab_email_subject_suffix'] = 'GitLab'gitlab_rails['smtp_enable'] = truegitlab_rails['smtp_address'] = &quot;smtp.gmail.com&quot;gitlab_rails['smtp_port'] = 587gitlab_rails['smtp_user_name'] = &quot;ew@xxx.com&quot;gitlab_rails['smtp_password'] = &quot;&quot;gitlab_rails['smtp_domain'] = &quot;smtp.gmail.com&quot;gitlab_rails['smtp_authentication'] = &quot;login&quot;gitlab_rails['smtp_enable_starttls_auto'] = truegitlab_rails['smtp_tls'] = falsegitlab_rails['smtp_openssl_verify_mode'] = 'peer'</code></pre><h2 id="å¤‡ä»½é…ç½®">å¤‡ä»½é…ç½®</h2><p>å¤‡ä»½åˆ°AWS-S3ï¼Œrole æˆæƒ</p><pre><code class="language-bash">## /export/docker-data-gitlab/config/gitlab.rbgitlab_rails['backup_upload_connection'] = &#123;  'provider' =&gt; 'AWS',  'region' =&gt; '&lt;region-id&gt;',  #'aws_access_key_id' =&gt; 'AKIAKIAKI',  #'aws_secret_access_key' =&gt; 'secret123'  # If using an IAM Profile, don't configure aws_access_key_id &amp; aws_secret_access_key  'use_iam_profile' =&gt; true&#125;# å¤‡ä»½åˆ°S3ä¸Šçš„æ ¹è·¯å¾„ bucket/Path gitlab_rails['backup_upload_remote_directory'] = '&lt;æ¡¶å&gt;/backup/gitlab'</code></pre><pre><code class="language-json"># s3ç­–ç•¥&#123;    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Sid&quot;: &quot;VisualEditor0&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;s3:PutObject&quot;,                &quot;s3:GetObject&quot;,                &quot;s3:ListBucket&quot;            ],            &quot;Resource&quot;: [                &quot;arn:aws:s3:::&lt;æ¡¶å&gt;&quot;,                &quot;arn:aws:s3:::&lt;æ¡¶å&gt;/backup/gitlab/*&quot;            ]        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor1&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:ListAllMyBuckets&quot;,            &quot;Resource&quot;: &quot;*&quot;        &#125;    ]&#125;</code></pre><p>å¤‡ä»½åˆ°é˜¿é‡Œäº‘-OSSï¼ŒAKæˆæƒï¼Œæš‚ä¸æ”¯æŒ role æˆæƒ</p><pre><code class="language-bash">## /export/docker-data-gitlab/config/gitlab.rbgitlab_rails['backup_upload_connection'] = &#123;'provider' =&gt; 'aliyun','aliyun_accesskey_id' =&gt; 'AK123','aliyun_accesskey_secret' =&gt; 'secret123','aliyun_oss_bucket' =&gt; '&lt;æ¡¶å&gt;','aliyun_region_id' =&gt; '&lt;region-id&gt;','aliyun_oss_endpoint' =&gt; 'http://oss-&lt;region-id&gt;-internal.aliyuncs.com'&#125;gitlab_rails['backup_upload_remote_directory'] = 'backup/gitlab'</code></pre><p>âš ï¸</p><blockquote><h3 id="éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆªæ­¢-fog-aliyun-0-3-19-ç‰ˆæœ¬ï¼Œaliyun-oss-endpoint-æŒ‡å®šå†…ç½‘åœ°å€çš„æ—¶å€™ï¼Œä¾ç„¶èµ°çš„æ˜¯å…¬ç½‘çš„-endpointï¼Œä¼šæ¶ˆè€—å…¬ç½‘æµé‡">éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆªæ­¢ fog-aliyun: 0.3.19 ç‰ˆæœ¬ï¼Œaliyun_oss_endpoint æŒ‡å®šå†…ç½‘åœ°å€çš„æ—¶å€™ï¼Œä¾ç„¶èµ°çš„æ˜¯å…¬ç½‘çš„ endpointï¼Œä¼šæ¶ˆè€—å…¬ç½‘æµé‡</h3><p><a href="https://gitlab.com/gitlab-org/gitlab/-/blob/da46c9655962df7d49caef0e2b9f6bbe88462a02/Gemfile#L122">https://gitlab.com/gitlab-org/gitlab/-/blob/da46c9655962df7d49caef0e2b9f6bbe88462a02/Gemfile#L122</a><br><a href="https://rubygems.org/gems/fog-aliyun">https://rubygems.org/gems/fog-aliyun</a></p></blockquote><pre><code class="language-json">&#123;    &quot;Version&quot;: &quot;1&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;oss:*&quot;            ],            &quot;Resource&quot;: [                &quot;acs:oss:*:*:&lt;æ¡¶å&gt;/backup/gitlab/*&quot;            ]        &#125;,        &#123;            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;oss:Get*&quot;,                &quot;oss:List*&quot;            ],            &quot;Resource&quot;: &quot;*&quot;        &#125;    ]&#125;</code></pre><h2 id="å¤‡ä»½è®¡åˆ’ï¼Œè§¦å‘å¤‡ä»½">å¤‡ä»½è®¡åˆ’ï¼Œè§¦å‘å¤‡ä»½</h2><ol><li>é˜¿é‡Œäº‘ ï¼ˆroleæˆæƒï¼‰</li></ol><pre><code class="language-bash"># é…ç½® role åˆ°æœåŠ¡å™¨ä¸Šcat &gt; /etc/profile.d/ecs_role.sh &lt;&lt; EOFRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`ramRoleName=`curl -sq http://100.100.100.200/latest/meta-data/ram/security-credentials/`aliyun configure set --profile ecsRamRoleProfile  --mode EcsRamRole --ram-role-name $&#123;ramRoleName&#125; --region $&#123;Region&#125;EOF</code></pre><p>æ·»åŠ è„šæœ¬åˆ°crontab</p><pre><code class="language-bash">#!/bin/bashsource /etc/profile.d/ecs_role.shRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`Endpoint=&quot;http://oss-$&#123;Region&#125;-internal.aliyuncs.com&quot;basedir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`cd $basedirTime=`date +%Y%m%d`docker exec -t gitlab gitlab-backup createtar zcf $&#123;Time&#125;.config.tar.gz /export/docker-data-gitlab/configaliyun oss cp $&#123;Time&#125;.config.tar.gz oss://æ¡¶å/backup/gitlab/ -e $&#123;Endpoint&#125; --force</code></pre><ol start="2"><li><p>aws (roleæˆæƒ)</p><p>æ·»åŠ è„šæœ¬åˆ°crontab</p></li></ol><pre><code class="language-bash">#!/bin/bashbasedir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`cd $basedirTime=`date +%Y%m%d`docker exec -t gitlab gitlab-backup createtar zcf $&#123;Time&#125;.config.tar.gz /export/docker-data-gitlab/configaws s3 cp $&#123;Time&#125;.config.tar.gz s3://æ¡¶å/backup/gitlab/</code></pre><h2 id="é‡è½½é…ç½®æœåŠ¡">é‡è½½é…ç½®æœåŠ¡</h2><p>docker exec -it gitlab gitlab-ctl reconfigure</p><h2 id="å‡çº§">å‡çº§</h2><blockquote><p>å¤§ç‰ˆæœ¬å‡çº§å¯èƒ½å¤±è´¥ï¼Œç‰¹åˆ«æ˜¯æ•°æ®åº“ä¹Ÿå‡çº§çš„æƒ…å†µä¸‹</p></blockquote><pre><code class="language-bash">docker stop gitlabdocker rm gitlabgitlabtag=domainName=docker pull gitlab/gitlab-ce:$&#123;gitlabtag&#125;docker run --detach --hostname $&#123;domainName&#125;  --publish 443:443 --publish 80:80 --publish 2222:22   --name gitlab   --restart always   --volume /export/docker-data-gitlab/config:/etc/gitlab   --volume /export/docker-data-gitlab/logs:/var/log/gitlab   --volume /export/docker-data-gitlab/data:/var/opt/gitlab   gitlab/gitlab-ce:$&#123;gitlabtag&#125;</code></pre><h2 id="Oauth">Oauth</h2><p><a href="https://docs.gitlab.com/ee/administration/auth/README.html">GitLab authentication and authorization | GitLab</a></p><h2 id="å¤§é—®é¢˜">å¤§é—®é¢˜</h2><p>æš‚æ— </p><h2 id="å…¶å®ƒ">å…¶å®ƒ</h2><p>è‹¥æ²¡æœ‰ç›´æ¥é‡‡ç”¨ossä½œä¸ºå­˜å‚¨è·¯å¾„ï¼Œå³æœ¬åœ°å‹ç¼©åï¼Œå†ç”¨è„šæœ¬ä¸Šä¼ </p><pre><code class="language-bash">#!/bin/bashbasedir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`# ç¡®å®šgitlabå¤‡ä»½æ–‡ä»¶åœ°å€mv /path/to/backup/*backup.tar $&#123;basedir&#125;/ls $&#123;basedir&#125;/*.tar | awk -F '/|_' '&#123;print $4&#125;' | while read line;do        Old7day=`date -d &quot;-7 days&quot; &quot;+%s&quot;`        if [ $line -lt $Old7day ];then              rm -rf $&#123;basedir&#125;/$&#123;line&#125;*.tar &amp;&amp; echo &quot;Delete old7day file $&#123;basedir&#125;/$&#123;line&#125;*.tar&quot;        fidonecd ~ &amp;&amp; source $&#123;basedir&#125;/role.confRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`Endpoint=&quot;http://oss-$&#123;Region&#125;-internal.aliyuncs.com&quot;BucketName=&lt;å­˜å‚¨æ¡¶&gt;echo &quot;Start: `date &quot;+%Y%m%d %H%M%S&quot;` --&gt; oss://$&#123;BucketName&#125;/backup/&quot;aliyun oss sync $&#123;basedir&#125;/ oss://$&#123;BucketName&#125;/backup/ --exclude='*.log' --update --delete --force -e $&#123;Endpoint&#125; --checkpoint-dir=/tmp/ossutil_checkpoint --output-dir=/tmp/ossutil_outputecho &quot;End: `date &quot;+%Y%m%d %H%M%S&quot;` --&gt; oss://$&#123;BucketName&#125;/backup/&quot;</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜EC2-GPUå®ä¾‹å®‰è£…æ˜¾å¡é©±åŠ¨</title>
      <link href="posts/2e07203a/"/>
      <url>posts/2e07203a/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥ä¸‹å‘½ä»¤å‡åœ¨ ubuntu ç”¨æˆ·ä¸­æ‰§è¡Œ</p></blockquote><h2 id="å®‰è£…-awscli-åˆ°-ubuntu-ç”¨æˆ·ä¸‹">å®‰è£… awscli åˆ° ubuntu ç”¨æˆ·ä¸‹</h2><pre><code class="language-bash:">sudo apt-get update -ysudo apt-get install python3-pip -ypip3 install awscli --upgrade --user</code></pre><h2 id="æ›´æ–°ç³»ç»Ÿå†…æ ¸å’Œgccï¼Œä»¥åŠç¦ç”¨å¼€æºé©±åŠ¨">æ›´æ–°ç³»ç»Ÿå†…æ ¸å’Œgccï¼Œä»¥åŠç¦ç”¨å¼€æºé©±åŠ¨</h2><pre><code class="language-bash:">sudo apt-get upgrade -y linux-awssudo rebootsudo apt-get install -y gcc make linux-headers-$(uname -r)cat &lt;&lt; EOF | sudo tee --append /etc/modprobe.d/blacklist.confblacklist vga16fbblacklist nouveaublacklist rivafbblacklist nvidiafbblacklist rivatvEOFsudo vi /etc/default/grub     GRUB_CMDLINE_LINUX=&quot;rdblacklist=nouveau&quot;sudo update-grubsudo reboot</code></pre><h2 id="é…ç½®-aws-key-æ‹‰å–-G3-ç³»åˆ—é©±åŠ¨">é…ç½® aws key æ‹‰å– G3 ç³»åˆ—é©±åŠ¨</h2><pre><code class="language-bash:">aws configure# æ ¹æ®æç¤ºè¾“å…¥ç›¸å…³æ•°æ®ï¼Œè¿™é‡Œ aws key å¯ä»¥ç”¨ä»»æ„ iam ç”¨æˆ·çš„</code></pre><h2 id="ä¸‹è½½-G3-é©±åŠ¨">ä¸‹è½½ G3 é©±åŠ¨</h2><pre><code class="language-bash:"># G3å®ä¾‹ç›´æ¥ä»awsåº“é‡Œä¸‹è½½ï¼Œå…¶å®ƒéœ€è¦è‡ªè¡Œå»å®˜ç½‘ä¸‹è½½https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/install-nvidia-driver.html#obtain-nvidia-GRID-driver-linuxaws s3 cp --recursive s3://ec2-linux-nvidia-drivers/latest/ .</code></pre><h2 id="å®‰è£…é©±åŠ¨">å®‰è£…é©±åŠ¨</h2><pre><code class="language-bash:">sudo /bin/sh ./NVIDIA-Linux-x86_64*.run# å¯èƒ½ä¼šå‡ºç° gcc ç‰ˆæœ¬æ£€æµ‹ï¼Œå¿½ç•¥æ‰ç‰ˆæœ¬æ£€æµ‹ï¼Œç›´æ¥å®‰è£…sudo reboot</code></pre><h2 id="å¯ç”¨-GRUD-è™šæ‹Ÿåº”ç”¨ç¨‹åºï¼Œé»˜è®¤å¯ç”¨-GRUD-è™šæ‹Ÿå·¥ä½œç«™">å¯ç”¨ GRUD è™šæ‹Ÿåº”ç”¨ç¨‹åºï¼Œé»˜è®¤å¯ç”¨ GRUD è™šæ‹Ÿå·¥ä½œç«™</h2><pre><code class="language-bash:"># å…·ä½“æ­¥éª¤çœ‹æ–‡æ¡£https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/activate_grid.html</code></pre><h2 id="ä¼˜åŒ–G3ï¼Œå¼€å¯å…¨åŠŸç‡ï¼Œå…³é—­autoboost-ï¼ˆP3-å®ä¾‹ä¸Šçš„-GPU-ä¸æ”¯æŒ-autoboost-åŠŸèƒ½ã€‚ï¼‰">ä¼˜åŒ–G3ï¼Œå¼€å¯å…¨åŠŸç‡ï¼Œå…³é—­autoboost ï¼ˆP3 å®ä¾‹ä¸Šçš„ GPU ä¸æ”¯æŒ autoboost åŠŸèƒ½ã€‚ï¼‰</h2><pre><code class="language-bash:">sudo nvidia-persistencedsudo nvidia-smi --auto-boost-default=0# P2 å®ä¾‹ï¼šsudo nvidia-smi -ac 2505,875# P3 å®ä¾‹ï¼šsudo nvidia-smi -ac 877,1530# G3 å®ä¾‹ï¼šsudo nvidia-smi -ac 2505,1177</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aws </tag>
            
            <tag> ubuntu </tag>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fpmâ˜é™æ€é…ç½®</title>
      <link href="posts/d1d65c30/"/>
      <url>posts/d1d65c30/</url>
      
        <content type="html"><![CDATA[<blockquote><p>QPS 800-1000</p><p>2*4 æœºå™¨</p></blockquote><pre><code class="language-ini">[www01]user = webappsgroup = webappslisten = /usr/local/php/var/log/php-fpm-www01.socklisten.owner = webappslisten.group = webappslisten.backlog = 10240listen.mode = 0666listen.allowed_clients = 127.0.0.1pm = staticpm.max_children = 300pm.max_requests = 1024request_slowlog_timeout = 1request_terminate_timeout = 1slowlog = /usr/local/php/var/log/php-slow.logpm.status_path = /php-fpm_status</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> fpm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php-fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜é—®é¢˜é›†</title>
      <link href="posts/6332ca50/"/>
      <url>posts/6332ca50/</url>
      
        <content type="html"><![CDATA[<h2 id="upstream-prematurely-closed-connection-while-reading-response-header-from-upstream">upstream prematurely closed connection while reading response header from upstream</h2><p>æ±‰è¯‘ï¼šå½“ä»ä¸Šæ¸¸è¯»å–å“åº”å¤´æ—¶ï¼Œä¸Šæ¸¸æå‰å…³é—­è¿æ¥</p><p>ç»ç¡®è®¤ï¼Œæ­¤é”™è¯¯ä¸€èˆ¬æ˜¯å¼€å¯é•¿é“¾æ¥åï¼Œé•¿é“¾æ¥è¶…æ—¶å…³é—­æ—¶ï¼Œæ°å¥½æœ‰æ•°æ®å‘ç”Ÿ</p><p>å› æ­¤ï¼Œè§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ªï¼š</p><ol><li>nginx å°†é•¿é“¾æ¥çš„è¶…æ—¶è®¾ç½®ä¸º 0 ï¼Œå³å…³é—­é•¿é“¾æ¥</li></ol><pre><code class="language-bash">keepalive_timeout 0; # æ­¤å€¼é»˜è®¤ä¸º0ï¼Œé»˜è®¤ä½äºnginxä¸»é…ç½®</code></pre><ol start="2"><li>å…³é—­ nginx é•¿é“¾æ¥è¶…æ—¶ä¸»åŠ¨å…³é—­çš„åŠŸèƒ½</li></ol><pre><code class="language-bash">proxy_http_version 1.1; # æ”¯æŒé•¿é“¾æ¥proxy_set_header Connection &quot;&quot;; # nginxä¸ä¼šä¸»åŠ¨å…³é—­é•¿è¿æ¥ï¼Œæ­¤å€¼é»˜è®¤æ˜¯ close</code></pre><blockquote><p>nginx æ·»åŠ è‡ªå®šä¹‰ header åï¼Œå°±ä¼šè¦†ç›–æ‰ç›¸åº”çš„é»˜è®¤å€¼</p><p><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header">Module ngx_http_proxy_module (nginx.org)</a></p><table><thead><tr><th style="text-align:left">Syntax:</th><th><code>proxy_set_header field value;</code></th></tr></thead><tbody><tr><td style="text-align:left">Default:</td><td><code>proxy_set_header Host $proxy_host; proxy_set_header Connection close;</code></td></tr><tr><td style="text-align:left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table></blockquote>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openvpnâ˜å®‰è£…</title>
      <link href="posts/7c1abbe1/"/>
      <url>posts/7c1abbe1/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>openvpn ä¸€èˆ¬ç”¨äºå°å…¬å¸è¿œç¨‹è¿æ¥å…¬å¸åŠå…¬ç½‘ç»œç¯å¢ƒï¼Œæ­¤è„šæœ¬éœ€è¦ä¸€ä¸ªlinuxç³»ç»Ÿçš„ä¸»æœºã€‚<br>è‡³äºåœŸè±ªå…¬å¸ï¼Œå¯ä»¥æ— è§†ã€‚<br>æ–‡æ¡£åŒ…å«å®‰è£…è„šæœ¬ï¼Œåˆ›å»ºç”¨æˆ·è„šæœ¬ï¼Œåˆ é™¤ç”¨æˆ·è„šæœ¬ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œå®‰è£…è„šæœ¬å’Œåˆ›å»ºç”¨æˆ·è„šæœ¬ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹ä¸€äº›å˜é‡ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‘ç°ç§»åŠ¨ç½‘ç»œè¿æ¥å…¶å®ƒè¿è¥å•†ç½‘ç»œçš„æ—¶å€™ï¼Œä¸ç¨³å®šã€‚<br>æ¯”å¦‚æˆ‘è¿™è¾¹ï¼Œç§»åŠ¨ç½‘ç»œè¿æ¥ç”µä¿¡ç½‘ç»œï¼ˆopenvpnæ‰€åœ¨ç½‘ç»œï¼‰ï¼Œå°±å®¹æ˜“ä¸¢åŒ…ã€‚</p></blockquote><h2 id="å®‰è£…">å®‰è£…</h2><p>ğŸ’¥ä»¥ä¸‹å‘½ä»¤éœ€é€è¡Œæ‰§è¡Œï¼Œä¸èƒ½å¤åˆ¶æ‰¹é‡æ‰§è¡Œï¼Œå› ä¸ºä¸­é—´éœ€è¦è‡ªè¡Œæ·»åŠ å˜é‡ï¼Œä»¥åŠæ‰‹åŠ¨è¾“å…¥ä¸€äº›ä¿¡æ¯</p><pre><code class="language-bash:">yum install dockerdocker pull kylemanna/openvpnOVPN_DATA=&quot;/root/ovpn-data&quot;IP=&quot;æœåŠ¡å™¨ä¸»ç½‘å¡ip&quot;  # è‡ªè¡Œä¿®æ”¹PORT=  # å®¹å™¨æ˜ å°„çš„å®¿ä¸»æœºç«¯å£mkdir $&#123;OVPN_DATA&#125;docker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u tcp://$&#123;IP&#125;docker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpkidocker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full CLIENTNAME nopassdocker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient CLIENTNAME &gt; $&#123;OVPN_DATA&#125;/CLIENTNAME.ovpndocker run --name openvpn -v $&#123;OVPN_DATA&#125;:/etc/openvpn -d -p $&#123;PORT&#125;:1194 --privileged kylemanna/openvpn</code></pre><h2 id="å®¹å™¨ç”Ÿæˆçš„æœåŠ¡å™¨ä¸»é…ç½®">å®¹å™¨ç”Ÿæˆçš„æœåŠ¡å™¨ä¸»é…ç½®</h2><p>/root/ovpn-data/openvpn.conf</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ”¹åçš„ç¤ºä¾‹é…ç½®</p><pre><code class="language-bash">server 192.168.255.0 255.255.255.0verb 3# å˜æ›´ä¸ºå®¹å™¨é‡Œé»˜è®¤ç”Ÿæˆçš„key /etc/openvpn/pki/private/&lt;ä¿®æ”¹æˆ‘&gt;.keyca /etc/openvpn/pki/ca.crt# å˜æ›´ä¸ºå®¹å™¨é‡Œé»˜è®¤ç”Ÿæˆçš„cert /etc/openvpn/pki/issued/&lt;ä¿®æ”¹æˆ‘&gt;.crtdh /etc/openvpn/pki/dh.pemtls-auth /etc/openvpn/pki/ta.keykey-direction 0keepalive 10 60persist-keypersist-tunproto tcp# Rely on Docker to do port mapping, internally always 1194port 1194dev tun0status /tmp/openvpn-status.loguser nobodygroup nogroupcomp-lzo no### Route Configurations Belowroute 192.168.254.0 255.255.255.0### Push Configurations Belowpush &quot;block-outside-dns&quot;push &quot;comp-lzo no&quot;### å¼€å¯ DNS æ¨é€push &quot;dhcp-option DNS 223.5.5.5&quot;push &quot;dhcp-option DNS 114.114.114.114&quot;### æ·»åŠ  DNS çš„è·¯ç”±push &quot;route 223.5.5.5 255.255.255.255&quot;push &quot;route 114.114.114.114 255.255.255.255&quot;### æ·»åŠ å®¢æˆ·ç«¯éœ€è¦é€šè¿‡openvpnè®¿é—®çš„ç½‘ç»œpush &quot;route 10.100.0.0 255.255.0.0&quot;</code></pre><h3 id="æœåŠ¡ç«¯dnsæ¨é€ä¸å®¢æˆ·ç«¯å…¨å±€è·¯ç”±çš„å…³ç³»">æœåŠ¡ç«¯dnsæ¨é€ä¸å®¢æˆ·ç«¯å…¨å±€è·¯ç”±çš„å…³ç³»</h3><p>å¦‚æœå®¢æˆ·ç«¯åˆ é™¤äº†å…¨å±€è·¯ç”± redirect-gateway def1ï¼›åˆ™æœåŠ¡ç«¯è¦ä¹ˆå…³é—­ dns æ¨é€ï¼Œè¦ä¹ˆå¼€å¯ dns æ¨é€çš„åŒæ—¶ï¼Œå¼€å¯ dns çš„ç›¸å…³è·¯ç”±ã€‚</p><p>å¦‚æœå®¢æˆ·ç«¯å¼€å¯äº†å…¨å±€è·¯ç”± redirect-gateway def1ï¼›åˆ™æœåŠ¡ç«¯æœ€å¥½å¼€å¯ dns æ¨é€ï¼Œä½†æ— éœ€å¼€å¯ dns è·¯ç”±ã€‚</p><h3 id="ç¤ºä¾‹ï¼Œå®¢æˆ·ä»…éƒ¨åˆ†ç½‘ç»œéœ€è¦èµ°openvpnï¼Œå…¶ä½™ç½‘ç»œèµ°æœ¬åœ°ï¼Œä¸”éœ€è¦é€šè¿‡å…¬å¸dnsè§£æåŸŸåã€‚">ç¤ºä¾‹ï¼Œå®¢æˆ·ä»…éƒ¨åˆ†ç½‘ç»œéœ€è¦èµ°openvpnï¼Œå…¶ä½™ç½‘ç»œèµ°æœ¬åœ°ï¼Œä¸”éœ€è¦é€šè¿‡å…¬å¸dnsè§£æåŸŸåã€‚</h3><p>æœåŠ¡ç«¯é…ç½®ï¼šå¼€å¯ dns æ¨é€å’Œ dns è·¯ç”±</p><pre><code class="language-bash">push &quot;dhcp-option DNS å…¬å¸dnsåœ°å€&quot;push &quot;dhcp-option DNS 114.114.114.114&quot;push &quot;route å…¬å¸dnsåœ°å€ 255.255.255.255&quot;push &quot;route 114.114.114.114 255.255.255.255&quot;push &quot;route éœ€è¦èµ°openvpnçš„ç½‘æ®µå’Œæ©ç &quot;</code></pre><p>å®¢æˆ·ç«¯é…ç½®ï¼šå…³é—­å…¨å±€è·¯ç”±</p><pre><code class="language-bash"># redirect-gateway def1</code></pre><h2 id="åˆ›å»ºç”¨æˆ·è„šæœ¬">åˆ›å»ºç”¨æˆ·è„šæœ¬</h2><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸‹åˆ—è„šæœ¬ä¸­ï¼Œæ˜¯éœ€è¦è‡ªè¡Œä¿®æ”¹ipçš„ã€‚</p></blockquote><pre><code class="language-bash:">#!/bin/bash# å¦‚æœæ˜¯natåçš„å†…ç½‘ipï¼Œåˆ™éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œçš„ipä¸ºå¤–ç½‘ip# bash xxx.sh &lt;ç”¨æˆ·å&gt;[[ -z $1 ]] &amp;&amp; exitCLIENTNAME=$1OVPN_DATA=&quot;/root/ovpn-data&quot;docker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full $&#123;CLIENTNAME&#125; nopassdocker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient $CLIENTNAME &gt; $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i '1a comp-lzo' $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i '2a tun-mtu 1500' $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i '3a auth-nocache' $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i &quot;s/1194/&lt;å¤–ç½‘ç«¯å£&gt;/&quot; $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpn # ä¿®æ”¹æˆ‘sed -i &quot;s/&lt;æœåŠ¡å™¨å†…ç½‘IP&gt;/&lt;å®¢æˆ·ç«¯è¿æ¥çš„å¤–ç½‘IP&gt;/&quot; $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpn  # ä¿®æ”¹æˆ‘read -p 'æ˜¯å¦å…³é—­å…¨å±€è·¯ç”±ï¼Œï¼ˆyï¼‰å…³é—­å…¨å±€è·¯ç”±ï¼Œä»…å½“å®¢æˆ·ç«¯åŒ¹é…ä¸‹å‘è·¯ç”±æ—¶æ‰èµ°openvpn.[ç¡®ä¿æœåŠ¡ç«¯æ²¡æœ‰å¼€å¯DNSæ¨é€ï¼Œè‹¥å¼€å¯åˆ™æ·»åŠ å¯¹åº”çš„DNSè·¯ç”±]ï¼›ï¼ˆnï¼‰å¼€å¯&gt;å…¨å±€è·¯ç”±ï¼Œå®¢æˆ·ç«¯æ‰€æœ‰æµé‡å‡èµ°openvpn.[ç¡®ä¿æœåŠ¡ç«¯å¼€å¯äº†DNSæ¨é€]ï¼š' yn[[ $yn == 'y' ]] &amp;&amp; sed -i '/redirect-gateway def1/d' $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnmkdir -pv $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;mv /root/ovpn-data/pki/private/$&#123;CLIENTNAME&#125;.key $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;mv /root/ovpn-data/pki/issued/$&#123;CLIENTNAME&#125;.crt $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;mv $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpn $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;cd $&#123;OVPN_DATA&#125;/users/tar zcf $&#123;CLIENTNAME&#125;.tar.gz $&#123;CLIENTNAME&#125;echo &quot;`pwd`/$&#123;CLIENTNAME&#125;.tar.gz&quot;echo &quot;################################################&quot;cat $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;/$&#123;CLIENTNAME&#125;.ovpn#sz $&#123;CLIENTNAME&#125;.tar.gz</code></pre><h2 id="åˆ é™¤ç”¨æˆ·è„šæœ¬">åˆ é™¤ç”¨æˆ·è„šæœ¬</h2><pre><code class="language-bash:">#!/bin/bash# bash xxx.sh &lt;ç”¨æˆ·å&gt;[[ -z $1 ]] &amp;&amp; exitCLIENTNAME=$1#read -p 'è¾“å…¥ç”¨æˆ·åï¼ˆå­—æ¯ç»„æˆï¼‰:' CLIENTNAMEOVPN_DATA=&quot;/root/ovpn-data&quot;rm -rf /root/ovpn-data/pki/private/$&#123;CLIENTNAME&#125;.key*rm -rf /root/ovpn-data/pki/reqs/$&#123;CLIENTNAME&#125;.reqrm -rf /root/ovpn-data/pki/issued/$&#123;CLIENTNAME&#125;.crtsed -i &quot;/$&#123;CLIENTNAME&#125;/d&quot; /root/ovpn-data/pki/index.txtcd /root/ovpn-data/usersrm -rf $&#123;CLIENTNAME&#125;rm -f $&#123;CLIENTNAME&#125;.tar.gz</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> openvpn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜è°ƒæ•´å†…æ ¸å‚æ•°</title>
      <link href="posts/28361833/"/>
      <url>posts/28361833/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>redis å†…å­˜å ç”¨çˆ†ç‚¸. æ‰€ä»¥ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ª</p><pre><code class="language-python"># encoding: utf-8&quot;&quot;&quot;author: yangyi@youzan.comtime: 2018/4/26 ä¸‹åˆ4:34func: è·å–æ•°æ®åº“ä¸­æ²¡æœ‰è®¾ç½®ttlçš„ key&quot;&quot;&quot;import redisimport argparseimport timeimport sysclass ShowProcess:    &quot;&quot;&quot;    æ˜¾ç¤ºå¤„ç†è¿›åº¦çš„ç±»    è°ƒç”¨è¯¥ç±»ç›¸å…³å‡½æ•°å³å¯å®ç°å¤„ç†è¿›åº¦çš„æ˜¾ç¤º    &quot;&quot;&quot;    i = 0 # å½“å‰çš„å¤„ç†è¿›åº¦    max_steps = 0 # æ€»å…±éœ€è¦å¤„ç†çš„æ¬¡æ•°    max_arrow = 100 # è¿›åº¦æ¡çš„é•¿åº¦    # åˆå§‹åŒ–å‡½æ•°ï¼Œéœ€è¦çŸ¥é“æ€»å…±çš„å¤„ç†æ¬¡æ•°    def __init__(self, max_steps):        self.max_steps = max_steps        self.i = 0    # æ˜¾ç¤ºå‡½æ•°ï¼Œæ ¹æ®å½“å‰çš„å¤„ç†è¿›åº¦iæ˜¾ç¤ºè¿›åº¦    # æ•ˆæœä¸º[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]100.00%    def show_process(self, i = None):        if i is not None:            self.i = i        else:            self.i += 1        num_arrow = int(self.i * self.max_arrow / self.max_steps) # è®¡ç®—æ˜¾ç¤ºå¤šå°‘ä¸ª'&gt;'        num_line = self.max_arrow - num_arrow # è®¡ç®—æ˜¾ç¤ºå¤šå°‘ä¸ª'-'        percent = self.i * 100.0 / self.max_steps # è®¡ç®—å®Œæˆè¿›åº¦ï¼Œæ ¼å¼ä¸ºxx.xx%        process_bar = '[' + '&gt;' * num_arrow + ' ' * num_line + ']'\                      + '%.2f' % percent + '%' + '\r' # å¸¦è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼Œ'\r'è¡¨ç¤ºä¸æ¢è¡Œå›åˆ°æœ€å·¦è¾¹        sys.stdout.write(process_bar) # è¿™ä¸¤å¥æ‰“å°å­—ç¬¦åˆ°ç»ˆç«¯        sys.stdout.flush()    def close(self, words='done'):        print ''        print words        self.i = 0def check_ttl(redis_conn, no_ttl_file, dbindex):    start_time = time.time()    no_ttl_num = 0    keys_num = redis_conn.dbsize()    print &quot;there are &#123;num&#125; keys in db &#123;index&#125; &quot;.format(num=keys_num, index=dbindex)    process_bar = ShowProcess(keys_num)    with open(no_ttl_file, 'a') as f:        for key in redis_conn.scan_iter(count=1000):            process_bar.show_process()            if redis_conn.ttl(key) == -1:                no_ttl_num += 1    #            if no_ttl_num &lt; 1000:                f.write(key+'\n')            else:                continue    process_bar.close()    print &quot;cost time(s):&quot;, time.time() - start_time    print &quot;no ttl keys number:&quot;, no_ttl_num    print &quot;we write keys with no ttl to the file: %s&quot; % no_ttl_filedef main():    parser = argparse.ArgumentParser()    parser.add_argument('-p', type=int, dest='port', action='store', help='port of redis ')    parser.add_argument('-d', type=str, dest='db_list', action='store', default=0,                        help='ex : -d all / -d 1,2,3,4 ')    args = parser.parse_args()    port = args.port    if args.db_list == 'all':        db_list = [i for i in xrange(0, 16)]    else:        db_list = [int(i) for i in args.db_list.split(',')]    for index in db_list:        try:            pool = redis.ConnectionPool(host='127.0.0.1', port=port, db=index)            r = redis.StrictRedis(connection_pool=pool)        except redis.exceptions.ConnectionError as e:            print e        else:            no_ttl_keys_file = &quot;/tmp/&#123;port&#125;_&#123;db&#125;_no_ttl_keys.txt&quot;.format(port=port, db=index)            check_ttl(r, no_ttl_keys_file, index)if __name__ == '__main__':    main()</code></pre><ol><li>è¯·å‹¿åœ¨redisæœåŠ¡å™¨ä¸Šæ‰§è¡Œ</li><li>ä¿®æ”¹è„šæœ¬ä¸­ 127.0.0.1 ä¸º redis æœåŠ¡å™¨åœ°å€</li><li>è„šæœ¬æ‰§è¡Œå‘½ä»¤: <code>python nottlkey.py -d all -p 6379  </code></li><li>æ·»åŠ ttlå‘½ä»¤ï¼š<code>cat no_ttl_keys.txt  |  xargs -i -t ./redis-cli -h &lt;redis_ip&gt; -n &lt;database_num&gt; expire &lt;ttl_time&gt;</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜è°ƒæ•´å†…æ ¸å‚æ•°</title>
      <link href="posts/28361833/"/>
      <url>posts/28361833/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä¹‹å‰å®‰è£…å®Œredisï¼Œå¯åŠ¨redisï¼Œæ€»ä¼šå‘Šè¯‰ä½ è®©ä½ é»˜è®¤ä¿®æ”¹ä¸€äº›å‚æ•°ï¼Œä¸çŸ¥å…¶åŸå› ï¼Œä½†æ¯æ¬¡éƒ½æ‹›åŠã€‚<br>åæ¥é‡åˆ°ä¸€äº›rediså†…å­˜ä½¿ç”¨ç´§å¼ çš„æ—¶å€™ï¼Œä»è€Œå¯¼è‡´ redis-bgsave å¤±è´¥ï¼Œå†ä¸€æ¬¡æƒ³åˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚<br>ç»è¿‡æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°å®˜æ–¹æ–‡æ¡£é‡Œå‘Šè¯‰äº†åŸå› ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚å¦‚æœ‰ä¸å¯¹ä¹‹å¤„ï¼Œè¿˜è¯·æŒ‡å‡ºã€‚</p><h4 id="æˆ‘æ˜¯é—®é¢˜">æˆ‘æ˜¯é—®é¢˜</h4><p>redis-bgsaveä¸overcommit_memoryçš„å…³ç³»ã€‚<br>å½“å‰©ä½™ç‰©ç†å†…å­˜ä½äºå½“å‰redisæ‰€ç”¨å†…å­˜çš„æ—¶å€™ï¼Œovercommit_memory=1çš„æ„ä¹‰</p><h4 id="å®˜æ–¹è§£é‡Šåœ¨æ­¤">å®˜æ–¹è§£é‡Šåœ¨æ­¤</h4><blockquote><p><a href="https://redis.io/topics/faq">https://redis.io/topics/faq</a></p></blockquote><h2 id="Background-saving-fails-with-a-fork-error-under-Linux-even-if-I-have-a-lot-of-free-RAM">Background saving fails with a fork() error under Linux even if I have a lot of free RAM!</h2><p>Short answer: : <code>echo 1 &gt; /proc/sys/vm/overcommit_memory</code></p><p>And now the long one:</p><p>Redis background saving schema relies on the copy-on-write semantic of fork in modern operating systems: Redis forks (creates a child process) that is an exact copy of the parent. The child process dumps the DB on disk and finally exits. In theory the child should use as much memory as the parent being a copy, but actually thanks to the copy-on-write semantic implemented by most modern operating systems the parent and child process will <em>share</em> the common memory pages. A page will be duplicated only when it changes in the child or in the parent. Since in theory all the pages may change while the child process is saving, Linux canâ€™t tell in advance how much memory the child will take, so if the setting is set to zero fork will fail unless there is as much free RAM as required to really duplicate all the parent memory pages, with the result that if you have a Redis dataset of 3 GB and just 2 GB of free memory it will fail.<code>overcommit_memory</code></p><p>Setting to 1 tells Linux to relax and perform the fork in a more optimistic allocation fashion, and this is indeed what you want for Redis.<code>overcommit_memory</code></p><p>A good source to understand how Linux Virtual Memory works and other alternatives for and is this classic from Red Hat Magazine, <a href="https://people.redhat.com/nhorman/papers/rhel3_vm.pdf">â€œUnderstanding Virtual Memoryâ€</a>. You can also refer to the <a href="http://man7.org/linux/man-pages/man5/proc.5.html">proc(5)</a> man page for explanations of the available values.<code>overcommit_memory``overcommit_ratio</code></p><h4 id="ç¿»è¯‘åçš„å¤§è‡´æ„æ€">ç¿»è¯‘åçš„å¤§è‡´æ„æ€</h4><p>å®˜æ–¹çš„FAQï¼Œç»™äººä¸€ç§è¿™ä¹ˆä¸ªæ„æ€ã€‚ å¦‚æœä½ ä¸è®¾ç½®overcommit_memory=1ï¼Œé‚£ä¹ˆCOWæœºåˆ¶å°†æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥å½“ç©ºä½™å†…å­˜å°äºå½“å‰rediså ç”¨å†…å­˜æ—¶ï¼Œredis-bgsave å› ä¸ºæ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°†å¯¼è‡´åˆ†é…å†…å­˜å¤±è´¥ã€‚<br>è€ŒCOWæœºåˆ¶çš„æ„æ€å°±æ˜¯ï¼šçˆ¶å­è¿›ç¨‹å…¬ç”¨å†…å­˜é¡µï¼Œå› æ­¤åªä¼šcopyå˜åŒ–çš„æ•°æ®ã€‚å› æ­¤ï¼Œåœ¨COWæœºåˆ¶ä¸‹ï¼Œredis-bgsaveåªéœ€è¦ç”³è¯·åˆ°æ”¯æ’‘å˜åŒ–æ•°æ®çš„å†…å­˜å³å¯ã€‚<br>è‡³äºæ˜¯å¦æ˜¯å› ä¸ºå¯ç”¨ overcommit_memory=1 ä»è€Œä½¿å¾—COWæœºåˆ¶èµ·ä½œç”¨ï¼Œé™äºè¿™æ˜¯å†…æ ¸å±‚é¢çš„ä¸œè¥¿</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜s3è·¨è´¦æˆ·è®¿é—®</title>
      <link href="posts/7cac5d21/"/>
      <url>posts/7cac5d21/</url>
      
        <content type="html"><![CDATA[<ul><li>è§„åˆ™å¦‚ä¸‹ï¼š</li></ul><pre><code class="language-:">å­˜å‚¨æ¡¶ç­–ç•¥,æˆæƒå…¶å®ƒè´¦æˆ·çš„æŸä¸ª iam èµ„æºè®¿é—®æ­¤å­˜å‚¨æ¡¶arn:aws:iam::&lt;aws_account_id&gt;:&lt;type&gt;/&lt;name&gt;</code></pre><ul><li>ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š</li></ul><pre><code class="language-json:">&#123;    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Id&quot;: &quot;Policy1564021125924&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Sid&quot;: &quot;object1&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Principal&quot;: &#123;                &quot;AWS&quot;: &quot;arn:aws:iam::&lt;account-id&gt;:role/&lt;role-name&gt;&quot;            &#125;,            &quot;Action&quot;: [                &quot;s3:Get*&quot;,                &quot;s3:List*&quot;            ],            &quot;Resource&quot;: &quot;arn:aws:s3:::&lt;open-bucket&gt;/&lt;open-path&gt;/*&quot;        &#125;    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cloudformer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜rds-mysqlæ—¥å¿—</title>
      <link href="posts/604c5952/"/>
      <url>posts/604c5952/</url>
      
        <content type="html"><![CDATA[<h2 id="å¸¸è§„-é”™è¯¯-æ…¢-æ—¥å¿—">å¸¸è§„/é”™è¯¯/æ…¢/æ—¥å¿—</h2><pre><code class="language-bash"># ä¿®æ”¹å‚æ•°ç»„slow_query_logï¼šè¦åˆ›å»ºæ…¢é€ŸæŸ¥è¯¢æ—¥å¿—ï¼Œè¯·è®¾ç½®ä¸º 1ã€‚é»˜è®¤å€¼ä¸º 0ã€‚general_log(ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—)ï¼šè¦åˆ›å»ºå¸¸è§„æ—¥å¿—ï¼Œè¯·è®¾ç½®ä¸º 1ã€‚é»˜è®¤å€¼ä¸º 0ã€‚</code></pre><p>long_query_timeï¼šè¦é˜²æ­¢åœ¨æ…¢é€ŸæŸ¥è¯¢æ—¥å¿—ä¸­è®°å½•å¿«é€Ÿè¿è¡Œçš„æŸ¥è¯¢ï¼Œè¯·æŒ‡å®šéœ€è¦è®°å½•çš„æœ€çŸ­æŸ¥è¯¢æ‰§è¡Œæ—¶é—´å€¼ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚é»˜è®¤å€¼ä¸º 10 ç§’ï¼›æœ€å°å€¼ä¸º 0ã€‚<br>å¦‚æœ log_output = FILEï¼Œåˆ™å¯ä»¥æŒ‡å®šç²¾ç¡®åˆ°å¾®ç§’çš„æµ®ç‚¹å€¼, å³å¯è®°å½• 0.1s<br>å¦‚æœ log_output = TABLEï¼Œåˆ™å¿…é¡»æŒ‡å®šç²¾ç¡®åˆ°ç§’çš„æ•´æ•°å€¼ã€‚<br>ç³»ç»Ÿåªè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ long_query_time å€¼çš„æŸ¥è¯¢ã€‚</p><p>log_queries_not_using_indexes(ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—)ï¼šè¦å°†æ‰€æœ‰ä¸ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢è®°å½•åˆ°æ…¢é€ŸæŸ¥è¯¢æ—¥å¿—ï¼Œè¯·è®¾ç½®ä¸º 1ã€‚é»˜è®¤å€¼ä¸º 0ã€‚å°†è®°å½•ä¸ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢ï¼Œå³ä½¿å®ƒä»¬çš„æ‰§è¡Œæ—¶é—´å°äº long_query_time å‚æ•°çš„å€¼ã€‚</p><p>log_output optionï¼šæ‚¨å¯ä¸º log_output å‚æ•°æŒ‡å®šä¸‹åˆ—é€‰é¡¹ä¹‹ä¸€ã€‚</p><p>TABLEï¼ˆé»˜è®¤, ä¸å»ºè®®, å½±å“æ•°æ®åº“æœ¬èº«æ€§èƒ½ï¼‰â€“ å°†ä¸€èˆ¬æŸ¥è¯¢å†™å…¥ mysql.general_log è¡¨ï¼Œå°†æ…¢é€ŸæŸ¥è¯¢å†™å…¥ mysql.slow_log è¡¨ã€‚</p><p>FILE(æ¨è,ä¹Ÿæ˜¯å¿…é¡»,å¦åˆ™æ— æ³•æ¨é€åˆ°cloudwatch)â€“ å°†ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—å’Œæ…¢é€ŸæŸ¥è¯¢æ—¥å¿—å†™å…¥æ–‡ä»¶ç³»ç»Ÿã€‚æ—¥å¿—æ–‡ä»¶æ¯å°æ—¶è½®æ¢ä¸€æ¬¡ã€‚é»˜è®¤è®°å½•24å°æ—¶.</p><p>NONEâ€“ ç¦ç”¨æ—¥å¿—è®°å½•</p><h2 id="å®¡è®¡æ—¥å¿—">å®¡è®¡æ—¥å¿—</h2><pre><code># ä¿®æ”¹é€‰é¡¹ç»„, æ·»åŠ é¢å¤–é€‰é¡¹MARIADB_AUDIT_PLUGIN </code></pre><h2 id="äºŒè¿›åˆ¶æ—¥å¿—">äºŒè¿›åˆ¶æ—¥å¿—</h2><blockquote><p>äºŒè¿›åˆ¶æ—¥å¿—ä¸€èˆ¬æˆ‘ä»¬ç”¨æ¥æ¢å¤æ•°æ®, é»˜è®¤ rds ä¼šå°½é‡é”€æ¯äºŒè¿›åˆ¶æ—¥å¿—, æ¥ä¿ç•™ç£ç›˜å¯ç”¨ç©ºé—´.</p><p>äºŒè¿›åˆ¶æ—¥å¿—é»˜è®¤æ ¼å¼æ˜¯   mixed</p></blockquote><p>é…ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„æ–¹æ³•:</p><pre><code class="language-bash"># å°†äºŒè¿›åˆ¶æ—¥å¿—ä¿ç•™24å°æ—¶call mysql.rds_set_configuration('binlog retention hours', 24);</code></pre><p>è®¿é—®äºŒè¿›åˆ¶æ—¥å¿—çš„æ–¹æ³•å¦‚ä¸‹:</p><pre><code class="language-bash">mysqlbinlog \    --read-from-remote-server \    --host=&lt;mysql_rds_instance_address&gt; \    --port=&lt;mysql_port&gt; \    --user ReplUser \    --password \    --raw \    --result-file=/tmp/ \    binlog.00098</code></pre><blockquote><ul><li><p>æŒ‡å®š  <code>--read-from-remote-server</code>  é€‰é¡¹ã€‚</p></li><li><p><code>--host</code>ï¼šæŒ‡å®šè¯¥å®ä¾‹æ‰€åœ¨çš„ç»ˆç«¯èŠ‚ç‚¹ä¸­çš„ DNS åç§°ã€‚</p></li><li><p><code>--port</code>ï¼šæŒ‡å®šè¯¥å®ä¾‹ä½¿ç”¨çš„ç«¯å£ã€‚</p></li><li><p><code>--user</code>ï¼šæŒ‡å®šå·²æˆäºˆäº†å¤åˆ¶ä»å±å®ä¾‹æƒé™çš„ MySQL ç”¨æˆ·ã€‚</p></li><li><p><code>--password</code>ï¼šæŒ‡å®šç”¨æˆ·çš„å¯†ç ï¼Œæˆ–å¿½ç•¥å¯†ç å€¼ä»¥è®©å®ç”¨ç¨‹åºæç¤ºæ‚¨è¾“å…¥å¯†ç ã€‚</p></li><li><p>è¦æŒ‰äºŒè¿›åˆ¶æ ¼å¼ä¸‹è½½æ–‡ä»¶ï¼Œè¯·æŒ‡å®š  <code>--raw</code>  é€‰é¡¹ã€‚</p></li><li><p><code>--result-file</code>ï¼šæŒ‡å®šç”¨äºæ¥æ”¶åŸå§‹è¾“å‡ºçš„æœ¬åœ°æ–‡ä»¶ã€‚</p></li><li><p>æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„åç§°ã€‚è¦è·å–å¯ç”¨æ—¥å¿—çš„åˆ—è¡¨ï¼Œè¯·ä½¿ç”¨ SQL å‘½ä»¤ SHOW BINARY LOGSã€‚</p></li><li><p>è¦æµå¼ä¼ è¾“äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œè¯·æŒ‡å®š  <code>--stop-never</code>  é€‰é¡¹ã€‚</p></li></ul></blockquote><hr><h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£:</h2><ol><li><a href="https://docs.aws.amazon.com/zh_cn/AmazonRDS/latest/UserGuide/USER_LogAccess.Concepts.MySQL.html#Appendix.MySQL.CommonDBATasks.Logs">https://docs.aws.amazon.com/zh_cn/AmazonRDS/latest/UserGuide/USER_LogAccess.Concepts.MySQL.html#Appendix.MySQL.CommonDBATasks.Logs</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rds </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜centos7é‡ç½®rootå¯†ç </title>
      <link href="posts/13364d65/"/>
      <url>posts/13364d65/</url>
      
        <content type="html"><![CDATA[<ol><li>å¼€æœºæŒ‰ECSï¼Œè¿›å…¥å¯åŠ¨é¡¹</li></ol><p><img src="/posts/13364d65/image-20210706143953672.png" alt="image-20210706143953672"></p><ol start="2"><li><p>æŒ‰eï¼Œç¼–è¾‘ç¬¬ä¸€æ¡</p></li><li><p>å°† root æŒ‚è½½ï¼Œä» ro å˜æ›´ä¸º rwï¼Œå¹¶åœ¨æœ€åæ·»åŠ  init=/bin/sh</p></li></ol><p><img src="/posts/13364d65/image-20210706144107672.png" alt="image-20210706144107672"></p><ol start="4"><li>æŒ‰ ctrl+xï¼Œè¿›å…¥ç³»ç»Ÿï¼Œå¹¶æ‰§è¡Œ <code>passwd</code> å‘½ä»¤è¿›è¡Œä¿®æ”¹</li></ol>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜ç³»ç»Ÿå†…æ ¸ä¼˜åŒ–</title>
      <link href="posts/f41d0763/"/>
      <url>posts/f41d0763/</url>
      
        <content type="html"><![CDATA[<h2 id="å†…æ ¸ä¼˜åŒ–">å†…æ ¸ä¼˜åŒ–</h2><pre><code class="language-bash"># å†…æ ¸å‚æ•°# ç³»ç»Ÿçº§åˆ«ä¸Šé™ï¼Œ å³æ•´ä¸ªç³»ç»Ÿæ‰€æœ‰è¿›ç¨‹å•ä½æ—¶é—´å¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡fs.file-max = 6553500# ä¸‰æ¬¡æ¡æ‰‹è¯·æ±‚é¢‘æ¬¡net.ipv4.tcp_syn_retries = 5# æ”¾å¼ƒå›åº”ä¸€ä¸ªTCPè¯·æ±‚ä¹‹å‰ï¼Œéœ€è¦å°è¯•å¤šå°‘æ¬¡net.ipv4.tcp_retries1 = 3# ä¸‰æ¬¡æ¡æ‰‹åº”ç­”é¢‘æ¬¡net.ipv4.tcp_synack_retries = 2# ä¸‰æ¬¡æ¡æ‰‹å®Œæ¯•ï¼Œ æ²¡æœ‰æ•°æ®æ²Ÿé€šçš„æƒ…å†µä¸‹ï¼Œ ç©ºè¿æ¥å­˜æ´»æ—¶é—´net.ipv4.tcp_keepalive_time = 60# æ¢æµ‹æ¶ˆæ¯å‘é€æ¬¡æ•°net.ipv4.tcp_keepalive_probes = 3# æ¢æµ‹æ¶ˆæ¯å‘é€é—´éš”æ—¶é—´net.ipv4.tcp_keepalive_intvl = 15net.ipv4.tcp_retries2 = 5net.ipv4.tcp_fin_timeout = 5# ç³»ç»Ÿå¤„ç†ä¸å±äºä»»ä½•è¿›ç¨‹çš„TCPé“¾æ¥net.ipv4.tcp_orphan_retries = 3net.ipv4.tcp_max_orphans = 327680# åœ¨æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚net.core.netdev_max_backlog = 10240# å¯¹äºè¿˜æœªè·å¾—å¯¹æ–¹ç¡®è®¤çš„è¿æ¥è¯·æ±‚ï¼Œå¯ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­çš„æœ€å¤§æ•°ç›®net.ipv4.tcp_max_syn_backlog = 10240# å®šä¹‰äº†ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç«¯å£æœ€å¤§çš„ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦ net.core.somaxconn=10240#æœ€å¤§timewaitæ•°net.ipv4.tcp_max_tw_buckets = 20000net.ipv4.ip_local_port_range=1024 65500# å¼€å¯æ—¶é—´æˆ³net.ipv4.tcp_timestamps=1# é’ˆå¯¹å®¢æˆ·ç«¯æœ‰æ•ˆï¼Œå¿…é¡»åœ¨å¼€å¯æ—¶é—´æˆ³çš„å‰æä¸‹net.ipv4.tcp_tw_reuse = 1# å¼€å¯ iptables åï¼Œ é“¾è·¯è¿½è¸ªä¸Šé™å’Œè¶…æ—¶æ—¶é—´, è‹¥æ²¡æœ‰ä½¿ç”¨ iptablesï¼Œåˆ™æ— æ•ˆnet.netfilter.nf_conntrack_max = 6553500net.netfilter.nf_conntrack_tcp_timeout_established = 150## tcpæ ˆå†…å­˜ä½¿ç”¨ï¼Œ å•ä½æ˜¯å†…å­˜é¡µï¼Œ ä¸€é¡µ=4KB#net.ipv4.tcp_mem = 524288 786432 1310720## socketè¯»å†™ç¼“å†²åŒºå¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚#net.ipv4.tcp_rmem = 4096 4096 16777216#net.ipv4.tcp_wmem = 4096 4096 16777216##æœ€ä½å†…å­˜å’Œç¼“å†²åŒºå›æ”¶å€¾å‘ï¼ˆæ­¤å‚æ•°æœ‰ä¸€å®šé£é™©ï¼‰#vm.min_free_kbytes=409600#vm.vfs_cache_pressure=200</code></pre><pre><code class="language-bash">#ä¿®æ”¹/etc/security/limits.conf# å•ä¼šè¯çº§åˆ«ï¼Œå¯æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸Šé™* soft nofile 655350* hard nofile 655350# å•ä¼šè¯çº§åˆ«ï¼Œ å¯æ‰“å¼€çš„æ‰€æœ‰è¿›ç¨‹ä¸Šé™* soft nproc 10240* hard nproc 10240</code></pre><h2 id="å¼€å¯-iptables-å">å¼€å¯ iptables å</h2><h3 id="æŸ¥çœ‹å½“å‰é“¾è·¯è¡¨æ•°é‡å‘½ä»¤">æŸ¥çœ‹å½“å‰é“¾è·¯è¡¨æ•°é‡å‘½ä»¤</h3><blockquote><p>$ sysctl net.netfilter.nf_conntrack_count</p><p>net.netfilter.nf_conntrack_count = 601032</p></blockquote><h3 id="æŸ¥çœ‹è¿æ¥æ•°æœ€é«˜çš„10ä¸ªIPï¼šå¯ä»¥æŸ¥å°æŸä¸ªip-æˆ–è€…åˆ¤æ–­æ˜¯è°å¯¼è‡´çš„">æŸ¥çœ‹è¿æ¥æ•°æœ€é«˜çš„10ä¸ªIPï¼šå¯ä»¥æŸ¥å°æŸä¸ªip, æˆ–è€…åˆ¤æ–­æ˜¯è°å¯¼è‡´çš„</h3><p>$ awk -Fâ€™=â€™ â€˜{c[$2]++}END{for ( i in c) print i,c[i]}â€™ /proc/net/nf_conntrack | head -10</p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shellâ˜ifåˆ¤å®š</title>
      <link href="posts/241ce96c/"/>
      <url>posts/241ce96c/</url>
      
        <content type="html"><![CDATA[<pre><code>-a FILEï¼šå­˜åœ¨åˆ™ä¸ºçœŸï¼›å¦åˆ™åˆ™ä¸ºå‡ï¼›-e FILE: å­˜åœ¨åˆ™ä¸ºçœŸï¼›å¦åˆ™åˆ™ä¸ºå‡ï¼›-f FILE: å­˜åœ¨å¹¶ä¸”ä¸ºæ™®é€šæ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-d DIR: å­˜åœ¨å¹¶ä¸”ä¸ºç›®å½•ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-L/-h FILE: å­˜åœ¨å¹¶ä¸”ä¸ºç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-b: å­˜åœ¨å¹¶ä¸”ä¸ºå—è®¾å¤‡ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-c: å­˜åœ¨å¹¶ä¸”ä¸ºå­—ç¬¦è®¾å¤‡ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡-S: å­˜åœ¨å¹¶ä¸”ä¸ºå¥—æ¥å­—æ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡-p: å­˜åœ¨å¹¶ä¸”ä¸ºå‘½åç®¡é“ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡-s FILE: å­˜åœ¨å¹¶ä¸”ä¸ºéç©ºæ–‡ä»¶åˆ™ä¸ºå€¼ï¼Œå¦åˆ™ä¸ºå‡ï¼›-r FILEï¼šæ–‡ä»¶å¯è¯»ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡-w FILEï¼šæ–‡ä»¶å¯å†™ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› </title>
      <link href="posts/a3dfc0e8/"/>
      <url>posts/a3dfc0e8/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-â˜-dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› ">linux â˜ dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› </h2><ul><li><h3 id="é—®é¢˜è¡¨ç°ï¼š">é—®é¢˜è¡¨ç°ï¼š</h3></li></ul><p>df æ•°æ®æ¯” du æ•°æ®å°ï¼Œè€Œä¸”æ˜¯å‘ç”Ÿåœ¨åˆ é™¤æ–‡ä»¶ä¹‹åã€‚</p><hr><p>è¿™ä¸ªé—®é¢˜ç‰µæ‰¯åˆ° linux ç³»ç»Ÿæ˜¯å°†å¦‚ä½•ç¡®è®¤å’Œå›æ”¶æ•°æ®çš„.</p><ul><li><h3 id="ç©ºé—´æ˜¯å¦‚ä½•è¢«åˆ¤å®šå ç”¨çš„">ç©ºé—´æ˜¯å¦‚ä½•è¢«åˆ¤å®šå ç”¨çš„</h3></li></ul><p>linuxæ–‡ä»¶ç³»ç»Ÿåˆ¤å®šç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œæ˜¯æŸ¥çœ‹ç©ºé—´çš„ imap æ˜¯å¦ä¸º1ï¼Œè€Œ imap æ˜¯å¦ä¸º1ï¼Œåˆ™å–å†³äºå ç”¨ç©ºé—´çš„æ–‡ä»¶çš„ inode èŠ‚ç‚¹çš„ Links æ˜¯å¦ä¸º0ã€‚è€Œæ¯å½“ç¨‹åºè°ƒç”¨æ–‡ä»¶ä¸”æ²¡æœ‰å…³é—­ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶çš„ inode çš„ Links å°±ä¼šåŠ  1ã€‚</p><p>å¦‚æœ Links ä¸ä¸º0ï¼Œåˆ™ imap å°±ä¸ä¼šæ˜¯ 0 ï¼Œåˆ™è¿™ä»½ç©ºé—´å°±æ— æ³•è¢«å†æ¬¡è°ƒç”¨.<br>å¦å¤–ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé»˜è®¤ inode  Links æ˜¯1</p><ul><li><h3 id="ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„">ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„</h3></li></ul><p>æ–‡ä»¶ç³»ç»Ÿé¦–å…ˆåœ¨çˆ¶ç›®å½•æ–‡ä»¶é‡Œæ‰¾åˆ°æ‰€è¦åˆ é™¤çš„æ–‡ä»¶åï¼Œå°†æ­¤æ–‡ä»¶ä¿¡æ¯ä»çˆ¶ç›®å½•é‡Œæ¸…é™¤æ‰ï¼Œå¦‚è‹¥æ¸…é™¤åï¼ŒLinks ä¸º0 ï¼Œåˆ™åˆ é™¤ inode èŠ‚ç‚¹ï¼Œå°† imap å°±ç½®ä¸º0ï¼Œç©ºé—´å¯ä»¥å†æ¬¡è¢«åˆ©ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœçˆ¶ç›®å½•æ–‡ä»¶ä¿¡æ¯æ¸…é™¤åï¼Œæœ‰ç¨‹åºåœ¨è°ƒç”¨æ–‡ä»¶ï¼Œåˆ™ Links ä¸ä¸º0ï¼Œé‚£ä¹ˆ inode æ— æ³•è¢«åˆ é™¤ï¼Œ imap ä¹Ÿæ— æ³•ç½®ä¸º0ï¼Œç»“æœå°±æ˜¯æ–‡ä»¶çœ‹ç€æ²¡äº†ï¼Œä½†æ˜¯ç©ºé—´è¿˜æ˜¯æ²¡æœ‰é‡Šæ”¾ã€‚</p><hr><p>df å’Œ du çš„æœ€å¤§åŒºåˆ«å°±æ˜¯ï¼š</p><p>df æ˜¯æ ¹æ® inode çš„ Links æ¥ç¡®è®¤ç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œå¹¶è¿›è€Œç»Ÿè®¡</p><p>du æ˜¯æ ¹æ®ç›®å½•çš„æ–‡ä»¶ä¿¡æ¯æ¥ç¡®è®¤ç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œå¹¶è¿›è€Œç»Ÿè®¡</p><ul><li><h3 id="å¦‚ä½•é‡Šæ”¾è¢«å ç”¨çš„ç©ºé—´">å¦‚ä½•é‡Šæ”¾è¢«å ç”¨çš„ç©ºé—´</h3></li></ul><p>ä»ä¸Šé¢å¯çŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¢«åˆ é™¤æ–‡ä»¶çš„ inode Links é™æˆ 0 å³å¯ï¼Œä¹Ÿå°±æ˜¯å…³é—­æ­¤æ–‡ä»¶çš„è°ƒç”¨ç¨‹åº.</p><p>å¦‚ä½•æŸ¥æ‰¾è°ƒç”¨ç¨‹åºï¼Ÿ</p><pre><code class="language-bash">lsof -n | grep rm_file_name # è·å–åˆ°ç¨‹åº pidï¼Œå¹¶å°†å…¶æ€æ­»å³å¯</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux-æ·»åŠ sshç™»é™†é™åˆ¶</title>
      <link href="posts/c3b69c28/"/>
      <url>posts/c3b69c28/</url>
      
        <content type="html"><![CDATA[<ol><li>å¼€å¯sshçš„UsePAM</li></ol><pre><code class="language-bash"># /etc/ssh/sshd_configUsePAM yes</code></pre><ol start="2"><li>æ·»åŠ è§„åˆ™</li></ol><pre><code class="language-bash"># /etc/pam.d/sshd#%PAM-1.0auth required pam_tally2.so deny=3 unlock_time=600 even_deny_root root_unlock_time=600</code></pre><p>ä»»ä½•ç”¨æˆ·æ¯600ç§’åªæœ‰ä¸‰æ¬¡è¯•é”™ã€‚</p><ol start="3"><li>è§£å°ç”¨æˆ·</li></ol><pre><code class="language-bash">pam_tally2 -u &lt;ç”¨æˆ·å&gt; -r</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-lookupæ’ä»¶</title>
      <link href="posts/25732c33/"/>
      <url>posts/25732c33/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>lookup æ’ä»¶å¯ä»¥é…åˆ loop å…³é”®è¯å¾ªç¯å®ç° with_x å¾ªç¯</p><h2 id="lookup-æŸ¥è¯¢æ’ä»¶">lookup æŸ¥è¯¢æ’ä»¶</h2><p>é€šè¿‡ä¸åŒçš„å‚æ•°ï¼Œè¿”å›ç»“æœé›†ï¼Œç»“æœé›†æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚</p><blockquote><p>query æ’ä»¶ä¸ lookup æ’ä»¶ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äº query é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ç”¨äº†wantlist=trueã€‚<br>wantlist çš„æ„æ€æ˜¯å°†è¿”å›çš„å­—ç¬¦ä¸²æ„æˆä¸€ä¸ªåˆ—è¡¨<br>å¦å¤–ï¼Œquery å¯ä»¥ç®€å†™ä¸ºq</p></blockquote><h2 id="loop-å…³é”®è¯">loop å…³é”®è¯</h2><p>loop ä½œç”¨æ˜¯å°†ä¸€ä¸ªåˆ—è¡¨å¾ªç¯è¾“å‡ºï¼Œæ¯æ¬¡å¾ªç¯æ—¶ï¼Œå°†åˆ—è¡¨å­å…ƒç´ èµ‹å€¼ç»™ item å˜é‡. å®˜æ–¹ç”¨æ¥æ›¿ä»£ with_xxx</p><h2 id="lookupå’Œloopç»“åˆ">lookupå’Œloopç»“åˆ</h2><p>loopç”¨æ¥éå† lookup ç»“æœé›†ã€‚</p><blockquote><p>è‡ªå®šä¹‰loopå¾ªç¯ä¸­çš„å­å…ƒç´ å˜é‡ä¸º xxxï¼Œä»£æ›¿item</p><pre><code class="language-yaml">loop_control:  loop_var: xxx</code></pre><p>loop_control è¿˜æœ‰å…¶å®ƒæ§åˆ¶ï¼Œæ¯”å¦‚</p><ul><li>index_var: var_name å¾ªç¯ç´¢å¼•.</li><li>pause: time å¾ªç¯é—´éš”æ—¶é—´</li><li>label: var_name å»æ‰ var_name ä¹‹å¤–çš„ä¸ç›¸å¹²ä¿¡æ¯è¾“å‡º</li></ul></blockquote><h2 id="lookupå¸¸ç”¨å‚æ•°ç¤ºä¾‹">lookupå¸¸ç”¨å‚æ•°ç¤ºä¾‹</h2><h4 id="file-å‚æ•°">file å‚æ•°</h4><blockquote><p>å¤šä¸ªæ–‡ä»¶å†…å®¹åˆå¹¶åœ¨ä¸€èµ·ï¼Œæˆ–ä»¥å­—ç¬¦ä¸²é€—å·åˆ†éš”è¾“å‡ºï¼Œæˆ–ä»¥åˆ—è¡¨å½¢å¼è¾“å‡º</p></blockquote><h4 id="ini-å‚æ•°">ini å‚æ•°</h4><blockquote><p>è·å– ini é…ç½®ä¿¡æ¯</p></blockquote><pre><code class="language-ini"># ~/test.ini[testA]a1=zhangsana2=lisi[testB]b1=wangwu</code></pre><pre><code class="language-yaml">---- hosts: localhost  gather_facts: no  remote_user: zyh  tasks:    - name: get ini      debug:        msg: &quot;&#123;&#123; q('ini', 'a1 section=testA file=~/test.ini') &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        &quot;zhangsan&quot;    ]&#125;</code></pre><blockquote><p>å½“é…ç½®æ˜¯ propertiesï¼Œå¯ä»¥è¿½åŠ  type=properties</p></blockquote><h4 id="dictå‚æ•°">dictå‚æ•°</h4><p>ç”Ÿæˆä¸€ä¸ªå­—å…¸åˆ—è¡¨</p><pre><code class="language-bash"># ç»“æœé›† [&#123;key: xxx, value: xxx&#125;, &#123;key: xxx, value: xxx&#125;]</code></pre><pre><code class="language-yaml">---- hosts: local  gather_facts: no  connection: local  vars:    users:      male: Bob      female: Maris  tasks:    - name: test vars 1      loop: &quot;&#123;&#123; lookup('dict', users) &#125;&#125;&quot;      debug:        msg: &quot;&#123;&#123; item.key &#125;&#125;: &#123;&#123; item.value &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; (item=&#123;'key': u'male', 'value': u'Bob'&#125;) =&gt; &#123;    &quot;msg&quot;: &quot;male: Bob&quot;&#125;ok: [localhost] =&gt; (item=&#123;'key': u'female', 'value': u'Maris'&#125;) =&gt; &#123;    &quot;msg&quot;: &quot;female: Maris&quot;&#125;</code></pre><h4 id="subelementså‚æ•°">subelementså‚æ•°</h4><pre><code class="language-bash"># å†™æ³•ï¼š&#123;&#123; lookup('subelements',list,'content') &#125;&#125;# ä¸€ä¸ªç”±ç›¸åŒç»“æ„å­—å…¸ç»„æˆçš„åˆ—è¡¨listï¼Œå°†å­—å…¸ä¸­æŸä¸€ä¸ªå…ƒç´ keyï¼ˆå€¼å¿…é¡»æ˜¯åˆ—è¡¨ï¼‰ä¸å­—å…¸å‰©ä½™çš„å…ƒç´ ï¼ˆå‰©ä½™çš„å…ƒç´ ä½œä¸ºä¸€ä¸ªæ•´ä½“æ–°å­—å…¸ï¼‰ï¼Œæ„å»ºç¬›å¡å°”ç§¯ã€‚ä»è€Œå½¢æˆ itemã€‚æ¯ä¸€ä¸ªå­—å…¸æ‹†åˆ†ç»„åˆåçš„ item æ„å»ºç»“æœé›† items# ç»“æœé›†items=[[&#123;list.0.å‰©ä½™kv&#125;,  list.0.key.0], [&#123;list.0.å‰©ä½™kv&#125;,  list.0.key.1], [&#123;list.1.å‰©ä½™kv&#125;,  list.1.key.0], [&#123;list.1.å‰©ä½™kv&#125;,  list.1.key.1], ]</code></pre><pre><code class="language-yaml">---- hosts: local  gather_facts: no  connection: local  vars:          users:                  - name: Bob                    gender: male                    age: 18                    content:                            - eating                            - sleeping                            - play ogre                  - name: Maris                    gender: female                    age: 20                    content:                            - eating                            - sleeping                            - shopping  tasks:          - name: test vars 2            debug:                    msg: &quot;&#123;&#123; item.0.name &#125;&#125; - &#123;&#123; item.0.gender &#125;&#125; - &#123;&#123; item.1 &#125;&#125;&quot;            loop: &quot;&#123;&#123; lookup('subelements',users,'content') &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; (item=[&#123;u'gender': u'male', u'age': 18, u'name': u'Bob'&#125;, u'eating']) =&gt; &#123;    &quot;msg&quot;: &quot;Bob - male - eating&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'male', u'age': 18, u'name': u'Bob'&#125;, u'sleeping']) =&gt; &#123;    &quot;msg&quot;: &quot;Bob - male - sleeping&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'male', u'age': 18, u'name': u'Bob'&#125;, u'play ogre']) =&gt; &#123;    &quot;msg&quot;: &quot;Bob - male - play ogre&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'female', u'age': 20, u'name': u'Maris'&#125;, u'eating']) =&gt; &#123;    &quot;msg&quot;: &quot;Maris - female - eating&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'female', u'age': 20, u'name': u'Maris'&#125;, u'sleeping']) =&gt; &#123;    &quot;msg&quot;: &quot;Maris - female - sleeping&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'female', u'age': 20, u'name': u'Maris'&#125;, u'shopping']) =&gt; &#123;    &quot;msg&quot;: &quot;Maris - female - shopping&quot;&#125;</code></pre><blockquote><p>è‹¥æœ‰å¤šä¸ªkeyéœ€è¦é™„åŠ ï¼Œéœ€è¦ nested ä¸  include_tasks çš„ç»„åˆå®ç°</p></blockquote><h4 id="nestedå‚æ•°">nestedå‚æ•°</h4><blockquote><p>å°†å¤šä¸ªåˆ—è¡¨è¿›è¡Œç¬›å¡å°”ç§¯è¿ç®—</p><ol><li>test3.yml ä¸­æ‹¿åˆ° userså¾ªç¯å•ä½“ user</li><li>é’ˆå¯¹å¾ªç¯å•ä½“ userå¼•å…¥é™„åŠ ä»»åŠ¡ test3_1.yml</li><li>é€šè¿‡lookupæ’ä»¶nestedï¼Œå°† userå­—å…¸ä¸­å„keyçš„valueç›¸äº’éå†ï¼Œæ„å»ºæ–°åˆ—è¡¨ item</li></ol></blockquote><pre><code class="language-yaml">################ test3.yml---- hosts: local  gather_facts: no  connection: local  vars:          users:                  - name: Bob                    gender: male                           age: 18                    content:                            - eating                               - sleeping                             - play ogre                    specialty:                            - english                              - game                       - name: Maris                            gender: female                         age: 20                    content:                            - eating                               - sleeping                             - shopping                     specialty:                            - history                              - cooking    tasks:          - include_tasks: test3_1.yml             loop: &quot;&#123;&#123; users &#125;&#125;&quot;            loop_control:                    loop_var: user ################ test3_1.yml- loop: &quot;&#123;&#123; lookup('nested',user.name, user.age, user.content, user.specialty) &#125;&#125;&quot;  debug:    msg: &quot;name:&#123;&#123; item.0 &#125;&#125;, age:&#123;&#123; item.1 &#125;&#125;, &#123;&#123; item.2 &#125;&#125;, &#123;&#123; item.3 &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; (item=[u'Bob', 18, u'eating', u'english']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, eating, english&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'eating', u'game']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, eating, game&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'sleeping', u'english']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, sleeping, english&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'sleeping', u'game']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, sleeping, game&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'play ogre', u'english']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, play ogre, english&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'play ogre', u'game']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, play ogre, game&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'eating', u'history']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, eating, history&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'eating', u'cooking']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, eating, cooking&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'sleeping', u'history']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, sleeping, history&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'sleeping', u'cooking']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, sleeping, cooking&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'shopping', u'history']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, shopping, history&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'shopping', u'cooking']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, shopping, cooking&quot;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> lookup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="posts/0/"/>
      <url>posts/0/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-go">package mainimport (      &quot;fmt&quot;    &quot;sync&quot;)func main() &#123;      var wg sync.WaitGroup  // 1.ç­‰å¾…ç»„    done := make(chan struct&#123;&#125;) // 2.é€šé“ï¼ˆä»…å……å½“æ ‡è¯†å®Œæˆä¸å¦ï¼‰    wq := make(chan interface&#123;&#125;) // 3.é€šé“ï¼ˆå­˜å‚¨æ¶ˆè´¹æ•°æ®ï¼‰    workerCount := 2 // 4.æ¶ˆè´¹è€…    for i := 0; i &lt; workerCount; i++ &#123;        wg.Add(1)  // 5.æ·»åŠ ç­‰å¾…ç»„è®¡æ•°ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å¯¹åº”ä¸€ä¸ª        go doit(i,wq,done,&amp;wg) // 6.å¹¶å‘æ‰§è¡Œæ¶ˆè´¹å‡½æ•°    &#125;     for i := 0; i &lt; workerCount; i++ &#123; // 9.å†™å…¥0,1åˆ°æ¶ˆè´¹é€šé“wq        wq &lt;- i    &#125;    close(done) // 11. å…³é—­å®Œæˆé€šé“ï¼Œä½¿æ¶ˆè´¹è€…å¯ä»¥ä»å…³é—­é€šé“é‡Œè·å–ç©ºå€¼ï¼Œä»è€Œæ¨å‡ºç›‘å¬forå¾ªç¯    wg.Wait() // 15. ç­‰å¾…ç»„åœ¨è®¡æ•°ä¸º0ä¹‹å‰ï¼Œé˜»å¡è¿›ç¨‹    fmt.Println(&quot;all done!&quot;)&#125;func doit(workerId int, wq &lt;-chan interface&#123;&#125;,done &lt;-chan struct&#123;&#125;,wg *sync.WaitGroup) &#123;  // æ¶ˆè´¹è€…IDï¼Œæ¶ˆè´¹é€šé“ï¼ˆä»…å¯åªè¯»ï¼‰ï¼Œå®Œæˆé€šé“ï¼ˆä»…å¯åªè¯»ï¼‰ï¼Œç­‰å¾…ç»„æŒ‡é’ˆ    fmt.Printf(&quot;worker [%v] is running\n&quot;,workerId) // 7. æ‰“å°æ¶ˆè´¹è€…çŠ¶æ€    defer wg.Done() // 14. ä¸€ä¸ªæ¶ˆè´¹è€…å®Œæˆæ¶ˆè´¹å‡½æ•°ï¼Œç­‰å¾…ç»„è®¡æ•°å‡1    for &#123;      // 8.æ¯ä¸€ä¸ªæ¶ˆè´¹è€…å†…éƒ¨å¾ªç¯ç›‘å¬æ¶ˆè´¹é€šé“wq        select &#123;        case m := &lt;- wq: // 10.ä¸€æ—¦æ¶ˆè´¹é€šé“å‡ºç°æ•°æ®ï¼Œåˆ™æ¶ˆè´¹è€…å°±ä»æ¶ˆè´¹é€šé“é‡Œè·å–æ•°æ®ï¼Œå¹¶æ‰“å°            fmt.Printf(&quot;worker [%v] consumed %v\n&quot;,workerId,m)        case &lt;- done:  // 12. ä»å®Œæˆé€šé“é‡Œè·å–ç©ºå€¼ï¼Œä»è€Œè¾¾æˆæ‰§è¡Œæ¡ä»¶            fmt.Printf(&quot;worker [%v] is done\n&quot;,workerId)            return  // 13. é€€å‡ºå¾ªç¯ç›‘å¬        default:            time.Sleep(1 * time.Second) // 8-1. åœ¨æ²¡æœ‰æ¶ˆè´¹æ•°æ®ä¹‹å‰ï¼Œæ¯ä¸€ç§’ç›‘å¬ä¸€æ¬¡            fmt.Println(&quot;No Event!&quot;)        &#125;    &#125;&#125;</code></pre><p>11æ‰§è¡Œä¹‹åï¼Œ12å¦‚ä½•ç¡®ä¿åœ¨10ä¹‹åè¿è¡Œã€‚</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
