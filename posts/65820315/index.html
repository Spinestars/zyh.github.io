<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="prometheus☞搭建"><meta name="keywords" content="Peometheus"><meta name="author" content="zyh"><meta name="copyright" content="zyh"><title>prometheus☞搭建 | zyh</title><link rel="shortcut icon" href="/niu.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 5.1.1"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">监控端组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#grafana-%E7%95%8C%E9%9D%A2"><span class="toc-number">2.1.</span> <span class="toc-text">grafana 界面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alertmanager-%E5%91%8A%E8%AD%A6%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">alertmanager 告警管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Peometheus-%E4%B8%BB%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">Peometheus 主程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pushgateway-%E5%88%9D%E6%9C%9F%E7%94%A8%E4%B8%8D%E4%B8%8A%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">2.4.</span> <span class="toc-text">pushgateway (初期用不上的组件)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">被监控端组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#node-exporter-%E7%89%A9%E7%90%86%E8%8A%82%E7%82%B9%E7%9B%91%E6%8E%A7"><span class="toc-number">3.1.</span> <span class="toc-text">node-exporter 物理节点监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cadvisor-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7"><span class="toc-number">3.2.</span> <span class="toc-text">cadvisor 容器监控</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-grafana-%E6%95%B0%E6%8D%AE%E6%BA%90-proms"><span class="toc-number">4.1.</span> <span class="toc-text">添加 grafana 数据源 : proms</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-grafana-%E7%9B%91%E6%8E%A7%E6%A8%A1%E6%9D%BF"><span class="toc-number">4.2.</span> <span class="toc-text">添加 grafana 监控模板</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://spinestars.github.io/assets.github.io/niu.png"></div><div class="author-info__name text-center">zyh</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">92</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">71</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">18</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">zyh</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">prometheus☞搭建</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-07-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E7%9B%91%E6%8E%A7/">监控</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1>前言</h1>
<p>所需准备：</p>
<ol>
<li>所有资源机器，确保时间一致</li>
</ol>
<h1>监控端组件</h1>
<p>搞之前，先创建一个网络</p>
<p>docker network create promsnet</p>
<h2 id="grafana-界面">grafana 界面</h2>
<blockquote>
<p>数据展示，部署在 proms 端</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker volume create grafana</span><br><span class="line">docker run -d \</span><br><span class="line">  --network promsnet \</span><br><span class="line">  --name grafana \</span><br><span class="line">  --mount <span class="string">&#x27;type=volume,src=grafana,dst=/var/lib/grafana&#x27;</span> \</span><br><span class="line">  -p 3000:3000 \</span><br><span class="line">grafana/grafana</span><br></pre></td></tr></table></figure>
<blockquote>
<p>默认账户/初始密码都是admin</p>
</blockquote>
<h2 id="alertmanager-告警管理">alertmanager 告警管理</h2>
<blockquote>
<p>告警管理器，部署在 proms 端</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker volume create alertmanager</span><br><span class="line">docker run --name alertmanager -d \</span><br><span class="line">  --network promsnet \</span><br><span class="line">  -p 9093:9093 \</span><br><span class="line">  --mount <span class="string">&#x27;type=volume,src=alertmanager,dst=/etc/alertmanager&#x27;</span> \</span><br><span class="line">prom/alertmanager</span><br></pre></td></tr></table></figure>
<ul>
<li>alertmanager.yml</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  group_interval: 10s</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  receiver: <span class="string">&#x27;wechat&#x27;</span></span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">&#x27;wechat&#x27;</span></span><br><span class="line">  wechat_configs:</span><br><span class="line">  - corp_id: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    to_user: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    agent_id: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    api_secret: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    send_resolved: <span class="literal">true</span></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    target_match:</span><br><span class="line">      severity: <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    equal: [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>上面是微信的，你也可以webhook方式，来走其它方式，例如飞书/钉钉</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line"></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  group_interval: 10s</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  receiver: <span class="string">&#x27;web.hook.prometheusalert&#x27;</span></span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">&#x27;web.hook.prometheusalert&#x27;</span></span><br><span class="line">  webhook_configs:</span><br><span class="line">  - url: <span class="string">&#x27;&#x27;</span></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    target_match:</span><br><span class="line">      severity: <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    equal: [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>💁飞书/钉钉，可以用 <a target="_blank" rel="noopener" href="https://gitee.com/feiyu563/PrometheusAlert">PrometheusAlert</a></p>
<h2 id="Peometheus-主程">Peometheus 主程</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir /<span class="built_in">export</span>/docker-data-proms/&#123;data,conf&#125; -p</span><br><span class="line">chmod 777 /<span class="built_in">export</span>/docker-data-proms/data</span><br></pre></td></tr></table></figure>
<ul>
<li>prometheus.yml (写入到 /export/docker-data-proms/promethesu.yml)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><br><span class="line">rule_files:</span><br><span class="line">  - &quot;&#x2F;etc&#x2F;prometheus&#x2F;conf&#x2F;rules&#x2F;*.yml&quot;</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#39;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label &#96;job&#x3D;&lt;job_name&gt;&#96; to any timeseries scraped from this config.</span><br><span class="line">#  - job_name: &#39;prometheus&#39;</span><br><span class="line">#    static_configs:</span><br><span class="line">#    - targets: [&#39;proms:9090&#39;]</span><br><span class="line"></span><br><span class="line">#  - job_name: &quot;grafana&quot;</span><br><span class="line">#    static_configs:</span><br><span class="line">#    - targets: [&#39;grafana:3000&#39;]</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;dockersInfo&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;10.3.128.250:10052&#39;,&#39;47.92.212.25:10052&#39;]</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;node_exporter&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&#39;10.3.128.250:9100&#39;,&#39;47.92.212.25:9100&#39;]</span><br></pre></td></tr></table></figure>
<ul>
<li>rules.yml (写入到 /export/docker-data-proms/conf/rules/)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># node-exporter-record-rules.yml</span></span><br><span class="line"><span class="comment"># 标签 job 关联主配置定义的任务 node_exporter，获取任务传递的数据，从而抽取信息定义 expr</span></span><br><span class="line"><span class="comment"># 给 expr 表达式设置一个别名 record, 别名可以被其它 rules 调用</span></span><br><span class="line"></span><br><span class="line">groups:</span><br><span class="line">  - name: node_exporter-exist</span><br><span class="line">    rules:</span><br><span class="line">    - expr: up&#123;job=~<span class="string">&quot;node_exporter&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:up</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点是否在线, 在线1,不在线0&quot;</span></span><br><span class="line">        unit: <span class="string">&quot; &quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line">    - expr: time() - node_boot_time_seconds&#123;&#125;</span><br><span class="line">      record: node_exporter:node_uptime</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的运行时间&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;s&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"><span class="comment">##############################################################################################</span></span><br><span class="line"><span class="comment">#                              cpu                                                           #</span></span><br><span class="line">    - expr: (1 - avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;[5m])))  * 100</span><br><span class="line">      record: node_exporter:cpu:total:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的cpu总消耗百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;[5m])))  * 100</span><br><span class="line">      record: node_exporter:cpu:idle:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的cpu idle百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>,mode=<span class="string">&quot;iowait&quot;</span>&#125;[5m])))  * 100</span><br><span class="line">      record: node_exporter:cpu:iowait:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的cpu iowait百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>,mode=<span class="string">&quot;system&quot;</span>&#125;[5m])))  * 100</span><br><span class="line">      record: node_exporter:cpu:system:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的cpu system百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>,mode=<span class="string">&quot;user&quot;</span>&#125;[5m])))  * 100</span><br><span class="line">      record: node_exporter:cpu:user:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的cpu user百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>,mode=~<span class="string">&quot;softirq|nice|irq|steal&quot;</span>&#125;[5m])))  * 100</span><br><span class="line">      record: node_exporter:cpu:other:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的cpu 其他的百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"><span class="comment">##############################################################################################</span></span><br><span class="line"><span class="comment">#                                    memory                                                  #</span></span><br><span class="line">    - expr: node_memory_MemTotal_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:memory:total</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的内存总量&quot;</span></span><br><span class="line">        unit: byte</span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_memory_MemFree_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:memory:free</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的剩余内存量&quot;</span></span><br><span class="line">        unit: byte</span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_memory_MemTotal_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125; - node_memory_MemFree_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:memory:used</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的已使用内存量&quot;</span></span><br><span class="line">        unit: byte</span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_memory_MemTotal_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125; - node_memory_MemAvailable_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:memory:actualused</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点用户实际使用的内存量&quot;</span></span><br><span class="line">        unit: byte</span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: (1-(node_memory_MemAvailable_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125; / (node_memory_MemTotal_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;)))* 100</span><br><span class="line">      record: node_exporter:memory:used:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的内存使用百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: ((node_memory_MemAvailable_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125; / (node_memory_MemTotal_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;)))* 100</span><br><span class="line">      record: node_exporter:memory:free:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的内存剩余百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"><span class="comment">##############################################################################################</span></span><br><span class="line"><span class="comment">#                                   load                                                     #</span></span><br><span class="line">    - expr: sum by (instance) (node_load1&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;)</span><br><span class="line">      record: node_exporter:load:load1</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;系统1分钟负载&quot;</span></span><br><span class="line">        unit: <span class="string">&quot; &quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: sum by (instance) (node_load5&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;)</span><br><span class="line">      record: node_exporter:load:load5</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;系统5分钟负载&quot;</span></span><br><span class="line">        unit: <span class="string">&quot; &quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: sum by (instance) (node_load15&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;)</span><br><span class="line">      record: node_exporter:load:load15</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;系统15分钟负载&quot;</span></span><br><span class="line">        unit: <span class="string">&quot; &quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################</span></span><br><span class="line"><span class="comment">#                                 disk                                                       #</span></span><br><span class="line">    - expr: node_filesystem_size_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span> ,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:disk:usage:total</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的磁盘总量&quot;</span></span><br><span class="line">        unit: byte</span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_filesystem_avail_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:disk:usage:free</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的磁盘剩余空间&quot;</span></span><br><span class="line">        unit: byte</span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_filesystem_size_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125; - node_filesystem_avail_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:disk:usage:used</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的磁盘使用的空间&quot;</span></span><br><span class="line">        unit: byte</span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr:  (1 - node_filesystem_avail_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125; / node_filesystem_size_bytes&#123;job=<span class="string">&quot;node_exporter&quot;</span>,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125;) * 100</span><br><span class="line">      record: node_exporter:disk:used:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的磁盘的使用百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: irate(node_disk_reads_completed_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;[1m])</span><br><span class="line">      record: node_exporter:disk:<span class="built_in">read</span>:count:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的磁盘读取速率&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;次/秒&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: irate(node_disk_writes_completed_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;[1m])</span><br><span class="line">      record: node_exporter:disk:write:count:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的磁盘写入速率&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;次/秒&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: (irate(node_disk_written_bytes_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;[1m]))/1024/1024</span><br><span class="line">      record: node_exporter:disk:<span class="built_in">read</span>:mb:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的设备读取MB速率&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;MB/s&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: (irate(node_disk_read_bytes_total&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;[1m]))/1024/1024</span><br><span class="line">      record: node_exporter:disk:write:mb:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的设备写入MB速率&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;MB/s&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################################</span></span><br><span class="line"><span class="comment">#                                filesystem                                                  #</span></span><br><span class="line">    - expr:   (1 -node_filesystem_files_free&#123;job=<span class="string">&quot;node_exporter&quot;</span>,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125; / node_filesystem_files&#123;job=<span class="string">&quot;node_exporter&quot;</span>,fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125;) * 100</span><br><span class="line">      record: node_exporter:filesystem:used:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的inode的剩余可用的百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br><span class="line"><span class="comment">#                                filefd                                                     #</span></span><br><span class="line">    - expr: node_filefd_allocated&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:filefd_allocated:count</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的文件描述符打开个数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_filefd_allocated&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;/node_filefd_maximum&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125; * 100</span><br><span class="line">      record: node_exporter:filefd_allocated:percent</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的文件描述符打开百分比&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;%&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br><span class="line"><span class="comment">#                                network                                                    #</span></span><br><span class="line">    - expr: avg by (environment,instance,device) (irate(node_network_receive_bytes_total&#123;device=~<span class="string">&quot;eth0|eth1|ens33|ens37&quot;</span>&#125;[1m]))</span><br><span class="line">      record: node_exporter:network:netin:bit:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点网卡eth0每秒接收的比特数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;bit/s&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: avg by (environment,instance,device) (irate(node_network_transmit_bytes_total&#123;device=~<span class="string">&quot;eth0|eth1|ens33|ens37&quot;</span>&#125;[1m]))</span><br><span class="line">      record: node_exporter:network:netout:bit:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点网卡eth0每秒发送的比特数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;bit/s&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: avg by (environment,instance,device) (irate(node_network_receive_packets_total&#123;device=~<span class="string">&quot;eth0|eth1|ens33|ens37&quot;</span>&#125;[1m]))</span><br><span class="line">      record: node_exporter:network:netin:packet:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点网卡每秒接收的数据包个数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个/秒&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: avg by (environment,instance,device) (irate(node_network_transmit_packets_total&#123;device=~<span class="string">&quot;eth0|eth1|ens33|ens37&quot;</span>&#125;[1m]))</span><br><span class="line">      record: node_exporter:network:netout:packet:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点网卡发送的数据包个数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个/秒&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: avg by (environment,instance,device) (irate(node_network_receive_errs_total&#123;device=~<span class="string">&quot;eth0|eth1|ens33|ens37&quot;</span>&#125;[1m]))</span><br><span class="line">      record: node_exporter:network:netin:error:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点设备驱动器检测到的接收错误包的数量&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个/秒&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: avg by (environment,instance,device) (irate(node_network_transmit_errs_total&#123;device=~<span class="string">&quot;eth0|eth1|ens33|ens37&quot;</span>&#125;[1m]))</span><br><span class="line">      record: node_exporter:network:netout:error:rate</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点设备驱动器检测到的发送错误包的数量&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个/秒&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_tcp_connection_states&#123;job=<span class="string">&quot;node_exporter&quot;</span>, state=<span class="string">&quot;established&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:network:tcp:established:count</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点当前established的个数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: node_tcp_connection_states&#123;job=<span class="string">&quot;node_exporter&quot;</span>, state=<span class="string">&quot;time_wait&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:network:tcp:timewait:count</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点timewait的连接数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"></span><br><span class="line">    - expr: sum by (environment,instance) (node_tcp_connection_states&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;)</span><br><span class="line">      record: node_exporter:network:tcp:total:count</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点tcp连接总数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br><span class="line"><span class="comment">#                                process                                                    #</span></span><br><span class="line">    - expr: node_processes_state&#123;state=<span class="string">&quot;Z&quot;</span>&#125;</span><br><span class="line">      record: node_exporter:process:zoom:total:count</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点当前状态为zoom的个数&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;个&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br><span class="line"><span class="comment">#                                other                                                    #</span></span><br><span class="line">    - expr: abs(node_timex_offset_seconds&#123;job=<span class="string">&quot;node_exporter&quot;</span>&#125;)</span><br><span class="line">      record: node_exporter:time:offset</span><br><span class="line">      labels:</span><br><span class="line">        desc: <span class="string">&quot;节点的时间偏差&quot;</span></span><br><span class="line">        unit: <span class="string">&quot;s&quot;</span></span><br><span class="line">        job: <span class="string">&quot;node_exporter&quot;</span></span><br><span class="line"><span class="comment">#############################################################################################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">    - expr: count by (instance) ( count by (instance,cpu) (node_cpu_seconds_total&#123; mode=<span class="string">&#x27;system&#x27;</span>&#125;) )</span><br><span class="line">      record: node_exporter:cpu:count</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># node-exporter-alert-rules.yml</span></span><br><span class="line"><span class="comment"># 定义告警规则</span></span><br><span class="line"><span class="comment"># 通过前一个 rules 文件拿到定义的 record 别名来编写 expr 判断式</span></span><br><span class="line"><span class="comment"># 这里定义的告警规则，在触发的时候，都会传递到 alertmanager，最后从传递的信息中抽取所需数据发送给目标人。</span></span><br><span class="line">groups:</span><br><span class="line">  - name: node-alert</span><br><span class="line">    rules:</span><br><span class="line">    - alert: node-down</span><br><span class="line">      expr: node_exporter:up == 0</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 宕机了&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line">    - alert: node-cpu-high</span><br><span class="line">      expr:  node_exporter:cpu:total:percent &gt; 80</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; cpu 使用率高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-cpu-iowait-high</span><br><span class="line">      expr:  node_exporter:cpu:iowait:percent &gt;= 12</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; cpu iowait 使用率高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-load-load1-high</span><br><span class="line">      expr:  (node_exporter:load:load1) &gt; (node_exporter:cpu:count) * 1.2</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; load1 使用率高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-memory-high</span><br><span class="line">      expr:  node_exporter:memory:used:percent &gt; 85</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;内存使用率高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-disk-high</span><br><span class="line">      expr:  node_exporter:disk:used:percent &gt; 80</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.device &#125;&#125;:&#123;&#123; <span class="variable">$labels</span>.mountpoint &#125;&#125; 使用率高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-disk-read:count-high</span><br><span class="line">      expr:  node_exporter:disk:<span class="built_in">read</span>:count:rate &gt; 3000</span><br><span class="line">      <span class="keyword">for</span>: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; iops read 使用率高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-disk-write-count-high</span><br><span class="line">      expr:  node_exporter:disk:write:count:rate &gt; 3000</span><br><span class="line">      <span class="keyword">for</span>: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; iops write 使用率高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-disk-read-mb-high</span><br><span class="line">      expr:  node_exporter:disk:<span class="built_in">read</span>:mb:rate &gt; 60</span><br><span class="line">      <span class="keyword">for</span>: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 读取字节数 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-disk-write-mb-high</span><br><span class="line">      expr:  node_exporter:disk:write:mb:rate &gt; 60</span><br><span class="line">      <span class="keyword">for</span>: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 写入字节数 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-filefd-allocated-percent-high</span><br><span class="line">      expr:  node_exporter:filefd_allocated:percent &gt; 80</span><br><span class="line">      <span class="keyword">for</span>: 10m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 打开文件描述符 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-network-netin-error-rate-high</span><br><span class="line">      expr:  node_exporter:network:netin:error:rate &gt; 4</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 包进入的错误速率 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line">    - alert: node-network-netin-packet-rate-high</span><br><span class="line">      expr:  node_exporter:network:netin:packet:rate &gt; 35000</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 包进入速率 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-network-netout-packet-rate-high</span><br><span class="line">      expr:  node_exporter:network:netout:packet:rate &gt; 35000</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 包流出速率 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-network-tcp-total-count-high</span><br><span class="line">      expr:  node_exporter:network:tcp:total:count &gt; 40000</span><br><span class="line">      <span class="keyword">for</span>: 1m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; tcp连接数量 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-process-zoom-total-count-high</span><br><span class="line">      expr:  node_exporter:process:zoom:total:count &gt; 10</span><br><span class="line">      <span class="keyword">for</span>: 10m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; 僵死进程数量 高于 &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br><span class="line"></span><br><span class="line">    - alert: node-time-offset-high</span><br><span class="line">      expr:  node_exporter:time:offset &gt; 0.03</span><br><span class="line">      <span class="keyword">for</span>: 2m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;instance: &#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &#123;&#123; <span class="variable">$labels</span>.desc &#125;&#125;  &#123;&#123; <span class="variable">$value</span> &#125;&#125;&#123;&#123; <span class="variable">$labels</span>.unit &#125;&#125;&quot;</span></span><br><span class="line">        grafana: <span class="string">&quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; <span class="variable">$labels</span>.instance &#125;&#125; &quot;</span></span><br><span class="line">        console: <span class="string">&quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;</span></span><br><span class="line">        cloudmonitor: <span class="string">&quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;</span></span><br><span class="line">        id: <span class="string">&quot;&#123;&#123; <span class="variable">$labels</span>.instanceid &#125;&#125;&quot;</span></span><br><span class="line">        <span class="built_in">type</span>: <span class="string">&quot;aliyun_meta_ecs_info&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 暂时无用的规则</span></span><br><span class="line">groups:</span><br><span class="line">  - name: ap-southeast-1服务器告警</span><br><span class="line">    rules:</span><br><span class="line">    - alert: 服务器宕机告警</span><br><span class="line">      expr: up == 0</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        region: ap-southeast-1</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;宕机！&quot;</span></span><br><span class="line">        description: <span class="string">&quot;服务器&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;已宕机！&quot;</span></span><br><span class="line">    - alert: cpu使用率过高告警</span><br><span class="line">      expr: (100 - (avg(irate(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[5m])) by(instance)* 100))* on(instance) group_left(nodename) (node_uname_info) &gt; 30</span><br><span class="line">      <span class="keyword">for</span>: 5m</span><br><span class="line">      labels:</span><br><span class="line">        region: ap-southeast-1</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;（&#123;&#123;<span class="variable">$labels</span>.nodename&#125;&#125;）CPU使用率过高！&quot;</span></span><br><span class="line">        description: <span class="string">&#x27;服务器&#123;&#123;$labels.instance&#125;&#125;（&#123;&#123;$labels.nodename&#125;&#125;）CPU使用率超过85%(目前使用:&#123;&#123;printf &quot;%.2f&quot; $value&#125;&#125;%)&#x27;</span></span><br><span class="line">    - alert: 系统负载过高</span><br><span class="line">      expr: (node_load1/count without (cpu, mode) (node_cpu_seconds_total&#123;mode=<span class="string">&quot;system&quot;</span>&#125;))* on(instance) group_left(nodename) (node_uname_info)&gt;1.1</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        region: ap-southeast-1</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;（&#123;&#123;<span class="variable">$labels</span>.nodename&#125;&#125;）系统负载过高！&quot;</span></span><br><span class="line">        description: <span class="string">&#x27;&#123;&#123;$labels.instance&#125;&#125;（&#123;&#123;$labels.nodename&#125;&#125;）当前负载超标率 &#123;&#123;printf &quot;%.2f&quot; $value&#125;&#125;&#x27;</span></span><br><span class="line">    - alert: 内存不足告警</span><br><span class="line">      expr: (100 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100)* on(instance) group_left(nodename) (node_uname_info) &gt; 80</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        region: ap-southeast-1</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;（&#123;&#123;<span class="variable">$labels</span>.nodename&#125;&#125;）内存使用率过高！&quot;</span></span><br><span class="line">        description: <span class="string">&#x27;服务器&#123;&#123;$labels.instance&#125;&#125;（&#123;&#123;$labels.nodename&#125;&#125;）内存使用率超过80%(目前使用:&#123;&#123;printf &quot;%.2f&quot; $value&#125;&#125;%)&#x27;</span></span><br><span class="line">    - alert: 硬盘空间不足告警</span><br><span class="line">      expr: (100-(node_filesystem_free_bytes&#123;fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125;/node_filesystem_size_bytes &#123;fstype=~<span class="string">&quot;ext4|xfs&quot;</span>&#125;*100) )* on(instance) group_left(nodename) (node_uname_info)&gt; 80</span><br><span class="line">      <span class="keyword">for</span>: 3m</span><br><span class="line">      labels:</span><br><span class="line">        region: ap-southeast-1</span><br><span class="line">      annotations:</span><br><span class="line">        summary: <span class="string">&quot;&#123;&#123;<span class="variable">$labels</span>.instance&#125;&#125;（&#123;&#123;<span class="variable">$labels</span>.nodename&#125;&#125;）硬盘使用率过高！&quot;</span></span><br><span class="line">        description: <span class="string">&#x27;服务器&#123;&#123;$labels.instance&#125;&#125;（&#123;&#123;$labels.nodename&#125;&#125;）硬盘使用率超过80%(目前使用:&#123;&#123;printf &quot;%.2f&quot; $value&#125;&#125;%)&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>docker</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--network promsnet \</span><br><span class="line">-p 9090:9090 \</span><br><span class="line">--name proms \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-proms/prometheus.yml,dst=/etc/prometheus/prometheus.yml&#x27;</span>  \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-proms/data,dst=/prometheus&#x27;</span> \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-proms/conf,dst=/etc/prometheus/conf&#x27;</span> \</span><br><span class="line">prom/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/prometheus --storage.tsdb.retention=30d</span><br></pre></td></tr></table></figure>
<ul>
<li>二进制</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.20.0/prometheus-2.20.0.linux-amd64.tar.gz</span><br><span class="line">mkdir prometheus</span><br><span class="line">tar xf prometheus-2.20.0.linux-amd64.tar.gz --strip-components 1 -C prometheus</span><br><span class="line">rm -rf prometheus-2.20.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> prometheus &amp;&amp; baseDir=`<span class="built_in">pwd</span>`</span><br><span class="line">cp prometheus.yml&#123;,.bak&#125; </span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=prometheus server daemon</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Restart=on-failure</span><br><span class="line">ExecStart=<span class="variable">$&#123;baseDir&#125;</span>/prometheus --config.file=<span class="variable">$&#123;baseDir&#125;</span>/prometheus.yml</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start prometheus</span><br></pre></td></tr></table></figure>
<p>被监控端状态：<a target="_blank" rel="noopener" href="http://xxx:9090/targets">http://xxx:9090/targets</a></p>
<p>通过上述地址，你可以看到配置中 job_name 定义的被监控任务的状态</p>
<p><img src="/posts/65820315/image-20201218112329166.png" alt="image-20201218112329166"></p>
<h2 id="pushgateway-初期用不上的组件">pushgateway (初期用不上的组件)</h2>
<blockquote>
<p>push 模式下的网关</p>
<p>当前没有现成的推送模式的 node-exporter</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker</span></span><br><span class="line">docker run -d --name=pushgateway -p 9091:9091 prom/pushgateway</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 一个推送模式的采集脚本示例</span></span><br><span class="line"><span class="comment"># cat tcpestab.sh </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 添加脚本到计划任务中，定时采集</span></span><br><span class="line"><span class="comment"># pushgateway ip</span></span><br><span class="line">pushgatewayIp=</span><br><span class="line"><span class="comment">#获取主机名，常传输到Prometheus标签以主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d<span class="string">&#x27;.&#x27;</span> -f1`</span><br><span class="line"><span class="comment">#判断主机名不能是localhost不然发送过的数据不知道是那个主机的 </span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$instance_name</span> == <span class="string">&quot;localhost&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hostname must not localhost&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#自定义key，在Prometheus即可使用key查询</span></span><br><span class="line">label=<span class="string">&quot;count_estab_connections&quot;</span> </span><br><span class="line"><span class="comment">#获取TCP estab 连接数</span></span><br><span class="line">count_estab_connections=`netstat -an | grep -i <span class="string">&#x27;established&#x27;</span> | wc -l`</span><br><span class="line"><span class="comment">#将数据发送到pushgateway固定格式</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$label</span> <span class="variable">$count_estab_connections</span>&quot;</span>  | curl --data-binary @- http://<span class="variable">$pushgatewayIp</span>:9091/metrics/job/pushgateway/instance/<span class="variable">$instance_name</span></span><br></pre></td></tr></table></figure>
<h1>被监控端组件</h1>
<h2 id="node-exporter-物理节点监控">node-exporter 物理节点监控</h2>
<blockquote>
<p>宿主数据采集端，部署在被监控主机的9100端口</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span></span><br><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span> &amp;&amp; mkdir node_exporter</span><br><span class="line">tar xf node_exporter-1.0.1.linux-amd64.tar.gz --strip-components 1 -C node_exporter</span><br><span class="line">mkdir src</span><br><span class="line">mv node_exporter-1.0.1.linux-amd64.tar.gz src</span><br><span class="line"><span class="built_in">cd</span> node_exporter &amp;&amp; baseDir=`<span class="built_in">pwd</span>`</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/node_exporter.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=node_exporter server daemon</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Restart=on-failure</span><br><span class="line">ExecStart=<span class="variable">$&#123;baseDir&#125;</span>/node_exporter</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start node_exporter</span><br><span class="line">systemctl status node_exporter</span><br><span class="line">curl http://localhost:9100/metrics <span class="comment"># 查看获取的监控数据</span></span><br></pre></td></tr></table></figure>
<h2 id="cadvisor-容器监控">cadvisor 容器监控</h2>
<blockquote>
<p>容器数据采集端，部署在被监控容器所在宿主的10052端口</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dockerRoot=`docker info | awk -F<span class="string">&#x27;:&#x27;</span>  <span class="string">&#x27;/Docker Root Dir/&#123;print $2&#125;&#x27;</span>|sed <span class="string">&#x27;s@^ *@@g&#x27;</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$dockerRoot</span></span><br><span class="line">docker run \</span><br><span class="line">  --volume=/:/rootfs:ro \</span><br><span class="line">  --volume=/var/run:/var/run:rw \</span><br><span class="line">  --volume=/sys:/sys:ro \</span><br><span class="line">  --volume=<span class="variable">$&#123;dockerRoot&#125;</span>/:/var/lib/docker:ro \</span><br><span class="line">  --volume=/dev/disk/:/dev/disk:ro \</span><br><span class="line">  --publish=10052:8080 \</span><br><span class="line">  --privileged=<span class="literal">true</span> \</span><br><span class="line">  --detach=<span class="literal">true</span> \</span><br><span class="line">  --name=cadvisor \</span><br><span class="line">  google/cadvisor:latest</span><br></pre></td></tr></table></figure>
<h1>使用</h1>
<h2 id="添加-grafana-数据源-proms">添加 grafana 数据源 : proms</h2>
<p><img src="/posts/65820315/image-20201218135400147.png" alt="image-20201218135400147"></p>
<h2 id="添加-grafana-监控模板">添加 grafana 监控模板</h2>
<p><img src="/posts/65820315/image-20201218135502105.png" alt="image-20201218135502105"></p>
<p>node模板：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/8919">https://grafana.com/grafana/dashboards/8919</a></p>
<p>docker模板：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/10566">https://grafana.com/grafana/dashboards/10566</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zyh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zyh.cool/posts/65820315/">https://zyh.cool/posts/65820315/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zyh.cool">zyh</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Peometheus/">Peometheus</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5ebcbd4086e8aa2b" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/posts/e1096625/"><i class="fa fa-chevron-left">  </i><span>k8s☞记录点</span></a></div><div class="next-post pull-right"><a href="/posts/ed865d2f/"><span>zabbix ☞ server安装注意事项</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '5d6fb59b1508af7318d7',
  clientSecret: 'bca058cc7e0b4b62ce5d43b046bb18d9484e5163',
  repo: 'zyh.github.io',
  owner: 'Spinestars',
  admin: 'Spinestars',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By zyh</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to <a href="https://zyh.cool">zyh.cool</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>