<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		prometheus☞搭建 | 
	 
	zyh
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	


	<!-- search -->
	<script>
		var searchEngine = "https://www.google.com/search?q=";
		if(typeof searchEngine == "undefined" || searchEngine == null || searchEngine == ""){
			searchEngine = "https://www.google.com/search?q=";
		}
		var homeHost = "zyh.cool";
		if(typeof homeHost == "undefined" || homeHost == null || homeHost == ""){
			homeHost = window.location.host;
		}
	</script>


	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">


	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>

	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@v1.4.14/dist/Valine.min.js"></script>

	
	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
	<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d8eaf4579517c8bea955331f62e2b380";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<header id="header">
    <a id="title" href="/" class="logo">zyh</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">ABOUT</a>
		</li>
	
		<li class="menu-item">
			<a href="/tags" class="menu-item-link">标签</a>
		</li>
	

	
		<li class="menu-item">
			<a href="/categories" class="menu-item-link">分类</a>
		</li>
	
		<li class="menu-item">
			<a href="https://github.com/Spinestars" class="menu-item-link" target="_blank">
				<i class="fa fa-github fa-2x"></i>
			</a>
		</li>
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="search" placeholder="按回车全站搜索">
		<div id="tree">
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										web
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										fpm
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/b73a61bf/">
                     
										    fpm☞安装-包管理方式
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3321a2dc/">
                     
										    fpm☞安装-编译方式
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d1d65c30/">
                     
										    fpm☞静态配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										nginx
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/2722921e/">
                     
										    nginx-常用变量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/58a1c0c7/">
                     
										    nginx☞fcgi中alias的使用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4c513678/">
                     
										    nginx☞location
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/18de0eed/">
                     
										    nginx☞基本认证
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6209085/">
                     
										    nginx☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9fb0f3a1/">
                     
										    nginx☞日志切割
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/78ceb386/">
                     
										    nginx☞泛域名_变量截取
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6332ca50/">
                     
										    nginx☞问题集
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/7c44c2e8/">
                     
										    web☞服务器承载能力计算
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										公有云
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										aws
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/2e07203a/">
                     
										    aws☞EC2-GPU实例安装显卡驱动
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/438aa722/">
                     
										    aws☞rds-mysql参数
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/604c5952/">
                     
										    aws☞rds-mysql日志
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2c5a64ff/">
                     
										    aws☞s3初始化创建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7cac5d21/">
                     
										    aws☞s3跨账户访问
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ddc4c969/">
                     
										    aws☞利用cf服务初始化aws环境
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2e304ad6/">
                     
										    aws☞国内外之间迁移-AMI
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										阿里云
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/bd60be5f/">
                     
										    aliyun-ack_ingress
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6723fbb4/">
                     
										    aliyun-k8s_svc绑定固定ELB
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6df9bb76/">
                     
										    aliyun☞cli安装和基本调用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b5d7d6ee/">
                     
										    aliyun☞oss
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4cc38acc/">
                     
										    aliyun☞常见问题
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										git
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/a38d0013/">
                     
										    gitlab☞大版本迁移
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3f38f454/">
                     
										    gitlab☞安装及备份
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5edc3545/">
                     
										    gitlab☞批量修改用户密码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f0c6f6c3/">
                     
										    git☞常用命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										hexo
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/662e9d4d/">
                     
										    hexo☞图片显示404错误的解决办法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f5c218d/">
                     
										    hexo☞本地搜索
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a4903823/">
                     
										    jira-备份文档
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7c1abbe1/">
                     
										    openvpn☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/894f9595/">
                     
										    vsftpd☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3827a60a/">
                     
										    工具库
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/248f8ccf/">
                     
										    开发-认证机制[转载]
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/40d986c3/">
                     
										    网络-SNAT和DNAT
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f68976bc/">
                     
										    网络-华为路由器vlan划分
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5290b79d/">
                     
										    网络☞S5700配置攻击朔源
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6f53a6b8/">
                     
										    网络☞链路聚合
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1ddb9d4e/">
                     
										    问题记录
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										容器
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										docker
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/cdd230fc/">
                     
										    docker-多阶段构建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/634b48fb/">
                     
										    docker-常用的指令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b7cf7b1f/">
                     
										    docker☞01安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/604e367f/">
                     
										    docker☞非root用户执行程序
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										harbor
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/9573a87d/">
                     
										    harbor☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										helm
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/51015304/">
                     
										    helm☞01入门
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/710e3e49/">
                     
										    helm☞02chart
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										k8s
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/74e7acf4/">
                     
										    k8s-22自定义hpa
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/87e37b21/">
                     
										    k8s-安全上下文
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/aaf9b7/">
                     
										    k8s☞01常见术语概念
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c3c9f0f8/">
                     
										    k8s☞02-1切换使用runtime-containerd
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9602dad/">
                     
										    k8s☞02安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/94518966/">
                     
										    k8s☞03Pod
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3ec72f7e/">
                     
										    k8s☞04Pod-init容器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9aa66899/">
                     
										    k8s☞05容器生命周期-回调和探针
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/18e4fa73/">
                     
										    k8s☞06无状态服务deployment
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f6e328b5/">
                     
										    k8s☞07自动扩缩
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d3b80b5f/">
                     
										    k8s☞08负载均衡service
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1080c6b6/">
                     
										    k8s☞09存储资源
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4b0e4a5/">
                     
										    k8s☞10应用配置与密码与信息提供
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/64fa9c84/">
                     
										    k8s☞11-1pod资源约束
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ed4c29d5/">
                     
										    k8s☞11-2namespace资源约束
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/63d8d3d4/">
                     
										    k8s☞12-1DaemonSet
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4bf29cf0/">
                     
										    k8s☞12-2有状态服务StatefulSet
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5d39569c/">
                     
										    k8s☞13-1 ingress-nginx的各种用法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7627a41d/">
                     
										    k8s☞13高级版负载均衡ingress控制器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a5ed67a6/">
                     
										    k8s☞14认证授权
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/55da993d/">
                     
										    k8s☞15证书管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7538d100/">
                     
										    k8s☞16kubeadm集群升级
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/932d1f08/">
                     
										    k8s☞17-1调度之node污染和pod容忍
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4d69fc4a/">
                     
										    k8s☞17-2调度之亲和性和反亲和性
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/451721ed/">
                     
										    k8s☞18日志收集系统
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ce23a4a1/">
                     
										    k8s☞19日志系统EFK
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/68c615a7/">
                     
										    k8s☞20网络cni
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e902d670/">
                     
										    k8s☞21证书管理器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c15432fa/">
                     
										    k8s☞kubectl多集群管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9a7bc037/">
                     
										    k8s☞showdoc部署
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/106410b0/">
                     
										    k8s☞常用命令记录
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e1096625/">
                     
										    k8s☞记录点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										数据库
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										mysql
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/a1d2702d/">
                     
										    mysql-主从同步
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d73c1236/">
                     
										    mysql-联合索引
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b824edd8/">
                     
										    mysql☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e6ae9474/">
                     
										    mysql☞常用命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c83ca575/">
                     
										    mysql☞离线迁移脚本
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										pgsql
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/684ab210/">
                     
										    pgsql-基础命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										redis
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/65ab632a/">
                     
										    redis-001安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2c2d50a0/">
                     
										    redis-002备份
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/28361833/">
                     
										    redis-003内存紧张bgsave失败
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/783b242a/">
                     
										    redis-004主从复制知识
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/847734cb/">
                     
										    redis-005主从复制和哨兵配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5067cdc/">
                     
										    redis-006获取没有设置TTL的key
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										日志
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										ELK
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/13e95dda/">
                     
										    日志-06Elasticsearch索引生命周期
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f8ca35d2/">
                     
										    日志☞00ELK基本使用-简介
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3475106c/">
                     
										    日志☞01ELK基本使用-beats组件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f73d84da/">
                     
										    日志☞02ELK基本使用-logstash组件01-安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/56da51f2/">
                     
										    日志☞03ELK基本使用-logstash组件02-插件介绍
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/41bf4066/">
                     
										    日志☞04ELK基本使用-elasticsearch
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d8390732/">
                     
										    日志☞05ELK基本使用-kibana
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/421d605e/">
                     
										    日志☞logrotate安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										消息
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										kafka
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/9bd7430f/">
                     
										    001-kafka基本信息
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/bd4c8d1c/">
                     
										    002-kafka基本安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2fb0e26c/">
                     
										    003-kafka基本认证
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/14fdb3fd/">
                     
										    004-kafka用户配额
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/124a3d6d/">
                     
										    005-kafka基本维护
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1a545f72/">
                     
										    006-kafka基本监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/41d19ce/">
                     
										    007-kafka基本保活
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										rabbitmq
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/188d54be/">
                     
										    rabbitmq-集群相关概念
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b43013ef/">
                     
										    rabbitmq☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										监控
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										prometheus
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/e55f0a09/">
                     
										    prometheus-07k8s-coredns
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1bafff65/">
                     
										    prometheus-08k8s-node
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/posts/65820315/">
                     
										    prometheus☞01搭建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e172b6e2/">
                     
										    prometheus☞02外置prometheus监控k8s
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/bced4977/">
                     
										    prometheus☞03k8s内置部署
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/978d0c1d/">
                     
										    prometheus☞04redis监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6178b477/">
                     
										    prometheus☞05mysql监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7fd13722/">
                     
										    prometheus☞06rabbitmq监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										zabbix
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/3d20f83e/">
                     
										    zabbix☞WEB监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1587f6e8/">
                     
										    zabbix☞agent和proxy(yum)
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b35b5965/">
                     
										    zabbix☞nginx
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6c093771/">
                     
										    zabbix☞redis
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ed865d2f/">
                     
										    zabbix☞server安装注意事项
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/25f36846/">
                     
										    zabbix☞容器搭建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4ebbd3a8/">
                     
										    zabbix☞预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/ae41ae33/">
                     
										    监控☞monit
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ab1247fb/">
                     
										    监控☞mysql慢sql预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8c33f887/">
                     
										    监控☞企业微信机器人
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f9b08c30/">
                     
										    监控☞微信预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1fac36d/">
                     
										    监控☞远程磁盘检测
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f8f9b4d0/">
                     
										    监控☞邮件预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										系统
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										linux
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/3dd05018/">
                     
										    linux-vim中文乱码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c3b69c28/">
                     
										    linux-添加ssh登陆限制
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/13364d65/">
                     
										    linux☞centos7重置root密码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a3dfc0e8/">
                     
										    linux☞df与du数据不一致的原因
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5db0cd07/">
                     
										    linux☞ssh-MFA自动登陆
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e4f7ce4c/">
                     
										    linux☞ubuntu20-04纯命令行网卡配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7b3cf3d8/">
                     
										    linux☞使用expect自动登录ssh后远程会话不会跟随本地会话缩放的问题
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d2fed0bf/">
                     
										    linux☞利用acme-sh管理免费的ssl证书申请
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/cd32aa48/">
                     
										    linux☞时间
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f41d0763/">
                     
										    linux☞系统内核优化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a7611bc1/">
                     
										    linux☞软raid创建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3988a5f2/">
                     
										    linux☞输出个性化开机状态
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										windows
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/348cba53/">
                     
										    windows-wsl问题点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/22b82d75/">
                     
										    windows-包管理工具-scoop
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/88eb7b6/">
                     
										    windows☞win10迁移数据
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										自动化
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										ansible
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/15aa7d2e/">
                     
										    ansible☞playbook-aws
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b0929188/">
                     
										    ansible☞playbook-handle
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6ce01f58/">
                     
										    ansible☞playbook-include
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/25732c33/">
                     
										    ansible☞playbook-lookup插件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/960fc783/">
                     
										    ansible☞playbook-tags
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4235ddf4/">
                     
										    ansible☞playbook-变量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/14bc184e/">
                     
										    ansible☞playbook-循环
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/29683589/">
                     
										    ansible☞playbook-条件判断
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f43dca37/">
                     
										    ansible☞playbook-过滤器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c4126d5a/">
                     
										    ansible☞playbook-错误捕获
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d3e413b7/">
                     
										    ansible☞基础信息
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1e274151/">
                     
										    ansible☞常用模块-命令调用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4235ddf4/">
                     
										    ansible☞常用模块-文本文件操作
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/84eb900/">
                     
										    ansible☞常用模块-系统相关
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3d9b9ec1/">
                     
										    ansible☞常用模块-软件包管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/724fda19/">
                     
										    ansible☞模板
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/720afd15/">
                     
										    ansible☞角色
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										jenkins
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/9011aa7a/">
                     
										    jenkins-gitops-cd
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/eea0d6c7/">
                     
										    jenkins-gitops-ci
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e804084e/">
                     
										    jenkins-groovy基础
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/57e9683e/">
                     
										    jenkins-pipeline dsl 常用方法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/75dc22a9/">
                     
										    jenkins-常用插件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/67a8b607/">
                     
										    jenkins-构建工具集成
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/192a4f4c/">
                     
										    jenkins-示例1
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b7391a97/">
                     
										    jenkins-集成SonarQube
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2a5275e1/">
                     
										    jenkins-集成gitlab
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d9cdb70/">
                     
										    jenkins☞001安装和基本配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8a33e212/">
                     
										    jenkins☞002Pipelines
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e4df8a4f/">
                     
										    jenkins☞003共享库
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3e0f2183/">
                     
										    jenkins☞从容器中访问宿主机docker命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3b5cd3e1/">
                     
										    jenkins☞基于k8s生成动态的Jenkins agent
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										虚拟化
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										vmware
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/eab024cf/">
                     
										    vcsa☞存储设备有vmfs分区，但数据存储丢失
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										语言
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										css
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/fa5680b3/">
                     
										    css☞背景图居中拉伸平铺
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										go
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/38c126f9/">
                     
										    go-013文件先读再覆盖写
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/0/">
                     
										    go-014并发和管道
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/83a93e23/">
                     
										    go-015自定义包
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5086e20/">
                     
										    go-016并发
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/786ba9af/">
                     
										    go-017测试
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/717b7a86/">
                     
										    go-100遇到的点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/759b68d8/">
                     
										    go☞001变量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8c3e952e/">
                     
										    go☞002常量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1a034363/">
                     
										    go☞003运算符
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8a6b5455/">
                     
										    go☞004控制流
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/98f86e16/">
                     
										    go☞005函数
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/318675c1/">
                     
										    go☞006函数-闭包
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a705a91a/">
                     
										    go☞007结构
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f8eb4b1b/">
                     
										    go☞008方法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/77a46e91/">
                     
										    go☞009接口
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2dab3d00/">
                     
										    go☞010特殊控制流(defer panic recover)
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/336ec0ac/">
                     
										    go☞011错误处理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d1503f4a/">
                     
										    go☞012常用模块
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										java
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/ac6b3b36/">
                     
										    jdk☞安装和配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										jquery
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/5d527900/">
                     
										    jquery☞伪进度条
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										python
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/86059ffb/">
                     
										    django☞admin管理视图
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/dd4c9efa/">
                     
										    django☞restful简单使用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/26bd5165/">
                     
										    django☞日志
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6a4df400/">
                     
										    django☞管理静态文件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3f8b5448/">
                     
										    django☞记忆点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d60c38c/">
                     
										    django☞验证码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/876c5852/">
                     
										    python☞json
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										shell
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/f2de1fb/">
                     
										    shell-[[ ]]
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/241ce96c/">
                     
										    shell☞if判定
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b06f599c/">
                     
										    shell☞read嵌套
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/1a0d1bbd/">
                     
										    正则表达式-修饰符
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">
	prometheus☞搭建
</h1>
<div class="article-meta">
	
		<span>
			阅读量:<span id="/posts/65820315/" class="leancloud_visitors" data-flag-title="prometheus☞搭建"></span>
		</span>
	
	<span>zyh</span>
	<span>2020-07-26 11:25:44</span>
		<div id="article-categories">
    
		<span>Categories：</span>
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true">
                        <a href="/categories/监控/">监控</a>
                        </i>
                      
                        >
                      
                    </span>
                
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true">
                        <a href="/categories/监控/prometheus/">prometheus</a>
                        </i>
                      
                    </span>
                
            
    

    
		<span>Tags：</span>
            
                
                    <span>
                        <i class="fa fa-tag" aria-hidden="true">
                        <a href="/tags/prometheus/">prometheus</a>
                        </i>
                    </span>
                
            
    
		</div>

</div>

<div id="article-content">
	<h1>前言</h1>
<p>prometheus 监控的构建，相比 zabbix 来说，还是要麻烦一些。</p>
<p>当然，如果你完全熟悉之后，配置文件化也更容易被其他系统所修改。</p>
<h1>监控端组件</h1>
<p>搞之前，先创建一个网络</p>
<pre><code class="language-bash">docker network create promsnet
</code></pre>
<h2 id="Grafana-展示">Grafana 展示</h2>
<p><a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/installation/docker/">https://grafana.com/docs/grafana/latest/installation/docker/</a></p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/grafana/grafana">https://hub.docker.com/r/grafana/grafana</a></p>
<blockquote>
<p>数据展示，部署在 proms 端</p>
</blockquote>
<h3 id="配置">配置</h3>
<blockquote>
<p>/export/docker-data-grafana/conf/default.ini</p>
</blockquote>
<p>主配置里参数非常多，修改下列基本配置即可</p>
<pre><code class="language-ini">[server]
domain = 域名
http_port = 端口
[database]
type = sqlite3
host = 127.0.0.1:3306
name = grafana
user = root
password =
[smtp]
enabled = true
host = smtp.feishu.cn:465
user = 
password = 
skip_verify = true
from_address = 
from_name = GrafanaAdmin
</code></pre>
<h3 id="安装启动">安装启动</h3>
<pre><code class="language-bash">versionTag=8.3.6
mkdir -p /export/docker-data-grafana/&#123;data,conf&#125;
chmod 777 /export/docker-data-grafana/data
docker run --name grafana \
--restart always \
--network promsnet \
--mount 'type=bind,src=/export/docker-data-grafana/data,dst=/var/lib/grafana' \
--mount 'type=bind,src=/export/docker-data-grafana/conf,dst=/usr/share/grafana/conf' \
-p 3000:3000 -d grafana/grafana:$&#123;versionTag&#125;

cat &lt;&lt; EOF | tee grafana.docker.command
docker run --name grafana \
--restart always \
--network promsnet \
--mount 'type=bind,src=/export/docker-data-grafana/data,dst=/var/lib/grafana' \
--mount 'type=bind,src=/export/docker-data-grafana/conf,dst=/usr/share/grafana/conf' \
-p 3000:3000 -d grafana/grafana:$&#123;versionTag&#125;
EOF
</code></pre>
<p>正式版本号，纯数字，没有任何test或者pre后缀</p>
<blockquote>
<p>默认账户/初始密码都是admin</p>
<p>默认配置库是sqlite 3</p>
</blockquote>
<h3 id="升级">升级</h3>
<pre><code class="language-bash">dateTime=`date +%Y%m%d`
cp -rp /export/docker-data-grafana /export/docker-data-grafana.$&#123;dateTime&#125;

</code></pre>
<h2 id="Alertmanager-告警管理">Alertmanager 告警管理</h2>
<p>告警管理器，接收 proms 发来的告警，经过【分组】=&gt;【收敛】=&gt;【静默】处理后通过【receiver】发出。</p>
<p>其配置中的标签可以是prometheus刮取数据中自带的，也可以是prometheus告警规则中自定义的labels。</p>
<h3 id="告警分组、收敛、静默">告警分组、收敛、静默</h3>
<p>分组的意思，就是将某一个组内同一时期的告警合并发送，例如根据实例来分组。</p>
<p>收敛的意思，就是告警A规则和告警B规则同时触发，但是告警A规则出现的时候，必然会触发告警B，此时只发告警A，例如MYSQL机器挂了，那么只需要发机器挂掉的告警，MYSQL的告警就没必要发送了。</p>
<p>静默的意思，就是用户已知这个时间点会触发告警规则，但是无需触发，例如高压力定时任务引起磁盘IO告警，虽然会触发平均指标告警，但是在用户认定的安全范围内，因而无需触发。</p>
<ul>
<li>分组</li>
</ul>
<p>在【route】根路由上通过【label】进行分组，同组的预警尽量一次性发出</p>
<pre><code class="language-yaml">route:
  group_by: ['alertname']  # 告警分组指标, 可以写多个，从而进一步分组。
  group_wait: 10s # 分组后，组内需告警的第一条规则需要在 10s 内等待其它可能的告警规则，等待结束后一次性发出。
  group_interval: 5m # 在发生告警后，同组内需告警的规则列表需要在 5m 内等待列表可能发生的变动，若有变化，则等待结束后再次发送。
  repeat_interval: 1h # 在发生告警后，同组需告警的规则列表若在 1h 内没有发生变化，则再次发送。
</code></pre>
<p>👀<code>alertname</code>标签指的是prometheus告警规则名称</p>
<p>根路由【route】之后，还可以继续通过子路由【routes】来将不同【label】的告警发送给不同的【receiver】。</p>
<ul>
<li>收敛</li>
</ul>
<p>举例说明：当主机挂了，此时只需要发送主机挂掉的预警，无需再发送因主机挂掉而产出的其它预警。</p>
<pre><code class="language-yaml">inhibit_rules:
  - source_matchers: [severity=&quot;critical&quot;]
    target_matchers: [severity=~&quot;error|warning&quot;]
    equal: [cluster] # 针对包含 cluster 标签的告警
  - source_matchers: [severity=&quot;critical&quot;]
    target_matchers: [severity=~&quot;error|warning&quot;]
    equal: [instance] # 针对包含 instance 标签的告警
  - source_matchers: [severity=&quot;error&quot;]
    target_matchers: [severity=&quot;warning&quot;]
    equal: [name] # 针对包含容器标签 name 的告警
</code></pre>
<p>source_matchers 列出匹配标签键值对的【需告警】规则；</p>
<p>target_matchers  列出匹配标签键值对的【无需告警】规则；</p>
<p>当 equal 的标签【同时】被 source_matchers 和 target_matchers 匹配的时候，inhibit_rule 规则生效。</p>
<ul>
<li>静默</li>
</ul>
<p>web控制台上配置。就是临时关闭发送。</p>
<ul>
<li>接收者</li>
</ul>
<p>【receiver】统一由【receivers】进行配置。</p>
<h3 id="配置-2">配置</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml">https://github.com/prometheus/alertmanager/blob/main/doc/examples/simple.yml</a></p>
<p>alertmanager.yml</p>
<pre><code class="language-bash">global:
  resolve_timeout: 5m
  smtp_smarthost: 'localhost:25'
  smtp_require_tls: true
  smtp_from: 'alertmanager@example.org'
  smtp_auth_username: 'alertmanager'
  smtp_auth_password: 'password'
route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'wechat'
  routes:
    - matchers:
        - app=~&quot;app1|app2&quot;
      receiver: email
      routes:
        - matchers:
            - severity=&quot;critical&quot;
          receiver: wechat
receivers:
- name: 'wechat'
  wechat_configs:
  - corp_id: ''
    to_user: ''
    agent_id: ''
    api_secret: ''
    send_resolved: true
- name: 'email'
  email_configs:
  - to: &lt;tmpl_string&gt;
inhibit_rules:
  - source_matchers: [severity=&quot;critical&quot;]
    target_matchers: [severity=~&quot;error|warning&quot;]
    equal: [cluster] # 针对包含 cluster 标签的告警
  - source_matchers: [severity=&quot;critical&quot;]
    target_matchers: [severity=~&quot;error|warning&quot;]
    equal: [instance] # 针对包含 instance 标签的告警
  - source_matchers: [severity=&quot;error&quot;]
    target_matchers: [severity=&quot;warning&quot;]
    equal: [name] # 针对包含容器标签 name 的告警
</code></pre>
<p>上面是微信的，你也可以webhook方式，来走其它方式，例如飞书/钉钉</p>
<pre><code class="language-bash">global:
  resolve_timeout: 5m
# 告警根路由
route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 60m
  receiver: 'feishu'
# 默认的接收队列
receivers:
- name: 'feishu'
  webhook_configs:
  - url: ''
# 抑制规则
inhibit_rules:
  - source_matchers: [severity=&quot;critical&quot;]
    target_matchers: [severity=~&quot;error|warning&quot;]
    equal: [cluster] # 针对包含 cluster 标签的告警
  - source_matchers: [severity=&quot;critical&quot;]
    target_matchers: [severity=~&quot;error|warning&quot;]
    equal: [instance] # 针对包含 instance 标签的告警
  - source_matchers: [severity=&quot;error&quot;]
    target_matchers: [severity=&quot;warning&quot;]
    equal: [name] # 针对包含容器标签 name 的告警
</code></pre>
<h3 id="告警发送中心">告警发送中心</h3>
<p>💁关于飞书/钉钉的webhook，可以用部署 <a target="_blank" rel="noopener" href="https://gitee.com/feiyu563/PrometheusAlert">PrometheusAlert</a>实现。</p>
<p><a target="_blank" rel="noopener" href="https://feiyu563.gitbook.io/prometheusalert/webhook">https://feiyu563.gitbook.io/prometheusalert/webhook</a></p>
<p>贴一个PrometheusAlert的告警模板：</p>
<pre><code class="language-go">&#123;&#123; $var := .externalURL&#125;&#125;&#123;&#123; range $k,$v:=.alerts &#125;&#125;
&#123;&#123;if eq $v.status "resolved"&#125;&#125;
**Prometheus恢复信息**
告警项目：&#123;&#123;$v.labels.alertname&#125;&#125;
告警级别：&#123;&#123;$v.labels.severity&#125;&#125;
持续范围：&#123;&#123;GetCSTtime $v.startsAt&#125;&#125; to &#123;&#123;GetCSTtime $v.endsAt&#125;&#125;
故障主机：&#123;&#123;$v.labels.instance&#125;&#125;
**&#123;&#123;$v.annotations.summary&#125;&#125;**
[点击打开grafana](&#123;&#123;$v.annotations.grafana&#125;&#125;)
&#123;&#123;else&#125;&#125;
**Prometheus告警信息**
告警项目：&#123;&#123;$v.labels.alertname&#125;&#125;
告警级别：&#123;&#123;$v.labels.severity&#125;&#125;
开始时间：&#123;&#123;GetCSTtime $v.startsAt&#125;&#125;
故障主机：&#123;&#123;$v.labels.instance&#125;&#125;
**&#123;&#123;$v.annotations.summary&#125;&#125;**
[点击打开grafana](&#123;&#123;$v.annotations.grafana&#125;&#125;)
&#123;&#123;end&#125;&#125;
&#123;&#123; end &#125;&#125;
</code></pre>
<p>👀<code>GetCSTtime</code>是PrometheusAlert自带的一个方法，可以将时区转换成CST。</p>
<p>从Alertmanager发过来的消息例子，可用于在PrometheusAlert中测试模板。</p>
<pre><code class="language-json">&#123;&quot;receiver&quot;:&quot;web\\.hook\\.prometheusalert&quot;,&quot;status&quot;:&quot;resolved&quot;,&quot;alerts&quot;:[&#123;&quot;status&quot;:&quot;resolved&quot;,&quot;labels&quot;:&#123;&quot;alertname&quot;:&quot;container-cpu-usage-high&quot;,&quot;cpu&quot;:&quot;cpu00&quot;,&quot;desc&quot;:&quot;容器的cpu总消耗百分比&quot;,&quot;id&quot;:&quot;/docker/91afdbd4c24f22650ce&quot;,&quot;image&quot;:&quot;registry-vpc.cn-zhangjiakou.aliyuncs.com/zyh/app1:latest&quot;,&quot;instance&quot;:&quot;java001.zjk.zyh&quot;,&quot;job&quot;:&quot;auto_discovery_dns&quot;,&quot;name&quot;:&quot;app1&quot;,&quot;severity&quot;:&quot;warning&quot;,&quot;unit&quot;:&quot;%&quot;&#125;,&quot;annotations&quot;:&#123;&quot;grafana&quot;:&quot;http://&lt;grafana_ip&gt;&quot;,&quot;id&quot;:&quot;&quot;,&quot;summary&quot;:&quot;instance: java001.zjk.zyh 下的 container: app1 cpu 使用率持续超过90%.&quot;&#125;,&quot;startsAt&quot;:&quot;2022-02-17T18:06:40.611569268Z&quot;,&quot;endsAt&quot;:&quot;2022-02-17T18:06:55.611569268Z&quot;,&quot;generatorURL&quot;:&quot;http://&lt;prometheus_ip&gt;:9090&quot;,&quot;fingerprint&quot;:&quot;d48ec3&quot;&#125;],&quot;groupLabels&quot;:&#123;&quot;alertname&quot;:&quot;container-cpu-usage-high&quot;&#125;,&quot;commonLabels&quot;:&#123;&quot;alertname&quot;:&quot;container-cpu-usage-high&quot;,&quot;cpu&quot;:&quot;cpu00&quot;,&quot;desc&quot;:&quot;容器的cpu总消耗百分比&quot;,&quot;id&quot;:&quot;/docker/91afdbd4c24f22650ce&quot;,&quot;image&quot;:&quot;registry-vpc.cn-zhangjiakou.aliyuncs.com/zyh/app1:latest&quot;,&quot;instance&quot;:&quot;java001.zjk.zyh&quot;,&quot;job&quot;:&quot;auto_discovery_dns&quot;,&quot;name&quot;:&quot;cms-runner&quot;,&quot;severity&quot;:&quot;warning&quot;,&quot;unit&quot;:&quot;%&quot;&#125;,&quot;commonAnnotations&quot;:&#123;&quot;grafana&quot;:&quot;http://&lt;grafana_ip&gt;&quot;,&quot;id&quot;:&quot;&quot;,&quot;summary&quot;:&quot;instance: java001.zjk.zyh 下的 container: app1 cpu  使用率持续超过90%.&quot;&#125;,&quot;externalURL&quot;:&quot;http://e21437fd4:9093&quot;,&quot;version&quot;:&quot;4&quot;,&quot;groupKey&quot;:&quot;&#123;&#125;:&#123;alertname=\&quot;container-cpu-usage-high\&quot;&#125;&quot;,&quot;truncatedAlerts&quot;:0&#125;
</code></pre>
<p>官方列出的POST json数据：</p>
<pre><code class="language-json">&#123;
  &quot;version&quot;: &quot;4&quot;,
  &quot;groupKey&quot;: &lt;string&gt;,              // key identifying the group of alerts (e.g. to deduplicate)
  &quot;truncatedAlerts&quot;: &lt;int&gt;,          // how many alerts have been truncated due to &quot;max_alerts&quot;
  &quot;status&quot;: &quot;&lt;resolved|firing&gt;&quot;,
  &quot;receiver&quot;: &lt;string&gt;,
  &quot;groupLabels&quot;: &lt;object&gt;,
  &quot;commonLabels&quot;: &lt;object&gt;,
  &quot;commonAnnotations&quot;: &lt;object&gt;,
  &quot;externalURL&quot;: &lt;string&gt;,           // backlink to the Alertmanager.
  &quot;alerts&quot;: [
    &#123;
      &quot;status&quot;: &quot;&lt;resolved|firing&gt;&quot;,
      &quot;labels&quot;: &lt;object&gt;,
      &quot;annotations&quot;: &lt;object&gt;,
      &quot;startsAt&quot;: &quot;&lt;rfc3339&gt;&quot;,
      &quot;endsAt&quot;: &quot;&lt;rfc3339&gt;&quot;,
      &quot;generatorURL&quot;: &lt;string&gt;,      // identifies the entity that caused the alert
      &quot;fingerprint&quot;: &lt;string&gt;        // fingerprint to identify the alert
    &#125;,
    ...
  ]
&#125;
</code></pre>
<h3 id="启动">启动</h3>
<pre><code class="language-bash">mkdir -p /export/docker-data-alertmanager
docker run --name alertmanager -d \
  --restart always \
  --network promsnet \
  -p 9093:9093 \
  --mount 'type=bind,src=/export/docker-data-alertmanager,dst=/etc/alertmanager' \
  prom/alertmanager
</code></pre>
<h2 id="Prometheus-主程">Prometheus 主程</h2>
<h3 id="概念">概念</h3>
<ul>
<li>数据来源：
<ul>
<li>从各种源服务自带的 /metrics 地址中获取指标数据；</li>
<li>如果源服务（例如redis）里没有提供，则可以从第三方写好的抓取服务中获取指标数据；</li>
<li>如果是自己写的服务，则可以在服务里嵌入 prometheus 的 sdk 来暴漏指标。</li>
</ul>
</li>
<li>数据存储：
<ul>
<li>默认是本地存储</li>
<li>可以是远程存储</li>
</ul>
</li>
</ul>
<pre><code class="language-bash">mkdir /export/docker-data-proms/&#123;data,conf&#125; -p
chmod 777 /export/docker-data-proms/data
</code></pre>
<h3 id="配置-3">配置</h3>
<h4 id="主配置">主配置</h4>
<p>/export/docker-data-proms/promethesu.yml</p>
<pre><code class="language-:"># my global config
global:
  scrape_interval:     15s # 从数据源处刮取数据的间隔周期。默认是1分钟
  evaluation_interval: 15s # 重新评估告警表达式的间隔周期。默认是1分钟
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  - &quot;/etc/prometheus/conf/rules/*.yml&quot;

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
#  - job_name: 'prometheus'
#    static_configs:
#    - targets: ['proms:9090']

#  - job_name: &quot;grafana&quot;
#    static_configs:
#    - targets: ['grafana:3000']

  - job_name: &quot;auto_discovery_dns&quot;
    relabel_configs: # 数据获取之前，针对数据源 target 的标签修改
    - source_labels: [&quot;__address__&quot;]  # 将 target 中标签键 __address__ = (.*):9100 变更为 instance = .*
      regex: &quot;(.*):9100&quot; # 匹配原始标签的值
      replacement: &quot;$1&quot; # 提取 regex 中拿到的值
      target_label: &quot;instance&quot; # 设定要修改的目标标签
      action: replace # 将目标标签的值替换为 replacement 提取的值
    - source_labels: [&quot;__address__&quot;]  # 获取原始标签
      regex: &quot;(.*):10052&quot; # 匹配原始标签的值
      replacement: &quot;$1&quot; # 提取 regex 中拿到的值
      target_label: &quot;instance&quot; # 设定要修改的目标标签
      action: replace # 将目标标签的值替换为 replacement 提取的值
    metric_relabel_configs: # 数据获取后，针对数据指标落盘前的修改
    - source_labels: [&quot;__name__&quot;] # 获取原始标签
      regex: &quot;^go_.*|^process_.*&quot; # 匹配标签值
      action: drop # 删除，不让数据落盘
    dns_sd_configs: # 通过 dns srv 记录自动发现
    - names: [&quot;_prometheus._tcp.zjk.pj&quot;]

# 启用远程存储 TSDB,以阿里云的 TSDB mlarge 规格数据库为例
# 阿里云的 TSDB 推荐配置表： https://help.aliyun.com/document_detail/114516.html
## Remote write configuration (TSDB).
remote_write:
  - url: &quot;http://ts-xxxxxxxxxxxx.hitsdb.rds.aliyuncs.com:3242/api/prom_write&quot;
    # Configures the queue used to write to remote storage.
    queue_config:
      # Number of samples to buffer per shard before we start dropping them. 内存事件队列长度，如果满了，则新事件直接丢弃
      capacity: 10000
      # Maximum number of shards, i.e. amount of concurrency. 并发 shard 数
      max_shards: 1
      # Maximum number of samples per send. 每个 shard 每次发送多少事件。以500为例，可以简单的理解为每秒发送5000
      max_samples_per_send: 500

## Remote read configuration (TSDB).
remote_read:
  - url: &quot;http://ts-xxxxxxxxxxxx.hitsdb.rds.aliyuncs.com:3242/api/prom_read&quot;
    read_recent: true
</code></pre>
<p>relabel_configs：针对 scrape target endpoint（刮取器） 的标签修改</p>
<p>metric_relabel_configs：针对 scrape target endpoint 拿到的 metrics 指标数据的标签修改</p>
<p><code>__name__</code>是内置的针对标签键的通用名</p>
<h5 id="原始标签和目标标签">原始标签和目标标签</h5>
<p>可以在下图位置【Status】-【Service Discovery】中看到详情</p>
<p><img src="/posts/65820315/image-20210316182617074.png" alt="image-20210316182617074"></p>
<h5 id="自动发现">自动发现</h5>
<p>dns srv 自动发现，需要一个内部的dns服务器，例如阿里云的云私有解析等。</p>
<p>如何添加 srv 记录，例如让proms发现节点服务 all.it.zjk.pj:9100 和 all.it.zjk.pj:10052</p>
<ol>
<li>添加私有域 zjk.pj</li>
<li>添加A记录 all.it.zjk.pj -&gt; 192.168.1.1</li>
<li>添加srv记录 _prometheus._tcp.zjk.pj -&gt; 10 10 9100 all.it.zjk.pj</li>
<li>添加srv记录 _prometheus._tcp.zjk.pj -&gt; 10 10 10052 all.it.zjk.pj</li>
</ol>
<p>关于A记录就不说了，srv记录里 <code>10 10 9100 all.it.zjk.pj</code>的意思是<code>优先级 权重 服务端口 服务器域名</code></p>
<p>最终，你可以在 http://&lt;prometheus_ip&gt;:9090/classic/targets 看到自动发现的节点信息。</p>
<h4 id="定义需要告警的指标规则">定义需要告警的指标规则</h4>
<p>将采集的数据指标通过 expr 进行运算，并通过 record 进行命名。</p>
<p>关于规则里的表达式语句的写法涉及到 PromQL，可以看一下文档。</p>
<p><a target="_blank" rel="noopener" href="https://fuckcloudnative.io/prometheus/3-prometheus/basics.html">https://fuckcloudnative.io/prometheus/3-prometheus/basics.html</a></p>
<h5 id="主机监控指标规则">主机监控指标规则</h5>
<p>/export/docker-data-proms/conf/rules/node-exporter-record-rules.yml</p>
<pre><code class="language-bash"># node-exporter-record-rules.yml
# 标签 job 关联主配置定义的任务 auto_discovery_dns，获取任务传递的数据，从而抽取信息定义 expr
# 给 expr 表达式设置一个别名 record, 别名可以被其它 rules 调用

groups:
  - name: node_exporter-record
    rules:
    - expr: up&#123;job=~&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:up
      labels:
        desc: &quot;节点是否在线, 在线1,不在线0&quot;
        unit: &quot; &quot;
        job: &quot;auto_discovery_dns&quot;
    - expr: time() - node_boot_time_seconds&#123;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:node_uptime
      labels:
        desc: &quot;节点的运行时间&quot;
        unit: &quot;s&quot;
        job: &quot;auto_discovery_dns&quot;
##############################################################################################
#                              cpu                                                           #
    - expr: (1 - avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:cpu:total:percent
      labels:
        desc: &quot;节点的cpu总消耗百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:cpu:idle:percent
      labels:
        desc: &quot;节点的cpu idle百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;iowait&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:cpu:iowait:percent
      labels:
        desc: &quot;节点的cpu iowait百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;


    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;system&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:cpu:system:percent
      labels:
        desc: &quot;节点的cpu system百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=&quot;user&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:cpu:user:percent
      labels:
        desc: &quot;节点的cpu user百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;auto_discovery_dns&quot;,mode=~&quot;softirq|nice|irq|steal&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:cpu:other:percent
      labels:
        desc: &quot;节点的cpu 其他的百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;
##############################################################################################
#                                    memory                                                  #
    - expr: node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:memory:total
      labels:
        desc: &quot;节点的内存总量&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr: node_memory_MemFree_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:memory:free
      labels:
        desc: &quot;节点的剩余内存量&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr: node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; - node_memory_MemFree_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:memory:used
      labels:
        desc: &quot;节点的已使用内存量&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr: node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; - node_memory_MemAvailable_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:memory:actualused
      labels:
        desc: &quot;节点用户实际使用的内存量&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr: (1-(node_memory_MemAvailable_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:memory:used:percent
      labels:
        desc: &quot;节点的内存使用百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: ((node_memory_MemAvailable_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;auto_discovery_dns&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:memory:free:percent
      labels:
        desc: &quot;节点的内存剩余百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;
##############################################################################################
#                                   load                                                     #
    - expr: sum by (instance) (node_load1&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:load:load1
      labels:
        desc: &quot;系统1分钟负载&quot;
        unit: &quot; &quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: sum by (instance) (node_load5&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:load:load5
      labels:
        desc: &quot;系统5分钟负载&quot;
        unit: &quot; &quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: sum by (instance) (node_load15&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:load:load15
      labels:
        desc: &quot;系统15分钟负载&quot;
        unit: &quot; &quot;
        job: &quot;auto_discovery_dns&quot;

##############################################################################################
#                                 disk                                                       #
    - expr: node_filesystem_size_bytes&#123;job=&quot;auto_discovery_dns&quot; ,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:usage:total
      labels:
        desc: &quot;节点的磁盘总量&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr: node_filesystem_avail_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:usage:free
      labels:
        desc: &quot;节点的磁盘剩余空间&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr: node_filesystem_size_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125; - node_filesystem_avail_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:usage:used
      labels:
        desc: &quot;节点的磁盘使用的空间&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr:  (1 - node_filesystem_avail_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:used:percent
      labels:
        desc: &quot;节点的磁盘的使用百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: irate(node_disk_reads_completed_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:read:count:rate
      labels:
        desc: &quot;节点的磁盘读取速率&quot;
        unit: &quot;次/秒&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: irate(node_disk_writes_completed_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:write:count:rate
      labels:
        desc: &quot;节点的磁盘写入速率&quot;
        unit: &quot;次/秒&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: (irate(node_disk_written_bytes_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:read:mb:rate
      labels:
        desc: &quot;节点的设备读取MB速率&quot;
        unit: &quot;MB/s&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: (irate(node_disk_read_bytes_total&#123;job=&quot;auto_discovery_dns&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:disk:write:mb:rate
      labels:
        desc: &quot;节点的设备写入MB速率&quot;
        unit: &quot;MB/s&quot;
        job: &quot;auto_discovery_dns&quot;

##############################################################################################
#                                filesystem                                                  #
    - expr:   (1 -node_filesystem_files_free&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_files&#123;job=&quot;auto_discovery_dns&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:filesystem:used:percent
      labels:
        desc: &quot;节点的inode的剩余可用的百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;
#############################################################################################
#                                filefd                                                     #
    - expr: node_filefd_allocated&#123;job=&quot;auto_discovery_dns&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:filefd_allocated:count
      labels:
        desc: &quot;节点的文件描述符打开个数&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: node_filefd_allocated&#123;job=&quot;auto_discovery_dns&quot;&#125;/node_filefd_maximum&#123;job=&quot;auto_discovery_dns&quot;&#125; * 100 * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:filefd_allocated:percent
      labels:
        desc: &quot;节点的文件描述符打开百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

#############################################################################################
#                                network                                                    #
    - expr: avg by (environment,instance,device) (irate(node_network_receive_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:netin:bit:rate
      labels:
        desc: &quot;节点网卡eth0每秒接收的比特数&quot;
        unit: &quot;bit/s&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_transmit_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:netout:bit:rate
      labels:
        desc: &quot;节点网卡eth0每秒发送的比特数&quot;
        unit: &quot;bit/s&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_receive_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:netin:packet:rate
      labels:
        desc: &quot;节点网卡每秒接收的数据包个数&quot;
        unit: &quot;个/秒&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_transmit_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:netout:packet:rate
      labels:
        desc: &quot;节点网卡发送的数据包个数&quot;
        unit: &quot;个/秒&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_receive_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:netin:error:rate
      labels:
        desc: &quot;节点设备驱动器检测到的接收错误包的数量&quot;
        unit: &quot;个/秒&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: avg by (environment,instance,device) (irate(node_network_transmit_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:netout:error:rate
      labels:
        desc: &quot;节点设备驱动器检测到的发送错误包的数量&quot;
        unit: &quot;个/秒&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: node_tcp_connection_states&#123;job=&quot;auto_discovery_dns&quot;, state=&quot;established&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:tcp:established:count
      labels:
        desc: &quot;节点当前established的个数&quot;
        unit: &quot;个&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: node_tcp_connection_states&#123;job=&quot;auto_discovery_dns&quot;, state=&quot;time_wait&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:tcp:timewait:count
      labels:
        desc: &quot;节点timewait的连接数&quot;
        unit: &quot;个&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: sum by (environment,instance) (node_tcp_connection_states&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:network:tcp:total:count
      labels:
        desc: &quot;节点tcp连接总数&quot;
        unit: &quot;个&quot;
        job: &quot;auto_discovery_dns&quot;
#############################################################################################
#                                process                                                    #
    - expr: node_processes_state&#123;state=&quot;Z&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:process:zoom:total:count
      labels:
        desc: &quot;节点当前状态为zoom的个数&quot;
        unit: &quot;个&quot;
        job: &quot;auto_discovery_dns&quot;
#############################################################################################
#                                other                                                    #
    - expr: abs(node_timex_offset_seconds&#123;job=&quot;auto_discovery_dns&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:time:offset
      labels:
        desc: &quot;节点的时间偏差&quot;
        unit: &quot;s&quot;
        job: &quot;auto_discovery_dns&quot;
#############################################################################################
#
    - expr: count by (instance) ( count by (instance,cpu) (node_cpu_seconds_total&#123; mode='system'&#125;) ) * on(instance) group_left(nodename) (node_uname_info)
      record: node_exporter:cpu:count
</code></pre>
<h5 id="容器监控指标规则">容器监控指标规则</h5>
<p>/export/docker-data-proms/conf/rules/dockersInfo-record-rules.yml</p>
<pre><code class="language-yaml">groups:
  - name: dockersInfo-record
    rules:
    - expr: count by (instance, name) (count_over_time(container_last_seen&#123;job=&quot;auto_discovery_dns&quot;, name!=&quot;&quot;, container_label_restartcount!=&quot;&quot;&#125;[15m]))
      record: dockersInfo:container:restart
      labels:
        desc: &quot;15m周期内容器发生重启的次数&quot;
        unit: &quot;&quot;
        job: &quot;auto_discovery_dns&quot;
##############################################################################################
#                              cpu                                                           #
    - expr: rate(container_cpu_usage_seconds_total&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125;[5m])  * 100
      record: dockersInfo:container:cpu:total:percent
      labels:
        desc: &quot;容器的cpu总消耗百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

    - expr: rate(container_fs_io_time_seconds_total&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125;[5m])  * 100
      record: dockersInfo:cpu:iowait:percent
      labels:
        desc: &quot;容器的cpu iowait百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;

##############################################################################################
#                                    memory                                                  #
    - expr: container_spec_memory_limit_bytes&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125;
      record: dockersInfo:memory:total
      labels:
        desc: &quot;容器的内存总量&quot;
        unit: byte
        job: &quot;auto_discovery_dns&quot;

    - expr: container_memory_usage_bytes&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125; / container_spec_memory_limit_bytes&#123;job=&quot;auto_discovery_dns&quot;, name!=''&#125; * 100
      record: dockersInfo:memory:used:percent
      labels:
        desc: &quot;容器的内存使用百分比&quot;
        unit: &quot;%&quot;
        job: &quot;auto_discovery_dns&quot;
</code></pre>
<h4 id="定义监控指标阈值规则">定义监控指标阈值规则</h4>
<h5 id="主机监控指标阈值">主机监控指标阈值</h5>
<p>/export/docker-data-proms/conf/rules/node-exporter-alert-rules.yml</p>
<pre><code class="language-bash"># node-exporter-alert-rules.yml
# 定义告警规则
# 通过前一个 rules 文件拿到定义的 record 别名来编写 expr 判断式
# 这里定义的告警规则，在触发的时候，都会传递到 alertmanager，最后从传递的信息中抽取所需数据发送给目标人。
groups:
  - name: node-alert
    rules:
    - alert: node-down
      expr: node_exporter:up == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 宕机了&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;
    - alert: node-cpu-high
      expr:  node_exporter:cpu:total:percent &gt; 80
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; cpu 使用率高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-cpu-iowait-high
      expr:  node_exporter:cpu:iowait:percent &gt;= 12
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; cpu iowait 使用率高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-load-load1-high
      expr:  (node_exporter:load:load1) &gt; (node_exporter:cpu:count) * 1.2
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; load1 使用率高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-memory-high
      expr:  node_exporter:memory:used:percent &gt; 85
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;内存使用率高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-disk-high
      expr:  node_exporter:disk:used:percent &gt; 80
      for: 3m
      labels:
        severity: info
      annotations:
        summary: &quot;&#123;&#123; $labels.device &#125;&#125;:&#123;&#123; $labels.mountpoint &#125;&#125; 使用率高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-disk-read:count-high
      expr:  node_exporter:disk:read:count:rate &gt; 3000
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; iops read 使用率高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-disk-write-count-high
      expr:  node_exporter:disk:write:count:rate &gt; 3000
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; iops write 使用率高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-disk-read-mb-high
      expr:  node_exporter:disk:read:mb:rate &gt; 60
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 读取字节数 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-disk-write-mb-high
      expr:  node_exporter:disk:write:mb:rate &gt; 60
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 写入字节数 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-filefd-allocated-percent-high
      expr:  node_exporter:filefd_allocated:percent &gt; 80
      for: 10m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 打开文件描述符 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-network-netin-error-rate-high
      expr:  node_exporter:network:netin:error:rate &gt; 4
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 包进入的错误速率 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;
    - alert: node-network-netin-packet-rate-high
      expr:  node_exporter:network:netin:packet:rate &gt; 35000
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 包进入速率 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-network-netout-packet-rate-high
      expr:  node_exporter:network:netout:packet:rate &gt; 35000
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 包流出速率 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-network-tcp-total-count-high
      expr:  node_exporter:network:tcp:total:count &gt; 40000
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; tcp连接数量 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-process-zoom-total-count-high
      expr:  node_exporter:process:zoom:total:count &gt; 10
      for: 10m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 僵死进程数量 高于 &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: node-time-offset-high
      expr:  node_exporter:time:offset &gt; 0.03
      for: 2m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; &#123;&#123; $labels.desc &#125;&#125;  &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;
        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;
</code></pre>
<h5 id="容器监控指标阈值">容器监控指标阈值</h5>
<p>/export/docker-data-proms/conf/rules/dockersInfo-alert-rules.yml</p>
<pre><code class="language-yaml">groups:
  - name: container-alert
    rules:
    - alert: container-restart-times-high
      expr: dockersInfo:container:restart &gt; 5
      for: 1m
      labels:
        severity: warn
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 下的 container: &#123;&#123; $labels.name &#125;&#125; 15分钟内重启次数超过5次&quot;
        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: container-cpu-usage-high
      expr: dockersInfo:container:cpu:total:percent &gt; 90
      for: 1m
      labels:
        severity: info
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 下的 container: &#123;&#123; $labels.name &#125;&#125; cpu 使用率持续超过90%.&quot;
        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

    - alert: container-cpu-iowait-high
      expr: dockersInfo:cpu:iowait:percent &gt; 10
      for: 1m
      labels:
        severity: warn
      annotations:
        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 下的 container: &#123;&#123; $labels.name &#125;&#125; cpu iowait 持续超过10%&quot;
        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;
        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
        type: &quot;aliyun_meta_ecs_info&quot;

#    - alert: container-mem-usage-high
#      expr: dockersInfo:memory:used:percent &gt; 80
#      for: 1m
#      labels:
#        severity: warn
#      annotations:
#        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; 下的 container: &#123;&#123; $labels.name &#125;&#125; 内存使用率超过80%&quot;
#        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;
#        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;
#        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;
#        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;
#        type: &quot;aliyun_meta_ecs_info&quot;
</code></pre>
<h4 id="告警流程解析">告警流程解析</h4>
<p>关于告警，prometheus存在三个告警状态：</p>
<ul>
<li>inactive 未触发expr告警表达式。</li>
<li>pending 已触发 expr 告警表达式，但还未满足告警持续时间（即 for 语法关键词）。</li>
<li>firing 已触发最新一次expr 告警表达式且满足告警持续时间。</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://ip:9090/alerts">http://ip:9090/alerts</a> 可以看到各项告警规则的状态。</p>
<p>💥需要注意的是，如果不设置for或者将其置为0，则会跳过告警持续时间，直接告警。</p>
<p>借用网上的一个例子来介绍：</p>
<pre><code class="language-yaml">groups:
-  name: example
   rules:
   - alert: mysql_uptime
      expr: mysql:server_status:uptime &lt; 30
      for: 10s
      labels:
         level: &quot;CRITICAL&quot;
      annotations:
         detail: 数据库运行时间
</code></pre>
<p><img src="/posts/65820315/image-20220217115556807.png" alt="image-20220217115556807"></p>
<p>每5秒采集一个数据点；采集第三个点的时候，发现 mysql_uptime = 0; 说明 mysql 发生重启。</p>
<p>每10秒计算表达式 server_status:uptime &lt; 30 是否为真；在第三个采集点与第四个采集点之间触发了一次计算，致使触发告警。</p>
<p>等待告警持续时间 10 秒，再次计算表达式 server_status:uptime &lt; 30 是否为真。最终满足【已触发最新一次 expr 告警表达式且满足告警持续时间】，从而触发告警发送给Altertmanager告警管理器。</p>
<h3 id="部署">部署</h3>
<h4 id="docker-方式">docker 方式</h4>
<pre><code class="language-bash">docker run -d \
--name proms \
--network promsnet \
--restart always \
-p 9090:9090 \
--mount 'type=bind,src=/export/docker-data-proms/prometheus.yml,dst=/etc/prometheus/prometheus.yml'  \
--mount 'type=bind,src=/export/docker-data-proms/data,dst=/prometheus' \
--mount 'type=bind,src=/export/docker-data-proms/conf,dst=/etc/prometheus/conf' \
prom/prometheus \
--config.file=/etc/prometheus/prometheus.yml \
--storage.tsdb.path=/prometheus \
--storage.tsdb.retention=15d \
--web.enable-admin-api \
--web.enable-lifecycle
</code></pre>
<p>⚠️</p>
<p><code>--web.enable-admin-api</code> 如果不开启，则无法使用api接口，也就无法自主的删除数据.</p>
<p><code>--web.enable-lifecycle</code>如果不开启，则无法通过 <code>curl -XPOST http://ip:9090/-/reload</code> 重载 prometheus</p>
<h4 id="二进制方式">二进制方式</h4>
<pre><code class="language-bash">wget https://github.com/prometheus/prometheus/releases/download/v2.20.0/prometheus-2.20.0.linux-amd64.tar.gz
mkdir prometheus
tar xf prometheus-2.20.0.linux-amd64.tar.gz --strip-components 1 -C prometheus
rm -rf prometheus-2.20.0.linux-amd64.tar.gz
cd prometheus &amp;&amp; baseDir=`pwd`
cp prometheus.yml&#123;,.bak&#125; 
#---
cat &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt;EOF
[Unit]
Description=prometheus server daemon

[Service]
Restart=on-failure
ExecStart=$&#123;baseDir&#125;/prometheus --config.file=$&#123;baseDir&#125;/prometheus.yml

[Install]
WantedBy=multi-user.target
EOF
#---
systemctl daemon-reload
systemctl start prometheus
</code></pre>
<h3 id="查看">查看</h3>
<p>被监控端状态：<a target="_blank" rel="noopener" href="http://xxx:9090/targets">http://xxx:9090/targets</a></p>
<p>通过上述地址，你可以看到配置中 job_name 定义的被监控任务的端点状态</p>
<p><img src="/posts/65820315/image-20210311110821675.png" alt="image-20210311110821675"></p>
<h3 id="数据删除">数据删除</h3>
<pre><code class="language-bash"># match[] 表示匹配所有key, &#123;&#125;精确选中key
# 删除包含&#123;instance=&quot;10.3.128.202:15692&quot;&#125;的所有数据
curl -X POST -g 'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=&#123;instance=~&quot;10.3.128.202:15692&quot;&#125;'
# 添加删除时间范围
curl -X POST -g 'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?start=2021-05-30T00:00:00Z&amp;end=2021-06-07T23:59:59Z'
</code></pre>
<h2 id="pushgateway-未验证">pushgateway (未验证)</h2>
<blockquote>
<p>push 模式下的网关</p>
<p>当前没有现成的推送模式的 node-exporter</p>
</blockquote>
<pre><code class="language-bash"># docker
docker run -d --name=pushgateway -p 9091:9091 prom/pushgateway
</code></pre>
<pre><code class="language-bash"># 一个推送模式的采集脚本示例
# cat tcpestab.sh 

#!/bin/bash
# 添加脚本到计划任务中，定时采集
# pushgateway ip
pushgatewayIp=
#获取主机名，常传输到Prometheus标签以主机名
instance_name=`hostname -f | cut -d'.' -f1`
#判断主机名不能是localhost不然发送过的数据不知道是那个主机的 
if [ $instance_name == &quot;localhost&quot; ];then
echo &quot;Hostname must not localhost&quot;
exit 1
fi
#自定义key，在Prometheus即可使用key查询
label=&quot;count_estab_connections&quot; 
#获取TCP estab 连接数
count_estab_connections=`netstat -an | grep -i 'established' | wc -l`
#将数据发送到pushgateway固定格式
echo &quot;$label $count_estab_connections&quot;  | curl --data-binary @- http://$pushgatewayIp:9091/metrics/job/pushgateway/instance/$instance_name
</code></pre>
<h1>被监控端组件</h1>
<p>prometheus官方列出的表单：</p>
<p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a></p>
<p>编写exporter：</p>
<p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/writing_exporters/">https://prometheus.io/docs/instrumenting/writing_exporters/</a></p>
<h2 id="node-exporter-物理节点监控组件">node-exporter 物理节点监控组件</h2>
<blockquote>
<p>宿主数据采集端，部署在被监控主机的9100端口</p>
</blockquote>
<h3 id="docker-不太建议">docker 不太建议</h3>
<pre><code class="language-bash">docker run -d \
  --name=node-exporter \
  --restart=always \
  --net=&quot;host&quot; \
  --pid=&quot;host&quot; \
  -v &quot;/:/host:ro,rslave&quot; \
  quay.io/prometheus/node-exporter:latest \
  --path.rootfs=/host
</code></pre>
<h3 id="yum-方式-推荐">yum 方式 推荐</h3>
<pre><code class="language-bash"># yum包 https://copr.fedorainfracloud.org/coprs/ibotty/prometheus-exporters/
curl -Lo /etc/yum.repos.d/_copr_ibotty-prometheus-exporters.repo https://copr.fedorainfracloud.org/coprs/ibotty/prometheus-exporters/repo/epel-7/ibotty-prometheus-exporters-epel-7.repo &amp;&amp; yum install node_exporter -y
</code></pre>
<h3 id="源码包">源码包</h3>
<pre><code class="language-bash">cd /usr/local/
wget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz
mkdir node_exporter
tar xf node_exporter-1.0.1.linux-amd64.tar.gz --strip-components 1 -C node_exporter
mv node_exporter-1.0.1.linux-amd64.tar.gz src
cd node_exporter &amp;&amp; baseDir=`pwd`
#---
cat &gt; /usr/lib/systemd/system/node_exporter.service &lt;&lt;EOF
[Unit]
Description=node_exporter server daemon

[Service]
Restart=on-failure
ExecStart=$&#123;baseDir&#125;/node_exporter

[Install]
WantedBy=multi-user.target
EOF
</code></pre>
<h3 id="yum和源码的启动方式">yum和源码的启动方式</h3>
<pre><code class="language-bash">systemctl daemon-reload
systemctl start node_exporter
systemctl status node_exporter
curl http://localhost:9100/metrics # 查看获取的监控数据
systemctl enable node_exporter
</code></pre>
<h2 id="cadvisor-容器监控组件">cadvisor 容器监控组件</h2>
<blockquote>
<p>容器数据采集端，部署在被监控容器所在宿主的10052端口</p>
</blockquote>
<pre><code class="language-bash">dockerRoot=`docker info | awk -F':'  '/Docker Root Dir/&#123;print $2&#125;'|sed 's@^ *@@g'`
echo $dockerRoot
docker run \
  --restart=always \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:rw \
  --volume=/sys:/sys:ro \
  --volume=$&#123;dockerRoot&#125;/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=10052:8080 \
  --privileged=true \
  --detach=true \
  --name=cadvisor \
  google/cadvisor:latest
</code></pre>
<h1>使用</h1>
<h2 id="添加-grafana-数据源-proms">添加 grafana 数据源 : proms</h2>
<p><img src="/posts/65820315/image-20201218135400147.png" alt="image-20201218135400147"></p>
<h2 id="添加-grafana-监控模板">添加 grafana 监控模板</h2>
<p><img src="/posts/65820315/image-20201218135502105.png" alt="image-20201218135502105"></p>
<p>node模板：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/8919">https://grafana.com/grafana/dashboards/8919</a></p>
<p>docker模板：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/10566">https://grafana.com/grafana/dashboards/10566</a></p>

</div>


    <div class="post-guide">
        <div class="item left">
            
              <a href="/posts/e1096625/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  k8s☞记录点
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/posts/ed865d2f/">
                zabbix☞server安装注意事项
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>



	<div id="vcomments"></div>


<script>
	
		// 评论
		new Valine({
			el: '#vcomments',
			appId: 'Sq2igagqhmGqvs3eHHtcNKiB-gzGzoHsz',
			appKey: 'cDTpqcpogeQq55SOuBHEXv9W',
			placeholder: '写点东西吧',
			path: window.location.pathname,
			avatar: 'retro',
			highlight: false,
      recordIP: true,
      enableQQ: true,
			requiredFields: ['nick','mail']
		})
	
	
    // 显示次数
		function showTime(Counter) {
			var query = new AV.Query("Counter");
			if($(".leancloud_visitors").length > 0){
				var url = $(".leancloud_visitors").attr('id').trim();
				// where field
				query.equalTo("words", url);
				// count
				query.count().then(function (number) {
					// There are number instances of MyClass where words equals url.
					$(document.getElementById(url)).text(number?  number : '--');
				}, function (error) {
					// error is an instance of AVError.
				});
			}
		}
		// 追加pv
		function addCount(Counter) {
			var url = $(".leancloud_visitors").length > 0 ? $(".leancloud_visitors").attr('id').trim() : 'wujun234.github.io';
			var Counter = AV.Object.extend("Counter");
			var query = new Counter;
			query.save({
				words: url
			}).then(function (object) {
			})
		}
		$(function () {
			var Counter = AV.Object.extend("Counter");
			addCount(Counter);
			showTime(Counter);
		});
	
</script>
	</div>
	<div id="footer">
	<p>
	©2016-<span id="footerYear"></span> 
	<a href="/">zyh</a> 
	
	
		|
		<span id="busuanzi_container_site_pv">
			pv
			<span id="busuanzi_value_site_pv"></span>
		</span>
		|
		<span id="busuanzi_container_site_uv"> 
			uv
			<span id="busuanzi_value_site_uv"></span>
		</span>
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>
<script type="text/javascript"> 
	document.getElementById('footerYear').innerHTML = new Date().getFullYear() + '';
</script>
	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>