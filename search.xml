<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>k8sâ˜13é«˜çº§ç‰ˆè´Ÿè½½å‡è¡¡ingress</title>
      <link href="posts/7627a41d/"/>
      <url>posts/7627a41d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ingress å¯ä»¥æä¾›è´Ÿè½½å‡è¡¡/SSLç®¡ç†/è™šæ‹Ÿå‘½åä¸»æœº/pathè·¯ç”±. å°±å¦‚åŒå®Œæ•´ç‰ˆçš„nginxä¸€æ ·. å®ƒå°±å¦‚åŒ Service å¯¹è±¡çš„è¶…é›†. ä½ å¯ä»¥é€šè¿‡ Ingress å°†è¯·æ±‚è½¬å‘åˆ°å„ä¸ª Service å¯¹è±¡.</p><p>ä½†æ˜¯ingressæœ¬èº«å¹¶ä¸æ˜¯è§„åˆ™çš„æ‰§è¡Œè€…. å®ƒåªæ˜¯è®°å½•è§„åˆ™, è§„åˆ™æ‰§è¡Œè€…ç”±ingress-controllerå®ç°.</p><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>ingress æä¾›è§„åˆ™, å®ƒéœ€è¦å’Œåç«¯ä¸šåŠ¡ä½äºåŒä¸€ä¸ªnsä¸­.</li><li>ingress controller å®ç°è§„åˆ™, å®ƒå¯ä»¥å•ç‹¬æ˜¯ä¸€ä¸ªns.å› ä¸ºå®ƒä¼šè‡ªåŠ¨å»æ‰¾é‚£äº›æ³¨è§£å«æœ‰è‡ªå·±çš„ingress.</li><li>ingress åªé’ˆå¯¹ http å’Œ https. è¿™äº›ä¹‹å¤–çš„ç«¯å£æš´æ¼ä½ åº”è¯¥ä½¿ç”¨ Service.Type=NodePort æˆ–è€… Service.Type=LoadBalancer</li></ul><h2 id="æµé‡è·¯å¾„">æµé‡è·¯å¾„</h2><p>internet =&gt; Ingress =&gt; Service</p><h2 id="Ingress">Ingress</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">https://kubernetes.io/docs/concepts/services-networking/ingress/</a></p><h3 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h3><p>client =&gt; <a href="http://one.foo.com/one">http://one.foo.com/one</a> =&gt; Ingress = &gt; Service(one):8001 =&gt; pod</p><p>client =&gt; http://*.foo.com/other =&gt; Ingress  =&gt; Service(other):8002 =&gt; pod</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">minimal-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">one.foo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/one</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">one</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8001</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">&quot;*.foo.com&quot;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/other&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">other</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8002</span></span><br></pre></td></tr></table></figure><p>ğŸŒŸè¯·æ³¨æ„, <code>networking.k8s.io/v1</code>å¿…é¡»æ˜¯v1.19+æ‰å¯ä»¥ä½¿ç”¨, å¦‚æœä½ ä¸æ˜¯,åˆ™åº”è¯¥ä½¿ç”¨<code>networking.k8s.io/v1beta1</code></p><p>æ—¢ç„¶Ingressæ˜¯å’Œnginxä¸€ä¸ªå±‚æ¬¡çš„æœåŠ¡,é‚£å¿…ç„¶ä¼šæœ‰ä¸€äº›ç›¸åŒçš„æ¦‚å¿µ.</p><p>nginx.servername:  è¿™é‡Œæ˜¯ spec.rules[].host</p><p>nginx.location: è¿™é‡Œæ˜¯ spec.rules.http.paths[].path</p><p>nginx.upstream: è¿™é‡Œæ˜¯ spec.rules.http.paths[].backend</p><h3 id="å…³äº-spec-rules-host">å…³äº spec.rules[].host</h3><p>è¿™é‡Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹. host æ”¯æŒç»Ÿé…åŒ¹é…. ä¸è¿‡ <code>*</code>ä¸èƒ½è·¨çº§åŒ¹é…. ä¾‹å¦‚,</p><p>*.abc.com å¯ä»¥åŒ¹é… <a href="http://one.abc.com">one.abc.com</a> ä½†æ˜¯ä¸èƒ½åŒ¹é… <a href="http://two.one.abc.com">two.one.abc.com</a>.</p><h3 id="å…³äº-spec-rules-http-paths-path">å…³äº spec.rules.http.paths[].path</h3><p>è¿™é‡Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹.å¦‚ä¸Šä¾‹å­æ‰€è¿°. pathType å®šä¹‰äº† path çš„ç±»å‹. å®ƒæœ‰ä¸‰ä¸ªç±»å‹:</p><ul><li><p>ImplementationSpecific: å·²ingress classä¸ºåŸºå‡†. å…·ä½“å¦‚ä½•åŒ¹é…,éœ€è¦çœ‹é€‰ç”¨çš„ingress class.è¿™æ˜¯é»˜è®¤çš„.</p></li><li><p>Exact: ä¸¥æ ¼åŒ¹é…. ä¸èƒ½æœ‰ä¸€ç‚¹ä¸åŒ.</p></li><li><p>Prefix: åŸºäº&quot;/&quot;åˆ†æ®µè¿›è¡Œå‰ç¼€åŒ¹é…. ä¾‹å¦‚,</p><ul><li>/aaa/bbb å¯ä»¥åŒ¹é…ä»»ä½• /aaa/bbb/ å¼€å¤´çš„, æˆ–è€… /aaa/bbb.  å› æ­¤ /aaa/bbbb æ˜¯ä¸èƒ½åŒ¹é…çš„.</li><li>/aaa å¯ä»¥åŒ¹é…ä»»ä½• /aaa/ å¼€å¤´çš„, æˆ–è€… /aaa. å› æ­¤, /aaaa æ˜¯ä¸èƒ½åŒ¹é…çš„.</li><li>/ å¯ä»¥åŒ¹é…ä»»ä½• / å¼€å¤´çš„. å› æ­¤, åŒ¹é…æ‰€æœ‰.</li></ul><p>â­ï¸è¯·æ³¨æ„, Prefix ç±»å‹ä¸‹.ä½ å†™çš„åŒ¹é…å­—ç¬¦ä¸²é¦–å°¾éƒ½éœ€è¦åŠ <code>/</code>, å¦‚æœä½ å°¾éƒ¨æ²¡æœ‰åŠ <code>/</code>, é‚£ä¹ˆ ingress åœ¨åŒ¹é…çš„æ—¶å€™, ä¹Ÿä¼šå¸®ä½ åŠ ä¸Š<code>/</code>.</p></li></ul><p>å½“Exactå’ŒPrefixæ··ç”¨çš„æ—¶å€™, å¦‚æœä¸€ä¸ªè¯·æ±‚åŒæ—¶åŒ¹é…äº†è¿™ä¸¤ä¸ªç±»å‹ä¸‹çš„path, é‚£ä¹ˆExact ä¼˜å…ˆçº§æ›´é«˜.</p><h3 id="æ„å»ºTLS">æ„å»ºTLS</h3><ol><li><h4 id="åˆ›å»º-Secret-å¯¹è±¡-å¯¼å…¥è¯ä¹¦æ–‡ä»¶">åˆ›å»º Secret å¯¹è±¡, å¯¼å…¥è¯ä¹¦æ–‡ä»¶</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foo-com-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">cert</span> <span class="comment"># è¿™é‡Œéœ€è¦å¡«å†™ base64 ç¼–ç åçš„ cert å†…å®¹. tls.crt ä¸å¯æ›´å</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">base64</span> <span class="string">encoded</span> <span class="string">key</span>  <span class="comment"># è¿™é‡Œéœ€è¦å¡«å†™ base64 ç¼–ç åçš„ key å†…å®¹. tls.key ä¸å¯æ›´å</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br></pre></td></tr></table></figure></li><li><h4 id="åœ¨Ingresså¯¹è±¡ä¸­è°ƒç”¨-Secret">åœ¨Ingresså¯¹è±¡ä¸­è°ƒç”¨ Secret</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tls-example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https-example.foo.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">foo-com-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">https-example.foo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure></li></ol><p>é€šè¿‡é…ç½®æ–‡ä»¶, å¯ä»¥çœ‹å‡ºæ¥åŠ å¯†åˆ°Ingresså°±åœæ­¢äº†(åç«¯Serviceå¯¹è±¡service1çš„ç«¯å£æ˜¯80).è¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬åœ¨ék8sç¯å¢ƒä¸­çš„æµç¨‹.</p><p>å¦å¤–, ä¸åŒçš„Ingressæ§åˆ¶å™¨å¯¹äºTLSè¿™å—ä¹Ÿæœ‰ä¸€å®šå·®å¼‚.å…·ä½“ä»¥æ§åˆ¶å™¨æœ¬èº«è¯´æ˜ä¸ºå‡†.</p><h2 id="Ingress-controller">Ingress controller</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/</a></p><p>Ingress æƒ³è¦æ­£å¸¸è¿ä½œ, éœ€è¦Ingressæ§åˆ¶å™¨çš„æ”¯æŒ. endpoints â€œdefault-http-backendâ€ not found</p><p>ä½ å¯ä»¥åœ¨k8sä¸­éƒ¨ç½²å¤šä¸ªIngressæ§åˆ¶å™¨, ä½†æ˜¯ä½ éœ€è¦é€šè¿‡åœ¨ annotations ä¸­ç”¨ ingress.class æ³¨è§£å¼ºè°ƒä½ æƒ³ç”¨å“ªä¸€æ¬¾.</p><p>å°±åƒä¸‹é¢è¿™æ ·</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">serviceName:</span> <span class="string">service-http</span></span><br><span class="line">    <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬é€‰ç”¨k8sç»´æŠ¤çš„nginxæ§åˆ¶å™¨.å®ƒçš„éƒ¨ç½²æ–‡æ¡£æ˜¯: <a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md">https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md</a> æˆ–è€… <a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a></p><p>æˆ‘ä»¬å°†é€šè¿‡helmæ¥å®‰è£…ingress-nginx. (ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å…¶å®ƒå®‰è£…æ–¹å¼. åœ¨ <a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a> ä¸­å¯ä»¥æ‰¾åˆ°å¾ˆå¤šä¸åŒç¯å¢ƒçš„å®‰è£…æ–¹å¼. )</p><p>è¿™é‡Œæ˜¯ helm çš„å®‰è£…æ–‡æ¡£: <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></p><p>å½“å‰å®ƒçš„å®‰è£…æ–¹å¼åº”è¯¥æ˜¯:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3</span><br><span class="line">chmod 700 get_helm.sh</span><br><span class="line">./get_helm.sh</span><br></pre></td></tr></table></figure><p>å½“å‰ingress-nginxçš„ä»“åº“åœ°å€æ˜¯: <a href="https://hub.helm.sh/charts/ingress-nginx/ingress-nginx">https://hub.helm.sh/charts/ingress-nginx/ingress-nginx</a> ä½ å¯ä»¥åœ¨è¿™é‡Œç›´æ¥æ‰¾åˆ°å®‰è£…å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">kubectl create namespace ingress-nginx</span><br><span class="line">helm install ingress-nginx ingress-nginx/ingress-nginx -n ingress-nginx</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get all -n ingress-nginx</span><br><span class="line">===</span><br><span class="line">NAME                                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/ingress-nginx-controller-5886685d54-hf6l6   1/1     Running   0          68m</span><br><span class="line"></span><br><span class="line">NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">service/ingress-nginx-controller             LoadBalancer   10.96.210.139   &lt;pending&gt;     80:32489/TCP,443:30936/TCP   68m</span><br><span class="line">service/ingress-nginx-controller-admission   ClusterIP      10.96.128.101   &lt;none&gt;        443/TCP                      68m</span><br><span class="line"></span><br><span class="line">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/ingress-nginx-controller   1/1     1            1           68m</span><br><span class="line"></span><br><span class="line">NAME                                                  DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/ingress-nginx-controller-5886685d54   1         1         1       68m</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ingress-nginx æ§åˆ¶å™¨åˆ›å»ºäº†ä¸€ä¸ª pod, è¿™ä¸ª pod å…¶å®å°±æ˜¯ä¸€ä¸ª nginx. å®ƒé€šè¿‡æ¥æ”¶ ingress å®šä¹‰çš„è§„åˆ™, æ¥åŠ¨æ€çš„å˜æ›´nginxé…ç½®,ä»è€Œæ­£ç¡®çš„å°†æµé‡è½¬å‘ç»™åç«¯åº”ç”¨çš„serviceå¯¹è±¡.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe pod/ingress-nginx <span class="built_in">exec</span> -it pod/ingress-nginx-controller-5886685d54-hf6l6</span><br><span class="line">===</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:      100m</span><br><span class="line">      memory:   90Mi</span><br></pre></td></tr></table></figure><p>å½“å‰é…ç½®é»˜è®¤æ²¡æœ‰åšlimité™åˆ¶. æ‰€ä»¥éœ€è¦å…³æ³¨ingress-nginxåˆ›å»ºçš„podæ‰€åœ¨ç‰©ç†èŠ‚ç‚¹çš„æ€§èƒ½æ˜¯å¦å¯ä»¥æ»¡è¶³. å»ºè®®å¼ºåˆ¶ç»‘å®šåˆ°å¤šä¸ªnodeèŠ‚ç‚¹, è¿™æ‰¹èŠ‚ç‚¹ä¸“é—¨è·‘ç”¨æ¥è¿›è¡Œingressæ§åˆ¶å™¨.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl --namespace ingress-nginx <span class="built_in">exec</span> -it pod/ingress-nginx-controller-5886685d54-hf6l6 -- /bin/bash</span><br><span class="line">==</span><br><span class="line">cat /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ingress-nginxä¼šåŠ¨æ€çš„åŠ è½½ingresså®šä¹‰çš„è·¯ç”±è§„åˆ™.</p><p>æœ€å, æˆ‘ä»¬å¯èƒ½æœ€éœ€è¦å…³æ³¨çš„æ˜¯ service/ingress-nginx-controller. å› ä¸ºå®ƒçš„ç±»å‹å†³å®šäº†, æˆ‘ä»¬å¦‚ä½•è§£æå°†è¦æš´æ¼çš„æœåŠ¡åŸŸå.</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é€šè¿‡helmé»˜è®¤å®‰è£…çš„ ingress crotroller çš„ Service å¯¹è±¡æ˜¯LoadBalancerç±»å‹. è¿™ç§ç±»å‹æˆ‘ä»¬ä¸€èˆ¬æ˜¯ç”¨äºäº‘ç«¯ç¯å¢ƒçš„. è€Œæˆ‘è¿™é‡Œæµ‹è¯•ç¯å¢ƒæ˜¯è£¸æœº,å› æ­¤ä½ å¯ä»¥çœ‹åˆ°è¿™é‡Œå®ƒä¸€ç›´æ— æ³•è·å–åˆ°<code>EXTERNAL-IP</code>.</p><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜.k8så®˜æ–¹æ–‡æ¡£è¿™é‡Œæä¾›äº†å¤šç§æ–¹æ¡ˆ. <a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/</a></p><p>æˆ‘ä»¬è¿™é‡Œé€šè¿‡ <a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a> æ¥è§£å†³ LB ç±»å‹çš„ <code>EXTERNAL-IP</code>è·å–é—®é¢˜. å…¶å®ƒæ–¹æ¡ˆå¹¶ä¸æ˜¯é‡‡ç”¨çš„ LB ç±»å‹, å› ä¸ºè¿™é‡Œä¸å†å™è¯´.</p><p>metallb æ–¹æ¡ˆåœ¨å½“å‰å¹¶ä¸æ˜¯ä¸€ä¸ªæˆç†Ÿçš„æ–¹æ¡ˆ,å½“ç„¶å®ƒåº”è¯¥æ˜¯å¯ç”¨çš„ğŸ˜„ æ‰€ä»¥ç”¨äºæœ¬åœ°æµ‹è¯•ç¯å¢ƒæ˜¯å¯ä»¥çš„. çº¿ä¸Šç¯å¢ƒå»ºè®®ç›´æ¥ç”¨äº‘æœåŠ¡çš„LBå³å¯.</p><h2 id="metallb">metallb</h2><p><a href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></p><p>metallb æ¨¡æ‹Ÿäº†äº‘ç¯å¢ƒä¸­çš„è´Ÿè½½å‡è¡¡å™¨åŠŸèƒ½.</p><p>ğŸŒŸIf youâ€™re using kube-proxy in IPVS mode, since Kubernetes v1.14.2 you have to enable strict ARP mode.</p><p>å¦‚æœä½ æ˜¯ipvs ä¸” k8s ç‰ˆæœ¬åœ¨1.14.2ä»¥ä¸Š, é‚£ä¹ˆä½ éœ€è¦å¯åŠ¨ä¸¥æ ¼arpæ¨¡å¼.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl edit configmap -n kube-system kube-proxy</span><br><span class="line">===</span><br><span class="line">ipvs:</span><br><span class="line">  strictARP: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å¼€å§‹å®‰è£…</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/namespace.yaml</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/metallb.yaml</span><br><span class="line"><span class="comment"># ä¸‹é¢è¿™ä¸ªå‘½ä»¤ä»…åœ¨ä½ åˆå§‹å®‰è£…çš„æ—¶å€™éœ€è¦è¿è¡Œ</span></span><br><span class="line">kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=<span class="string">&quot;<span class="subst">$(openssl rand -base64 128)</span>&quot;</span></span><br></pre></td></tr></table></figure><p>metallbå°†ä¼šåœ¨ä¸€ä¸ªæ–°çš„ns: metallb-systemä¸‹åˆ›å»º.</p><p>å¼€å§‹é…ç½®åœ°å€æ± </p><p>metallbé€šè¿‡ä¸€ä¸ªåœ°å€æ± cmæ¥ç»™LBåˆ†å‘ip. æˆ‘ä»¬å°†ä¸º metallb ä¸‹å‘ä¸€ä¸ªå†…ç½‘åœ°å€æ± . è¯·è®°ä½, è¿™äº›åœ°å€å¿…é¡»æ˜¯æ²¡æœ‰è¢«å…¶å®ƒèµ„æºå ç”¨çš„.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># metallb.cm.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">metallb-system</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">address-pools:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">layer2</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.200</span><span class="number">.16</span><span class="number">.11</span><span class="number">-10.200</span><span class="number">.16</span><span class="number">.29</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f metallb.cm.yaml</span><br></pre></td></tr></table></figure><p>ä¸‹é¢,è®©æˆ‘ä»¬å†çœ‹çœ‹ ingress crotroller çš„ svc å¯¹è±¡ä¿¡æ¯.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get svc -n ingress-nginx</span><br><span class="line">===</span><br><span class="line">NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                      AGE</span><br><span class="line">ingress-nginx-controller             LoadBalancer   10.96.210.139   10.200.16.11   80:32489/TCP,443:30936/TCP   88m</span><br><span class="line">ingress-nginx-controller-admission   ClusterIP      10.96.128.101   &lt;none&gt;         443/TCP                      88m</span><br></pre></td></tr></table></figure><p>ç»ˆäºå®ƒæ‹¿åˆ°äº†ä¸€ä¸ªæˆ‘ä»¬æƒ³è®©å®ƒè·å¾—çš„ip, ç°åœ¨ä½ å°±å¯ä»¥å°†åŸŸåè§£æåˆ°<code>EXTERNAL-IP</code>, å¹¶é€šè¿‡è¿™ä¸ªåŸŸåæ¥è®¿é—®ä½ çš„åº”ç”¨äº†.(è€Œä¸”å®ƒå¿…é¡»æ˜¯èƒ½é€šè¿‡80è®¿é—®çš„.)ğŸ˜„</p><p>åŒæ—¶, è®©æˆ‘ä»¬æ¥çœ‹çœ‹ ingress å¯¹è±¡ä¿¡æ¯.</p><p>â­ï¸æˆ‘æš´æ¼çš„åº”ç”¨åœ¨ns: itä¸­.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get ingress -n it</span><br><span class="line">===</span><br><span class="line">NAME                   CLASS    HOSTS          ADDRESS        PORTS   AGE </span><br><span class="line">nas-it-local-ingress   &lt;none&gt;   nas.it.local   10.200.16.11   80      106m</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°. ingress çš„ä¿¡æ¯ä¹Ÿæ›´æ–°äº†, å¹¶æ‹¿åˆ°äº† metallb çš„ä¸‹å‘çš„ip.</p><p>ä½ å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šé€šè¿‡ ipvs è§„åˆ™æ¥çœ‹åˆ°è½¬å‘æƒ…å†µ.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ipvsadm -L -n</span><br><span class="line">===</span><br><span class="line">TCP  10.200.16.11:80 rr</span><br><span class="line">  -&gt; 10.97.2.57:80                Masq    1      0          0</span><br><span class="line">TCP  10.200.16.11:443 rr</span><br><span class="line">  -&gt; 10.97.2.57:443               Masq    1      0          0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ 10.97.2.57 æ˜¯ ingress æ§åˆ¶å™¨çš„ pod ip.</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜12æœ‰çŠ¶æ€æœåŠ¡</title>
      <link href="posts/4bf29cf0/"/>
      <url>posts/4bf29cf0/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å½“æˆ‘ä»¬æ„å»ºä¸€ä¸ªæœ‰çŠ¶æ€çš„åº”ç”¨çš„æ—¶å€™,æˆ‘ä»¬å¯èƒ½ä¼šæœ‰ä¸‹åˆ—é¢„æœŸ:</p><ul><li>ç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦ã€‚</li><li>ç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨ã€‚</li><li>æœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œç¼©æ”¾ã€‚</li><li>æœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–°ã€‚</li></ul><p>StatefulSet å°±æ˜¯å¹²è¿™ä¸ªçš„.</p><h2 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    name: web</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  serviceName: &quot;nginx&quot;</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: k8s.gcr.io&#x2F;nginx-slim:0.8</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: www</span><br><span class="line">          mountPath: &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: www</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­, åˆ›å»ºä¸€ä¸ª headless service å’Œ ä¸€ä¸ª statefulset. headless ç”¨æ¥å‘å¸ƒ statefulset ä¸­çš„ pod ip.</p><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>pod æ‹¥æœ‰å”¯ä¸€çš„é¡ºåºç´¢å¼•å’Œç¨³å®šçš„ç½‘ç»œèº«ä»½(ä¸ç®¡æ€ä¹ˆåˆ , åå­—éƒ½ä¸å˜, ip ä¼šå˜). pod è¢«éƒ¨ç½²çš„æ—¶å€™å…¶åå­—æ˜¯æŒ‰ç…§<code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>åˆ›å»ºçš„(web-0, web-1). è¿™ä¸ªåå­—å°±æ˜¯ä»–ä»¬çš„hostname.(è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>pod ä¸ç®¡æ€ä¹ˆåˆ , podä¸pvcä¹‹é—´çš„å…³ç³»éƒ½ä¸ä¼šæ··ä¹±.</li><li>å¯åŠ¨ pod çš„æ—¶å€™, æŒ‰ç…§ç´¢å¼•, ä» 0 å¼€å§‹. ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨. ä¸ä¼šåŒæ—¶å¯åŠ¨å¤šä¸ª. (è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>åˆ é™¤ pod çš„æ—¶å€™, æŒ‰ç…§ç´¢å¼•å€’åºåˆ é™¤, ä»æœ€åä¸€ä¸ªå¼€å§‹, ä¸€ä¸ªä¸€ä¸ªåˆ é™¤. ä¸ä¼šåŒæ—¶åˆ é™¤å¤šä¸ª. (è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>åˆ é™¤ pod çš„æ—¶å€™, pvc å’Œ pv å¹¶ä¸ä¼šåˆ é™¤.</li><li>Service å¿…é¡»æ˜¯ headless .</li></ul><blockquote><p>ä½ å¯ä»¥é€šè¿‡è®¾ç½®statefulsetç®¡ç†ç­–ç•¥, æ¥æ”¹å˜ä¸Šè¿°é»˜è®¤è¡Œä¸º</p><p><a href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy">https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy</a></p></blockquote><h2 id="æ‰©å±•-ç¼©æ”¾">æ‰©å±•/ç¼©æ”¾</h2><p>æ‰©å±•: <code>kubectl scale sts web --replicas=5</code></p><p>ç¼©æ”¾: <code>kubectl patch sts web -p '&#123;&quot;spec&quot;:&#123;&quot;replicas&quot;:3&#125;&#125;'</code></p><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œ replicas çš„å€¼æ¥è¿›è¡Œå˜æ›´.</p><h2 id="æ›´æ–°">æ›´æ–°</h2><p>æœ‰çŠ¶æ€åº”ç”¨çš„æ›´æ–°å’Œæ— çŠ¶æ€åº”ç”¨çš„æ›´æ–°æœ‰äº›å·®å¼‚.</p><p>æœ‰çŠ¶æ€åº”ç”¨çš„æ›´æ–°ç­–ç•¥(spec.updateStrategy)æ˜¯ RollingUpdate å’Œ OnDelete. å…¶ä¸­ RollingUpdate æ˜¯é»˜è®¤ç­–ç•¥, è¿™ä¸ªæ˜¯è‡ªåŠ¨æ»šåŠ¨æ›´æ–°. è€ŒOnDeleteçš„æ„æ€æ˜¯åªæœ‰ä½ æ‰‹åŠ¨åˆ é™¤äº†podæ‰ä¼šæ›´æ–°.</p><p>æ›´æ–°æ˜¯é’ˆå¯¹podæ¨¡æ¿çš„. ä¾‹å¦‚:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch statefulset web --<span class="built_in">type</span>=<span class="string">&#x27;json&#x27;</span> -p=<span class="string">&#x27;[&#123;&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;gcr.io/google_containers/nginx-slim:0.8&quot;&#125;]&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæ›´æ–°äº†nginxçš„é•œåƒ.</p></blockquote><p>è¦æƒ³æ›´æ–°, åˆ™éœ€è¦å…ˆä¿è¯æ‰€æœ‰çš„ pod æ˜¯å°±ç»ªçŠ¶æ€.</p><p>æ›´æ–°å’Œåˆ é™¤åŠ¨ä½œä¸€æ ·, å‡é‡‡ç”¨ç´¢å¼•å€’åºè¿›è¡Œ, å¹¶ä¸”ä¹Ÿæ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ›´æ–°.</p><p>å½“æ›´æ–°å¤±è´¥çš„æ—¶å€™, æ‰€æœ‰çš„podå°†æ¢å¤åˆ°å½“å‰ç‰ˆæœ¬.(ä¹Ÿå°±æ˜¯è¯´å·²ç»æ”¶åˆ°æ›´æ–°çš„podæ¢å¤åˆ°æ›´æ–°çš„ç‰ˆæœ¬, æ²¡æœ‰å¼€å§‹æ›´æ–°çš„podå°†æ¢å¤åˆ°æ›´æ–°å‰çš„ç‰ˆæœ¬)</p><ul><li>éœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœä½ å› äºŒè¿›åˆ¶æ–‡ä»¶æ•…éšœæˆ–è€…é…ç½®æ–‡ä»¶é”™è¯¯å¯¼è‡´æ›´æ–°å¤±è´¥å, åˆ™å¯èƒ½ä½ å·²ç»æ¢å¤äº†æ›´æ–°å‰çš„æ¨¡æ¿,å´å‘ç°statefulsetä¾ç„¶ä¸æ­£å¸¸, åˆ™ä½ éœ€è¦æ‰‹åŠ¨åˆ é™¤æ‰€æœ‰ç”±é”™è¯¯æ¨¡æ¿äº§å‡ºçš„pod.ä¹‹åstatefulsetå°†ä¼šé‡‡ç”¨æ›´æ–°å‰çš„æ¨¡æ¿é‡å»ºpod. (<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#forced-rollback">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#forced-rollback</a>)</li></ul><h2 id="é˜¶æ®µæ›´æ–°-staging-an-update">é˜¶æ®µæ›´æ–°(staging an update)</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½å¹¶ä¸æƒ³ä¸€æ¬¡æ›´æ–°æ‰€æœ‰, æ­¤æ—¶å¯ä»¥è¿›è¡Œé˜¶æ®µæ›´æ–°.</p><p>é˜¶æ®µæ›´æ–°çš„æ„æ€å°±æ˜¯é€šè¿‡åœ¨ç´¢å¼•ä¸Šè®¾ç½®ä¸€ä¸ªç‚¹. å½“podçš„ç´¢å¼•å¤§äºç­‰äºè¿™ä¸ªç‚¹çš„æ—¶å€™, æ‰ä¼šæ›´æ–°. (é»˜è®¤ç‚¹æ˜¯ç´¢å¼•0)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl patch statefulset web -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;updateStrategy&quot;:&#123;&quot;type&quot;:&quot;RollingUpdate&quot;,&quot;rollingUpdate&quot;:&#123;&quot;partition&quot;:3&#125;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ„æ€æ˜¯è®¾ç½®ç´¢å¼•3ä¸ºé˜¶æ®µåˆ†å‰²ç‚¹.</p><h2 id="åˆ é™¤">åˆ é™¤</h2><p>åˆ é™¤åˆ†ä¸ºè”çº§åˆ é™¤å’Œéè”çº§åˆ é™¤.</p><p>è”çº§åˆ é™¤å°±æ˜¯ statefulset å’Œ pod éƒ½åˆ é™¤</p><p>éè”çº§åˆ é™¤, åªä¼šåˆ é™¤ statefulset. ä½ å¯ä»¥é€šè¿‡åˆ é™¤çš„æ—¶å€™é™„åŠ <code>--cascade=false</code>å¼€å¯å®ƒ.</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> StatefulSet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜12å®ˆæŠ¤è¿›ç¨‹</title>
      <link href="posts/63d8d3d4/"/>
      <url>posts/63d8d3d4/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>DaemonSet ç¡®ä¿æŒ‡å®šçš„nodeä¸Šéƒ½å­˜åœ¨ä¸€ä»½ pod. å¸¸ç”¨æ¥æ„å»ºä¸€äº›æ‰¹é‡ä»£ç†æ€§è´¨çš„app. ä¾‹å¦‚ç›‘æ§èŠ‚ç‚¹app, æˆ–è€…æ—¥å¿—èŠ‚ç‚¹app</p><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>å½“ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤, æˆ–ä»é›†ç¾¤ä¸­åˆ é™¤, åˆ™ pod ä¼šè¢«æ·»åŠ /åˆ é™¤</li><li>å½“DaemonSetè¢«åˆ é™¤, åˆ™ pod éƒ½ä¼šè¢«åˆ é™¤.</li><li>podæ¨¡æ¿ä¸­çš„ RestartPolicy å¿…é¡»æ˜¯é»˜è®¤å€¼, ä¹Ÿå°±æ˜¯ Always.</li><li>åˆ›å»ºå.spec.selector ä¸å¯ä¿®æ”¹.</li><li>é»˜è®¤è°ƒåº¦åœ¨æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„nodeä¸Š.</li></ul><h2 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="comment"># this toleration is to have the daemonset runnable on master nodes</span></span><br><span class="line">      <span class="comment"># remove it if your masters can&#x27;t run pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd-elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ—¥å¿—é‡‡é›†pod. å®ƒå°†k8sé›†ç¾¤èŠ‚ç‚¹çš„ /var/log å’Œ /var/lib/docker/containers æŒ‚è½½åˆ° pod ä¸­. è¿™æ ·, elasticsearch å°±å¯ä»¥è·å–åˆ°k8sé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯äº†.</p><h2 id="podè¿è¡Œåœ¨éƒ¨åˆ†nodeä¸Š">podè¿è¡Œåœ¨éƒ¨åˆ†nodeä¸Š</h2><p>ä½ æœ‰ä¸¤ç§æ–¹å¼å¤„ç†podçš„éƒ¨åˆ†è°ƒåº¦.</p><h3 id="é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾-nodeSelector-æ¥é€‰æ‹©">é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾(nodeSelector)æ¥é€‰æ‹©.</h3><p><code>.spec.template.spec.nodeSelector</code>å¯ä»¥è®©ä½ ä»…åœ¨åŒ¹é…çš„nodeä¸Šåˆ›å»ºpod.</p><p>ä¾‹å¦‚: ä»…åœ¨æ‹¥æœ‰ssdç£ç›˜çš„èŠ‚ç‚¹ä¸Šæ„å»º</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡èŠ‚ç‚¹äº²å’Œæ€§-nodeAffinity-æ¥é€‰æ‹©">é€šè¿‡èŠ‚ç‚¹äº²å’Œæ€§(nodeAffinity)æ¥é€‰æ‹©</h3><p><code>.spec.affinity.nodeAffinity</code> , å®ƒæœ‰ä»¥ä¸‹å±æ€§: (æ¯ä¸€ä¸ªå±æ€§ç”±ä¸¤éƒ¨åˆ†æ„æ€ç»„æˆ)</p><p>requiredDuringScheduling<strong>IgnoredDuringExecution</strong><br>è¡¨ç¤ºpodå¿…é¡»éƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p><p>requiredDuringScheduling<strong>RequiredDuringExecution</strong><br>è¡¨ç¤ºpodå¿…é¡»éƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œåˆ™é‡æ–°é€‰æ‹©ç¬¦åˆè¦æ±‚çš„èŠ‚ç‚¹ã€‚</p><p>preferredDuringScheduling<strong>IgnoredDuringExecution</strong><br>è¡¨ç¤ºä¼˜å…ˆéƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p><p>preferredDuringScheduling<strong>RequiredDuringExecution</strong><br>è¡¨ç¤ºä¼˜å…ˆéƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºå¦‚æœåé¢èŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œæ»¡è¶³äº†æ¡ä»¶ï¼Œåˆ™é‡æ–°è°ƒåº¦åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/e2e-az-name</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">e2e-az1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">e2e-az2</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">another-node-label-key</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">another-node-label-value</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gcr.io/google_containers/pause:2.0</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé…ç½®çš„æ„æ€æ˜¯pod<strong>å¿…é¡»è¢«è°ƒåº¦</strong><a href="http://xn--kubernetes-m11qu01s34wc.io/e2e-az-name=e2e-az1%E6%88%96%E8%80%85kubernetes.io/e2e-az-name=e2e-az2">åˆ°æ ‡ç­¾kubernetes.io/e2e-az-name=e2e-az1æˆ–è€…kubernetes.io/e2e-az-name=e2e-az2</a> çš„èŠ‚ç‚¹ã€‚ä¸æ­¤åŒæ—¶, è¿˜å°†åœ¨ä¸Šè¿°æ¡ä»¶çš„åŸºç¡€ä¸Š, <strong>ä¼˜å…ˆè°ƒåº¦</strong>åˆ°é¢å¤–æ‹¥æœ‰æ ‡ç­¾ä¸ºanother-node-label-key=another-node-label-valueçš„èŠ‚ç‚¹ä¸Šã€‚</p><h2 id="æ±¡ç‚¹å’Œå®¹å¿åº¦Taint-and-toleration">æ±¡ç‚¹å’Œå®¹å¿åº¦Taint-and-toleration</h2><p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/</a></p><p>k8sé€šè¿‡æ±¡ç‚¹æ¥å‰”é™¤æŸäº›æ•…éšœèŠ‚ç‚¹, æˆ–æ„å»ºä¸€äº›ä¸“å±èŠ‚ç‚¹.</p><p>k8sé€šè¿‡å®¹å¿åº¦æ¥ç¡®ä¿æŸäº›podå¯ä»¥å¿½ç•¥æ±¡ç‚¹.</p><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹. æ²¡æœ‰ä»»ä½•å®¹å¿åº¦çš„podä¸ä¼šè¢«è°ƒåº¦åˆ°å­˜åœ¨æ±¡ç‚¹çš„nodeä¸Š. (å½“å‡ºç°èŠ‚ç‚¹æ•…éšœæ—¶å€™, é»˜è®¤ä¼šé™„åŠ ä¸€ä¸ªå®¹å¿åº¦, å®¹å¿åº¦å¤±æ•ˆ300ç§’)</p><p>ä½†DaemonSetå´éœ€è¦å¿½ç•¥è¿™äº›æ±¡ç‚¹, ä»¥ä¾¿äºpodé•¿å­˜. (ä¾‹å¦‚ä½ æ„å»ºçš„ç›‘æ§pod)</p><p>ä»¥ä¸‹æ˜¯DaemonSetè‡ªåŠ¨é™„åŠ çš„å®¹å¿åº¦, å®ƒå°†å¿½ç•¥è¿™äº›æ±¡ç‚¹. (æˆªè‡³åˆ°v1.19)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node.kubernetes.io/not-ready</span><br><span class="line">node.kubernetes.io/unreachable</span><br><span class="line">node.kubernetes.io/disk-pressure</span><br><span class="line">node.kubernetes.io/memory-pressure</span><br><span class="line">node.kubernetes.io/unschedulable</span><br><span class="line">node.kubernetes.io/network-unavailable</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æƒ…å†µåŸºæœ¬ä¿è¯äº†DaemonSetçš„podä¸ä¼šå› å„ç§æ„å¤–æƒ…å†µå¯¼è‡´podè¢«é©±é€.</p><h2 id="è®¿é—®DaemonSet-pod">è®¿é—®DaemonSet pod</h2><p>ä½ å¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ª Headless Service å¹¶é€šè¿‡ endpoint  æ¥è®¿é—®å„ä¸ª pod.</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> DaemonSet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜11-2namespaceèµ„æºçº¦æŸ</title>
      <link href="posts/ed4c29d5/"/>
      <url>posts/ed4c29d5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://kubernetes.io/docs/concepts/policy/limit-range/">https://kubernetes.io/docs/concepts/policy/limit-range/</a></p><p>namespace èµ„æºçº¦æŸ(LimitRange)é˜²æ­¢podçš„é…ç½®è¶…å‡ºé¢„æœŸ.ä»è€Œè®©æˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿çš„ç®¡ç†èµ„æº.</p><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>æä¾› pod çš„é»˜è®¤èµ„æºçº¦æŸ.</li><li>é™åˆ¶podçš„èµ„æºçº¦æŸ.</li><li>LimitRangeé…ç½®ç­–ç•¥çš„æ„å»ºå’Œå˜æ›´ä»…å½±å“ä¹‹åçš„pod</li></ul><h2 id="æµç¨‹">æµç¨‹</h2><h3 id="æ„å»ºLimitRange">æ„å»ºLimitRange</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cpu-mem-storage-min-max-default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Container</span></span><br><span class="line">    <span class="attr">max:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;1G&quot;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;50m&quot;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;50M&quot;</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;250M&quot;</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;50m&quot;</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;50M&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line">    <span class="attr">max:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">30G</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">8G</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f limitrange-default.yaml --namespace=default</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¾‹å­ä¸º default å‘½åç©ºé—´åŠ äº†ä¸€ä¸ªèµ„æºç­–ç•¥.æ•ˆæœå¦‚ä¸‹:</p><ul><li><p>å½“podæ²¡æœ‰ä»»ä½•é™åˆ¶çš„æ—¶å€™, podè§„åˆ™å¦‚ä¸‹</p><ul><li><p>limit: cpu=250m mem=50M</p></li><li><p>request: cpu=50m mem=50M</p></li><li><p>8G &lt; pvc &lt; 30G</p><p>ä¼šå…¨éƒ¨èµ°limitrangeçš„é»˜è®¤å€¼</p></li></ul></li><li><p>å½“podè®¾ç½®äº†limit: cpu=1000m mem=1Gçš„æ—¶å€™, podè§„åˆ™å¦‚ä¸‹</p><ul><li><p>limit: cpu=1000m mem=1G</p></li><li><p>request: cpu=1000m mem=1G</p></li><li><p>8G &lt; pvc &lt; 30G</p><p>è¿™é‡Œæ¯”è¾ƒå¥‡è‘©, å®˜æ–¹å°±æ˜¯è¿™ä¹ˆè®¾å®šçš„. è™½ç„¶ä½ æ²¡è®¾ç½®request, ä½†æ˜¯request ä¸ä¼šèµ°é»˜è®¤å€¼, ä¼šç»§æ‰¿ limit çš„è‡ªå®šä¹‰å€¼</p></li></ul></li><li><p>å½“podåªè®¾ç½®äº†request: cpu=100m mem=150Mçš„æ—¶å€™, podè§„åˆ™å¦‚ä¸‹</p><ul><li><p>limit: cpu=250m mem=250M</p></li><li><p>request: cpu=100m mem=150M</p></li><li><p>8G &lt; pvc &lt; 30G</p><p>è¿™é‡Œç¬¦åˆå¤§å®¶çš„é€»è¾‘â€¦æ²¡è®¾ç½®å°±æ˜¯èµ°é»˜è®¤.</p></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> èµ„æºçº¦æŸ </tag>
            
            <tag> namespace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜11-1podèµ„æºçº¦æŸ</title>
      <link href="posts/64fa9c84/"/>
      <url>posts/64fa9c84/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</a></p><p>èµ„æºçº¦æŸåœ¨æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„æ—¶å€™ä¸»è¦æ˜¯cpuå’Œå†…å­˜å±‚é¢, ä»¥åŠæœ¬åœ°ä¸´æ—¶å­˜å‚¨(emptyDir)</p><p>k8sèµ„æºçº¦æŸåˆ†ä¸ºä¸¤ç§: request(è½¯çº¦æŸ) å’Œ limits(ç¡¬çº¦æŸ)</p><p>request(è½¯çº¦æŸ)ç¡®ä¿äº†podä¸­çš„å®¹å™¨è‡³å°‘å¯ä»¥ä½¿ç”¨è¿™ä¹ˆå¤šèµ„æº. ä¸è¿‡å½“èŠ‚ç‚¹å¦‚æœæ²¡æœ‰å…¶å®ƒå®¹å™¨,åˆ™æ­¤å®¹å™¨å¯ä»¥çªç ´requesté™åˆ¶.</p><p>limits(ç¡¬çº¦æŸ) åˆ™ä½¿ç¡¬æ€§çš„é™åˆ¶äº†å®¹å™¨èµ„æºä¸Šé™. å¦‚æœå®¹å™¨è¯·æ±‚çš„å†…å­˜å¤§äºäº†limits,åˆ™ä¼šæ”¶åˆ°oomé”™è¯¯. å¦‚æœå®¹å™¨è¯·æ±‚çš„cpuå¤§äºäº†limits, åˆ™ä¸ä¼šäº§å‡ºé”™è¯¯, å› ä¸ºcpuå¯¹äºç¨‹åºæ¥è¯´,å®ƒä¸æ˜¯ä¸€ä¸ªç¡¬æ€§æŒ‡æ ‡.å¦‚æœcpuèµ„æºä¸å¤Ÿ,åªä¼šå¯¼è‡´ç¨‹åºå¡é¡¿åˆ°æ­»â€¦</p><p>æœ€å,k8sä¼šä¸¥æ ¼æŒ‰ç…§podå®šä¹‰çš„èµ„æºé™åˆ¶è¿›è¡Œè°ƒåº¦,å³æ—¶æŸä¸ªèŠ‚ç‚¹ä¸Šæœ‰å¤§é‡ç©ºé—²èµ„æº,ä½†åªè¦ç©ºé—²èµ„æºä¸èƒ½æ»¡è¶³podçš„èµ„æºå®šä¹‰,å°±ä¸èƒ½è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Š.</p><h2 id="å†™æ³•">å†™æ³•</h2><ul><li><code>spec.containers[].resources.limits.cpu </code>cpué™åˆ¶</li><li><code>spec.containers[].resources.limits.memory</code> å†…å­˜é™åˆ¶</li><li><code>spec.containers[].resources.limits.hugepages-&lt;size&gt;</code>   ä¸å¸¸ç”¨, å¯ä»¥å¿½ç•¥</li><li><code>spec.containers[].resources.limits.ephemeral-storage</code> emptyä¸´æ—¶å­˜å‚¨é™åˆ¶</li><li><code>spec.containers[].resources.requests.cpu</code></li><li><code>spec.containers[].resources.requests.memory</code></li><li><code>spec.containers[].resources.requests.hugepages-&lt;size&gt; </code> ä¸å¸¸ç”¨, å¯ä»¥å¿½ç•¥</li><li><code>spec.containers[].resources.requests.ephemeral-storage</code></li></ul><h2 id="å•ä½">å•ä½</h2><p>k8så°†ä¸€ä¸ªè¶…çº¿ç¨‹ç§°ä¸ºä¸€ä¸ªvcpu. 1vcpu=1000m. æˆ‘ä»¬åœ¨å®šä¹‰èµ„æºé™åˆ¶æ—¶, åº”è¯¥å§‹ç»ˆç”¨ m ä½œä¸ºå•ä½.å‡è®¾ä½ é™åˆ¶0.5ä¸ªvcpu,åˆ™å¡«å†™500m.</p><p>k8sçš„å†…å­˜å’Œä¸´æ—¶å­˜å‚¨å•ä½å’Œå¹³æ—¶æˆ‘ä»¬æ‰€ç”¨çš„æ²¡ä»€ä¹ˆåŒºåˆ«. ä½ åªéœ€è¦è®°ä½ K/M/G/T/P/E è¿™äº›å³å¯. ä¾‹å¦‚, 100Må°±æ˜¯100å…†</p><p>ä¸€ä¸ªä¾‹å­:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">images.my-company.example/app:v4</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64M&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">        <span class="attr">ephemeral-storage:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128M&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">ephemeral-storage:</span> <span class="string">&quot;4Gi&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log-aggregator</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">images.my-company.example/log-aggregator:v6</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64M&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">        <span class="attr">ephemeral-storage:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128M&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">ephemeral-storage:</span> <span class="string">&quot;4Gi&quot;</span></span><br></pre></td></tr></table></figure><h2 id="èµ„æºé™åˆ¶å¦‚ä½•è¿ä½œ">èµ„æºé™åˆ¶å¦‚ä½•è¿ä½œ</h2><p>k8sä¼šé€šè¿‡kubeletå°†podå®šä¹‰çš„èµ„æºé™åˆ¶ä¼ é€’ç»™å®¹å™¨.</p><p>å¦‚æœä½ å®¹å™¨ä½¿ç”¨çš„æ˜¯docker.</p><p>cpuè½¯é™åˆ¶å°†å¯¹æ ‡dockerçš„â€“cpu-shares. è€Œcpuç¡¬é™åˆ¶ä¼šå‘Šè¯‰å®¹å™¨æ¯100mså¯ä»¥ä½¿ç”¨çš„CPUæ—¶é—´æ€»é‡æ˜¯  limits.cpu * 100.</p><blockquote><p>å…³äºdockerçš„â€“cpu-shares, å¯ä»¥å‚è€ƒhttps://docs.docker.com/engine/reference/run/#cpu-share-constraint</p><p>æ€»çš„æ¥è¯´, --cpu-shares ä¼šè®©å®¹å™¨æŒ‰ç…§æ‰€è®¾å®šçš„åˆ†å€¼æ¯”ä¾‹å»ä½¿ç”¨cpu.ä¸è¿‡, åœ¨å¤šæ ¸å¿ƒèŠ‚ç‚¹ä¸Š, è¿™ä¸ªè§„åˆ™åˆä¸æ˜¯å¾ˆé€‚ç”¨. æŒ‰ç…§å®˜æ–¹çš„è¯´æ³•, å½“å¤šæ ¸å¿ƒcpuçš„æ—¶å€™,å®ƒçš„è§„åˆ™æ˜¯:</p><p>On a multi-core system, the shares of CPU time are distributed over all CPU cores. Even if a container is limited to less than 100% of CPU time, it can use 100% of each individual CPU core.</p><p>For example, consider a system with more than three cores. If you start one container <code>&#123;C0&#125;</code> with <code>-c=512</code> running one process, and another container <code>&#123;C1&#125;</code> with <code>-c=1024</code> running two processes, this can result in the following division of CPU shares:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PID    containerCPUCPU share</span><br><span class="line">100    &#123;C0&#125;0100% of CPU0</span><br><span class="line">101    &#123;C1&#125;1100% of CPU1</span><br><span class="line">102    &#123;C1&#125;2100% of CPU2</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸‰ä¸ªå®¹å™¨,éƒ½æ˜¯å•æ ¸å¿ƒç¨‹åº</p></blockquote><p>å†…å­˜çš„é™åˆ¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«éœ€è¦æ³¨æ„çš„.</p><h2 id="å®¹å™¨ä¸­çš„å¯è§èµ„æº">å®¹å™¨ä¸­çš„å¯è§èµ„æº</h2><p>é»˜è®¤æƒ…å†µä¸‹,ä¸ç®¡ä½ å¦‚ä½•è®¾ç½®èµ„æºé™åˆ¶,å®¹å™¨é‡Œçš„å¯è§èµ„æºéƒ½ç­‰äºèŠ‚ç‚¹èµ„æº.ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨å®¹å™¨é‡ŒæŸ¥çœ‹/proc/meminfoæ˜¾ç¤ºçš„èµ„æºå¹¶ä¸æ˜¯ä½ è®¾ç½®çš„.è¿™ä¸ªé—®é¢˜ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦.</p><p>å› ä¸ºå¾ˆå¤šç¨‹åºçš„å‚æ•°éƒ½æ˜¯æ ¹æ®å¯è§èµ„æºæ¥è®¾å®šçš„.ä¾‹å¦‚nginxçš„auto, æˆ–è€…jvmé‡Œçš„å†…å­˜å‚æ•°.</p><blockquote><p>ä» Java 8u191å¼€å§‹, jvm å·²ç»é»˜è®¤å®ç°äº†å®¹å™¨æ„ŸçŸ¥( -XX:+UseContainerSupport). å› æ­¤æ— éœ€å®‰è£…ä¸‹é¢çš„ lxcfs æ–¹æ¡ˆ.</p><p>å¹¶ä¸”, åœ¨å®¹å™¨ä¸­å»ºè®®åªè®¾ç½®å¦‚ä¸‹å†…å­˜å‚æ•°:</p><p>-XX:MaxRAMPercentage  æœ€å¤§å †å†…å­˜=ç‰©ç†å†…å­˜ç™¾åˆ†æ¯”, å»ºè®®ä¸ºå®¹å™¨é™åˆ¶çš„50%-75% . æ¯•ç«Ÿè¿˜éœ€è¦é¢„ç•™å…¶å®ƒå†…å­˜.</p></blockquote><p>è€Œç¤¾åŒºå¸¸è§çš„ä½œæ³•æ˜¯ç”¨<code>lxcfs</code> æ¥æå‡èµ„æºçš„å¯è§æ€§.<code>lxcfs</code> æ˜¯ä¸€ä¸ªå¼€æºçš„FUSEï¼ˆç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼‰å®ç°æ¥æ”¯æŒLXCå®¹å™¨, å®ƒä¹Ÿå¯ä»¥æ”¯æŒDockerå®¹å™¨.</p><p>LXCFSé€šè¿‡ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ, åœ¨å®¹å™¨ä¸­æä¾›ä¸‹åˆ— <code>procfs</code> çš„æ–‡ä»¶.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/proc/cpuinfo</span><br><span class="line">/proc/diskstats</span><br><span class="line">/proc/meminfo</span><br><span class="line">/proc/<span class="built_in">stat</span></span><br><span class="line">/proc/swaps</span><br><span class="line">/proc/uptime</span><br></pre></td></tr></table></figure><p>ä¸æˆ‘ä»¬èµ„æºé™åˆ¶æœ‰å…³çš„, ä¸»è¦æ˜¯ cpuinfo å’Œ meminfo.</p><p>ç›®å‰ç¤¾åŒºçš„åšæ³•å¦‚ä¸‹:</p><ol><li><p>æ‰€æœ‰èŠ‚ç‚¹å®‰è£… fuse-libs åŒ….</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y fuse-libs</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…éƒ¨ç½²lxcfs</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gti <span class="built_in">clone</span> https://github.com/denverdino/lxcfs-admission-webhook.git</span><br><span class="line"><span class="built_in">cd</span> lxcfs-admission-webhook</span><br><span class="line">vim deployment/lxcfs-daemonset.yaml</span><br><span class="line">=== ä¿®æ­£ç‰ˆæœ¬ä¸º apps/v1  (å½“å‰gité‡Œçš„ä»£ç æ˜¯é™ˆæ—§çš„...ä»£ç é‡Œçš„ç‰ˆæœ¬åœ¨ 1.18 å·²ç»è¢«åºŸå¼ƒ). å…·ä½“å½’å±äºä»€ä¹ˆç‰ˆæœ¬, è¯·å‚è€ƒk8så®˜æ–¹apiæ–‡æ¡£ https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/<span class="comment">#daemonset-v1-apps</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f deployment/lxcfs-daemonset.yaml</span><br><span class="line">kubectl get pod</span><br><span class="line">=== ç­‰å¾… lxcfs pod çŠ¶æ€æˆ running</span><br><span class="line"></span><br><span class="line">deployment/install.sh</span><br><span class="line">kubectl get secrets,pods,svc,mutatingwebhookconfigurations</span><br><span class="line">=== æŸ¥çœ‹å„ä¸ªå¯¹è±¡çŠ¶æ€</span><br></pre></td></tr></table></figure></li><li><p>ç»™ç›¸å…³namespaceæ³¨å…¥lxcfs</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl label namespace default lxcfs-admission-webhook=enabled</span><br></pre></td></tr></table></figure></li><li><p>é‡å¯æ·»åŠ äº†èµ„æºé™åˆ¶çš„pod, æ­¤æ—¶ /proc/cpuinfo å’Œ /proc/meminfo å°†ä¼šæ­£ç¡®æ˜¾ç¤º. (freeä¹‹ç±»çš„è¿˜æ˜¯ä¼šè¾“å‡ºèŠ‚ç‚¹çš„)</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
            <tag> èµ„æºçº¦æŸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜10ä¸€ä¸ªwordpressä¾‹å­</title>
      <link href="posts/db1e9e5/"/>
      <url>posts/db1e9e5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‚è€ƒä¾‹å­">å‚è€ƒä¾‹å­</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blog</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--default_authentication_plugin=mysql_native_password</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dbport</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">rootPassW0rd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blog</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlport</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">dbport</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blog</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">minReadySeconds:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-db</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until nslookup mysql; do echo waiting for mysql service; sleep 2; done;&#x27;</span>]</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">wdport</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">mysql:3306</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">blog</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpressport</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">32255</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">wdport</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ConfigMap </tag>
            
            <tag> Secret </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜09åº”ç”¨é…ç½®ä¸å¯†ç ä¸ä¿¡æ¯æä¾›</title>
      <link href="posts/4b0e4a5/"/>
      <url>posts/4b0e4a5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>k8sæä¾›äº†ä¸€ä¸ªä¸“é—¨ç”¨äºå­˜å‚¨é…ç½®å’Œå¯†ç çš„å¯¹è±¡.</p><p>åˆ†åˆ«å«åš ConfigMap å’Œ Secret</p><h2 id="é…ç½®ConfigMap">é…ç½®ConfigMap</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/configmap/">https://kubernetes.io/docs/concepts/configuration/configmap/</a></p><p>ConfigMap å¸¸ç”¨åœ¨ä¸¤ç§æƒ…å†µä¸­. ç¬¬ä¸€ç§æ˜¯æä¾›ç¯å¢ƒå˜é‡.ç¬¬äºŒç§æ˜¯æä¾›é…ç½®æ–‡ä»¶</p><p>ä¸€ä¸ªç®€å•é…ç½®ä¾‹å­å¦‚ä¸‹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cm-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">data.1:</span> <span class="string">hello</span></span><br><span class="line">  <span class="attr">data.2:</span> <span class="string">world</span></span><br><span class="line">  <span class="attr">nginx.conf:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">property.1=value-1</span></span><br><span class="line">    <span class="string">property.2=value-2</span></span><br><span class="line">    <span class="string">property.3=value-3</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¾‹å­ä¸­, åŒ…å«çš„å†…å®¹æœ‰</p><p>ç¯å¢ƒå˜é‡æ–¹å¼:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">data.1:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">data.2:</span> <span class="string">world</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶æ–¹å¼:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">nginx.conf:</span> <span class="string">|</span></span><br><span class="line">  <span class="string">property.1=value-1</span></span><br><span class="line">  <span class="string">property.2=value-2</span></span><br><span class="line">  <span class="string">property.3=value-3</span></span><br></pre></td></tr></table></figure><p>nginx.config æ˜¯æ–‡ä»¶å, ç®¡é“ç¬¦ | ä¸‹é¢æ˜¯æ–‡ä»¶å†…å®¹.</p><p>éœ€è¦æ³¨æ„çš„æ˜¯, å†…å®¹å¤ªä¾ç„¶è¦éµå¾ª yaml çš„ç¼©è¿›è§„åˆ™</p><p>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo $&#123;DATA.1&#125; $&#123;DATA.2&#125;&quot;</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATA1</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cm-demo-vc</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">data.1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATA2</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cm-demo-vc</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">data.2</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cm-demo-vc</span></span><br><span class="line">      <span class="attr">subPath:</span> <span class="string">nginx.conf</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cm-demo-vc</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cm-demo</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶æ•°æ®å·æ–¹å¼:</p><ul><li>é€šè¿‡åœ¨ spec.volumes ä¸­å®šä¹‰ä¸€ä¸ªå…³è”å£°æ˜(cm.demo-vc). å®ƒä¸€ç«¯è¢« spec.containers.volumeMounts è°ƒç”¨, å¦ä¸€ç«¯å…³è” configMap. ç„¶åé€šè¿‡ spec.containers.volumeMounts ç»‘å®š configMap å, å°±å¯ä»¥ä½¿ç”¨ subPath è°ƒç”¨é…ç½®æ–‡ä»¶, å¹¶ä½¿ç”¨ mountPath æŒ‚è½½åˆ°å®¹å™¨é‡Œçš„å…·ä½“è·¯å¾„ä¸Š.</li><li>è¿™ç§æ–¹å¼ä¸‹,configMapæ›´æ–°å,podå†…æŒ‚è½½çš„ä¹Ÿä¼šåŒæ—¶æ›´æ–°.</li></ul><p>ç¯å¢ƒå˜é‡æ–¹å¼:</p><ul><li>é€šè¿‡åœ¨ spec.containers.env ä¸­å®šä¹‰. ä¾‹å­ä¸­, DATA1 æ˜¯ç¯å¢ƒå˜é‡çš„é”®, DATA1çš„å€¼é€šè¿‡valueFromå®šä¹‰.æœ€ç»ˆ,ä½ å¯ä»¥åœ¨å®¹å™¨ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡DATA1å’ŒDATA2</li></ul><h2 id="å¯†ç Secret">å¯†ç Secret</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/secret/">https://kubernetes.io/docs/concepts/configuration/secret/</a></p><p>secretå¯¹è±¡é‡Œçš„å€¼éœ€è¦å†™å…¥åŠ å¯†åçš„.</p><p>secretå¯¹è±¡ä¹Ÿå¯ä»¥è¢«å½“ä½œæ–‡ä»¶æŒ‚è½½æˆ–ç¯å¢ƒå˜é‡æ³¨å…¥</p><p>ä¸€ä¸ªç®€å•ä¾‹å­:</p><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç”¨æˆ·å¯†ç å¯¹,åˆ†åˆ«æ—¶usernameå’Œpassword</p><p>secretå¯¹è±¡è¦æ±‚å€¼å¿…é¡»è¿›è¡Œbase64ç¼–ç åŠ å¯†(å½“typeä¸ºOpaqueçš„æ—¶å€™).</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 test-yaml]<span class="comment"># echo -n &quot;admin&quot; | base64</span></span><br><span class="line">YWRtaW4=</span><br><span class="line">[root@k8s00 test-yaml]<span class="comment"># echo -n &quot;admin321&quot; | base64</span></span><br><span class="line">YWRtaW4zMjE=</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">MWYyZDFlMmU2N2Rm</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SECRET_USERNAME</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">secretKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SECRET_PASSWORD</span></span><br><span class="line">        <span class="attr">valueFrom:</span></span><br><span class="line">          <span class="attr">secretKeyRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br></pre></td></tr></table></figure><p>åœ¨é€šè¿‡ä¸Šè¿°é…ç½®åˆ›å»ºå¥½èµ„æºå,æˆ‘ä»¬è¿›å…¥pod,è¿›è¡Œæµ‹è¯•.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl exec -it mypod -- /bin/sh</span></span><br><span class="line">===å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªåŠ å¯†ä¿¡æ¯ç”Ÿæˆäº†ä¸¤ä¸ªè½¯è¿æ¥,å¹¶æŒ‡å‘äº†éšè—æ–‡ä»¶</span><br><span class="line">/ <span class="comment"># ls -l /etc/foo</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx    1 root     root            15 Sep 17 07:18 password -&gt; ..data/password</span><br><span class="line">lrwxrwxrwx    1 root     root            15 Sep 17 07:18 username -&gt; ..data/username</span><br><span class="line">===ç¯å¢ƒå˜é‡</span><br><span class="line">/ <span class="comment"># echo $&#123;SECRET_USERNAME&#125;</span></span><br><span class="line">admin</span><br><span class="line">===æ–‡ä»¶æ–¹å¼</span><br><span class="line">/ <span class="comment"># cat /etc/foo/username</span></span><br><span class="line">admin/ <span class="comment"># </span></span><br></pre></td></tr></table></figure><h2 id="é™åˆ¶">é™åˆ¶</h2><ul><li>æœºå¯†èµ„æºé™åˆ¶åœ¨åŒä¸€å‘½åç©ºé—´</li><li>æ•°æ®å¤§å°ä¸èƒ½è¶…è¿‡1MB</li><li>å½“podå¼•ç”¨ä¸å­˜åœ¨çš„æœºå¯†æ—¶,podæ— æ³•å¯åŠ¨</li></ul><h2 id="å…¶å®ƒ">å…¶å®ƒ</h2><ol><li><p>ä¸å¯å˜çš„æœºå¯†(k8s v1.19ä»¥ä¸Š)</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">secret.immutable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ç”¨æ¥æ„å»ºæ°¸ä¹…ä¸å¯å˜çš„å¯†ç ,ä¸”æ„å»ºåæ— æ³•æ›´æ”¹,ä¸”æ„å»ºåä½¿ç”¨å®ƒçš„podä¹Ÿæ— æ³•å¸è½½æ‰å®ƒ.</p><p>å› æ­¤,ä¸€æ—¦æ„å»ºåæƒ³æ›´æ”¹,åˆ™å®ƒå’Œå®ƒå…³è”çš„podéƒ½è¦åˆ é™¤é‡å»º.</p><p>ä¼˜ç‚¹:</p><ul><li>é¿å…é”™è¯¯çš„æ›´æ–°</li><li>æ˜¾è‘—æé«˜é›†ç¾¤æ€§èƒ½</li></ul></li><li><p>å‘½ä»¤æ–¹å¼åˆ›å»º</p><p>kubectl create configmap/secret <name> xxx</name></p><p>è¿™é‡Œxxxå¯ä»¥ç”¨ä¸¤ç§æ–¹å¼:</p><ul><li>â€“from-literal=<key>=<value> æŒ‡å®škv</value></key></li><li>â€“from-file=&lt;æ–‡ä»¶/ç›®å½•&gt; å½“ä¸ºç›®å½•çš„æ—¶å€™,ä¼šé€’å½’å°†ç›®å½•é‡Œçš„æ–‡ä»¶éƒ½å†™å…¥å¯¹è±¡ä¸­</li></ul></li><li><p>éšè—çš„å¯†ç ä¿¡æ¯æ–‡ä»¶</p><p>ä½ å¯ä»¥å°† secret.data.<key> å†™æˆ secret.data.&lt;.key&gt; æ¥éšè—å®ƒ.</key></p></li></ol><h2 id="ä¿¡æ¯æä¾›Downward-API">ä¿¡æ¯æä¾›Downward API</h2><p><a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/">https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/</a></p><p>ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨Downward APIä¼ é€’ä¿¡æ¯åˆ°å®¹å™¨. ç„¶åç¨‹åºæ ¹æ®ä¿¡æ¯æ¥è®¾ç½®.</p><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­: å°†èµ„æºé™åˆ¶æ•°æ®æŒ‚è½½åˆ°å®¹å™¨/etc/podinfo</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-downwardapi-volume-example-2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">client-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s.gcr.io/busybox:1.24</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n&#x27;</span><span class="string">;</span></span><br><span class="line">          <span class="string">if</span> [[ <span class="string">-e</span> <span class="string">/etc/podinfo/cpu_limit</span> ]]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n&#x27;</span><span class="string">;</span> <span class="string">cat</span> <span class="string">/etc/podinfo/cpu_limit;</span> <span class="string">fi;</span></span><br><span class="line">          <span class="string">if</span> [[ <span class="string">-e</span> <span class="string">/etc/podinfo/cpu_request</span> ]]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n&#x27;</span><span class="string">;</span> <span class="string">cat</span> <span class="string">/etc/podinfo/cpu_request;</span> <span class="string">fi;</span></span><br><span class="line">          <span class="string">if</span> [[ <span class="string">-e</span> <span class="string">/etc/podinfo/mem_limit</span> ]]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n&#x27;</span><span class="string">;</span> <span class="string">cat</span> <span class="string">/etc/podinfo/mem_limit;</span> <span class="string">fi;</span></span><br><span class="line">          <span class="string">if</span> [[ <span class="string">-e</span> <span class="string">/etc/podinfo/mem_request</span> ]]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n&#x27;</span><span class="string">;</span> <span class="string">cat</span> <span class="string">/etc/podinfo/mem_request;</span> <span class="string">fi;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">5</span><span class="string">;</span></span><br><span class="line">        <span class="string">done;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;32Mi&quot;</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;125m&quot;</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/podinfo</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">      <span class="attr">downwardAPI:</span></span><br><span class="line">        <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;cpu_limit&quot;</span></span><br><span class="line">            <span class="attr">resourceFieldRef:</span></span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">client-container</span></span><br><span class="line">              <span class="attr">resource:</span> <span class="string">limits.cpu</span></span><br><span class="line">              <span class="attr">divisor:</span> <span class="string">1m</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;cpu_request&quot;</span></span><br><span class="line">            <span class="attr">resourceFieldRef:</span></span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">client-container</span></span><br><span class="line">              <span class="attr">resource:</span> <span class="string">requests.cpu</span></span><br><span class="line">              <span class="attr">divisor:</span> <span class="string">1m</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;mem_limit&quot;</span></span><br><span class="line">            <span class="attr">resourceFieldRef:</span></span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">client-container</span></span><br><span class="line">              <span class="attr">resource:</span> <span class="string">limits.memory</span></span><br><span class="line">              <span class="attr">divisor:</span> <span class="string">1Mi</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;mem_request&quot;</span></span><br><span class="line">            <span class="attr">resourceFieldRef:</span></span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">client-container</span></span><br><span class="line">              <span class="attr">resource:</span> <span class="string">requests.memory</span></span><br><span class="line">              <span class="attr">divisor:</span> <span class="string">1Mi</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ConfigMap </tag>
            
            <tag> Secret </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜08è´Ÿè½½å‡è¡¡service</title>
      <link href="posts/d3b80b5f/"/>
      <url>posts/d3b80b5f/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨å®é™…ä¸šåŠ¡ä¸­,å› ä¸šåŠ¡å‹åŠ›é—®é¢˜,ç»å¸¸ä¼šæœ‰å¤šä¸ªåç«¯æœåŠ¡å‰¯æœ¬,å®ƒä»¬å…±åŒæ‰¿æ‹…è¯·æ±‚.æˆ‘ä»¬ä½¿ç”¨äº‘æœåŠ¡çš„æ—¶å€™,å¯ä»¥è´­ä¹°é˜¿é‡Œäº‘çš„slbæˆ–è€…awsçš„elb/albç­‰è´Ÿè½½å‡è¡¡å™¨å‘è¿™äº›åç«¯å‰¯æœ¬åˆ†å‘æµé‡. å¹¶é€šè¿‡è¿™äº›è´Ÿè½½å‡è¡¡å‘å…¬ç½‘æš´æ¼å†…ç½‘è¿™äº›åç«¯ç¨‹åº.</p><p>k8sè®¾è®¡äº†ä¸€ä¸ªserviceå¯¹è±¡æ¥å®ç°è¿™ä¸€ç›®çš„.</p><h2 id="k8sIP">k8sIP</h2><p>åœ¨æServiceå¯¹è±¡ä¹‹å‰,éœ€è¦å…ˆçŸ¥é“k8sä¸­å­˜åœ¨çš„ä¸‰ç§IP.å³ NodeIP, ClusterIP, PodIP</p><p>NodeIP å°±æ˜¯ç‰©ç†èŠ‚ç‚¹ip, è¿™ä¸ªæ²¡å¾—è¯´, ç©å®¶è‡ªå·±å®šä¹‰</p><p>ClusterIP æ˜¯k8sçš„ä¸€ä¸ªè™šæ‹Ÿip, æœ¬èº«æ²¡æœ‰ä»»ä½•å®ä½“, ä¹Ÿå°±æ˜¯VIP</p><p>PodIP æ˜¯å®¹å™¨å…±äº«çš„ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´å¯¹åº”çš„ip, ä¸€ä¸ªpodé‡Œçš„å®¹å™¨å…±ç”¨.</p><h2 id="Service">Service</h2><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">https://kubernetes.io/zh/docs/concepts/services-networking/service/</a></p><p>Serviceå¯¹è±¡é€šè¿‡servicespec.typeæ¥è®¾å®šç±»å‹, å…±è®¡4ä¸ªç±»å‹: ClusterIP, NodePort, LoadBalancer, ExternalName. è¿™å››ä¸ªç±»å‹å¯ä»¥åˆ†ä¸ºä¸¤ç±»</p><ul><li>åˆ›å»ºServiceå¯¹è±¡ä¾›é›†ç¾¤å†…éƒ¨è®¿é—®</li></ul><p>ClusterIP(é»˜è®¤ç±»å‹): åå‘ä»£ç†é›†ç¾¤å†…çš„pod. ä¾›é›†ç¾¤å†…å…¶å®ƒæœåŠ¡è®¿é—®. æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å†…éƒ¨å…¶å®ƒæœåŠ¡=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp-http</span></span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä¾‹å­ä¸­, é›†ç¾¤å†…éƒ¨è®¿é—®myservice.defaultçš„æ—¶å€™,æ­¤æ—¶ä¼šè®¿é—®åˆ°app=myappçš„pod</p><p>è¿™é‡Œportæ˜¯Serviceæš´éœ²ç«¯å£, targetPortæ˜¯podæš´éœ²ç«¯å£. é»˜è®¤æƒ…å†µä¸‹, targetPortå°†ç­‰äºport</p><p>spec.typeæ²¡æœ‰å®šä¹‰æ˜¯å› ä¸ºClusterIPæ˜¯Serviceå¯¹è±¡çš„é»˜è®¤ç±»å‹</p></blockquote><p>ExternalName: æ„å»ºä¸€ä¸ªCNAMEè§£æ(serviceå¯¹è±¡-CNAME-å…¶å®ƒåŸŸå).  æˆ‘èƒ½æƒ³åˆ°çš„ä¸»è¦æ˜¯è®©é›†ç¾¤å†…éƒ¨æœåŠ¡å¯ä»¥è®¿é—®åˆ°é›†ç¾¤å¤–éƒ¨æœåŠ¡.</p><p>ä¾‹å¦‚:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">my.database.example.com</span></span><br></pre></td></tr></table></figure><blockquote><p>é›†ç¾¤å†…éƒ¨è®¿é—®my-service.prodçš„æ—¶å€™, <a href="http://xn--k8sdnsmy-vq8m536awioci6an95by58d3far6b.database.example.com">å°†é€šè¿‡k8sçš„dnsæœåŠ¡è¿”å›my.database.example.com</a></p></blockquote><ul><li>ä¾›é›†ç¾¤å¤–éƒ¨è®¿é—®</li></ul><p>NodePort: åå‘ä»£ç†é›†ç¾¤å†…çš„pod(ä½¿ç”¨NATåœ¨æ¯ä¸€ä¸ªé›†ç¾¤nodeä¸Šçš„ç›¸åŒç«¯å£ä¸Šå…¬å¼€Service, æ˜¯ClusterIPç±»å‹çš„è¶…é›†). ä¾›é›†ç¾¤å¤–æœåŠ¡è®¿é—®. æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å¤–=&gt;ä»»æ„èŠ‚ç‚¹ip:ç«¯å£=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31000</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp-http</span></span><br></pre></td></tr></table></figure><blockquote><p>é›†ç¾¤å¤–éƒ¨æ­¤æ—¶å¯ä»¥è®¿é—®ä»»æ„ç‰©ç†èŠ‚ç‚¹ip:31000, æ­¤æ—¶å¯ä»¥è®¿é—®åˆ°é›†ç¾¤å†…éƒ¨app=myappçš„pod.</p><p>è¿™é‡ŒnodePortæ˜¯ç‰©ç†èŠ‚ç‚¹æš´éœ²ç«¯å£, portæ˜¯Serviceæš´éœ²ç«¯å£, targetPortæ˜¯podæš´éœ²ç«¯å£.</p><p>nodePortå¯ä»¥ä¸å®šä¹‰, åˆ™æ­¤æ—¶ä¼šè‡ªåŠ¨ä»30000-32767éšæœºåˆ†é….</p></blockquote><p>LoadBalancer: å¯¹æ¥äº‘å•†çš„è´Ÿè½½å‡è¡¡æœåŠ¡, ç»™Serviceåˆ†é…ä¸€ä¸ªå›ºå®šIP. æ–¹ä¾¿äº‘æœåŠ¡å•†çš„LBæœåŠ¡ç»‘å®š. (æ˜¯NodePortç±»å‹çš„è¶…é›†). æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å¤–=&gt;äº‘æœåŠ¡LB=&gt;ä»»æ„ç‰©ç†èŠ‚ç‚¹ip:ç«¯å£=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><p>è¿™ç§ç±»å‹å»ºè®®ç›´æ¥å‚è€ƒå®˜æ–¹æ–‡æ¡£: <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer">https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer</a></p><h2 id="Headless-Service">Headless Service</h2><p>è¿™æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡, å®ƒå’ŒClusterIPåªæœ‰ä¸€ç‚¹åŒºåˆ«, å°±æ˜¯<code>service.spec.clusterIP: None</code>. å®ƒçš„æ•ˆæœå°±æ˜¯ä¸ä¼šæä¾›ClusterIP, è€Œæ˜¯ç›´æ¥æä¾›podçš„endpointåœ°å€,ä¹Ÿå°±æ˜¯podçš„ipå’Œç«¯å£.</p><p>é‚£ä¹ˆè®¾è®¡çš„ç›®çš„æ˜¯ç»™ä¸€äº›ç‰¹æ®Šçš„æœ‰çŠ¶æ€çš„æœåŠ¡é›†ç¾¤ä½¿ç”¨, æ‰€ä»¥ä¸€èˆ¬å’Œstatefulsetå¯¹è±¡ä¸€èµ·å‡ºç°.</p><p>ä¾‹å¦‚, æ„å»ºzké›†ç¾¤,æˆ‘ä»¬çŸ¥é“ä¸€èˆ¬zké›†ç¾¤æ˜¯ä¸‰èŠ‚ç‚¹,å¾ˆå¤šå…¶å®ƒæœåŠ¡åœ¨è®¿é—®zké›†ç¾¤çš„æ—¶å€™,éƒ½æ˜¯éœ€è¦é…ç½®zké›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹åœ°å€å’Œç«¯å£çš„.è€Œé»˜è®¤çš„Serviceå¯¹è±¡éƒ½æ˜¯æä¾›ä¸€ä¸ªæš´æ¼åœ°å€,å¹¶ä¸æä¾›podçš„ç›´æ¥åœ°å€,è¿™å°±å°´å°¬äº†.æ‰€ä»¥æ­¤æ—¶Headless Serviceå°±å¯ä»¥ç”¨ä¸Šäº†.</p><h2 id="ä¼šè¯">ä¼šè¯</h2><p>æœ‰äº›æ—¶å€™,æˆ‘ä»¬éœ€è¦ä¼šè¯é»æ€§,ä½ å¯ä»¥é€šè¿‡service.spec.sessionAffinity=ClientIPæ¥è®¾ç½®.å¹¶åŒæ—¶å¯ä»¥é€šè¿‡service.spec.sessionAffinityConfig.clientIP.timeoutSecondsæ¥è®¾ç½®ä¼šè¯ä¿æŒæ—¶é—´,å®ƒé»˜è®¤æ˜¯3å°æ—¶.</p><h2 id="å¤šç«¯å£">å¤šç«¯å£</h2><p>æœ‰äº›æ—¶å€™,æŸä¸ªæœåŠ¡å¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªç«¯å£,ä¾‹å¦‚webæœåŠ¡,ä¼šåŒæ—¶æœ‰80å’Œ443.è¿™ç§æƒ…å†µä¸‹ä½ éœ€è¦é’ˆå¯¹ä¸¤ä¸ªç«¯å£åˆ†åˆ«è®¾å®šä¸€ä¸ªç«¯å£åç§°.å³ <a href="http://service.spec.ports.name">service.spec.ports.name</a></p><h2 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables">https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables</a></p><p>å½“serviceåˆ›å»ºçš„æ—¶å€™,kubeletä¼šç”Ÿæˆä¸€æ‰¹ç¯å¢ƒå˜é‡.ä½ å¯ä»¥åœ¨å…¶å®ƒpodä¸­ä½¿ç”¨è¿™äº›ç¯å¢ƒå˜é‡è®¿é—®service.ä¸è¿‡å‰ææ˜¯serviceå¯¹è±¡å¿…é¡»æå‰åˆ›å»º.</p><p>ä¸è¿‡,æˆ‘è§‰å¾—ä¸€èˆ¬æ¥è¯´,æœ‰dnsæ–¹å¼,éƒ½ä¼šé€šè¿‡dnså»è®¿é—®.è€Œä¸”dnsä¹Ÿæ²¡æœ‰å…ˆåˆ›å»ºserviceè¿™ä¸€ä¸ªé™åˆ¶.</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> service </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜06æ— çŠ¶æ€æœåŠ¡æ›´æ–°ç­–ç•¥</title>
      <link href="posts/18e4fa73/"/>
      <url>posts/18e4fa73/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æˆ‘ä»¬åœ¨æ“ä½œä¸€ä¸ªæ— çŠ¶æ€çš„appçš„æ—¶å€™,å¸¸å¸¸æ¶‰åŠåˆ°æ›´æ–°/å›æ»š.</p><p>å¯¹äºæ›´æ–°,æˆ‘ä»¬ä¸€èˆ¬ä¼šé‡‡ç”¨æ»šåŠ¨æ›´æ–°,å³:</p><ul><li>å…ˆæ‰©å±•ä¸€éƒ¨åˆ†æ–°ç‰ˆæœ¬</li><li>åˆ é™¤ä¸€éƒ¨åˆ†è€ç‰ˆæœ¬</li><li>é‡å¤ä¸Šè¿°è¡Œä¸º,ç›´è‡³æ‰€æœ‰è€ç‰ˆæœ¬è¢«æ›¿æ¢.</li></ul><p>å¯¹äºå›æ»š,æˆ‘ä»¬æƒ³å›æ»šåˆ°ä»»ä½•ä¸€ä¸ªä¹‹å‰çš„ç‰ˆæœ¬.</p><p>è€Œdeploymentå¯¹è±¡å¯ä»¥å¸®æˆ‘ä»¬å®ç°è¿™äº›.</p><h2 id="æ›´æ–°">æ›´æ–°</h2><p>ä¸€ä¸ªæ›´æ–°nginxç‰ˆæœ¬çš„ä¾‹å­. é¦–å…ˆ,æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªnginxçš„deployment</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f nginx-dep.yaml</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œdepçš„é…ç½®ä¸­spec.template.spec.container.image=nginx, æˆ‘æ²¡æœ‰è®¾ç½®å…·ä½“ç‰ˆæœ¬</p><p>Containers:<br>nginx:<br>Image:        nginx</p></blockquote><p>æ­¤æ—¶,æŸ¥çœ‹ç‰ˆæœ¬å†å², è¿™é‡Œæ¶‰åŠåˆ° rollout æŒ‡ä»¤, å›æ»šçš„æ—¶å€™ä¹Ÿä¼šç”¨åˆ°.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-dep</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">deployment.apps/nginx-dep </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å‘ç°æ²¡æœ‰å…³äºè¿™ä¸ªç‰ˆæœ¬1çš„ç›¸å…³æè¿°, æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œæ·»åŠ </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl annotate deployment/nginx-dep kubernetes.io/change-cause=<span class="string">&quot;first&quot;</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-dep</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">deployment.apps/nginx-dep </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         first</span><br></pre></td></tr></table></figure><blockquote><p>ä½ ä¹Ÿå¯ä»¥åœ¨æ‰§è¡Œå†™å…¥å‘½ä»¤çš„æ—¶å€™, è¿½åŠ  --record æ¥å°†æ‰§è¡Œçš„å‘½ä»¤å†™å…¥åˆ°å½“å‰change-cause</p></blockquote><p>ç°åœ¨, å°†æ‰€æœ‰deploymentä¸­æ‰€æœ‰nginxçš„imageç‰ˆæœ¬ä»é»˜è®¤å˜æ›´ä¸ºäº†1.19.2</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-dep nginx=nginx:1.19.2 &amp;&amp; kubectl annotate deployment/nginx-dep kubernetes.io/change-cause=<span class="string">&quot;nginx image to 1.19.2&quot;</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-dep</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">deployment.apps/nginx-dep </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         first</span><br><span class="line">2         nginx image to 1.19.2</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†ç”Ÿæˆä¸€ä¸ªç‰ˆæœ¬1.18</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-dep nginx=nginx:1.18 &amp;&amp; kubectl annotate deployment/nginx-dep kubernetes.io/change-cause=<span class="string">&quot;nginx image to 1.18&quot;</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-dep</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">deployment.apps/nginx-dep </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         first</span><br><span class="line">2         nginx image to 1.19.2</span><br><span class="line">3         nginx image to 1.18</span><br></pre></td></tr></table></figure><p>è¿™æ ·,æˆ‘ä»¬æ€»å…±æœ‰ä¸‰ä¸ªç‰ˆæœ¬, ä½ å¯ä»¥é€šè¿‡è¿½åŠ ç‰ˆæœ¬å·æ¥çœ‹å…·ä½“çš„ç‰ˆæœ¬å†…å®¹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-dep --revision=&lt;num&gt;</span><br></pre></td></tr></table></figure><h2 id="å›æ»š">å›æ»š</h2><p>æˆ‘ä»¬é€‰æ‹©å°†nginxç‰ˆæœ¬å›æ»šåˆ°firstç¬¬ä¸€ä¸ªç‰ˆæœ¬.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl rollout undo deployment/nginx-dep --to-revision=1</span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-dep</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">deployment.apps/nginx-dep </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         nginx image to 1.19.2</span><br><span class="line">3         nginx image to 1.18</span><br><span class="line">4         first</span><br></pre></td></tr></table></figure><h2 id="ç­–ç•¥">ç­–ç•¥</h2><p>deployment çš„ .spec ä¸­å¯ä»¥æ·»åŠ ä¸€äº›ç­–ç•¥.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">spec:  </span><br><span class="line">  minReadySeconds: 3  <span class="comment"># pod å°±ç»ªæ—¶é—´, åœ¨æ­¤æ—¶é—´ä¹‹å‰, deploy è®¤ä¸º pod è¿˜æ²¡æœ‰å‡†å¤‡å¥½. é»˜è®¤0</span></span><br><span class="line">  revisionHistoryLimit: 10 <span class="comment"># æœ€å¤§ç‰ˆæœ¬ä¿ç•™æ¬¡æ•°. é»˜è®¤10 </span></span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: rollingUpdate <span class="comment"># å®šä¹‰å˜æ›´ç­–ç•¥. é™¤äº† rollingUpdate, è¿˜å¯ä»¥æ˜¯Recreate.RecreateæŒ‡çš„æ˜¯å…ˆåˆ é™¤æ‰€æœ‰pod,å†åˆ›å»º.</span></span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 30% <span class="comment"># å˜æ›´æœŸé—´æœ€å¤šå­˜åœ¨å¤šå°‘ä¸ªä¸å¯ç”¨çš„pod</span></span><br><span class="line">      maxSurge: 30% <span class="comment"># å˜æ›´æœŸé—´æœ€å¤šå­˜åœ¨å¤šå°‘ä¸ªè¶…å‡ºå·²å®šä¹‰å‰¯æœ¬çš„podæ•°é‡</span></span><br></pre></td></tr></table></figure><blockquote><p>maxUnavailable å’Œ maxSurge è®¾ç½®ç›¸ç­‰å³å¯. å³å¼€å¤šå°‘ä¸ªæ–°çš„, å°±å…³å¤šå°‘ä¸ªè€çš„</p></blockquote><h2 id="å°ç»“">å°ç»“</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl rollout <span class="built_in">history</span> <span class="comment"># æŸ¥çœ‹å¯¹è±¡å†å²</span></span><br><span class="line">kubectl rollout undo <span class="comment"># å¯¹è±¡ç‰ˆæœ¬å›é€€</span></span><br><span class="line">kubectl rollout status <span class="comment"># å±•ç¤ºæ‰§è¡ŒçŠ¶æ€</span></span><br><span class="line">kubectl rollout pause <span class="comment"># æš‚åœæ­¤æ¬¡ç‰ˆæœ¬æ“ä½œè¡Œä¸º</span></span><br><span class="line">kubectl rollout resume <span class="comment"># æ¢å¤æ­¤æ¬¡ç‰ˆæœ¬æ“ä½œè¡Œä¸º</span></span><br><span class="line">kubectl <span class="built_in">set</span> image <span class="comment"># ä¿®æ”¹é•œåƒé…ç½®</span></span><br><span class="line">kubectl annotate <span class="comment"># æ·»åŠ ä¸€ä¸ªæ³¨é‡Š</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> deployment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜07æ— çŠ¶æ€æœåŠ¡podæ‰©ç¼©</title>
      <link href="posts/f6e328b5/"/>
      <url>posts/f6e328b5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>k8sçš„podç¼©æ”¾åŠŸèƒ½,å’Œawsçš„auto scalingåŠŸèƒ½æ˜¯ä¸€å›äº‹.è™½ç„¶å¯èƒ½æ²¡æœ‰awsçš„auto scalingåŠŸèƒ½å¼ºå¤§.</p><p>k8sçš„podç¼©æ”¾åŠŸèƒ½ç§°ä¹‹ä¸ºHPA(Horizontal Pod Autoscaler),å®ƒå¯ä»¥åŸºäºè®¾å®šçš„cpué˜ˆå€¼,æ¥è‡ªåŠ¨è°ƒæ•´deploymentä¸­çš„podæ•°é‡.</p><h2 id="metrics-server">metrics-server</h2><p><a href="https://github.com/kubernetes-sigs/metrics-server">https://github.com/kubernetes-sigs/metrics-server</a></p><p>metrics æœåŠ¡å™¨å¯ä»¥é€šè¿‡èµ„æºåº¦é‡å€¼ API å¯¹å¤–æä¾›åº¦é‡æ•°æ®ï¼ŒHorizontal Pod Autoscaler æ­£æ˜¯æ ¹æ®æ­¤ API æ¥è·å–åº¦é‡æ•°æ®.å¦‚æœæ²¡æœ‰æ­¤æœåŠ¡,HPAå°†æ— æ³•å·¥ä½œ.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.7/components.yaml</span><br></pre></td></tr></table></figure><p>é»˜è®¤ metrics-server çš„ deployment æ— æ³•ç›´æ¥ä½¿ç”¨, æˆ‘ä»¬éœ€è¦æ·»åŠ å‡ ä¸ªå‚æ•°,  æ¥ç¦æ­¢ ca è®¤è¯å’Œå¼€é€š dns</p><p>åœ¨ deployment.spec.template.spec.containers ä¸­æ–°åŠ å…¥ä¸‹åˆ—é…ç½®:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/metrics-server</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalDNS,InternalIP,ExternalDNS,ExternalIP,Hostname</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure><h2 id="hpa">hpa</h2><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</a></p><p>åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„webæœåŠ¡, hpa-test.yaml</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/hpa-example</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">php-apache</span></span><br></pre></td></tr></table></figure><p>ç»™webæœåŠ¡å¼€å¯hpa</p><p>å‘½ä»¤æ–¹å¼:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=5</span><br></pre></td></tr></table></figure><p>å£°æ˜æ–¹å¼:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„æ„æ€æ˜¯, cpu é˜ˆå€¼50%, æœ€å°podæ•°1, æœ€å¤§podæ•°5. hpaä¼šå°†æ‰€æœ‰podçš„å¹³å‡cpuåˆ©ç”¨ç‡ç»´æŒåœ¨50%, å¹¶ä¸”podæ•°é‡åœ¨1~5çš„èŒƒå›´å†…æ³¢åŠ¨</p></blockquote><p>æŸ¥çœ‹å½“å‰cpuä½¿ç”¨ç‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get hpa</span><br><span class="line">===</span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         5         1          57m</span><br></pre></td></tr></table></figure><p>æ·»åŠ æµ‹è¯•ç”¨çš„å®¢æˆ·ç«¯, è®¿é—®webæœåŠ¡, å¢åŠ webæœåŠ¡çš„cpuä½¿ç”¨ç‡</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run -it --rm load-generator --image=busybox /bin/sh</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> wget -q -O- http://php-apache; <span class="keyword">done</span></span><br><span class="line">=== ä¼šè¾“å‡ºå¤§é‡OK!</span><br><span class="line">OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!</span><br></pre></td></tr></table></figure><p>åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ç­‰å¾…å(ä¸ä¼šè¶…è¿‡1åˆ†é’Ÿ, é»˜è®¤ç›‘æ§æŠ“å–æ•°æ®é—´éš”æ—¶é—´æ˜¯1åˆ†é’Ÿ),æˆ‘ä»¬å¯ä»¥çœ‹åˆ° pod æ•°é‡å‘ç”Ÿå˜åŒ–</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         5         1          60m</span><br><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   0%/50%    1         5         1          60m</span><br><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   250%/50%   1         5         1          61m</span><br><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   250%/50%   1         5         1          61m</span><br><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl get deployment/php-apache</span></span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   5/5     5            5           68m</span><br><span class="line">[root@k8s00 test-yaml]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>ç°åœ¨,å…³é—­å®¢æˆ·ç«¯è¯·æ±‚,ç­‰å¾…1åˆ†é’Ÿä»¥ä¸Š.å†æ¬¡çœ‹hpa, è¿™æ—¶å€™cpuåˆ©ç”¨ç‡å·²ç»ä¸‹é™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl get hpa</span></span><br><span class="line">NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">php-apache   Deployment/php-apache   11%/50%   1         5         5          64m</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™,å†çœ‹podæ•°é‡,å®ƒåº”è¯¥å·²ç»å¼€å§‹ç¼©å‡,ä½†æ˜¯è¿™ä¸ªç¼©å‡å¹¶ä¸æ˜¯åœ¨cpuä½¿ç”¨ç‡ä¸‹é™ä¹‹åå°±ç«‹å³æ‰§è¡Œ,è€Œæ˜¯å†…éƒ¨æœ‰ä¸€ä¸ªç®—æ³•.å®ƒé¿å…å› ç«‹å³æ‰§è¡Œä»è€Œå¯¼è‡´èµ„æºå‡ºç°åå¤æ³¢åŠ¨.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl get deployment php-apache</span></span><br><span class="line">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">php-apache   5/5     5            5           70m</span><br><span class="line">[root@k8s00 test-yaml]<span class="comment"># kubectl describe deployment/php-apache</span></span><br><span class="line">Name:                   php-apache</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Wed, 16 Sep 2020 10:22:32 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               run=php-apache</span><br><span class="line">Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  run=php-apache</span><br><span class="line">  Containers:</span><br><span class="line">   php-apache:</span><br><span class="line">    Image:      k8s.gcr.io/hpa-example</span><br><span class="line">    Port:       80/TCP</span><br><span class="line">    Host Port:  0/TCP</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:  500m</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        200m</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   php-apache-5c4f475bf5 (1/1 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age    From                   Message</span><br><span class="line">  ----    ------             ----   ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  14m    deployment-controller  Scaled up replica <span class="built_in">set</span> php-apache-5c4f475bf5 to 4</span><br><span class="line">  Normal  ScalingReplicaSet  14m    deployment-controller  Scaled up replica <span class="built_in">set</span> php-apache-5c4f475bf5 to 5</span><br><span class="line">  Normal  ScalingReplicaSet  6m50s  deployment-controller  Scaled down replica <span class="built_in">set</span> php-apache-5c4f475bf5 to 4</span><br><span class="line">  Normal  ScalingReplicaSet  4m49s  deployment-controller  Scaled down replica <span class="built_in">set</span> php-apache-5c4f475bf5 to 1</span><br></pre></td></tr></table></figure><h2 id="å…¶å®ƒ">å…¶å®ƒ</h2><p>å½“å‰hpaçš„apiç‰ˆæœ¬æ˜¯autoscaling/v1,å®ƒåªèƒ½æŠ“å–cpuæŒ‡æ ‡.å¦‚æœä½ æƒ³æŠ“å–å†…å­˜æŒ‡æ ‡(å½“å‰ä¹Ÿåªæ”¯æŒå†…å­˜)æˆ–è‡ªå®šä¹‰æŒ‡æ ‡,é‚£ä¹ˆéœ€è¦å°†ç‰ˆæœ¬å˜æ›´ä¸ºautoscaling/v2beta2</p><p>autoscaling/v2beta2ç‰ˆæœ¬çš„é…ç½®æœ‰äº†ä¸€äº›å˜åŒ–,ä¸”å¯èƒ½éšæ—¶ä¼šæœ‰æ–°çš„å˜åŒ–.ä½ å¯ä»¥åœ¨</p><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics</a></p><p>æ‰¾åˆ°å®ƒçš„ä¾‹å­.</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">lastScaleTime:</span> <span class="string">&lt;some-time&gt;</span></span><br><span class="line">  <span class="attr">currentReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">desiredReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">currentMetrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">current:</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">averageValue:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> deployment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜å¸¸ç”¨å‘½ä»¤</title>
      <link href="posts/e6ae9474/"/>
      <url>posts/e6ae9474/</url>
      
        <content type="html"><![CDATA[<h2 id="æŸ¥è¯¢åº“è¡¨å ç”¨ç©ºé—´">æŸ¥è¯¢åº“è¡¨å ç”¨ç©ºé—´</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    table_schema AS &#39;æ•°æ®åº“&#39;,</span><br><span class="line">    table_name AS &#39;è¡¨å&#39;,</span><br><span class="line">    table_rows AS &#39;è®°å½•æ•°&#39;,</span><br><span class="line">    TRUNCATE (data_length &#x2F; 1024 &#x2F; 1024 &#x2F; 1024, 3) AS &#39;æ•°æ®å®¹é‡(GB)&#39;,</span><br><span class="line">    TRUNCATE (index_length &#x2F; 1024 &#x2F; 1024 &#x2F; 1024 , 3) AS &#39;ç´¢å¼•å®¹é‡(GB)&#39;,</span><br><span class="line">TRUNCATE (DATA_FREE &#x2F; 1024 &#x2F; 1024 &#x2F; 1024, 3) AS &#39;å·²å ç”¨ç©ºé—´ä½†æœªä½¿ç”¨(GB)&#39;</span><br><span class="line">FROM</span><br><span class="line">    information_schema. TABLES</span><br><span class="line">WHERE</span><br><span class="line">    table_schema in (&#39;new_data&#39;,&#39;megable_main&#39;,&#39;megable_active&#39;)</span><br><span class="line">ORDER BY</span><br><span class="line">    data_length DESC;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> command </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜05podæ¢æµ‹å™¨</title>
      <link href="posts/9aa66899/"/>
      <url>posts/9aa66899/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¢æµ‹å™¨">æ¢æµ‹å™¨</h2><blockquote><p><a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes">https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes</a></p></blockquote><p>æ¢æµ‹å™¨æœ‰ä¸‰ç§ï¼šå­˜æ´»æ¢æµ‹å™¨ï¼Œå°±ç»ªæ¢æµ‹å™¨ï¼Œå¯åŠ¨æ¢æµ‹å™¨</p><p>kubelet ä½¿ç”¨å­˜æ´»æ¢æµ‹å™¨æ¥çŸ¥é“ä»€ä¹ˆæ—¶å€™è¦é‡å¯å®¹å™¨ã€‚ ä¾‹å¦‚ï¼Œå­˜æ´»æ¢æµ‹å™¨å¯ä»¥æ•æ‰åˆ°æ­»é”ç¨‹åºï¼ˆè¿›ç¨‹åœ¨ï¼Œä½†ç¨‹åºå·²æ— æ³•è¿›ä¸€æ­¥æ‰§è¡Œï¼‰ã€‚ è¿™æ ·çš„æƒ…å†µä¸‹é‡å¯å®¹å™¨æœ‰åŠ©äºè®©åº”ç”¨ç¨‹åºåœ¨æœ‰é—®é¢˜çš„æƒ…å†µä¸‹æ›´å¯ç”¨ã€‚</p><p>kubelet ä½¿ç”¨å°±ç»ªæ¢æµ‹å™¨å¯ä»¥çŸ¥é“å®¹å™¨ä»€ä¹ˆæ—¶å€™å‡†å¤‡å¥½äº†å¹¶å¯ä»¥å¼€å§‹æ¥å—è¯·æ±‚æµé‡ï¼Œ å½“ä¸€ä¸ª Pod å†…çš„æ‰€æœ‰å®¹å™¨éƒ½å‡†å¤‡å¥½äº†ï¼Œæ‰èƒ½æŠŠè¿™ä¸ª Pod çœ‹ä½œå°±ç»ªäº†ã€‚ è¿™ç§ä¿¡å·çš„ä¸€ä¸ªç”¨é€”å°±æ˜¯æ§åˆ¶å“ªä¸ª Pod ä½œä¸º Service çš„åç«¯ã€‚ åœ¨ Pod è¿˜æ²¡æœ‰å‡†å¤‡å¥½çš„æ—¶å€™ï¼Œä¼šä» Service çš„è´Ÿè½½å‡è¡¡å™¨ä¸­è¢«å‰”é™¤çš„ã€‚</p><p>kubelet ä½¿ç”¨å¯åŠ¨æ¢æµ‹å™¨å¯ä»¥çŸ¥é“åº”ç”¨ç¨‹åºå®¹å™¨ä»€ä¹ˆæ—¶å€™å¯åŠ¨äº†ã€‚ å¦‚æœé…ç½®äº†è¿™ç±»æ¢æµ‹å™¨ï¼Œå°±å¯ä»¥æ§åˆ¶å®¹å™¨åœ¨å¯åŠ¨æˆåŠŸåå†è¿›è¡Œå­˜æ´»æ€§å’Œå°±ç»ªæ£€æŸ¥ï¼Œ ç¡®ä¿è¿™äº›å­˜æ´»ã€å°±ç»ªæ¢æµ‹å™¨ä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„å¯åŠ¨ã€‚ è¿™å¯ä»¥ç”¨äºå¯¹æ…¢å¯åŠ¨å®¹å™¨è¿›è¡Œå­˜æ´»æ€§æ£€æµ‹ï¼Œé¿å…å®ƒä»¬åœ¨å¯åŠ¨è¿è¡Œä¹‹å‰å°±è¢«æ€æ‰ã€‚</p><h2 id="å­˜æ´»æ¢æµ‹å™¨-livenessProbe">å­˜æ´»æ¢æµ‹å™¨ livenessProbe</h2><p>ç›®çš„åœ¨äºç¡®è®¤å®¹å™¨æ˜¯å¦å¥åº·ï¼Œå¹¶åœ¨ä¸å¥åº·çš„æ—¶å€™é‡å¯å®¹å™¨ã€‚å®ƒå°†åœ¨å®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œã€‚</p><p>æ¢æµ‹å™¨æœ‰ä¸‰ç§æ¢æµ‹æ–¹å¼ï¼Œå‘½ä»¤æ–¹å¼ï¼Œhttpæ–¹å¼ï¼Œtcpæ–¹å¼ã€‚å…·ä½“å¯ä»¥ä¸Šè¿°å®˜æ–¹æ–‡æ¡£</p><p>å­˜æ´»æ¢æµ‹å™¨åŒ…å«ä¸¤ä¸ªæ—¶é—´æ®µï¼Œä¸€ä¸ªæ˜¯åˆå§‹å®½å®¹æœŸé˜¶æ®µ initialDelaySecondsï¼Œä¸€ä¸ªæ˜¯åˆå§‹é˜¶æ®µä¹‹åçš„æ¢æµ‹é—´éš”æ—¶é—´ periodSeconds</p><p>httpæ–¹å¼ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/liveness</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/server</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">httpHeaders:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Custom-Header</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Awesome</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><blockquote><p>æ¢æµ‹å™¨ä¼šè®¤ä¸º 200&lt;=x&lt;400 çš„çŠ¶æ€ç ä¸ºæ­£å¸¸ã€‚</p></blockquote><h2 id="å°±ç»ªæ¢æµ‹å™¨-readinessProbe">å°±ç»ªæ¢æµ‹å™¨ readinessProbe</h2><p>ç›®çš„åœ¨äºä»…ç¡®è®¤å®¹å™¨æ˜¯å¦å¥åº·ï¼Œä½†æ˜¯å¹¶ä¸åˆ é™¤å®¹å™¨ã€‚å®ƒå°†åœ¨å®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: goproxy</span><br><span class="line">  labels:</span><br><span class="line">    app: goproxy</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: goproxy</span><br><span class="line">    image: k8s.gcr.io&#x2F;goproxy:0.1</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    readinessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 10</span><br><span class="line">    livenessProbe:</span><br><span class="line">      tcpSocket:</span><br><span class="line">        port: 8080</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      periodSeconds: 20</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å°±ç»ªæ¢é’ˆçš„æ—¶é—´å®šä¹‰æ˜¯è¦æ¯”å­˜æ´»æ¢é’ˆæå‰çš„ã€‚å³å®¹å™¨å¯åŠ¨5ç§’åå°±è¿›è¡Œå°±ç»ªæ¢æµ‹ï¼Œå®¹å™¨å¯åŠ¨15ç§’åè¿›è¡Œå­˜æ´»æ¢æµ‹ã€‚</p><h2 id="å¯åŠ¨æ¢æµ‹å™¨-startupProbe">å¯åŠ¨æ¢æµ‹å™¨ startupProbe</h2><p>ç›®çš„åœ¨äºè®¾ç½®ä¸€ä¸ªå®¹å™¨å¯åŠ¨å®½å®¹æœŸã€‚å½“å¯åŠ¨æ¢æµ‹å™¨ç¡®è®¤å®¹å™¨æ²¡é—®é¢˜åï¼Œåç»­çš„å¥åº·çŠ¶æ€å°†äº¤ç»™å­˜æ´»æ¢æµ‹å™¨ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness-port</span></span><br><span class="line">  <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">liveness-port</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">startupProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">liveness-port</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</h2><ol><li>å­˜æ´»å’Œå°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æ˜¯ä¸¤ä¸ªäº’ç›¸ç‹¬ç«‹çš„æ¥å£</li><li>å­˜æ´»æ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æ˜¯ç›´æ¥è¿”å›çŠ¶æ€ç»“æœï¼Œä¸åº”è¯¥æœ‰ä»»ä½•é€»è¾‘</li><li>å°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æä¾›å°±ç»ªæ‰€éœ€è¦çš„é€»è¾‘ã€‚ä½†æ˜¯ä¸åº”è¯¥æ·»åŠ é‡æ–°æ„å»ºå°±ç»ªçš„é€»è¾‘ã€‚ä¾‹å¦‚ï¼šå¤„ç†httpè¯·æ±‚çš„ç¨‹åºéœ€è¦ä¸€ä¸ªæ•°æ®åº“è¿æ¥çš„å°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨å°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£é‡Œæ·»åŠ æ•°æ®åº“è¿æ¥çš„æ£€æŸ¥é€»è¾‘ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜é¢„è­¦</title>
      <link href="posts/4ebbd3a8/"/>
      <url>posts/4ebbd3a8/</url>
      
        <content type="html"><![CDATA[<p>å®šä¹‰é¢„è­¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤</p><ol><li>å®šä¹‰é¢„è­¦åª’ä»‹</li><li>å®šä¹‰é¢„è­¦ç”¨æˆ·</li><li>å®šä¹‰é¢„è­¦åŠ¨ä½œ</li></ol><p>è§¦å‘å™¨è¾¾åˆ°é˜ˆå€¼ï¼Œè°ƒç”¨é¢„è­¦åŠ¨ä½œï¼Œé¢„è­¦åŠ¨ä½œè°ƒç”¨é¢„è­¦ç”¨æˆ·ï¼Œé¢„è­¦ç”¨æˆ·è°ƒç”¨é¢„è­¦åª’ä»‹</p><h2 id="é¢„è­¦åª’ä»‹">é¢„è­¦åª’ä»‹</h2><p>é…ç½®-æŠ¥è­¦åª’ä»‹ç±»å‹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªè¦ç´ </p><h3 id="æŠ¥è­¦åª’ä»‹ç±»å‹">æŠ¥è­¦åª’ä»‹ç±»å‹</h3><p>ç±»å‹æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚é‚®ä»¶ï¼Œè‡ªå®šä¹‰è„šæœ¬ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰è‡ªå®šä¹‰è„šæœ¬ï¼Œæ¥å®šä¹‰ä¸€ä¸ªä¼ä¸šå¾®ä¿¡é¢„è­¦</p><p><img src="/posts/4ebbd3a8/image-20200902144015196.png" alt="image-20200902144015196"></p><p>è„šæœ¬éœ€è¦æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><p>{ALERT.SENDTO}ï¼šæ”¶ä»¶äºº</p><p>{ALERT.SUBJECT}ï¼šä¸»é¢˜</p><p>{ALERT.MESSAGE}ï¼šå†…å®¹</p><p>æˆ‘ä»¬ä¸€èˆ¬åªç”¨{ALERT.SENDTO}å’Œ{ALERT.MESSAGE}å³å¯</p><h3 id="ä¿¡æ¯æ¨¡æ¿">ä¿¡æ¯æ¨¡æ¿</h3><p>å®šä¹‰ä¿¡æ¯æ¨¡æ¿ï¼Œä¸€èˆ¬æˆ‘ä»¬å®šä¹‰å‘Šè­¦æ¨¡æ¿/æ¢å¤æ¨¡æ¿/è‡ªåŠ¨æ³¨å†Œæ¨¡æ¿</p><p>å‘Šè­¦æ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144408513.png" alt="image-20200902144408513"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ã€[éª·é«…]ã€‘&#x3D;ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ : &#123;EVENT.ID&#125;</span><br><span class="line">ã€é—®é¢˜æ—¶é—´ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125; </span><br><span class="line">ã€é—®é¢˜åå­—ã€‘: &#123;EVENT.NAME&#125;</span><br><span class="line">ã€é—®é¢˜ä¸»æœºã€‘: &#123;HOST.NAME&#125;</span><br><span class="line">ã€é—®é¢˜çº§åˆ«ã€‘: &#123;EVENT.SEVERITY&#125;</span><br><span class="line">ã€é˜ˆå€¼ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;</span><br><span class="line">ã€é˜ˆå€¼é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;</span><br><span class="line">ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">ã€Operational dataã€‘: &#123;EVENT.OPDATA&#125;</span><br><span class="line">&#123;TRIGGER.URL&#125;</span><br></pre></td></tr></table></figure><p>æ¢å¤æ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144504865.png" alt="image-20200902144504865"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ã€[OK]ã€‘&#x3D;ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ : &#123;EVENT.ID&#125;</span><br><span class="line">ã€é—®é¢˜æ—¶é—´ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125; </span><br><span class="line">ã€é—®é¢˜æ¢å¤æ—¶é—´ã€‘: &#123;EVENT.RECOVERY.DATE&#125;  &#123;EVENT.RECOVERY.TIME&#125;</span><br><span class="line">ã€é—®é¢˜åå­—ã€‘: &#123;EVENT.NAME&#125;</span><br><span class="line">ã€é—®é¢˜ä¸»æœºã€‘: &#123;HOST.NAME&#125;</span><br><span class="line">ã€é—®é¢˜çº§åˆ«ã€‘: &#123;EVENT.SEVERITY&#125;</span><br><span class="line">ã€é˜ˆå€¼ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;</span><br><span class="line">ã€é˜ˆå€¼é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;</span><br><span class="line">ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class="line">ã€Operational dataã€‘: &#123;EVENT.OPDATA&#125;</span><br><span class="line">&#123;TRIGGER.URL&#125;</span><br></pre></td></tr></table></figure><p>è‡ªåŠ¨æ³¨å†Œæ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144535568.png" alt="image-20200902144535568"></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è‡ªåŠ¨æ³¨å†Œ: </span><br><span class="line">ä¸»æœºå: &#123;HOST.HOST&#125;</span><br><span class="line">ä¸»æœºip: &#123;HOST.IP&#125;</span><br><span class="line">ä»£ç†ç«¯å£: &#123;HOST.PORT&#125;</span><br></pre></td></tr></table></figure><h3 id="æ”¾ç½®å‘é€ä¿¡æ¯çš„è„šæœ¬">æ”¾ç½®å‘é€ä¿¡æ¯çš„è„šæœ¬</h3><p>å…·ä½“ä½ç½®ä»¥zb serverçš„å®‰è£…å’Œé…ç½®ä¸ºåŸºå‡†.</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@author: zyh</span></span><br><span class="line"><span class="string">@contact: aaa103439@hotmail.com</span></span><br><span class="line"><span class="string">@software: vscode</span></span><br><span class="line"><span class="string">@file: sendchat.py</span></span><br><span class="line"><span class="string">@time: 2020/02/05</span></span><br><span class="line"><span class="string">@use: pip3 install requests configparser</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys, os, requests, pathlib, json, configparser</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PySendchat</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, corpid, agentid, secret, touser, content</span>):</span></span><br><span class="line">        self.corpid=corpid</span><br><span class="line">        self.agentid=agentid</span><br><span class="line">        self.secret=secret</span><br><span class="line">        self.touser=touser</span><br><span class="line">        self.content=content</span><br><span class="line"></span><br><span class="line">        LOG_PATHDIR=os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">        LOG_FILENAME = <span class="string">&#x27;&#123;0&#125;/sendchat.log&#x27;</span>.format(LOG_PATHDIR)</span><br><span class="line">        self.my_logger = logging.getLogger(<span class="string">&#x27;SendChat&#x27;</span>)</span><br><span class="line">        self.my_logger.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add the log message handler to the logger</span></span><br><span class="line">        handler = logging.handlers.RotatingFileHandler(LOG_FILENAME, maxBytes=<span class="number">102400000</span>, backupCount=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create formatter and add it to the handlers</span></span><br><span class="line">        formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">        handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        self.my_logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gettoken</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.my_logger.info(<span class="string">&#x27;-----------------------------------------------------------------------------------------&#x27;</span>)</span><br><span class="line">        pwd=os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">        tokenfile=<span class="string">&#x27;&#123;0&#125;/wechat.&#123;1&#125;&#x27;</span>.format(pwd,self.agentid)</span><br><span class="line">        <span class="keyword">if</span> pathlib.Path(tokenfile).exists():</span><br><span class="line">            tokenfilectime=os.path.getctime(tokenfile)</span><br><span class="line">            currenttime=datetime.now().timestamp()</span><br><span class="line">            dtime=currenttime-tokenfilectime</span><br><span class="line">            self.my_logger.info(<span class="string">&#x27;&#123;0&#125; lived &#123;1&#125;s.&#x27;</span>.format(tokenfile, dtime))</span><br><span class="line">            <span class="keyword">if</span> dtime &gt;= <span class="number">7200</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    os.remove(tokenfile)</span><br><span class="line">                    self.my_logger.info(<span class="string">&#x27;Token file &#123;0&#125;: delete success&#x27;</span>.format(tokenfile))</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    self.my_logger.error(<span class="string">&#x27;Token file:&#123;0&#125; delete error.Reason:&#123;1&#125;&#x27;</span>.format(tokenfile,e))</span><br><span class="line">                    exit</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check token file</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            tokensize = os.path.getsize(tokenfile)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.my_logger.info(<span class="string">&#x27;Token file is not exist.Reason:&#123;0&#125;&#x27;</span>.format(e))</span><br><span class="line">            tokensize = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># get token from token file</span></span><br><span class="line">        <span class="keyword">if</span> tokensize != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">with</span> open(tokenfile, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fd:</span><br><span class="line">                token = fd.read() <span class="comment"># get token success</span></span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;Get token from token file.&#x27;</span>)</span><br><span class="line">            jsonObject = json.loads(token.decode(encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">            access_token = jsonObject.get(<span class="string">&quot;access_token&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> access_token</span><br><span class="line">        <span class="comment"># get token from weixin api</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;New Token Create.&#x27;</span>)</span><br><span class="line">                f = requests.get(<span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#123;0&#125;&amp;corpsecret=&#123;1&#125;&#x27;</span>.format(self.corpid, self.secret))</span><br><span class="line">                token = f.content</span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;Get token from weixin api.&#x27;</span>)</span><br><span class="line">                jsonObject = json.loads(token.decode(encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">                errcode=int(jsonObject.get(<span class="string">&quot;errcode&quot;</span>))</span><br><span class="line">                <span class="keyword">if</span> errcode != <span class="number">0</span>:</span><br><span class="line">                    errmsg=jsonObject.get(<span class="string">&quot;errmsg&quot;</span>)</span><br><span class="line">                    self.my_logger.error(<span class="string">&#x27;Get token error!Reason:&#123;0&#125;&#x27;</span>.format(errmsg))</span><br><span class="line">                    exit()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.my_logger.error(<span class="string">&#x27;Get token error!Reason:&#123;0&#125;&#x27;</span>.format(e))</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;Write token to &#123;0&#125;.&#x27;</span>.format(tokenfile))</span><br><span class="line">                <span class="keyword">with</span> open(tokenfile, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fd:</span><br><span class="line">                    fd.write(token)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.my_logger.error(<span class="string">&#x27;Write &#123;0&#125; error!Reason:&#123;1&#125;&#x27;</span>.format(tokenfile,e))</span><br><span class="line">                exit()</span><br><span class="line">            access_token = jsonObject.get(<span class="string">&quot;access_token&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> access_token</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sendmsg</span>(<span class="params">self</span>):</span></span><br><span class="line">        accessToken = self.gettoken()</span><br><span class="line">        self.my_logger.info(<span class="string">&#x27;Token:&#123;0&#125;&#x27;</span>.format(accessToken))</span><br><span class="line">        sendMapDirectroy = &#123;&#125;</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;agentid&quot;</span>] = self.agentid</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;touser&quot;</span>] = self.touser</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;msgtype&quot;</span>] = <span class="string">&quot;text&quot;</span></span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;safe&quot;</span>] = <span class="string">&quot;0&quot;</span></span><br><span class="line">        contentDirectory = &#123;&#125;</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;text&quot;</span>] = contentDirectory</span><br><span class="line">        contentDirectory[<span class="string">&quot;content&quot;</span>] = self.content</span><br><span class="line">        bodyStr = json.dumps(sendMapDirectroy, ensure_ascii=<span class="literal">False</span>).encode(encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            f = requests.post(url=<span class="string">&quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot;</span> % accessToken,</span><br><span class="line">                          data=bodyStr, timeout=<span class="number">5</span>)</span><br><span class="line">            self.my_logger.info(f.content)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.my_logger.error(<span class="string">&#x27;Send chat network error!Reason:&#123;0&#125;&#x27;</span>.format(e))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    appname = sys.argv[<span class="number">1</span>]</span><br><span class="line">    content = sys.argv[<span class="number">3</span>]</span><br><span class="line">    <span class="comment"># read conf.ini</span></span><br><span class="line">    conf = configparser.ConfigParser()</span><br><span class="line">    conf_path = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">    conf_ini = <span class="string">&quot;&#123;0&#125;/conf.ini&quot;</span>.format(conf_path)</span><br><span class="line">    <span class="keyword">if</span> pathlib.Path(conf_ini).exists():</span><br><span class="line">        conf.read(conf_ini)</span><br><span class="line">        corpid = conf.get(<span class="string">&quot;wechat&quot;</span>, <span class="string">&quot;corpid&quot;</span>)</span><br><span class="line">        appinfo = conf.get(<span class="string">&quot;app&quot;</span>, appname)</span><br><span class="line">        agentid = appinfo.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        secret = appinfo.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        groupname = conf.get(<span class="string">&quot;group&quot;</span>, appname)</span><br><span class="line">        touser = groupname.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        chatobj = PySendchat(corpid, agentid, secret, touser, content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;conf.ini error&#x27;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        chatobj.sendmsg()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        chatobj.my_logger.error(<span class="string">&quot;Send chat failure!&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># conf.ini</span></span><br><span class="line"><span class="section">[wechat]</span></span><br><span class="line">corpid = </span><br><span class="line"></span><br><span class="line"><span class="section">[app]</span></span><br><span class="line"><span class="attr">it</span> = &lt;app_agent_id&gt;:&lt;app_secret&gt;</span><br><span class="line"></span><br><span class="line"><span class="section">[group]</span></span><br><span class="line"><span class="attr">it</span> = usera|userb</span><br></pre></td></tr></table></figure><p>eg:</p><p>python3 <a href="http://wechat.py">wechat.py</a> it â€˜â€™ &lt;é¢„è­¦å†…å®¹&gt;</p><p>å›  zabbix è°ƒç”¨è„šæœ¬å¹¶é root ç”¨æˆ·ï¼Œæ‰€ä»¥ç»™è„šæœ¬é™„åŠ  x æƒé™ï¼Œé¿å…æƒé™é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod a+x wechat.py</span><br><span class="line"><span class="comment"># å› è„šæœ¬ä¼šç”Ÿæˆå…¶å®ƒæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># æ‰€ä»¥è¿˜éœ€è¦ç»™è„šæœ¬æ‰€åœ¨çš„ç›®å½•æ·»åŠ å…¶å®ƒç”¨æˆ·çš„å†™å…¥æƒé™</span></span><br><span class="line">chmod 757 alertscripts</span><br></pre></td></tr></table></figure><h2 id="é¢„è­¦ç”¨æˆ·">é¢„è­¦ç”¨æˆ·</h2><p>ç®¡ç†-ç”¨æˆ·-æ·»åŠ ç”¨æˆ·ï¼Œè¿™é‡Œæœ‰ä¸‰è¦ç´ </p><h3 id="ç”¨æˆ·">ç”¨æˆ·</h3><p>ä½ æ— éœ€ç™»é™†è¿™ä¸ªç”¨æˆ·ï¼Œæ‰€ä»¥å¯†ç å¯ä»¥å°½é‡çš„å¤æ‚</p><p><img src="/posts/4ebbd3a8/image-20200902150131147.png" alt="image-20200902150131147"></p><h3 id="æŠ¥è­¦åª’ä»‹">æŠ¥è­¦åª’ä»‹</h3><p><img src="/posts/4ebbd3a8/image-20200902150145022.png" alt="image-20200902150145022"></p><blockquote><p>æˆ‘ä»¬å®šä¹‰è¿™ä¸ªç”¨æˆ·è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°†ä¼šå‘é€ä¿¡æ¯ç»™itç»„ï¼Œè‡³äºitç»„åŒ…å«å“ªäº›äººå‘˜ï¼Œåˆ™ç”±è„šæœ¬å®šä¹‰ã€‚</p></blockquote><h3 id="æƒé™">æƒé™</h3><p><img src="/posts/4ebbd3a8/image-20200902150153011.png" alt="image-20200902150153011"></p><h2 id="é¢„è­¦åŠ¨ä½œ">é¢„è­¦åŠ¨ä½œ</h2><p>é…ç½®-åŠ¨ä½œ-å·¦ä¸Šè§’ï¼ˆè§¦å‘å™¨åŠ¨ä½œTrigger actionsï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªè¦ç´ </p><ol><li>ä»€ä¹ˆæ¡ä»¶ä¸‹æ‰§è¡ŒåŠ¨ä½œ</li><li>åŠ¨ä½œçš„å®é™…è¡Œä¸º</li></ol><h3 id="æ¡ä»¶">æ¡ä»¶</h3><p>éœ€è¦æ³¨æ„çš„æ˜¯è®¡ç®—æ–¹å¼</p><blockquote><p>é—®é¢˜æ²¡æœ‰è¢«åˆ¶æ­¢çš„æ„æ€ï¼šæ²¡æœ‰äººä¸ºçš„å…³é—­é¢„è­¦</p></blockquote><p><img src="/posts/4ebbd3a8/image-20200902150806009.png" alt="image-20200902150806009"></p><h3 id="æ“ä½œ">æ“ä½œ</h3><p><img src="/posts/4ebbd3a8/image-20200902151037597.png" alt="image-20200902151037597"></p>]]></content>
      
      
      <categories>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> wechat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜å®¹å™¨æ­å»º</title>
      <link href="posts/25f36846/"/>
      <url>posts/25f36846/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆ›å»ºç½‘ç»œ">åˆ›å»ºç½‘ç»œ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker network create -d bridge zbnet</span><br></pre></td></tr></table></figure><h2 id="mysql">mysql</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /<span class="built_in">export</span>/docker-data-mysql/&#123;config,logs,data&#125;</span><br><span class="line">docker run --name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">--network zbnet \</span><br><span class="line">--restart=always \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-mysql/config,dst=/etc/mysql&#x27;</span> \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-mysql/logs,dst=/var/log/mysql&#x27;</span> \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-mysql/data,dst=/var/lib/mysql&#x27;</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">-d mysql:5.7</span><br></pre></td></tr></table></figure><h2 id="zabbix-server">zabbix-server</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-server-mysql">https://hub.docker.com/r/zabbix/zabbix-server-mysql</a></p></blockquote><p>å®‰è£… centos + server + mysql ç‰ˆæœ¬</p><p>é»˜è®¤ï¼Œç¯å¢ƒå˜é‡ <code>MYSQL_USER</code> and <code>MYSQL_PASSWORD</code> are <code>zabbix</code>, <code>zabbix</code>.</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;export&#x2F;docker-data-zbserver&#x2F;alertscripts</span><br><span class="line">docker volume create zabbixServerEtc</span><br><span class="line">docker run --name&#x3D;zabbix_server \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">--network zbnet \</span><br><span class="line">--restart&#x3D;always \</span><br><span class="line">--mount &#39;type&#x3D;volume,src&#x3D;zabbixServerEtc,dst&#x3D;&#x2F;etc&#x2F;zabbix&#39; \</span><br><span class="line">--mount &#39;type&#x3D;bind,src&#x3D;&#x2F;export&#x2F;docker-data-zbserver&#x2F;alertscripts,dst&#x3D;&#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;alertscripts&#39; \</span><br><span class="line">-e DB_SERVER_HOST&#x3D;&quot;mysql57&quot; \</span><br><span class="line">-e MYSQL_DATABASE&#x3D;&quot;zabbixserver&quot; \</span><br><span class="line">-e MYSQL_USER&#x3D;&quot;zabbix&quot; \</span><br><span class="line">-e MYSQL_PASSWORD&#x3D;&quot;zabbix&quot; \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD&#x3D;&quot;123456&quot; \</span><br><span class="line">-d zabbix&#x2F;zabbix-server-mysql:centos-latest</span><br></pre></td></tr></table></figure><ol><li><p>é»˜è®¤å®‰è£…å®Œä¹‹åï¼Œå®¹å™¨å†…ç¼ºå°‘ä¸€äº›å¼€å‘ç¯å¢ƒï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬çš„å‘Šè­¦è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œæ¯”å¦‚æˆ‘æ˜¯ç”¨ python3 å†™çš„å¾®ä¿¡å‘Šè­¦ï¼Œè€Œç¯å¢ƒé‡Œæ²¡æœ‰ã€‚å› æ­¤éœ€è¦é¢å¤–åŠ è£…ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker logs -f zabbix_server </span><br><span class="line"><span class="comment"># å¯ä»¥çœ‹åˆ°å¦‚ä¸‹é”™è¯¯</span></span><br><span class="line">203:20200831:030724.713 Failed to execute <span class="built_in">command</span> <span class="string">&quot;/usr/lib/zabbix/alertscripts/wechat.py &#x27;it&#x27; &#x27;è‡ªåŠ¨æ³¨å†Œ: xxx-use-001-10-240-128-100&#x27; &#x27;ä¸»æœºå: xxx-use-001-10-240-128-100</span></span><br><span class="line"><span class="string">ä¸»æœºip: xxx</span></span><br><span class="line"><span class="string">ä»£ç†ç«¯å£: 10050&#x27;&quot;</span>: env: <span class="string">&#x27;python3&#x27;</span>: No such file or directory</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… python3 å’Œæ¨¡å—</span></span><br><span class="line">docker <span class="built_in">exec</span> -it -u root zabbix_server yum install python3</span><br><span class="line">docker <span class="built_in">exec</span> -it -u root zabbix_server pip3 install requests configparser</span><br></pre></td></tr></table></figure></li><li><p>alertscripts ç›®å½•éœ€è¦æœ‰ other å¯æ‰§è¡Œæƒé™</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod o+w /<span class="built_in">export</span>/docker-data-zbserver/alertscripts</span><br></pre></td></tr></table></figure><p>å› ä¸º zabbix_server åœ¨æ‰§è¡Œå‘Šè­¦è„šæœ¬çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯æ™®é€šç”¨æˆ·</p></li></ol><h2 id="zabbix-server-web">zabbix-server-web</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-web-nginx-mysql">https://hub.docker.com/r/zabbix/zabbix-web-nginx-mysql</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å­—ä½“</span></span><br><span class="line">yum install google-noto-sans-simplified-chinese-fonts.noarch -y</span><br><span class="line">docker run --name zabbix_web \</span><br><span class="line">-p 80:8080 \</span><br><span class="line">-p 443:8443 \</span><br><span class="line">--restart=always \</span><br><span class="line">--network zbnet \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/usr/share/fonts/google-noto/NotoSansSC-Regular.otf,dst=/usr/share/zabbix/assets/fonts/DejaVuSans.ttf&#x27;</span> \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">&quot;mysql57&quot;</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">&quot;zabbixserver&quot;</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">&quot;zabbix&quot;</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">&quot;123456&quot;</span> \</span><br><span class="line">-e ZBX_SERVER_HOST=<span class="string">&quot;zabbix_server&quot;</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">&quot;Asia/Shanghai&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-web-nginx-mysql:latest</span><br></pre></td></tr></table></figure><blockquote><p><a href="http://ip">http://ip</a> å³å¯</p><p>åˆå§‹è´¦æˆ·å¯†ç æ˜¯ Admin/zabbix</p></blockquote><p>åˆ°è¿™é‡Œï¼Œä½ å°±å¯ä»¥è®¿é—®zabbixäº†ï¼Œä¸è¿‡è¿™æ—¶å€™ä½ ä¼šå‘ç°zabbixæç¤ºagentä¸å¯è¾¾</p><p><img src="/posts/25f36846/image-20200901172913999.png" alt="image-20200901172913999"></p><p>å…¶åŸå› æ˜¯æˆ‘ä»¬è¿˜æ²¡åˆ›å»ºagent</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºé»˜è®¤zabbix serverçš„ä¸»æœºé…ç½®é¡¹ç›‘å¬çš„æ˜¯ 127.0.0.1:10050, å¹¶ä¸”ä¸»æœºåé…ç½®çš„æ˜¯</p><p><code>zabbix server</code>. è¿™å’Œæˆ‘ä»¬æœ¬æ–‡æ¡£æœ‰ä¸€äº›å†²çªï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€äº›é…ç½®ã€‚</p><ol start="2"><li>ä¿®æ”¹ä¸»æœºé…ç½®ä¸­çš„ hostname ä¸º agent å®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡ ZBX_HOSTNAMEã€‚è¿™é‡Œæˆ‘ä»¬ä¸º zabbix_server</li><li>ä¿®æ”¹ä¸»æœºé…ç½®ä¸­çš„ç›‘å¬åœ°å€ä¸º zabbix_serverï¼Œä¸”ç›‘å¬æ–¹å¼ä¸º dns</li></ol><p>æœ€ç»ˆä¿®æ”¹å®Œå¦‚ä¸‹ï¼š</p><p><img src="/posts/25f36846/image-20200901175159400.png" alt="image-20200901175159400"></p><h2 id="zabbix-agent">zabbix-agent</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-agent">https://hub.docker.com/r/zabbix/zabbix-agent</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker volume create zbAgentEtc</span><br><span class="line">docker run --name zabbix_agent \</span><br><span class="line">--network=container:zabbix_server \</span><br><span class="line">--mount <span class="string">&#x27;type=volume,src=zbAgentEtc,dst=/etc/zabbix/zabbix_agentd.d&#x27;</span> \</span><br><span class="line">-e ZBX_DEBUGLEVEL=<span class="string">&quot;3&quot;</span> \</span><br><span class="line">-e ZBX_HOSTNAME=<span class="string">&quot;zabbix_server&quot;</span> \</span><br><span class="line">-e ZBX_SERVER_HOST=<span class="string">&quot;zabbix_server&quot;</span> \</span><br><span class="line">-d zabbix/zabbix-agent:latest</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ zabbix_agent é‡‡ç”¨ç½‘ç»œæ¨¡å¼ä¸ºå®¹å™¨æ¨¡å¼ï¼Œå¹¶åŠ å…¥åˆ° zabbix_server å®¹å™¨ä¸­ï¼Œä»¥ä¾¿äº zabbix_server å¯ä»¥æ‰¾åˆ° zabbix_agent</p><p>å…¶å®ƒé…ç½®å˜é‡è¯¦è§ä¸Šé¢å®˜æ–¹æ–‡æ¡£</p>]]></content>
      
      
      <categories>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜ç¦»çº¿è¿ç§»è„šæœ¬</title>
      <link href="posts/c83ca575/"/>
      <url>posts/c83ca575/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">databases=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">mysqltonew</span></span>()&#123;</span><br><span class="line">    olddatabasehost=</span><br><span class="line">    olddatabaseport=</span><br><span class="line">    olddatabase=<span class="variable">$1</span></span><br><span class="line">    oldUserName=</span><br><span class="line">    oldpassword=</span><br><span class="line"></span><br><span class="line">    newdatabasehost=</span><br><span class="line">    newolddatabaseport=</span><br><span class="line">    newdatabase=<span class="variable">$&#123;olddatabase&#125;</span></span><br><span class="line">    newUserName=</span><br><span class="line">    newpassword=</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># utf8 / utf8mb4</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">&quot;character [utf8/utf8mb4/latin1]:&quot;</span> Character</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¼å‡ºè€åº“</span></span><br><span class="line">    mysqldump -u<span class="variable">$&#123;oldUserName&#125;</span> -p<span class="variable">$&#123;oldpassword&#125;</span> -h<span class="variable">$&#123;olddatabasehost&#125;</span> -P<span class="variable">$&#123;olddatabaseport&#125;</span> --default-character-set=<span class="variable">$&#123;Character&#125;</span> --single-transaction <span class="variable">$&#123;olddatabase&#125;</span> &gt; <span class="variable">$&#123;olddatabase&#125;</span>.sql</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºæ–°åº“</span></span><br><span class="line">    mysql -u<span class="variable">$&#123;newUserName&#125;</span> -p<span class="variable">$&#123;newpassword&#125;</span> -h<span class="variable">$&#123;newdatabasehost&#125;</span> -P<span class="variable">$&#123;newolddatabaseport&#125;</span> -e <span class="string">&quot;CREATE DATABASE <span class="variable">$&#123;newdatabase&#125;</span> DEFAULT CHARSET <span class="variable">$&#123;Character&#125;</span> COLLATE <span class="variable">$&#123;Character&#125;</span>_general_ci;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¼å…¥æ–°åº“</span></span><br><span class="line">    mysql -u<span class="variable">$&#123;newUserName&#125;</span> -p<span class="variable">$&#123;newpassword&#125;</span> -h<span class="variable">$&#123;newdatabasehost&#125;</span> -P<span class="variable">$&#123;newolddatabaseport&#125;</span> --default-character-set=<span class="variable">$&#123;Character&#125;</span> <span class="variable">$&#123;newdatabase&#125;</span> &lt; <span class="variable">$&#123;olddatabase&#125;</span>.sql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;databases&#125;</span>;<span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;start <span class="variable">$i</span>&quot;</span></span><br><span class="line">        mysqltonew <span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> mysqldump </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜03é™æ€pod</title>
      <link href="posts/94518966/"/>
      <url>posts/94518966/</url>
      
        <content type="html"><![CDATA[<h2 id="é™æ€pod">é™æ€pod</h2><p>ç‰¹ç‚¹ï¼š</p><ol><li>æ°¸è¿œè¿è¡Œåœ¨å›ºå®šèŠ‚ç‚¹</li><li>ç”±æ‰€åœ¨èŠ‚ç‚¹çš„kubeletç®¡ç†ï¼Œä½†åªè´Ÿè´£ä¿æ´»ï¼Œå³podå´©æºƒé‡ç”Ÿ</li><li>kubeletä¼šè®©apiserveråˆ›å»ºä¸€ä¸ªé•œåƒpodï¼Œä¾¿äºå¯ä»¥é€šè¿‡kubectlæŸ¥è¯¢åˆ°é™æ€pod</li></ol><p>é…ç½®ï¼š</p><ol><li>å­˜æ”¾åœ¨ /etc/kubernetes/manifests å½“é‡‡ç”¨kubeadmå®‰è£…çš„æ—¶å€™ï¼Œä¸€èˆ¬ä½äºæ­¤ç›®å½•ã€‚å…·ä½“éœ€è¦å»çœ‹kubeleté…ç½®ã€‚</li><li>é…ç½®æœ¬èº«å¯ä»¥æŒ‰ç…§æ ‡å‡†podæ–¹å¼æ¥åˆ›å»º</li></ol><p>æ£€æµ‹ï¼š</p><ol><li>kubeletä¼šå®šæœŸæ£€æµ‹é…ç½®ç›®å½•åŠ è½½é…ç½®åˆ›å»º/é‡å»ºpod</li></ol><blockquote><p>å½“ä½ é€šè¿‡kubeadmåˆ›å»ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆk8sçš„å‡ ä¸ªé‡è¦ç»„ä»¶å‡ä¼šä»¥é™æ€podçš„æ–¹å¼åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œä½ å¯ä»¥åœ¨/etc/kubernetes/manifests/è¿™é‡Œæ‰¾åˆ°ä»–ä»¬çš„é…ç½®</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 ~]<span class="comment"># ll /etc/kubernetes/manifests/</span></span><br><span class="line">total 16</span><br><span class="line">-rw------- 1 root root 1848 Aug 25 16:28 etcd.yaml</span><br><span class="line">-rw------- 1 root root 2709 Aug 25 16:28 kube-apiserver.yaml</span><br><span class="line">-rw------- 1 root root 2564 Aug 25 16:33 kube-controller-manager.yaml</span><br><span class="line">-rw------- 1 root root 1120 Aug 25 16:33 kube-scheduler.yaml</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜04podé’©å­å‡½æ•°</title>
      <link href="posts/3ec72f7e/"/>
      <url>posts/3ec72f7e/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æˆ‘ä»¬åœ¨å®é™…å·¥ä½œä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°å®¹å™¨ç¨‹åºçš„å‡†å¤‡å·¥ä½œï¼Œä»¥åŠå®¹å™¨ç»“æŸä¹‹å‰çš„å¤„ç†å·¥ä½œã€‚æ¯”å¦‚ï¼Œå®¹å™¨å¼€å§‹ä¹‹å‰ä¸‹è½½ä¸€äº›åŒ…ï¼Œæˆ–è€…å®¹å™¨ç»“æŸä¹‹å‰ä¸Šä¼ æ—¥å¿—ç­‰ã€‚</p><p>k8s ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªå‡½æ•°ç”¨äºå¤„ç†è¿™äº›å·¥ä½œï¼Œåˆ†åˆ«æ˜¯ postStartå’Œ preStop</p><h2 id="postStart">postStart</h2><ol><li>å®ƒå°†åœ¨å®¹å™¨åˆ›å»ºåç«‹å³è¿è¡Œï¼Œä½†ä¸ä¿è¯åœ¨ ENTRYPOINT ä¹‹å‰è¿è¡Œ</li><li>å®ƒæ˜¯åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå®ƒå¡ä½ï¼Œpod æ— æ³•è¾¾åˆ° running çŠ¶æ€</li><li>å®ƒä½äºå®¹å™¨ lifecycle ä¸­</li></ol><p>ç¤ºä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">poststart-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">poststart-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo This is postStart-test &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 ~]<span class="comment"># kubectl apply -f poststart-test.yaml</span></span><br><span class="line">pod/poststart-test created</span><br><span class="line">[root@k8s00 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME             READY   STATUS              RESTARTS   AGE   IP       NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">poststart-test   0/1     ContainerCreating   0          7s    &lt;none&gt;   k8s02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@k8s00 ~]<span class="comment"># kubectl get pod -o wide</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP          NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">poststart-test   1/1     Running   0          10s   10.97.2.6   k8s02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@k8s00 ~]<span class="comment"># curl 10.97.2.6</span></span><br><span class="line">This is postStart-test</span><br></pre></td></tr></table></figure><h2 id="preStop">preStop</h2><ol><li>å®ƒå°†åœ¨å®¹å™¨ç»“æŸä¹‹å‰è¿è¡Œ</li><li>å®ƒæ˜¯åŒæ­¥çš„ï¼Œå¦‚æœå®ƒå¡ä½ï¼Œpod å°†åœç•™åœ¨ running çŠ¶æ€ï¼Œæ— æ³•è¾¾åˆ° failed çŠ¶æ€</li><li>å®ƒä½äºå®¹å™¨ lifecycle ä¸­</li></ol><p>ç¤ºä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prestop-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prestop-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prestop-test-tmp</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo This is preStop &gt; /usr/share/message&quot;</span>]</span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prestop-test-tmp</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@k8s00 ~]<span class="comment"># kubectl delete pod prestop-test</span></span><br><span class="line"><span class="comment"># è¿™é‡Œ prestop-test è¢«è°ƒåº¦åˆ° k8s02</span></span><br><span class="line">[root@k8s02 ~]<span class="comment"># cat /tmp/message</span></span><br><span class="line">This is preStop</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜02v1.18.6å®‰è£…</title>
      <link href="posts/9602dad/"/>
      <url>posts/9602dad/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ï¼Œå®˜æ–¹å·²ç»åˆ°äº†1.18.8ï¼Œä½†æ˜¯é‰´äºå›½å†…ç¯å¢ƒï¼Œéå®˜æ–¹æºæ²¡æ‰¾åˆ°1.18.8ï¼Œæ‰€ä»¥æœ€åç”¨çš„1.18.6<br>å¦å¤–ï¼Œæ–‡ä¸­å‡ºç°çš„å®¿ä¸»æœºipï¼Œè¯·è‡ªè¡Œä¿®æ”¹ä¸ºè‡ªå·±çš„ç¯å¢ƒip</p><h2 id="ä»¥ä¸‹å‘½ä»¤åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ">ä»¥ä¸‹å‘½ä»¤åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ</h2><ol><li><p>æ—¶é—´åŒæ­¥</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install chrony -y</span><br><span class="line">sed -i  <span class="string">&#x27;1a server cn.pool.ntp.org prefer iburst&#x27;</span> /etc/chrony.conf</span><br><span class="line">systemctl restart chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line">chronyc activity</span><br></pre></td></tr></table></figure></li><li><p>ç³»ç»Ÿé…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŠ è½½æ¨¡å—</span></span><br><span class="line">modprobe overlay</span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="comment"># æ·»åŠ é…ç½®</span></span><br><span class="line">cat &gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># é…ç½®ç”Ÿæ•ˆ</span></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç©ºé˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld.service iptables.service</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line">systemctl <span class="built_in">disable</span> iptables.service;</span><br><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s@^\(SELINUX=\).*@\1disabled@&#x27;</span> /etc/sysconfig/selinux</span><br><span class="line">sed -i <span class="string">&#x27;s@^\(SELINUX=\).*@\1disabled@&#x27;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­ swapï¼Œkubelet 1.18 è¦æ±‚.å¦‚æœä½ fstabä¹Ÿæœ‰ï¼Œè¯·ä¸€å¹¶æ³¨é‡Š</span></span><br><span class="line">swapoff -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… ipvs</span></span><br><span class="line">yum install ipvsadm -y</span><br><span class="line">ipvsadm --clear</span><br><span class="line">cat&gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">ipvs_mods_dir=<span class="string">&quot;/usr/lib/modules/<span class="subst">$(uname -r)</span>/kernel/net/netfilter/ipvs&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(ls <span class="variable">$ipvs_mods_dir</span> | grep -o <span class="string">&quot;^[^.]*&quot;</span>); <span class="keyword">do</span></span><br><span class="line">    /sbin/modinfo -F filename <span class="variable">$i</span>  &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        /sbin/modprobe <span class="variable">$i</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line">chmod +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line">/etc/sysconfig/modules/ipvs.modules</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… docker</p><blockquote><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line"><span class="comment"># å®‰è£…å…¼å®¹k8sçš„dockerç‰ˆæœ¬</span></span><br><span class="line">yum install -y \</span><br><span class="line">  containerd.io-1.2.13 \</span><br><span class="line">  docker-ce-19.03.11 \</span><br><span class="line">  docker-ce-cli-19.03.11</span><br><span class="line"><span class="comment">#sed -i &#x27;/ExecStart=/a ExecStartPort=/usr/sbin/iptables -P FORWARD ACCEPT&#x27; /usr/lib/systemd/system/docker.service;</span></span><br><span class="line">mkdir -p /etc/docker;</span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/export/docker-data-root&quot;</span>,</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… kubelet kubeadm kubectl</p><blockquote><p>é˜¿é‡Œå·´å·´é•œåƒç‚¹ï¼š</p><p><a href="https://developer.aliyun.com/mirror/kubernetes">https://developer.aliyun.com/mirror/kubernetes</a></p></blockquote></li></ol><blockquote><p>google å®˜æ–¹å®‰è£…æ–‡æ¡£ <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p></blockquote>   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">   cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">   [kubernetes]</span><br><span class="line">   name=Kubernetes</span><br><span class="line">   baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\<span class="variable">$basearch</span></span><br><span class="line">   enabled=1</span><br><span class="line">   gpgcheck=1</span><br><span class="line">   repo_gpgcheck=1</span><br><span class="line">   gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">   exclude=kubelet kubeadm kubectl</span><br><span class="line">   EOF</span><br><span class="line">   <span class="comment"># ç¡®å®š kube* ç‰ˆæœ¬</span></span><br><span class="line">   yum list kube* --showduplicates | sort -r </span><br><span class="line">   <span class="comment"># é€‰æ‹©è¦å®‰è£…çš„ç‰ˆæœ¬</span></span><br><span class="line">   Version=1.18.6</span><br><span class="line">   <span class="comment"># å®‰è£… kube ç®¡ç†ç»„ä»¶å’Œ kubelet</span></span><br><span class="line">   yum install -y kubelet-<span class="variable">$&#123;Version&#125;</span> kubeadm-<span class="variable">$&#123;Version&#125;</span> kubectl-<span class="variable">$&#123;Version&#125;</span> --disableexcludes=kubernetes</span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure><blockquote><p>kubelet 1.18 çš„æ—¶å€™ï¼Œå½“ä½ ä½¿ç”¨ docker çš„æ—¶å€™ï¼Œkubeadm ä¼šé€šè¿‡ kubelet è‡ªåŠ¨è®¾ç½® cgroup å’Œ docker ä¸€è‡´ã€‚</p></blockquote><h2 id="ä»¥ä¸‹å‘½ä»¤åœ¨-master-èŠ‚ç‚¹è¿è¡Œ">ä»¥ä¸‹å‘½ä»¤åœ¨ master èŠ‚ç‚¹è¿è¡Œ</h2><ol><li><p>åˆå§‹åŒ– master èŠ‚ç‚¹</p><blockquote><p>info: <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é‰´äºç½‘ç»œé—®é¢˜ï¼Œæ‰€ä»¥å›½å†…ä¸€èˆ¬æ— æ³•ç›´æ¥è¿è¡Œåˆå§‹åŒ–å‘½ä»¤ï¼Œå› æ­¤æœ€å¥½å…ˆè‡ªè¡Œå®‰è£…å¥½åŒ…</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬ k8s æ‰€éœ€åŒ…</span></span><br><span class="line">kubeadm config images list --kubernetes-version=1.18.6</span><br><span class="line"><span class="comment"># è¿è¡Œä¸‹åˆ—è„šæœ¬å®‰è£…æ‰€éœ€çš„åŒ…</span></span><br><span class="line"><span class="comment"># ---------------------æˆ‘æ˜¯è„šæœ¬å¼€å¤´--------------------</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># kubeadm config images list</span></span><br><span class="line">images=(</span><br><span class="line">kube-apiserver:v1.18.6</span><br><span class="line">kube-controller-manager:v1.18.6</span><br><span class="line">kube-scheduler:v1.18.6</span><br><span class="line">kube-proxy:v1.18.6</span><br><span class="line">pause:3.2</span><br><span class="line">etcd:3.4.3-0</span><br><span class="line">coredns:1.6.7</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> imageName <span class="keyword">in</span> <span class="variable">$&#123;images[@]&#125;</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    docker pull mirrorgooglecontainers/<span class="variable">$&#123;imageName&#125;</span></span><br><span class="line">    docker tag mirrorgooglecontainers/<span class="variable">$&#123;imageName&#125;</span> k8s.gcr.io/<span class="variable">$&#123;imageName&#125;</span></span><br><span class="line">    docker rmi mirrorgooglecontainers/<span class="variable">$&#123;imageName&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------æˆ‘æ˜¯è„šæœ¬ç»“å°¾--------------------</span></span><br><span class="line"><span class="comment"># å¦‚æœæŸäº›åŒ…æ— æ³•ä¸‹è½½ï¼Œåˆ™éœ€è‡ªè¡Œå» dockerhub ä¸Šæ‰¾ï¼Œå¹¶åœ¨ä¸‹è½½å®Œæ¯•åï¼Œæ·»åŠ  k8s è‡ªå·±çš„ tagsï¼Œä¾‹å¦‚ coredns</span></span><br><span class="line"><span class="comment">#docker pull coredns/coredns:1.6.7 &amp;&amp; docker tag coredns/coredns:1.6.7 k8s.gcr.io/coredns:1.6.7 &amp;&amp; docker rmi coredns/coredns:1.6.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°åˆå§‹åŒ–æ¨¡å¼</span></span><br><span class="line">kubeadm init --kubernetes-version=1.18.6  \</span><br><span class="line">--apiserver-advertise-address=10.200.16.100   \</span><br><span class="line">--service-cidr=10.96.0.0/16 --pod-network-cidr=10.97.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ–‡ä»¶åˆå§‹åŒ–æ¨¡å¼</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm.yaml</span><br><span class="line"><span class="comment"># ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š</span></span><br><span class="line"> advertiseAddress: <span class="comment"># apiserver èŠ‚ç‚¹å†…ç½‘IP</span></span><br><span class="line"> <span class="built_in">type</span>: CoreDNS  <span class="comment"># dnsç±»å‹</span></span><br><span class="line"> kubernetesVersion: v1.18.6  <span class="comment"># k8sç‰ˆæœ¬</span></span><br><span class="line"> podSubnet: 10.97.0.0/16</span><br><span class="line"> serviceSubnet: 10.96.0.0/16</span><br><span class="line"><span class="comment"># è¿½åŠ  ipvs é…ç½®</span></span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs  <span class="comment"># kube-proxy æ¨¡å¼</span></span><br><span class="line"><span class="comment"># è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">kubeadm init --config kubeadm.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•åˆå§‹åŒ–ç”Ÿæˆçš„å‘½ä»¤ï¼Œç‰¹åˆ«æ˜¯æœ€åçš„ kubeadm join</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®é€šè¿‡kubectlè®¿é—®é›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="comment"># kubectl å‘½ä»¤è¡¥å…¨</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line"></span><br><span class="line"><span class="comment"># You should now deploy a pod network to the cluster.</span></span><br><span class="line"><span class="comment"># Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span></span><br><span class="line"><span class="comment"># https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br></pre></td></tr></table></figure></li><li><p>è°ƒæ•´ kube-controller-manager å’Œ scheduler çš„é…ç½®.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½ å¯èƒ½ä¼šå‘ç°ï¼Œæ­¤æ—¶ç”¨ kubectl get cs ä¼šå‡ºç°æœåŠ¡è¿æ¥æ‹’ç»é—®é¢˜</span></span><br><span class="line">controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refused</span><br><span class="line">scheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line"><span class="comment"># åŸå› æ˜¯è¿™ä¸¤ä¸ªæœåŠ¡é…ç½®é»˜è®¤ç«¯å£æ˜¯0ã€‚è‡³äºä¸ºå•¥å°±ä¸æ™“å¾—äº†</span></span><br><span class="line"><span class="comment"># ä½ éœ€è¦æ³¨é‡Šæ‰ä¸¤ä¸ªé…ç½®é‡Œçš„ç«¯å£ï¼ˆ- --port=0ï¼‰ï¼Œæ¢å¤ä¸ºé»˜è®¤ç«¯å£</span></span><br><span class="line">sed -i <span class="string">&#x27;/- --port=0/d&#x27;</span> /etc/kubernetes/manifests/kube-scheduler.yaml</span><br><span class="line">sed -i <span class="string">&#x27;/- --port=0/d&#x27;</span> /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br><span class="line"><span class="comment"># é‡å¯ kubelet</span></span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ ç½‘ç»œæ’ä»¶</p><p>ç½‘ç»œæ’ä»¶å¸¸ç”¨çš„æœ‰ä¸¤ç§ï¼Œ</p><p>ç¬¬ä¸€ç§æ˜¯ flannelï¼Œæ¶‰åŠåˆ°æ›´å¤šçš„ iptables è§„åˆ™</p><p>ç¬¬äºŒç§æ˜¯ calicoï¼Œæ¶‰åŠåˆ°æ›´å¤šçš„è·¯ç”±è§„åˆ™</p><ul><li>flannel</li></ul><blockquote><p><a href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a> ä»£ç æ‰˜ç®¡åœ°å€</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="comment"># ä¿®æ”¹é‡Œé¢çš„ &quot;Network&quot;: &quot;10.244.0.0/16&quot;, å˜æ›´ä¸ºä½ è‡ªå·±çš„ pod ç½‘æ®µ</span></span><br><span class="line">kubectl apply -f  kube-flannel.yml</span><br></pre></td></tr></table></figure><ul><li>calico</li></ul><blockquote><p><a href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart">https://docs.projectcalico.org/getting-started/kubernetes/quickstart</a> å®‰è£…æ–‡æ¡£</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/tigera-operator.yaml</span><br><span class="line">wget https://docs.projectcalico.org/manifests/custom-resources.yaml</span><br><span class="line"><span class="comment"># custom-resources.yaml ä¿®æ”¹é‡Œé¢çš„ç½‘ç»œä¸º pod ç½‘æ®µ</span></span><br><span class="line">kubectl apply -f custom-resources.yaml</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼Œå½“ä½ ä½¿ç”¨äº† calico åï¼Œ ä¼šç”Ÿæˆä¸€äº› cni çš„é…ç½®ï¼Œè¿™äº›é…ç½®ä¼šå¯¼è‡´ä½ è¿”å› flannel çš„æ—¶å€™å‡ºç°é—®é¢˜ã€‚ä¾‹å¦‚æ— æ³•åˆ›å»º cni</p><p>ä½ å¯ä»¥ä½¿ç”¨ find / -name â€˜*calico*â€™ æ‰¾åˆ°æ‰€æœ‰ä¿¡æ¯ï¼Œç„¶åéƒ½åˆ é™¤</p></blockquote></li><li><p>é»˜è®¤kubeadmå®‰è£…å®Œåï¼Œç¦æ­¢è°ƒåº¦podåˆ°masterä¸Š</p></li><li><p>æ·»åŠ webæ§åˆ¶å°</p><blockquote><p><a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a> ä»£ç æ‰˜ç®¡åœ°å€</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml &amp;&amp; mv recommended.yaml kubernetes-dashboard.yaml</span><br><span class="line"><span class="comment"># è¿™é‡Œæˆ‘ä»¬è¦ä¿®æ”¹ä¸€äº›ä¸œè¥¿</span></span><br><span class="line"><span class="comment"># é»˜è®¤æ§åˆ¶å°çš„ svc é…ç½®ç±»å‹ä¸æ˜¯ NodePortï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡å®¿ä¸»æœºipè®¿é—®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ï¼Œå°† dashboard çš„ svc åŠ å…¥NodePortç±»å‹</span></span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort: 30001</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"><span class="comment">#---</span></span><br><span class="line"><span class="comment"># è¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹éƒ¨ç½²çš„ä½ç½®ï¼Œå¦‚æœä½ é›†ç¾¤ä¸­å·²ç»åŠ å…¥äº†å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä¼šå¯¼è‡´ pod åˆ†å‘åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šã€‚è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶åˆ†å‘åˆ° master ä¸Š. æ‰¾åˆ° kind: Deployment é…ç½®ï¼Œå¹¶ä¿®æ”¹ä¸¤ä¸ª pod çš„åˆ†å‘ä½ç½®ä¸º nodeName: &lt;master èŠ‚ç‚¹ä¸»æœºå&gt;</span></span><br><span class="line"><span class="comment">#---</span></span><br><span class="line">    spec:</span><br><span class="line">      nodeName: k8s00</span><br><span class="line">      containers:</span><br><span class="line">        - name: kubernetes-dashboard</span><br><span class="line">          image: kubernetesui/dashboard:v2.0.3</span><br><span class="line">          </span><br><span class="line">    spec:</span><br><span class="line">      nodeName: k8s00</span><br><span class="line">      containers:</span><br><span class="line">        - name: dashboard-metrics-scraper</span><br><span class="line">          image: kubernetesui/metrics-scraper:v1.0.4          </span><br><span class="line"><span class="comment">#---</span></span><br><span class="line"><span class="comment"># ç„¶ååˆ›å»º</span></span><br><span class="line">kubectl create -f kubernetes-dashboard.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è®¿é—® token</span></span><br><span class="line"><span class="comment"># å®˜æ–¹æ–‡æ¡£ï¼š https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md</span></span><br><span class="line"><span class="comment"># é€šè¿‡ä¸‹é¢å†…å®¹åˆ›å»º kube-db-auth.yaml</span></span><br><span class="line">cat &gt; kube-db-auth.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">EOF</span><br><span class="line">kubectl apply -f kube-db-auth.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ä¸‹é¢å‘½ä»¤æ‹¿åˆ° token</span></span><br><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ https://&lt;masterip&gt;:30001 è®¿é—®</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="ä»¥ä¸‹å‘½ä»¤åœ¨émasterèŠ‚ç‚¹æ‰§è¡Œ">ä»¥ä¸‹å‘½ä»¤åœ¨émasterèŠ‚ç‚¹æ‰§è¡Œ</h2><ol><li><p>èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤</p><blockquote><p>åŠ å…¥å‘½ä»¤ï¼Œä½äº master åˆå§‹åŒ–å‘½ä»¤å°¾éƒ¨</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubeadm join 10.200.16.100:6443 --token abcdef.827 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:681d6529ebcd1acaec488c842b42222838</span><br><span class="line"><span class="comment"># å¦‚æœå¿˜è®°äº† token</span></span><br><span class="line">kubeadm token list</span><br><span class="line">openssl x509 -pubkey -<span class="keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="string">&#x27;s/^.* //&#x27;</span></span><br></pre></td></tr></table></figure></li></ol><hr><h2 id="kubectl-å‘½ä»¤æ–‡æ¡£">kubectl å‘½ä»¤æ–‡æ¡£</h2><blockquote><p><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢é›†ç¾¤ç½‘ç»œçš„app</span></span><br><span class="line">kubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤ä¸æ¸…ç†">åˆ é™¤ä¸æ¸…ç†</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master åˆ é™¤æ‰€æœ‰ work node</span></span><br><span class="line">kubectl get node | awk <span class="string">&#x27;FNR!=1&#123;print $1&#125;&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> node;<span class="keyword">do</span> </span><br><span class="line">kubectl drain <span class="variable">$node</span>  --delete-local-data --force --ignore-daemonsets;</span><br><span class="line">kubectl delete node <span class="variable">$node</span>;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰€æœ‰èŠ‚ç‚¹æ¸…ç†</span></span><br><span class="line">yes | kubeadm reset;</span><br><span class="line">iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line">ipvsadm --clear;</span><br><span class="line">ip link <span class="built_in">set</span> cni0 down &amp;&amp; ip link delete cni0;</span><br><span class="line">ip link <span class="built_in">set</span> flannel.1 down &amp;&amp; ip link delete flannel.1;</span><br><span class="line">ip link <span class="built_in">set</span> kube-ipvs0 down &amp;&amp; ip link delete kube-ipvs0;</span><br><span class="line">ip link <span class="built_in">set</span> dummy0 down &amp;&amp; ip link delete dummy0;</span><br><span class="line">rm -rf /var/lib/cni/</span><br><span class="line">rm -rf <span class="variable">$HOME</span>/.kube;</span><br><span class="line"></span><br><span class="line"><span class="comment"># -------æˆ‘æ˜¯åˆ†å‰²çº¿------</span></span><br><span class="line"><span class="comment"># åˆ é™¤æŸä¸ª work node</span></span><br><span class="line"><span class="comment"># master exec</span></span><br><span class="line">kubectl drain &lt;NODE_ID&gt; --delete-local-data --force --ignore-daemonsets</span><br><span class="line">kubectl delete node &lt;NODE_ID&gt;</span><br><span class="line"><span class="comment"># worker exec</span></span><br><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure><hr><h1>ä»¥ä¸‹æ–‡æ¡£è¿˜æœªæ›´æ–°ï¼Œå±äºè€æ–‡æ¡£,  è¯·æ— è§†</h1><h2 id="æ„å»ºé«˜å¯ç”¨çš„-master-èŠ‚ç‚¹">æ„å»ºé«˜å¯ç”¨çš„ master èŠ‚ç‚¹</h2><blockquote><p>æ–‡æ¡£: <a href="https://kubernetes.io/docs/setup/independent/high-availability/">https://kubernetes.io/docs/setup/independent/high-availability/</a></p></blockquote><ol><li><p>æ„å»ºè´Ÿè½½è½¯ä»¶, æ¯”å¦‚ haproxy, å¹¶å°†å…¶è½¬å‘åˆ°æ‰€æœ‰ master çš„ apiserver</p></li><li><p>ä¿®æ”¹ä¸» master çš„ kubeadm-config.yaml ä¸­ä»¥ä¸‹é”®å€¼:</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: stable</span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - &quot;LOAD_BALANCER_DNS&quot;</span><br><span class="line">controlPlaneEndpoint: &quot;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&quot;</span><br></pre></td></tr></table></figure></li><li><p>åˆå§‹åŒ–ä¸» master, å¹¶å°†è¯ä¹¦å¤åˆ¶åˆ°å…¶å®ƒ master èŠ‚ç‚¹ä¸Š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">USER&#x3D; # ä¿®æ”¹ä¸ºå…å¯†å…è¯ä¹¦ç”¨æˆ·</span><br><span class="line">CONTROL_PLANE_IPS&#x3D;&quot;&quot; # ä¿®æ”¹ä¸ºå…¶å®ƒ master èŠ‚ç‚¹</span><br><span class="line">for host in $&#123;CONTROL_PLANE_IPS&#125;; do</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.crt &quot;$&#123;USER&#125;&quot;@$host:</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;ca.key &quot;$&#123;USER&#125;&quot;@$host:</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.key &quot;$&#123;USER&#125;&quot;@$host:</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;sa.pub &quot;$&#123;USER&#125;&quot;@$host:</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.crt &quot;$&#123;USER&#125;&quot;@$host:</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;front-proxy-ca.key &quot;$&#123;USER&#125;&quot;@$host:</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt &quot;$&#123;USER&#125;&quot;@$host:etcd-ca.crt</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.key &quot;$&#123;USER&#125;&quot;@$host:etcd-ca.key</span><br><span class="line">    scp &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf &quot;$&#123;USER&#125;&quot;@$host:</span><br><span class="line">done</span><br></pre></td></tr></table></figure></li><li><p>åœ¨å…¶å®ƒ master èŠ‚ç‚¹ä¸Š, å°†è¯ä¹¦ä»ç”¨æˆ·å®¶ç›®å½•ç§»è‡³å·¥ä½œç›®å½•</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">USER&#x3D;ubuntu # customizable</span><br><span class="line">mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;ca.crt &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;ca.key &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;sa.pub &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;sa.key &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;front-proxy-ca.crt &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;front-proxy-ca.key &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;etcd-ca.crt &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.crt</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;etcd-ca.key &#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd&#x2F;ca.key</span><br><span class="line">mv &#x2F;home&#x2F;$&#123;USER&#125;&#x2F;admin.conf &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ä¸» master åˆå§‹åŒ–çš„ kubeadm join å‘½ä»¤å°†å…¶å®ƒ master åŠ å…¥åˆ°ä¸» master é‡Œ</p><blockquote><p>æ³¨æ„éœ€è¦è¿½åŠ  experimental-control-plane å‚æ•°, ç”¨äºè‡ªåŠ¨å°†æ­¤ master è¿æ¥åˆ°é›†ç¾¤</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubeadm join --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;ca cert hash&gt; &lt;apiserver:6443&gt; --experimental-control-plane</span><br></pre></td></tr></table></figure></li><li><p>è§‚å¯Ÿ kube-system å‘½åç©ºé—´ä¸­ etcd pod çš„çŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get pod -n kube-system -w</span><br></pre></td></tr></table></figure></li></ol><h2 id="èŠ‚ç‚¹ä¸€è‡´æ€§æµ‹è¯•">èŠ‚ç‚¹ä¸€è‡´æ€§æµ‹è¯•</h2><blockquote><p><a href="https://kubernetes.io/docs/setup/node-conformance/">https://kubernetes.io/docs/setup/node-conformance/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜è®°å½•ç‚¹</title>
      <link href="posts/e1096625/"/>
      <url>posts/e1096625/</url>
      
        <content type="html"><![CDATA[<ol><li><p>pvå’Œpvcçš„ç»‘å®šå…³ç³»æ˜¯ç»ˆç”Ÿçš„. ä¹Ÿå°±æ˜¯è¯´ä½ åˆ é™¤äº†å½“å‰pvc, pvä¾ç„¶ä¸èƒ½è¢«å…¶å®ƒpvcæ‰€ç»‘å®š.</p><p>åˆ é™¤pvcå, pvçš„çŠ¶æ€å°†ä»boundè½¬ä¸ºReleased.</p><p>å¦‚æœä½ æƒ³è®©pvä»æ–°ç»‘å®šåˆ°åŸæ¥çš„pvcä¸Š, åˆ™éœ€è¦ä¸¤ä¸ªæ­¥éª¤:</p><ol><li>å…ˆåˆ›å»ºåŸæ¥çš„pvc.</li><li>åˆ é™¤å½“å‰pvå¹¶é‡æ–°åˆ›å»º, æˆ–è€…ä¿®æ”¹å½“å‰pvçš„é…ç½®, åˆ é™¤spec.claimRefä¿¡æ¯.</li></ol></li></ol>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix â˜ serverå®‰è£…æ³¨æ„äº‹é¡¹</title>
      <link href="posts/ed865d2f/"/>
      <url>posts/ed865d2f/</url>
      
        <content type="html"><![CDATA[<ol><li><p>æ•°æ®åº“ç¼–ç ä¸€å®šè¦å®‰è£…å®˜æ–¹æ¥å‘½ä»¤æ¥è®¾ç½®ï¼Œä¾‹å¦‚zabbix5ç¼–ç æ˜¯ utf8å’Œutf8_bin</p></li><li><p>æœ€åwebæ§åˆ¶å°å®‰è£…ç•Œé¢ï¼Œè¦ç¡®ä¿zabbix-serverå¯ä»¥è®¿é—®è®¾ç½®çš„ hostname çš„ 10051 ç«¯å£ã€‚å¦‚æœhostnameå†™çš„åŸŸåï¼Œé‚£ä¹ˆè¦ç¡®ä¿zabbix-serverå¯ä»¥é€šè¿‡ hostsæœ¬åœ°è§£ææˆ–è€…å¤–ç½‘è®¿é—®10051ç«¯å£</p></li><li><p>zabbix-server çš„ agent è¦ä½¿ç”¨æ‹‰å–æ¨¡å¼ï¼Œå› ä¸ºå®˜æ–¹ç»™çš„æ¨¡æ¿æ— æ³•ç›´æ¥ä¿®æ­£ä¸ºæ¨æµæ¨¡å¼</p></li><li><p>æŠ¥è­¦åª’ä»‹è®¾ç½®</p><p>è„šæœ¬è®¾ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">è„šæœ¬å‚æ•°</span><br><span class="line">&#123;ALERT.SENDTO&#125;</span><br><span class="line">&#123;ALERT.SUBJECT&#125;</span><br><span class="line">&#123;ALERT.MESSAGE&#125;</span><br></pre></td></tr></table></figure><p>é—®é¢˜æ¨¡æ¿</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ•…éšœ: &#123;TRIGGER.NAME&#125;</span><br><span class="line"></span><br><span class="line">ã€[éª·é«…]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ID : &#123;EVENT.ID&#125;</span><br><span class="line">ã€UTC+0ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">ã€å‘Šè­¦ç­‰çº§ã€‘: &#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">ã€ä¸»æœºä¿¡æ¯1ã€‘: &#123;HOST.NAME&#125;</span><br><span class="line">ã€ä¸»æœºä¿¡æ¯2ã€‘: &#123;HOSTNAME1&#125;</span><br><span class="line">ã€å‘Šè­¦ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;</span><br><span class="line">ã€å‘Šè­¦é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;</span><br><span class="line">ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br></pre></td></tr></table></figure><p>æ¢å¤æ¨¡æ¿</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">æ¢å¤: &#123;TRIGGER.NAME&#125;</span><br><span class="line"></span><br><span class="line">ã€[OK]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ID : &#123;EVENT.ID&#125;</span><br><span class="line">ã€UTC+0ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class="line">ã€å‘Šè­¦ç­‰çº§ã€‘: &#123;TRIGGER.SEVERITY&#125;</span><br><span class="line">ã€ä¸»æœºä¿¡æ¯1ã€‘: &#123;HOST.NAME&#125;</span><br><span class="line">ã€ä¸»æœºä¿¡æ¯2ã€‘: &#123;HOSTNAME1&#125;</span><br><span class="line">ã€å‘Šè­¦ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;</span><br><span class="line">ã€å‘Šè­¦é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;</span><br><span class="line">ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</span><br><span class="line">ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</span><br></pre></td></tr></table></figure></li><li><p>é¢„è­¦ç”¨æˆ·æ·»åŠ è¶…ç®¡æƒé™</p></li><li><p>ä¸­æ–‡å­—ä½“</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install google-noto-sans-simplified-chinese-fonts.noarch -y</span><br><span class="line">rm -rf /etc/alternatives/zabbix-web-font</span><br><span class="line">ln -s /usr/share/fonts/google-noto/NotoSansSC-Regular.otf /etc/alternatives/zabbix-web-font</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜ä»å®¹å™¨ä¸­è®¿é—®å®¿ä¸»æœºdockerå‘½ä»¤</title>
      <link href="posts/3e0f2183/"/>
      <url>posts/3e0f2183/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æˆ‘çš„jenkinsæ˜¯è¿è¡Œåœ¨dockerä¸­ï¼Œä½†æ˜¯jenkinså®˜æ–¹çš„é•œåƒé‡Œå´æ²¡æœ‰dockerå‘½ä»¤ã€‚</p><p>ä»¥è‡³äºæ— æ³•åœ¨æµæ°´çº¿ä¸­æ‰“åŒ…dockeré•œåƒã€‚</p><h2 id="æ–¹æ³•">æ–¹æ³•</h2><p>é¦–å…ˆï¼Œéœ€è¦å°†dockerå‘½ä»¤ã€docker.sockæ–‡ä»¶ä»¥åŠç›¸å…³ä¾èµ–æ–‡ä»¶æ˜ å°„åˆ°å®¹å™¨å†…ã€‚</p><p>å…¶æ¬¡ï¼Œä»¥rootç”¨æˆ·è®¿é—®å®¹å™¨ï¼Œåœ¨å®¹å™¨ä¸­æ·»åŠ dockerç»„ï¼Œå¹¶ä¸”ç»„idéœ€è¦å’Œå®¿ä¸»æœºä¸­çš„dockerç»„idä¸€è‡´ã€‚</p><p>æœ€åï¼Œä»¥rootç”¨æˆ·è®¿é—®å®¹å™¨ï¼Œå¹¶å°†jenkinsç”¨æˆ·åŠ å…¥åˆ°å®¹å™¨ä¸­çš„dockerç»„ä¸­ã€‚</p><p>æœ€æœ€åï¼Œæœ€å…³é”®çš„æ¥äº†ï¼Œ ä¸€å®šè¦é‡å¯ä¸€ä¸‹ jenkins å®¹å™¨ã€‚ã€‚ã€‚</p><h2 id="ç›¸å…³å‘½ä»¤">ç›¸å…³å‘½ä»¤</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é¢å¤–çš„æ˜ å°„æ–‡ä»¶ï¼ˆå®¿ä¸»æœºæ–‡ä»¶å’Œå®¹å™¨å†…çš„æ˜ å°„è·¯å¾„ï¼Œä»¥å®é™…æƒ…å†µä¸ºå‡†ï¼‰</span></span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker -v /usr/lib64/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ root ç”¨æˆ·è®¿é—® jenkins å®¹å™¨ï¼ˆå®¿ä¸»æœºçš„ç»„IDä»¥å®é™…æƒ…å†µä¸ºå‡†ï¼‰</span></span><br><span class="line">docker <span class="built_in">exec</span> -it -u root jenkins /bin/bash</span><br><span class="line">groupadd -g xxx docker</span><br><span class="line">usermod -aG docker jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ jenkins å®¹å™¨</span></span><br><span class="line">docker stop jenkins &amp;&amp; docker start jenkins</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„">æ³¨æ„</h2><p>åœ¨å®¹å™¨å†…æ‰§è¡Œçš„ groupadd å’Œ usermod å‘½ä»¤ï¼Œéœ€è¦åœ¨æ¯æ¬¡å˜æ›´å®¹å™¨é•œåƒåï¼Œé‡æ–°æ‰§è¡Œï¼Œå› ä¸ºå‘½ä»¤çš„ç›¸å…³ç»“æœéƒ½æ˜¯å®¹å™¨å†…æ•°æ®ï¼Œæ¸…ç†åä¸ä¼šä¿ç•™ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜ssh-MFAè‡ªåŠ¨ç™»é™†</title>
      <link href="posts/5db0cd07/"/>
      <url>posts/5db0cd07/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ssh å…³è”MFAå,å®‰å…¨åº¦å¢åŠ äº†å¾ˆå¤š,ä½†æ˜¯æ¯æ¬¡æ‰‹åŠ¨è¾“å…¥MFAåŠ¨æ€å£ä»¤æ¯”è¾ƒéº»çƒ¦.æ‰€ä»¥è®°å½•ä¸€ä¸‹è‡ªåŠ¨äº¤äº’è¾“å…¥MFAå£ä»¤</p><h2 id="å‘½ä»¤å®‰è£…">å‘½ä»¤å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install oathtool gnupg2 expect</span><br></pre></td></tr></table></figure><blockquote><p>oathtool æ˜¯æˆ‘ä»¬ç”¨æ¥ç”ŸæˆMFAå£ä»¤çš„å·¥å…·.</p><p>expect ç”¨æ¥ç¼–å†™äº¤äº’ç¨‹åº</p></blockquote><h2 id="ç™»é™†äº¤äº’è„šæœ¬">ç™»é™†äº¤äº’è„šæœ¬</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect</span></span><br><span class="line"><span class="built_in">set</span> timeout 5</span><br><span class="line"><span class="built_in">set</span> MFAToken <span class="string">&quot;æˆ‘æ˜¯MFAçš„TOKEN&quot;</span></span><br><span class="line">spawn æˆ‘æ˜¯sshå‘½ä»¤</span><br><span class="line">expect <span class="string">&quot;MFA auth&quot;</span></span><br><span class="line">send <span class="string">&quot;[exec oathtool -b --totp <span class="variable">$MFAToken</span>]\r&quot;</span>;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure><blockquote><p>å°†è„šæœ¬ä¸­çš„TOKENå’Œå‘½ä»¤æ›¿æ¢ä¸ºè‡ªå·±çš„.</p></blockquote><h2 id="æ³¨æ„">æ³¨æ„</h2><p>å¦‚æœä½ å‘ç°ä½ ç™»é™†ä¸äº†, æ¯æ¬¡éƒ½éªŒè¯é”™è¯¯, é‚£ä¹ˆä½ åº”è¯¥æ£€æŸ¥ä¸‹ä½ æœºå™¨çš„æ—¶é—´æ˜¯å¦æ­£å¸¸.</p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> ssh </tag>
            
            <tag> mfa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jdkâ˜å®‰è£…å’Œé…ç½®</title>
      <link href="posts/ac6b3b36/"/>
      <url>posts/ac6b3b36/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>oracle jdk ç°åœ¨æ˜¯å•†ä¸šäº§å“äº†, æ‰€ä»¥çº¿ä¸Šæœ€å¥½è¿˜æ˜¯ç”¨ openjdk.</p><h2 id="å®‰è£…">å®‰è£…</h2><p><a href="https://adoptopenjdk.net/installation.html#linux-pkg">https://adoptopenjdk.net/installation.html#linux-pkg</a></p><h2 id="é…ç½®">é…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> MANPATH=<span class="variable">$JAVA_HOME</span>/man</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar:<span class="variable">$JAVA_HOME</span>/jre/lib/rt.jar</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jdk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜fcgiä¸­aliasçš„ä½¿ç”¨</title>
      <link href="posts/58a1c0c7/"/>
      <url>posts/58a1c0c7/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¼—æ‰€å‘¨çŸ¥, nginx åœ¨é…ç½®é™æ€èµ„æºçš„æ—¶å€™, root å’Œ alias åˆ†åˆ«æ˜¯ä¸¤ç§æŒ‡å®šèµ„æºè·¯å¾„çš„æ–¹å¼.</p><p>å¦‚æœ url æ˜¯ <code>http://xxx.com/god/a.jpg</code>, location åŒ¹é…çš„æ˜¯ <code>/god/</code>.</p><p>åˆ™å½“ç”¨ root å®šä½èµ„æºè·¯å¾„æ—¶, root æŒ‡çš„å°±æ˜¯ <a href="http://xxx.com">xxx.com</a> æ‰€å¯¹åº”çš„è·¯å¾„, æ­¤æ—¶ a.jpg çš„ç‰©ç†è·¯å¾„å°±æ˜¯  $root/god/a.jpg</p><p>å½“ç”¨ alias å®šä½èµ„æºè·¯å¾„æ—¶, alias æŒ‡çš„ <a href="http://xxx.com/god/">xxx.com/god/</a> æ‰€å¯¹åº”çš„è·¯å¾„, æ­¤æ—¶ a.jpg çš„ç‰©ç†è·¯å¾„å°±æ˜¯ ${alias}a.jpg</p><p>å³</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location ^~ /god/ &#123;</span><br><span class="line">    root /<span class="built_in">export</span>/webapps/xxx.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line"></span><br><span class="line">location ^~ /god/ &#123;</span><br><span class="line">    <span class="built_in">alias</span> /<span class="built_in">export</span>/webapps/xxx.com/god/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åé—®é¢˜å‡ºç°äº†. å½“æˆ‘é‡‡ç”¨ä¸Šè¿°è§„åˆ™,å»é…ç½®fcgiçš„æ—¶å€™,ç°å®ç»™äº†æˆ‘æš´å‡»â€¦å¦¥å¦¥çš„404äº†.</p><h2 id="åœ¨fcgiç¯å¢ƒä¸‹-alias-çš„é…ç½®">åœ¨fcgiç¯å¢ƒä¸‹, alias çš„é…ç½®</h2><p>åºŸè¯ä¸å¤šè¯´, ç›´æ¥ä¸Šç»“æœ.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location ^~ /god/ &#123;</span><br><span class="line">    index  index.php index.html index.htm;</span><br><span class="line">    <span class="built_in">alias</span> /<span class="built_in">export</span>/webapps/xxx.com/god/;</span><br><span class="line">    location ~* <span class="string">&quot;\.php$&quot;</span> &#123;</span><br><span class="line">        try_files      <span class="variable">$uri</span> =404;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        include        fastcgi.conf;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  <span class="variable">$request_filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å®˜æ–¹çš„ä¾‹å­:</p><p><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#use-request-filename-for-script-filename">https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#use-request-filename-for-script-filename</a></p></blockquote><p>è¿™é‡Œ, å½“ä½ ç”¨ alias è€Œä¸æ˜¯ root çš„æ—¶å€™, ä½ éœ€è¦å°† $document_root$fastcgi_script_name æ›¿æ¢æˆ $request_filename.</p><p>å‡è®¾ä½ è®¿é—® /god/api.php, è€Œè¿™ä¸ªæ–‡ä»¶çš„ç‰©ç†è·¯å¾„æ˜¯ /export/webapps/xxx.com/god/api.php</p><p>ä½†æ˜¯ $document_root$fastcgi_script_name æŒ‡çš„æ˜¯ /export/webapps/xxx.com/god//god/api.php, è¿™æ˜¯ä¸å¯¹çš„.</p><p>æ­¤æ—¶ $request_filename æŒ‡çš„æ˜¯ /export/webapps/xxx.com/god/api.php.</p><p>å…¶æ¬¡, å½“ä½ ä½¿ç”¨äº† $request_filename çš„æ—¶å€™, åˆ™ fastcgi_index å°†æ— æ³•æ­£å¸¸å·¥ä½œ, å› æ­¤ä½ éœ€è¦æ˜¾å¼çš„æŒ‡å®š index. å³:</p><p>index  index.php index.html index.htm;</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> fcgi </tag>
            
            <tag> php </tag>
            
            <tag> alias </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜è§’è‰²</title>
      <link href="posts/720afd15/"/>
      <url>posts/720afd15/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>è§’è‰²çš„ä½œç”¨å°±æ˜¯è§„èŒƒåŒ–ï¼Œå°†ä¸€ä¸ªplaybookå„éƒ¨åˆ†åˆ†é—¨åˆ«ç±»çš„æ”¾ç½®åœ¨è§„å®šå¥½çš„ç›®å½•ä¸­ã€‚å°±å¦‚åŒlinuxç³»ç»Ÿä¸€æ ·ï¼Œ/etc/å°±æ˜¯æ”¾é…ç½®çš„ï¼Œ/bin å°±æ˜¯æ”¾ç¨‹åºçš„ï¼Œ/tmp å°±æ˜¯æ”¾ä¸´æ—¶æ–‡ä»¶çš„ â€¦</p><p>ansible ä¼šåŸºäºå®˜æ–¹è§„å®šå¥½çš„ç›®å½•ç»“æ„, å»è‡ªåŠ¨åŠ è½½ç›®å½•ä¸­çš„æ–‡ä»¶. å½“ä¸€ä¸ªéœ€æ±‚å¾ˆå¤æ‚çš„æ—¶å€™, æˆ‘ä»¬å°±å¯ä»¥åŸºäºè§’è‰²å¯¹éœ€æ±‚è¿›è¡Œåˆ†ç»„.</p><p>æœ€å, å¦‚æœä½ ä¸æŒ‰ç…§è¿™ä¸ªè§„å®šæ¥èµ°, é‚£ä¹ˆansibleè§’è‰²æ¨¡å—å°±æ‰¾ä¸åˆ°ç›¸å…³ä¸œè¥¿.</p><h2 id="è§’è‰²ç»“æ„">è§’è‰²ç»“æ„</h2><p>è¿™æ˜¯ä¸€ä¸ªå®˜æ–¹é¡¹ç›®çš„ä¾‹å­</p><blockquote><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#</a>  å®˜æ–¹æ–‡æ¡£</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">site.yml</span><br><span class="line">webservers.yml</span><br><span class="line">fooservers.yml</span><br><span class="line">roles/</span><br><span class="line">    common/</span><br><span class="line">        tasks/</span><br><span class="line">        handlers/</span><br><span class="line">        files/</span><br><span class="line">        templates/</span><br><span class="line">        vars/</span><br><span class="line">        defaults/</span><br><span class="line">        meta/</span><br><span class="line">    webservers/</span><br><span class="line">        tasks/</span><br><span class="line">        defaults/</span><br><span class="line">        meta/</span><br></pre></td></tr></table></figure><p>ä¾‹å­ä¸­ï¼Œcommon å’Œ webservers å°±æ˜¯ä¸¤ä¸ªè§’è‰²<br>å…³äºè§’è‰²çš„ç›®å½•ï¼Œå¿…é¡»åŒ…å«ä¸‹é¢åˆ—ä¸¾å‡ºæ¥çš„ç›®å½•ä¹‹ä¸€ï¼Œç›®å½•å¯ä»¥ä¸ºç©ºã€‚ä½†æ˜¯å¦‚æœä½ ä½¿ç”¨åˆ°äº†æŸä¸ªç›®å½•ï¼Œé‚£ä¹ˆéƒ¨åˆ†ç›®å½•éœ€è¦åŒ…å«main.ymlæ–‡ä»¶ã€‚</p><ul><li>tasks è§’è‰²ç”¨åˆ°çš„ä¸»è¦ä»»åŠ¡åˆ—è¡¨</li><li>handlers è§’è‰²æˆ–è€…è§’è‰²å¤–ç”¨åˆ°çš„ä»»åŠ¡åç»­å¤„ç†</li><li>defaults è§’è‰²é»˜è®¤å˜é‡</li><li>vars è§’è‰²å…¶ä½™å˜é‡ï¼Œä¼˜å…ˆçº§å¤§äº defaults ä¸­å®šä¹‰çš„å˜é‡</li><li>files è§’è‰²éƒ¨ç½²ä¸­ç‰µæ‰¯åˆ°çš„æ–‡ä»¶</li><li>templates è§’è‰²çš„jinja2æ¨¡æ¿</li><li>meta è§’è‰²çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚è§’è‰²çš„å±æ€§(ä½œè€…, è¯´æ˜, ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ç­‰)</li></ul><p>æœ€åï¼Œç›®å½•ä¸­main.ymlç”¨æ¥å­˜å‚¨ä¸»é…ç½®ä¿¡æ¯ã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥åŒ…å«å…¶å®ƒçš„å­ä»»åŠ¡ï¼Œåœ¨å­ä»»åŠ¡ä¸­è¯¦ç»†æè¿°ã€‚<br>ä¾‹å¦‚ï¼Œåœ¨ tasks/main.yml ä¸­ï¼Œé€šè¿‡ import_tasksï¼ŒåŒ…å«å…¶å®ƒå­ä»»åŠ¡ï¼Œå°±åƒä¸‹é¢è¿™æ ·</p><blockquote><p>main åŒ…å« redhat å’Œ debianã€‚å½“ç³»ç»Ÿæ˜¯ redhat æ—¶ï¼Œå®‰è£… httpd åŒ…ï¼Œå½“ç³»ç»Ÿæ˜¯ debian æ—¶ï¼Œå®‰è£… apache2 åŒ…</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># roles/xxx/tasks/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">added</span> <span class="string">in</span> <span class="number">2.4</span><span class="string">,</span> <span class="string">previously</span> <span class="string">you</span> <span class="string">used</span> <span class="string">&#x27;include&#x27;</span></span><br><span class="line">  <span class="attr">import_tasks:</span> <span class="string">redhat.yml</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;os_family&#x27;]|lower</span> <span class="string">==</span> <span class="string">&#x27;redhat&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">debian.yml</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_facts[&#x27;os_family&#x27;]|lower</span> <span class="string">==</span> <span class="string">&#x27;debian&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># roles/xxx/tasks/redhat.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;httpd&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># roles/xxx/tasks/debian.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;apache2&quot;</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨è§’è‰²">ä½¿ç”¨è§’è‰²</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># file: site.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">webservers.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">fooservers.yml</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># file: webservers.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">common</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">webservers</span></span><br></pre></td></tr></table></figure><p>åªè¿è¡Œ webservers è§’è‰²ï¼Œå¯ä»¥é€šè¿‡ site.yml æ·»åŠ  limit é™åˆ¶æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook site.yml --<span class="built_in">limit</span> webservers</span><br><span class="line">ansible-playbook webservers.yml</span><br></pre></td></tr></table></figure><h2 id="è§’è‰²ä¼˜å…ˆçº§">è§’è‰²ä¼˜å…ˆçº§</h2><p>è§’è‰²ä¸­é’ˆå¯¹ tasks, handlers, vars æœ‰ä¸€ä¸ªä¼˜å…ˆçº§æ¦‚å¿µ. ä¼˜å…ˆçº§å¤§çš„ä¼šè¦†ç›–æ‰ä¼˜å…ˆçº§å°çš„é…ç½®.</p><p>ä¼˜å…ˆçº§ç”±å¤§åˆ°å°å¦‚ä¸‹:</p><p><code>cli å±‚é¢å‚æ•° &gt; role-xxx-dir &gt; playbook-xxx &gt; role-defaults-dir</code></p><p>è¿™é‡Œ cli å±‚é¢å‚æ•°æŒ‡çš„æ˜¯ ansible-playbook -e vara=â€˜aâ€™ test.play è¿™ç§å¤–éƒ¨ä¼ é€’å˜é‡çš„è¡Œä¸º</p><p>è¿™é‡Œ role-xxx-dir æŒ‡çš„æ˜¯ role ç‰¹å®šç›®å½•é‡Œçš„é…ç½®, ä¾‹å¦‚ tasks, handlers, vars</p><p>è¿™é‡Œ playbook-xxx æŒ‡çš„æ˜¯ç›´æ¥å†™å…¥ ploybook ä¸­çš„éƒ¨åˆ†</p><p>è¿™é‡Œ role-defaults-dir æŒ‡çš„æ˜¯è§’è‰²ç›®å½•ä¸­çš„ defaults é»˜è®¤å˜é‡ç›®å½•</p><h2 id="è§’è‰²å¤åˆ¶">è§’è‰²å¤åˆ¶</h2><p>å¦‚æœä½ æƒ³è®©ä¸€ä¸ªè§’è‰²å¤šæ¬¡æ‰§è¡Œï¼Œå°±å¦‚åŒä¸‹é¢è¿™æ ·</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">moo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">moo</span></span><br></pre></td></tr></table></figure><p>æœ‰ä¸‹åˆ—ä¸¤ç§æ–¹å¼:</p><ol><li>mooï¼Œæ‹¥æœ‰ä¸åŒçš„å‚æ•°</li><li>å°†<code>allow_duplicates: true</code>å†™å…¥ moo/meta/main.yml</li></ol><h2 id="è§’è‰²æ ‡ç­¾">è§’è‰²æ ‡ç­¾</h2><p>æˆ‘ä»¬ä¸€å®šè¦é’ˆå¯¹è§’è‰²ä¸­çš„tasksæ·»åŠ æ ‡ç­¾(tags). åŸå› åœ¨äº, æœ‰äº›æ—¶å€™, å½“æˆ‘ä»¬åªæƒ³ä¿®æ”¹éƒ¨ç½²å¾ˆä¹…çš„ä¸€å †æœºå™¨çš„æŸä¸ªæœåŠ¡æ—¶, æˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œè§’è‰²çš„ playbook çš„æ—¶å€™,è¿½åŠ  --tags å³å¯å¸®åŠ©æˆ‘ä»¬æ‰§è¡Œé¡¹ç›®ä¸­æŸä¸€ä¸ªä»»åŠ¡ï¼Œè€Œä¸å¿…æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡.</p><p>æ¯”å¦‚, æˆ‘ä»¬æœ‰ä¸ªéƒ¨ç½²é¡¹ç›®, å…¶ä¸­æœ‰ä¸€ä¸ªåˆå§‹åŒ–è§’è‰²( common ). common ä¸­æœ‰ä¼—å¤šçš„åˆå§‹åŒ–ä»»åŠ¡, å…¶ä¸­ä¸€ä¸ªä»»åŠ¡æ˜¯ ntp æœåŠ¡çš„ å®‰è£…/é…ç½®/å¯åŠ¨/é‡å¯ .</p><p>ntp æœåŠ¡é…ç½®å¦‚ä¸‹:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># file: roles/common/tasks/main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">be</span> <span class="string">sure</span> <span class="string">ntp</span> <span class="string">is</span> <span class="string">installed</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">pkg=ntp</span> <span class="string">state=installed</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">ntp</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">be</span> <span class="string">sure</span> <span class="string">ntp</span> <span class="string">is</span> <span class="string">configured</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">src=ntp.conf.j2</span> <span class="string">dest=/etc/ntp.conf</span></span><br><span class="line">  <span class="attr">notify:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">restart</span> <span class="string">ntpd</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">ntp</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">be</span> <span class="string">sure</span> <span class="string">ntpd</span> <span class="string">is</span> <span class="string">running</span> <span class="string">and</span> <span class="string">enabled</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=ntpd</span> <span class="string">state=running</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">ntp</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># file: roles/common/handlers/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">ntpd</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=ntpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨, æˆ‘ä»¬åªæƒ³ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒçš„ ntp æœåŠ¡çš„é…ç½®, é‚£ä¹ˆåªéœ€è¦å°† ntp.conf.j2 æ¨¡æ¿é…ç½®å¥½ä¹‹å, é‡æ–°æ‰§è¡Œè¿™ä¸ªplaybookså³å¯. å°±æƒ³ä¸‹é¢è¿™æ ·:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook -i production site.yml --tags ntp</span><br></pre></td></tr></table></figure><h2 id="å†™å¥½çš„playbook">å†™å¥½çš„playbook</h2><p><a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/</a></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜æ¨¡æ¿</title>
      <link href="posts/724fda19/"/>
      <url>posts/724fda19/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å½“ä½ ç”¨ansibleè¿›è¡Œå¤šæœºå™¨çš„é…ç½®è°ƒæ•´ï¼Œä¸”è°ƒæ•´çš„ä¸œè¥¿éƒ½ä¸€æ¨¡ä¸€æ ·ï¼Œæ­¤æ—¶ä½ ä¸ä¼šæ‹’ç»æ¨¡æ¿çš„è¯±æƒ‘ã€‚</p><p>ansibleçš„æ¨¡æ¿æ˜¯jinja2ï¼Œæ‰€ä»¥jinja2çš„ç‰¹æ€§ï¼Œåœ¨è¿™é‡Œéƒ½å¯ä»¥ç”¨ã€‚</p><blockquote><p>æ¨¡æ¿ä¸­ï¼Œä¸è¦å‡ºç°ä»»ä½•ä½ è§‰å¾—æ¨¡æ¿ä¼šå¿½ç•¥çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºç©ºæ ¼</p></blockquote><h2 id="æ¨¡å—-template">æ¨¡å— template</h2><p>å‚æ•°ï¼š</p><ul><li>src æ¨¡æ¿æ–‡ä»¶è·¯å¾„</li><li>dest ç›®çš„æ–‡ä»¶è·¯å¾„</li></ul><p>ç‰µæ‰¯åˆ°ç›®çš„è·¯å¾„ï¼Œå¿…ç„¶æœ‰æƒé™å‚æ•°</p><ul><li>owner ç›®çš„å±ä¸»</li><li>group ç›®çš„å±ç»„</li><li>mode ç›®çš„æƒé™</li></ul><p>è¦†ç›–ä¸å¤‡ä»½</p><ul><li>force è¦†ç›–ï¼Œyes / no</li><li>backup å¤‡ä»½ï¼Œ yes / no ï¼Œ è‹¥ä¸º yes ï¼Œåˆ™ç›®çš„é‡åæ–‡ä»¶ä¼šå…ˆæ”¹å</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">~/test.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">~/test.info</span></span><br></pre></td></tr></table></figure><h2 id="æ¨¡æ¿åˆ†éš”ç¬¦">æ¨¡æ¿åˆ†éš”ç¬¦</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;&#123; &#125;&#125; ä¸€èˆ¬ç”¨æ¥å¡«å……å˜é‡ï¼Œå¯ä»¥æ˜¯è¿‡æ»¤å™¨ï¼Œä¹Ÿå¯ä»¥å¡«å……è¡¨è¾¾å¼ï¼Œä»è€Œè¿”å›ç›¸åº”çš„å€¼ï¼Œä¾‹å¦‚ &#123;&#123; 1==1 &#125;&#125; è¿”å› True</span><br><span class="line">&#123;% %&#125; ä¸€èˆ¬ç”¨æ¥å¡«å……æ§åˆ¶è¯­å¥</span><br><span class="line">&#123;<span class="comment"># #&#125; æ¨¡æ¿æ³¨é‡Šè¯­å¥ï¼Œå¹¶éæ¸²æŸ“åä¼šå‡ºç°</span></span><br><span class="line"><span class="comment">#  ... ## è¿™ä¸€ç§ ansible è²Œä¼¼ä¸æ”¯æŒï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†éš”ç¬¦1">åˆ†éš”ç¬¦1</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#123;&#123; &#125;&#125;</span><br><span class="line">&#123;# æ™®é€šå˜é‡ #&#125;</span><br><span class="line">&#123;&#123; foo.bar &#125;&#125;</span><br><span class="line">&#123;&#123; foo[&#39;bar&#39;] &#125;&#125;</span><br><span class="line">&#123;# ä»¥è¿‡æ»¤å™¨ lookup ä¸ºä¾‹ #&#125;</span><br><span class="line">&#123;&#123; lookup(&#39;file&#39;, &#39;~&#x2F;test.file&#39;) &#125;&#125;</span><br><span class="line">&#123;&#123; lookup(&#39;env&#39;, &#39;PATH&#39; )&#125;&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆç›®çš„æ–‡ä»¶ï¼Œä¼šè¾“å‡º<code>~/test.file</code> å†…å®¹å’Œ <code>$PATH</code> å†…å®¹</p><blockquote><p>å­—ç¬¦ä¸²æ‹¼æ¥éœ€è¦ä½¿ç”¨<code>~</code>ï¼Œä¾‹å¦‚ <code>&quot;name:&quot;~name</code></p></blockquote><h3 id="åˆ†éš”ç¬¦2">åˆ†éš”ç¬¦2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># &#123;% %&#125;</span></span><br><span class="line"><span class="comment"># å®˜ç½‘æ‰€æœ‰çš„æ§åˆ¶åˆ—è¡¨</span></span><br><span class="line">https://jinja.palletsprojects.com/en/master/templates/<span class="comment">#list-of-control-structures</span></span><br></pre></td></tr></table></figure><h4 id="æ¡ä»¶æ§åˆ¶è¯­å¥-if">æ¡ä»¶æ§åˆ¶è¯­å¥ if</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% if æ¡ä»¶1 %&#125;</span><br><span class="line">  pass</span><br><span class="line">&#123;% elif æ¡ä»¶2 %&#125;</span><br><span class="line">  pass</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">  pass </span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><h4 id="å¾ªç¯è¯­å¥-for">å¾ªç¯è¯­å¥ for</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in å¯è¿­ä»£å¯¹è±¡ %&#125;</span><br><span class="line">  &#123;&#123; i &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><blockquote><p>é»˜è®¤å¾ªç¯åï¼Œæ¯ä¸€ä¸ªå¾ªç¯å•ä½“ç‹¬å ä¸€è¡Œï¼Œå¦‚æœéœ€è¦åˆ é™¤ç‹¬å ï¼Œåˆ™éœ€è¦ç»™ç¬¬äºŒä¸ª%}å’Œç¬¬ä¸‰ä¸ªæ§åˆ¶ç¬¦{%åŠ å‡å·ï¼Œæœ€ç»ˆå˜ä¸º-%}å’Œ{%-ã€‚</p></blockquote><p>å…³äºå­—å…¸ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ iteritems() å‡½æ•°ï¼Œä»è€Œæ–¹ä¾¿çš„è·å–åˆ°å­—å…¸çš„ k å’Œ vã€‚ä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for k,v in &#123;&#39;name&#39;:&#39;zhangsan&#39;, &#39;gender&#39;:&#39;male&#39;&#125;.iteritems() %&#125;</span><br><span class="line">  &#123;&#123; k &#125;&#125;:&#123;&#123; v &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸²æŸ“å</span></span><br><span class="line">name:zhangsan</span><br><span class="line">gender:male</span><br></pre></td></tr></table></figure><h4 id="æ¡ä»¶å’Œå¾ªç¯ç»„åˆè¯­å¥">æ¡ä»¶å’Œå¾ªç¯ç»„åˆè¯­å¥</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in å¯è¿­ä»£å¯¹è±¡ if æ¡ä»¶ %&#125;</span><br><span class="line">  æ»¡è¶³æ¡ä»¶è¯­å¥</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">  ä¸æ»¡è¶³æ¡ä»¶è¯­å¥</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in [1,2,3,4] if i&gt;2 %&#125;</span><br><span class="line">&#123;&#123; i &#125;&#125;&#39;s index is &#123;&#123; loop.index &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸²æŸ“å</span></span><br><span class="line">3<span class="string">&#x27;s index is 1</span></span><br><span class="line"><span class="string">4&#x27;</span>s index is 2</span><br></pre></td></tr></table></figure><blockquote><p>loop.index æ˜¯å¾ªç¯ä½“ç´¢å¼•ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸ªç–‘é—®ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œ3å’Œ4çš„ç´¢å¼•åº”è¯¥å°±æ˜¯3å’Œ4ï¼Œä¹‹æ‰€ä»¥æ˜¯1å’Œ2ï¼ŒåŸå› åœ¨äºå½“æ¡ä»¶æ§åˆ¶å’Œå¾ªç¯æ§åˆ¶ä½äºåŒä¸€è¡Œçš„æ—¶å€™ï¼Œå…ˆè¡Œè¿ç®—çš„æ˜¯ <code>[1,2,3,4] if i&gt;2</code>ï¼Œä¹‹åæ‰å¼€å§‹èµ°<code>for</code>å¾ªç¯ã€‚</p><p>å¦‚æœä½ æƒ³è¾“å‡ºåŸå§‹å¾ªç¯ä½“ï¼Œåˆ™éœ€è¦å°†æ¡ä»¶æ§åˆ¶è¯­å¥å¦èµ·ä¸€è¡Œï¼Œæ”¾åœ¨<code>for</code>å¾ªç¯å†…éƒ¨</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in [1,2,3,4] %&#125;</span><br><span class="line">&#123;% if i&gt;2 %&#125;</span><br><span class="line">&#123;&#123; i &#125;&#125;&#39;s index is &#123;&#123; loop.index &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸²æŸ“å</span></span><br><span class="line">3<span class="string">&#x27;s index is 3</span></span><br><span class="line"><span class="string">4&#x27;</span>s index is 4</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°çš„ loop.index åªæ˜¯jinja2çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œå…¶å®ƒæ–¹å¼å…·ä½“å¯è§å®˜ç½‘æ–‡æ¡£</p><p><a href="https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures">https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures</a></p></blockquote><h4 id="å®-macro">å® macro</h4><p>å®å°±æ˜¯ç±»ä¼¼äºå‡½æ•°çš„ä¸€ä¸ªä¸œè¥¿ã€‚</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;# ç¼–å†™å® #&#125;</span><br><span class="line">&#123;% macro func() %&#125;</span><br><span class="line">å‡½æ•°ä½“</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;# è°ƒç”¨å® #&#125;</span><br><span class="line">&#123;&#123; func() &#125;&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% macro func(a,b,c&#x3D;3,d&#x3D;4) %&#125;</span><br><span class="line">&#123;# å®ç¼–å†™çš„æ—¶å€™ï¼Œå®å‚æ•°ï¼Œè¦éµå¾ªé»˜è®¤å‚æ•°åœ¨å</span><br><span class="line">&#123;&#123; a &#125;&#125;</span><br><span class="line">&#123;&#123; b &#125;&#125;</span><br><span class="line">&#123;&#123; c &#125;&#125;</span><br><span class="line">&#123;&#123; d &#125;&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;&#123; func(1,2,5) &#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸²æŸ“å</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">5</span><br><span class="line">4</span><br></pre></td></tr></table></figure><blockquote><p>å½“ç»™å‡ºå‚æ•°è¶…å‡ºäº†å®æ‰€å®šä¹‰çš„å‚æ•°æ—¶ï¼Œæ ¹æ®æƒ…å†µï¼Œå®ä¼šå°†å¤šä½™çš„å‚æ•°å­˜åœ¨å˜é‡ä¸­ï¼Œå³ï¼š</p><p>è¶…å‡ºçš„ä¸ºéå…³é”®å­—å‚æ•°ï¼Œåˆ™å­˜æ”¾åœ¨ä¸€ä¸ªå«<code>varargs</code>çš„å…ƒç»„ä¸­</p><p>è¶…å‡ºçš„ä¸ºå…³é”®å­—å‚æ•°ï¼Œåˆ™å­˜æ”¾åœ¨ä¸€ä¸ªå«<code>kwargs</code>çš„å­—å…¸ä¸­</p></blockquote><h4 id="call-æ–¹æ³•">call æ–¹æ³•</h4><p>å¦‚åŒå½“å‰å‡½æ•°çš„è£…é¥°å™¨ï¼Œå¯ä»¥æ‰©å±•å½“å‰å®çš„åŠŸèƒ½</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;# ç¼–å†™å® funcï¼Œå¹¶è°ƒç”¨ caller #&#125;</span><br><span class="line">&#123;% macro func(a) %&#125;</span><br><span class="line">æˆ‘æœ‰ä¸€ä¸ª&#123;&#123; a &#125;&#125;ã€‚</span><br><span class="line">&#123;&#123; caller(a) &#125;&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;# ç¼–å†™å® func_ext #&#125;</span><br><span class="line">&#123;% macro func_ext(a,b) %&#125;</span><br><span class="line">ä½†&#123;&#123; b &#125;&#125;æ¯”&#123;&#123; a &#125;&#125;å¥½åƒã€‚</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line">&#123;# é€šè¿‡ call å…³è” funcï¼ŒåŠ è½½ func_ext #&#125;</span><br><span class="line">&#123;% call(a) func(&#39;æ±‰å ¡&#39;) %&#125;</span><br><span class="line">&#123;&#123; func_ext(a,&#39;ä¸‰æ˜æ²»&#39;) &#125;&#125;</span><br><span class="line">&#123;% endcall %&#125;</span><br></pre></td></tr></table></figure><blockquote><p>calleræ˜¯callçš„å¯¹è±¡ï¼Œå› æ­¤callerä¹Ÿæ˜¯å¯ä»¥ç»™callä¼ å‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸²æŸ“å</span></span><br><span class="line">æˆ‘æœ‰ä¸€ä¸ªæ±‰å ¡ã€‚</span><br><span class="line">ä½†ä¸‰æ˜æ²»æ¯”æ±‰å ¡å¥½åƒ</span><br></pre></td></tr></table></figure><h2 id="æ‰©å±•">æ‰©å±•</h2><blockquote><p>æ‰©å±•å®˜æ–¹æ–‡æ¡£ï¼Œå¯è§ <a href="https://jinja.palletsprojects.com/en/master/extensions/">https://jinja.palletsprojects.com/en/master/extensions/</a></p></blockquote><p>è¿™é‡Œæˆ‘åªç®€å•çš„è¯´ä¸€ä¸‹å¦‚ä½•å¯åŠ¨ <code>for</code> å¾ªç¯ä¸­çš„ <code>break</code> å’Œ <code>continue</code>ã€‚</p><p><code>ansible</code> ä¸­æ·»åŠ  <code>jinja2</code> æ‰©å±•ï¼Œéœ€è¦ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶ <code>/etc/ansible/ansible.cfg</code>ï¼Œæ‰¾åˆ° <code>jinja2_extensions </code>ï¼Œåœ¨åé¢è¿½åŠ æ‰©å±•é…ç½®å³å¯ï¼Œæ¯ä¸€ä¸ªæ‰©å±•ç”¨é€—å·<code>,</code>åˆ†å‰²ã€‚</p><p><code>break</code>å’Œ<code>continue</code> çš„æ‰©å±•åå«ï¼š<code>jinja2.ext.loopcontrols</code></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-include</title>
      <link href="posts/6ce01f58/"/>
      <url>posts/6ce01f58/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•å…¥é¢å¤–ä»»åŠ¡">å¼•å…¥é¢å¤–ä»»åŠ¡</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">add.yml</span></span><br></pre></td></tr></table></figure><h2 id="ç»‘å®š-kv-å¯¹ï¼Œä»è€Œæ”¹å˜é¢å¤–ä»»åŠ¡é‡Œçš„å˜é‡">ç»‘å®š kv å¯¹ï¼Œä»è€Œæ”¹å˜é¢å¤–ä»»åŠ¡é‡Œçš„å˜é‡</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">add.yml</span></span><br><span class="line">    <span class="string">var1=hello</span></span><br><span class="line">    <span class="string">var2=world</span></span><br></pre></td></tr></table></figure><h2 id="ç»‘å®š-tags-æ ‡è®°">ç»‘å®š tags æ ‡è®°</h2><blockquote><p>å¯ä»¥é€šè¿‡tagsæ‰§è¡Œç›¸åº”çš„é¢å¤–ä»»åŠ¡</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - include: add1.yml</span><br><span class="line">    tags: add1</span><br><span class="line">  - include: add2.yml</span><br><span class="line">    tags: add2</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook test.play --tags add1 <span class="comment"># ä»…æ‰§è¡Œ add1.yml ä»»åŠ¡</span></span><br></pre></td></tr></table></figure><h2 id="ç»‘å®š-loop-å¾ªç¯">ç»‘å®š loop å¾ªç¯</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">add.yml</span></span><br><span class="line">    <span class="attr">loop:</span></span><br><span class="line">      <span class="bullet">-</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># add.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">  <span class="attr">msg:</span> <span class="string">&quot;loop-item: <span class="template-variable">&#123;&#123; item &#125;&#125;</span> in add.yml &quot;</span></span><br></pre></td></tr></table></figure><h2 id="ç»‘å®š-when-æ¡ä»¶">ç»‘å®š when æ¡ä»¶</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">add.yml</span></span><br><span class="line">    <span class="attr">when:</span> <span class="number">1</span> <span class="string">&lt;</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><hr><p>ansible åœ¨å½“å‰ç‰ˆæœ¬2.9ä¸­ï¼Œæ¨èä½¿ç”¨ import_tasks å’Œ include_tasks æ¥æ›¿æ¢ includeï¼Œinclude æœªæ¥æœ‰å¯èƒ½ä¸åœ¨æ”¯æŒã€‚ï¼ˆä¸ºå•¥æ€»æ„Ÿè§‰ ansible å„ç§å˜å‘¢ï¼‰</p><p>import_tasks é™æ€ä»»åŠ¡å¯¼å…¥ï¼Œé™æ€ä»»åŠ¡ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸èƒ½ä»ä»»åŠ¡å¤–ä¼ é€’å˜é‡åˆ°ä»»åŠ¡ä¸­ã€‚</p><p>include_tasks åŠ¨æ€ä»»åŠ¡å¯¼å…¥ã€‚æ”¯æŒå¾ªç¯ä¼ é€’å˜é‡</p><p>import_tasks ç»‘å®š when çš„æ—¶å€™ï¼Œä¼šå°† when çš„æ¡ä»¶ä¸€å¯¹ä¸€çš„åº”ç”¨åˆ°ä»»åŠ¡æ–‡ä»¶ä¸­åˆ—å‡ºçš„æ‰€æœ‰ä»»åŠ¡</p><p>include_tasks ç»‘å®š when çš„æ—¶å€™ï¼Œä¼šå°† when çš„æ¡ä»¶ä»…åº”ç”¨åˆ°ä»»åŠ¡æ–‡ä»¶ã€‚å³åªè¦æ¡ä»¶ä¸ºçœŸï¼Œä»»åŠ¡æ–‡ä»¶é‡Œçš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šæ‰§è¡Œã€‚</p><p>å…³äºæ–°ç‰ˆå†™æ³•ï¼Œç»‘å®š tags çš„æ–¹å¼ï¼Œå’Œæ—§ç‰ˆå·®å¼‚æ¯”è¾ƒå¤§ï¼Œä¾‹å¦‚</p><h4 id="include-tasks">include_tasks</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">include_tasks:</span> </span><br><span class="line">        <span class="attr">file:</span> <span class="string">add.yml</span></span><br><span class="line">        <span class="attr">apply:</span></span><br><span class="line">          <span class="attr">tags:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">add</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">always</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># add.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span> is ok&quot;</span></span><br><span class="line">  <span class="attr">loop:</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> include </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoâ˜æœ¬åœ°æœç´¢</title>
      <link href="posts/f5c218d/"/>
      <url>posts/f5c218d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å®‰è£…å®Œ hexo-generator-search åï¼Œå‘ç°æœç´¢ç»“æœå§‹ç»ˆæ˜¯æ‰€æœ‰æ–‡ç« .</p><p>å¦‚æœä½ ç”¨çš„ä¹Ÿæ˜¯ <a href="https://github.com/Molunerfinn/hexo-theme-melody">Melody</a> ä¸»é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥å‚è€ƒå¦‚ä¸‹ä¿¡æ¯ï¼Œæ¥ç¡®è®¤ã€‚</p><h2 id="æ•ˆæœå›¾">æ•ˆæœå›¾</h2><p><img src="/posts/f5c218d/image-20200518121421437.png" alt="image-20200518121421437"></p><h2 id="è½¯ä»¶åŒ…">è½¯ä»¶åŒ…</h2><blockquote><p>æˆªè‡³ï¼š2020.05.18ï¼Œè½¯ä»¶åŒ…å¦‚ä¸‹</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;gitalk&quot;</span>: <span class="string">&quot;^1.6.2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo&quot;</span>: <span class="string">&quot;^4.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-asset-image&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-deployer-git&quot;</span>: <span class="string">&quot;^2.1.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-generator-archive&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-generator-category&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-generator-index&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-generator-search&quot;</span>: <span class="string">&quot;^2.4.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-generator-tag&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-renderer-ejs&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-renderer-marked&quot;</span>: <span class="string">&quot;^2.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-renderer-pug&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-renderer-stylus&quot;</span>: <span class="string">&quot;^1.1.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hexo-server&quot;</span>: <span class="string">&quot;^1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;react&quot;</span>: <span class="string">&quot;^15.3.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;react-dom&quot;</span>: <span class="string">&quot;^15.3.1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="config-yml">_config.yml</h2><blockquote><p>è¿½åŠ å†…å®¹å¦‚ä¸‹</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.xml</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">content:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="ä¸»é¢˜é…ç½®">ä¸»é¢˜é…ç½®</h2><blockquote><p>ä¿®æ”¹å†…å®¹</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> æœç´¢ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…è„šæœ¬â˜nginxç¼–è¯‘æ–¹å¼</title>
      <link href="posts/6209085/"/>
      <url>posts/6209085/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æ­¤è„šæœ¬ç”¨äºå®‰è£… nginx;tengine;openresty. å®‰è£…ç‰ˆæœ¬ä¸ºï¼š</p><ul><li>nginx: 1.14</li><li>openresty: 1.15.8.3</li><li>tengine: 2.1.2 # è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„ç‰ˆæœ¬â€¦</li></ul><h4 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h4><p>å› ä¸ºæ˜¯ç¼–è¯‘å®‰è£…ï¼Œæ‰€ä»¥äº§å‡ºç›®å½•å‡åœ¨ /usr/local/&lt;nginx/openresty/tengine&gt;ï¼Œé™¤äº† logs åšäº†è½¯é“¾<code> /usr/local/xxx/logs -&gt; /export/logs/nginx</code></p><p><code>/usr/local/xxx/conf ç›®å½•ç»“æ„</code></p><p><img src="/posts/6209085/image-20200515120037239.png" alt="image-20200515120037239"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸‹é¢ä¸¤ä¸ªä¸»é…ç½®æ–‡ä»¶ä¼šå‘Šè¯‰ä½ ï¼Œç›¸åº”çš„ä¸Šä¸‹æ–‡é…ç½®ï¼Œåº”è¯¥ä»¥ä»€ä¹ˆç»“å°¾ï¼ï¼ï¼</span></span><br><span class="line">include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/nginx/conf/server/*.server;</span><br><span class="line">include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/nginx/conf/upstream/*.upstream;</span><br></pre></td></tr></table></figure><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">basedir=/usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$basedir</span></span><br><span class="line">runuser=`whoami`</span><br><span class="line">[[ <span class="variable">$runuser</span> == <span class="string">&#x27;root&#x27;</span> ]] || &#123; </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ERROR:æ‰§è¡Œç”¨æˆ·ä¸æ˜¯<span class="variable">$runuser</span>&quot;</span> &amp;&amp; <span class="built_in">exit</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[[ -d /<span class="built_in">export</span>/logs/nginx ]] || &#123; </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;/export/logs/nginx/ç›®å½•ä¸å­˜åœ¨&quot;</span> &amp;&amp; <span class="built_in">exit</span> </span><br><span class="line">&#125;</span><br><span class="line">CpuNum=`cat /proc/cpuinfo | grep processor | wc -l`</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥å®‰è£…çš„Nginxç‰ˆæœ¬:(nginx;tengine;openresty):&quot;</span> NginxVer</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥å¼€å‘æ—¥å¸¸æ“ä½œç”¨æˆ·:&quot;</span> KaifaUser</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥nginx workerç”¨æˆ·:&quot;</span> NginxWorkerUser</span><br><span class="line">useradd -s /sbin/nologin <span class="variable">$&#123;NginxWorkerUser&#125;</span></span><br><span class="line">usermod -a -G <span class="variable">$&#123;KaifaUser&#125;</span> <span class="variable">$&#123;NginxWorkerUser&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">rm -rf <span class="variable">$&#123;NginxVer&#125;</span> &amp;&amp; mkdir <span class="variable">$&#123;NginxVer&#125;</span></span><br><span class="line"></span><br><span class="line">cat&gt;&gt;<span class="variable">$basedir</span>/test.com.server&lt;&lt;EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.com;</span><br><span class="line">    root /<span class="built_in">export</span>/<span class="variable">$&#123;NginxWorkerUser&#125;</span>/test.com;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#charset koi8-r;</span></span><br><span class="line">    access_log logs/nginx-test.com.access.log main;</span><br><span class="line">    error_log logs/nginx-test.com.error.log;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å…³é—­æ—¥å¿—</span></span><br><span class="line">    location = /favicon.ico &#123;</span><br><span class="line">        log_not_found off;</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># å…³é—­æ—¥å¿—</span></span><br><span class="line">    location = /robots.txt &#123;</span><br><span class="line">        auth_basic off;</span><br><span class="line">        allow all;</span><br><span class="line">        log_not_found off;</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‹’ç»æ¢æµ‹ç½‘ç«™æ ¹ä¸‹çš„éšè—æ–‡ä»¶ Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).</span></span><br><span class="line">    location ~ /\. &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        access_log off;</span><br><span class="line">        log_not_found off;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        <span class="comment">#######è¿™ä¸ªæ˜¯ä¸€ä¸ªthinkphpæ¡†æ¶çš„ä¼ªé™æ€è§„åˆ™ï¼Œè¯·å¿½ç•¥</span></span><br><span class="line">        <span class="keyword">if</span> (!-e \<span class="variable">$request_filename</span>) &#123;</span><br><span class="line">           rewrite ^(.*)\$ /index.php?s=\<span class="variable">$1</span> last;</span><br><span class="line">           <span class="built_in">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#######</span></span><br><span class="line">        index index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#å¼€å¯æµè§ˆå™¨é™æ€æ–‡ä»¶ç¼“å­˜</span></span><br><span class="line">    location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)\$ &#123; </span><br><span class="line">        expires 3h; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment"># è‹¥php-fpm,è¯·ä¿ç•™è¿™é‡Œä¿®æ”¹</span></span><br><span class="line">    location ~ \.php &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1ï¼š9000;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        include fastcgi.conf;</span><br><span class="line">        fastcgi_connect_timeout 10s;</span><br><span class="line">        fastcgi_send_timeout 10s;</span><br><span class="line">        fastcgi_read_timeout 10s;</span><br><span class="line">        fastcgi_buffers 8 256k;                           </span><br><span class="line">        fastcgi_buffer_size 256k;</span><br><span class="line">        fastcgi_busy_buffers_size 256k;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># è‹¥ httpï¼Œè¯·ä¿ç•™è¿™é‡Œä¿®æ”¹</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:8080;</span><br><span class="line">        proxy_connect_timeout 300ms;</span><br><span class="line">        proxy_send_timeout 300ms;</span><br><span class="line">        proxy_read_timeout 300ms;</span><br><span class="line">        proxy_max_temp_file_size 1024m;</span><br><span class="line">        proxy_set_header   Host         <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header   X-Real-IP    <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header   X-Forwarded-For  <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_buffers 256 4k;</span><br><span class="line">        proxy_intercept_errors on;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat&gt;&gt;nginx_status.server&lt;&lt;EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 127.0.0.1;</span><br><span class="line"></span><br><span class="line">   <span class="comment"># charset koi8-r;</span></span><br><span class="line">    access_log off;</span><br><span class="line"></span><br><span class="line">    location /server_status &#123;</span><br><span class="line">        stub_status on;</span><br><span class="line">        access_log off;</span><br><span class="line">        allow 127.0.0.1;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$NginxVer</span> == <span class="string">&#x27;nginx&#x27;</span> ]];<span class="keyword">then</span></span><br><span class="line">    [[ -d /usr/<span class="built_in">local</span>/<span class="variable">$NginxVer</span> ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;/usr/local/$NginxVer å·²å­˜åœ¨&#x27;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">    yum install readline-devel pcre-devel openssl-devel gcc</span><br><span class="line">    wget http://<span class="variable">$&#123;NginxVer&#125;</span>.org/download/<span class="variable">$&#123;NginxVer&#125;</span>-1.14.0.tar.gz -O <span class="variable">$&#123;NginxVer&#125;</span>.tar.gz</span><br><span class="line">    tar xf <span class="variable">$&#123;NginxVer&#125;</span>.tar.gz --strip-components 1 -C <span class="variable">$&#123;NginxVer&#125;</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;NginxVer&#125;</span> &amp;&amp; ./configure --prefix=/usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span> --user=<span class="variable">$&#123;NginxWorkerUser&#125;</span> --group=<span class="variable">$&#123;NginxWorkerUser&#125;</span> --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_v2_module || <span class="built_in">exit</span></span><br><span class="line">    make</span><br><span class="line">    make install</span><br><span class="line">    <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span> &amp;&amp; rm -rf logs</span><br><span class="line">    ln -s /<span class="built_in">export</span>/logs/nginx logs</span><br><span class="line">    <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/conf</span><br><span class="line">    mkdir &#123;location,ssl,upstream,server&#125;</span><br><span class="line">    mv <span class="variable">$basedir</span>/&#123;test.com.server,nginx_status.server&#125; server/</span><br><span class="line">    rm -rf nginx.conf</span><br><span class="line">    cat &gt;&gt;nginx.conf&lt;&lt;EOF</span><br><span class="line">user <span class="variable">$&#123;NginxWorkerUser&#125;</span>;</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections 65535; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_log logs/error.log;</span><br><span class="line"><span class="comment">#error_log logs/error.log notice;</span></span><br><span class="line"><span class="comment">#error_log logs/error.log info;</span></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format main <span class="string">&#x27;\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;\$status \$body_bytes_sent &quot;\$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log logs/access.log main;</span><br><span class="line"></span><br><span class="line">    sendfile on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    gzip_buffers 4 16k;</span><br><span class="line">    gzip_comp_level 2;</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;</span><br><span class="line">    gzip_vary off;</span><br><span class="line">    gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#è·¨åŸŸè®¿é—®</span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Origin *; </span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Headers X-Requested-With;</span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 backlog=8092;</span><br><span class="line">        location / &#123;</span><br><span class="line">        deny all;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/conf/server/*.server;</span><br><span class="line">    include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/conf/upstream/*.upstream;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> [[ <span class="variable">$NginxVer</span> == <span class="string">&#x27;openresty&#x27;</span> ]];<span class="keyword">then</span></span><br><span class="line">    [[ -d /usr/<span class="built_in">local</span>/<span class="variable">$NginxVer</span> ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;/usr/local/$NginxVer å·²å­˜åœ¨&#x27;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">    yum install readline-devel pcre-devel openssl-devel gcc</span><br><span class="line">    wget https://openresty.org/download/openresty-1.15.8.3.tar.gz -O <span class="variable">$&#123;NginxVer&#125;</span>.tar.gz</span><br><span class="line">    tar xf <span class="variable">$&#123;NginxVer&#125;</span>.tar.gz --strip-components 1 -C <span class="variable">$&#123;NginxVer&#125;</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;NginxVer&#125;</span> &amp;&amp; ./configure --prefix=/usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span> --user=<span class="variable">$&#123;NginxWorkerUser&#125;</span> --group=<span class="variable">$&#123;NginxWorkerUser&#125;</span> --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_v2_module || <span class="built_in">exit</span></span><br><span class="line">    make</span><br><span class="line">    make install</span><br><span class="line">    <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/nginx &amp;&amp; rm -rf logs</span><br><span class="line">    ln -s /<span class="built_in">export</span>/logs/nginx logs</span><br><span class="line">    <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/nginx/conf</span><br><span class="line">    mkdir &#123;location,ssl,upstream,server&#125;</span><br><span class="line">    mv <span class="variable">$basedir</span>/&#123;test.com.server,nginx_status.server&#125; server/</span><br><span class="line">    rm -rf nginx.conf</span><br><span class="line">    cat &gt;&gt;nginx.conf&lt;&lt;EOF</span><br><span class="line">user <span class="variable">$&#123;NginxWorkerUser&#125;</span>;</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections 65535; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_log logs/error.log;</span><br><span class="line"><span class="comment">#error_log logs/error.log notice;</span></span><br><span class="line"><span class="comment">#error_log logs/error.log info;</span></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format main <span class="string">&#x27;\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;\$status \$body_bytes_sent &quot;\$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log logs/access.log main;</span><br><span class="line"></span><br><span class="line">    sendfile on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    gzip_buffers 4 16k;</span><br><span class="line">    gzip_comp_level 2;</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;</span><br><span class="line">    gzip_vary off;</span><br><span class="line">    gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#è·¨åŸŸè®¿é—®</span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Origin *; </span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Headers X-Requested-With;</span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 backlog=8092;</span><br><span class="line">        location / &#123;</span><br><span class="line">            <span class="built_in">return</span> 444;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/nginx/conf/server/*.server;</span><br><span class="line">    include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/nginx/conf/upstream/*.upstream;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="keyword">elif</span> [[ <span class="variable">$NginxVer</span> == <span class="string">&#x27;tengine&#x27;</span> ]];<span class="keyword">then</span></span><br><span class="line">    [[ -d /usr/<span class="built_in">local</span>/<span class="variable">$NginxVer</span> ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;/usr/local/$NginxVer å·²å­˜åœ¨&#x27;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">    yum install readline-devel pcre-devel openssl-devel gcc jemalloc-devel</span><br><span class="line">    wget http://tengine.taobao.org/download/tengine-2.1.2.tar.gz -O <span class="variable">$&#123;NginxVer&#125;</span>.tar.gz</span><br><span class="line">    tar xf <span class="variable">$&#123;NginxVer&#125;</span>.tar.gz --strip-components 1 -C <span class="variable">$&#123;NginxVer&#125;</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="variable">$&#123;NginxVer&#125;</span> &amp;&amp; ./configure --prefix=/usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span> --user=<span class="variable">$&#123;NginxWorkerUser&#125;</span> --group=<span class="variable">$&#123;NginxWorkerUser&#125;</span> --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-jemalloc || <span class="built_in">exit</span></span><br><span class="line">    make</span><br><span class="line">    make install</span><br><span class="line">    <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span> &amp;&amp; rm -rf logs</span><br><span class="line">    ln -s /<span class="built_in">export</span>/logs/nginx logs</span><br><span class="line">    <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/conf</span><br><span class="line">    mkdir &#123;location,ssl,upstream,server&#125;</span><br><span class="line">    mv <span class="variable">$basedir</span>/&#123;test.com.server,nginx_status.server&#125; server/</span><br><span class="line">    rm -rf nginx.conf</span><br><span class="line">    cat &gt;&gt;nginx.conf&lt;&lt;EOF</span><br><span class="line">user <span class="variable">$&#123;NginxWorkerUser&#125;</span>;</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections 65535; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error_log logs/error.log;</span><br><span class="line"><span class="comment">#error_log logs/error.log notice;</span></span><br><span class="line"><span class="comment">#error_log logs/error.log info;</span></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format main <span class="string">&#x27;\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;\$status \$body_bytes_sent &quot;\$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log logs/access.log main;</span><br><span class="line"></span><br><span class="line">    sendfile on;</span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    gzip_buffers 4 16k;</span><br><span class="line">    gzip_comp_level 2;</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;</span><br><span class="line">    gzip_vary off;</span><br><span class="line">    gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#è·¨åŸŸè®¿é—®</span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Origin *; </span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Headers X-Requested-With;</span></span><br><span class="line">    <span class="comment">#add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 backlog=8092;</span><br><span class="line">        location / &#123;</span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/conf/server/*.server;</span><br><span class="line">    include /usr/<span class="built_in">local</span>/<span class="variable">$&#123;NginxVer&#125;</span>/conf/upstream/*.upstream;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoâ˜å›¾ç‰‡æ˜¾ç¤º</title>
      <link href="posts/662e9d4d/"/>
      <url>posts/662e9d4d/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>å†™ä½œå·¥å…·ï¼štypora</p><p>éƒ¨ç½²ç«¯ï¼šgithub</p><p>éƒ¨ç½²åŒ…ï¼š</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ä½ å¯ä»¥é€šè¿‡hexoçš„æ ¹ç›®å½•ä¸‹çš„package.jsonæ¥ç¡®è®¤ç‰ˆæœ¬</span><br><span class="line">&quot;hexo&quot;: &quot;^4.0.0&quot;,</span><br><span class="line">&quot;hexo-asset-image&quot;: &quot;^1.0.0&quot;</span><br></pre></td></tr></table></figure><p>ç›®å‰ç½‘ä¸Šå¤§å¤šæ•°çš„åšæ–‡æè¿°çš„åœºæ™¯ï¼Œå‡ä¸æ˜¯å½“å‰åœºæ™¯ï¼ˆæˆªè‡³åˆ°2020.05.14ï¼‰ï¼Œæ‰€ä»¥åšæ–‡é‡Œè™½ç„¶å±•ç¤ºéƒ½æ­£å¸¸ï¼Œä½†æ˜¯æŒ‰ç…§åšæ–‡çš„æ“ä½œå´ä¼šæœ‰è·¯å¾„é—®é¢˜ï¼Œå…·ä½“è¡¨ç°æ˜¯å›¾ç‰‡å‰å¤šäº†ä¸€çº§è·¯å¾„ï¼ˆè·¯å¾„åº”è¯¥æ˜¯1çº§åŸŸåï¼Œ<a href="http://xn--bvs393b.com">æ¯”å¦‚.com</a>ï¼Œ.ioç­‰ï¼Œæ ¹æ®ä½ çš„åŸŸåæ¥å®šï¼‰</p><p>é‚£ä¹ˆï¼Œè¯·æŒ‰ç…§ä¸‹é¢æˆ‘çš„æ­¥éª¤æ¥æ“ä½œï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œé‚£å°±ä¸æ˜¯ä¸Šè¿°æˆ‘æ‰€è¯´çš„æƒ…å†µäº†ã€‚</p><h4 id="æµç¨‹">æµç¨‹</h4><ol><li><p>ä¿®æ”¹ hexo-asset-imageï¼Œä¿®æ”¹å†…å®¹å¦‚å›¾æ‰€ç¤º</p><p><img src="/posts/662e9d4d/image-20200901195338475.png" alt="image-20200901195338475">ä¿®æ”¹typoraçš„å›¾ç‰‡å­˜æ”¾è·¯å¾„ï¼Œä¿®æ”¹å†…å®¹å¦‚å›¾æ‰€ç¤º</p><p><img src="/posts/662e9d4d/image-20200514185631903.png" alt="image-20200514185631903"></p><blockquote><p>è¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯æˆ‘æƒ³æ²¡äººä¼šæ‹’ç»æ–¹ä¾¿çš„æ“ä½œã€‚ typora åœ¨è¿›è¡Œå¦‚ä¸Šæ“ä½œåï¼Œå°±å¯ä»¥åœ¨ä½ å¾€æ–‡ç« é‡Œç²˜è´´å›¾ç‰‡çš„æ—¶å€™ï¼Œè‡ªåŠ¨ç”Ÿæˆä»¥æ–‡ä»¶åå‰ç¼€å‘½åçš„ç›®å½•ï¼ˆæ•ˆæœå°±å¦‚åŒä½ å¼€å¯äº†hexoçš„post_asset_folder: trueå‚æ•°ï¼‰ï¼Œå¹¶å°†å›¾ç‰‡å­˜æ”¾åœ¨æ­¤ç›®å½•ä¸­ã€‚</p></blockquote></li><li><p>å¼€å¯ hexo çš„ _config.yml ä¸­ post_asset_folder: true å‚æ•°é…ç½®</p></li></ol><h4 id="ç»“è®º">ç»“è®º</h4><p>ç»è¿‡ä¸Šè¿°æ“ä½œï¼Œæˆ‘æƒ³ä½ å·²ç»å¯ä»¥åœ¨æœ¬åœ° md æ–‡ä»¶å’Œçº¿ä¸ŠåŒæ—¶çœ‹åˆ°å›¾ç‰‡äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> å›¾ç‰‡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜æ—¥å¿—åˆ‡å‰²è„šæœ¬</title>
      <link href="posts/445cf088/"/>
      <url>posts/445cf088/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æœ¬è„šæœ¬ç”¨äºå°† nginx æ—¥å¿—è¿›è¡Œæ—¶é—´å‘¨æœŸåˆ‡å‰²ï¼Œå¹¶ lzo å‹ç¼©ï¼Œæœ€ç»ˆä¸Šä¼ åˆ° s3ã€‚<br>è„šæœ¬åˆ†ä¸ºä¸‰ä¸ªå‡½æ•°ï¼Œåˆ‡å‰²å‡½æ•°ï¼Œå‹ç¼©ä¸Šä¼ å‡½æ•°ï¼Œåˆ é™¤å‡½æ•°ï¼Œéœ€è¦æ‰§è¡Œå“ªä¸ªï¼Œå°±å¡«å†™ç›¸å¯¹åº”å˜é‡ã€‚<br>è¯¦æƒ…å¯ä»¥çœ‹è„šæœ¬æ³¨é‡Šã€‚</p><blockquote><p>è¯·åŠ¡å¿…æ‰§è¡Œå‰ï¼Œç¡®è®¤å®‰è£…äº† lzop å’Œ jq å‘½ä»¤ ï¼Œä¸”æœºå™¨æ˜¯ aws EC2</p></blockquote><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># by zyh</span></span><br><span class="line"><span class="comment"># time: 2019-12-13</span></span><br><span class="line"><span class="comment"># warning: ä½¿ç”¨ä¹‹å‰ yum install -y lzop jq</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># crontab (æ‰§è¡Œæ—¶é—´å‘¨æœŸéœ€è¦å’Œåˆ‡å‰²æ—¶é—´å‘¨æœŸä¸€è‡´) é‡è¦!!!!!!!</span></span><br><span class="line"><span class="comment"># */10 * * * * root bash /export/shell/nginxlog2s3/start.sh &gt; /export/shell/nginxlog2s3/start.log 2&gt;&amp;1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ‡è¯†æ—¥å¿—åå‰ç¼€</span></span><br><span class="line">localtag=`curl -sq http://169.254.169.254/latest/dynamic/instance-identity/document/ | jq -r .<span class="string">&quot;accountId&quot;</span>,.<span class="string">&quot;availabilityZone&quot;</span>,.<span class="string">&quot;privateIp&quot;</span> | sed <span class="string">&#x27;N;N;s@\n@_@g&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------äººä¸ºå˜é‡å¡«å†™å¼€å§‹åŒºåŸŸ----------------------------------</span></span><br><span class="line"><span class="comment"># åˆ‡å‰²æ—¶é—´å‘¨æœŸï¼Œå®šä½åˆ‡å‰²åæ—¥æœŸçš„åˆå§‹å†™å…¥æ—¶é—´ï¼ˆä»…é€‚ç”¨äºè¿ç»­åˆ‡å‰²ï¼Œä¸”ä¸é€‚ç”¨äºç¬¬ä¸€æ¬¡åˆ‡å‰²ï¼‰</span></span><br><span class="line">todaytime=$(date -d <span class="string">&quot;-10 mins&quot;</span> +%Y%m%d)</span><br><span class="line">todayhour=$(date -d <span class="string">&quot;-10 mins&quot;</span> +%H)</span><br><span class="line">todaytimestr=$(date  -d <span class="string">&quot;-10 mins&quot;</span> +%s)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼ä¸šå¾®ä¿¡æœºå™¨äºº</span></span><br><span class="line">wx_api=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx æ—¥å¿—ç›®å½• logs æ‰€åœ¨è·¯å¾„, å¤‡ä»½æ—¥å¿—ç›®å½•æ˜¯ logs/logsbak</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚æ—¥å¿—ç›®å½•æ˜¯ /usr/local/nginx/logsï¼Œåˆ™å¡«å†™ /usr/loca/nginx, åˆ™åˆ‡å‰²åæœ¬åœ°å¤‡ä»½è·¯å¾„æ˜¯ /usr/local/nginx/logs/logsbak</span></span><br><span class="line">nginx_base=</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—ä½äºS3çš„æ ¹è·¯å¾„ï¼Œä¾‹å¦‚ s3://xxx/logs/xxxdays/nginx</span></span><br><span class="line">S3Base=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MvLogList=&quot;a.log b.log c.log&quot;  éœ€è¦åˆ‡å‰²çš„æ—¥å¿—ï¼Œè¿™æ˜¯å¿…é¡»çš„</span></span><br><span class="line">MvLogList=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LzopS3LogList=&quot;a.log b.log c.log&quot; éœ€è¦å‹ç¼©å¹¶ä¸Šä¼ S3çš„æ—¥å¿—ï¼Œå¦‚æœä½ éœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤</span></span><br><span class="line"><span class="comment"># S3ç›®å½•æ ¼å¼ï¼š$&#123;S3Base&#125;/$&#123;æ—¥å¿—å&#125;/$&#123;todaytime&#125;/$&#123;todayhour&#125;/ </span></span><br><span class="line">LzopS3LogList=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DeleteLocalLog=&quot;a.log b.log c.log&quot; éœ€è¦æœ¬åœ°è®¾ç½®ä¿ç•™æ—¶é—´çš„æ—¥å¿—ï¼Œå¦‚æœä½ éœ€è¦æ‰§è¡Œæ­¤æ­¥</span></span><br><span class="line">DeleteLocalLog=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°ä¿å­˜æ—¶é—´</span></span><br><span class="line">deletetime=$(date -d <span class="string">&quot;72 hours ago&quot;</span> +%s)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------äººä¸ºå˜é‡å¡«å†™ç»“æŸåŒºåŸŸ----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—åŸå§‹è·¯å¾„</span></span><br><span class="line">nginx_logs=<span class="string">&quot;<span class="variable">$&#123;nginx_base&#125;</span>/logs&quot;</span></span><br><span class="line"><span class="comment"># æ—¥å¿—ä½äºæœ¬åœ°çš„åˆ‡å‰²åå¤‡ä»½è·¯å¾„</span></span><br><span class="line">backup_logs=<span class="string">&quot;<span class="variable">$&#123;nginx_logs&#125;</span>/logsbak&quot;</span></span><br><span class="line">[[ -d <span class="variable">$&#123;backup_logs&#125;</span> ]] || mkdir -p <span class="variable">$&#123;backup_logs&#125;</span></span><br><span class="line"><span class="comment"># nginx pid æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">nginx_pid=<span class="string">&quot;<span class="variable">$&#123;nginx_logs&#125;</span>/nginx.pid&quot;</span></span><br><span class="line">[[ -f <span class="variable">$&#123;nginx_pid&#125;</span> ]] || &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;nginx_pid&#125;</span> is not exist!!!!&quot;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">mvlog</span></span>()&#123;</span><br><span class="line">  [[ -z <span class="variable">$1</span> ]] &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">  NginxLogName=<span class="variable">$1</span></span><br><span class="line">  [[ -d <span class="variable">$&#123;backup_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span> ]] || mkdir -p <span class="variable">$&#123;backup_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span></span><br><span class="line">  mv <span class="variable">$&#123;nginx_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span> <span class="variable">$&#123;backup_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span>/<span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;todaytime&#125;</span><span class="variable">$&#123;todayhour&#125;</span>_<span class="variable">$&#123;todaytimestr&#125;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;MV: <span class="variable">$&#123;nginx_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span> to <span class="variable">$&#123;backup_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span>/<span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;todaytime&#125;</span><span class="variable">$&#123;todayhour&#125;</span>_<span class="variable">$&#123;todaytimestr&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">lzops3log</span></span>()&#123;</span><br><span class="line">  [[ -z <span class="variable">$1</span> ]] &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">  NginxLogName=<span class="variable">$1</span></span><br><span class="line">  S3Path=<span class="variable">$2</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;backup_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span></span><br><span class="line">  lzop <span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;todaytime&#125;</span><span class="variable">$&#123;todayhour&#125;</span>_<span class="variable">$&#123;todaytimestr&#125;</span> &amp;&amp; aws s3 cp <span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;todaytime&#125;</span><span class="variable">$&#123;todayhour&#125;</span>_<span class="variable">$&#123;todaytimestr&#125;</span>.lzo <span class="variable">$&#123;S3Path&#125;</span>/<span class="variable">$&#123;todaytime&#125;</span>/<span class="variable">$&#123;todayhour&#125;</span>/ --quiet &amp;&amp; rm -rf <span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;todaytime&#125;</span><span class="variable">$&#123;todayhour&#125;</span>_<span class="variable">$&#123;todaytimestr&#125;</span>.lzo &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;UPLOAD: <span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;todaytime&#125;</span><span class="variable">$&#123;todayhour&#125;</span>_<span class="variable">$&#123;todaytimestr&#125;</span>.lzo to <span class="variable">$&#123;S3Path&#125;</span>/<span class="variable">$&#123;todaytime&#125;</span>/<span class="variable">$&#123;todayhour&#125;</span>/&quot;</span> || curl <span class="string">&quot;<span class="variable">$wx_api</span>&quot;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d <span class="string">&#x27;&#123;&quot;msgtype&quot;: &quot;markdown&quot;,&quot;markdown&quot;: &#123;&quot;content&quot;: &quot;# `&#x27;</span><span class="string">&quot;<span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;todaytime&#125;</span><span class="variable">$&#123;todayhour&#125;</span>_<span class="variable">$&#123;todaytimestr&#125;</span>.lzo&quot;</span><span class="string">&#x27;` æ—¥å¿—ä¸Šä¼ å¤±è´¥!!!!!!&quot;&#125;&#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">deletelocallog</span></span>()&#123;</span><br><span class="line">  [[ -z <span class="variable">$1</span> ]] &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">  NginxLogName=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;backup_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span></span><br><span class="line">  <span class="keyword">for</span> logname <span class="keyword">in</span> `ls`;<span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$&#123;deletetime&#125;</span> -ge <span class="variable">$&#123;logname##*_&#125;</span> ]];<span class="keyword">then</span></span><br><span class="line">      rm -rf <span class="variable">$&#123;logname&#125;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;DELETE: <span class="variable">$&#123;backup_logs&#125;</span>/<span class="variable">$&#123;NginxLogName&#125;</span>/<span class="variable">$&#123;localtag&#125;</span>_<span class="variable">$&#123;NginxLogName&#125;</span>_<span class="variable">$&#123;deletetime&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#MV</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;MvLogList&#125;</span>;<span class="keyword">do</span></span><br><span class="line">  mvlog <span class="variable">$&#123;i&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#nginx log reload</span></span><br><span class="line"><span class="built_in">kill</span> -USR1 `cat <span class="variable">$&#123;nginx_pid&#125;</span>`</span><br><span class="line"><span class="comment">#lzop and to s3</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;LzopS3LogList&#125;</span>;<span class="keyword">do</span></span><br><span class="line">  lzops3log <span class="variable">$&#123;i&#125;</span> <span class="variable">$&#123;S3Base&#125;</span>/<span class="variable">$&#123;i&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#Delete</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;DeleteLocalLog&#125;</span>;<span class="keyword">do</span></span><br><span class="line">  deletelocallog <span class="variable">$&#123;i&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix â˜ agentå’Œproxy</title>
      <link href="posts/de5145d4/"/>
      <url>posts/de5145d4/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://repo.zabbix.com/zabbix/">https://repo.zabbix.com/zabbix/</a></p></blockquote><h3 id="agentå®‰è£…å‘½ä»¤">agentå®‰è£…å‘½ä»¤</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ubuntu 16.04</span></span><br><span class="line">wget http://repo.zabbix.com/zabbix/3.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_3.4-1+xenial_all.deb</span><br><span class="line">dpkg -i zabbix-release_3.4-1+xenial_all.deb</span><br><span class="line">apt update</span><br><span class="line">apt-get install zabbix-agent</span><br><span class="line">systemctl enable zabbix-agent</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ubuntu 14.04</span></span><br><span class="line">wget http://repo.zabbix.com/zabbix/3.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_3.4-1+trusty_all.deb</span><br><span class="line">dpkg -i zabbix-release_3.4-1+trusty_all.deb</span><br><span class="line">apt update</span><br><span class="line">apt-get install zabbix-agent</span><br><span class="line">systemctl enable zabbix-agent</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> centos 7</span></span><br><span class="line">rpm -i http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</span><br><span class="line">yum install zabbix-agent -y</span><br><span class="line">systemctl enable zabbix-agent</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> centos 6</span></span><br><span class="line">rpm -i http://repo.zabbix.com/zabbix/3.4/rhel/6/x86_64/zabbix-release-3.4-15.el6.noarch.rpm;</span><br><span class="line">yum install zabbix-agent -y;</span><br><span class="line">chkconfig --level 2345 zabbix-agent on</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="agentä¸»åŠ¨æ¨¡å¼é…ç½®æ–‡ä»¶">agentä¸»åŠ¨æ¨¡å¼é…ç½®æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mv &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf.bak;</span><br><span class="line">cat &gt; &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf &lt;&lt; &#39;EOF&#39;</span><br><span class="line">Hostname&#x3D;</span><br><span class="line">StartAgents&#x3D;0</span><br><span class="line">ServerActive&#x3D;</span><br><span class="line">PidFile&#x3D;&#x2F;var&#x2F;run&#x2F;zabbix&#x2F;zabbix_agentd.pid</span><br><span class="line">LogFile&#x3D;&#x2F;var&#x2F;log&#x2F;zabbix&#x2F;zabbix_agentd.log</span><br><span class="line">#DebugLevel&#x3D;4</span><br><span class="line">Include&#x3D;&#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.d&#x2F;*.conf</span><br><span class="line">#è¢«ç›‘æ§ç«¯åˆ°æœåŠ¡å™¨è·å–ç›‘æ§é¡¹çš„å‘¨æœŸ</span><br><span class="line">RefreshActiveChecks&#x3D;60</span><br><span class="line">#è¢«ç›‘æ§ç«¯å­˜å‚¨ç›‘æ§ä¿¡æ¯çš„ç©ºé—´å¤§å°</span><br><span class="line">BufferSize&#x3D;1000</span><br><span class="line">MaxLinesPerSecond&#x3D;200</span><br><span class="line">#è¶…æ—¶æ—¶é—´</span><br><span class="line">Timeout&#x3D;10</span><br><span class="line">EOF</span><br><span class="line">vi  &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf</span><br><span class="line"></span><br><span class="line">systemctl start zabbix-agent</span><br></pre></td></tr></table></figure><h3 id="proxy-å®‰è£…å‘½ä»¤">proxy å®‰è£…å‘½ä»¤</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># centos 6</span><br><span class="line">yum install http:&#x2F;&#x2F;repo.zabbix.com&#x2F;zabbix&#x2F;3.4&#x2F;rhel&#x2F;6&#x2F;x86_64&#x2F;zabbix-proxy-mysql-3.4.15-1.el6.x86_64.rpm -y</span><br><span class="line"># è§£å‹æ•°æ®åº“æ–‡ä»¶, å¹¶è‡ªè¡Œå¯¼å…¥</span><br><span class="line">zcat &#x2F;usr&#x2F;share&#x2F;doc&#x2F;zabbix-proxy-mysql-3.4.15&#x2F;schema.sql.gz &gt; schema.sql</span><br><span class="line"></span><br><span class="line"># centos 7</span><br><span class="line">yum install http:&#x2F;&#x2F;repo.zabbix.com&#x2F;zabbix&#x2F;3.4&#x2F;rhel&#x2F;7&#x2F;x86_64&#x2F;zabbix-proxy-mysql-3.4.15-1.el7.x86_64.rpm</span><br><span class="line">zcat &#x2F;usr&#x2F;share&#x2F;doc&#x2F;zabbix-proxy-mysql-3.4.15&#x2F;schema.sql.gz &gt; schema.sql</span><br></pre></td></tr></table></figure><h2 id="proxy-é…ç½®">proxy é…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv /etc/zabbix/zabbix_proxy.conf /etc/zabbix/zabbix_proxy.conf.bak;</span><br><span class="line">cat &gt; /etc/zabbix/zabbix_proxy.conf  &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">Server=</span><br><span class="line">ServerPort=10051</span><br><span class="line">Hostname=</span><br><span class="line">LogFile=/var/<span class="built_in">log</span>/zabbix/zabbix_proxy.log</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_proxy.pid</span><br><span class="line">DBHost=</span><br><span class="line">DBPort=</span><br><span class="line">DBName=</span><br><span class="line">DBUser=</span><br><span class="line">DBPassword=</span><br><span class="line">Timeout=4</span><br><span class="line">LogSlowQueries=3000</span><br><span class="line">ConfigFrequency=60</span><br><span class="line">DataSenderFrequency=60</span><br><span class="line">StartDiscoverers=5</span><br><span class="line">CacheSize=128M</span><br><span class="line">StartDBSyncers=20</span><br><span class="line">HistoryCacheSize=256M</span><br><span class="line">HistoryIndexCacheSize=32M</span><br><span class="line">EOF</span><br><span class="line">vi /etc/zabbix/zabbix_proxy.conf</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix â˜ web ç›‘æ§</title>
      <link href="posts/3d20f83e/"/>
      <url>posts/3d20f83e/</url>
      
        <content type="html"><![CDATA[<h2 id="1-æ„å»º-zabbix-agentd-ç«¯é…ç½®">1. æ„å»º zabbix_agentd ç«¯é…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›®å½•ç»“æ„</span></span><br><span class="line">[root@ip-10-230-10-105 zabbix]<span class="comment"># pwd</span></span><br><span class="line">/etc/zabbix</span><br><span class="line">[root@ip-10-230-10-105 zabbix]<span class="comment"># tree &#123;etc,shell&#125;</span></span><br><span class="line">etc</span><br><span class="line">â”œâ”€â”€ zabbix_agentd.conf</span><br><span class="line">â”œâ”€â”€ zabbix_agentd.conf.bak</span><br><span class="line">â””â”€â”€ zabbix_agentd.conf.d</span><br><span class="line">    â””â”€â”€ http_status.conf <span class="comment"># æˆ‘æ˜¯ zabbix_agentd æ•°æ®é¡¹é…ç½®</span></span><br><span class="line"></span><br><span class="line">shell</span><br><span class="line">â””â”€â”€ web</span><br><span class="line">    â”œâ”€â”€ http_status.py <span class="comment"># æˆ‘æ˜¯è‡ªåŠ¨å‘ç°è„šæœ¬ + æ•°æ®é‡‡é›†è„šæœ¬</span></span><br><span class="line"></span><br><span class="line">    â””â”€â”€ WEB.txt  <span class="comment"># æˆ‘æ˜¯è‡ªåŠ¨å‘ç°çš„æ•°æ®æº</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2 directories, 5 files</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># zabbix_agentd é…ç½® http_status.conf</span></span><br><span class="line">UserParameter=web.site.code[*],/usr/bin/python /etc/zabbix/shell/web/http_status.py web_site_code <span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">UserParameter=web.site.discovery,/usr/bin/python /etc/zabbix/shell/web/http_status.py web_site_discovery</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è‡ªåŠ¨å‘ç°è§„åˆ™é…ç½®æ–‡ä»¶ WEB.txt</span></span><br><span class="line"><span class="comment"># ä¸€è¡Œä¸€ä¸ªç›‘æ§åœ°å€</span></span><br><span class="line"><span class="comment"># get åŸæ ·å†™å…¥</span></span><br><span class="line"><span class="comment"># post æ¨¡ä»¿getå¤šåŠ ä¸€ä¸ª?</span></span><br><span class="line">https://abc.com??&lt;post_kv&gt;</span><br><span class="line"></span><br><span class="line">https://abc.com?&lt;get_kv&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="comment"># python2.7</span></span><br><span class="line"><span class="comment"># è‡ªåŠ¨å‘ç°è„šæœ¬ + æ•°æ®é‡‡é›†è„šæœ¬ http_status.py</span></span><br><span class="line"><span class="comment"># è¯·å°†æˆ‘æ·»åŠ  o+x æƒé™</span></span><br><span class="line"><span class="keyword">import</span> urllib2, sys, json, ConfigParser, os </span><br><span class="line"></span><br><span class="line">a1 = sys.argv[<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">web_site_code</span>(<span class="params">args</span>):</span></span><br><span class="line">    response = <span class="literal">None</span></span><br><span class="line">    WEB_TXT = <span class="string">&quot;%s/WEB.txt&quot;</span> % (os.path.dirname(os.path.realpath(__file__)))</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> open(WEB_TXT):</span><br><span class="line">        <span class="keyword">if</span> args <span class="keyword">in</span> line:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;??&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                line = line.strip(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&quot;??&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;?&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">                line = line.strip(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = line.strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    response = urllib2.urlopen(line[<span class="number">0</span>], data=line[<span class="number">1</span>], timeout=<span class="number">5</span>)</span><br><span class="line">                    <span class="keyword">print</span> response.code</span><br><span class="line">                <span class="keyword">except</span> IndexError:</span><br><span class="line">                    response = urllib2.urlopen(line[<span class="number">0</span>], timeout=<span class="number">5</span>)</span><br><span class="line">                    <span class="keyword">print</span> response.code</span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    response = urllib2.urlopen(line, timeout=<span class="number">5</span>)</span><br><span class="line">                    <span class="keyword">print</span> response.code</span><br><span class="line">            <span class="keyword">except</span> urllib2.URLError,e:</span><br><span class="line">                <span class="keyword">if</span> hasattr(e, <span class="string">&#x27;code&#x27;</span>):</span><br><span class="line">                    <span class="keyword">print</span> e.code</span><br><span class="line">                <span class="keyword">elif</span> hasattr(e, <span class="string">&#x27;reason&#x27;</span>):</span><br><span class="line">                    <span class="keyword">print</span> <span class="number">53</span></span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="keyword">if</span> response:</span><br><span class="line">                    response.close()</span><br><span class="line">                exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">web_site_discovery</span>():</span></span><br><span class="line">    Dict = &#123;<span class="string">&quot;data&quot;</span>:[]&#125;</span><br><span class="line">    WEB_TXT = <span class="string">&quot;%s/WEB.txt&quot;</span> % (os.path.dirname(os.path.realpath(__file__)))</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> open(WEB_TXT):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;??&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">            line = line.strip(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&quot;??&quot;</span>)</span><br><span class="line">            line = &#123;<span class="string">&quot;&#123;#SITENAME&#125;&quot;</span>:line[<span class="number">0</span>]&#125;</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&quot;?&quot;</span> <span class="keyword">in</span> line:</span><br><span class="line">            line = line.strip(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">            line = &#123;<span class="string">&quot;&#123;#SITENAME&#125;&quot;</span>:line[<span class="number">0</span>]&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            line = line.strip(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            line = &#123;<span class="string">&quot;&#123;#SITENAME&#125;&quot;</span>:line&#125;</span><br><span class="line">        Dict[<span class="string">&quot;data&quot;</span>].append(line)</span><br><span class="line">    <span class="keyword">print</span> json.dumps(Dict, indent=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> a1 == <span class="string">&#x27;web_site_code&#x27;</span>:</span><br><span class="line">    url = sys.argv[<span class="number">2</span>]</span><br><span class="line">    web_site_code(url)</span><br><span class="line"><span class="keyword">elif</span> a1 == <span class="string">&#x27;web_site_discovery&#x27;</span>:</span><br><span class="line">    web_site_discovery()</span><br></pre></td></tr></table></figure><blockquote><p>{ #SITENAME} è‡ªåŠ¨å‘ç°è„šæœ¬è¾“å‡ºçš„é‡è¦å˜é‡ servername åœ°å€ï¼Œå°†ä¼šç”¨äº web æ§åˆ¶å°é…ç½®</p></blockquote><h2 id="2-æ„å»º-web-æ§åˆ¶å°é…ç½®">2. æ„å»º web æ§åˆ¶å°é…ç½®</h2><ul><li><p>æ„å»ºä¸€ä¸ªä¸»æœºé¡¹ï¼Œç›‘æ§ agentd</p></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºç›‘æ§é¡¹åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20200616182457232.png" alt="image-20200616182457232"></p></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºè§¦å‘å™¨åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20200616182509904.png" alt="image-20200616182509904"></p><blockquote><p>100ç§’ä»¥å†…ï¼Œæ”¶é›†åˆ°ä¸‰æ¬¡ä¸æ˜¯200çš„æ•°æ®ï¼Œå°±æŠ¥è­¦</p></blockquote></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºå›¾å½¢åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20200616182538573.png" alt="image-20200616182538573"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix â˜ redis</title>
      <link href="posts/6c093771/"/>
      <url>posts/6c093771/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-æ¨¡æ¿">zabbix æ¨¡æ¿</h2><ol><li>è‡ªåŠ¨å‘ç°è§„åˆ™</li></ol><p><img src="/posts/6c093771/image-20200520152740815.png" alt="image-20200520152740815"></p><ol start="2"><li><p>è¿‡æ»¤å™¨</p><p><img src="/posts/6c093771/image-20200520152922570.png" alt="image-20200520152922570"></p></li><li><p>ç›‘æ§é¡¹åŸå‹</p><table><thead><tr><th>åç§°</th><th>é”®å€¼</th><th>é—´éš”</th><th>å†å²è®°å½•</th><th>è¶‹åŠ¿</th><th>ç±»å‹</th></tr></thead><tbody><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; connected_clients[å®¢æˆ·ç«¯è¿æ¥æ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,connected_clients]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; maxmemory[redisé…ç½®çš„å†…å­˜ä¸Šé™]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,maxmemory]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; mem_fragmentation_ratio[å†…å­˜ç¢ç‰‡ç‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; redis_instantaneous_ops_per_sec[æ¯ç§’æ‰§è¡Œçš„å‘½ä»¤ä¸ªæ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,instantaneous_ops_per_sec]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; redis å­˜æ´»çŠ¶æ€</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,exist]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; rejected_connections[è¢«æ‹’ç»çš„å®¢æˆ·ç«¯è¿æ¥æ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,rejected_connections]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_sys[redis-master sys-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_sys]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_sys_children[redis-children sys-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_sys_children]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_user[redis-master user-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_user]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_user_children[redis-children user-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_user_children]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory[rediså±‚é¢å·²ä½¿ç”¨å†…å­˜-ä¸å«ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_pct[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜ç™¾åˆ†æ¯”]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_peak[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜å†å²å³°å€¼-å«å†…å­˜ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_peak]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_rss[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜-å«å†…å­˜ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_rss]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr></tbody></table></li><li><p>è§¦å‘å™¨åŸå‹</p><table><thead><tr><th>ä¸¥é‡æ€§</th><th>åç§°</th><th>è¡¨è¾¾å¼</th></tr></thead><tbody><tr><td>ä¸€èˆ¬ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  å†…å­˜ç¢ç‰‡åŒ–è¶…è¿‡50%, å‰©ä½™å¯ç”¨å†…å­˜ä½äº30%</code></td><td><code>&#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio].last()&#125;&gt;1.5  and &#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  å¯ç”¨å†…å­˜ä½, å­˜åœ¨ä½¿ç”¨äº¤æ¢åˆ†åŒº</code></td><td><code>&#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio].last()&#125;&lt;1  and &#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ä¸€èˆ¬ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  æ“ä½œç³»ç»Ÿå±‚é¢å†…å­˜å ç”¨ç™¾åˆ†æ¯”è¿‡é«˜</code></td><td><code>&#123;Template  Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ç¾éš¾</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis ç«¯å£æ— æ³•è®¿é—®</code></td><td><code>&#123;Template  Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,exist].last()&#125;&lt;&gt;1</code></td></tr></tbody></table></li><li><p>å›¾å½¢åŸå‹ï¼Œå°±ä¸è¯¦ç»†å†™äº†ï¼Œè¿™é‡Œåªåˆ—å‡ºæˆ‘è‡ªå·±çš„åˆ†ç±»</p><table><thead><tr><th>åç§°</th><th>å®½</th><th>é«˜</th><th>å›¾å½¢ç±»åˆ«</th></tr></thead><tbody><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis è¿æ¥æ•°ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis å…¶ä»–ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis qps ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis mem ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis cpu ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr></tbody></table></li></ol><h2 id="è„šæœ¬">è„šæœ¬</h2><p>è„šæœ¬ä¼šç”Ÿæˆè‡ªåŠ¨å‘ç°è¿›ç¨‹è„šæœ¬å’Œredisæ£€æµ‹è„šæœ¬</p><p>zabbixçš„redisé…ç½®è·¯å¾„ï¼šZabbixEtc</p><p>zabbixçš„è„šæœ¬è·¯å¾„ï¼šZabbixShell</p><p>redisçš„cliå‘½ä»¤è·¯å¾„ï¼šRedisCli</p><p>è‡ªåŠ¨å‘ç°è„šæœ¬ï¼šip_port_discovery.sh</p><ul><li>bash ip_port_discovery.sh è¿›ç¨‹åæˆ–è€…ç«¯å£</li></ul><p>redisæ£€æµ‹è„šæœ¬ï¼šredis_info.sh</p><ul><li>bash redis_info.sh ip port item</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ZabbixEtc&#x3D;&#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.d</span><br><span class="line">ZabbixShell&#x3D;&#x2F;etc&#x2F;zabbix&#x2F;shell</span><br><span class="line">RedisCli&#x3D;&#39;docker exec -t redis redis-cli&#39;</span><br><span class="line"></span><br><span class="line">[[ -d $&#123;ZabbixShell&#125; ]] || mkdir -p $&#123;ZabbixShell&#125;</span><br><span class="line">[[ -z $&#123;ZabbixEtc&#125; ]] &amp;&amp; [[ -z $&#123;ZabbixShell&#125; ]] || [[ -z $&#123;RedisCli&#125; ]] &amp;&amp; exit</span><br><span class="line"></span><br><span class="line">cat&gt;$&#123;ZabbixEtc&#125;&#x2F;redis.conf&lt;&lt;EOF</span><br><span class="line">##redis monitor</span><br><span class="line">UserParameter&#x3D;redis_info[*],$&#123;ZabbixShell&#125;&#x2F;redis_info.sh \$1 \$2 \$3 \$4</span><br><span class="line">UserParameter&#x3D;ip_port_discovery[*],$&#123;ZabbixShell&#125;&#x2F;ip_port_discovery.sh \$1</span><br><span class="line">EOF</span><br><span class="line">cat&gt;$&#123;ZabbixShell&#125;&#x2F;redis_info.sh&lt;&lt;&quot;EOF&quot;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">RedisCli&#x3D;</span><br><span class="line">HOST&#x3D;$1</span><br><span class="line">PORT&#x3D;$2</span><br><span class="line">REDIS_INFO&#x3D;&quot;$RedisCli -h $HOST -p $PORT info&quot;</span><br><span class="line">[[ $# -ne 3 ]] &amp;&amp; [[ $# -ne 4 ]] &amp;&amp; &#123;</span><br><span class="line"> exit</span><br><span class="line">&#125;</span><br><span class="line">if [[ $# -eq 3 ]];then</span><br><span class="line">case $3 in</span><br><span class="line">exist)</span><br><span class="line"> result&#x3D;&#96;$RedisCli -h $HOST -p $PORT ping 2&gt;&#x2F;dev&#x2F;null |grep -c PONG&#96;</span><br><span class="line"> echo $result</span><br><span class="line">;;</span><br><span class="line">cluster)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep cluster|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">uptime_in_seconds)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep uptime_in_seconds|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">connected_clients)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep connected_clients|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">client_longest_output_list)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep client_longest_output_list|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">client_biggest_input_buf)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep client_biggest_input_buf|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">blocked_clients)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep blocked_clients|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">#å†…å­˜</span><br><span class="line">maxmemory)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep maxmemory|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;|awk &#39;NR&#x3D;&#x3D;1&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep used_memory|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;|awk &#39;NR&#x3D;&#x3D;1&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_rss)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w used_memory_rss|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;|awk -F&#39;k&#39; &#39;&#123;print $1&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_pct)</span><br><span class="line"> A&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep used_memory|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;|awk &#39;NR&#x3D;&#x3D;1&#39;&#96;</span><br><span class="line"> B&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep maxmemory|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;|awk &#39;NR&#x3D;&#x3D;1&#39;&#96;</span><br><span class="line"> result&#x3D;&#96;echo $A $B | awk &#39;&#123;printf&quot;%0.2f&quot;,$1&#x2F;$2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_peak)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep used_memory_peak|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;|awk &#39;NR&#x3D;&#x3D;1&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_lua)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep used_memory_lua|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">mem_fragmentation_ratio)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep mem_fragmentation_ratio|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">#rdb</span><br><span class="line">rdb_changes_since_last_save)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep rdb_changes_since_last_save|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_bgsave_in_progress)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep rdb_bgsave_in_progress|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_last_save_time)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep rdb_last_save_time|awk -F&quot;:&quot; &#39;&#123;print $NF&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_last_bgsave_status)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;rdb_last_bgsave_status&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39; | &#x2F;bin&#x2F;grep -c ok&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_current_bgsave_time_sec)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;rdb_current_bgsave_time_sec&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">#rdbinfo</span><br><span class="line">aof_enabled)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_enabled&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_rewrite_scheduled)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_rewrite_scheduled&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_last_rewrite_time_sec)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_last_rewrite_time_sec&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">            ;;</span><br><span class="line">aof_current_rewrite_time_sec)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_current_rewrite_time_sec&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">            ;;</span><br><span class="line">aof_last_bgrewrite_status)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_last_bgrewrite_status&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39; | &#x2F;bin&#x2F;grep -c ok&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">#aofinfo</span><br><span class="line">aof_current_size)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_current_size&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_base_size)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_base_size&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_pending_rewrite)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_pending_rewrite&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_buffer_length)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_buffer_length&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_rewrite_buffer_length)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_rewrite_buffer_length&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_pending_bio_fsync)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_pending_bio_fsync&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_delayed_fsync)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;aof_delayed_fsync&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">#stats</span><br><span class="line">total_connections_received)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;total_connections_received&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">total_commands_processed)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;total_commands_processed&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">instantaneous_ops_per_sec)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;instantaneous_ops_per_sec&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rejected_connections)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;rejected_connections&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">expired_keys)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;expired_keys&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">evicted_keys)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;evicted_keys&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">keyspace_hits)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;keyspace_hits&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">keyspace_misses)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;keyspace_misses&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">pubsub_channels)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;pubsub_channels&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">pubsub_channels)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;pubsub_channels&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">pubsub_patterns)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;pubsub_patterns&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">latest_fork_usec)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;latest_fork_usec&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">connected_slaves)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;connected_slaves&quot; | awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">master_link_status)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;master_link_status&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;|&#x2F;bin&#x2F;grep -c up&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">master_last_io_seconds_ago)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;master_last_io_seconds_ago&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">master_sync_in_progress)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;master_sync_in_progress&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">slave_priority)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;slave_priority&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">#cpu</span><br><span class="line">used_cpu_sys)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;used_cpu_sys&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_cpu_user)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;used_cpu_user&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_cpu_sys_children)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;used_cpu_sys_children&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_cpu_user_children)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;used_cpu_user_children&quot;|awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"> echo &quot;argu error&quot;</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line">#db0:key</span><br><span class="line">   elif [[ $# -eq 4 ]];then</span><br><span class="line">case $4 in</span><br><span class="line">keys)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO| &#x2F;bin&#x2F;grep -w &quot;db0&quot;| &#x2F;bin&#x2F;grep -w &quot;$1&quot; | &#x2F;bin&#x2F;grep -w &quot;keys&quot; | awk -F&#39;&#x3D;|,&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">expires)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO| &#x2F;bin&#x2F;grep -w &quot;db0&quot;| &#x2F;bin&#x2F;grep -w &quot;$1&quot; | &#x2F;bin&#x2F;grep -w &quot;expires&quot; | awk -F&#39;&#x3D;|,&#39; &#39;&#123;print $4&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">avg_ttl)</span><br><span class="line">        result&#x3D;&#96;$REDIS_INFO|&#x2F;bin&#x2F;grep -w &quot;db0&quot;| &#x2F;bin&#x2F;grep -w &quot;$1&quot; | &#x2F;bin&#x2F;grep -w &quot;avg_ttl&quot; | awk -F&#39;&#x3D;|,&#39; &#39;&#123;print $6&#125;&#39;&#96;</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">     echo &quot;argu error&quot; ;;</span><br><span class="line">esac</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line">cat&gt;$&#123;ZabbixShell&#125;&#x2F;ip_port_discovery.sh&lt;&lt;&quot;EOF&quot;</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#$1æ˜¯è¦å‘ç°çš„è¿›ç¨‹éƒ¨åˆ†è¯æ±‡</span><br><span class="line">portarray&#x3D;(&#96;sudo ss -tnlp|egrep -i &quot;$1&quot;|awk &#123;&#39;print $4&#39;&#125;|awk -F&#39;:&#39; &#39;&#123;if ($NF~&#x2F;^[0-9]*$&#x2F;) print $NF&#125;&#39;|sort|uniq&#96;)</span><br><span class="line">iparray&#x3D;&#96;curl -s http:&#x2F;&#x2F;169.254.169.254&#x2F;latest&#x2F;meta-data&#x2F;local-ipv4&#96;</span><br><span class="line">length&#x3D;$&#123;#portarray[@]&#125;</span><br><span class="line">printf &quot;&#123;\n&quot;</span><br><span class="line">printf &#39;\t&#39;&quot;\&quot;data\&quot;:[&quot;</span><br><span class="line">for ((i&#x3D;0;i&lt;$length;i++))</span><br><span class="line">  do</span><br><span class="line">     printf &#39;\n\t\t&#123;&#39;</span><br><span class="line">     printf &quot;\&quot;&#123;#IP&#125;\&quot;:\&quot;$&#123;iparray&#125;\&quot;,\&quot;&#123;#TCP_PORT&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;</span><br><span class="line">     if [ $i -lt $[$length-1] ];then</span><br><span class="line">                printf &#39;,&#39;</span><br><span class="line">     fi</span><br><span class="line">  done</span><br><span class="line">printf &quot;\n\t]\n&quot;</span><br><span class="line">printf &quot;&#125;\n&quot;</span><br><span class="line">EOF</span><br><span class="line">chmod a+x $&#123;ZabbixShell&#125;&#x2F;redis_info.sh</span><br><span class="line">chmod a+x $&#123;ZabbixShell&#125;&#x2F;ip_port_discovery.sh</span><br><span class="line">sed -i &#39;s#RedisCli&#x3D;#RedisCli&#x3D;\&quot;&#39;&quot;$&#123;RedisCli&#125;&quot;&#39;\&quot;#&#39; $&#123;ZabbixShell&#125;&#x2F;redis_info.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &#39;------------------------------------æˆ‘æ˜¯ zabbix ç›‘æ§ä¿¡æ¯----------------------------------&#39;</span><br><span class="line">echo &#39;ç¼–è¾‘ visudoï¼Œæ·»åŠ å¦‚ä¸‹ä¿¡æ¯&#39;</span><br><span class="line">echo &quot;</span><br><span class="line">#zabbixç”¨æˆ·å¯ä»¥ä»¥sudoæ‰§è¡Œss</span><br><span class="line">zabbix ALL &#x3D; NOPASSWD: &#x2F;usr&#x2F;sbin&#x2F;ss</span><br><span class="line">#zabbixç”¨æˆ·ä½¿ç”¨sudoæ— éœ€tty</span><br><span class="line">Defaults:zabbix    !requiretty</span><br><span class="line">&quot;</span><br><span class="line">echo &#39;è‹¥redisè¿è¡Œåœ¨dockerä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤&#39;</span><br><span class="line">echo &#39;usermod -a -G docker zabbix&#39;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix â˜ nginx</title>
      <link href="posts/b35b5965/"/>
      <url>posts/b35b5965/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç¡®ä¿ç›¸å…³ç›®å½•åœ°å€å¦‚ä¸‹ï¼š</p><p>/etc/zabbix/shell</p><p>/etc/zabbix/zabbix_agentd.d</p><p>/usr/local/nginx/conf/server</p></blockquote><ul><li>1ï¼Œnginxå¢åŠ é…ç½® server_status.server</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &gt; &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;server&#x2F;server_status.server &lt;&lt; &#39;EOF&#39;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  127.0.0.1;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    access_log  off;</span><br><span class="line">    location &#x2F;server_status &#123;</span><br><span class="line">        stub_status on;</span><br><span class="line">        access_log off;</span><br><span class="line">        allow 127.0.0.1;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -t &amp;&amp; &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br></pre></td></tr></table></figure><hr><ul><li>2ï¼Œ<a href="http://xn--nginx-e86hk14jmnl025b.sh">æ·»åŠ è„šæœ¬nginx.sh</a>  (ç¡®ä¿a+xæƒé™)</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;zabbix&#x2F;shell -p;</span><br><span class="line">cat &gt; &#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh &lt;&lt; &#39;EOF&#39;</span><br><span class="line">#!&#x2F;bin&#x2F;bash  </span><br><span class="line"></span><br><span class="line">function active &#123;</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;curl &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot; 2&gt; &#x2F;dev&#x2F;null| grep &#39;Active&#39; | awk &#39;&#123;print $NF&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function reading &#123;</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;curl &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot; 2&gt; &#x2F;dev&#x2F;null| grep &#39;Reading&#39; | awk &#39;&#123;print $2&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function writing &#123;</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;curl &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot; 2&gt;&#x2F;dev&#x2F;null| grep &#39;Writing&#39; | awk &#39;&#123;print $4&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function waiting &#123;</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;curl &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot; 2&gt; &#x2F;dev&#x2F;null| grep &#39;Waiting&#39; | awk &#39;&#123;print $6&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function accepts &#123;</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;curl &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot; 2&gt; &#x2F;dev&#x2F;null| awk NR&#x3D;&#x3D;3 | awk &#39;&#123;print $1&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function handled &#123;</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;curl &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot; 2&gt; &#x2F;dev&#x2F;null| awk NR&#x3D;&#x3D;3 | awk &#39;&#123;print $2&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function requests &#123;</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;curl &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot; 2&gt; &#x2F;dev&#x2F;null| awk NR&#x3D;&#x3D;3 | awk &#39;&#123;print $3&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function qps &#123;</span><br><span class="line">        NGINX_STATUS_URL&#x3D;&quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;server_status&quot;</span><br><span class="line">        #è‹¥æ˜¯tnginxï¼Œåˆ™æœ€ååº”è¾“å‡ºd[length(d)-1]</span><br><span class="line">        requestold&#x3D;&#96;&#x2F;usr&#x2F;bin&#x2F;curl -s $&#123;NGINX_STATUS_URL&#125; | &#x2F;usr&#x2F;bin&#x2F;awk &#39;&#x2F;server accepts handled requests&#x2F;&#123;getline a;split(a,d);print d[length(d)]&#125;&#39;&#96;</span><br><span class="line">        TimeWait&#x3D;1</span><br><span class="line">        sleep $TimeWait</span><br><span class="line">        requestnew&#x3D;&#96;&#x2F;usr&#x2F;bin&#x2F;curl -s $&#123;NGINX_STATUS_URL&#125; | &#x2F;usr&#x2F;bin&#x2F;awk &#39;&#x2F;server accepts handled requests&#x2F;&#123;getline a;split(a,d);print d[length(d)]&#125;&#39;&#96;</span><br><span class="line">        if [ $requestnew -gt 0 ];then</span><br><span class="line">                QPS&#x3D;&#96;echo &quot;( $requestnew - $requestold ) &#x2F; $TimeWait&quot; | &#x2F;usr&#x2F;bin&#x2F;bc&#96;</span><br><span class="line">        fi</span><br><span class="line">        echo $QPS</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Run the requested function  </span><br><span class="line">$1</span><br><span class="line">EOF</span><br><span class="line">chmod a+x &#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh</span><br></pre></td></tr></table></figure><hr><ul><li>3ï¼Œé…ç½®zabbixå®¢æˆ·ç«¯zabbix_agentd.conf</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &gt; &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.d&#x2F;nginx.conf &lt;&lt; &#39;EOF&#39;</span><br><span class="line">#monitor nginx  </span><br><span class="line">UserParameter&#x3D;nginx.accepts,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh accepts</span><br><span class="line">UserParameter&#x3D;nginx.handled,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh handled</span><br><span class="line">UserParameter&#x3D;nginx.requests,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh requests</span><br><span class="line">UserParameter&#x3D;nginx.connections.active,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh active</span><br><span class="line">UserParameter&#x3D;nginx.connections.reading,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh reading</span><br><span class="line">UserParameter&#x3D;nginx.connections.writing,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh writing</span><br><span class="line">UserParameter&#x3D;nginx.connections.waiting,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh waiting</span><br><span class="line">UserParameter&#x3D;nginx.connections.qps,&#x2F;etc&#x2F;zabbix&#x2F;shell&#x2F;nginx.sh qps</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><hr><ul><li>4ï¼Œåœ¨æœåŠ¡çš„å¯¹åº”ä¸»æœºä¸Šæ·»åŠ æ¨¡æ¿</li></ul>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…è„šæœ¬â˜redis</title>
      <link href="posts/65ab632a/"/>
      <url>posts/65ab632a/</url>
      
        <content type="html"><![CDATA[<h4 id="docker-å®‰è£…">docker å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redisName=redis</span><br><span class="line">docker volume create <span class="variable">$&#123;redisName&#125;</span></span><br><span class="line">touch /<span class="built_in">export</span>/docker-data-root/volumes/<span class="variable">$&#123;redisName&#125;</span>/_data/redis.conf</span><br><span class="line">redis.conf è¯·å‚è€ƒå®˜æ–¹é»˜è®¤é…ç½®æ–‡æ¡£ï¼Œé»˜è®¤é…ç½®æ–‡æ¡£åœ°å€ï¼š https://redis.io/topics/config</span><br><span class="line">docker run --name  <span class="variable">$&#123;redisName&#125;</span> -v  <span class="variable">$&#123;redisName&#125;</span>:/data -p 6379:6379 --restart always -d redis redis-server /data/redis.conf </span><br></pre></td></tr></table></figure><h4 id="ç¼–è¯‘å®‰è£…">ç¼–è¯‘å®‰è£…</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> by zyh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2018-06-21</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DownUrl: redisæºç åŒ…</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RedisBaseDirï¼š rediså®‰è£…è·¯å¾„</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RedisPort: redisç«¯å£</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> RedisMaxMemï¼šrediså†…å­˜é™åˆ¶</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ZabbixBase: zabbix æ ¹è·¯å¾„</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…å®Œæ¯•åï¼Œä¼šè¾“å‡º</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. redisä¿¡æ¯</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. zabbixéœ€è¦é¢å¤–æ‰‹åŠ¨æ·»åŠ çš„å‘½ä»¤ï¼Œ å¹¶åœ¨zabbix_server_webé‡Œï¼Œç»™æœºå™¨å…³è”ä¸Š &lt;Template Redis Auto Discovert Active mode&gt; æ¨¡æ¿</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. monitéœ€è¦é¢å¤–æ‰‹åŠ¨æ·»åŠ çš„é…ç½®</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BaseDir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`</span><br><span class="line">DownUrl=http://download.redis.io/releases/redis-stable.tar.gz</span><br><span class="line">RedisMaxMem=1g</span><br><span class="line">RedisPort=6379</span><br><span class="line">RedisBaseDir=/export/redis_$&#123;RedisPort&#125;</span><br><span class="line">ZabbixBase=/etc/zabbix</span><br><span class="line"></span><br><span class="line">if [[ $&#123;ZabbixBase&#125; == &#x27;/usr/local/zabbix&#x27; ]];then</span><br><span class="line">    ZabbixShell=$&#123;ZabbixBase&#125;/shell</span><br><span class="line">    ZabbixEtc=$&#123;ZabbixBase&#125;/etc/zabbix_agentd.conf.d/redis.conf</span><br><span class="line">else</span><br><span class="line">    ZabbixShell=/etc/zabbix/shell</span><br><span class="line">    ZabbixEtc=/etc/zabbix/zabbix_agentd.d/redis.conf</span><br><span class="line">fi</span><br><span class="line">RedisBaseName=$&#123;RedisBaseDir##*/&#125;</span><br><span class="line"></span><br><span class="line">export TOP_PID=$$</span><br><span class="line">trap &#x27;exit 1&#x27; TERM</span><br><span class="line"></span><br><span class="line">exit_script()&#123;</span><br><span class="line">    kill -s TERM $TOP_PID</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">yum install gcc-c++ -y</span><br><span class="line"></span><br><span class="line">[[ -d $&#123;RedisBaseDir&#125; ]] &amp;&amp; echo &quot;$&#123;RedisBaseDir&#125;å·²å­˜åœ¨&quot; &amp;&amp; exit_script</span><br><span class="line">ss -tnalp | grep redis | awk &#x27;&#123;print $4&#125;&#x27; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | while read line;do</span><br><span class="line">    [[ $line -eq $&#123;RedisPort&#125; ]] &amp;&amp; echo &quot;$&#123;RedisPort&#125;å·²è¢«å ç”¨&quot; &amp;&amp; exit_script</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">cd $&#123;BaseDir&#125; &amp;&amp; mkdir redis</span><br><span class="line">wget $&#123;DownUrl&#125; -O redis.tar.gz</span><br><span class="line">tar xf redis.tar.gz --strip-components 1 -C redis</span><br><span class="line">cd redis</span><br><span class="line">make PREFIX=$&#123;RedisBaseDir&#125; install</span><br><span class="line">mkdir $&#123;RedisBaseDir&#125;/&#123;etc,data,logs&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash"><span class="variable">$&#123;RedisBaseDir&#125;</span>/etc/redis.conf &lt;&lt;EOF</span></span><br><span class="line">bind 0.0.0.0</span><br><span class="line">protected-mode yes</span><br><span class="line">port $&#123;RedisPort&#125;</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile $&#123;RedisBaseDir&#125;/redis.pid</span><br><span class="line">loglevel warning</span><br><span class="line">logfile &quot;$&#123;RedisBaseDir&#125;/logs/redis.log&quot;</span><br><span class="line">databases 16</span><br><span class="line">always-show-logo yes</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename redis_$&#123;RedisPort&#125;.rdb</span><br><span class="line">dir $&#123;RedisBaseDir&#125;/data/</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100</span><br><span class="line">rename-command FLUSHDB GOD_FLUSHDB</span><br><span class="line">rename-command FLUSHALL GOD_FLUSHALL</span><br><span class="line">rename-command CONFIG GOD_CONFIG</span><br><span class="line">rename-command KEYS GOD_KEYS</span><br><span class="line">maxmemory $&#123;RedisMaxMem&#125;</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">slave-lazy-flush no</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble no</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events &quot;&quot;</span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash"><span class="variable">$&#123;RedisBaseDir&#125;</span>/redis.sh &lt;&lt; EOF</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Simple Redis init.d script conceived to work on Linux systems</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> as it does use of the /proc filesystem.</span></span><br><span class="line">BASEDIR=$&#123;RedisBaseDir&#125;</span><br><span class="line">REDISPORT=$&#123;RedisPort&#125;</span><br><span class="line">EXEC=\$BASEDIR/bin/redis-server</span><br><span class="line">CLIEXEC=\$BASEDIR/bin/redis-cli</span><br><span class="line">PIDFILE=\$BASEDIR/redis.pid</span><br><span class="line">CONF=&quot;\$BASEDIR/etc/redis.conf&quot;</span><br><span class="line">case &quot;\$1&quot; in</span><br><span class="line">    start)</span><br><span class="line">        [[ -f \$PIDFILE ]] &amp;&amp; kill -0 \`cat \$PIDFILE\` 2&gt;&gt;\$BASEDIR/crash.log &amp;&amp; echo &quot;\$PIDFILE exists, process is already running or crashed&quot; || &#123;</span><br><span class="line">                echo &quot;Starting Redis server...&quot;</span><br><span class="line">                \$EXEC \$CONF</span><br><span class="line">        &#125;</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        if [ ! -f \$PIDFILE ]</span><br><span class="line">        then</span><br><span class="line">                echo &quot;\$PIDFILE does not exist, process is not running&quot;</span><br><span class="line">        else</span><br><span class="line">                PID=\$(cat \$PIDFILE)</span><br><span class="line">                echo &quot;Stopping ...&quot;</span><br><span class="line">                \$CLIEXEC -p \$REDISPORT shutdown</span><br><span class="line">                while [ -x /proc/\$&#123;PID&#125; ]</span><br><span class="line">                do</span><br><span class="line">                    echo &quot;Waiting for Redis to shutdown ...&quot;</span><br><span class="line">                    sleep 1</span><br><span class="line">                done</span><br><span class="line">                echo &quot;Redis stopped&quot;</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Please use start or stop as first argument&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line">EOF</span><br><span class="line">chmod u+x $&#123;RedisBaseDir&#125;/redis.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ä¿®æ”¹å†…æ ¸å‚æ•°</span></span><br><span class="line">grep -q net.core.somaxconn /etc/sysctl.conf || echo &quot;net.core.somaxconn = 511&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">grep -q vm.overcommit_memory /etc/sysctl.conf || &#123;</span><br><span class="line">    echo &quot;vm.overcommit_memory = 1&quot; &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -p</span><br><span class="line">&#125;</span><br><span class="line">grep -q &#x27;/sys/kernel/mm/transparent_hugepage/enabled&#x27; /etc/rc.local || &#123;</span><br><span class="line">    echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">    echo &#x27;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#x27; &gt;&gt; /etc/rc.local</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ä¿®æ”¹zabbixç›‘æ§</span></span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash"><span class="variable">$&#123;ZabbixEtc&#125;</span>&lt;&lt;EOF</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#redis monitor</span></span></span><br><span class="line">UserParameter=redis_info[*],$&#123;ZabbixShell&#125;/redis_info.sh \$1 \$2 \$3 \$4</span><br><span class="line">UserParameter=ip_port_discovery[*],$&#123;ZabbixShell&#125;/ip_port_discovery.sh \$1</span><br><span class="line">EOF</span><br><span class="line">mkdir $&#123;ZabbixShell&#125;</span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash"><span class="variable">$&#123;ZabbixShell&#125;</span>/redis_info.sh&lt;&lt;<span class="string">&quot;EOF&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">REDISPATH=&quot;/export/redis/bin/redis-cli&quot;</span><br><span class="line">HOST=$1</span><br><span class="line">PORT=$2</span><br><span class="line">REDIS_INFO=&quot;$REDISPATH -h $HOST -p $PORT info&quot;</span><br><span class="line">[[ $# -ne 3 ]] &amp;&amp; [[ $# -ne 4 ]] &amp;&amp; &#123;</span><br><span class="line"> exit</span><br><span class="line">&#125;</span><br><span class="line">if [[ $# -eq 3 ]];then</span><br><span class="line">case $3 in</span><br><span class="line">exist)</span><br><span class="line"> result=`$REDISPATH -h $HOST -p $PORT ping 2&gt;/dev/null |grep -c PONG`</span><br><span class="line"> echo $result</span><br><span class="line">;;</span><br><span class="line">cluster)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep cluster|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">uptime_in_seconds)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep uptime_in_seconds|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">connected_clients)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep connected_clients|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">client_longest_output_list)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep client_longest_output_list|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">client_biggest_input_buf)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep client_biggest_input_buf|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">blocked_clients)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep blocked_clients|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line"><span class="meta">#</span><span class="bash">å†…å­˜</span></span><br><span class="line">maxmemory)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;|awk &#x27;NR==1&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;|awk &#x27;NR==1&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_rss)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w used_memory_rss|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;|awk -F&#x27;k&#x27; &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_pct)</span><br><span class="line"> A=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;|awk &#x27;NR==1&#x27;`</span><br><span class="line"> B=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;|awk &#x27;NR==1&#x27;`</span><br><span class="line"> result=`echo $A $B | awk &#x27;&#123;printf&quot;%0.2f&quot;,$1/$2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_peak)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep used_memory_peak|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;|awk &#x27;NR==1&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_memory_lua)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep used_memory_lua|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">mem_fragmentation_ratio)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep mem_fragmentation_ratio|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line"><span class="meta">#</span><span class="bash">rdb</span></span><br><span class="line">rdb_changes_since_last_save)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep rdb_changes_since_last_save|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_bgsave_in_progress)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep rdb_bgsave_in_progress|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_last_save_time)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep rdb_last_save_time|awk -F&quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_last_bgsave_status)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_last_bgsave_status&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | /bin/grep -c ok`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rdb_current_bgsave_time_sec)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_current_bgsave_time_sec&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line"><span class="meta">#</span><span class="bash">rdbinfo</span></span><br><span class="line">aof_enabled)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_enabled&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_rewrite_scheduled)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_scheduled&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_last_rewrite_time_sec)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_rewrite_time_sec&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">            ;;</span><br><span class="line">aof_current_rewrite_time_sec)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_rewrite_time_sec&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">            ;;</span><br><span class="line">aof_last_bgrewrite_status)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_bgrewrite_status&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27; | /bin/grep -c ok`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line"><span class="meta">#</span><span class="bash">aofinfo</span></span><br><span class="line">aof_current_size)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_size&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_base_size)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_base_size&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_pending_rewrite)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_rewrite&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_buffer_length)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_buffer_length&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_rewrite_buffer_length)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_buffer_length&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_pending_bio_fsync)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_bio_fsync&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">aof_delayed_fsync)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;aof_delayed_fsync&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line"><span class="meta">#</span><span class="bash">stats</span></span><br><span class="line">total_connections_received)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;total_connections_received&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">total_commands_processed)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;total_commands_processed&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">instantaneous_ops_per_sec)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;instantaneous_ops_per_sec&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">rejected_connections)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;rejected_connections&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">expired_keys)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;expired_keys&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">evicted_keys)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;evicted_keys&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">keyspace_hits)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_hits&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">keyspace_misses)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_misses&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">pubsub_channels)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">pubsub_channels)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">pubsub_patterns)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_patterns&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">latest_fork_usec)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;latest_fork_usec&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">connected_slaves)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;connected_slaves&quot; | awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">master_link_status)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;master_link_status&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;|/bin/grep -c up`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">master_last_io_seconds_ago)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;master_last_io_seconds_ago&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">master_sync_in_progress)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;master_sync_in_progress&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">slave_priority)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;slave_priority&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line"><span class="meta">#</span><span class="bash">cpu</span></span><br><span class="line">used_cpu_sys)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_cpu_user)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_cpu_sys_children)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys_children&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">used_cpu_user_children)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user_children&quot;|awk -F&#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line"> echo &quot;argu error&quot;</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line"><span class="meta">#</span><span class="bash">db0:key</span></span><br><span class="line">   elif [[ $# -eq 4 ]];then</span><br><span class="line">case $4 in</span><br><span class="line">keys)</span><br><span class="line">        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;keys&quot; | awk -F&#x27;=|,&#x27; &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">expires)</span><br><span class="line">        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;expires&quot; | awk -F&#x27;=|,&#x27; &#x27;&#123;print $4&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">avg_ttl)</span><br><span class="line">        result=`$REDIS_INFO|/bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;avg_ttl&quot; | awk -F&#x27;=|,&#x27; &#x27;&#123;print $6&#125;&#x27;`</span><br><span class="line">        echo $result</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">     echo &quot;argu error&quot; ;;</span><br><span class="line">esac</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line"><span class="meta">cat&gt;</span><span class="bash"><span class="variable">$&#123;ZabbixShell&#125;</span>/ip_port_discovery.sh&lt;&lt;<span class="string">&quot;EOF&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="variable">$1</span>æ˜¯è¦å‘ç°çš„è¿›ç¨‹éƒ¨åˆ†è¯æ±‡</span></span><br><span class="line">portarray=(`sudo ss -tnlp|egrep -i &quot;$1&quot;|awk &#123;&#x27;print $4&#x27;&#125;|awk -F&#x27;:&#x27; &#x27;&#123;if ($NF~/^[0-9]*$/) print $NF&#125;&#x27;|sort|uniq`)</span><br><span class="line">iparray=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`</span><br><span class="line">length=$&#123;#portarray[@]&#125;</span><br><span class="line">printf &quot;&#123;\n&quot;</span><br><span class="line">printf &#x27;\t&#x27;&quot;\&quot;data\&quot;:[&quot;</span><br><span class="line">for ((i=0;i&lt;$length;i++))</span><br><span class="line">  do</span><br><span class="line">     printf &#x27;\n\t\t&#123;&#x27;</span><br><span class="line">     printf &quot;\&quot;&#123;#IP&#125;\&quot;:\&quot;$&#123;iparray&#125;\&quot;,\&quot;&#123;#TCP_PORT&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;</span><br><span class="line">     if [ $i -lt $[$length-1] ];then</span><br><span class="line">                printf &#x27;,&#x27;</span><br><span class="line">     fi</span><br><span class="line">  done</span><br><span class="line">printf &quot;\n\t]\n&quot;</span><br><span class="line">printf &quot;&#125;\n&quot;</span><br><span class="line">EOF</span><br><span class="line">chmod a+x $&#123;ZabbixShell&#125;/redis_info.sh</span><br><span class="line">chmod a+x $&#123;ZabbixShell&#125;/ip_port_discovery.sh</span><br><span class="line">sed -i &#x27;2s#/export/redis#&#x27;&quot;$&#123;RedisBaseDir&#125;&quot;&#x27;#&#x27; $&#123;ZabbixShell&#125;/redis_info.sh</span><br><span class="line"></span><br><span class="line">echo &#x27;--------------------------------------------------æˆ‘æ˜¯ redis ä¿¡æ¯-----------------------------------------------------------&#x27;</span><br><span class="line">echo &#x27;redisç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š&#x27;</span><br><span class="line">echo &quot;</span><br><span class="line">æ ¹è·¯å¾„ï¼š$&#123;RedisBaseDir&#125;</span><br><span class="line">å¯åŠ¨è„šæœ¬ï¼š$&#123;RedisBaseDir&#125;/redis.sh</span><br><span class="line">&quot;</span><br><span class="line">echo &#x27;--------------------------------------------------æˆ‘æ˜¯ zabbix ç›‘æ§ä¿¡æ¯----------------------------------------------------------&#x27;</span><br><span class="line">echo &#x27;è¯·å…ˆå®‰è£… zabbix.&#x27;</span><br><span class="line">echo &#x27;zabbixç›‘æ§å› ä½¿ç”¨äº†sså‘½ä»¤ï¼Œæ•…è€Œéœ€è¦å¼€å¯sudoç›¸å…³ä¿¡æ¯&#x27;</span><br><span class="line">echo &quot;</span><br><span class="line"><span class="meta">#</span><span class="bash">zabbixç”¨æˆ·å¯ä»¥ä»¥sudoæ‰§è¡Œss</span></span><br><span class="line">zabbix ALL = NOPASSWD: /usr/sbin/ss</span><br><span class="line"><span class="meta">#</span><span class="bash">zabbixç”¨æˆ·ä½¿ç”¨sudoæ— éœ€tty</span></span><br><span class="line">Defaults:zabbix    !requiretty</span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">echo &#x27;---------------------------------------------------æˆ‘æ˜¯ monit ç›‘æ§ä¿¡æ¯----------------------------------------------------------&#x27;</span><br><span class="line">echo &#x27;è¯·å…ˆå®‰è£… monit.&#x27;</span><br><span class="line">echo &#x27;monité…ç½®æ–‡ä»¶å¦‚ä¸‹:&#x27;</span><br><span class="line">echo &quot;</span><br><span class="line">check process $&#123;RedisBaseName&#125; with pidfile $&#123;RedisBaseDir&#125;/redis.pid</span><br><span class="line">  start program = \&quot;$&#123;RedisBaseDir&#125;/redis.sh start\&quot;</span><br><span class="line">  stop program = \&quot;$&#123;RedisBaseDir&#125;/redis.sh stop\&quot;</span><br><span class="line">if changed pid then alert</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§â˜ä¼ä¸šå¾®ä¿¡æœºå™¨äºº</title>
      <link href="posts/8c33f887/"/>
      <url>posts/8c33f887/</url>
      
        <content type="html"><![CDATA[<h4 id="shell">shell</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wechatUrl=</span><br><span class="line">wechatData=</span><br><span class="line">curl <span class="variable">$&#123;wechatUrl&#125;</span> -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> -d <span class="string">&#x27;&#123;&quot;msgtype&quot;: &quot;markdown&quot;,&quot;markdown&quot;: &#123;&quot;content&quot;: &quot;`&#x27;</span><span class="string">&quot;<span class="variable">$wechatData</span>&quot;</span><span class="string">&#x27;`&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="python">python</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json, requests</span><br><span class="line">wechatData=&#123;<span class="string">&quot;msgtype&quot;</span>: <span class="string">&quot;text&quot;</span>,<span class="string">&quot;text&quot;</span>: &#123;<span class="string">&quot;content&quot;</span>: <span class="string">&quot;&quot;</span>&#125;&#125;</span><br><span class="line">wechatData[<span class="string">&#x27;text&#x27;</span>][<span class="string">&#x27;content&#x27;</span>]=<span class="string">&#x27;å¹¿å·ä»Šæ—¥å¤©æ°”ï¼š29åº¦ï¼Œå¤§éƒ¨åˆ†å¤šäº‘ï¼Œé™é›¨æ¦‚ç‡ï¼š60%&#x27;</span></span><br><span class="line">wechatData[<span class="string">&#x27;text&#x27;</span>][<span class="string">&#x27;mentioned_list&#x27;</span>]=[<span class="string">&quot;zyh&quot;</span>]  <span class="comment"># all ä»£è¡¨ç¾¤ç»„æ‰€æœ‰äºº</span></span><br><span class="line">wechatData=json.dumps(wechatData)</span><br><span class="line">wechatUrl=</span><br><span class="line">requests.post(url=wechatUrl, headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;, data=wechat</span><br><span class="line">Data, timeout=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ä¼ä¸šå¾®ä¿¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ å¾®ä¿¡é¢„è­¦</title>
      <link href="posts/f9b08c30/"/>
      <url>posts/f9b08c30/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># conf.ini</span></span><br><span class="line">[wechat]</span><br><span class="line">corpid = </span><br><span class="line"></span><br><span class="line">[app]</span><br><span class="line">it = &lt;app_agent_id&gt;:&lt;app_secret&gt;</span><br><span class="line"></span><br><span class="line">[group]</span><br><span class="line">it = usera|userb</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@author: zyh</span></span><br><span class="line"><span class="string">@contact: aaa103439@hotmail.com</span></span><br><span class="line"><span class="string">@software: vscode</span></span><br><span class="line"><span class="string">@file: sendchat.py</span></span><br><span class="line"><span class="string">@time: 2020/02/05</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys, os, requests, pathlib, json, configparser</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PySendchat</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, corpid, agentid, secret, touser, content</span>):</span></span><br><span class="line">        self.corpid=corpid</span><br><span class="line">        self.agentid=agentid</span><br><span class="line">        self.secret=secret</span><br><span class="line">        self.touser=touser</span><br><span class="line">        self.content=content</span><br><span class="line"></span><br><span class="line">        LOG_PATHDIR=os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">        LOG_FILENAME = <span class="string">&#x27;&#123;0&#125;/sendchat.log&#x27;</span>.format(LOG_PATHDIR)</span><br><span class="line">        self.my_logger = logging.getLogger(<span class="string">&#x27;SendChat&#x27;</span>)</span><br><span class="line">        self.my_logger.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add the log message handler to the logger</span></span><br><span class="line">        handler = logging.handlers.RotatingFileHandler(LOG_FILENAME, maxBytes=<span class="number">102400000</span>, backupCount=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create formatter and add it to the handlers</span></span><br><span class="line">        formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">        handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        self.my_logger.addHandler(handler)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gettoken</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.my_logger.info(<span class="string">&#x27;-----------------------------------------------------------------------------------------&#x27;</span>)</span><br><span class="line">        pwd=os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">        tokenfile=<span class="string">&#x27;&#123;0&#125;/wechat.&#123;1&#125;&#x27;</span>.format(pwd,self.agentid)</span><br><span class="line">        <span class="keyword">if</span> pathlib.Path(tokenfile).exists():</span><br><span class="line">            tokenfilectime=os.path.getctime(tokenfile)</span><br><span class="line">            currenttime=datetime.now().timestamp()</span><br><span class="line">            dtime=currenttime-tokenfilectime</span><br><span class="line">            self.my_logger.info(<span class="string">&#x27;&#123;0&#125; lived &#123;1&#125;s.&#x27;</span>.format(tokenfile, dtime))</span><br><span class="line">            <span class="keyword">if</span> dtime &gt;= <span class="number">7200</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    os.remove(tokenfile)</span><br><span class="line">                    self.my_logger.info(<span class="string">&#x27;Token file &#123;0&#125;: delete success&#x27;</span>.format(tokenfile))</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    self.my_logger.error(<span class="string">&#x27;Token file:&#123;0&#125; delete error.Reason:&#123;1&#125;&#x27;</span>.format(tokenfile,e))</span><br><span class="line">                    exit</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check token file</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            tokensize = os.path.getsize(tokenfile)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.my_logger.info(<span class="string">&#x27;Token file is not exist.Reason:&#123;0&#125;&#x27;</span>.format(e))</span><br><span class="line">            tokensize = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># get token from token file</span></span><br><span class="line">        <span class="keyword">if</span> tokensize != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">with</span> open(tokenfile, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fd:</span><br><span class="line">                token = fd.read() <span class="comment"># get token success</span></span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;Get token from token file.&#x27;</span>)</span><br><span class="line">            jsonObject = json.loads(token.decode(encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">            access_token = jsonObject.get(<span class="string">&quot;access_token&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> access_token</span><br><span class="line">        <span class="comment"># get token from weixin api</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;New Token Create.&#x27;</span>)</span><br><span class="line">                f = requests.get(<span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#123;0&#125;&amp;corpsecret=&#123;1&#125;&#x27;</span>.format(self.corpid, self.secret))</span><br><span class="line">                token = f.content</span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;Get token from weixin api.&#x27;</span>)</span><br><span class="line">                jsonObject = json.loads(token.decode(encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">                errcode=int(jsonObject.get(<span class="string">&quot;errcode&quot;</span>))</span><br><span class="line">                <span class="keyword">if</span> errcode != <span class="number">0</span>:</span><br><span class="line">                    errmsg=jsonObject.get(<span class="string">&quot;errmsg&quot;</span>)</span><br><span class="line">                    self.my_logger.error(<span class="string">&#x27;Get token error!Reason:&#123;0&#125;&#x27;</span>.format(errmsg))</span><br><span class="line">                    exit()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.my_logger.error(<span class="string">&#x27;Get token error!Reason:&#123;0&#125;&#x27;</span>.format(e))</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.my_logger.info(<span class="string">&#x27;Write token to &#123;0&#125;.&#x27;</span>.format(tokenfile))</span><br><span class="line">                <span class="keyword">with</span> open(tokenfile, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fd:</span><br><span class="line">                    fd.write(token)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.my_logger.error(<span class="string">&#x27;Write &#123;0&#125; error!Reason:&#123;1&#125;&#x27;</span>.format(tokenfile,e))</span><br><span class="line">                exit()</span><br><span class="line">            access_token = jsonObject.get(<span class="string">&quot;access_token&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> access_token</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sendmsg</span>(<span class="params">self</span>):</span></span><br><span class="line">        accessToken = self.gettoken()</span><br><span class="line">        self.my_logger.info(<span class="string">&#x27;Token:&#123;0&#125;&#x27;</span>.format(accessToken))</span><br><span class="line">        sendMapDirectroy = &#123;&#125;</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;agentid&quot;</span>] = self.agentid</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;touser&quot;</span>] = self.touser</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;msgtype&quot;</span>] = <span class="string">&quot;text&quot;</span></span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;safe&quot;</span>] = <span class="string">&quot;0&quot;</span></span><br><span class="line">        contentDirectory = &#123;&#125;</span><br><span class="line">        sendMapDirectroy[<span class="string">&quot;text&quot;</span>] = contentDirectory</span><br><span class="line">        contentDirectory[<span class="string">&quot;content&quot;</span>] = self.content</span><br><span class="line">        bodyStr = json.dumps(sendMapDirectroy, ensure_ascii=<span class="literal">False</span>).encode(encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            f = requests.post(url=<span class="string">&quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot;</span> % accessToken,</span><br><span class="line">                          data=bodyStr, timeout=<span class="number">5</span>)</span><br><span class="line">            self.my_logger.info(f.content)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.my_logger.error(<span class="string">&#x27;Send chat network error!Reason:&#123;0&#125;&#x27;</span>.format(e))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    appname = sys.argv[<span class="number">1</span>]</span><br><span class="line">    content = sys.argv[<span class="number">3</span>]</span><br><span class="line">    <span class="comment"># read conf.ini</span></span><br><span class="line">    conf = configparser.ConfigParser()</span><br><span class="line">    conf_path = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">    conf_ini = <span class="string">&quot;&#123;0&#125;/conf.ini&quot;</span>.format(conf_path)</span><br><span class="line">    <span class="keyword">if</span> pathlib.Path(conf_ini).exists():</span><br><span class="line">        conf.read(conf_ini)</span><br><span class="line">        corpid = conf.get(<span class="string">&quot;wechat&quot;</span>, <span class="string">&quot;corpid&quot;</span>)</span><br><span class="line">        appinfo = conf.get(<span class="string">&quot;app&quot;</span>, appname)</span><br><span class="line">        agentid = appinfo.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        secret = appinfo.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        groupname = conf.get(<span class="string">&quot;group&quot;</span>, appname)</span><br><span class="line">        touser = groupname.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        chatobj = PySendchat(corpid, agentid, secret, touser, content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;conf.ini error&#x27;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        chatobj.sendmsg()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        chatobj.my_logger.error(<span class="string">&quot;Send chat failure!&quot;</span>)</span><br></pre></td></tr></table></figure><p>eg:</p><p>python <a href="http://sendchat.py">sendchat.py</a> it â€˜â€™ &lt;é¢„è­¦å†…å®¹&gt;</p><blockquote><p>åˆ›å»ºå¥½appï¼Œå¹¶å…³è”ç”¨æˆ·åˆ°app</p><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œä¼šå°†é¢„è­¦å†…å®¹é€šè¿‡&lt;app_agent_id&gt; åº”ç”¨å‘é€ç»™ç”¨æˆ·useraå’Œuserb</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ä¼ä¸šå¾®ä¿¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿— â˜ logrotate</title>
      <link href="posts/421d605e/"/>
      <url>posts/421d605e/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>logrotate å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ—¥å¿—åˆ‡å‰²ï¼Œæ­é… cron æœåŠ¡ï¼Œå°±å¯ä»¥è‡ªåŠ¨çš„è¿›è¡Œè½®è½¬</p><h4 id="logrotate-ç‰ˆæœ¬æ›´æ–°">logrotate ç‰ˆæœ¬æ›´æ–°</h4><blockquote><p>ç¡®ä¿ logrotate æ”¯æŒå°æ—¶çº§åˆ«çš„ç®¡ç†ï¼Œæ›¿æ¢/usr/sbin/logrotate,å¹¶é™„åŠ xæƒé™ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶ç‰ˆæœ¬ <a href="logrotate">logrotate</a></p><p>æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥å» github ä¸Šæ‹‰å–https://github.com/logrotate/logrotate</p></blockquote><h4 id="æ·»åŠ -logrotate-é…ç½®">æ·»åŠ  logrotate é…ç½®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ æ‰€éœ€åˆ‡å‰²çš„æ—¥å¿—é…ç½®</span></span><br><span class="line">cat &gt; /etc/logrotate.d/nginx &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/logs/access.log &#123;  <span class="comment"># å®šä¹‰æ—¥å¿—ä½ç½®</span></span><br><span class="line"> hourly    <span class="comment"># æŒ‰ç…§å°æ—¶åˆ‡å‰²</span></span><br><span class="line"> rotate 2  <span class="comment"># æœ€å¤šä¿ç•™ä¸¤ä»½åˆ‡å‰²æ—¥å¿—</span></span><br><span class="line"> missingok</span><br><span class="line"> nocompress</span><br><span class="line"> sharedscripts</span><br><span class="line"> postrotate</span><br><span class="line">  /bin/<span class="built_in">kill</span> -USR1 `cat /usr/<span class="built_in">local</span>/nginx/logs/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line"> endscript</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ -crontab-é…ç½®">æ·»åŠ  crontab é…ç½®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ logrotateæ‰§è¡Œè„šæœ¬</span></span><br><span class="line">cp /etc/cron.daily/logrotate /etc/cron.hourly/</span><br></pre></td></tr></table></figure><h4 id="é‡è½½-crond-æœåŠ¡">é‡è½½ crond æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl reload crond</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logrotate </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ è¿œç¨‹ç£ç›˜æ£€æµ‹</title>
      <link href="posts/1fac36d/"/>
      <url>posts/1fac36d/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash </span></span><br><span class="line"><span class="comment"># æ–‡ä»¶åï¼šdisklog.sh </span></span><br><span class="line"><span class="comment"># ç”¨é€”ï¼šç›‘è§†è¿œç¨‹ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ </span></span><br><span class="line">BaseDir=`<span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>&quot;</span>; <span class="built_in">pwd</span>`</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$BaseDir</span></span><br><span class="line">logfile=<span class="string">&quot;disk.log&quot;</span> </span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="variable">$1</span> ]];<span class="keyword">then</span> </span><br><span class="line">    logfile=<span class="variable">$1</span> </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">shellexecuser=`whoami`</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$shellexecuser</span> == root ]];<span class="keyword">then</span></span><br><span class="line">    rm -rf /root/.ssh/known_hosts</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    rm -rf /home/<span class="variable">$shellexecuser</span>/.ssh/known_hosts</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s %-14s %-9s %-8s %-6s %-6s %-6s %s\r\n&quot;</span> <span class="string">&quot;Date&quot;</span> <span class="string">&quot;IP ADDRESS&quot;</span> <span class="string">&quot;Device&quot;</span> <span class="string">&quot;Capacity&quot;</span> <span class="string">&quot;Used&quot;</span> <span class="string">&quot;Free&quot;</span> <span class="string">&quot;Percent&quot;</span> <span class="string">&quot;Status&quot;</span> &gt; <span class="variable">$logfile</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">##################### æ‰‹åŠ¨å¡«å†™åŒº</span></span><br><span class="line"><span class="comment"># æä¾›è¿œç¨‹ä¸»æœºIPåœ°å€åˆ—è¡¨ 1.1.1.1 2.2.2.2 3.3.3.3</span></span><br><span class="line">IP_LIST=</span><br><span class="line"><span class="comment"># ç›‘æ§é˜ˆå€¼(ç™¾åˆ†æ¯”) åªå¡«å†™æ•°å­— 1 åˆ° 100</span></span><br><span class="line">DiskPct=</span><br><span class="line"><span class="comment"># æ‰§è¡Œç”¨æˆ·</span></span><br><span class="line">UserName=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œç”¨æˆ·æ‰€éœ€ç§é’¥, æ­¤æ–‡ä»¶éœ€è¦ä¸è„šæœ¬åŒçº§ç›®å½•</span></span><br><span class="line">PemName=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># ä¼ä¸šå¾®ä¿¡botæœºå™¨äººåœ°å€</span></span><br><span class="line">wx_api=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment">##################### æ‰‹åŠ¨å¡«å†™åŒº</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable">$IP_LIST</span>;<span class="keyword">do</span> </span><br><span class="line">    ssh -i <span class="variable">$PemName</span> -o StrictHostKeyChecking=no <span class="variable">$&#123;UserName&#125;</span>@<span class="variable">$ip</span> <span class="string">&#x27;df -H&#x27;</span> | grep ^/dev/ &gt; /tmp/$$.df </span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line;<span class="keyword">do</span> </span><br><span class="line">        cur_date=`date  <span class="string">&quot;+%F_%R&quot;</span>`</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;%-8s %-14s &quot;</span> <span class="variable">$cur_date</span> <span class="variable">$ip</span> </span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">&#x27;&#123; printf(&quot;%-9s %-8s %-6s %-6s %-8s&quot;, $1,$2,$3,$4,$5); &#125;&#x27;</span> </span><br><span class="line"></span><br><span class="line">        pusg=$(<span class="built_in">echo</span> <span class="variable">$line</span> | egrep -o <span class="string">&quot;[0-9]+%&quot;</span>) </span><br><span class="line">        pusg=<span class="variable">$&#123;pusg/\%/&#125;</span>; </span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$pusg</span> -lt <span class="variable">$DiskPct</span> ];<span class="keyword">then</span> </span><br><span class="line">            <span class="built_in">echo</span> OK</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="built_in">echo</span> ALERT </span><br><span class="line">        <span class="keyword">fi</span> </span><br><span class="line">    <span class="keyword">done</span> &lt; /tmp/$$.df </span><br><span class="line">    rm -rf /tmp/$$.df</span><br><span class="line"><span class="keyword">done</span> &gt;&gt; <span class="variable">$&#123;logfile&#125;</span></span><br><span class="line">sed -n <span class="string">&#x27;1p&#x27;</span> <span class="variable">$&#123;logfile&#125;</span> &gt; alert.log</span><br><span class="line">awk <span class="string">&#x27;$NF == &quot;ALERT&quot;&#123;print $0&#125;&#x27;</span> <span class="variable">$&#123;logfile&#125;</span> &gt;&gt; alert.log</span><br><span class="line"><span class="comment">#sed -i &#x27;1i &quot;ç£ç›˜é˜ˆå€¼ï¼š&#x27;&quot;$DiskPct&quot;&#x27;&quot;&#x27; alert.log</span></span><br><span class="line">content=`cat alert.log`</span><br><span class="line">grep -q <span class="string">&#x27;ALERT&#x27;</span> alert.log &amp;&amp; &#123;</span><br><span class="line">curl <span class="string">&quot;<span class="variable">$wx_api</span>&quot;</span>  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span>  \</span><br><span class="line">-d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">   &#123;</span></span><br><span class="line"><span class="string">        &quot;msgtype&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;text&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;content&quot;: &quot;&#x27;</span><span class="string">&quot;<span class="variable">$content</span>&quot;</span><span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">   &#125;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ç£ç›˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ é‚®ä»¶é¢„è­¦</title>
      <link href="posts/f8f9b4d0/"/>
      <url>posts/f8f9b4d0/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># $1 æ”¶ä»¶äºº</span></span><br><span class="line"><span class="comment"># $2 ä¸»é¢˜</span></span><br><span class="line"><span class="comment"># $3 å†…å®¹</span></span><br><span class="line">smtpServer=  <span class="comment"># smtp æœåŠ¡å™¨åœ°å€ï¼Œä¾‹å¦‚ smtp.gmail.com:xxx</span></span><br><span class="line">sendUserEmail=<span class="string">&#x27;it@abc.com&#x27;</span></span><br><span class="line">sendUserPassword=  <span class="comment"># ä¸€èˆ¬å‘ä»¶äººé‚®ç®±å¯†ç éƒ½æ˜¯ä¸“ç”¨å¯†ç ï¼Œå¹¶éwebå¯†ç </span></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/sendEmail -f <span class="variable">$&#123;sendUserEmail&#125;</span> -t <span class="variable">$1</span> -u <span class="string">&quot;<span class="variable">$2</span>&quot;</span> -m <span class="string">&quot;<span class="variable">$3</span>&quot;</span> -s <span class="variable">$&#123;smtpServer&#125;</span> -xu <span class="variable">$&#123;sendUserEmail&#125;</span> -xp <span class="variable">$&#123;sendUserPassword&#125;</span> -o message-charset=utf-8</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="comment">#coding:utf-8 </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> smtplib </span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText </span><br><span class="line"><span class="keyword">import</span> sys </span><br><span class="line"> </span><br><span class="line">mail_host = <span class="string">&#x27;&#x27;</span> <span class="comment"># smtp æœåŠ¡å™¨åœ°å€ï¼Œä¾‹å¦‚ smtp.gmail.com:xxx</span></span><br><span class="line">mail_user = <span class="string">&#x27;it@abc.com&#x27;</span></span><br><span class="line">mail_pass = <span class="string">&#x27;&#x27;</span> <span class="comment"># ä¸€èˆ¬å‘ä»¶äººé‚®ç®±å¯†ç éƒ½æ˜¯ä¸“ç”¨å¯†ç ï¼Œå¹¶éwebå¯†ç </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span>(<span class="params">to_list,subject,content</span>):</span> </span><br><span class="line">    me = mail_user+<span class="string">&quot;&lt;&quot;</span>+mail_user+<span class="string">&quot;&gt;&quot;</span> </span><br><span class="line">    msg = MIMEText(content) </span><br><span class="line">    msg[<span class="string">&#x27;Subject&#x27;</span>] = subject </span><br><span class="line">    msg[<span class="string">&#x27;From&#x27;</span>] = me </span><br><span class="line">    msg[<span class="string">&#x27;to&#x27;</span>] = to_list </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;start sendmail&quot;</span></span><br><span class="line">        s = smtplib.SMTP(mail_host)</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;connect mail server suesscc&quot;</span> </span><br><span class="line">s.starttls()</span><br><span class="line">        s.login(mail_user,mail_pass) </span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;login mail server suesscc&quot;</span></span><br><span class="line">        s.sendmail(me,to_list,msg.as_string()) </span><br><span class="line">        s.close() </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span> </span><br><span class="line">    <span class="keyword">except</span> Exception,e: </span><br><span class="line">        <span class="keyword">print</span> str(e) </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span> </span><br><span class="line">     </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>: </span><br><span class="line">    send_mail(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], sys.argv[<span class="number">3</span>])</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> é‚®ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-è¿‡æ»¤å™¨</title>
      <link href="posts/f43dca37/"/>
      <url>posts/f43dca37/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä¸ç®¡æ˜¯è¿‡æ»¤å™¨ï¼Œlookupï¼Œqueryï¼Œwith_xxxï¼Œå¾ˆå¤šéƒ½æ˜¯è·å–æˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ã€‚</p><h4 id="è¿‡æ»¤å™¨">è¿‡æ»¤å™¨</h4><blockquote><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</a></p></blockquote><blockquote><p>å¤„ç†å˜é‡å€¼ï¼Œä»è€Œè·å–æƒ³è¦çš„ä¿¡æ¯.</p><p>è¿‡æ»¤å™¨æœ¬èº«æ˜¯ jinja2 æˆ–è€… ansible å®˜æ–¹å®šä¹‰çš„</p></blockquote><h4 id="ç®€ä¾‹">ç®€ä¾‹</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">vara:</span> <span class="string">abcde</span></span><br><span class="line">    <span class="attr">varb:</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">A</span>,<span class="string">b</span>,<span class="string">C</span>,<span class="string">d</span>]</span><br><span class="line">    <span class="attr">varc:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">vard:</span> [ <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],<span class="number">4</span>,<span class="number">5</span> ]</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">upper</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; vara | upper&#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>ç®€ä¾‹ä¸­çš„ upper å³æ˜¯è¿‡æ»¤å™¨ï¼Œå®ƒå¯ä»¥å°† vara ä¸­çš„æ‰€æœ‰å­—æ¯å…ƒç´ å¤§å†™ï¼Œæœ€ç»ˆè¾“å‡º ABCDE</p></blockquote><h4 id="å¸¸ç”¨çš„è¿‡æ»¤å™¨">å¸¸ç”¨çš„è¿‡æ»¤å™¨</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å°†å­—ç¬¦ä¸²å¼€å¤´å’Œç»“å°¾çš„ç©ºæ ¼å»é™¤</span></span><br><span class="line"><span class="string">msg:</span>Â <span class="string">&quot;<span class="template-variable">&#123;&#123;Â varaÂ |Â trimÂ &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment">#è¿”å›å­—ç¬¦ä¸²æˆ–åˆ—è¡¨é•¿åº¦,lengthä¸countç­‰æ•ˆ,å¯ä»¥å†™ä¸ºcount</span></span><br><span class="line"><span class="string">msg:</span>Â <span class="string">&quot;<span class="template-variable">&#123;&#123;Â varbÂ |Â lengthÂ &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># ç»å¯¹å€¼</span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varc | abs &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># æ’åº(é™åºæ’åº)</span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb | sort(reverse=true) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># å°†åˆ—è¡¨ä¸­ç¬¬ä¸€å±‚åµŒå¥—åˆ—è¡¨å…ƒç´ å±•å¼€å¹¶å…¥åˆ—è¡¨ä¸­,å¹¶å–å‡ºæ–°åˆ—è¡¨ä¸­çš„æœ€å¤§å…ƒç´ </span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; vard | flatten(levels=1) | max &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># éšæœºè¿”å›ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb | random &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># å»é‡</span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; vard | unique &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># å¹¶é›†</span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb | union(vard) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># äº¤é›†</span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb | intersect(vard) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># è¡¥é›†ï¼Œå–å‡ºå­˜åœ¨äº varbï¼Œä½†ä¸å­˜åœ¨äº vard ä¸­çš„å…ƒç´ </span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb | difference(vard) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># å»é™¤ä¸¤ä¸ªåˆ—è¡¨äº¤é›†åçš„å…ƒç´ </span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb | symmetric_difference(vard) &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># å˜é‡æœªå®šä¹‰ï¼Œè¿”å›é»˜è®¤å€¼ new</span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; vare | default(&#x27;new&#x27;)&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># å˜é‡æœªå®šä¹‰æˆ–è€…å®šä¹‰ä½†ä¸ºç©ºï¼Œè¿”å›é»˜è®¤å€¼ new</span></span><br><span class="line"><span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; vare | default(&#x27;new&#x27;, boolean=true)&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># å˜é‡æœªå®šä¹‰æ—¶ï¼Œå¿½ç•¥æŸä¸ªå‚æ•°</span></span><br><span class="line"><span class="attr">file:</span> <span class="string">xxxx</span>  <span class="string">mode=&#123;&#123;</span> <span class="string">vare</span> <span class="string">|</span> <span class="string">default(omit)&#125;&#125;&quot;</span>  <span class="comment"># è‹¥ vare ä¸å­˜åœ¨ï¼Œåˆ™å¿½ç•¥modeå‚æ•°</span></span><br></pre></td></tr></table></figure><h4 id="json-query">json_query</h4><blockquote><p>è·å–ç‰¹å®šæ•°æ®</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. æŸ¥è¯¢å­—ç¬¦ä¸²å¯ç”¨å˜é‡ä»£æ›¿ï¼Œå¢åŠ å¯è¯»æ€§</span><br><span class="line"> loop: &quot;&#123;&#123; domain_definition | json_query(server_name_cluster1_query) &#125;&#125;&quot;</span><br><span class="line"> vars:</span><br><span class="line">    server_name_cluster1_query: &quot;domain.server[?cluster&#x3D;&#x3D;&#39;cluster1&#39;].port&quot;</span><br></pre></td></tr></table></figure><ol start="2"><li>æŸ¥è¯¢æ¡ä»¶</li></ol><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zhangsan</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lisi</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | json_query(&#x27;[?name==`zhangsan`].gender&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;male&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="map">map</h4><blockquote><p>æ˜ å°„</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zhangsan</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lisi</span></span><br><span class="line">      <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users|map(attribute=&#x27;name&#x27;) | list &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users | json_query(&#x27;[*].name&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># test 2 æ˜¯é‡‡ç”¨ json_query æ–¹å¼ï¼Œtest1å’Œtest2ç»“æœä¸€æ ·</span></span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;zhangsan&quot;</span>, </span><br><span class="line">        <span class="string">&quot;lisi&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-æ–‡æœ¬æ–‡ä»¶æ“ä½œ</title>
      <link href="posts/4235ddf4/"/>
      <url>posts/4235ddf4/</url>
      
        <content type="html"><![CDATA[<h4 id="var-å®šä¹‰">var å®šä¹‰</h4><blockquote><p>é€šè¿‡å˜é‡ï¼Œä¿®æ”¹playbook</p><p>å¯ç›´æ¥å†™å…¥ playbookï¼Œ ä¹Ÿå¯ä»¥å†™å…¥æ–‡ä»¶ï¼Œç„¶å playbook é€šè¿‡ vars_files å¼•ç”¨</p><p>å…³é”®è¯:</p><ul><li>vars</li><li>vars_files # ä¸€æ¬¡æ€§åŠ è½½æ–‡ä»¶å†…éƒ¨æ•°æ®ï¼Œä¸æ”¯æŒæ–‡ä»¶åŠ¨æ€ä¿®æ”¹æˆ–æ·»åŠ æ–°å˜é‡</li></ul></blockquote><h4 id="ç®€ä¾‹">ç®€ä¾‹</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">vars_files:</span> <span class="string">~/vars.yml</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">father:</span> <span class="string">Zhang</span> <span class="string">San</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">vars</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; father &#125;&#125;</span> - <span class="template-variable">&#123;&#123; children.son_name &#125;&#125;</span> success&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">~/son.log</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">children:</span></span><br><span class="line">  <span class="attr">son_name:</span> <span class="string">Zhang</span> <span class="string">Xiaosan</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># son.log å†…å®¹</span></span><br><span class="line">Zhang San - Zhang Xiaosan success</span><br></pre></td></tr></table></figure><h4 id="var-æ³¨å†Œ">var æ³¨å†Œ</h4><blockquote><p>å½“æˆ‘ä»¬æƒ³å°†æŸä¸ªä»»åŠ¡çš„ç»“æœå†™å…¥ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨registeræ¥è¿›è¡Œæ³¨å†Œ</p><p>å…³é”®è¯:</p><ul><li>register</li><li>debug<ul><li>var è¾“å‡ºå˜é‡å€¼</li><li>msg è¾“å‡ºå­—ç¬¦ä¸²</li></ul></li></ul></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">register</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;register success&quot;</span> <span class="string">&gt;</span> <span class="string">~/register.log</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">resultInfo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">register</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;Oh my god&quot;</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">resultInfo</span></span><br></pre></td></tr></table></figure><h4 id="var-äº¤äº’">var äº¤äº’</h4><blockquote><p>æä¾›ä¸€ä¸ªç”¨æˆ·è¾“å…¥ä¿¡æ¯çš„æœºä¼šï¼Œå’Œ shell é‡Œé¢çš„ read -p ä¸€è‡´ã€‚</p><p>å…³é”®è¯ï¼š</p><ul><li>vars_prompt</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: localhost</span><br><span class="line">  remote_user: zyh</span><br><span class="line">  vars_prompt:</span><br><span class="line">    - name: <span class="string">&quot;fatherName&quot;</span></span><br><span class="line">      prompt: <span class="string">&quot;What&#x27;s your father name&quot;</span></span><br><span class="line">      default: ZhangSan</span><br><span class="line">      private: no</span><br><span class="line">  tasks:</span><br><span class="line">    - name: show father name</span><br><span class="line">      shell: <span class="built_in">echo</span> <span class="string">&quot;&#123;&#123; fatherName &#125;&#125;&quot;</span> &gt; ~/prompt.log</span><br></pre></td></tr></table></figure><blockquote><p>private yes=éšè—è¾“å…¥å†…å®¹ no=æ˜¾ç¤ºè¾“å…¥å†…å®¹</p><p>default é»˜è®¤å€¼</p><p>encrypt â€œsha512_cryptâ€ å°†å˜é‡å€¼åŠ å¯†ï¼Œä¸€èˆ¬ç”¨äºä¼ é€’å¯†ç ï¼Œæ¯”å¦‚ä¼ é€’ç»™ user æ¨¡å—çš„ password å‚æ•°</p></blockquote><h4 id="var-å‘½ä»¤è¡Œä¼ å…¥">var å‘½ä»¤è¡Œä¼ å…¥</h4><blockquote><p>ä¸€èˆ¬ç”¨äºä¸´æ—¶å¼ºåˆ¶è¦†ç›–playbookä¸­å®šä¹‰å¥½çš„å˜é‡</p><p>å…³é”®è¯ï¼š</p><ul><li>-e æˆ–è€… --extra-vars<ul><li>å‚æ•°åé¢ï¼Œå¯ä»¥è·Ÿéšå¤šä¸ªå˜é‡kvå¯¹ï¼Œæ¯ä¸€ä¸ªkvå¯¹ç”¨ç©ºæ ¼éš”å¼€</li><li>å‚æ•°åé¢ï¼Œ@filePath å¯ä»¥ä¼ å…¥å˜é‡æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­çš„å˜é‡å‡å¯ä»¥è¢«å¼•ç”¨</li></ul></li></ul></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-play test.play -e <span class="string">&quot;fatherName=Laowang&quot;</span></span><br></pre></td></tr></table></figure><h4 id="var-ä½œç”¨åŸŸ">var ä½œç”¨åŸŸ</h4><table><thead><tr><th>åˆ›å»ºæ–¹å¼</th><th>è°ƒç”¨ä½ç½®</th><th>ä½œç”¨åŸŸ</th></tr></thead><tbody><tr><td>vars</td><td>playå’Œtasks</td><td>å½“å‰playæˆ–è€…å½“å‰tasksï¼Œæ— æ³•è·¨ä¸»æœº</td></tr><tr><td>set_fact</td><td>tasks</td><td>è·¨playï¼Œé»˜è®¤æ— æ³•è·¨ä¸»æœº</td></tr><tr><td>register</td><td>tasks</td><td>è·¨playï¼Œé»˜è®¤æ— æ³•è·¨ä¸»æœº</td></tr></tbody></table><p>è‹¥è¦ä½¿å¾— set_fact å’Œ register è·¨ä¸»æœºä½¿ç”¨ï¼Œåˆ™éœ€è¦å¼•å…¥å†…ç½®å˜é‡ <code>hostvars</code> ä¾‹å¦‚ hostvars.&lt;ä¸»æœºå&gt;.&lt;å˜é‡å&gt;</p><blockquote><p>å…¶å®ƒå†…ç½®å˜é‡ï¼š</p><ul><li><p>ansible_version # ç‰ˆæœ¬</p></li><li><p>hostvars # å­˜å‚¨playä¸­çš„æ‰€æœ‰ä¸»æœºå˜é‡</p></li><li><p>play_hosts # å­˜å‚¨playä¸­çš„æ‰€æœ‰ä¸»æœºå</p></li><li><p>inventory_hostname  # å­˜å‚¨å½“å‰ä¸»æœºå</p></li><li><p>inventory_hostname_short  # å­˜å‚¨å½“å‰ä¸»æœºåç®€ç§°ï¼ˆå…¶å®å°±æ˜¯è·å–ä¸»æœºåç¬¬ä¸€çº§ï¼Œä¾‹å¦‚001.localhostï¼Œé‚£ä¹ˆè·å–çš„å°±æ˜¯001ï¼‰</p></li><li><p>groups # å­˜å‚¨æ‰€æœ‰åˆ†ç»„ä¿¡æ¯ï¼ŒåŒ…æ‹¬allå’Œungrouped</p></li><li><p>group_names # å­˜å‚¨å½“å‰playä¸­ä¸»æœºçš„æ‰€å±ç»„å</p></li><li><p>inventory_dir # å­˜å‚¨ä¸»æœºæ¸…å•æ–‡ä»¶æ‰€åœ¨è·¯å¾„</p></li></ul></blockquote><h4 id="var-åŠ¨æ€è·å–æ–°å˜é‡">var åŠ¨æ€è·å–æ–°å˜é‡</h4><blockquote><p>å…³é”®è¯ï¼šinclude_vars</p><p>ç”¨äºä»»åŠ¡é‡è½½å˜é‡æ–‡ä»¶ï¼Œä»è€Œè·å–ä»»åŠ¡æœŸé—´å˜é‡æ–‡ä»¶ä¿®æ”¹çš„æ•°æ®</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars_files:</span> <span class="string">~/test.yaml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">varb</span> <span class="bullet">-</span> <span class="string">max</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb |  max &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lineinfile</span></span><br><span class="line">      <span class="attr">lineinfile:</span></span><br><span class="line">        <span class="attr">regexp:</span> <span class="string">^varb</span></span><br><span class="line">        <span class="attr">line:</span> <span class="string">&quot;varb: [1,2,3,4]&quot;</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">~/test.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_vars:</span> <span class="string">~/test.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">varb</span> <span class="bullet">-</span> <span class="string">max</span> <span class="string">again</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; varb |  max &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### test.yaml å˜é‡æ–‡ä»¶åˆå§‹å†…å®¹:</span></span><br><span class="line"></span><br><span class="line">vara: 123                                                                 </span><br><span class="line">varb: [1,2,3]  </span><br><span class="line"></span><br><span class="line"><span class="comment">#### æœ€ç»ˆç»“æœï¼š</span></span><br><span class="line"></span><br><span class="line">ç¬¬ä¸€æ¬¡ get varb ä»»åŠ¡è¾“å‡º 3, ç¬¬äºŒæ¬¡ get varb ä»»åŠ¡è¾“å‡º 4</span><br></pre></td></tr></table></figure><blockquote><p>include_vars æ¨¡å—å¸¸ç”¨å‚æ•°ï¼š</p><ul><li><p>file è¯»å–æŸä¸ªå˜é‡æ–‡ä»¶</p></li><li><p>dir è¯»å–æŸä¸ªç›®å½•çš„æ‰€æœ‰å˜é‡æ–‡ä»¶</p></li><li><p>depth é€’å½’å±‚æ·±ï¼Œä»…åœ¨ dir å¯ç”¨çš„æ—¶å€™æœ‰æ„ä¹‰</p></li><li><p>files_matching æ­£åˆ™åŒ¹é…æ–‡ä»¶åï¼Œä»…åœ¨ dir å¯ç”¨çš„æ—¶å€™æœ‰æ„ä¹‰</p></li><li><p>ignore_files å¿½ç•¥æŸä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„å…ƒç´ å¯ä»¥ä¸ºæ­£åˆ™è¡¨è¾¾å¼</p></li><li><p>name: å˜é‡ x  å°†è¯»å–çš„æ–‡ä»¶å†…å®¹é›†ä¸­å¤åˆ¶ç»™å˜é‡ xï¼Œä¾‹å¦‚ä¸Šä¾‹ä¸­å˜é‡ x ä¸º {vara: 123, varb: [1,2,3,4]}</p></li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜è¾“å‡ºä¸ªæ€§åŒ–å¼€æœºçŠ¶æ€</title>
      <link href="posts/3988a5f2/"/>
      <url>posts/3988a5f2/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰æ²¿">å‰æ²¿</h4><p>è§‰å¾—é»˜è®¤çš„ç™»é™†ä¸å¤Ÿç»™åŠ›ï¼Œæ— æ³•å¿½æ‚ æœºå™¨ï¼Œç”¨wowerçš„è¯æ¥è¯´ï¼Œå°±æ˜¯å…ˆç¥–å¿½æ‚ ç€ä½ </p><h4 id="æ•ˆæœå›¾åœ¨æ­¤">æ•ˆæœå›¾åœ¨æ­¤</h4><p><img src="/posts/3988a5f2/image-20200515110044304.png" alt="image-20200515110044304"></p><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><blockquote><p>å°†è„šæœ¬æ”¾ç½®åˆ° /etc/profile.d/status.sh</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Author: zyh</span></span><br><span class="line"><span class="comment"># éœ€å…ˆå®‰è£… toilet å’Œ cowsay å‘½ä»¤</span></span><br><span class="line"><span class="comment"># yum install epel-release -y</span></span><br><span class="line"><span class="comment"># yum install https://rpmfind.net/linux/openmandriva/4.1/repository/x86_64/unsupported/release/toilet-0.2-3-omv4000.x86_64.rpm cowsay -y</span></span><br><span class="line"></span><br><span class="line">user=<span class="variable">$USER</span></span><br><span class="line">home=<span class="variable">$HOME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## blue to echo</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">blue</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[34m[Info] <span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## green to echo</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">green</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[32m[Success] <span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Error</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">red</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[31m\033[01m[Error] <span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># warning</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">yellow</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[33m\033[01m[Warn] <span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Error to warning with blink</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">bred</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[31m\033[01m\033[05m[Error] <span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Error to warning with blink</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">byellow</span></span>()&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;\033[33m\033[01m\033[05m[Warn] <span class="variable">$1</span>\033[0m&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">publicip=`curl -s http://169.254.169.254/latest/meta-data/public-ipv4`</span><br><span class="line">localip=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$publicip</span> <span class="variable">$localip</span>&quot;</span> | cowsay -f tux | toilet -f term  --gay</span><br><span class="line"></span><br><span class="line"><span class="comment"># * Check if we&#x27;re somewhere in /home</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$&#123;home&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># * Calculate last login</span></span><br><span class="line">lastlog=`lastlog -u <span class="variable">$&#123;user&#125;</span> | grep <span class="variable">$&#123;user&#125;</span> | awk <span class="string">&#x27;&#123;for(i=3;i&lt;=NF;++i) printf(&quot;%s &quot;,$i)&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># * Print Output</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; ::::::::::::::::::::::::::::::::::-STATUS-::::::::::::::::::::::::::::::::::&quot;</span></span><br><span class="line"><span class="comment">#  * Check RAM Usages</span></span><br><span class="line">free_mem_usages=$(awk <span class="string">&#x27;/MemTotal/&#123;total=$2&#125;/MemAvailable/&#123;free=$2&#125;END&#123;print free/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;&#x27;</span> /proc/meminfo)</span><br><span class="line">app_mem_usages=$(awk <span class="string">&#x27;/MemTotal/&#123;total=$2&#125;/MemFree/&#123;free=$2&#125;/Buffers/&#123;buffers=$2&#125;/^Cached/&#123;cached=$2&#125;END&#123;print (total-free-buffers-cached)/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;&#x27;</span>  /proc/meminfo)</span><br><span class="line">all_mem_usages=$(awk <span class="string">&#x27;/MemTotal/&#123;total=$2&#125;/MemFree/&#123;free=$2&#125;END&#123;print (total-free)/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;&#x27;</span>  /proc/meminfo)</span><br><span class="line">blue <span class="string">&quot; Free Memory : <span class="variable">$&#123;free_mem_usages&#125;</span>&quot;</span></span><br><span class="line">blue <span class="string">&quot; Application Memory Usages : <span class="variable">$&#123;app_mem_usages&#125;</span>&quot;</span></span><br><span class="line">blue <span class="string">&quot; System Memory Usages : <span class="variable">$&#123;all_mem_usages&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># * Check Disk Usages</span></span><br><span class="line">diskusages=$(df -PH | awk <span class="string">&#x27;&#123;printf &quot;%-40s%-15s%-15s%-15s%-15s%-15s\n&quot;, $1,$2,$3,$4,$5,$6&#125;&#x27;</span>)</span><br><span class="line">blue <span class="string">&quot; Disk Usages :&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;diskusages&#125;</span>&quot;</span> | toilet -f term --metal -w 200</span><br><span class="line"><span class="comment"># * Check Load Average</span></span><br><span class="line">loadaverage=$(top -n 1 -b | grep <span class="string">&quot;load average:&quot;</span> | awk <span class="string">&#x27;&#123;print $(NF-2) $(NF-1) $NF&#125;&#x27;</span>)</span><br><span class="line">blue <span class="string">&quot; Load Average: <span class="variable">$loadaverage</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é—®é¢˜è®°å½•</title>
      <link href="posts/1ddb9d4e/"/>
      <url>posts/1ddb9d4e/</url>
      
        <content type="html"><![CDATA[<h3 id="Q-åŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶å‡ºç°">Q:åŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶å‡ºç°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">insserv:  loop involving service xxx at depth 2</span><br></pre></td></tr></table></figure><h4 id="A-åˆ é™¤-xxx-æœåŠ¡ï¼Œå¦‚æœ-xxx-æœåŠ¡å·²åˆ é™¤ï¼Œæ¸…ç†-xxx-æœåŠ¡çš„å¯åŠ¨è„šæœ¬-etc-init-d-xxx">A:åˆ é™¤ xxx æœåŠ¡ï¼Œå¦‚æœ xxx æœåŠ¡å·²åˆ é™¤ï¼Œæ¸…ç† xxx æœåŠ¡çš„å¯åŠ¨è„šæœ¬ /etc/init.d/xxx</h4><hr><h3 id="Q-crontab-å¦‚ä½•ä¿®æ”¹æ—¶åŒº">Q:crontab å¦‚ä½•ä¿®æ”¹æ—¶åŒº</h3><h4 id="A-åœ¨crontabæ–‡ä»¶æœ€ä¸Šæ–¹æ·»åŠ å‘½ä»¤ï¼Œä¾‹å¦‚èŠåŠ å“¥æ—¶åŒº">A:åœ¨crontabæ–‡ä»¶æœ€ä¸Šæ–¹æ·»åŠ å‘½ä»¤ï¼Œä¾‹å¦‚èŠåŠ å“¥æ—¶åŒº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TZ=<span class="string">&#x27;America/Chicago&#x27;</span>                                          </span><br><span class="line">CRON_TZ=<span class="string">&#x27;America/Chicago&#x27;</span>  `</span><br></pre></td></tr></table></figure><hr><h3 id="Q-su-user-c-â€œcommandâ€-å‘½ä»¤å‡ºé”™">Q:su - user -c â€œcommandâ€ å‘½ä»¤å‡ºé”™</h3><h4 id="A-éœ€è¦ç”¨æˆ·å¼€å¯ç™»é™†æƒé™ï¼Œå³-etc-passwd-ä¸­ä¸èƒ½ä½¿-sbin-nologin">A:éœ€è¦ç”¨æˆ·å¼€å¯ç™»é™†æƒé™ï¼Œå³ /etc/passwd ä¸­ä¸èƒ½ä½¿ /sbin/nologin</h4><hr><h3 id="Q-zabbix-è‡ªåŠ¨å‘ç°å¼‚å¸¸ï¼Œè¡¨é¢çœ‹ä¸å‡ºé—®é¢˜">Q:zabbix è‡ªåŠ¨å‘ç°å¼‚å¸¸ï¼Œè¡¨é¢çœ‹ä¸å‡ºé—®é¢˜</h3><h4 id="A-zabbix-agent-ç«¯å¼€å¯-debug-æ¨¡å¼ï¼Œé…ç½®åŠ å…¥å‚æ•°-DebugLevel-4">A:zabbix-agent ç«¯å¼€å¯ debug æ¨¡å¼ï¼Œé…ç½®åŠ å…¥å‚æ•° DebugLevel=4</h4><hr><h3 id="Q-adminer-æ— æ•ˆçš„CSRFä»¤ç‰Œ-Invalid-CSRF-token">Q:adminer: æ— æ•ˆçš„CSRFä»¤ç‰Œ(Invalid CSRF token)</h3><h4 id="A-nginx-worker-user-ç”¨æˆ·æ— æ³•è®¿é—®-php-session-ç›®å½•">A:nginx worker user ç”¨æˆ·æ— æ³•è®¿é—® php session ç›®å½•.</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chgrp <span class="variable">$&#123;nginxWorkerUser&#125;</span> <span class="variable">$&#123;phpSessionDir&#125;</span></span><br><span class="line"><span class="comment"># å¦‚æœæ˜¯yumæˆ–è€…aptå®‰è£…,é‚£ä¹ˆphpçš„sessionä¸€èˆ¬æ˜¯ /var/lib/php/session</span></span><br></pre></td></tr></table></figure><hr><h3 id="Q-python3-No-module-named-â€˜PILâ€™">Q:python3 : No module named â€˜PILâ€™</h3><h4 id="A-pip3-install-pillow">A:pip3 install pillow</h4><hr><h3 id="Q-python-workon-å‘½ä»¤æ‰¾ä¸åˆ°">Q:python: workon å‘½ä»¤æ‰¾ä¸åˆ°</h3><h4 id="A">A:</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install virtualenvwrapper</span><br><span class="line">echo &#39;export PATH&#x3D;~&#x2F;.local&#x2F;bin:$PATH&#39; &gt;&gt; ~&#x2F;.bashrc # æ ¹æ®æ‰€ç”¨shellæ¥å†³å®šæ–‡ä»¶è·¯å¾„</span><br></pre></td></tr></table></figure><hr><h3 id="Q-jiraé…ç½®163çš„smtpè¿æ¥è¶…æ—¶-ä½†æ˜¯æœåŠ¡å™¨ç»ˆç«¯telnetæ­£å¸¸">Q:jiraé…ç½®163çš„smtpè¿æ¥è¶…æ—¶,ä½†æ˜¯æœåŠ¡å™¨ç»ˆç«¯telnetæ­£å¸¸</h3><h4 id="A-2">A:</h4><p><img src="/posts/1ddb9d4e/image-20200917111208620.png" alt="image-20200917111208620"></p>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> é—®é¢˜è®°å½• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-tags</title>
      <link href="posts/960fc783/"/>
      <url>posts/960fc783/</url>
      
        <content type="html"><![CDATA[<h4 id="tagsçš„å®šä¹‰">tagsçš„å®šä¹‰</h4><blockquote><p>tags å¯ä»¥è®©ä½ åœ¨æ‰§è¡Œplaybookçš„æ—¶å€™ï¼Œæœ‰é€‰æ‹©åœ°æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œå› æ­¤ tags æ˜¯ tasks ä¸‹çš„å…³é”®è¯</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook test.play &lt;--tags-args&gt;</span><br></pre></td></tr></table></figure><h4 id="tagsçš„å‚æ•°">tagsçš„å‚æ•°</h4><blockquote><ul><li>â€“tags=tag_name  æ‰§è¡Œå…·æœ‰ tag_name ä»»åŠ¡</li><li>â€“skip-tags=tag_name å¿½ç•¥å…·æœ‰ tag_name ä»»åŠ¡</li><li>â€“list-tags è¾“å‡ºæ‰€æœ‰</li></ul></blockquote><blockquote><p>tag_name å†…ç½®å€¼ ï¼š</p><ul><li>tagged æœ‰tagçš„taskï¼Œè¡¨ç¤ºæ‰§è¡Œå…·æœ‰æ ‡è®°çš„ä»»åŠ¡</li><li>untagged æ²¡æœ‰tagçš„taskï¼Œè¡¨ç¤ºæ‰§è¡Œä¸å…·æœ‰æ ‡è®°çš„ä»»åŠ¡</li><li>all æ‰€æœ‰taskï¼Œè¡¨ç¤ºæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡</li></ul></blockquote><h4 id="tagsçš„å†…ç½®æ ‡è®°">tagsçš„å†…ç½®æ ‡è®°</h4><blockquote><ul><li>always æ€»æ˜¯æ‰§è¡ŒæŸä¸ª task</li><li>never æ°¸è¿œä¸æ‰§è¡ŒæŸä¸ª task</li></ul></blockquote><h4 id="tags-çš„ä½ç½®">tags çš„ä½ç½®</h4><blockquote><p>ä½äºplayæˆ–è€…taskséƒ½å¯ä»¥ï¼Œæœ¬èº«å…·æœ‰ç»§æ‰¿å±æ€§ï¼Œä¹Ÿå°±æ˜¯tasksé‡Œçš„tagsä¼šç»§æ‰¿playçš„tags</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">father</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">tag</span> <span class="string">son</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">son,children</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;son is here!&quot;</span> <span class="string">&gt;</span> <span class="string">~/son.log</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">tag</span> <span class="string">daughter</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">daughter,children</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;daughter is here!&quot;</span> <span class="string">&gt;</span> <span class="string">~/daughter.log</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook test.play --tags=son <span class="comment"># åªä¼šç”Ÿæˆ son.log</span></span><br><span class="line">ansible-playbook test.play --tags=father  <span class="comment"># å› ç»§æ‰¿æœºåˆ¶ï¼Œä¼šç”Ÿæˆ son.log å’Œ daughter.log</span></span><br><span class="line">ansible-playbook test.play --tags=children <span class="comment"># å› éƒ½å«æœ‰ï¼ŒåŒæ ·ä¼šç”Ÿæˆ son.log å’Œ daughter.log</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-é”™è¯¯æ•è·</title>
      <link href="posts/c4126d5a/"/>
      <url>posts/c4126d5a/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ç±»ä¼¼äº python ä¸­çš„ tryâ€¦exceptâ€¦finallyï¼Œansible å¯ä»¥ç”¨ blockâ€¦rescueâ€¦always</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">mkdir</span> <span class="string">/file</span></span><br><span class="line">      <span class="attr">rescue:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">&quot;No operation permission&quot;</span></span><br><span class="line">      <span class="attr">always:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">&quot;Task End!&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>åˆ›å»º file ç›®å½•å¤±è´¥ï¼Œåˆ™è¾“å‡º&quot;No operation permission&quot;, æœ€ç»ˆæ€»æ˜¯è¾“å‡ºâ€œTask End!â€</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-æ¡ä»¶åˆ¤æ–­</title>
      <link href="posts/29683589/"/>
      <url>posts/29683589/</url>
      
        <content type="html"><![CDATA[<h4 id="å…³é”®è¯">å…³é”®è¯</h4><ul><li>when</li></ul><h4 id="è¿ç®—ç¬¦">è¿ç®—ç¬¦</h4><ul><li>==  !=  &gt;  &lt;  &gt;=  &lt;=</li><li>and or not</li><li>( ) ç»„åˆï¼Œä¾‹å¦‚ ( a and b ) or c</li></ul><blockquote><p>ansible æŸä¸ª task æŠ¥é”™ï¼Œä¼šå¯¼è‡´ä»»åŠ¡ç»ˆæ­¢ï¼Œè€Œignore_errors: true å¯ä»¥å¿½ç•¥æŸä¸ªä»»åŠ¡çš„æ¡ä»¶ä¸æ»¡è¶³</p></blockquote><h4 id="is-è¯­å¥-æˆ–è€…-is-not-è¯­å¥">is è¯­å¥ æˆ–è€… is not è¯­å¥</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">is</span> <span class="string">xxx</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">&quot;xxx is ok&quot;</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">var</span> <span class="string">is</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure><blockquote><p>åˆ¤æ–­æ–‡ä»¶</p><ul><li>xxx æ˜¯ exists ï¼Œè¡¨ç¤ºè‹¥ var å­˜åœ¨ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ file, è¡¨ç¤ºè‹¥ var æ˜¯æ–‡ä»¶ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ directoryï¼Œ è¡¨ç¤ºè‹¥ var æ˜¯ç›®å½•ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ linkï¼Œè¡¨ç¤ºè‹¥ var æ˜¯è½¯è¿æ¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ mountï¼Œè¡¨ç¤ºè‹¥ var æ˜¯æŒ‚è½½ç‚¹ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­å˜é‡</p><ul><li>è‹¥ xxx æ˜¯ defined, è¡¨ç¤ºè‹¥ var å·²å®šä¹‰ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ undefinedï¼Œ è¡¨ç¤ºè‹¥ var æœªå®šä¹‰ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ noneï¼Œ è¡¨ç¤ºè‹¥ var æ˜¯ç©ºï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­ä»»åŠ¡çŠ¶æ€</p><ul><li>è‹¥ xxx æ˜¯ successï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€æˆåŠŸï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ failureï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ changeï¼Œè‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€æ”¹å˜ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ skipï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡è¢«å¿½ç•¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­å­—ç¬¦ä¸²</p><ul><li><p>è‹¥ xxx æ˜¯ stringï¼Œè‹¥ var æ˜¯å­—ç¬¦ä¸²ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ lowerï¼Œè‹¥ var æ˜¯çº¯å°å†™ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ upperï¼Œè‹¥ var æ˜¯çº¯å¤§å†™ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li></ul></blockquote><blockquote><p>åˆ¤æ–­æ•°å­—</p><ul><li><p>è‹¥ xxx æ˜¯ numberï¼Œ è‹¥ var æ˜¯æ•°å­—ï¼Œæ¡ä»¶ä¸ºçœŸã€‚ var: â€œ123â€ ,è¿™é‡Œ var æ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°å­—</p></li><li><p>è‹¥ xxx æ˜¯ evenï¼Œè‹¥ var æ˜¯å¶æ•°ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ oddï¼Œ è‹¥ var æ˜¯å¥‡æ•°ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ divisibleby(num), è‹¥ var å¯ä»¥è¢« num æ•´é™¤ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li></ul></blockquote><blockquote><p>åˆ¤æ–­é›†åˆ</p><ul><li>è‹¥ xxx æ˜¯ subset(list)ï¼Œè‹¥ var æ˜¯ list çš„å­é›†ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ superset(list), è‹¥ var æ˜¯ list çš„çˆ¶é›†ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-å¾ªç¯</title>
      <link href="posts/14bc184e/"/>
      <url>posts/14bc184e/</url>
      
        <content type="html"><![CDATA[<h4 id="å¸¸è§çš„å¾ªç¯">å¸¸è§çš„å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">debug</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">a</span>,<span class="string">b</span> ]</span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">A</span>,<span class="string">B</span>, [ <span class="string">D</span>,<span class="string">E</span>,<span class="string">F</span> ]]</span><br></pre></td></tr></table></figure><blockquote><ul><li><p>with_list è¾“å‡ºæœ€è¡¨å±‚å…ƒç´ ï¼Œåœ¨ç®€ä¾‹ä¸­ï¼Œä¼šè¾“å‡º [ a,b ] å’Œ [ A,B, [ D,E,F ] ]</p></li><li><p>with_item é€’å½’è¾“å‡ºæ‰€æœ‰å±‚å…ƒç´ </p></li><li><p>with_together åˆå¹¶ä¸¤ä¸ªåˆ—è¡¨ï¼Œå…ƒç´ æŒ‰ç…§å¯¹åº”ä¸‹æ ‡ç»“åˆï¼Œå¦‚æœæŸä¸€æ–¹åˆ—è¡¨å…ƒç´ ç¼ºå¤±ï¼Œåˆ™ç”¨nullä»£æ›¿</p></li><li><p>with_indexed_items æœ€è¡¨å±‚æ‰€æœ‰åˆ—è¡¨åˆå¹¶ä¸ºä¸€ä¸ªæ–°åˆ—è¡¨å¹¶å¾ªç¯ã€‚itemç”±{ list.index: list.value } æ„æˆã€‚åœ¨ç®€ä¾‹ä¸­ï¼Œæ–°åˆ—è¡¨æ˜¯[ a,b,A,B, [ D,E,F ]]</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">msg:</span> <span class="string">&quot;Index:<span class="template-variable">&#123;&#123; item.0 &#125;&#125;</span>, Value:<span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ok: [localhost] =&gt; (item=[0, u<span class="string">&#x27;a&#x27;</span>]) =&gt; &#123;</span><br><span class="line">     <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Index:0, Vaule:a&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> ok: [localhost] =&gt; (item=[1, u<span class="string">&#x27;b&#x27;</span>]) =&gt; &#123;</span><br><span class="line">     <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Index:1, Vaule:b&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> ok: [localhost] =&gt; (item=[2, u<span class="string">&#x27;A&#x27;</span>]) =&gt; &#123;</span><br><span class="line">     <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Index:2, Vaule:A&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> ok: [localhost] =&gt; (item=[3, u<span class="string">&#x27;B&#x27;</span>]) =&gt; &#123;</span><br><span class="line">     <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Index:3, Vaule:B&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line"> ok: [localhost] =&gt; (item=[4, [u<span class="string">&#x27;D&#x27;</span>, u<span class="string">&#x27;E&#x27;</span>, u<span class="string">&#x27;F&#x27;</span>]]) =&gt; &#123;</span><br><span class="line">     <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Index:4, Vaule:[u&#x27;D&#x27;, u&#x27;E&#x27;, u&#x27;F&#x27;]&quot;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>with_random_choice éšæœºè¾“å‡ºä¸€ä¸ªæœ€è¡¨å±‚åˆ—è¡¨å…ƒç´ ï¼Œç®€ä¾‹ä¸­è¾“å‡º [a,b] æˆ–è€… [ A,B, [ D,E,F ]]</p></li></ul></blockquote><h4 id="dict-å­—å…¸å¾ªç¯">dict å­—å…¸å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">debug</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;Name:<span class="template-variable">&#123;&#123; item.key &#125;&#125;</span>, gender:<span class="template-variable">&#123;&#123; item.value &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">with_dict:</span></span><br><span class="line">        <span class="attr">Zhangsan:</span> <span class="string">male</span></span><br><span class="line">        <span class="attr">Lisi:</span> <span class="string">female</span></span><br></pre></td></tr></table></figure><blockquote><p>è¾“å‡ºæ‰€æœ‰å­—å…¸</p></blockquote><h4 id="sequence-åºåˆ—å¾ªç¯">sequence åºåˆ—å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">sequence</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">with_sequence:</span></span><br><span class="line">        <span class="string">start=1</span></span><br><span class="line">        <span class="string">end=5</span></span><br><span class="line">        <span class="string">stride=2</span></span><br><span class="line">        <span class="string">format=&quot;I&#x27;m</span> <span class="string">%0.4f&quot;</span></span><br></pre></td></tr></table></figure><blockquote><ul><li>with_sequence è·å–å¥‡å¶æ•°ï¼Œstartå’Œendæ˜¯èµ·æ­¢ç‚¹ï¼Œstride æ˜¯æ­¥é•¿ï¼ˆæ­¥é•¿å¯ä»¥ä¸ºè´Ÿå€¼ï¼‰ï¼Œformatæ˜¯æ ¼å¼åŒ–</li></ul></blockquote><h4 id="nested-åµŒå¥—å¾ªç¯">nested åµŒå¥—å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">nested</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;mkdir /mnt/<span class="template-variable">&#123;&#123; item.0 &#125;&#125;</span>/<span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">with_nested:</span></span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">a</span>,<span class="string">b</span> ]</span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">A</span>,<span class="string">B</span>,<span class="string">C</span> ]</span><br></pre></td></tr></table></figure><blockquote><p>ä¸¤ä¸ªåˆ—è¡¨åšç¬›å¡å°”ç§¯, ä¾‹å¦‚æ„å»ºç¯å¢ƒç›®å½•</p></blockquote><h4 id="subelements-å­å…ƒç´ å¾ªç¯">subelements å­å…ƒç´ å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">          <span class="attr">users:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Bob</span></span><br><span class="line">                    <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">                    <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">                    <span class="attr">content:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">eating</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">sleeping</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">play</span> <span class="string">ogre</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Maris</span></span><br><span class="line">                    <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">                    <span class="attr">age:</span> <span class="number">20</span></span><br><span class="line">                    <span class="attr">content:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">eating</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">sleeping</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">shopping</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">vars</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">debug:</span></span><br><span class="line">                    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.0.name &#125;&#125;</span> - <span class="template-variable">&#123;&#123; item.0.gender &#125;&#125;</span> - <span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>&quot;</span></span><br><span class="line">            <span class="attr">with_subelements:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users &#125;&#125;</span>&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">content</span></span><br></pre></td></tr></table></figure><blockquote><p>åˆ†è§£ , é€‰ä¸­åˆ—è¡¨å†…æŸä¸€ä¸ªåˆ—è¡¨å…ƒç´  content, ä¸ä½œä¸ºä¸€ä¸ªä¸´æ—¶æ•´ä½“çš„å‰©ä½™å…ƒç´ æ„å»ºç¬›å¡å°”ç§¯ï¼Œå½¢æˆ item</p></blockquote><h4 id="file-æ–‡ä»¶å¾ªç¯">file æ–‡ä»¶å¾ªç¯</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">with_file:</span></span><br><span class="line">  <span class="string">/mnt/a.ini</span></span><br><span class="line">  <span class="string">/mnt/b.ini</span></span><br></pre></td></tr></table></figure><blockquote><p>å§‹ç»ˆå¾ªç¯è·å–ansibleä¸»æœºé‡Œæ–‡ä»¶çš„å†…å®¹ã€‚ï¼ˆä¸ç›®æ ‡ä¸»æœºæ— å…³ï¼‰</p></blockquote><h4 id="fileglob-å¯»æ‰¾é€šé…ç¬¦åŒ¹é…çš„æ–‡ä»¶">fileglob å¯»æ‰¾é€šé…ç¬¦åŒ¹é…çš„æ–‡ä»¶</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">with_fileglob:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/home/zyh/test/dirA/*</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/home/zyh/test/dirB/[0-9].ini</span></span><br></pre></td></tr></table></figure><blockquote><p>å§‹ç»ˆå¾ªç¯è·å–ansibleä¸»æœºæŒ‡å®šç›®å½•ä¸­åŒ¹é…çš„æ–‡ä»¶åå’Œè·¯å¾„ã€‚ï¼ˆä¸ç›®æ ‡ä¸»æœºæ— å…³ï¼‰</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-ç³»ç»Ÿç›¸å…³</title>
      <link href="posts/84eb900/"/>
      <url>posts/84eb900/</url>
      
        <content type="html"><![CDATA[<h4 id="cron">cron</h4><blockquote><p>crontab è®¡åˆ’ä»»åŠ¡</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>name è®¡åˆ’ä»»åŠ¡æ³¨é‡Šï¼Œå¤šæ¬¡æ“ä½œåŒåä»»åŠ¡ï¼Œåªä¼šä¿®æ”¹ï¼Œè€Œä¸ä¼šæ–°åŠ </p><p>æ—¶é—´å‚æ•°ï¼š</p><ul><li><p>minute hour day month weekday</p></li><li><p>special_time : @reboot @yearly @monthly @weekly @daily @hourly (æ¯xxxæ‰§è¡Œ)</p></li></ul><p>user æ·»åŠ åˆ°æŒ‡å®šç”¨æˆ·è®¡åˆ’ä»»åŠ¡ä¸­</p><p>job è®¡åˆ’ä»»åŠ¡æ‰§è¡Œå‘½ä»¤</p><p>state å½“å€¼ä¸ºabsentæ—¶ï¼ŒæŒ‡åˆ é™¤ä»»åŠ¡. åªéœ€æŒ‡å®š name.</p><p>disabled æ³¨é‡Šä»»åŠ¡ï¼Œè‹¥ä»»åŠ¡ä¿¡æ¯å’Œä¹‹å‰ä¸ä¸€è‡´ï¼Œä¼šåŒæ—¶ä¿®æ”¹ä»»åŠ¡</p><p>backup å…ˆå¤‡ä»½å†æ“ä½œ, å¤‡ä»½æ–‡ä»¶ä½äº /tmp/crontabxxxx</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible localhost -m cron -a <span class="string">&quot;name=&#x27;test cron module&#x27; user=zyh special_time=hourly job=&#x27;ls /home/zyh &gt; /home/zyh/cron.log 2&gt;&amp;1&#x27;&quot;</span></span><br><span class="line">ansible localhost -m cron -a <span class="string">&quot;name=&#x27;test cron module&#x27; state=absent&quot;</span></span><br></pre></td></tr></table></figure><h4 id="service">service</h4><blockquote><p>è°ƒç”¨è¿œç¨‹ç³»ç»Ÿè‡ªèº«çš„æœåŠ¡ç®¡ç†æ¨¡å—ï¼Œä¾‹å¦‚ centos6 çš„ service ï¼Œæˆ–è€… centos7 çš„ systemctl</p><p>å‚æ•°ä»‹ç»:</p><p>name æœåŠ¡å</p><p>state æ‰§è¡ŒåŠ¨ä½œ started, stopped, restarted, reloaded</p><p>enabled å¼€æœºè‡ªå¯åŠ¨</p></blockquote><h4 id="user">user</h4><blockquote><p>ç”¨æˆ·ç®¡ç†</p><p>å¸¸ç”¨å‚æ•°ä»‹ç»ï¼š</p><p>name ç”¨æˆ·å</p><p>group ç”¨æˆ·ç»„ groups ç”¨æˆ·é™„åŠ ç»„</p><ul><li>append é¢å¤–é™„åŠ ç”¨æˆ·é™„åŠ ç»„</li></ul><p>shell æŒ‡å®šé»˜è®¤shellï¼Œæ¯”å¦‚/usr/sbin/nologin</p><p>state å€¼ä¸º absent è¡¨ç¤ºåˆ é™¤ç”¨æˆ·ï¼Œå€¼ä¸º present è¡¨ç¤ºç”¨æˆ·å¿…é¡»å­˜åœ¨</p><ul><li>remove åˆ é™¤ç”¨æˆ·æ—¶ï¼ŒåŒæ—¶åˆ é™¤ç”¨æˆ·å®¶ç›®å½•</li></ul><p>password ç”¨æˆ·å¯†ç ã€‚ï¼ˆéœ€è¦ä¼ é€’åŠ å¯†å¯†ç ï¼Œä¸èƒ½æ˜¯æ˜æ–‡å¯†ç ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> crypt:</span><br><span class="line">passwd=</span><br><span class="line">print(crypt.crypt(passwd))</span><br></pre></td></tr></table></figure><p>generate_ssh_key ç›¸å½“äºè¿œç¨‹æ‰§è¡Œ ssh-keygen å‘½ä»¤ï¼ˆä¸åŠ ä»»ä½•å‚æ•°ï¼Œä¸€è·¯å›è½¦ï¼‰ã€‚è‹¥å·²ç»å­˜åœ¨~/.ssh/{id_rsa, id_rsa.pub}, åˆ™ä¸æ‰§è¡Œ</p><ul><li>ssh_key_file è‡ªå®šä¹‰ç§é’¥åå’Œç§é’¥å­˜æ”¾è·¯å¾„, å…¬é’¥ä¹Ÿä¼šåœ¨è‡ªå®šä¹‰è·¯å¾„ä¸‹ç”Ÿæˆ</li></ul></blockquote><h4 id="group">group</h4><blockquote><p>ç®¡ç†ç”¨æˆ·ç»„</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>name ç»„å</p><p>state ç»„çŠ¶æ€, å€¼ä¸º absent æŒ‡åˆ é™¤(ç»„æœ¬èº«å¹¶éç”¨æˆ·ä¸»è¦ç»„)</p></blockquote><h4 id="setup">setup</h4><blockquote><p>è·å–æœºå™¨ä¿¡æ¯</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>gather_subset è·å–æŸä¸ªå­é›†ï¼ˆall, min, hardware, network, virtual, ohai, facterï¼‰</p><p>filter è·å–æŸä¸ªé›†åˆçš„æŸä¸ªkey</p><p>fact_path è‡ªå®šä¹‰ä¿¡æ¯å­˜æ”¾ç›®å½•</p></blockquote><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># setup é»˜è®¤ä¼šæœç´¢ç›®æ ‡ä¸»æœº/etc/ansible/facts.d ä¸‹çš„è‡ªå®šä¹‰ä¿¡æ¯,ä¾‹å¦‚ family.ini</span></span><br><span class="line"><span class="section">[family]</span></span><br><span class="line"><span class="attr">father</span>=Zhangsan</span><br><span class="line"><span class="attr">son</span>=Zhangxiaosan</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-handle</title>
      <link href="posts/b0929188/"/>
      <url>posts/b0929188/</url>
      
        <content type="html"><![CDATA[<h4 id="åŠŸèƒ½">åŠŸèƒ½</h4><p>ç”¨ä¸€ä¸ªçŸ­è·¯åˆ¤æ–­æ¥è¯´ï¼Œå°±æ˜¯ä¸¤è€…æ˜¯ä¸²è”å…³ç³»ï¼Œhandlers ç”¨æ¥å¤„ç†ä»»åŠ¡åç»­</p><p>tasks &amp;&amp; handlers</p><p>tasks &amp;&amp; handlers - listen ï¼ˆhandlers ç»„ï¼‰</p><h4 id="handlers-çš„-playbook-æ ·æœ¬">handlers çš„ playbook æ ·æœ¬</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-t</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">      <span class="string">log</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">meta:</span> <span class="string">flush_handlers</span> </span><br><span class="line">  </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;nginx check success&quot;</span> <span class="string">&gt;</span> <span class="string">~/playbook.log</span></span><br></pre></td></tr></table></figure><blockquote><p>å¤šä¸ªtasksçš„æ—¶å€™ï¼Œtasksåé¢çš„ <code>meta: flush_handlers</code> å¯ä»¥è®©tasksæ‰§è¡Œå®Œï¼Œç«‹é©¬æ‰§è¡Œå…³è”çš„handlersã€‚å¦åˆ™handlersä¼šåœ¨æ‰€æœ‰tasksæ‰§è¡Œå®Œåï¼Œæ‰å¼€å§‹æ‰§è¡Œ</p></blockquote><h4 id="handlers-listen-çš„-playbook-æ ·æœ¬">handlers-listen çš„ playbook æ ·æœ¬</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/usr/sbin/nginx</span> <span class="string">-t</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">      <span class="string">log</span> <span class="string">group</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log1</span></span><br><span class="line">    <span class="attr">listen:</span> <span class="string">log</span> <span class="string">group</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;nginx check success 1&quot;</span> <span class="string">&gt;</span> <span class="string">~/playbook.log</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log2</span></span><br><span class="line">    <span class="attr">listen:</span> <span class="string">log</span> <span class="string">group</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&quot;nginx check success 2&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">~/playbook.log</span></span><br></pre></td></tr></table></figure><blockquote><p>handlers é€šè¿‡ listen ç»‘å®šåœ¨ä¸€èµ·ï¼Œ tasks å…³è” liasten ç»‘å®š handlers ç»„ï¼Œæœ€ç»ˆ playbook.log å°†ä¼šå†™å…¥ä¸¤è¡Œä¿¡æ¯</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> handle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜å¤‡ä»½</title>
      <link href="posts/2c2d50a0/"/>
      <url>posts/2c2d50a0/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æœ¬æ–‡ä¸»è¦è®°å½• redis çš„ä¸¤ç§æ•°æ®ç£ç›˜å›ºåŒ–æ–¹å¼ã€‚<br>æ¶‰åŠåˆ°ç›¸å…³å‚æ•°ï¼Œç®€å•çš„å‘½ä»¤æ“ä½œç­‰ã€‚</p><h4 id="rdb">rdb</h4><blockquote><p>é€šè¿‡forkä¸€ä¸ªå­è¿›ç¨‹æ¥å­˜å‚¨æŸä¸€æ—¶åˆ»redisæ•°æ®(bgsaveæ–¹å¼)ã€‚rdbæŒä¹…åŒ–æ˜¯é»˜è®¤æ–¹å¼ã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><p>å°å¹…åº¦ä¸¢å¤±æ•°æ®(å–å†³äºsaveæˆ–è€…bgsaveå‘½ä»¤çš„æ‰§è¡Œå‘¨æœŸ)ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è¯´saveï¼Œåº”è¯¥ä¸ä¼šç”¨åˆ°è¿™ä¸ª</p></li><li><p>æ¢å¤é€Ÿåº¦å¿«</p></li></ul></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‹ç¼©rdbæ–‡ä»¶</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="comment"># rdb æ–‡ä»¶åç§°</span></span><br><span class="line">dbfilename redis-6379.rdb</span><br><span class="line"><span class="comment"># rdbæ–‡ä»¶ä¿å­˜ç›®å½•</span></span><br><span class="line">dir /redis/data/</span><br></pre></td></tr></table></figure><ul><li>æ•°æ®è‡ªåŠ¨å†™å…¥ç­–ç•¥ (æ»¡è¶³ä¸‹åˆ—è§„åˆ™ï¼Œå°±æ‰§è¡Œbgsave)</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 900så†…è‡³å°‘è¾¾åˆ°ä¸€æ¡å†™å‘½ä»¤</span></span><br><span class="line">save 900 1</span><br><span class="line"><span class="comment"># 300så†…è‡³å°‘è¾¾è‡³10æ¡å†™å‘½ä»¤</span></span><br><span class="line">save 300 10</span><br><span class="line"><span class="comment"># 60så†…è‡³å°‘è¾¾åˆ°10000æ¡å†™å‘½ä»¤</span></span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure><ul><li>æ•°æ®äººå·¥å†™å…¥ç­–ç•¥ (æ¯10åˆ†é’Ÿè®¡åˆ’ä»»åŠ¡è°ƒç”¨ä¸€æ¬¡bgsave)</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*/10 * * * * root /<span class="built_in">export</span>/redis/bin/redis-cli -h 127.0.0.1 bgsave &gt;&gt; /<span class="built_in">export</span>/redis/bgsave.log 2&gt;&amp;1  </span><br></pre></td></tr></table></figure><blockquote><p>bgsave å› éœ€è¦forkå­è¿›ç¨‹ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–é¢„ç•™ç©ºé—²çš„ç‰©ç†å†…å­˜ï¼Œåœ¨overcommit_memory=1å¼€å¯çš„æƒ…å†µä¸‹ï¼Œé¢„ç•™å†…å­˜å¤§å° &gt; å‘¨æœŸå˜åŒ–æ•°æ®å¤§å°</p></blockquote><h4 id="aof">aof</h4><blockquote><p>è®°å½•çš„æ˜¯redisæ¯ä¸€æ¬¡çš„å†™å…¥æ“ä½œè®°å½•</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>æ¢å¤é€Ÿåº¦æ…¢</li><li>ä¸¢å¤±æ•°æ®å°</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¼€å¯aofæœºåˆ¶</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="comment"># aofæ–‡ä»¶å</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"><span class="comment"># å†™å…¥ç­–ç•¥,alwaysè¡¨ç¤ºæ¯ä¸ªå†™æ“ä½œéƒ½ä¿å­˜åˆ°aofæ–‡ä»¶ä¸­,ä¹Ÿå¯ä»¥æ˜¯everysecæˆ–noã€‚ everysec æ¯ç§’ä¸€æ¬¡</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># é»˜è®¤ä¸é‡å†™aofæ–‡ä»¶,æ„æ€å°±æ˜¯æ¯æ¬¡ appendfsync å°±å‹ç¼©æ•´åˆaofæ–‡ä»¶ï¼Œé¿å…aofè¿‡å¤§ï¼Œä¸æ¨èå¼€å¯ï¼Œå½±å“æ€§èƒ½</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"><span class="comment"># ä¿å­˜ç›®å½•</span></span><br><span class="line">dir /redis/data/</span><br></pre></td></tr></table></figure><ul><li>äººå·¥è®¡åˆ’ä»»åŠ¡é‡å†™</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*/10 * * * * root /<span class="built_in">export</span>/redis/bin/redis-cli -h 127.0.0.1 bgrewriteaof &gt;&gt; /<span class="built_in">export</span>/redis/bgrewriteaof.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure><ul><li>aof å› æœåŠ¡å™¨æŒ‚æ‰æŸåå¯ä»¥ä¿®å¤</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-check-aof -fix file.aof</span><br></pre></td></tr></table></figure><h4 id="ç»“è®º">ç»“è®º</h4><p>rdb æˆ–è€… aof æ ¹æ®ä¸šåŠ¡äºŒé€‰ä¸€å³å¯ï¼Œæ²¡å¿…è¦éƒ½å¼€å¯ï¼Œä½†æ˜¯ä¸ç®¡æ˜¯å“ªä¸€ç§ï¼Œéƒ½å¯ä»¥åœ¨äººå·¥è®¡åˆ’ä»»åŠ¡ä¹‹åï¼Œå¤åˆ»ä¸€ä»½å¤‡ä»½æ–‡ä»¶åˆ°äº‘ç«¯å¯¹è±¡å­˜å‚¨ä¸­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> å¤‡ä»½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-è½¯ä»¶åŒ…ç®¡ç†</title>
      <link href="posts/3d9b9ec1/"/>
      <url>posts/3d9b9ec1/</url>
      
        <content type="html"><![CDATA[<h4 id="apt-repository">apt_repository</h4><blockquote><p>ubuntu ä¸‹ï¼š</p><p>repo æŒ‡å®šåº“åœ°å€ï¼Œä¾‹å¦‚ nginx åœ°å€ ppa:nginx/stable</p><p>state å€¼ä¸º absent æ—¶ä¸ºåˆ é™¤</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible localhost -m apt_repository -a <span class="string">&quot;repo=ppa:nginx/stable&quot;</span> -b --ask-become-pass</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">localhost | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;repo&quot;</span>: <span class="string">&quot;ppa:nginx/stable&quot;</span>, </span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;present&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#( 04/24/20@ 3:10PM )( zyh@zyh ):~</span></span><br><span class="line">   cat  /etc/apt/sources.list.d/ppa_nginx_stable_bionic.list</span><br><span class="line">deb http://ppa.launchpad.net/nginx/stable/ubuntu bionic main</span><br></pre></td></tr></table></figure><h4 id="apt">apt</h4><blockquote><p>å¸¸ç”¨å‚æ•°ï¼š</p><p>name åŒ…å</p><p>state åŒ…çŠ¶æ€ ï¼ˆabsent-åˆ é™¤ï¼Œlatest-æœ€æ–°åŒ…,  present-é»˜è®¤å®‰è£…ï¼‰ latest ç›¸å½“äºå‡çº§åŒ…</p><p>upgrade å‡çº§ ï¼ˆyesï¼Œdistï¼Œfullï¼Œno-é»˜è®¤ï¼‰</p><p><a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html#apt-module">https://docs.ansible.com/ansible/latest/modules/apt_module.html#apt-module</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible localhost -m apt -a <span class="string">&quot;name=nginx state=present&quot;</span> -b --ask-become-pass</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">localhost | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;cache_update_time&quot;</span>: 1587713114, </span><br><span class="line">    <span class="string">&quot;cache_updated&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [], </span><br><span class="line">    <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;Reading package lists...\nBuilding dependency tree.......</span></span><br></pre></td></tr></table></figure><h4 id="yum-repository">yum_repository</h4><blockquote><p>name ä»“åº“å</p><p>baseurl ä»“åº“åœ°å€</p><p>enabled ï¼ˆyes-é»˜è®¤ï¼Œno)</p><p>gpgcheck (yes, no)</p><p>gpgcakey æŒ‡å®š gpg ca å…¬é’¥</p><p>state (present-é»˜è®¤ï¼Œabsent-åˆ é™¤)</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible localhost -m yum_repository -a <span class="string">&quot;name=epel baseurl=https://download.fedoraproject.org/pub/epel/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/&quot;</span></span><br></pre></td></tr></table></figure><h4 id="yum">yum</h4><blockquote><p>name åŒ…å</p><p>state (absent-åˆ é™¤ï¼Œpresent-å®‰è£…-é»˜è®¤å€¼ï¼Œlatest-æ›´æ–°)</p><p>disable_gpg_check å…³é—­gpgæ£€æŸ¥ï¼ˆç”¨äºæºgpgæ£€æŸ¥æ²¡æœ‰çš„æƒ…å†µï¼‰</p><p>enablerepo å®‰è£…åŒ…çš„æ—¶å€™ï¼Œå…ˆä¸´æ—¶å¯ç”¨æŸä¸ªæº</p><p>disablerepo å®‰è£…åŒ…çš„æ—¶å€™ï¼Œå…ˆä¸´æ—¶ç¦ç”¨æŸä¸ªæº</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-å‘½ä»¤è°ƒç”¨</title>
      <link href="posts/1e274151/"/>
      <url>posts/1e274151/</url>
      
        <content type="html"><![CDATA[<h4 id="shell">shell</h4><blockquote><p>è¿œç¨‹æ‰§è¡Œä¸€ä¸ªå‘½ä»¤</p><p>éƒ¨åˆ†å‚æ•°è§£æï¼š</p><p>chdir è¿œç¨‹å·¥ä½œç›®å½•</p><p>executable è¿œç¨‹æ‰§è¡Œshellï¼Œéœ€è¦ç»å¯¹è·¯å¾„</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible localhost -m shell -a <span class="string">&quot;chdir=/ ls&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">localhost | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="script">script</h4><blockquote><p>è¿œç¨‹æ‰§è¡Œä¸€ä¸ªansibleä¸»æœºç¯å¢ƒçš„è„šæœ¬</p><p>éƒ¨åˆ†å‚æ•°è§£æï¼š</p><p>chdir è¿œç¨‹å·¥ä½œç›®å½•</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat test.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `ls /<span class="built_in">export</span>`;<span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$i</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#-------------</span></span><br><span class="line">ansible -i hosts <span class="built_in">test</span> -m script -a <span class="string">&quot;/home/zyh/test.sh&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">10.200.10.212 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;changed&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">&quot;rc&quot;</span>: 0, </span><br><span class="line">    <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;Shared connection to 10.200.10.212 closed.\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stderr_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Shared connection to 10.200.10.212 closed.&quot;</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;jdk1.8.0_191\r\njdk8\r\nsen\r\n&quot;</span>, </span><br><span class="line">    <span class="string">&quot;stdout_lines&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;jdk1.8.0_191&quot;</span>, </span><br><span class="line">        <span class="string">&quot;jdk8&quot;</span>, </span><br><span class="line">        <span class="string">&quot;sen&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-æ–‡æœ¬æ–‡ä»¶æ“ä½œ</title>
      <link href="posts/4235ddf4/"/>
      <url>posts/4235ddf4/</url>
      
        <content type="html"><![CDATA[<h2 id="æ–‡æœ¬æ“ä½œ">æ–‡æœ¬æ“ä½œ</h2><h4 id="file">file</h4><blockquote><p>path æ–‡ä»¶å¯¹è±¡åœ°å€<br>state æ–‡ä»¶ç±»å‹æˆ–è€…åŠ¨ä½œçŠ¶æ€ ï¼ˆtouch: é’ˆå¯¹æ–‡ä»¶, directoryï¼šé’ˆå¯¹ç›®å½•, linkï¼šé’ˆå¯¹è½¯è¿æ¥, hardï¼šé’ˆå¯¹ç¡¬é“¾æ¥)</p><p>src è½¯ç¡¬é“¾æ¥çš„æºæ–‡ä»¶</p><p>owner å±ä¸»</p><p>group å±ç»„</p><p>mode æ•°å­—æƒé™</p><p>recurse é€’å½’æ“ä½œ</p></blockquote><h4 id="blockinfile">blockinfile</h4><blockquote><p>åœ¨æŒ‡å®šä½ç½®ï¼Œæ’å…¥æ–‡æœ¬å—ï¼Œå¹¶åœ¨æ–‡æœ¬å—å¼€å¤´å’Œç»“å°¾æ·»åŠ æ ‡è®°. æ ‡è®°ç”¨æ¥ç¡®è®¤æ–‡æœ¬å—çš„ä½ç½®ï¼Œä¸€äº›å‚æ•°ä¼šé€šè¿‡æ ‡è®°ä½ç½®æ¥ä¿®æ”¹æ–‡æœ¬å—ã€‚</p><p>æ³¨é‡Šæ ¼å¼:</p><p># BEGIN xxx</p><p># END xxx</p><p>å‚æ•°ç®€ä»‹ï¼š</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€</p><p>block éœ€è¦æ·»åŠ çš„æ–‡æœ¬å—</p><p>marker è‡ªå®šä¹‰æ ‡è®° xxx éƒ¨åˆ†ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒæ ‡è®°ï¼Œåˆ™ä¼˜å…ˆå¤„ç†ç›¸åŒæ ‡è®°çš„æ–‡æœ¬å—ã€‚</p><p>state çŠ¶æ€ä¸ºabsentæ—¶ï¼Œåˆ é™¤æ ‡è®°åŒ…æ‹¬çš„æ–‡æœ¬å—</p><p>insertafter æ­£åˆ™æˆ–è€…EOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å</p><p>insertbefore æ­£åˆ™æˆ–è€…BOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å‰</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œï¼Œå¤‡ä»½æ–‡ä»¶åç¼€æ˜¯æ—¶é—´æˆ³</p><p>create æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¿™æ¡å‘½ä»¤ä¸­ï¼Œå¦‚æœmarkeræ ‡è®°å·²ç»å­˜åœ¨ï¼Œåˆ™insertafterå°†æ— æ•ˆ</span></span><br><span class="line">-m blockinfile -a <span class="string">&#x27;path= block=&quot; &quot; marker=&quot;#&#123;mark&#125; xxx&quot; insertafter=&quot;æ­£åˆ™&quot;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="lineinfile">lineinfile</h4><blockquote><p>æ ¹æ®æŒ‡å®šçš„å†…å®¹ï¼Œè¿›è¡Œæ›¿æ¢æˆ–åˆ é™¤</p><p>å‚æ•°ç®€ä»‹ï¼š</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€ã€‚</p><p>line æŒ‡å®šè¡Œå†…å®¹ï¼ˆåœ¨æ²¡æœ‰æ­£åˆ™çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å…¨åŒ¹é…ï¼‰ã€‚</p><p>regexp é€šè¿‡æ­£åˆ™åŒ¹é…è¡Œï¼Œå¹¶å°†æ­¤è¡Œæ›¿æ¢æˆ line æŒ‡å®šçš„å†…å®¹ï¼Œregexpæœ‰é¢å¤–æ‰©å±•å‚æ•°ï¼Œä¾‹å¦‚ backrefã€‚</p><ul><li><p>line  è‹¥lineåŒ¹é…åˆ°æŸè¡Œï¼Œåˆ™ä¸ä¿®æ”¹ï¼Œè‹¥æ— åŒ¹é…ï¼Œåˆ™æ·»åŠ lineè‡³æœ«å°¾ã€‚</p></li><li><p>regexp + line  è‹¥æœ‰regexpåŒ¹é…åˆ°æŸè¡Œï¼Œæ›¿æ¢åŒ¹é…è¡Œä¸ºlineï¼›å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™å°†lineè¿½åŠ åˆ°è¡Œå°¾ã€‚æ­¤æ—¶ï¼Œregexpä¸æ”¯æŒåˆ†ç»„ã€‚</p></li><li><p>regexp + backrefs ï¼ˆtrueï¼‰+ line  è‹¥æœ‰regexpåŒ¹é…åˆ°æŸè¡Œï¼Œæ›¿æ¢åŒ¹é…è¡Œä¸ºlineï¼›å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™ä¿æŒæºæ–‡ä»¶ä¸å˜ï¼›æ­¤æ—¶ï¼Œregexpæ”¯æŒåˆ†ç»„ã€‚</p></li></ul><p>state çŠ¶æ€ä¸ºabsentæ—¶ï¼Œåˆ é™¤åŒ¹é…è¡Œ</p><p>insertafter æ­£åˆ™æˆ–è€…EOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å</p><p>insertbefore æ­£åˆ™æˆ–è€…BOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å‰</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œ</p><p>create æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-m lineinfile -a <span class="string">&#x27;path= line=&quot; &quot; insertafter=&quot;æ­£åˆ™&quot;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="replace">replace</h4><blockquote><p>æ›¿æ¢æ–‡ä»¶å¯¹è±¡ä¸­ç¬¦åˆåŒ¹é…çš„å­—ç¬¦ä¸²</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€</p><p>regexp æ­£åˆ™åŒ¹é…</p><p>replace æ›¿æ¢åçš„å­—ç¬¦ä¸²</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œ</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-aws</title>
      <link href="posts/15aa7d2e/"/>
      <url>posts/15aa7d2e/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://github.com/ansible/ansible/blob/stable-2.9/contrib/inventory/">https://github.com/ansible/ansible/blob/stable-2.9/contrib/inventory/</a></p><p><a href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html">https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html</a></p><p><a href="https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#inventory-script-example-aws-ec2">https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#inventory-script-example-aws-ec2</a> ï¼ˆæ·±å‘ï¼Œè„šæœ¬404ï¼Œæ‰¾åˆ°äº†è„šæœ¬ï¼Œå„ç§é”™è¯¯ï¼Œè¯·æ‰”ä¸€è¾¹ï¼‰</p></blockquote><h3 id="å‰è¨€">å‰è¨€</h3><p>é€šè¿‡ ansible è·å–å¤§åŒºä¸‹ ec2 èµ„æºä¿¡æ¯</p><h3 id="æˆæƒ">æˆæƒ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export AWS_ACCESS_KEY_ID=&#x27;AK123&#x27;</span><br><span class="line">export AWS_SECRET_ACCESS_KEY=&#x27;abc123&#x27;</span><br><span class="line">export EC2_INI_PATH=ec2.ini</span><br></pre></td></tr></table></figure><h3 id="åº“å­˜-inventory">åº“å­˜(inventory)</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[local]</span></span><br><span class="line">localhost</span><br></pre></td></tr></table></figure><h3 id="Playbook">Playbook</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">ec2</span></span><br><span class="line">    <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">gather_facts:</span> <span class="literal">no</span>   <span class="comment"># æˆ‘ä»¬è¦è¿™ä¿¡æ¯å¹²ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æ˜¯æœ‰ç›®æ ‡çš„</span></span><br><span class="line">    <span class="attr">connection:</span> <span class="string">local</span> <span class="comment"># æœ¨æœ‰å®šä¹‰èµ„æº</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tasks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">ec2</span> <span class="string">info</span></span><br><span class="line">        <span class="attr">ec2_instance_info:</span></span><br><span class="line">          <span class="attr">region:</span> <span class="string">cn-north-1</span></span><br><span class="line">        <span class="attr">register:</span> <span class="string">data_output</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">ec2</span> <span class="string">info</span></span><br><span class="line">        <span class="attr">debug:</span></span><br><span class="line">          <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; data_output|json_query(&#x27;instances[*].network_interfaces[*].private_ip_address&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œ">æ‰§è¡Œ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ansible-playbook -i hosts ec2.yml</span><br></pre></td></tr></table></figure><h3 id="è¾“å‡º">è¾“å‡º</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">TASK [show ec2 info] ******************************************************************************************************************************************************</span><br><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: [</span><br><span class="line">        [</span><br><span class="line">            &quot;10.100.10.250&quot;</span><br><span class="line">        ], </span><br><span class="line">        [</span><br><span class="line">            &quot;10.100.10.252&quot;</span><br><span class="line">        ], </span><br><span class="line">        [</span><br><span class="line">            &quot;10.100.10.210&quot;</span><br><span class="line">        ], </span><br><span class="line">        [</span><br><span class="line">            &quot;10.100.10.251&quot;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> aws </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows åŒ…ç®¡ç†å·¥å…· scoop</title>
      <link href="posts/22b82d75/"/>
      <url>posts/22b82d75/</url>
      
        <content type="html"><![CDATA[<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> RemoteSigned <span class="literal">-scope</span> CurrentUser</span><br><span class="line"><span class="built_in">iwr</span> <span class="literal">-useb</span> get.scoop.sh | <span class="built_in">iex</span></span><br><span class="line">scoop install aria2</span><br><span class="line">scoop config aria2<span class="literal">-max</span><span class="literal">-connection</span><span class="literal">-per</span><span class="literal">-server</span> <span class="number">16</span></span><br><span class="line">scoop config aria2<span class="operator">-split</span> <span class="number">16</span></span><br><span class="line">scoop config aria2<span class="literal">-min</span><span class="operator">-split</span><span class="literal">-size</span> <span class="number">1</span>M</span><br><span class="line">scoop bucket add extras</span><br><span class="line">scoop install Terminus</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windws </tag>
            
            <tag> scoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜å®‰è£…å’ŒåŸºæœ¬é…ç½®</title>
      <link href="posts/d9cdb70/"/>
      <url>posts/d9cdb70/</url>
      
        <content type="html"><![CDATA[<ul><li><p>jenkins</p><blockquote><p><a href="https://github.com/jenkinsci/docker/blob/master/README.md">https://github.com/jenkinsci/docker/blob/master/README.md</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jenkinsDomain=</span><br><span class="line">gitlabDomain=</span><br><span class="line">gitlabWanIP=</span><br><span class="line">jenkinsDns=</span><br><span class="line">docker volume create jenkins_home</span><br><span class="line">docker run --name jenkins --hostname <span class="variable">$&#123;jenkinsDomain&#125;</span> --add-host <span class="variable">$&#123;gitlabDomain&#125;</span>:<span class="variable">$&#123;gitlabWanIP&#125;</span> --restart always -d -v jenkins_home:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker -v /usr/lib64/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7 -p 8080:8080 -p 50000:50000 --dns <span class="variable">$&#123;jenkinsDns&#125;</span> jenkins/jenkins:lts</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it -u root jenkins /bin/bash</span><br><span class="line">curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py</span><br><span class="line">python get-pip.py</span><br><span class="line">pip install awscli</span><br><span class="line">pip install ansible</span><br><span class="line">groupadd -g &lt;docker-group-id&gt; docker</span><br><span class="line">usermod -aG docker jenkins</span><br><span class="line">docker stop jenkins &amp;&amp; docker start jenkins</span><br></pre></td></tr></table></figure></li><li><p>ç”¨æˆ·å’Œè§’è‰²ç®¡ç†</p><ol><li><p>å®‰è£…æ’ä»¶ Role-based Authorization Strategy</p></li><li><p>å¯ç”¨æ’ä»¶ Configure Global Security ä¸­å¯ç”¨ Role-Based Strategy ç­–ç•¥</p><p><img src="/posts/d9cdb70/image-20200515180703925.png" alt="image-20200515180703925"></p></li><li><p>é…ç½®å…¨å±€è§’è‰²å’Œé¡¹ç›®è§’è‰² Manage and Assign Roles - Manage Roles</p><p>å…¨å±€è§’è‰²<strong>Global roles</strong> è®¾ç½®ä¸¤ä¸ªï¼š admin å’Œ read</p><p><img src="/posts/d9cdb70/image-20200515181449965.png" alt="image-20200515181449965"></p><p>é¡¹ç›®è§’è‰²<strong>Project roles</strong>ï¼šæ¯ä¸€ä¸ªé¡¹ç›®è®¾ç½®ä¸€ä¸ª</p><p>Pattern: <code>.*\.&lt;é¡¹ç›®å&gt; </code></p><p>æƒé™: çœ‹å›¾</p><p><img src="/posts/d9cdb70/image-20200515181359533.png" alt="image-20200515181359533"></p></li><li><p>åˆ›å»ºé¡¹ç›®ç”¨æˆ·</p></li><li><p>åˆ†é…è§’è‰² Manage and Assign Roles - Assign Roles</p><p>ç»™ç®¡ç†å‘˜åˆ†é… adminï¼Œç»™é¡¹ç›®ç”¨æˆ·åˆ†é… read å’Œ cp (cpæ˜¯æˆ‘è®¾ç½®çš„é¡¹ç›®è§’è‰²)</p><p><img src="/posts/d9cdb70/image-20200515181740598.png" alt="image-20200515181740598"></p></li></ol></li><li><p>å®‰è£…é…ç½®æ–‡ä»¶æ’ä»¶ Config File Provider</p></li><li><p>è‡ªåŠ¨å®‰è£… git ï¼Œjdkï¼Œmaven ï¼ˆè¿™ç§æ–¹å¼åªæœ‰åœ¨è¿›è¡Œäº†ä¸€æ¬¡æ„å»ºåï¼Œæ‰ä¼šå®‰è£…ï¼‰</p></li><li><p>maven ç§æœé…ç½®æ–‡ä»¶</p><ol><li><p>é€šè¿‡ Config File Provider æ·»åŠ ä¸€ä¸ªé¡¹ç›®mavené…ç½®</p></li><li><pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;          xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;          xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt;  &lt;servers&gt;    &lt;server&gt;     &lt;id&gt;&lt;Repository Policyå&gt;&lt;/id&gt;     &lt;username&gt;&lt;/username&gt;     &lt;password&gt;&lt;/password&gt;    &lt;/server&gt;    &lt;server&gt;     &lt;id&gt;&lt;Repository Policyå&gt;&lt;/id&gt;      &lt;username&gt;&lt;/username&gt;      &lt;password&gt;&lt;/password&gt;    &lt;/server&gt;  &lt;/servers&gt;  &lt;profiles&gt;  &lt;profile&gt;&lt;id&gt;&lt; ä»“åº“å &gt;&lt;/id&gt;&lt;repositories&gt;  &lt;repository&gt;&lt;id&gt;&lt;maven ä»“åº“ç»„æˆ–ä»“åº“ID&gt;&lt;/id&gt;&lt;url&gt;&lt;maven ç§æœå…·ä½“ä»“åº“ç»„æˆ–ä»“åº“åœ°å€&gt;&lt;/url&gt;&lt;releases&gt;  &lt;enabled&gt;true&lt;/enabled&gt;&lt;/releases&gt;&lt;snapshots&gt;  &lt;enabled&gt;true&lt;/enabled&gt;&lt;/snapshots&gt;  &lt;/repository&gt;&lt;/repositories&gt;  &lt;/profile&gt;  &lt;/profiles&gt;  &lt;activeProfiles&gt; &lt;activeProfile&gt;é¡¹ç›®å&lt;/activeProfile&gt;  &lt;/activeProfiles&gt;&lt;/settings&gt;</code></pre></li><li><p>ç„¶åæ„å»ºé¡¹ç›®çš„æ—¶å€™ï¼Œæ„å»ºç¯å¢ƒ-Provide Configuration files-Filesï¼Œå¹¶ä¸”Build-é«˜çº§-Settings file-Provided settings.xml</p></li></ol></li></ul>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…è„šæœ¬â˜phpåŒ…ç®¡ç†æ–¹å¼</title>
      <link href="posts/b73a61bf/"/>
      <url>posts/b73a61bf/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä»‹ç»å¦‚ä½•é€šè¿‡yumæˆ–è€…apt-getå®‰è£…phpå’Œphp-fpm<br>é€‚åˆphp7.2</p><h4 id="centos">centos</h4><blockquote><p>å®‰è£…æº <a href="https://webtatic.com/">https://webtatic.com/</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line">yum install gcc-c++ geoip-devel -y</span><br><span class="line">yum install php72w-cli php72w-devel mod_php72w php72w-fpm php72w-opcache php72w-gd php72w-bcmath php72w-xml php72w-lzo -y</span><br><span class="line"></span><br><span class="line">mkdir /<span class="built_in">export</span>/logs/php -p</span><br><span class="line"><span class="built_in">cd</span> /etc/php-fpm.d/ &amp;&amp; mv www.conf www.conf.bak</span><br><span class="line">webName=www</span><br><span class="line">cat &gt; www.conf &lt;&lt; EOF</span><br><span class="line">[<span class="variable">$&#123;webName&#125;</span>]</span><br><span class="line">user = webapps</span><br><span class="line">group = webapps</span><br><span class="line">listen = 0.0.0.0:9000</span><br><span class="line">pm = static</span><br><span class="line">pm.max_children = 20</span><br><span class="line">pm.max_requests = 1024</span><br><span class="line">pm.status_path = /php-fpm_status</span><br><span class="line">request_slowlog_timeout = 2s</span><br><span class="line">slowlog = /<span class="built_in">export</span>/logs/php/php-slow.log</span><br><span class="line">php_admin_value[error_log] = /<span class="built_in">export</span>/logs/php/www-error.log</span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line">php_value[session.save_handler] = files</span><br><span class="line">php_value[session.save_path]    = /var/lib/php/session</span><br><span class="line">php_value[soap.wsdl_cache_dir]  = /var/lib/php/wsdlcache</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># å®‰è£…æºä¸­æ²¡æœ‰çš„æ¨¡å—</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">phpModule=&lt;æ¨¡å—å&gt;</span><br><span class="line">wget https://pecl.php.net/get/<span class="variable">$&#123;phpModule&#125;</span> &amp;&amp; mkdir redis-src &amp;&amp; tar xf redis --strip-components 1 -C <span class="variable">$&#123;phpModule&#125;</span>-src</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;phpModule&#125;</span>-src &amp;&amp; phpize &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">cat &gt; /etc/php.d/<span class="variable">$&#123;phpModule&#125;</span>.ini &lt;&lt; EOF</span><br><span class="line">; Enable zip extension module</span><br><span class="line">extension=<span class="variable">$&#123;phpModule&#125;</span>.so</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="ubuntu">ubuntu</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">add-apt-repository ppa:ondrej/php</span><br><span class="line">apt-get install php7.2 php7.2-dev php7.2-fpm php7.2-mysql php7.2-curl php7.2-json php7.2-mbstring php7.2-xml  php7.2-intl php7.2-yac php7.2-yaf php7.2-redis php7.2-lzo php7.2-geoip php7.2-pecl php7.2-pear php7.2-dev php7.2-gd php7.2-zip php7.2-xml php7.2-bcmath</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜åŸºç¡€ä¿¡æ¯</title>
      <link href="posts/d3e413b7/"/>
      <url>posts/d3e413b7/</url>
      
        <content type="html"><![CDATA[<h3 id="å®‰è£…">å®‰è£…</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apt-get install python3-pip</span><br><span class="line">pip3 install ansible --user -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><blockquote><p>pip å®‰è£…æ–¹å¼ï¼Œä¸ä¼šç”Ÿæˆé»˜è®¤é…ç½®<br><a href="https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg">https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg</a></p></blockquote><h3 id="å…³é—­-known-hosts-æ£€æŸ¥">å…³é—­ known_hosts æ£€æŸ¥</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/ansible/ansible.cfg or ~/.ansible.cfg</span></span><br><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></table></figure><h3 id="åº“å­˜å’Œå˜é‡">åº“å­˜å’Œå˜é‡</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/ansible/hosts é»˜è®¤ä½ç½®ï¼Œä½†å¯è‡ªå®šä¹‰ï¼Œå¹¶é€šè¿‡ -i æ¥è°ƒç”¨</span></span><br><span class="line"><span class="comment">############################################################################</span></span><br><span class="line"><span class="comment"># å•ä¸»æœº</span></span><br><span class="line">mail.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># http_port ä¸»æœºå˜é‡</span></span><br><span class="line"><span class="section">[webservers]</span></span><br><span class="line">www[01:50].example.comhttp_port=80</span><br><span class="line"></span><br><span class="line"><span class="section">[dbservers]</span></span><br><span class="line">db-[a:f].example.comansible_connection=ssh        ansible_ssh_user=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»„å˜é‡ ==&gt; ç»„å:vers</span></span><br><span class="line"><span class="section">[dbservers:vars]</span></span><br><span class="line"><span class="attr">mysql_port</span>=<span class="number">3306</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åµŒå¥—ç»„ ==&gt; çˆ¶ç»„:children</span></span><br><span class="line"><span class="section">[webproject:children]</span></span><br><span class="line">webservers</span><br><span class="line">dbservers</span><br></pre></td></tr></table></figure><blockquote><p>ä¸­æ‹¬å·è¡¨ç¤ºåˆ†ç»„ï¼Œå¯ä»¥ç”¨ç»„åä»£æ›¿ç»„èµ„æº ;</p></blockquote><h3 id="ç»“æ„åŒ–å˜é‡">ç»“æ„åŒ–å˜é‡</h3><blockquote><p>é‡‡ç”¨ yaml é…ç½®ï¼Œæ ¼å¼ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line">  <span class="string">å˜é‡:å€¼</span></span><br></pre></td></tr></table></figure></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/etc/ansible/group_vars/&lt;ç»„å&gt; # &lt;ç»„å&gt;æ–‡ä»¶æˆ–è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œå‡ä¼šè¢«è®¤ä¸ºæ˜¯&lt;ç»„å&gt;å˜é‡</span><br><span class="line">/etc/ansible/host_vars/&lt;ä¸»æœºå&gt; # &lt;ä¸»æœºå&gt;æ–‡ä»¶æˆ–è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œå‡ä¼šè¢«è®¤ä¸ºæ˜¯&lt;ç»„å&gt;å˜é‡</span><br></pre></td></tr></table></figure><h4 id="å¸¸ç”¨çš„å˜é‡">å¸¸ç”¨çš„å˜é‡</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ansible_ssh_host</span><br><span class="line">      å°†è¦è¿æ¥çš„è¿œç¨‹ä¸»æœºå.ä¸ä½ æƒ³è¦è®¾å®šçš„ä¸»æœºçš„åˆ«åä¸åŒçš„è¯,å¯é€šè¿‡æ­¤å˜é‡è®¾ç½®.</span><br><span class="line"></span><br><span class="line">ansible_ssh_port</span><br><span class="line">      sshç«¯å£å·.å¦‚æœä¸æ˜¯é»˜è®¤çš„ç«¯å£å·,é€šè¿‡æ­¤å˜é‡è®¾ç½®.</span><br><span class="line"></span><br><span class="line">ansible_ssh_user</span><br><span class="line">      é»˜è®¤çš„ ssh ç”¨æˆ·å</span><br><span class="line"></span><br><span class="line">ansible_ssh_pass</span><br><span class="line">      ssh å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨,æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-pass æˆ– SSH å¯†é’¥)</span><br><span class="line"></span><br><span class="line">ansible_sudo_pass</span><br><span class="line">      sudo å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨,æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨ -b --ask-become-pass)</span><br><span class="line"></span><br><span class="line">ansible_sudo_exe (new in version 1.8)</span><br><span class="line">      sudo å‘½ä»¤è·¯å¾„(é€‚ç”¨äº1.8åŠä»¥ä¸Šç‰ˆæœ¬)</span><br><span class="line"></span><br><span class="line">ansible_connection</span><br><span class="line">      ä¸ä¸»æœºçš„è¿æ¥ç±»å‹.æ¯”å¦‚:local, ssh æˆ–è€… paramiko. Ansible 1.2 ä»¥å‰é»˜è®¤ä½¿ç”¨ paramiko.1.2 ä»¥åé»˜è®¤ä½¿ç”¨ &#x27;smart&#x27;,&#x27;smart&#x27; æ–¹å¼ä¼šæ ¹æ®æ˜¯å¦æ”¯æŒ ControlPersist, æ¥åˆ¤æ–­&#x27;ssh&#x27; æ–¹å¼æ˜¯å¦å¯è¡Œ.</span><br><span class="line"></span><br><span class="line">ansible_ssh_private_key_file</span><br><span class="line">      ssh ä½¿ç”¨çš„ç§é’¥æ–‡ä»¶.é€‚ç”¨äºæœ‰å¤šä¸ªå¯†é’¥,è€Œä½ ä¸æƒ³ä½¿ç”¨ SSH ä»£ç†çš„æƒ…å†µ.</span><br><span class="line"></span><br><span class="line">ansible_shell_type</span><br><span class="line">      ç›®æ ‡ç³»ç»Ÿçš„shellç±»å‹.é»˜è®¤æƒ…å†µä¸‹,å‘½ä»¤çš„æ‰§è¡Œä½¿ç”¨ &#x27;sh&#x27; è¯­æ³•,å¯è®¾ç½®ä¸º &#x27;csh&#x27; æˆ– &#x27;fish&#x27;.</span><br><span class="line"></span><br><span class="line">ansible_python_interpreter</span><br><span class="line">      ç›®æ ‡ä¸»æœºçš„ python è·¯å¾„.é€‚ç”¨äºçš„æƒ…å†µ: ç³»ç»Ÿä¸­æœ‰å¤šä¸ª Python, æˆ–è€…å‘½ä»¤è·¯å¾„ä¸æ˜¯&quot;/usr/bin/python&quot;,æ¯”å¦‚  \*BSD, æˆ–è€… /usr/bin/python</span><br><span class="line">      ä¸æ˜¯ 2.X ç‰ˆæœ¬çš„ Python.æˆ‘ä»¬ä¸ä½¿ç”¨ &quot;/usr/bin/env&quot; æœºåˆ¶,å› ä¸ºè¿™è¦æ±‚è¿œç¨‹ç”¨æˆ·çš„è·¯å¾„è®¾ç½®æ­£ç¡®,ä¸”è¦æ±‚ &quot;python&quot; å¯æ‰§è¡Œç¨‹åºåä¸å¯ä¸º pythonä»¥å¤–çš„åå­—(å®é™…æœ‰å¯èƒ½åä¸ºpython26).</span><br><span class="line"></span><br><span class="line">      ä¸ ansible_python_interpreter çš„å·¥ä½œæ–¹å¼ç›¸åŒ,å¯è®¾å®šå¦‚ ruby æˆ– perl çš„è·¯å¾„....</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å·¥å…·åº“</title>
      <link href="posts/3827a60a/"/>
      <url>posts/3827a60a/</url>
      
        <content type="html"><![CDATA[<p><a href="https://encycolorpedia.cn/323e4e">åå…­è¿›åˆ¶é¢œè‰²ä»£ç è¡¨ï¼Œå›¾è¡¨ï¼Œè°ƒè‰²æ¿ï¼Œç»˜å›¾&amp;æ²¹æ¼†</a></p><p><a href="http://gosspublic.alicdn.com/ram-policy-editor/index.html">é˜¿é‡Œäº‘ ram ç­–ç•¥ç”Ÿæˆå™¨</a></p><p><a href="https://develop.aliyun.com/tools/sdk?#/python">é˜¿é‡Œäº‘SDKé¢‘é“</a></p><p><a href="https://app.xuty.tk/static/app/index.html">è¡¨æƒ…é”…</a></p><p><a href="https://whoer.net/zh">æµ‹è¯•å›½å¤–å‡ºå£ip</a></p><p><a href="http://www.ip-api.com/">æµ‹è¯•å›½å¤–å‡ºå£ip</a></p><p><a href="https://www.wondercv.com/">è¶…çº§ç®€å†WonderCV - HRæ¨èç®€å†æ¨¡æ¿,æ™ºèƒ½ç®€å†åˆ¶ä½œå·¥å…·,ä¸“ä¸šä¸­è‹±æ–‡ç®€å†æ¨¡æ¿å…è´¹ä¸‹è½½</a></p><p><a href="https://help.aliyun.com/knowledge_detail/50270.html?spm=a2c4g.11186623.6.621.483534bfFo31Sm">å„åœ°åŒºç®¡å±€å¤‡æ¡ˆè§„åˆ™</a></p><p><a href="https://www.ipplus360.com/">æ›´ç²¾å‡†çš„å…¨çƒIPåœ°å€å®šä½å¹³å°_IPé—®é—® -åŸƒæ–‡ç§‘æŠ€(ipplus360.com)</a></p><p><a href="http://xn--eqrt2g.xn--vuq861b/">å·¥ä¿¡éƒ¨-åŸŸå.ä¿¡æ¯</a></p><p><a href="http://explainshell.com/">è§£æå‘½ä»¤ explainshell.com - match command-line arguments to their help text</a></p><p><a href="https://haveibeenpwned.com/Passwords">å¯†ç æ³„éœ²æ£€æµ‹</a></p><p><a href="https://tuna.moe/">æ¸…åå¤§å­¦ TUNA åä¼š - Home</a></p><p><a href="http://zh.thetimenow.com/time-zone-converter.php">æ—¶åŒºè½¬æ¢ç”Ÿæˆ</a></p><p><a href="https://help.aliyun.com/document_detail/116378.html?spm=a2c4g.11186623.2.17.6f36578flUOrcy#concept-188715">ä½¿ç”¨redis-shakeè¿ç§»RDBæ–‡ä»¶å†…çš„æ•°æ®</a></p><p><a href="https://www.17ce.com/">ç½‘ç«™æµ‹é€Ÿ|ç½‘ç«™é€Ÿåº¦æµ‹è¯•|ç½‘é€Ÿæµ‹è¯•|ç”µä¿¡|è”é€š|ç½‘é€š|å…¨å›½|ç›‘æ§|CDN|PING|DNS 17CE.COM</a></p><p><a href="https://devhints.io/">è¯­è¨€/å·¥å…·è¯­æ³•å¸¸ç”¨æ‘˜è¦</a></p><p><a href="https://ipchaxun.com/">åŸŸååæŸ¥ip</a></p><p><a href="https://www.whatsmydns.net/">åŸŸåè§£ææ£€æŸ¥</a></p><p><a href="https://intodns.com/">åŸŸåçŠ¶æ€æŠ¥å‘Š</a></p><p><a href="https://github.com/ireaderlab/alex">alex:webå‹åŠ›æµ‹è¯•å·¥å…·</a></p><p><a href="http://www.kammerl.de/ascii/AsciiSignature.php">Ascii Text / Signature Generator motdåŠ¨æ€å¼€æœºæé†’</a></p><p><a href="https://www.json2yaml.com/convert-yaml-to-json">Convert YAML to JSON</a></p><p><a href="https://csr.chinassl.net/generator-csr.html">CSRæ–‡ä»¶ç”Ÿæˆå·¥å…·-ä¸­å›½æ•°å­—è¯ä¹¦CHINASSL</a></p><p><a href="https://apps.evozi.com/apk-downloader/">gp apk ä¸‹è½½</a></p><p><a href="http://tool.520101.com/wangluo/ipjisuan/">ipåœ°å€åœ¨çº¿è®¡ç®—å™¨</a></p><p><a href="https://ipv6-test.com/validate.php">IPv6 ç«™ç‚¹æµ‹è¯•</a></p><p><a href="http://grokconstructor.appspot.com/do/match#result">logstash grok æµ‹è¯•</a></p><p><a href="https://github.com/DoubleLabyrinth/MobaXterm-keygen">MobaXterm-keygen å¯†é’¥</a></p><p><a href="http://msdn.itellyou.cn/">MSDN, æˆ‘å‘Šè¯‰ä½ </a></p><p><a href="https://api.aliyun.com/#/cli">OpenAPI Explorer</a></p><p><a href="https://www.pyman.com.cn/">pymanç½‘å€å¯¼èˆª</a></p><p><a href="http://rpm.pbone.net/">RPM Search</a></p><p><a href="https://www.cnblogs.com/zhaoruiqing/articles/12870209.html">Typoraçš„EmojiæŒ‡ä»¤</a></p><p><a href="https://paste.ubuntu.com/">Ubuntu Pastebin</a></p><p><a href="http://www.92csz.com/study/UnixToolbox-zh_CN.html">Unix Toolbox - ä¸­æ–‡ç‰ˆ</a></p><p><a href="https://www.dotcom-tools.com/">Website Performance Test Tools</a></p>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜æ—¶é—´</title>
      <link href="posts/cd32aa48/"/>
      <url>posts/cd32aa48/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æœ¬æ–‡ä¸­æè¿°çš„å¹¶ä¸èƒ½æ¶µç›–æ‰€æœ‰æ—¶é—´è®¾ç½®å‘½ä»¤ï¼Œåªæ˜¯è®°å½•äº†ç»å¸¸ç”¨åˆ°çš„ä¸€äº›ã€‚</p><h4 id="ä¿®æ”¹ä¼šè¯æ—¶åŒº">ä¿®æ”¹ä¼šè¯æ—¶åŒº</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;TZ=&#x27;UTC+0&#x27;; export TZ&quot;</span> &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>UTC8 è¡¨ç¤ºè¥¿8åŒº</li><li>tzselect å¯ä»¥å¸®ä½ æŸ¥çœ‹æ—¶åŒºæœ‰å“ªäº›</li><li>UTC æ–¹å¼ï¼Œæ— æ³•è¯†åˆ«å†¬ä»¤æ—¶å’Œå¤ä»¤æ—¶ï¼Œæ‰€ä»¥å»ºè®®ç”¨åœ°åŒºåç§°ï¼Œä¾‹å¦‚ asia/shanghai</li></ol></blockquote><h4 id="ä¿®æ”¹crontabæ—¶åŒº">ä¿®æ”¹crontabæ—¶åŒº</h4><p>åœ¨ crontab ç”¨æˆ·é…ç½®æœ€ä¸Šé¢åŠ å…¥ï¼Œä¾‹å¦‚æ·»åŠ èŠåŠ å“¥æ—¶åŒº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TZ=<span class="string">&#x27;America/Chicago&#x27;</span></span><br><span class="line">CRON_TZ=<span class="string">&#x27;America/Chicago&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>å…³äºæ—¶åŒºè®¾ç½®æ–¹é¢ï¼Œä¸å»ºè®®ä¿®æ”¹é…ç½®ï¼Œå› ä¸ºä¸å¤Ÿçµæ´»</p></blockquote><h4 id="ä¿®æ­£æ—¶é—´-å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ">ä¿®æ­£æ—¶é—´, å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install ntp -y</span><br><span class="line">ntpdate cn.ntp.org.cn</span><br><span class="line">hwclock -w</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;0 12 * * * /usr/sbin/ntpdate cn.ntp.org.cn &gt; /dev/null 2&gt;&amp;1&#x27;</span> &gt;&gt; /etc/crontab</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> æ—¶åŒº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜ELKç®€å•éƒ¨ç½²-å®¹å™¨æ–¹å¼</title>
      <link href="posts/3475106c/"/>
      <url>posts/3475106c/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><ul><li>å„ç»„ä»¶æ€»ä¸‹è½½é¡µ: <a href="https://www.elastic.co/cn/downloads/">https://www.elastic.co/cn/downloads/</a></li><li>å®¹å™¨ä¸‹è½½é¡µ: <a href="https://www.docker.elastic.co">https://www.docker.elastic.co</a></li></ul><ol><li>Elasticsearch æœç´¢åˆ†æ <a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></li><li>Logstash è½¬æ¢è¾“å‡º <a href="https://www.elastic.co/cn/downloads/logstash">https://www.elastic.co/cn/downloads/logstash</a></li><li>Filebeat æ”¶é›† <a href="https://www.elastic.co/cn/downloads/beats/filebeat">https://www.elastic.co/cn/downloads/beats/filebeat</a></li><li>Kibana å±•ç¤º <a href="https://www.elastic.co/cn/downloads/kibana">https://www.elastic.co/cn/downloads/kibana</a></li></ol><h4 id="æ•°æ®è¿‡ç¨‹">æ•°æ®è¿‡ç¨‹:</h4><p>Filebeat â˜ Logstash â˜ Elasticsearch (master node) + data node â˜ Kibana</p><h4 id="å®‰è£…æ­¥éª¤">å®‰è£…æ­¥éª¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker</span></span><br><span class="line">yum install docker -y æˆ–è€… yum install docker-ce -y</span><br><span class="line">yum install python3-pip -y</span><br><span class="line">pip3 install docker-compose æˆ–è€… pip install docker-compose</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ docker é»˜è®¤æ•°æ®ç›®å½•</span></span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;data-root&quot;</span>: <span class="string">&quot;/export/docker-data-root&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># elasticsearch å…·ä½“å®‰è£…å‘½ä»¤å’Œç‰ˆæœ¬è¯·ä»¥ä¸‹è½½é¡µä¸­å¯¹åº”çš„dockerå®‰è£…æ–¹å¼é¡µé‡Œå‘½ä»¤ä¸ºåŸºå‡†</span></span><br><span class="line"><span class="string">sysctl</span> <span class="string">-a</span> <span class="string">|</span> <span class="string">grep</span>  <span class="string">vm.max_map_count</span>  <span class="comment"># æŸ¥çœ‹æ˜¯å¦è¿‡å°, å¦‚æœè¿‡å°æ‰§è¡Œä¸‹ä¸€æ¡</span></span><br><span class="line"><span class="string">echo</span> <span class="string">&#x27;vm.max_map_count=262144&#x27;</span> <span class="string">&gt;&gt;</span> <span class="string">/etc/sysctl.conf</span> <span class="string">&amp;&amp;</span> <span class="string">sysctl</span> <span class="string">-p</span></span><br><span class="line"></span><br><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/export/docker-compose-data/es;</span></span><br><span class="line"><span class="string">touch</span> <span class="string">/export/docker-compose-data/docker-compose.yml;</span></span><br><span class="line"><span class="string">touch</span> <span class="string">/export/docker-compose-data/es/es01.yml;</span></span><br><span class="line"><span class="string">touch</span> <span class="string">/export/docker-compose-data/es/es02.yml;</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/export/docker-compose-data/kibana;</span></span><br><span class="line"><span class="string">touch</span> <span class="string">/export/docker-compose-data/kibana/kibana.yml;</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/export/docker-compose-data/logstash</span></span><br><span class="line"><span class="string">touch</span> <span class="string">/export/docker-compose-data/logstash/logstash.yml;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># es01 master å’Œ data</span></span><br><span class="line"><span class="comment"># es02 data</span></span><br><span class="line">cat &gt; /<span class="built_in">export</span>/docker-compose-data/es/es01.yml &lt;&lt; EOF</span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">http.port: 9200</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">&quot;*&quot;</span> </span><br><span class="line"></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /<span class="built_in">export</span>/docker-compose-data/es/es02.yml &lt;&lt; EOF</span><br><span class="line">node.master: <span class="literal">false</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">http.port: 9200</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"></span><br><span class="line">http.cors.enabled: <span class="literal">true</span></span><br><span class="line">http.cors.allow-origin: <span class="string">&quot;*&quot;</span> </span><br><span class="line"></span><br><span class="line">xpack.security.enabled: <span class="literal">false</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /<span class="built_in">export</span>/docker-compose-data/kibana/kibana.yml &lt;&lt; EOF</span><br><span class="line">xpack.monitoring.ui.container.elasticsearch.enabled: <span class="literal">true</span></span><br><span class="line">i18n.locale: zh-CN</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /<span class="built_in">export</span>/docker-compose-data/logstash/logstash.yml &lt;&lt; EOF</span><br><span class="line">node.name: logstash</span><br><span class="line">http.host: 0.0.0.0</span><br><span class="line">http.port: 9600</span><br><span class="line">log.level: info</span><br><span class="line">config.reload.automatic: <span class="literal">true</span></span><br><span class="line">config.reload.interval: 10s</span><br><span class="line">config.support_escapes: <span class="literal">false</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™-logstash-ç®¡é“æ–‡ä»¶">ç¼–å†™ logstash ç®¡é“æ–‡ä»¶</h4><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹ /export/docker-compose-data/logstash/pipeline/es-curator.conf</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line"><span class="string">file</span> &#123;</span><br><span class="line"><span class="string">path</span> <span class="string">=&gt;</span> <span class="string">&quot;/mnt/info.log&quot;</span></span><br><span class="line"><span class="string">type</span> <span class="string">=&gt;</span> <span class="string">&quot;es-curator&quot;</span></span><br><span class="line"><span class="string">start_position</span> <span class="string">=&gt;</span> <span class="string">&quot;beginning&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line"><span class="string">if</span> [<span class="string">type</span>] <span class="string">==</span> <span class="string">&quot;es-curator&quot;</span> &#123;</span><br><span class="line"><span class="string">elasticsearch</span> &#123;</span><br><span class="line"><span class="string">hosts=&gt;</span> [<span class="string">&quot;es01:9200&quot;</span>]</span><br><span class="line"><span class="string">index=&gt;</span> <span class="string">&quot;es-curator-<span class="template-variable">%&#123;+YYYY-MM-dd&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨æœåŠ¡docker-composeé…ç½®æ–‡ä»¶">å¯åŠ¨æœåŠ¡docker-composeé…ç½®æ–‡ä»¶</h4><blockquote><p><a href="https://docs.docker.com/compose/compose-file/compose-file-v2/">https://docs.docker.com/compose/compose-file/compose-file-v2/</a></p><p>æœ¬é…ç½®æ–‡ä»¶å‚è€ƒ 2.3 ç‰ˆæœ¬, è¯·å‹¿ä½¿ç”¨ 3.x ç‰ˆæœ¬, å› ä¸ºå®ƒçš„èµ„æºå±‚ deploy, docker-composeå‘½ä»¤ä¸æ”¯æŒ</p></blockquote><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">/export/docker-compose-data/docker-compose.yml</span> <span class="string">&lt;&lt;</span> <span class="string">EOF</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2.3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">es01:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.4.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es01</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-sen</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms1536m -Xmx1536m&quot;</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">      <span class="attr">nofile:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">esdata01:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/export/docker-compose-data/es/es01.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">esnet</span></span><br><span class="line">    <span class="attr">cpus:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">mem_limit:</span> <span class="string">3G</span></span><br><span class="line">    <span class="attr">memswap_limit:</span> <span class="string">3G</span></span><br><span class="line">    <span class="attr">mem_reservation:</span> <span class="string">3G</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9200&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">120s</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line">  <span class="attr">es02:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.4.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es02</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-sen</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ES_JAVA_OPTS=-Xms1536m-Xmx1536m&quot;</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">      <span class="attr">nofile:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">65536</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">65536</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">esdata02:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/export/docker-compose-data/es/es02.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">esnet</span></span><br><span class="line">    <span class="attr">cpus:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">mem_limit:</span> <span class="string">3G</span></span><br><span class="line">    <span class="attr">memswap_limit:</span> <span class="string">3G</span></span><br><span class="line">    <span class="attr">mem_reservation:</span> <span class="string">3G</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9200&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">120s</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line">  <span class="attr">kibana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/kibana/kibana:7.4.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SERVER_NAME:</span> <span class="string">kibana.sen-sdk.com</span></span><br><span class="line">      <span class="attr">SERVER_HOST:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="attr">ELASTICSEARCH_HOSTS:</span> <span class="string">http://es01:9200</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/export/docker-compose-data/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5601</span><span class="string">:5601</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">esnet</span></span><br><span class="line">    <span class="attr">cpus:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">mem_limit:</span> <span class="string">512m</span></span><br><span class="line">    <span class="attr">memswap_limit:</span> <span class="string">512m</span></span><br><span class="line">    <span class="attr">mem_reservation:</span> <span class="string">512m</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:5601&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">120s</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">logstash:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/logstash/logstash:7.4.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">logstash</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/export/docker-compose-data/logstash/pipeline/:/usr/share/logstash/pipeline/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/export/docker-compose-data/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">logstash:/usr/share/logstash/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5044:5044&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9600:9600&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">esnet</span></span><br><span class="line">    <span class="attr">cpus:</span> <span class="number">0.5</span></span><br><span class="line">    <span class="attr">mem_limit:</span> <span class="string">1g</span></span><br><span class="line">    <span class="attr">memswap_limit:</span> <span class="string">1g</span></span><br><span class="line">    <span class="attr">mem_reservation:</span> <span class="string">1g</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9600&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">120s</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">esdata01:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">esdata02:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">logstash:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">esnet:</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨-docker-compose">å¯åŠ¨ docker-compose</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/docker-compose-data/</span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment"># docker-compose up -d --no-recreate</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx â˜ åŸºæœ¬è®¤è¯</title>
      <link href="posts/18de0eed/"/>
      <url>posts/18de0eed/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… htpasswd å·¥å…·</span></span><br><span class="line">yum install httpd-tools -y</span><br><span class="line"><span class="comment"># ç”Ÿæˆå¯†ç æ–‡ä»¶</span></span><br><span class="line">htpasswd -bc /usr/<span class="built_in">local</span>/nginx/conf/.passwd usera <span class="built_in">pwd</span> <span class="comment"># åˆ›å»ºç”¨æˆ·usera, å¹¶å†™å…¥ .passwd</span></span><br><span class="line">htpasswd -b /usr/<span class="built_in">local</span>/nginx/conf.passwd userb <span class="built_in">pwd</span>  <span class="comment"># è¿½åŠ ç”¨æˆ· userb</span></span><br><span class="line">htpasswd -D /usr/<span class="built_in">local</span>/nginx/conf/.passwd usera <span class="comment"># åˆ é™¤ç”¨æˆ·</span></span><br><span class="line"><span class="comment"># nginxé…ç½®</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  xxx.com;</span><br><span class="line">    index index.html;</span><br><span class="line">    location /auth &#123;</span><br><span class="line">        auth_basic <span class="string">&quot;nginx auth&quot;</span>;</span><br><span class="line">        auth_basic_user_file /usr/<span class="built_in">local</span>/nginx/conf/.passwd;</span><br><span class="line">        <span class="built_in">alias</span> /<span class="built_in">export</span>/webapps/xxx.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux â˜ è½¯ raid åˆ›å»º</title>
      <link href="posts/a7611bc1/"/>
      <url>posts/a7611bc1/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-â˜-è½¯-raid-åˆ›å»º">linux â˜ è½¯ raid åˆ›å»º</h2><ul><li>åˆ›å»º</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç£ç›˜åˆ†åŒº</span></span><br><span class="line">fdisk /dev/sda</span><br><span class="line">fdisk /dev/sdb</span><br><span class="line"><span class="comment"># æ„å»ºraid0</span></span><br><span class="line"><span class="comment"># --level raidçº§åˆ«</span></span><br><span class="line"><span class="comment"># --raid-devices ç›˜æ•°</span></span><br><span class="line"><span class="comment"># --chunk æ¡å¸¦æ·±åº¦ï¼Œå†³å®šäº†æ•°æ®åˆ†å‰²çš„æ ‡å‡†å•ä½å¤§å°ï¼Œæ•°å€¼è¶Šå°ï¼Œåˆ™æ•°æ®è¶Šåˆ†æ•£ï¼Œæ€§èƒ½è¶Šä½(å¦‚è‹¥æ²¡æœ‰ç‰¹æ®Šä¼˜åŒ–éœ€æ±‚ï¼Œå»ºè®®é€‰é»˜è®¤å€¼å³å¯)</span></span><br><span class="line">mdadm -Cv /dev/md0 --level=0 --raid-devices=2 /dev/sda1 /dev/sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·²ä¸Šé…ç½®ä¸­, ä¹Ÿå¯ä»¥ä¸åˆ†åŒº, ç›´æ¥è¿›è¡Œ raid æ„å»º</span></span><br><span class="line">mdadm --create --verbose /dev/md0 --level=0 --name=MY_RAID --raid-devices=number_of_volumes device_name1 device_name2</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§‚å¯Ÿå’Œç­‰å¾…é˜µåˆ—åˆå§‹åŒ–</span></span><br><span class="line">cat /proc/mdstat</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§‚å¯Ÿåˆå§‹åŒ–åçš„é˜µåˆ—ä¿¡æ¯</span></span><br><span class="line">mdadm --detail /dev/md0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¼å¼åŒ– ï¼ˆåŠ å·æ ‡ï¼‰</span></span><br><span class="line">mke2fs -t ext4 -L raid0 /dev/md0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥é…ç½®</span></span><br><span class="line"><span class="comment"># ä¸åŒçš„æ“ä½œç³»ç»Ÿ mdadm.conf ä½ç½®ä¸åŒ, å…·ä½“ä»¥ man mdadm.conf ä¸ºå‡†</span></span><br><span class="line">mdadm --detail --scan | tee -a /etc/mdadm.conf</span><br><span class="line"><span class="comment"># echo &quot;DEVICE /dev/sda1 /dev/sdb1 &quot; &gt;&gt; /etc/mdadm/mdadm.conf</span></span><br><span class="line"><span class="comment"># mdadm -Ds &gt;&gt; /etc/mdadm/mdadm.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ–°çš„ Ramdisk Image ä»¥ä¸ºæ–°çš„ RAID é…ç½®æ­£ç¡®åœ°é¢„åŠ è½½å—å‚¨å­˜è®¾å¤‡æ¨¡å—</span></span><br><span class="line">sudo dracut -H -f /boot/initramfs-$(uname -r).img $(uname -r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥æŒ‚è½½ ï¼ˆç”¨å·æ ‡æŒ‚è½½ï¼Œæœ‰äº›ç³»ç»Ÿé‡å¯åï¼Œè®¾å¤‡åä¼šä»md0å˜æˆmd127ï¼‰</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;LABEL=raid0 /data ext4 defaults,nofail 0 2&quot;</span> &gt;&gt; /etc/fstab</span><br><span class="line">mkdir /data</span><br><span class="line">mount -a</span><br><span class="line"><span class="comment"># ç¡®è®¤æŒ‚è½½æˆåŠŸ</span></span><br><span class="line">df -h</span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤/etc/fstabçš„æŒ‚è½½ä¿¡æ¯</span></span><br><span class="line">$ mdadm -S /dev/md0</span><br><span class="line">$ mdadm --misc --zero-superblock /dev/sda</span><br><span class="line">$ mdadm --misc --zero-superblock /dev/sdb</span><br><span class="line"><span class="comment"># åˆ é™¤/etc/mdadm/mdadm.confæ–‡ä»¶ä¸­æ·»åŠ çš„DEVICEè¡Œå’ŒARRAYè¡Œ</span></span><br></pre></td></tr></table></figure><ul><li>é¢å¤–ä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#2Tä»¥ä¸Šå¤§å°åˆ†åŒº</span></span><br><span class="line">parted /dev/sda</span><br><span class="line"> mklabel gpt</span><br><span class="line"> mkpart primary1 0% 100%</span><br><span class="line">partprobe</span><br></pre></td></tr></table></figure><ul><li>å…³äºäº‘</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">å½“ä½¿ç”¨äº‘ç«¯ç£ç›˜æ„å»ºraidçš„æ—¶å€™,ä¸”åˆæƒ³è¿›è¡Œ raid å¤‡ä»½,åˆ™åŠ¡å¿…å…ˆåœæ­¢ioæ“ä½œ,åœæ­¢ioæ“ä½œçš„æ–¹æ³•æœ€å¥½æ˜¯ umount æˆ–è€…åœæœº. å¦åˆ™ä¼šå¯¼è‡´ raid æ•°æ®å®Œæ•´æ€§å‡ºç°é—®é¢˜.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> raid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜s3 åˆå§‹åŒ–å®‰è£…</title>
      <link href="posts/2c5a64ff/"/>
      <url>posts/2c5a64ff/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€">å‰è¨€</h3><p>è„šæœ¬çš„ç›®çš„ï¼š</p><ol><li>åˆ›å»ºS3</li><li>æ·»åŠ ç”Ÿå‘½å‘¨æœŸ</li><li>åˆ›å»ºiamè§„åˆ™</li></ol><h3 id="ä¸»ä½“è„šæœ¬">ä¸»ä½“è„šæœ¬</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># http://docs.amazonaws.cn/general/latest/gr/rande.html#s3_region</span></span><br><span class="line"><span class="comment"># us-east-1 us-west-1 ç­‰</span></span><br><span class="line"><span class="comment"># éœ€è¦s3æƒé™å’Œiamæƒé™</span></span><br><span class="line"><span class="comment"># éœ€è¦å…ˆç¼–å†™ s3-lifecycle.json</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¡¶å</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥s3æ¡¶å=&quot;</span> S3BucketName</span><br><span class="line"><span class="comment">#æ‰€å±é¡¹ç›®</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥é¡¹ç›®å=&quot;</span> TeamName</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥AWS_ACCESS_KEY_ID=&quot;</span> AWS_ACCESS_KEY_ID</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥AWS_SECRET_ACCESS_KEY=&quot;</span> AWS_SECRET_ACCESS_KEY</span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;è¾“å…¥AWS_DEFAULT_REGION=&quot;</span> AWS_DEFAULT_REGION</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=<span class="variable">$AWS_ACCESS_KEY_ID</span></span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=<span class="variable">$AWS_SECRET_ACCESS_KEY</span></span><br><span class="line"><span class="built_in">export</span> AWS_DEFAULT_REGION=<span class="variable">$AWS_DEFAULT_REGION</span></span><br><span class="line"></span><br><span class="line">S3LocationConstraint=<span class="variable">$&#123;AWS_DEFAULT_REGION&#125;</span></span><br><span class="line"></span><br><span class="line">[[ <span class="variable">$&#123;S3LocationConstraint&#125;</span> == <span class="string">&#x27;us-east-1&#x27;</span> ]] &amp;&amp; aws s3api create-bucket --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --region <span class="variable">$&#123;S3LocationConstraint&#125;</span> || aws s3api create-bucket --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --region <span class="variable">$&#123;S3LocationConstraint&#125;</span> --create-bucket-configuration LocationConstraint=<span class="variable">$&#123;S3LocationConstraint&#125;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;conf/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;data/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;backup/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;logs/7days/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;logs/15days/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;logs/30days/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;logs/60days/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;logs/90days/&#x27;</span></span><br><span class="line">aws s3api put-object --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --key <span class="string">&#x27;logs/longlasting/&#x27;</span></span><br><span class="line"></span><br><span class="line">aws s3api put-bucket-tagging --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --tagging <span class="string">&quot;TagSet=[&#123;Key=Team,Value=<span class="variable">$&#123;TeamName&#125;</span>&#125;]&quot;</span></span><br><span class="line">aws s3api put-bucket-lifecycle-configuration --bucket <span class="variable">$&#123;S3BucketName&#125;</span> --lifecycle-configuration file://s3-lifecycle.json</span><br><span class="line"></span><br><span class="line">cat &gt; s3-program.rule &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;VisualEditor0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:PutObject&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:DeleteObject&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Resource&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/7days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/15days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/30days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/60days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/90days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/longlasting/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/conf/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/data/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/backup/*&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;VisualEditor1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;s3:ListBucket&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Resource&quot;</span>: <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cat &gt; s3-local.rule &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;VisualEditor0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;s3:ListBucket&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Resource&quot;</span>: <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;ForAnyValue:IpAddress&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;aws:SourceIp&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;1.1.1.1/32&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;VisualEditor1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;s3:PutObject&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                <span class="string">&quot;s3:DeleteObject&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Resource&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/7days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/15days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/30days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/60days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/90days/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/logs/longlasting/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/conf/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/data/*&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>/backup/*&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;ForAnyValue:IpAddress&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;aws:SourceIp&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;1.1.1.1/32&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;VisualEditor2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;s3:GetBucketLocation&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Resource&quot;</span>: <span class="string">&quot;arn:aws:s3:::<span class="variable">$&#123;S3BucketName&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;ForAnyValue:IpAddress&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;aws:SourceIp&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;1.1.1.1/32&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;VisualEditor3&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;s3:ListAllMyBuckets&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;ForAnyValue:IpAddress&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;aws:SourceIp&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;1.1.1.1/32&quot;</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">aws iam create-policy --policy-name s3-<span class="variable">$&#123;S3BucketName&#125;</span>-role --description <span class="string">&quot;For role use only!!!!!!!!!!!!&quot;</span> --policy-document  file://s3-program.rule</span><br><span class="line">aws iam create-policy --policy-name s3-<span class="variable">$&#123;S3BucketName&#125;</span>-<span class="built_in">local</span> --description <span class="string">&quot;Limit the source IP!!!!!!!!!!!!&quot;</span> --policy-document file://s3-local.rule</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ç¨‹åºç”¨æˆ·è§„åˆ™: s3-<span class="variable">$&#123;S3BucketName&#125;</span>-role å·²ç”Ÿæˆ&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æœ¬åœ°ç”¨æˆ·è§„åˆ™ï¼šs3-<span class="variable">$&#123;S3BucketName&#125;</span>-local å·²ç”Ÿæˆ&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¯·å°† local è§„åˆ™å…³è”åˆ°å¯¹åº”ä¸ªäººç”¨æˆ·æˆ–ç»„&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¯·å°† role è§„åˆ™å…³è”åˆ°è§’è‰²&quot;</span></span><br></pre></td></tr></table></figure><h3 id="ç”Ÿå‘½å‘¨æœŸè§„åˆ™-s3-lifecycle-json">ç”Ÿå‘½å‘¨æœŸè§„åˆ™ s3-lifecycle.json</h3><blockquote><p>è§„åˆ™è¯´æ˜ï¼š</p><ol><li>æ‰€æœ‰å¯¹è±¡ï¼Œ30å¤©ä¹‹åè½¬ä¸ºONEZONE_IA;</li><li>logs å‰ç¼€å•ç‹¬å®šä¹‰ï¼š<ul><li>days è·¯å¾„ä¸‹çš„å¯¹è±¡ä¿å­˜å¯¹åº”çš„å¤©æ•°</li><li>longlasting è·¯å¾„ä¸‹çš„å¯¹è±¡æ°¸ä¹…ä¿å­˜ï¼Œä½†æ˜¯ 90 å¤©ä¹‹åçš„å¯¹è±¡è½¬æ¢ä¸º GLACIER</li></ul></li></ol></blockquote>  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Rules&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Filter&quot;: &#123;</span><br><span class="line">                &quot;Prefix&quot;: &quot;&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;Status&quot;: &quot;Enabled&quot;, </span><br><span class="line">            &quot;Transitions&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Days&quot;: 30, </span><br><span class="line">                    &quot;StorageClass&quot;: &quot;ONEZONE_IA&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;NoncurrentVersionTransitions&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;NoncurrentDays&quot;: 30, </span><br><span class="line">                    &quot;StorageClass&quot;: &quot;ONEZONE_IA&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;ID&quot;: &quot;30days_onezone_ia&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Filter&quot;: &#123;</span><br><span class="line">                &quot;Prefix&quot;: &quot;logs/longlasting/&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;Status&quot;: &quot;Enabled&quot;, </span><br><span class="line">            &quot;Transitions&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Days&quot;: 90, </span><br><span class="line">                    &quot;StorageClass&quot;: &quot;GLACIER&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;ID&quot;: &quot;logs_90day_glacier&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;Enabled&quot;,</span><br><span class="line">            &quot;NoncurrentVersionExpiration&quot;: &#123;</span><br><span class="line">                &quot;NoncurrentDays&quot;: 1</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Filter&quot;: &#123;</span><br><span class="line">                &quot;Prefix&quot;: &quot;logs/7days/&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Expiration&quot;: &#123;</span><br><span class="line">                &quot;Days&quot;: 7</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AbortIncompleteMultipartUpload&quot;: &#123;</span><br><span class="line">                &quot;DaysAfterInitiation&quot;: 7</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ID&quot;: &quot;logs_delete_7days_before&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;Enabled&quot;,</span><br><span class="line">            &quot;NoncurrentVersionExpiration&quot;: &#123;</span><br><span class="line">                &quot;NoncurrentDays&quot;:  1</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Filter&quot;: &#123;</span><br><span class="line">                &quot;Prefix&quot;: &quot;logs/15days/&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Expiration&quot;: &#123;</span><br><span class="line">                &quot;Days&quot;: 15</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AbortIncompleteMultipartUpload&quot;: &#123;</span><br><span class="line">                &quot;DaysAfterInitiation&quot;: 7</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ID&quot;: &quot;logs_delete_15days_before&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;Enabled&quot;,</span><br><span class="line">            &quot;NoncurrentVersionExpiration&quot;: &#123;</span><br><span class="line">                &quot;NoncurrentDays&quot;:  1</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Filter&quot;: &#123;</span><br><span class="line">                &quot;Prefix&quot;: &quot;logs/30days/&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Expiration&quot;: &#123;</span><br><span class="line">                &quot;Days&quot;: 30</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AbortIncompleteMultipartUpload&quot;: &#123;</span><br><span class="line">                &quot;DaysAfterInitiation&quot;: 7</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ID&quot;: &quot;logs_delete_30days_before&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;Enabled&quot;,</span><br><span class="line">            &quot;NoncurrentVersionExpiration&quot;: &#123;</span><br><span class="line">                &quot;NoncurrentDays&quot;: 1</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Filter&quot;: &#123;</span><br><span class="line">                &quot;Prefix&quot;: &quot;logs/60days/&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Expiration&quot;: &#123;</span><br><span class="line">                &quot;Days&quot;: 60</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AbortIncompleteMultipartUpload&quot;: &#123;</span><br><span class="line">                &quot;DaysAfterInitiation&quot;: 7</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ID&quot;: &quot;logs_delete_60days_before&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Status&quot;: &quot;Enabled&quot;,</span><br><span class="line">            &quot;NoncurrentVersionExpiration&quot;: &#123;</span><br><span class="line">                &quot;NoncurrentDays&quot;: 1</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Filter&quot;: &#123;</span><br><span class="line">                &quot;Prefix&quot;: &quot;logs/90days/&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Expiration&quot;: &#123;</span><br><span class="line">                &quot;Days&quot;: 90</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;AbortIncompleteMultipartUpload&quot;: &#123;</span><br><span class="line">                &quot;DaysAfterInitiation&quot;: 7</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ID&quot;: &quot;logs_delete_90days_before&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aws </tag>
            
            <tag> s3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜01å¸¸è§æœ¯è¯­æ¦‚å¿µ</title>
      <link href="posts/aaf9b7/"/>
      <url>posts/aaf9b7/</url>
      
        <content type="html"><![CDATA[<h2 id="ç‰©ç†">ç‰©ç†</h2><ol><li><p>master æ˜¯ k8s çš„ä¸»èŠ‚ç‚¹ï¼Œè´Ÿè´£åè°ƒé›†ç¾¤ä¸­çš„æ‰€æœ‰æ´»åŠ¨ï¼Œä¾‹å¦‚è°ƒåº¦åº”ç”¨ç¨‹åºã€ç»´æŠ¤åº”ç”¨ç¨‹åºçš„æ‰€éœ€çŠ¶æ€ã€æ‰©å±•åº”ç”¨ç¨‹åºå’Œæ»šåŠ¨æ›´æ–°ã€‚</p></li><li><p>node æ˜¯ k8s çš„å·¥ä½œèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å®é™…è·‘å®¹å™¨çš„èŠ‚ç‚¹ã€‚</p></li></ol><h2 id="æœåŠ¡">æœåŠ¡</h2><p>master èŠ‚ç‚¹æœåŠ¡</p><ol><li>kube-apiserver æ˜¯masterèŠ‚ç‚¹æœåŠ¡ï¼Œ æ˜¯k8s çš„ api æœåŠ¡ï¼Œæ˜¯é›†ç¾¤å…¥å£ï¼Œæä¾› http rset æœåŠ¡ã€‚</li><li>kube-controller-manager æ˜¯masterèŠ‚ç‚¹æœåŠ¡ï¼Œç»´æŠ¤é›†ç¾¤çŠ¶æ€ï¼ˆæ•…éšœæ£€æµ‹/æ»šåŠ¨å‡çº§/nodeæ‰©å±•ç­‰ï¼‰ï¼Œæ˜¯é›†ç¾¤æ‰€æœ‰èµ„æºå¯¹è±¡çš„è‡ªåŠ¨åŒ–ä¸­å¿ƒã€‚</li><li>kube-scheduler æ˜¯è´Ÿè´£ pod çš„è°ƒåº¦, å³å¦‚ä½•å°†podåˆ†å‘åˆ°node</li><li>etcd æ³¨å†Œä¸­å¿ƒï¼Œä¿å­˜é›†ç¾¤çŠ¶æ€ã€‚</li></ol><p>node èŠ‚ç‚¹æœåŠ¡</p><ol><li><p>kubelet æ˜¯èŠ‚ç‚¹ä»£ç†ç¨‹åºï¼Œéƒ¨ç½²åœ¨ node ä¸Šã€‚å®ƒæ˜¯k8s masterå’Œk8s nodeä¹‹é—´çš„çº½å¸¦ã€‚å¤„ç† pod åˆ›å»º/å¯åŠ¨/ç›‘æ§/é‡å¯/é”€æ¯ç­‰å·¥ä½œã€‚</p><p>å¼€å¯ register-node = true çš„æƒ…å†µä¸‹ ä¼šè‡ªåŠ¨å‘ apiserver æœåŠ¡æ³¨å†Œè‡ªå·±ã€‚</p></li><li><p>kube-proxy æ˜¯å®ç°nodeèŠ‚ç‚¹ä¸Šå„èµ„æºçš„é€šä¿¡</p></li></ol><h2 id="èµ„æº">èµ„æº</h2><ol><li><p>Namespace</p><p>å‘½åç©ºé—´æ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œèµ·åˆ°äº†éš”ç¦»ä½œç”¨ã€‚é€šè¿‡å®ƒï¼Œä½ å¯ä»¥æ‰¾åˆ°å®ƒå†…éƒ¨çš„å…¶å®ƒèµ„æºå¯¹è±¡ï¼Œä¾‹å¦‚ podï¼Œsvcï¼Œdeploymentç­‰</p></li><li><p>Pod</p><p>pod å†…åŒ…å«å¤šä¸ªå®¹å™¨ï¼Œæ‰€ä»¥å¤šä¸ªå®¹å™¨å…±äº«ä»¥ä¸‹èµ„æºã€‚</p><ul><li>PIDå‘½åç©ºé—´: podå†…çš„è¿›ç¨‹èƒ½äº’ç›¸çœ‹åˆ°PID</li><li>ç½‘ç»œå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªip (å”¯ä¸€)</li><li>IPCå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡</li><li>UTSå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªä¸»æœºå (å”¯ä¸€)</li><li>å­˜å‚¨å·: podå¤šä¸ªå®¹å™¨å¯ä»¥å…±åŒè®¿é—®podå®šä¹‰çš„å­˜å‚¨å·</li></ul></li><li><p>Label</p><p>labelç”¨äºè¡¨ç¤ºèµ„æºï¼Œä»è€Œæ–¹ä¾¿çš„è¢«å…¶å®ƒèµ„æºæ‰¾åˆ°ã€‚å®ƒå¾ˆé‡è¦ã€‚</p><p>æ ‡ç­¾å®šä¹‰ <code>key: value</code></p><p>é€‰æ‹©å™¨: <code>key &lt;= !=&gt; value</code>  <code>key &lt;not&gt; in (value1, value2)</code></p><p>RC å’Œ Service é€šè¿‡ selector é€‰æ‹©å™¨æ¥é€‰æ‹© Pod å¯¹è±¡èŒƒå›´, ä»è€Œç²¾ç»†åŒ–çš„å°† Pod è¿›è¡Œåˆ†ç»„ã€‚</p></li><li><p>Deployment</p><p>æ— çŠ¶æ€å‰¯æœ¬é›†ã€‚ç”¨æ¥éƒ¨ç½²ä¸€ä¸ª pod ç»„ï¼Œå®ƒé€šè¿‡ ReplicaSet æ¥è¿›è¡Œç¼©æ”¾ï¼Œ å¹¶éœ€è¦ pod æ¨¡æ¿åˆ›å»º podï¼Œ éœ€è¦ Label ç›‘æ§ podã€‚Deployment é€šè¿‡ RC ä¸¥æ ¼æ‰§è¡Œé…ç½®æ‰€å®šä¹‰çš„podå‰¯æœ¬æ•°é‡ã€‚å¯ä»¥æ¯”å–»ä¸º aws çš„ç›®æ ‡ç»„æˆ–è€…nginxçš„upstreamç»„ã€‚</p></li><li><p>Satefulset</p><p>æœ‰çŠ¶æ€å‰¯æœ¬é›†ã€‚</p></li><li><p>Service</p><p>svc ç”¨æ¥æ„å»ºä¸€ä¸ªè´Ÿè½½é…ç½®ã€‚å¯ä»¥æ¯”å–»ä¸ºawsçš„elbå†…ç½‘è´Ÿè½½å‡è¡¡å™¨æˆ–è€…nginxçš„service proxyé…ç½®ã€‚</p><p>svc é€šè¿‡ pod å®šä¹‰çš„ label å‘ç°ä¸€ç»„ podã€‚è¿™äº› pod æœ¬èº«æœ‰ endpoint åœ°å€ã€‚</p><p>svc åˆ›å»ºåï¼Œä¼šæ‹¿åˆ°ä¸€ä¸ªé›†ç¾¤å†…éƒ¨ipå’Œdnsã€‚kube-proxy æœåŠ¡ä¼šå°† svc çš„ ip å’Œ pod çš„ endpoint åœ°å€å…³è”èµ·æ¥ã€‚</p><p>æœ€ç»ˆï¼Œå…¶å®ƒå®¹å™¨å¯ä»¥é€šè¿‡è¿™ä¸ªipå’Œdnsæ¥è®¿é—®svcå…³è”çš„podèµ„æºã€‚</p></li><li><p>Ingress</p><p>æ˜ å°„ä¸€ä¸ªç«¯å£åˆ°å®¿ä¸»ipï¼Œæä¾›æœåŠ¡çš„å¤–éƒ¨è®¿é—®</p></li></ol><h2 id="æœåŠ¡ç»„ä»¶æµç¨‹å›¾">æœåŠ¡ç»„ä»¶æµç¨‹å›¾</h2><blockquote><ul><li>apiserver è´Ÿè´£ etcd å­˜å‚¨çš„æ‰€æœ‰æ“ä½œï¼Œä¸”åªæœ‰ apiserver æ‰ç›´æ¥æ“ä½œ etcd é›†ç¾¤</li><li>apiserver å¯¹å†…ï¼ˆé›†ç¾¤ä¸­çš„å…¶ä»–ç»„ä»¶ï¼‰å’Œå¯¹å¤–ï¼ˆç”¨æˆ·ï¼‰æä¾›ç»Ÿä¸€çš„ REST APIï¼Œå…¶ä»–ç»„ä»¶å‡é€šè¿‡ apiserver è¿›è¡Œé€šä¿¡<ul><li>controller managerã€schedulerã€kube-proxy å’Œ kubelet ç­‰å‡é€šè¿‡ apiserver watch API ç›‘æµ‹èµ„æºå˜åŒ–æƒ…å†µï¼Œå¹¶å¯¹èµ„æºä½œç›¸åº”çš„æ“ä½œ</li><li>æ‰€æœ‰éœ€è¦æ›´æ–°èµ„æºçŠ¶æ€çš„æ“ä½œå‡é€šè¿‡ apiserver çš„ REST API è¿›è¡Œ</li></ul></li><li>apiserver ä¹Ÿä¼šç›´æ¥è°ƒç”¨ kubelet APIï¼ˆå¦‚ logs, exec, attach ç­‰ï¼‰ï¼Œé»˜è®¤ä¸æ ¡éªŒ kubelet è¯ä¹¦ï¼Œä½†å¯ä»¥é€šè¿‡ <code>--kubelet-certificate-authority</code> å¼€å¯ï¼ˆè€Œ GKE é€šè¿‡ SSH éš§é“ä¿æŠ¤å®ƒä»¬ä¹‹é—´çš„é€šä¿¡ï¼‰</li></ul></blockquote><p><img src="/posts/aaf9b7/image-20200823102314477.png" alt="image-20200823102314477"></p><p><img src="/posts/aaf9b7/image-20200823103640732.png" alt="image-20200823103640732"></p><blockquote><p>ä»¥ä¸€ä¸ªpodçš„æ„å»ºä¸ºä¾‹:</p><ul><li>ç”¨æˆ·é€šè¿‡ REST API åˆ›å»ºä¸€ä¸ª Pod</li><li>apiserver å°†å…¶å†™å…¥ etcd</li><li>scheduluer æ£€æµ‹åˆ°æœªç»‘å®š Node çš„ Podï¼Œå¼€å§‹è°ƒåº¦å¹¶æ›´æ–° Pod çš„ Node ç»‘å®š</li><li>kubelet æ£€æµ‹åˆ°æœ‰æ–°çš„ Pod è°ƒåº¦è¿‡æ¥ï¼Œé€šè¿‡ container runtime è¿è¡Œè¯¥ Pod</li><li>kubelet é€šè¿‡ container runtime å–åˆ° Pod çŠ¶æ€ï¼Œå¹¶æ›´æ–°åˆ° apiserver ä¸­</li></ul></blockquote><p><img src="/posts/aaf9b7/image-20200823102430144.png" alt="image-20200823102430144"></p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜5.7å®¹å™¨åŸºæœ¬æ­å»º</title>
      <link href="posts/b824edd8/"/>
      <url>posts/b824edd8/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /<span class="built_in">export</span>/docker-data-mysql/&#123;config,logs,data&#125;</span><br><span class="line">docker run --name mysql57 \</span><br><span class="line">-p 3306:3306 \</span><br><span class="line">--restart=always \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-mysql/config,dst=/etc/mysql&#x27;</span> \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-mysql/logs,dst=/var/log/mysql&#x27;</span> \</span><br><span class="line">--mount <span class="string">&#x27;type=bind,src=/export/docker-data-mysql/data,dst=/var/lib/mysql&#x27;</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">-d mysql:5.7</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx â˜ æ³›åŸŸå_å˜é‡æˆªå–</title>
      <link href="posts/78ceb386/"/>
      <url>posts/78ceb386/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    listen       [::]:80;</span><br><span class="line">    server_name ~^(?&lt;userName&gt;.*)\.apple\.com\.cn$;</span><br><span class="line">    root /<span class="built_in">export</span>/webapps/apple.com/<span class="variable">$userName</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#å¼€å¯æµè§ˆå™¨é™æ€æ–‡ä»¶ç¼“å­˜</span></span><br><span class="line">    location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)$ &#123;</span><br><span class="line">        expires      3h;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># https://&lt;username&gt;.apple.com/api -&gt; /export/webapps/apple.com/api.php #####</span></span><br><span class="line">    location ~* ^/(api|event_api)$ &#123;</span><br><span class="line">        root /<span class="built_in">export</span>/webapps/apple.com;</span><br><span class="line">        rewrite ^/(.*)$ /<span class="variable">$1</span>.php <span class="built_in">break</span>;</span><br><span class="line">        fastcgi_pass     127.0.0.1:9001;</span><br><span class="line">        fastcgi_index    index.php;</span><br><span class="line">        include      fastcgi.conf;</span><br><span class="line">        fastcgi_connect_timeout    600s;</span><br><span class="line">        fastcgi_send_timeout       600s;</span><br><span class="line">        fastcgi_read_timeout       600s;</span><br><span class="line">        fastcgi_buffers 8 256k;</span><br><span class="line">        fastcgi_buffer_size 256k;</span><br><span class="line">        fastcgi_busy_buffers_size 256k;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># https://&lt;username&gt;.apple.com/&lt;uri&gt; -&gt; /export/webapps/apple.com/&lt;username&gt;/&lt;uri&gt;.php</span></span><br><span class="line">    location ~* ^/[0-9a-zA-Z]+$ &#123;</span><br><span class="line">        rewrite ^/(.*)$ /<span class="variable">$1</span>.php <span class="built_in">break</span>;</span><br><span class="line">        fastcgi_pass     127.0.0.1:9001;</span><br><span class="line">        fastcgi_index    index.php;</span><br><span class="line">        include      fastcgi.conf;</span><br><span class="line">        fastcgi_connect_timeout    600s;</span><br><span class="line">        fastcgi_send_timeout       600s;</span><br><span class="line">        fastcgi_read_timeout       600s;</span><br><span class="line">        fastcgi_buffers 8 256k;</span><br><span class="line">        fastcgi_buffer_size 256k;</span><br><span class="line">        fastcgi_busy_buffers_size 256k;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>location ä¼˜å…ˆçº§ä»ä¸Šå¾€ä¸‹ä¾æ¬¡é€’å‡ï¼š<br>location =      ä»…åŒ¹é…å­—ç¬¦ä¸²è‡ªèº«<br>location ^~    åŒ¹é…æŸä¸ªå­—ç¬¦ä¸²å¼€å¤´çš„uri<br>location ~      æ­£åˆ™åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™<br>location ~*    æ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™<br>location /      è¡¨ç¤ºåŒ¹é…â€œåŸŸå/ä¹‹åçš„uriâ€ï¼Œå†æ¯”å¦‚localtion /imagesï¼Œè¡¨ç¤ºåŒ¹é…â€œåŸŸå/imagesä¹‹åçš„uri</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…è„šæœ¬â˜phpç¼–è¯‘æ–¹å¼</title>
      <link href="posts/3321a2dc/"/>
      <url>posts/3321a2dc/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ç”¨äºç¼–è¯‘å®‰è£…php7.1</p><h4 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h4><p>æ ¹ç›®å½•ï¼š/usr/local/php<br>æ—¥å¿—ç›®å½•ï¼š/usr/local/php/var/log -&gt; /export/logs/php</p><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># è„šæœ¬, é€‚ç”¨äº php 7.1</span></span><br><span class="line">basedir=/usr/<span class="built_in">local</span>/src</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$basedir</span></span><br><span class="line">runuser=`whoami`</span><br><span class="line">[[ <span class="variable">$runuser</span> == <span class="string">&#x27;root&#x27;</span> ]] || &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ERROR:æ‰§è¡Œç”¨æˆ·ä¸æ˜¯<span class="variable">$runuser</span>&quot;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒ</span></span><br><span class="line">[[ -d /<span class="built_in">export</span>/logs/php ]] || &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;/export/logs/phpç›®å½•ä¸å­˜åœ¨&quot;</span> &amp;&amp; <span class="built_in">exit</span></span><br><span class="line">&#125;</span><br><span class="line">yum install libmcrypt-devel ncurses-devel recode-devel aspell-devel curl-devel readline-devel openldap-devel enchant-devel pcre-devel net-snmp-devel libicu-devel libtool-ltdl-devel libjpeg-devel libpng-devel libxml2-devel bzip2-devel freetype-devel gcc-c++ mysql-devel</span><br><span class="line">cp -p /usr/lib64/libldap* /usr/lib</span><br><span class="line">ln -s /usr/lib64/mysql /usr/lib/mysql</span><br><span class="line">wget http://sg2.php.net/distributions/php-7.1.25.tar.gz -O php.tar.gz</span><br><span class="line">rm -rf php &amp;&amp; mkdir php</span><br><span class="line">tar xf php.tar.gz --strip-components 1 -C php</span><br><span class="line"><span class="built_in">cd</span> php &amp;&amp; ./configure --prefix=/usr/<span class="built_in">local</span>/php --with-config-file-path=/usr/<span class="built_in">local</span>/php/etc --with-config-file-scan-dir=/usr/<span class="built_in">local</span>/php/etc/php.d --with-curl --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl --enable-mbstring --with-freetype-dir --with-jpeg-dir --with-png-dir --with-gd --with-libxml-dir --with-zlib --with-mcrypt --with-bz2 --enable-sysvshm --enable-sysvsem --enable-soap --with-recode --with-snmp --with-readline --enable-intl --enable-dba --enable-bcmath --with-enchant --with-pspell --enable-xml --enable-sockets --enable-exif --enable-inline-optimization --enable-fpm || <span class="built_in">exit</span></span><br><span class="line">make &amp;&amp; make install || <span class="built_in">exit</span></span><br><span class="line">cp sapi/fpm/init.d.php-fpm /etc/rc.d/init.d/php-fpm</span><br><span class="line">chkconfig --add php-fpm</span><br><span class="line">chkconfig php-fpm off</span><br><span class="line">chmod u+x /etc/rc.d/init.d/php-fpm</span><br><span class="line">cp php.ini-production /usr/<span class="built_in">local</span>/php/etc/php.ini</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/php/var &amp;&amp; rm -rf <span class="built_in">log</span></span><br><span class="line">ln -s /<span class="built_in">export</span>/logs/php <span class="built_in">log</span></span><br><span class="line">cat&gt;&gt;/usr/<span class="built_in">local</span>/php/etc/php.ini&lt;&lt;EOF</span><br><span class="line">; å…³é—­phpæ— ç”¨æ—¥å¿—ä¿¡æ¯</span><br><span class="line">error_reporting = E_COMPILE_ERROR|E_RECOVERABLE_ERROR|E_ERROR|E_CORE_ERROR</span><br><span class="line">; å¼€å¯php opcache ç¼“å­˜åŠŸèƒ½</span><br><span class="line">[opcache]</span><br><span class="line">zend_extension=opcache.so</span><br><span class="line">; å¯åŠ¨æ“ä½œç ç¼“å­˜</span><br><span class="line">opcache.enable=1</span><br><span class="line">; é’ˆå¯¹æ”¯æŒCLIç‰ˆæœ¬PHPå¯åŠ¨æ“ä½œç ç¼“å­˜ ä¸€èˆ¬è¢«ç”¨æ¥æµ‹è¯•å’Œè°ƒè¯•</span><br><span class="line">opcache.enable_cli=0</span><br><span class="line">; å…±äº«å†…å­˜å¤§å°ï¼Œå•ä½ä¸ºMB</span><br><span class="line">opcache.memory_consumption=128</span><br><span class="line">; å­˜å‚¨ä¸´æ—¶å­—ç¬¦ä¸²ç¼“å­˜å¤§å°ï¼Œå•ä½ä¸ºMBï¼ŒPHP5.3.0ä»¥å‰ä¼šå¿½ç•¥æ­¤é¡¹é…ç½®</span><br><span class="line">opcache.interned_strings_buffer=8</span><br><span class="line">; ç¼“å­˜æ–‡ä»¶æ•°æœ€å¤§é™åˆ¶ï¼Œå‘½ä¸­ç‡ä¸åˆ°100%ï¼Œå¯ä»¥è¯•ç€æé«˜è¿™ä¸ªå€¼</span><br><span class="line">opcache.max_accelerated_files=4000</span><br><span class="line">; ä¸€å®šæ—¶é—´å†…æ£€æŸ¥æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´, è¿™é‡Œè®¾ç½®æ£€æŸ¥çš„æ—¶é—´å‘¨æœŸ, é»˜è®¤ä¸º 2, å•ä½ä¸ºç§’</span><br><span class="line">opcache.revalidate_freq=60</span><br><span class="line">; å¼€å¯å¿«é€Ÿåœæ­¢ç»­å‘äº‹ä»¶ï¼Œä¾èµ–äºZendå¼•æ“çš„å†…å­˜ç®¡ç†æ¨¡å—ï¼Œä¸€æ¬¡é‡Šæ”¾å…¨éƒ¨è¯·æ±‚å˜é‡çš„å†…å­˜ï¼Œè€Œä¸æ˜¯ä¾æ¬¡é‡Šæ”¾å†…å­˜å—</span><br><span class="line">opcache.fast_shutdown=1</span><br><span class="line">;å¯ç”¨æ£€æŸ¥ PHP è„šæœ¬å­˜åœ¨æ€§å’Œå¯è¯»æ€§çš„åŠŸèƒ½ï¼Œæ— è®ºæ–‡ä»¶æ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œéƒ½ä¼šæ£€æŸ¥æ“ä½œç ç¼“å­˜,å¯ä»¥æå‡æ€§èƒ½ã€‚ ä½†æ˜¯å¦‚æœç¦ç”¨äº† opcache.validate_timestampsé€‰é¡¹ï¼Œ å¯èƒ½å­˜åœ¨è¿”å›è¿‡æ—¶æ•°æ®çš„é£é™©ã€‚</span><br><span class="line">opcache.enable_file_override=1</span><br><span class="line">EOF</span><br><span class="line">cat&gt;&gt;/usr/<span class="built_in">local</span>/php/etc/php-fpm.conf&lt;&lt;EOF</span><br><span class="line">[global]</span><br><span class="line">log_level =error</span><br><span class="line">daemonize = yes</span><br><span class="line">events.mechanism = epoll</span><br><span class="line">rlimit_files = 10240</span><br><span class="line">emergency_restart_threshold = 60</span><br><span class="line">emergency_restart_interval = 60s</span><br><span class="line"></span><br><span class="line">[fcgi]</span><br><span class="line">user = webapps</span><br><span class="line">group = webapps</span><br><span class="line">listen = 0.0.0.0:9000</span><br><span class="line">pm = static</span><br><span class="line">pm.max_children = 100</span><br><span class="line">pm.max_requests = 1024</span><br><span class="line">request_slowlog_timeout = 1s</span><br><span class="line">slowlog = /usr/<span class="built_in">local</span>/php/var/<span class="built_in">log</span>/php-slow.log</span><br><span class="line">pm.status_path = /php-fpm_status</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>php-fpm â˜ é™æ€é…ç½®</title>
      <link href="posts/d1d65c30/"/>
      <url>posts/d1d65c30/</url>
      
        <content type="html"><![CDATA[<blockquote><p>QPS 800-1000</p><p>2*4 æœºå™¨</p></blockquote><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[www01]</span></span><br><span class="line"><span class="attr">user</span> = webapps</span><br><span class="line"><span class="attr">group</span> = webapps</span><br><span class="line"><span class="attr">listen</span> = /usr/local/php/var/log/php-fpm-www01.sock</span><br><span class="line"><span class="attr">listen.owner</span> = webapps</span><br><span class="line"><span class="attr">listen.group</span> = webapps</span><br><span class="line"><span class="attr">listen.backlog</span> = <span class="number">10240</span></span><br><span class="line"><span class="attr">listen.mode</span> = <span class="number">0666</span></span><br><span class="line"><span class="attr">listen.allowed_clients</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">pm</span> = static</span><br><span class="line"><span class="attr">pm.max_children</span> = <span class="number">300</span></span><br><span class="line"><span class="attr">pm.max_requests</span> = <span class="number">1024</span></span><br><span class="line"><span class="attr">request_slowlog_timeout</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">request_terminate_timeout</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">slowlog</span> = /usr/local/php/var/log/php-slow.log</span><br><span class="line"><span class="attr">pm.status_path</span> = /php-fpm_status</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php </tag>
            
            <tag> php-fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…è„šæœ¬â˜openvpn-dockeræ–¹å¼</title>
      <link href="posts/7c1abbe1/"/>
      <url>posts/7c1abbe1/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>openvpn ä¸€èˆ¬ç”¨äºå°å…¬å¸è¿œç¨‹è¿æ¥å…¬å¸åŠå…¬ç½‘ç»œç¯å¢ƒï¼Œæ­¤è„šæœ¬éœ€è¦ä¸€ä¸ªlinuxç³»ç»Ÿçš„ä¸»æœºã€‚<br>è‡³äºåœŸè±ªå…¬å¸ï¼Œå¯ä»¥æ— è§†ã€‚<br>æ–‡æ¡£åŒ…å«å®‰è£…è„šæœ¬ï¼Œåˆ›å»ºç”¨æˆ·è„šæœ¬ï¼Œåˆ é™¤ç”¨æˆ·è„šæœ¬ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œå®‰è£…è„šæœ¬å’Œåˆ›å»ºç”¨æˆ·è„šæœ¬ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹ä¸€äº›å˜é‡ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‘ç°ç§»åŠ¨ç½‘ç»œè¿æ¥å…¶å®ƒè¿è¥å•†ç½‘ç»œçš„æ—¶å€™ï¼Œä¸ç¨³å®šã€‚<br>æ¯”å¦‚æˆ‘è¿™è¾¹ï¼Œç§»åŠ¨ç½‘ç»œè¿æ¥ç”µä¿¡ç½‘ç»œï¼ˆopenvpnæ‰€åœ¨ç½‘ç»œï¼‰ï¼Œå°±å®¹æ˜“ä¸¢åŒ…ã€‚</p></blockquote><h4 id="å®‰è£…è„šæœ¬">å®‰è£…è„šæœ¬</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install docker</span><br><span class="line">docker pull kylemanna&#x2F;openvpn</span><br><span class="line">OVPN_DATA&#x3D;&quot;&#x2F;root&#x2F;ovpn-data&quot;</span><br><span class="line">IP&#x3D;&quot;æœºå™¨å¤–ç½‘ipæˆ–è€…natåçš„å†…ç½‘ip&quot;  # è‡ªè¡Œä¿®æ”¹</span><br><span class="line">mkdir $&#123;OVPN_DATA&#125;</span><br><span class="line">docker run -v $&#123;OVPN_DATA&#125;:&#x2F;etc&#x2F;openvpn --rm kylemanna&#x2F;openvpn ovpn_genconfig -u tcp:&#x2F;&#x2F;$&#123;IP&#125;</span><br><span class="line">docker run -v $&#123;OVPN_DATA&#125;:&#x2F;etc&#x2F;openvpn --rm -it kylemanna&#x2F;openvpn ovpn_initpki</span><br><span class="line">docker run -v $&#123;OVPN_DATA&#125;:&#x2F;etc&#x2F;openvpn --rm -it kylemanna&#x2F;openvpn easyrsa build-client-full CLIENTNAME nopass</span><br><span class="line">docker run -v $&#123;OVPN_DATA&#125;:&#x2F;etc&#x2F;openvpn --rm kylemanna&#x2F;openvpn ovpn_getclient CLIENTNAME &gt; $&#123;OVPN_DATA&#125;&#x2F;CLIENTNAME.ovpn</span><br><span class="line">docker run --name openvpn -v $&#123;OVPN_DATA&#125;:&#x2F;etc&#x2F;openvpn -d -p 1194:1194 --privileged kylemanna&#x2F;openvpn</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºç”¨æˆ·è„šæœ¬">åˆ›å»ºç”¨æˆ·è„šæœ¬</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"># å¦‚æœæ˜¯natåçš„å†…ç½‘ipï¼Œåˆ™éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œçš„ipä¸ºå¤–ç½‘ip</span><br><span class="line"># bash xxx.sh &lt;ç”¨æˆ·å&gt;</span><br><span class="line">[[ -z $1 ]] &amp;&amp; exit</span><br><span class="line">CLIENTNAME&#x3D;$1</span><br><span class="line">#read -p &#39;è¾“å…¥ç”¨æˆ·åï¼ˆå­—æ¯ç»„æˆï¼‰:&#39; CLIENTNAME</span><br><span class="line">OVPN_DATA&#x3D;&quot;&#x2F;root&#x2F;ovpn-data&quot;</span><br><span class="line">docker run -v $&#123;OVPN_DATA&#125;:&#x2F;etc&#x2F;openvpn --rm -it kylemanna&#x2F;openvpn easyrsa build-client-full $&#123;CLIENTNAME&#125; nopass</span><br><span class="line">docker run -v $&#123;OVPN_DATA&#125;:&#x2F;etc&#x2F;openvpn --rm kylemanna&#x2F;openvpn ovpn_getclient $CLIENTNAME &gt; $&#123;OVPN_DATA&#125;&#x2F;$&#123;CLIENTNAME&#125;.ovpn</span><br><span class="line">sed -i &#39;1a comp-lzo&#39; $&#123;OVPN_DATA&#125;&#x2F;$&#123;CLIENTNAME&#125;.ovpn</span><br><span class="line">sed -i &#39;2a tun-mtu 1500&#39; $&#123;OVPN_DATA&#125;&#x2F;$&#123;CLIENTNAME&#125;.ovpn</span><br><span class="line">sed -i &#39;3a auth-nocache&#39; $&#123;OVPN_DATA&#125;&#x2F;$&#123;CLIENTNAME&#125;.ovpn</span><br><span class="line">sed -i &quot;s&#x2F;$&#123;æœ¬æœºip&#125;&#x2F;$&#123;å¤–ç½‘ip&#125;&#x2F;&quot; $&#123;OVPN_DATA&#125;&#x2F;$&#123;CLIENTNAME&#125;.ovpn  # è‹¥ä¸ºnatç¯å¢ƒï¼Œè‡ªè¡Œä¿®æ”¹ï¼Œè‹¥ä¸æ˜¯natç¯å¢ƒï¼Œæ³¨é‡Šæ‰æœ¬è¡Œ</span><br><span class="line">mkdir -pv $&#123;OVPN_DATA&#125;&#x2F;users&#x2F;$&#123;CLIENTNAME&#125;</span><br><span class="line">mv &#x2F;root&#x2F;ovpn-data&#x2F;pki&#x2F;private&#x2F;$&#123;CLIENTNAME&#125;.key $&#123;OVPN_DATA&#125;&#x2F;users&#x2F;$&#123;CLIENTNAME&#125;</span><br><span class="line">mv &#x2F;root&#x2F;ovpn-data&#x2F;pki&#x2F;issued&#x2F;$&#123;CLIENTNAME&#125;.crt $&#123;OVPN_DATA&#125;&#x2F;users&#x2F;$&#123;CLIENTNAME&#125;</span><br><span class="line">mv $&#123;OVPN_DATA&#125;&#x2F;$&#123;CLIENTNAME&#125;.ovpn $&#123;OVPN_DATA&#125;&#x2F;users&#x2F;$&#123;CLIENTNAME&#125;</span><br><span class="line">cd $&#123;OVPN_DATA&#125;&#x2F;users&#x2F;</span><br><span class="line">tar zcf $&#123;CLIENTNAME&#125;.tar.gz $&#123;CLIENTNAME&#125;</span><br><span class="line">sz $&#123;CLIENTNAME&#125;.tar.gz</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤ç”¨æˆ·è„šæœ¬">åˆ é™¤ç”¨æˆ·è„šæœ¬</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"># bash xxx.sh &lt;ç”¨æˆ·å&gt;</span><br><span class="line">[[ -z $1 ]] &amp;&amp; exit</span><br><span class="line">CLIENTNAME&#x3D;$1</span><br><span class="line">#read -p &#39;è¾“å…¥ç”¨æˆ·åï¼ˆå­—æ¯ç»„æˆï¼‰:&#39; CLIENTNAME</span><br><span class="line">OVPN_DATA&#x3D;&quot;&#x2F;root&#x2F;ovpn-data&quot;</span><br><span class="line">rm -rf &#x2F;root&#x2F;ovpn-data&#x2F;pki&#x2F;private&#x2F;$&#123;CLIENTNAME&#125;.key*</span><br><span class="line">rm -rf &#x2F;root&#x2F;ovpn-data&#x2F;pki&#x2F;reqs&#x2F;$&#123;CLIENTNAME&#125;.req</span><br><span class="line">rm -rf &#x2F;root&#x2F;ovpn-data&#x2F;pki&#x2F;issued&#x2F;$&#123;CLIENTNAME&#125;.crt</span><br><span class="line">sed -i &quot;&#x2F;$&#123;CLIENTNAME&#125;&#x2F;d&quot; &#x2F;root&#x2F;ovpn-data&#x2F;pki&#x2F;index.txt</span><br><span class="line">cd &#x2F;root&#x2F;ovpn-data&#x2F;users</span><br><span class="line">rm -rf $&#123;CLIENTNAME&#125;</span><br><span class="line">rm -f $&#123;CLIENTNAME&#125;.tar.gz</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> openvpn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜è°ƒæ•´å†…æ ¸å‚æ•°</title>
      <link href="posts/28361833/"/>
      <url>posts/28361833/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>redis å†…å­˜å ç”¨çˆ†ç‚¸. æ‰€ä»¥ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ª</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">author: yangyi@youzan.com</span></span><br><span class="line"><span class="string">time: 2018/4/26 ä¸‹åˆ4:34</span></span><br><span class="line"><span class="string">func: è·å–æ•°æ®åº“ä¸­æ²¡æœ‰è®¾ç½®ttlçš„ key</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShowProcess</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ˜¾ç¤ºå¤„ç†è¿›åº¦çš„ç±»</span></span><br><span class="line"><span class="string">    è°ƒç”¨è¯¥ç±»ç›¸å…³å‡½æ•°å³å¯å®ç°å¤„ç†è¿›åº¦çš„æ˜¾ç¤º</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    i = <span class="number">0</span> <span class="comment"># å½“å‰çš„å¤„ç†è¿›åº¦</span></span><br><span class="line">    max_steps = <span class="number">0</span> <span class="comment"># æ€»å…±éœ€è¦å¤„ç†çš„æ¬¡æ•°</span></span><br><span class="line">    max_arrow = <span class="number">100</span> <span class="comment"># è¿›åº¦æ¡çš„é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–å‡½æ•°ï¼Œéœ€è¦çŸ¥é“æ€»å…±çš„å¤„ç†æ¬¡æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, max_steps</span>):</span></span><br><span class="line">        self.max_steps = max_steps</span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ˜¾ç¤ºå‡½æ•°ï¼Œæ ¹æ®å½“å‰çš„å¤„ç†è¿›åº¦iæ˜¾ç¤ºè¿›åº¦</span></span><br><span class="line">    <span class="comment"># æ•ˆæœä¸º[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]100.00%</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_process</span>(<span class="params">self, i = None</span>):</span></span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.i = i</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.i += <span class="number">1</span></span><br><span class="line">        num_arrow = int(self.i * self.max_arrow / self.max_steps) <span class="comment"># è®¡ç®—æ˜¾ç¤ºå¤šå°‘ä¸ª&#x27;&gt;&#x27;</span></span><br><span class="line">        num_line = self.max_arrow - num_arrow <span class="comment"># è®¡ç®—æ˜¾ç¤ºå¤šå°‘ä¸ª&#x27;-&#x27;</span></span><br><span class="line">        percent = self.i * <span class="number">100.0</span> / self.max_steps <span class="comment"># è®¡ç®—å®Œæˆè¿›åº¦ï¼Œæ ¼å¼ä¸ºxx.xx%</span></span><br><span class="line">        process_bar = <span class="string">&#x27;[&#x27;</span> + <span class="string">&#x27;&gt;&#x27;</span> * num_arrow + <span class="string">&#x27; &#x27;</span> * num_line + <span class="string">&#x27;]&#x27;</span>\</span><br><span class="line">                      + <span class="string">&#x27;%.2f&#x27;</span> % percent + <span class="string">&#x27;%&#x27;</span> + <span class="string">&#x27;\r&#x27;</span> <span class="comment"># å¸¦è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼Œ&#x27;\r&#x27;è¡¨ç¤ºä¸æ¢è¡Œå›åˆ°æœ€å·¦è¾¹</span></span><br><span class="line">        sys.stdout.write(process_bar) <span class="comment"># è¿™ä¸¤å¥æ‰“å°å­—ç¬¦åˆ°ç»ˆç«¯</span></span><br><span class="line">        sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self, words=<span class="string">&#x27;done&#x27;</span></span>):</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">print</span> words</span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_ttl</span>(<span class="params">redis_conn, no_ttl_file, dbindex</span>):</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    no_ttl_num = <span class="number">0</span></span><br><span class="line">    keys_num = redis_conn.dbsize()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;there are &#123;num&#125; keys in db &#123;index&#125; &quot;</span>.format(num=keys_num, index=dbindex)</span><br><span class="line">    process_bar = ShowProcess(keys_num)</span><br><span class="line">    <span class="keyword">with</span> open(no_ttl_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> redis_conn.scan_iter(count=<span class="number">1000</span>):</span><br><span class="line">            process_bar.show_process()</span><br><span class="line">            <span class="keyword">if</span> redis_conn.ttl(key) == <span class="number">-1</span>:</span><br><span class="line">                no_ttl_num += <span class="number">1</span></span><br><span class="line">    <span class="comment">#            if no_ttl_num &lt; 1000:</span></span><br><span class="line">                f.write(key+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    process_bar.close()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;cost time(s):&quot;</span>, time.time() - start_time</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;no ttl keys number:&quot;</span>, no_ttl_num</span><br><span class="line">    <span class="keyword">print</span> <span class="string">&quot;we write keys with no ttl to the file: %s&quot;</span> % no_ttl_file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, type=int, dest=<span class="string">&#x27;port&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, help=<span class="string">&#x27;port of redis &#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-d&#x27;</span>, type=str, dest=<span class="string">&#x27;db_list&#x27;</span>, action=<span class="string">&#x27;store&#x27;</span>, default=<span class="number">0</span>,</span><br><span class="line">                        help=<span class="string">&#x27;ex : -d all / -d 1,2,3,4 &#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    port = args.port</span><br><span class="line">    <span class="keyword">if</span> args.db_list == <span class="string">&#x27;all&#x27;</span>:</span><br><span class="line">        db_list = [i <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">16</span>)]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        db_list = [int(i) <span class="keyword">for</span> i <span class="keyword">in</span> args.db_list.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> db_list:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pool = redis.ConnectionPool(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=port, db=index)</span><br><span class="line">            r = redis.StrictRedis(connection_pool=pool)</span><br><span class="line">        <span class="keyword">except</span> redis.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            no_ttl_keys_file = <span class="string">&quot;/tmp/&#123;port&#125;_&#123;db&#125;_no_ttl_keys.txt&quot;</span>.format(port=port, db=index)</span><br><span class="line">            check_ttl(r, no_ttl_keys_file, index)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><ol><li>è¯·å‹¿åœ¨redisæœåŠ¡å™¨ä¸Šæ‰§è¡Œ</li><li>ä¿®æ”¹è„šæœ¬ä¸­ 127.0.0.1 ä¸º redis æœåŠ¡å™¨åœ°å€</li><li>è„šæœ¬æ‰§è¡Œå‘½ä»¤: <code>python nottlkey.py -d all -p 6379  </code></li><li>æ·»åŠ ttlå‘½ä»¤ï¼š<code>cat no_ttl_keys.txt  |  xargs -i -t ./redis-cli -h &lt;redis_ip&gt; -n &lt;database_num&gt; expire &lt;ttl_time&gt;</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜è°ƒæ•´å†…æ ¸å‚æ•°</title>
      <link href="posts/28361833/"/>
      <url>posts/28361833/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä¹‹å‰å®‰è£…å®Œredisï¼Œå¯åŠ¨redisï¼Œæ€»ä¼šå‘Šè¯‰ä½ è®©ä½ é»˜è®¤ä¿®æ”¹ä¸€äº›å‚æ•°ï¼Œä¸çŸ¥å…¶åŸå› ï¼Œä½†æ¯æ¬¡éƒ½æ‹›åŠã€‚<br>åæ¥é‡åˆ°ä¸€äº›rediså†…å­˜ä½¿ç”¨ç´§å¼ çš„æ—¶å€™ï¼Œä»è€Œå¯¼è‡´ redis-bgsave å¤±è´¥ï¼Œå†ä¸€æ¬¡æƒ³åˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚<br>ç»è¿‡æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°å®˜æ–¹æ–‡æ¡£é‡Œå‘Šè¯‰äº†åŸå› ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚å¦‚æœ‰ä¸å¯¹ä¹‹å¤„ï¼Œè¿˜è¯·æŒ‡å‡ºã€‚</p><h4 id="æˆ‘æ˜¯é—®é¢˜">æˆ‘æ˜¯é—®é¢˜</h4><p>redis-bgsaveä¸overcommit_memoryçš„å…³ç³»ã€‚<br>å½“å‰©ä½™ç‰©ç†å†…å­˜ä½äºå½“å‰redisæ‰€ç”¨å†…å­˜çš„æ—¶å€™ï¼Œovercommit_memory=1çš„æ„ä¹‰</p><h4 id="å®˜æ–¹è§£é‡Šåœ¨æ­¤">å®˜æ–¹è§£é‡Šåœ¨æ­¤</h4><blockquote><p><a href="https://redis.io/topics/faq">https://redis.io/topics/faq</a></p></blockquote><h2 id="Background-saving-fails-with-a-fork-error-under-Linux-even-if-I-have-a-lot-of-free-RAM">Background saving fails with a fork() error under Linux even if I have a lot of free RAM!</h2><p>Short answer: : <code>echo 1 &gt; /proc/sys/vm/overcommit_memory</code></p><p>And now the long one:</p><p>Redis background saving schema relies on the copy-on-write semantic of fork in modern operating systems: Redis forks (creates a child process) that is an exact copy of the parent. The child process dumps the DB on disk and finally exits. In theory the child should use as much memory as the parent being a copy, but actually thanks to the copy-on-write semantic implemented by most modern operating systems the parent and child process will <em>share</em> the common memory pages. A page will be duplicated only when it changes in the child or in the parent. Since in theory all the pages may change while the child process is saving, Linux canâ€™t tell in advance how much memory the child will take, so if the setting is set to zero fork will fail unless there is as much free RAM as required to really duplicate all the parent memory pages, with the result that if you have a Redis dataset of 3 GB and just 2 GB of free memory it will fail.<code>overcommit_memory</code></p><p>Setting to 1 tells Linux to relax and perform the fork in a more optimistic allocation fashion, and this is indeed what you want for Redis.<code>overcommit_memory</code></p><p>A good source to understand how Linux Virtual Memory works and other alternatives for and is this classic from Red Hat Magazine, <a href="https://people.redhat.com/nhorman/papers/rhel3_vm.pdf">â€œUnderstanding Virtual Memoryâ€</a>. You can also refer to the <a href="http://man7.org/linux/man-pages/man5/proc.5.html">proc(5)</a> man page for explanations of the available values.<code>overcommit_memory``overcommit_ratio</code></p><h4 id="ç¿»è¯‘åçš„å¤§è‡´æ„æ€">ç¿»è¯‘åçš„å¤§è‡´æ„æ€</h4><p>å®˜æ–¹çš„FAQï¼Œç»™äººä¸€ç§è¿™ä¹ˆä¸ªæ„æ€ã€‚ å¦‚æœä½ ä¸è®¾ç½®overcommit_memory=1ï¼Œé‚£ä¹ˆCOWæœºåˆ¶å°†æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥å½“ç©ºä½™å†…å­˜å°äºå½“å‰rediså ç”¨å†…å­˜æ—¶ï¼Œredis-bgsave å› ä¸ºæ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°†å¯¼è‡´åˆ†é…å†…å­˜å¤±è´¥ã€‚<br>è€ŒCOWæœºåˆ¶çš„æ„æ€å°±æ˜¯ï¼šçˆ¶å­è¿›ç¨‹å…¬ç”¨å†…å­˜é¡µï¼Œå› æ­¤åªä¼šcopyå˜åŒ–çš„æ•°æ®ã€‚å› æ­¤ï¼Œåœ¨COWæœºåˆ¶ä¸‹ï¼Œredis-bgsaveåªéœ€è¦ç”³è¯·åˆ°æ”¯æ’‘å˜åŒ–æ•°æ®çš„å†…å­˜å³å¯ã€‚<br>è‡³äºæ˜¯å¦æ˜¯å› ä¸ºå¯ç”¨ overcommit_memory=1 ä»è€Œä½¿å¾—COWæœºåˆ¶èµ·ä½œç”¨ï¼Œé™äºè¿™æ˜¯å†…æ ¸å±‚é¢çš„ä¸œè¥¿</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>web â˜ ç³»ç»ŸåŸºæœ¬ä¼˜åŒ–</title>
      <link href="posts/f41d0763/"/>
      <url>posts/f41d0763/</url>
      
        <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å†…æ ¸å‚æ•°</span></span><br><span class="line"><span class="comment"># ç³»ç»Ÿçº§åˆ«ä¸Šé™ï¼Œ å³æ•´ä¸ªç³»ç»Ÿæ‰€æœ‰è¿›ç¨‹å•ä½æ—¶é—´å¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡</span></span><br><span class="line">fs.file-max = 6553500</span><br><span class="line"><span class="comment"># ä¸‰æ¬¡æ¡æ‰‹è¯·æ±‚é¢‘æ¬¡</span></span><br><span class="line">net.ipv4.tcp_syn_retries = 5</span><br><span class="line"><span class="comment"># æ”¾å¼ƒå›åº”ä¸€ä¸ªTCPè¯·æ±‚ä¹‹å‰ï¼Œéœ€è¦å°è¯•å¤šå°‘æ¬¡</span></span><br><span class="line">net.ipv4.tcp_retries1 = 3</span><br><span class="line"><span class="comment"># ä¸‰æ¬¡æ¡æ‰‹åº”ç­”é¢‘æ¬¡</span></span><br><span class="line">net.ipv4.tcp_synack_retries = 2</span><br><span class="line"><span class="comment"># ä¸‰æ¬¡æ¡æ‰‹å®Œæ¯•ï¼Œ æ²¡æœ‰æ•°æ®æ²Ÿé€šçš„æƒ…å†µä¸‹ï¼Œ ç©ºè¿æ¥å­˜æ´»æ—¶é—´</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 60</span><br><span class="line"><span class="comment"># æ¢æµ‹æ¶ˆæ¯å‘é€æ¬¡æ•°</span></span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line"><span class="comment"># æ¢æµ‹æ¶ˆæ¯å‘é€é—´éš”æ—¶é—´</span></span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 15</span><br><span class="line">net.ipv4.tcp_retries2 = 5</span><br><span class="line">net.ipv4.tcp_fin_timeout = 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç³»ç»Ÿå¤„ç†ä¸å±äºä»»ä½•è¿›ç¨‹çš„TCPé“¾æ¥</span></span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_max_orphans = 35000</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚</span></span><br><span class="line">net.core.netdev_max_backlog = 10240</span><br><span class="line"><span class="comment"># å¯¹äºè¿˜æœªè·å¾—å¯¹æ–¹ç¡®è®¤çš„è¿æ¥è¯·æ±‚ï¼Œå¯ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­çš„æœ€å¤§æ•°ç›®</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 10240</span><br><span class="line"><span class="comment"># å®šä¹‰äº†ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç«¯å£æœ€å¤§çš„ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦ </span></span><br><span class="line">net.core.somaxconn=10240</span><br><span class="line"></span><br><span class="line"><span class="comment">#æœ€å¤§timewaitæ•°</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 20000</span><br><span class="line">net.ipv4.ip_local_port_range=1024 65500</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯æ—¶é—´æˆ³</span></span><br><span class="line">net.ipv4.tcp_timestamps=1</span><br><span class="line"><span class="comment"># é’ˆå¯¹å®¢æˆ·ç«¯æœ‰æ•ˆï¼Œå¿…é¡»åœ¨å¼€å¯æ—¶é—´æˆ³çš„å‰æä¸‹</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯ iptables åï¼Œ é“¾è·¯è¿½è¸ªä¸Šé™å’Œè¶…æ—¶æ—¶é—´, è‹¥æ²¡æœ‰ä½¿ç”¨ iptablesï¼Œåˆ™æ— æ•ˆ</span></span><br><span class="line">net.netfilter.nf_conntrack_max = 6553500</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 150</span><br><span class="line"></span><br><span class="line"><span class="comment">## tcpæ ˆå†…å­˜ä½¿ç”¨ï¼Œ å•ä½æ˜¯å†…å­˜é¡µï¼Œ ä¸€é¡µ=4KB</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_mem = 524288 786432 1310720</span></span><br><span class="line"><span class="comment">## socketè¯»å†™ç¼“å†²åŒºå¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_rmem = 4096 4096 16777216</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_wmem = 4096 4096 16777216</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##æœ€ä½å†…å­˜å’Œç¼“å†²åŒºå›æ”¶å€¾å‘ï¼ˆæ­¤å‚æ•°æœ‰ä¸€å®šé£é™©ï¼‰</span></span><br><span class="line"><span class="comment">#vm.min_free_kbytes=409600</span></span><br><span class="line"><span class="comment">#vm.vfs_cache_pressure=200</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹/etc/security/limits.conf</span></span><br><span class="line"><span class="comment"># å•ä¼šè¯çº§åˆ«ï¼Œå¯æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸Šé™</span></span><br><span class="line">* soft nofile 655350</span><br><span class="line">* hard nofile 655350</span><br><span class="line"><span class="comment"># å•ä¼šè¯çº§åˆ«ï¼Œ å¯æ‰“å¼€çš„æ‰€æœ‰è¿›ç¨‹ä¸Šé™</span></span><br><span class="line">* soft nproc 10240</span><br><span class="line">* hard nproc 10240</span><br></pre></td></tr></table></figure><blockquote><h5 id="å¼€å¯iptableså-æŸ¥çœ‹å½“å‰é“¾è·¯è¡¨æ•°é‡å‘½ä»¤">å¼€å¯iptableså, æŸ¥çœ‹å½“å‰é“¾è·¯è¡¨æ•°é‡å‘½ä»¤</h5><p>$ sysctl net.netfilter.nf_conntrack_count</p><p>net.netfilter.nf_conntrack_count = 601032</p><h5 id="æŸ¥çœ‹è¿æ¥æ•°æœ€é«˜çš„10ä¸ªIPï¼šå¯ä»¥æŸ¥å°æŸä¸ªip-æˆ–è€…åˆ¤æ–­æ˜¯è°å¯¼è‡´çš„">æŸ¥çœ‹è¿æ¥æ•°æœ€é«˜çš„10ä¸ªIPï¼šå¯ä»¥æŸ¥å°æŸä¸ªip, æˆ–è€…åˆ¤æ–­æ˜¯è°å¯¼è‡´çš„</h5><p>$ awk -Fâ€™=â€™ â€˜{c[$2]++}END{for ( i in c) print i,c[i]}â€™ /proc/net/nf_conntrack | head -10</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shellâ˜ifåˆ¤å®š</title>
      <link href="posts/241ce96c/"/>
      <url>posts/241ce96c/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-a FILEï¼šå­˜åœ¨åˆ™ä¸ºçœŸï¼›å¦åˆ™åˆ™ä¸ºå‡ï¼›</span><br><span class="line">-e FILE: å­˜åœ¨åˆ™ä¸ºçœŸï¼›å¦åˆ™åˆ™ä¸ºå‡ï¼›</span><br><span class="line">-f FILE: å­˜åœ¨å¹¶ä¸”ä¸ºæ™®é€šæ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›</span><br><span class="line">-d DIR: å­˜åœ¨å¹¶ä¸”ä¸ºç›®å½•ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›</span><br><span class="line">-L&#x2F;-h FILE: å­˜åœ¨å¹¶ä¸”ä¸ºç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›</span><br><span class="line">-b: å­˜åœ¨å¹¶ä¸”ä¸ºå—è®¾å¤‡ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›</span><br><span class="line">-c: å­˜åœ¨å¹¶ä¸”ä¸ºå­—ç¬¦è®¾å¤‡ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡</span><br><span class="line">-S: å­˜åœ¨å¹¶ä¸”ä¸ºå¥—æ¥å­—æ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡</span><br><span class="line">-p: å­˜åœ¨å¹¶ä¸”ä¸ºå‘½åç®¡é“ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡</span><br><span class="line">-s FILE: å­˜åœ¨å¹¶ä¸”ä¸ºéç©ºæ–‡ä»¶åˆ™ä¸ºå€¼ï¼Œå¦åˆ™ä¸ºå‡ï¼›</span><br><span class="line">-r FILEï¼šæ–‡ä»¶å¯è¯»ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡</span><br><span class="line">-w FILEï¼šæ–‡ä»¶å¯å†™ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux â˜ dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› </title>
      <link href="posts/a3dfc0e8/"/>
      <url>posts/a3dfc0e8/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-â˜-dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› ">linux â˜ dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› </h2><ul><li><h3 id="é—®é¢˜è¡¨ç°ï¼š">é—®é¢˜è¡¨ç°ï¼š</h3></li></ul><p>df æ•°æ®æ¯” du æ•°æ®å°ï¼Œè€Œä¸”æ˜¯å‘ç”Ÿåœ¨åˆ é™¤æ–‡ä»¶ä¹‹åã€‚</p><hr><p>è¿™ä¸ªé—®é¢˜ç‰µæ‰¯åˆ° linux ç³»ç»Ÿæ˜¯å°†å¦‚ä½•ç¡®è®¤å’Œå›æ”¶æ•°æ®çš„.</p><ul><li><h3 id="ç©ºé—´æ˜¯å¦‚ä½•è¢«åˆ¤å®šå ç”¨çš„">ç©ºé—´æ˜¯å¦‚ä½•è¢«åˆ¤å®šå ç”¨çš„</h3></li></ul><p>linuxæ–‡ä»¶ç³»ç»Ÿåˆ¤å®šç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œæ˜¯æŸ¥çœ‹ç©ºé—´çš„ imap æ˜¯å¦ä¸º1ï¼Œè€Œ imap æ˜¯å¦ä¸º1ï¼Œåˆ™å–å†³äºå ç”¨ç©ºé—´çš„æ–‡ä»¶çš„ inode èŠ‚ç‚¹çš„ Links æ˜¯å¦ä¸º0ã€‚è€Œæ¯å½“ç¨‹åºè°ƒç”¨æ–‡ä»¶ä¸”æ²¡æœ‰å…³é—­ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶çš„ inode çš„ Links å°±ä¼šåŠ  1ã€‚</p><p>å¦‚æœ Links ä¸ä¸º0ï¼Œåˆ™ imap å°±ä¸ä¼šæ˜¯ 0 ï¼Œåˆ™è¿™ä»½ç©ºé—´å°±æ— æ³•è¢«å†æ¬¡è°ƒç”¨.<br>å¦å¤–ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé»˜è®¤ inode  Links æ˜¯1</p><ul><li><h3 id="ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„">ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„</h3></li></ul><p>æ–‡ä»¶ç³»ç»Ÿé¦–å…ˆåœ¨çˆ¶ç›®å½•æ–‡ä»¶é‡Œæ‰¾åˆ°æ‰€è¦åˆ é™¤çš„æ–‡ä»¶åï¼Œå°†æ­¤æ–‡ä»¶ä¿¡æ¯ä»çˆ¶ç›®å½•é‡Œæ¸…é™¤æ‰ï¼Œå¦‚è‹¥æ¸…é™¤åï¼ŒLinks ä¸º0 ï¼Œåˆ™åˆ é™¤ inode èŠ‚ç‚¹ï¼Œå°† imap å°±ç½®ä¸º0ï¼Œç©ºé—´å¯ä»¥å†æ¬¡è¢«åˆ©ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœçˆ¶ç›®å½•æ–‡ä»¶ä¿¡æ¯æ¸…é™¤åï¼Œæœ‰ç¨‹åºåœ¨è°ƒç”¨æ–‡ä»¶ï¼Œåˆ™ Links ä¸ä¸º0ï¼Œé‚£ä¹ˆ inode æ— æ³•è¢«åˆ é™¤ï¼Œ imap ä¹Ÿæ— æ³•ç½®ä¸º0ï¼Œç»“æœå°±æ˜¯æ–‡ä»¶çœ‹ç€æ²¡äº†ï¼Œä½†æ˜¯ç©ºé—´è¿˜æ˜¯æ²¡æœ‰é‡Šæ”¾ã€‚</p><hr><p>df å’Œ du çš„æœ€å¤§åŒºåˆ«å°±æ˜¯ï¼š</p><p>df æ˜¯æ ¹æ® inode çš„ Links æ¥ç¡®è®¤ç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œå¹¶è¿›è€Œç»Ÿè®¡</p><p>du æ˜¯æ ¹æ®ç›®å½•çš„æ–‡ä»¶ä¿¡æ¯æ¥ç¡®è®¤ç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œå¹¶è¿›è€Œç»Ÿè®¡</p><ul><li><h3 id="å¦‚ä½•é‡Šæ”¾è¢«å ç”¨çš„ç©ºé—´">å¦‚ä½•é‡Šæ”¾è¢«å ç”¨çš„ç©ºé—´</h3></li></ul><p>ä»ä¸Šé¢å¯çŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¢«åˆ é™¤æ–‡ä»¶çš„ inode Links é™æˆ 0 å³å¯ï¼Œä¹Ÿå°±æ˜¯å…³é—­æ­¤æ–‡ä»¶çš„è°ƒç”¨ç¨‹åº.</p><p>å¦‚ä½•æŸ¥æ‰¾è°ƒç”¨ç¨‹åºï¼Ÿ</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lsof -n | grep rm_file_name <span class="comment"># è·å–åˆ°ç¨‹åº pidï¼Œå¹¶å°†å…¶æ€æ­»å³å¯</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-lookupæ’ä»¶</title>
      <link href="posts/25732c33/"/>
      <url>posts/25732c33/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>lookup æ’ä»¶å¯ä»¥é…åˆ loop å¾ªç¯å®ç° with_x å¾ªç¯</p><h2 id="lookup-æŸ¥è¯¢æ’ä»¶">lookup æŸ¥è¯¢æ’ä»¶</h2><blockquote><p>query æ’ä»¶ä¸ lookup æ’ä»¶ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äº query é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ç”¨äº†wantlist=trueã€‚<br>wantlist çš„æ„æ€æ˜¯å°†è¿”å›çš„å­—ç¬¦ä¸²æ„æˆä¸€ä¸ªåˆ—è¡¨<br>å¦å¤–ï¼Œquery å¯ä»¥ç®€å†™ä¸ºq</p></blockquote><h5 id="loop-å…³é”®è¯">loop å…³é”®è¯</h5><p>ç”¨äºå°†ä¸€ä¸ªåˆ—è¡¨è¿›è¡Œå¾ªç¯ï¼Œé»˜è®¤å¾ªç¯å•ä½“å˜é‡æ˜¯ item. å®˜æ–¹ç”¨æ¥æ›¿ä»£ with_xxx</p><p>ç”¨æ¥éå† lookup ç»“æœé›†</p><blockquote><p>è‡ªå®šä¹‰loopå¾ªç¯å•ä½“å˜é‡ä¸º xxx</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">loop_control:</span></span><br><span class="line">  <span class="attr">loop_var:</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure><p>loop_control è¿˜æœ‰å…¶å®ƒæ§åˆ¶ï¼Œæ¯”å¦‚</p><ul><li>index_var: var_name å¾ªç¯ç´¢å¼•.</li><li>pause: time å¾ªç¯é—´éš”æ—¶é—´</li><li>label: var_name å»æ‰ var_name ä¹‹å¤–çš„ä¸ç›¸å¹²ä¿¡æ¯è¾“å‡º</li></ul></blockquote><h2 id="å¸¸ç”¨å‚æ•°ç¤ºä¾‹">å¸¸ç”¨å‚æ•°ç¤ºä¾‹</h2><h4 id="file-å‚æ•°">file å‚æ•°</h4><blockquote><p>å¤šä¸ªæ–‡ä»¶å†…å®¹åˆå¹¶åœ¨ä¸€èµ·ï¼Œæˆ–ä»¥å­—ç¬¦ä¸²é€—å·åˆ†éš”è¾“å‡ºï¼Œæˆ–ä»¥åˆ—è¡¨å½¢å¼è¾“å‡º</p></blockquote><h4 id="ini-å‚æ•°">ini å‚æ•°</h4><blockquote><p>è·å– ini é…ç½®ä¿¡æ¯</p></blockquote><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ~/test.ini</span></span><br><span class="line"><span class="section">[testA]</span></span><br><span class="line"><span class="attr">a1</span>=zhangsan</span><br><span class="line"><span class="attr">a2</span>=lisi</span><br><span class="line"></span><br><span class="line"><span class="section">[testB]</span></span><br><span class="line"><span class="attr">b1</span>=wangwu</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">zyh</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">ini</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; q(&#x27;ini&#x27;, &#x27;a1 section=testA file=~/test.ini&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ok: [localhost] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å½“é…ç½®æ˜¯ propertiesï¼Œå¯ä»¥è¿½åŠ  type=properties</p></blockquote><h4 id="dictå‚æ•°">dictå‚æ•°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç»“æœé›† </span></span><br><span class="line">[&#123;key: xxx, value: xxx&#125;, &#123;key: xxx, value: xxx&#125;]</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">male:</span> <span class="string">Bob</span></span><br><span class="line">      <span class="attr">female:</span> <span class="string">Maris</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">vars</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.key &#125;&#125;</span>: <span class="template-variable">&#123;&#123; item.value &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;dict&#x27;, users) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ok: [localhost] =&gt; (item=&#123;<span class="string">&#x27;key&#x27;</span>: u<span class="string">&#x27;male&#x27;</span>, <span class="string">&#x27;value&#x27;</span>: u<span class="string">&#x27;Bob&#x27;</span>&#125;) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;male: Bob&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=&#123;<span class="string">&#x27;key&#x27;</span>: u<span class="string">&#x27;female&#x27;</span>, <span class="string">&#x27;value&#x27;</span>: u<span class="string">&#x27;Maris&#x27;</span>&#125;) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;female: Maris&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="subelementså‚æ•°">subelementså‚æ•°</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å†™æ³•ï¼š</span></span><br><span class="line">&#123;&#123; lookup(<span class="string">&#x27;subelements&#x27;</span>,list,<span class="string">&#x27;content&#x27;</span>) &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€ä¸ªç”±ç›¸åŒç»“æ„å­—å…¸ç»„æˆçš„åˆ—è¡¨listï¼Œå°†å­—å…¸ä¸­æŸä¸€ä¸ªå…ƒç´ keyï¼ˆå€¼å¿…é¡»æ˜¯åˆ—è¡¨ï¼‰ä¸å­—å…¸å‰©ä½™çš„å…ƒç´ ï¼ˆå‰©ä½™çš„å…ƒç´ ä½œä¸ºä¸€ä¸ªæ•´ä½“æ–°å­—å…¸ï¼‰ï¼Œæ„å»ºç¬›å¡å°”ç§¯ã€‚ä»è€Œå½¢æˆ itemã€‚æ¯ä¸€ä¸ªå­—å…¸æ‹†åˆ†ç»„åˆåçš„ item æ„å»ºç»“æœé›† items</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æœé›†</span></span><br><span class="line"></span><br><span class="line">items=[</span><br><span class="line">[&#123;list.0.å‰©ä½™kv&#125;,  list.0.key.0], </span><br><span class="line">[&#123;list.0.å‰©ä½™kv&#125;,  list.0.key.1], </span><br><span class="line">[&#123;list.1.å‰©ä½™kv&#125;,  list.1.key.0], </span><br><span class="line">[&#123;list.1.å‰©ä½™kv&#125;,  list.1.key.1], </span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">          <span class="attr">users:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Bob</span></span><br><span class="line">                    <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">                    <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">                    <span class="attr">content:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">eating</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">sleeping</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">play</span> <span class="string">ogre</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Maris</span></span><br><span class="line">                    <span class="attr">gender:</span> <span class="string">female</span></span><br><span class="line">                    <span class="attr">age:</span> <span class="number">20</span></span><br><span class="line">                    <span class="attr">content:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">eating</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">sleeping</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">shopping</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">vars</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">debug:</span></span><br><span class="line">                    <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; item.0.name &#125;&#125;</span> - <span class="template-variable">&#123;&#123; item.0.gender &#125;&#125;</span> - <span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>&quot;</span></span><br><span class="line">            <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;subelements&#x27;,users,&#x27;content&#x27;) &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ok: [localhost] =&gt; (item=[&#123;u<span class="string">&#x27;gender&#x27;</span>: u<span class="string">&#x27;male&#x27;</span>, u<span class="string">&#x27;age&#x27;</span>: 18, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;Bob&#x27;</span>&#125;, u<span class="string">&#x27;eating&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Bob - male - eating&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;u<span class="string">&#x27;gender&#x27;</span>: u<span class="string">&#x27;male&#x27;</span>, u<span class="string">&#x27;age&#x27;</span>: 18, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;Bob&#x27;</span>&#125;, u<span class="string">&#x27;sleeping&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Bob - male - sleeping&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;u<span class="string">&#x27;gender&#x27;</span>: u<span class="string">&#x27;male&#x27;</span>, u<span class="string">&#x27;age&#x27;</span>: 18, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;Bob&#x27;</span>&#125;, u<span class="string">&#x27;play ogre&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Bob - male - play ogre&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;u<span class="string">&#x27;gender&#x27;</span>: u<span class="string">&#x27;female&#x27;</span>, u<span class="string">&#x27;age&#x27;</span>: 20, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;Maris&#x27;</span>&#125;, u<span class="string">&#x27;eating&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Maris - female - eating&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;u<span class="string">&#x27;gender&#x27;</span>: u<span class="string">&#x27;female&#x27;</span>, u<span class="string">&#x27;age&#x27;</span>: 20, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;Maris&#x27;</span>&#125;, u<span class="string">&#x27;sleeping&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Maris - female - sleeping&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[&#123;u<span class="string">&#x27;gender&#x27;</span>: u<span class="string">&#x27;female&#x27;</span>, u<span class="string">&#x27;age&#x27;</span>: 20, u<span class="string">&#x27;name&#x27;</span>: u<span class="string">&#x27;Maris&#x27;</span>&#125;, u<span class="string">&#x27;shopping&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Maris - female - shopping&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è‹¥æœ‰å¤šä¸ªkeyéœ€è¦é™„åŠ ï¼Œéœ€è¦ nested ä¸  include_tasks çš„ç»„åˆå®ç°</p></blockquote><h4 id="nestedå‚æ•°">nestedå‚æ•°</h4><blockquote><p>å°†å¤šä¸ªåˆ—è¡¨è¿›è¡Œç¬›å¡å°”ç§¯è¿ç®—</p><ol><li>test3.yml ä¸­æ‹¿åˆ° userså¾ªç¯å•ä½“ user</li><li>é’ˆå¯¹å¾ªç¯å•ä½“ userå¼•å…¥é™„åŠ ä»»åŠ¡ test3_1.yml</li><li>é€šè¿‡lookupæ’ä»¶nestedï¼Œå°† userå­—å…¸ä¸­å„keyçš„valueç›¸äº’éå†ï¼Œæ„å»ºæ–°åˆ—è¡¨ item</li></ol></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">################ test3.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">          <span class="attr">users:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Bob</span></span><br><span class="line">                    <span class="attr">gender:</span> <span class="string">male</span>       </span><br><span class="line">                    <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">                    <span class="attr">content:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">eating</span>   </span><br><span class="line">                            <span class="bullet">-</span> <span class="string">sleeping</span> </span><br><span class="line">                            <span class="bullet">-</span> <span class="string">play</span> <span class="string">ogre</span></span><br><span class="line">                    <span class="attr">specialty:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">english</span>  </span><br><span class="line">                            <span class="bullet">-</span> <span class="string">game</span>     </span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Maris</span>        </span><br><span class="line">                    <span class="attr">gender:</span> <span class="string">female</span>     </span><br><span class="line">                    <span class="attr">age:</span> <span class="number">20</span></span><br><span class="line">                    <span class="attr">content:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">eating</span>   </span><br><span class="line">                            <span class="bullet">-</span> <span class="string">sleeping</span> </span><br><span class="line">                            <span class="bullet">-</span> <span class="string">shopping</span> </span><br><span class="line">                    <span class="attr">specialty:</span></span><br><span class="line">                            <span class="bullet">-</span> <span class="string">history</span>  </span><br><span class="line">                            <span class="bullet">-</span> <span class="string">cooking</span>  </span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">test3_1.yml</span> </span><br><span class="line">            <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; users &#125;&#125;</span>&quot;</span></span><br><span class="line">            <span class="attr">loop_control:</span></span><br><span class="line">                    <span class="attr">loop_var:</span> <span class="string">user</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">################ test3_1.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">loop:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; lookup(&#x27;nested&#x27;,user.name, user.age, user.content, user.specialty) &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&quot;name:<span class="template-variable">&#123;&#123; item.0 &#125;&#125;</span>, age:<span class="template-variable">&#123;&#123; item.1 &#125;&#125;</span>, <span class="template-variable">&#123;&#123; item.2 &#125;&#125;</span>, <span class="template-variable">&#123;&#123; item.3 &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Bob&#x27;</span>, 18, u<span class="string">&#x27;eating&#x27;</span>, u<span class="string">&#x27;english&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Bob, age:18, eating, english&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Bob&#x27;</span>, 18, u<span class="string">&#x27;eating&#x27;</span>, u<span class="string">&#x27;game&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Bob, age:18, eating, game&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Bob&#x27;</span>, 18, u<span class="string">&#x27;sleeping&#x27;</span>, u<span class="string">&#x27;english&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Bob, age:18, sleeping, english&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Bob&#x27;</span>, 18, u<span class="string">&#x27;sleeping&#x27;</span>, u<span class="string">&#x27;game&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Bob, age:18, sleeping, game&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Bob&#x27;</span>, 18, u<span class="string">&#x27;play ogre&#x27;</span>, u<span class="string">&#x27;english&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Bob, age:18, play ogre, english&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Bob&#x27;</span>, 18, u<span class="string">&#x27;play ogre&#x27;</span>, u<span class="string">&#x27;game&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Bob, age:18, play ogre, game&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Maris&#x27;</span>, 20, u<span class="string">&#x27;eating&#x27;</span>, u<span class="string">&#x27;history&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Maris, age:20, eating, history&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Maris&#x27;</span>, 20, u<span class="string">&#x27;eating&#x27;</span>, u<span class="string">&#x27;cooking&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Maris, age:20, eating, cooking&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Maris&#x27;</span>, 20, u<span class="string">&#x27;sleeping&#x27;</span>, u<span class="string">&#x27;history&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Maris, age:20, sleeping, history&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Maris&#x27;</span>, 20, u<span class="string">&#x27;sleeping&#x27;</span>, u<span class="string">&#x27;cooking&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Maris, age:20, sleeping, cooking&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Maris&#x27;</span>, 20, u<span class="string">&#x27;shopping&#x27;</span>, u<span class="string">&#x27;history&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Maris, age:20, shopping, history&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [localhost] =&gt; (item=[u<span class="string">&#x27;Maris&#x27;</span>, 20, u<span class="string">&#x27;shopping&#x27;</span>, u<span class="string">&#x27;cooking&#x27;</span>]) =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;name:Maris, age:20, shopping, cooking&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> lookup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="posts/0/"/>
      <url>posts/0/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">title: ä¿æ´»â˜monit</span><br><span class="line">date: 2020-09-27 14:27:54</span><br><span class="line">tags:</span><br><span class="line">  - monit</span><br><span class="line">categories:</span><br><span class="line">  - ç›‘æ§</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…">å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install monit -y</span><br></pre></td></tr></table></figure><h2 id="ä¸»é…ç½®">ä¸»é…ç½®</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/monitrc</span></span><br><span class="line"><span class="built_in">set</span> daemon  10 <span class="comment"># è°ƒæ•´å‘¨æœŸ</span></span><br></pre></td></tr></table></figure><p>â­ï¸å®˜æ–¹é…ç½®æ–‡æ¡£: <a href="https://mmonit.com/monit/documentation/monit.html">https://mmonit.com/monit/documentation/monit.html</a></p><h2 id="ç¨‹åºä¿æ´»é…ç½®">ç¨‹åºä¿æ´»é…ç½®</h2><p>é»˜è®¤å­˜æ”¾ä½ç½®: /etc/monit.d/</p><p>è¿™é‡Œä»¥ pidfile æ£€æµ‹æ–¹å¼ä¸ºä¾‹</p><p>nginxçš„é…ç½®:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">check process nginx with pidfile /var/run/nginx.pid</span><br><span class="line">  start program = <span class="string">&quot;/usr/sbin/nginx&quot;</span></span><br><span class="line">  stop program = <span class="string">&quot;/usr/bin/killall nginx&quot;</span></span><br><span class="line"><span class="keyword">if</span> changed pid <span class="keyword">then</span> alert</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°nginxé…ç½®çš„æ„æ€:</p><ol><li><p>æ£€æµ‹æ–¹å¼: pidfile</p></li><li><p>å¼€å…³ç¨‹åºè·¯å¾„</p></li><li><p>å‘ç°pidæ”¹å˜,åˆ™è§¦å‘åŠ¨ä½œ: é¢„è­¦</p></li></ol><p>tomcatçš„é…ç½®:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">check process tomcat-8080 with pidfile /opt/tomcat/tomcat-8080/bin/tomcat.pid</span><br><span class="line">  start program = <span class="string">&quot;/usr/bin/bash /opt/tomcat/tomcat-8080/bin/startup.sh&quot;</span></span><br><span class="line">    as uid <span class="string">&quot;root&quot;</span> and gid <span class="string">&quot;root&quot;</span></span><br><span class="line">  stop program = <span class="string">&quot;/usr/bin/ps aux | /usr/bin/grep &#x27;/opt/tomcat/tomcat-8080/bin/bootstrap.jar&#x27; | /usr/bin/awk &#x27;&#123;print &quot;</span><span class="built_in">kill</span> -9 <span class="string">&quot;<span class="variable">$2</span>&#125;&#x27; | /usr/bin/bash&quot;</span></span><br><span class="line">    as uid <span class="string">&quot;root&quot;</span> and gid <span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="keyword">if</span> failed port 8080 <span class="keyword">then</span> alert</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°tomcaté…ç½®çš„æ„æ€:</p><ol><li>æ£€æµ‹æ–¹å¼: pidfile</li><li>å¼€å…³ç¨‹åºè·¯å¾„, å¹¶ä¸”æ‰§è¡Œçš„æ—¶å€™éœ€è¦ä»¥ root æƒé™æ‰§è¡Œ</li><li>å‘ç° 8080 ä¸é€š, åˆ™è§¦å‘åŠ¨ä½œ: é¢„è­¦</li></ol><p>ğŸŒŸéœ€è¦æ³¨æ„çš„æ˜¯, æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„éƒ½éœ€è¦æ˜¯ç»å¯¹è·¯å¾„, åŒ…æ‹¬å‘½ä»¤.</p><h2 id="å¯åŠ¨-å…³é—­">å¯åŠ¨/å…³é—­</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl start/stop/reload monit</span><br></pre></td></tr></table></figure><p>ğŸŒŸå½“monitå¯åŠ¨ä¹‹å, å®ƒå°±ä¼šåŠ è½½ä¿æ´»é…ç½®, å¹¶è¿›è¡Œæ£€æµ‹.</p><h2 id="æ—¥å¿—">æ—¥å¿—</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;var&#x2F;log&#x2F;monit.log</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
