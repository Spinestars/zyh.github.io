<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>rabbitmqâ˜å®‰è£…</title>
      <link href="posts/b43013ef/"/>
      <url>posts/b43013ef/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…rabbitmq-server">å®‰è£…rabbitmq server</h2><h3 id="dockeræ–¹å¼">dockeræ–¹å¼</h3><pre><code class="language-bash"># https://hub.docker.com/_/rabbitmq, ç„¶åæœç´¢ management ç‰ˆæœ¬ [docker pull rabbitmq:management]mkdir /export/docker-data-rabbitmqpwd=`cat /proc/sys/kernel/random/uuid | cut -d'-' -f1`echo mq@$&#123;pwd&#125;;container_name=rabbitmqnetwork=cmsdocker run --name $&#123;container_name&#125; \--hostname $&#123;container_name&#125; \--network $&#123;network&#125; \--restart always \-p 5672:5672 -p 15672:15672 \--cpus=1 \--memory=1G --memory-swap=1G \--ulimit nofile=204800 \--mount &quot;type=bind,src=/export/docker-data-rabbitmq,dst=/var/lib/rabbitmq&quot; \-e RABBITMQ_DEFAULT_VHOST=rabbitmq \-e RABBITMQ_DEFAULT_USER=admin \-e RABBITMQ_DEFAULT_PASS=mq@$&#123;pwd&#125; \-d rabbitmq:3.8.13-management</code></pre><h3 id="rpmæ–¹å¼">rpmæ–¹å¼</h3><pre><code># å®‰è£… erlang çš„ rabbitmq å…¼å®¹ç‰ˆæ–¹å¼ (å¸è½½å‘½ä»¤ yum erase erlang-*)yum install -y https://github.com/rabbitmq/erlang-rpm/releases/download/v22.0.7/erlang-22.0.7-1.el6.x86_64.rpm# å®‰è£… rabbitmq-serveryum install -y https://dl.bintray.com/rabbitmq/all/rabbitmq-server/3.7.15/rabbitmq-server-3.7.15-1.el6.noarch.rpm;## å¼€å¯ç®¡ç†rabbitmq-plugins enable rabbitmq_management;# ä¿®æ”¹ä¸€äº›å°é…ç½®vim /etc/rabbitmq/rabbitmq.conflog.file.level = warninglog.file = rabbitmq.logvim /etc/rabbitmq/rabbitmq-env.confRABBITMQ_LOG_BASE=/export/rabbitmq/logsmkdir -p /export/rabbitmq/logs &amp;&amp; chown rabbitmq:rabbitmq /export/rabbitmq/logschown rabbitmq.rabbitmq /var/lib/rabbitmq/.erlang.cookie;echo '* soft nofile 202400' &gt;&gt; /etc/security/limits.confecho '* hard nofile 202400' &gt;&gt; /etc/security/limits.conf/etc/init.d/rabbitmq-server restart;</code></pre><h3 id="æ·»åŠ ç”¨æˆ·å’Œè™šæ‹Ÿä¸»æœº">æ·»åŠ ç”¨æˆ·å’Œè™šæ‹Ÿä¸»æœº</h3><pre><code class="language-bash">#è¾“å…¥http://ip:15672å¯ä»¥ç™»å½•ç®¡ç†ç•Œé¢,# rpm å®‰è£…åï¼Œåªæœ‰é»˜è®¤è´¦æˆ·guest/guest.# docker å®‰è£…åï¼Œæœ‰ admin/admin ç”¨æˆ·# æ·»åŠ ä¸€ä¸ª vhostpro_vhost=rabbitmqctl add_vhost $&#123;pro_vhost&#125;# æ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·user_name=pwd=`cat /proc/sys/kernel/random/uuid | cut -d'-' -f1`rabbitmqctl add_user $&#123;user_name&#125; mq@$&#123;pwd&#125;;echo &quot;$&#123;user_name&#125;ç”¨æˆ·å¯†ç æ˜¯ï¼šmq@$&#123;pwd&#125;&quot;#è¯¥å‘½ä»¤ä½¿ç”¨æˆ· user_name å…·æœ‰ pro_vhost ä¸­æ‰€æœ‰èµ„æºçš„é…ç½®ã€å†™ã€è¯»æƒé™ä»¥ä¾¿ç®¡ç†å…¶ä¸­çš„èµ„æº# rabbitmqctl set_permissions -p vhost User ConfP WriteP ReadPrabbitmqctl set_permissions -p $&#123;pro_vhost&#125; $&#123;user_name&#125; &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;; # ç”¨æˆ·ç»‘å®š tags# tagså†³å®šäº†ç”¨æˆ·æ›´é«˜çº§çš„æƒé™ï¼Œ## è¶…çº§ç®¡ç†å‘˜(administrator)ï¼šå¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹)ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥å¯¹ç”¨æˆ·ï¼Œç­–ç•¥(policy)è¿›è¡Œæ“ä½œã€‚## ç›‘æ§è€…(monitoring)ï¼šå¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹)ï¼ŒåŒæ—¶å¯ä»¥æŸ¥çœ‹rabbitmqèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(è¿›ç¨‹æ•°ï¼Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç£ç›˜ä½¿ç”¨æƒ…å†µç­‰)## ç­–ç•¥åˆ¶å®šè€…(policymaker)ï¼šå¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹), åŒæ—¶å¯ä»¥å¯¹policyè¿›è¡Œç®¡ç†ã€‚ä½†æ— æ³•æŸ¥çœ‹èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯(ä¸Šå›¾çº¢æ¡†æ ‡è¯†çš„éƒ¨åˆ†)## æ™®é€šç®¡ç†è€…(management)ï¼šä»…å¯ç™»é™†ç®¡ç†æ§åˆ¶å°(å¯ç”¨management pluginçš„æƒ…å†µä¸‹)ï¼Œæ— æ³•çœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•å¯¹ç­–ç•¥è¿›è¡Œç®¡ç†ã€‚## å…¶ä»–(other)ï¼šæ— æ³•ç™»é™†ç®¡ç†æ§åˆ¶å°ï¼Œé€šå¸¸å°±æ˜¯æ™®é€šçš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚user_tag=rabbitmqctl set_user_tags $&#123;user_name&#125; $&#123;user_tag&#125;;#æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·rabbitmqctl list_users;</code></pre><h3 id="çŠ¶æ€">çŠ¶æ€</h3><pre><code class="language-bash">rabbitmqctl statusrabbitmqctl list_queues -p &lt;vhost_name&gt;</code></pre><h3 id="é˜Ÿåˆ—">é˜Ÿåˆ—</h3><pre><code class="language-bash">rabbitmqctl list_queues --vhost &lt;&gt;</code></pre><h2 id="phpä½¿ç”¨">phpä½¿ç”¨</h2><pre><code>wget https://github.com/alanxz/rabbitmq-c/releases/download/v0.7.1/rabbitmq-c-0.7.1.tar.gz;tar xf rabbitmq-c-0.7.1.tar.gz;cd rabbitmq-c-0.7.1;./configure --prefix=/usr/local/rabbitmq-c-0.7.1;make &amp;&amp; make install;cd ..;wget https://pecl.php.net/get/amqp-1.9.3.tgz;tar xf amqp-1.9.3.tgz;cd amqp-1.9.3;/usr/local/php/bin/phpize;./configure --with-php-config=/usr/local/php/bin/php-config --with-amqp --with-librabbitmq-dir=/usr/local/rabbitmq-c-0.7.1;make &amp;&amp; make install;php.inié‡Œæ·»åŠ ç”Ÿæˆçš„amqp.soçš„è·¯å¾„ä¿¡æ¯extension = /usr/local/php/lib/php/extensions/no-debug-non-zts-20160303/amqp.so</code></pre>]]></content>
      
      
      <categories>
          
          <category> ä¸­é—´ä»¶ </category>
          
          <category> rabbitmq </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> rabbitmq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜åŠ¨æ€agent</title>
      <link href="posts/3b5cd3e1/"/>
      <url>posts/3b5cd3e1/</url>
      
        <content type="html"><![CDATA[<h2 id="æµç¨‹">æµç¨‹</h2><p>jenkins-master -&gt; pipeline -&gt; kubernetes æ’ä»¶ -&gt; kubernetes é›†ç¾¤ -&gt; jenkins-agent -&gt; jenkins-master</p><h2 id="å‡­è¯ä¿¡æ¯">å‡­è¯ä¿¡æ¯</h2><p>é€šè¿‡ kube config é‡Œçš„åŠ å¯†ä¿¡æ¯è·å–å‡­æ®æ‰€éœ€çš„è¯ä¹¦</p><pre><code class="language-bash">certificate-authority-data=client-certificate-data=client-key-data=echo &quot;$&#123;certificate-authority-data&#125;&quot; | base64 -d &gt; ca.crtecho &quot;$&#123;client-certificate-data&#125;&quot; | base64 -d &gt; client.crtecho &quot;$&#123;client-key-data&#125;&quot; | base64 -d &gt; client.keyopenssl pkcs12 -export -out cert.pfx -inkey client.key -in client.crt -certfile ca.crt</code></pre><p>å°† pkcs12 ä¼ è¾“åˆ° jenkins å‡­æ®ä¸­</p><p><img src="/posts/3b5cd3e1/image-20210116152344875.png" alt="image-20210116152344875"></p><p>ğŸ’ä½ éœ€è¦åœ¨å‡­æ®ã€å¯†ç ã€‘ä½ç½®ä¸­è¾“å…¥ä½ ç”Ÿæˆ pkcs12 è¯ä¹¦æ—¶è¾“å…¥çš„å¯†ç .</p><h2 id="å®‰è£…æ’ä»¶">å®‰è£…æ’ä»¶</h2><ol><li>å®‰è£… kubernetes æ’ä»¶</li><li>æ·»åŠ ä¸€ä¸ªæ–°çš„æ’ä»¶é…ç½®</li></ol><p><img src="/posts/3b5cd3e1/image-20210116152033813.png" alt="image-20210116152033813"></p><ol start="3"><li>ç¡®ä¿æ’ä»¶é…ç½®ã€è¿æ¥æµ‹è¯•ã€‘æ˜¾ç¤ºæˆåŠŸè¿æ¥</li></ol><h2 id="é…ç½®-pipeline-åŠ¨æ€ç”Ÿæˆ-agent">é…ç½® pipeline åŠ¨æ€ç”Ÿæˆ agent</h2><p>å…³äº agent çš„ pod æ¨¡æ¿ï¼Œé»˜è®¤æ’ä»¶å·²ç»æä¾›äº†ä¸€ä¸ªï¼Œåªä¸è¿‡ä½ çœ‹ä¸åˆ°ã€‚å› æ­¤å“ªæ€•ä½ ä»€ä¹ˆéƒ½ä¸åšï¼Œä½  pipeline stages ä¹Ÿä¼šåœ¨é»˜è®¤çš„ agent pod é‡Œæ‰§è¡Œã€‚</p><p>æˆ‘ä»¬ä¸€èˆ¬é€‰æ‹©ç»™ agent pod æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨ï¼Œè¿™ä¸ªé¢å¤–çš„å®¹å™¨é‡ŒåŒ…å«äº†æˆ‘ä»¬æ‰§è¡Œ stages æ‰€éœ€è¦çš„ç¯å¢ƒï¼Œä¾‹å¦‚å« jenkinstoolsã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><p>å¤šå®¹å™¨ pod æ¨¡æ¿æœ‰è¯¸å¤šçš„ç¡¬æ€§é™åˆ¶ï¼š</p><p>Multiple containers can be defined in a pod. One of them is automatically created with name <code>jnlp</code>, and runs the Jenkins JNLP agent service, with args <code>$&#123;computer.jnlpmac&#125; $&#123;computer.name&#125;</code>, and will be the container acting as Jenkins agent.</p><p>Other containers must run a long running process, so the container does not exit. If the default entrypoint or command just runs something and exit then it should be overridden with something like <code>cat</code> with <code>ttyEnabled: true</code>.</p><p><strong>WARNING</strong> If you want to provide your own Docker image for the JNLP agent, you <strong>must</strong> name the container <code>jnlp</code> so it overrides the default one. Failing to do so will result in two agents trying to concurrently connect to the master.</p><ol><li>jnlp agent å®¹å™¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå“ªæ€•ä½ æ²¡æœ‰å®šä¹‰ã€‚</li><li>å¦‚æœä½ è‡ªå®šä¹‰äº† JNLP æœåŠ¡æ‰€åœ¨çš„å®¹å™¨ï¼Œé‚£ä¹ˆè´Ÿè´£è¿æ¥ master çš„ jnlp agent å®¹å™¨åå¿…é¡»å« jnlpã€‚</li><li>å…¶å®ƒå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨æ¥æ‰§è¡Œ stages çš„å®¹å™¨ï¼Œå¿…é¡»è¿è¡Œä¸€ä¸ªæŒä¹…çš„ç¨‹åºï¼Œä»¥ä¾¿äºå®¹å™¨ä¸ä¼šè‡ªåŠ¨é€€å‡ºã€‚ä¾‹å¦‚ cat å‘½ä»¤å¹¶é™„åŠ ä¸€ä¸ªä¼ªç»ˆç«¯ã€‚</li><li>stages é˜¶æ®µæ‰§è¡Œçš„æ—¶å€™ï¼Œå¿…é¡»æ˜ç¡®çš„æŒ‡å®šé¢å¤–å®¹å™¨ï¼Œå¦åˆ™ä¼šé»˜è®¤åœ¨ jnlp å®¹å™¨é‡Œæ‰§è¡Œ. ï¼ˆè¿™ä¸ªä¸æ˜¯å¾ˆç¡®å®šï¼Œä½†æ˜¯æˆ‘æµ‹è¯•æ˜¯è¿™æ ·ï¼‰</li></ol><p>ä¸‹å›¾æ˜¯æˆ‘çš„ pod æ¨¡æ¿é…ç½®ï¼ˆéƒ¨åˆ†æˆªå›¾ï¼‰</p><p><img src="/posts/3b5cd3e1/image-20210126182630608.png" alt="image-20210126182630608"></p><p>åœ¨ pipeline é‡Œè°ƒç”¨æ’ä»¶é…ç½®</p><pre><code>pipeline&#123;    agent&#123;        kubernetes&#123;            label &quot;jenkins-agent&quot; // pod æ¨¡æ¿æ ‡ç­¾            cloud 'kubernetes'  // æ’ä»¶é…ç½®å        &#125;    &#125;    stages &#123;        stage('Start Command On Remote Machine') &#123;            steps &#123;                container('jenkinstools') &#123;  // æ˜ç¡®æŒ‡å®š pod é‡Œçš„æ‰§è¡Œå®¹å™¨å                    script&#123;                        mytools.getRemoteIP(serverIP)                        mytools.ansible(ansibleRemoteUser,&quot;$&#123;ansibleShellCommand&#125;&quot;)                    &#125;                &#125;            &#125;        &#125;    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>aliyunâ˜oss</title>
      <link href="posts/b5d7d6ee/"/>
      <url>posts/b5d7d6ee/</url>
      
        <content type="html"><![CDATA[<h2 id="æ„å»º-oss-å­˜å‚¨æ¡¶">æ„å»º oss å­˜å‚¨æ¡¶</h2><ul><li>æ‰§è¡Œè„šæœ¬ï¼ˆæ‰§è¡Œæœ¬è„šæœ¬è·‘åˆ°é˜¿é‡Œäº‘çš„äº‘ç«¯cliå»æ‰§è¡Œï¼‰</li></ul><pre><code class="language-python">#!/usr/bin/python3.6# -*- coding: utf-8 -*-###  Usageï¼šhttps://help.aliyun.com/document_detail/32027.html##  Githubï¼šhttps://github.com/aliyun/aliyun-oss-python-sdk##  author: zyhimport oss2, osfrom oss2.models import (LifecycleExpiration, LifecycleRule,                        BucketLifecycle,AbortMultipartUpload,                        TaggingRule, Tagging, StorageTransition,                        NoncurrentVersionStorageTransition,                        NoncurrentVersionExpiration)from oss2.models import Tagging, TaggingRule#from aliyunsdkcore.client import AcsClientfrom aliyunsdkcore.acs_exception.exceptions import ClientExceptionfrom aliyunsdkcore.acs_exception.exceptions import ServerExceptionfrom aliyunsdkram.request.v20150501.CreatePolicyRequest import CreatePolicyRequest####################################region = 'æˆ‘æ˜¯åŒºåŸŸID'bucketName = 'æˆ‘æ˜¯æ¡¶å'project = 'æˆ‘æ˜¯æ ‡ç­¾projectçš„å€¼'akey = skey = ###################################endpoint = 'http://oss-&#123;0&#125;.aliyuncs.com'.format(region)auth = oss2.Auth(akey,skey)bucket = oss2.Bucket(auth, endpoint, bucketName)# create bucketbucket.create_bucket()# add tagrule = TaggingRule()rule.add('project', project)tagging = Tagging(rule)bucket.put_bucket_tagging(tagging)# init dirsbucket.put_object('conf/README','æˆ‘æ˜¯å­˜æ”¾é…ç½®çš„ç›®å½•')bucket.put_object('data/README','æˆ‘æ˜¯å­˜æ”¾æ•°æ®çš„ç›®å½•')bucket.put_object('hive/README','æˆ‘æ˜¯å­˜æ”¾hiveçš„ç›®å½•')bucket.put_object('backup/README','æˆ‘æ˜¯å­˜æ”¾å¤‡ä»½çš„ç›®å½•')bucket.put_object('logs/7days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™7å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/15days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™15å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/30days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™30å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/60days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™60å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/90days/README','æˆ‘æ˜¯å­˜æ”¾ä¿ç•™90å¤©çš„æ—¥å¿—ç›®å½•')bucket.put_object('logs/180days/README','æˆ‘æ˜¯å­˜æ”¾æ°¸ä¹…ä¿ç•™çš„æ—¥å¿—ç›®å½•')# add lifecyclerule1 = LifecycleRule('rule1', 'logs/7days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=7))rule2 = LifecycleRule('rule2', 'logs/15days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=15))rule3 = LifecycleRule('rule3', 'logs/30days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=30))rule4 = LifecycleRule('rule4', 'logs/60days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=60))rule5 = LifecycleRule('rule5', 'logs/90days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=90))rule6 = LifecycleRule('rule6', 'logs/180days/',                      status=LifecycleRule.ENABLED,                      expiration=LifecycleExpiration(days=180))rule7 = LifecycleRule('rule7', 'logs/longlasting/',                      status=LifecycleRule.ENABLED,                      storage_transitions=[StorageTransition(days=60,storage_class=oss2.BUCKET_STORAGE_CLASS_IA),                          StorageTransition(days=180,storage_class=oss2.BUCKET_STORAGE_CLASS_ARCHIVE)])lifecycle = BucketLifecycle([rule1, rule2, rule3, rule4, rule5, rule6, rule7])bucket.put_bucket_lifecycle(lifecycle)os.system(&quot;sed 's#ossBucketName#&#123;0&#125;#g' local.policy.default &gt; local_&#123;0&#125;.policy&quot;.format(bucketName))os.system(&quot;sed 's#ossBucketName#&#123;0&#125;#g' role.policy.default &gt; role_&#123;0&#125;.policy&quot;.format(bucketName))os.system(&quot;aliyun ram CreatePolicy --PolicyName oss-&#123;0&#125;-local --PolicyDocument \&quot;`cat local_&#123;0&#125;.policy`\&quot;&quot;.format(bucketName))os.system(&quot;aliyun ram CreatePolicy --PolicyName oss-&#123;0&#125;-role --PolicyDocument \&quot;`cat role_&#123;0&#125;.policy`\&quot;&quot;.format(bucketName))</code></pre><ul><li>è¿œç¨‹ç”¨æˆ·ç­–ç•¥ï¼ˆæ‰§è¡Œè„šæœ¬å‰éœ€è¦æ·»åŠ çš„ï¼‰</li></ul><pre><code class="language-json">&#123;  &quot;Version&quot;: &quot;1&quot;,  &quot;Statement&quot;: [    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [                &quot;oss:GetObject&quot;,                &quot;oss:PutObject&quot;,                &quot;oss:DeleteObject&quot;,                &quot;oss:ListObject&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName/logs/7days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/15days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/30days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/60days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/90days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/180days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/longlasting/*&quot;,        &quot;acs:oss:*:*:ossBucketName/conf/*&quot;,        &quot;acs:oss:*:*:ossBucketName/data/*&quot;,        &quot;acs:oss:*:*:ossBucketName/backup/*&quot;,        &quot;acs:oss:*:*:ossBucketName/hive/*&quot;      ],      &quot;Condition&quot;: &#123;        &quot;IpAddress&quot;: &#123;          &quot;acs:SourceIp&quot;: [            &quot;1.1.1.1&quot;,            &quot;2.2.2.2&quot;          ]        &#125;      &#125;    &#125;,    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [        &quot;oss:List*&quot;,        &quot;oss:GetBucketLocation&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName&quot;      ],      &quot;Condition&quot;: &#123;        &quot;IpAddress&quot;: &#123;          &quot;acs:SourceIp&quot;: [            &quot;1.1.1.1&quot;,            &quot;2.2.2.2&quot;          ]        &#125;      &#125;    &#125;  ]&#125;</code></pre><ul><li>è§’è‰²ç”¨æˆ·ç­–ç•¥ï¼ˆæ‰§è¡Œè„šæœ¬å‰éœ€è¦æ·»åŠ çš„ï¼‰</li></ul><pre><code class="language-json">&#123;  &quot;Version&quot;: &quot;1&quot;,  &quot;Statement&quot;: [    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [                &quot;oss:GetObject&quot;,                &quot;oss:PutObject&quot;,                &quot;oss:DeleteObject&quot;,                &quot;oss:ListObject&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName/logs/7days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/15days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/30days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/60days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/90days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/180days/*&quot;,        &quot;acs:oss:*:*:ossBucketName/logs/longlasting/*&quot;,        &quot;acs:oss:*:*:ossBucketName/conf/*&quot;,        &quot;acs:oss:*:*:ossBucketName/data/*&quot;,        &quot;acs:oss:*:*:ossBucketName/backup/*&quot;,        &quot;acs:oss:*:*:ossBucketName/hive/*&quot;      ]    &#125;,    &#123;      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Action&quot;: [        &quot;oss:List*&quot;      ],      &quot;Resource&quot;: [        &quot;acs:oss:*:*:ossBucketName&quot;      ]    &#125;  ]&#125;</code></pre><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><p>ä»¥è§’è‰²æˆæƒæ–¹å¼+aliyun cliå‘½ä»¤æ–¹å¼èµ°èµ·.</p><p>ğŸ˜”ï¼Œaliyun cli çš„æ–‡æ¡£å’Œä½¿ç”¨ä¸€è¨€éš¾å°½=ã€‚=</p><p><strong>ä½¿ç”¨å‰è¯·ç¡®ä¿è§’è‰²å·²ç»å…³è”äº†å¯¹åº”æƒé™ä»¥åŠè§’è‰²å·²ç»ç»‘å®šåˆ°äº†ECSä¸Š</strong></p><pre><code class="language-bash"># /etc/profile.d/ecs_role.shRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`ramRoleName=`curl -sq http://100.100.100.200/latest/meta-data/ram/security-credentials/`aliyun configure set --profile ecsRamRoleProfile  --mode EcsRamRole --ram-role-name $&#123;ramRoleName&#125; --region $&#123;Region&#125;</code></pre><blockquote><p>æœ¬è„šæœ¬ï¼Œä¼šè®©ä»»ä½•ä¸€ä¸ªä¼šè¯ç™»é™†çš„æ—¶å€™å°±æ‹¿åˆ°è§’è‰²æ‹¥æœ‰çš„æƒé™</p></blockquote><pre><code class="language-bash">##å¯¼å…¥è§’è‰²source /etc/profile.d/ecs_role.shRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`Endpoint=&quot;http://oss-$&#123;Region&#125;-internal.aliyuncs.com&quot;BucketName=test#éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¯·æ±‚ç«¯èµ„æºä¸ossä¸åœ¨ä¸€ä¸ªå¤§åŒºï¼Œåˆ™endpointåœ°å€éœ€è¦ç”¨ä¸‹è¿°å¤–ç½‘åœ°å€ï¼š å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼Endpoint=&quot;http://oss-$&#123;Region&#125;.aliyuncs.com&quot;##æŸ¥è¯¢## é»˜è®¤æŸ¥è¯¢æ˜¯é€’å½’æŸ¥è¯¢ï¼Œ-d åªæŸ¥è¯¢ä¸€å±‚aliyun oss ls oss://$&#123;BucketName&#125;/ -d -e $&#123;Endpoint&#125;##åŸºæœ¬çš„ä¸Šä¼ æˆ–ä¸‹è½½##ä¸Šä¼ æ–‡ä»¶ a.file åˆ° oss://test/ aliyun oss cp a.file oss://$&#123;BucketName&#125;/ -e $&#123;Endpoint&#125;##åŸºæœ¬çš„é€’å½’ä¸Šä¼ ##ä¸Šä¼ ç›®å½• abc ä¸‹çš„æ–‡ä»¶åˆ° oss://test/ ä¸‹ï¼Œå¦‚æœæœ‰é‡å¤å†…å®¹ï¼Œåˆ™éœ€è¦åŠ å…¥ --forceï¼šå…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼aliyun oss cp abc oss://$&#123;BucketName&#125;/ --recursive -e $&#123;Endpoint&#125;##å¤æ‚çš„é€’å½’ä¸Šä¼ ##ä¸Šä¼ ç›®å½• abc ä¸‹çš„ .lzo ç»“å°¾çš„æ–‡ä»¶åˆ° oss://test/ ä¸‹.##ä¸¥ç¦åœ¨æºç›®å½•é‡Œæ‰§è¡Œ --recursive å‚æ•°.  å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼å…³é”®ï¼##å³ç¦æ­¢æ‰§è¡Œ aliyun oss cp . oss://$&#123;BucketName&#125;/ --recursive aliyun oss cp abc/ oss://$&#123;BucketName&#125;/ --include='*.lzo' --recursive --force -e $&#123;Endpoint&#125;##åŒæ­¥ç›®å½• sync æŒ‡ä»¤å˜æ›´##åŒæ­¥ç›®å½• abc ä¸‹çš„æ–‡ä»¶åˆ° oss://$&#123;BucketName&#125;/ ä¸‹ï¼Œå¦‚æœ‰é‡å¤ï¼Œåˆ™å¿½ç•¥aliyun oss cp abc oss://$&#123;BucketName&#125;/ --recursive -u -e $&#123;Endpoint&#125;</code></pre><h2 id="å¼€å‘å‘-sdk">å¼€å‘å‘ sdk</h2><p>å…³äºphp sdkè®¿é—®å¯¹è±¡å­˜å‚¨çš„æ–‡æ¡£</p><p>php oss å¯¹è±¡ sdk<br><a href="https://packagist.org/packages/aliyuncs/oss-sdk-php?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6">https://packagist.org/packages/aliyuncs/oss-sdk-php?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6</a><br>php ram role sdk<br><a href="https://packagist.org/packages/alibabacloud/credentials?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6">https://packagist.org/packages/alibabacloud/credentials?spm=a2c6h.13321295.0.0.4f765c2dMbvzR6</a></p>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aliyun </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aliyun </tag>
            
            <tag> oss </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç½‘ç»œâ˜S5700é…ç½®æ”»å‡»æœ”æº</title>
      <link href="posts/5290b79d/"/>
      <url>posts/5290b79d/</url>
      
        <content type="html"><![CDATA[<h2 id="ç›®çš„">ç›®çš„</h2><p>åˆ¤æ–­ç½‘ç»œæ”»å‡»æ¥æº</p><h2 id="è®¾ç½®ç®¡ç†å‘˜ipä¸ºç™½åå•">è®¾ç½®ç®¡ç†å‘˜ipä¸ºç™½åå•</h2><pre><code class="language-bash">acl 3666rule 1 permit ip source 10.200.15.1 0.0.0.0</code></pre><h2 id="æ ¹æ®IPåˆ¤æ–­">æ ¹æ®IPåˆ¤æ–­</h2><pre><code class="language-bash">cpu-defend policy 1auto-defend enableauto-defend attack-packet sample 5auto-defend trace-type source-mac source-ip source-portvlanauto-defend protocol arp icmp dhcp telnetauto-defend threshold 60auto-defend alarm enableauto-defend alarm threshold 60auto-defend whitelist 1 acl 3666</code></pre><h2 id="æ ¹æ®ç«¯å£åˆ¤æ–­">æ ¹æ®ç«¯å£åˆ¤æ–­</h2><pre><code class="language-bash">cpu-defend policy 1auto-port-defend enableauto-port-defend attack-packet sample 5auto-port-defend protocol arp-request arp-reply dhcp icmpauto-port-defend protocol arp-request threshold 30auto-port-defend protocol arp-reply threshold 30auto-port-defend protocol dhcp threshold 30auto-port-defend protocol icmp threshold 30auto-port-defend alarm enableauto-port-defend whitelist 1 acl 3666</code></pre><h2 id="åº”ç”¨ç­–ç•¥">åº”ç”¨ç­–ç•¥</h2><pre><code class="language-bash">cpu-defend-policy 1 global</code></pre><h2 id="æŸ¥çœ‹æ”»å‡»æ¥æºip">æŸ¥çœ‹æ”»å‡»æ¥æºip</h2><pre><code class="language-bash">display auto-defend attack-source</code></pre><h2 id="æŸ¥çœ‹æ”»å‡»æ¥æºç«¯å£">æŸ¥çœ‹æ”»å‡»æ¥æºç«¯å£</h2><pre><code class="language-bash">display auto-port-defend attack-source</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
          <category> ç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äº¤æ¢æœº </tag>
            
            <tag> S5700 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜ubuntu20.04çº¯å‘½ä»¤è¡Œç½‘å¡é…ç½®</title>
      <link href="posts/e4f7ce4c/"/>
      <url>posts/e4f7ce4c/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>netplan ç”¨äºå±è”½å„ç§ç½‘ç»œç®¡ç†å™¨ï¼Œå®ƒå¯ä»¥è®©ä½ ç”¨ä¸€ä»½é…ç½®ï¼Œå°±å¸®ä½ æŠŠç½‘ç»œç»™é…ç½®å¥½ï¼Œè€Œæ— éœ€ä½ è€ƒè™‘ç½‘ç»œæ§åˆ¶å™¨å¦‚ä½•ä½¿ç”¨ã€‚</p><p>20.04 å·²ç»é»˜è®¤å®‰è£…äº† netplan.</p><h2 id="è®°å½•å½“å‰ç½‘å¡æ ‡è¯†å">è®°å½•å½“å‰ç½‘å¡æ ‡è¯†å</h2><pre><code class="language-bash">ip addr show # ===1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo       valid_lft forever preferred_lft forever    inet6 ::1/128 scope host       valid_lft forever preferred_lft forever2: enp0s31f6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000    link/ether d8:9e:f3:31:83:c8 brd ff:ff:ff:ff:ff:ff</code></pre><p>ä¾‹å¦‚ä¸Šè¿°ä¸­çš„ <code>enp0s31f6</code></p><h2 id="ç¼–è¾‘é…ç½®æ–‡ä»¶">ç¼–è¾‘é…ç½®æ–‡ä»¶</h2><pre><code class="language-bash">cat /etc/netplan/00-installer-config.yaml# ===# This is the network config written by 'subiquity'network:  ethernets:    enp0s31f6:      addresses: [10.200.10.2/24]      dhcp4: no      optional: true      gateway4: 10.200.10.1      nameservers:        addresses: [10.200.10.1]  version: 2  renderer: networkd</code></pre><h2 id="åŠ è½½é…ç½®">åŠ è½½é…ç½®</h2><pre><code class="language-bash">netplan applysystemctl restart networkd-dispatcher.service</code></pre><blockquote><p>ä¹‹åå¦‚æœå†ä¿®æ”¹ ipï¼Œ å†æ¬¡æ‰§è¡Œ <code>netplay apply</code> å³å¯</p></blockquote><h2 id="å‚è€ƒ">å‚è€ƒ</h2><p><a href="https://netplan.io/examples/#configuration">https://netplan.io/examples/#configuration</a></p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> ubuntu </tag>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§â˜mysqlæ…¢sqlé¢„è­¦</title>
      <link href="posts/ab1247fb/"/>
      <url>posts/ab1247fb/</url>
      
        <content type="html"><![CDATA[<h2 id="ç”¨é€”">ç”¨é€”</h2><p>æ£€æµ‹æ•°æ®åº“ä¸­æ‰§è¡Œç¼“æ…¢çš„sqlï¼Œå¹¶è®°å½•é¢„è­¦</p><h2 id="è„šæœ¬">è„šæœ¬</h2><pre><code class="language-bash">#!/bin/bash# by zyh# æ£€æŸ¥æ•°æ®åº“è€—æ—¶è¿‡é•¿çš„è¯­å¥# æ‰€éœ€é…ç½®æ–‡ä»¶:# 1. userfile.txt ç”¨äºåˆ¤æ–­ç¨‹åºç”¨æˆ·çš„sqlæ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶äº†æ€æ­»  ##ç”¨æˆ·å      å¯†ç     è¶…æ—¶æ—¶é—´# 2. database.conf éœ€è¦show full processlistæƒé™  ##Username=  ##Password=  ##Mysqlhostname=  ##Database=  ##Port=# bash start.sh database.conf æ”¾åˆ°è®¡åˆ’ä»»åŠ¡é‡Œ# -------------------------------------------------------------------------------#--å˜é‡--basedir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`currtime=`date &quot;+%Y%m%d_%H%M%S&quot;`#Username=#Password=#Mysqlhostname=#Database=#Port=source $basedir/$1datadir=$basedir/data/$Database-$1/$currtime[[ -d $datadir ]] || mkdir -p $datadir#--main--mysql -s -r -u$Username -p$Password -h$Mysqlhostname -P$Port -e 'show full processlist' | grep -v 'Sleep' |grep -v 'system' | egrep '(Query|Execute)' | grep -i $'\tselect' &gt; $datadir/$Database.allawk -F'\t' 'BEGIN&#123;OFS=&quot;\t&quot;&#125;ARGIND==1&#123;warntime[$1]=$3;warnpwd[$1]=$2&#125; \                ARGIND==2&#123; \                        for( nametime in warntime ) &#123; \                                if( $2 == nametime &amp;&amp; $6 &gt; warntime[$2] ) &#123; \                                        print warnpwd[$2],$0;break \                                &#125; \                        &#125; \                &#125;' $basedir/userfile.txt $datadir/$Database.all &gt; $datadir/$Database.warncat $datadir/$Database.warn | while read warningpwd id warningname other;do        echo &quot;# $&#123;warningname&#125;: $id $other&quot;        echo &quot;mysql -s -r -u$warningname -p$warningpwd -h$Mysqlhostname -P$Port -e 'kill '&quot;$id&quot;'&quot;done &gt; $datadir/kill.sql[[ -s $datadir/kill.sql ]] &amp;&amp; python $&#123;basedir&#125;/sendmail.py 'æ”¶ä»¶äººé‚®ç®±åœ°å€' &quot;[SQL-TimeOut]-$Database&quot; &quot;($Mysqlhostname)The attachment content is timeout SQL information&quot; 'æŠ„é€é‚®ç®±åœ°å€'  &quot;$datadir/kill.sql&quot; || rm -rf $datadir</code></pre><pre><code class="language-python">#!/usr/bin/python#coding:utf-8# by zyh# python sendmail.py 'æ”¶ä»¶äººé‚®ç®±åœ°å€'  'ä¸»é¢˜' 'é‚®ä»¶å†…å®¹' 'æŠ„é€é‚®ç®±åœ°å€' 'é™„ä»¶ç»å¯¹è·¯å¾„'import smtplibfrom email.header import Headerfrom email.mime.text import MIMETextfrom email.mime.multipart import MIMEMultipartimport sysreload(sys)sys.setdefaultencoding('utf8')mail_host = 'smtpæœåŠ¡å™¨åœ°å€'  # ä¾‹å¦‚ smtp.gmail.com:587mail_user = 'å‘ä»¶äººé‚®ç®±'      # ä¾‹å¦‚ it@gmail.commail_pass = 'å‘ä»¶äººå¯†ç 'def send_mail(*args):    argsNum=len(args[0])    if argsNum == 4:        filename,to_list, subject, content=args[0]    elif argsNum == 5:        filename,to_list, subject, content, cc_list=args[0]    elif argsNum == 6:        filename,to_list, subject, content, cc_list, subfile=args[0]    me = mail_user+&quot;&lt;&quot;+mail_user+&quot;&gt;&quot;    #åˆå§‹åŒ–é‚®ä»¶å¯¹è±¡ msg    msg = MIMEMultipart()    msg['From'] = me    msg['to'] = to_list    emailList=to_list    # ä¸»é¢˜    msg['Subject'] = Header(subject, 'utf-8').encode()    # å†…å®¹    msg.attach(MIMEText(content, 'plain', 'utf-8'))    # æŠ„é€    if 'cc_list' in vars():        msg['Cc'] = cc_list        emailstring = to_list+','+cc_list        emailList=emailstring.split(&quot;,&quot;)    # é™„ä»¶    if 'subfile' in vars():        att1 = MIMEText(open((&quot;%s&quot;%subfile),'rb').read(), 'base64', 'utf8')        att1[&quot;Content-Type&quot;] = 'text/plain'        att1[&quot;Content-Disposition&quot;] = 'attachment; filename='+subfile.split('/')[-1] # è¿™é‡Œçš„filenameå¯ä»¥ä»»æ„å†™ï¼Œå†™ä»€ä¹ˆåå­—ï¼Œé‚®ä»¶ä¸­æ˜¾ç¤ºä»€ä¹ˆåå­—        msg.attach(att1)    # å‘é€    try:        print &quot;start sendmail&quot;        s = smtplib.SMTP(mail_host)        print &quot;connect mail server suesscc&quot;        s.starttls()        s.login(mail_user,mail_pass)        print &quot;login mail server suesscc&quot;        s.sendmail(me,emailList,msg.as_string())        s.close()        return True    except Exception,e:        print &quot;%s\t%s&quot;%(to_list,str(e))        return Falseif __name__ == &quot;__main__&quot;:    if len(sys.argv) &lt; 4:        exit()    send_mail(sys.argv)</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webâ˜æœåŠ¡å™¨æ‰¿è½½èƒ½åŠ›è®¡ç®—</title>
      <link href="posts/7c44c2e8/"/>
      <url>posts/7c44c2e8/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>æˆ‘ä»¬åœ¨è¯„ä¼°ä¸€ä¸ªç³»ç»Ÿéœ€è¦å¤šå°‘ä¸ªæœåŠ¡å™¨æ¥æ”¯æ’‘çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šæ¶‰åŠåˆ°å¤šä¸ªç‚¹ã€‚</p><ul><li>pv</li><li>qps</li><li>å¹¶å‘</li><li>å¹³å‡å“åº”æ—¶é—´</li></ul><p>å¦‚æœä½ å·²ç»æœç´¢è¿‡ç›¸å…³ç«™ç‚¹ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªå…¬å¼ï¼šå¹¶å‘=qps*å¹³å‡å“åº”æ—¶é—´</p><p>è¯´å®è¯ï¼Œè¿™ä¸ªå…¬å¼å¾ˆè›‹ç–¼ï¼ŒçŒ›åœ°ä¸€çœ‹è®©äººä¸€è„¸æ‡µé€¼ã€‚è¿™é‡Œæˆ‘æŒ‰ç…§æˆ‘çš„æ–¹å¼æ¥è¯´ä¸€ä¸‹ã€‚</p><p>é¦–å…ˆå°†å…¬å¼å˜å½¢ï¼Œ QPS = å·¥ä½œè¿›ç¨‹æ•° / å¹³å‡å“åº”æ—¶é—´</p><p>å…¶æ¬¡ï¼Œæ¢ç®—ä¸¤è¾¹æ—¶é—´å•ä½éƒ½ä¸ºç§’çº§ï¼Œ QPS = ï¼ˆ1ç§’ / ç§’çº§å¹³å‡å“åº”æ—¶é—´ï¼‰* å·¥ä½œè¿›ç¨‹æ•°</p><p>å†æ¬¡ï¼Œå°†<code>å¹¶å‘</code>ç†è§£ä¸ºç³»ç»Ÿçš„<code>å·¥ä½œè¿›ç¨‹</code>ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå¹¶å‘æ˜¯100ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç®€å•çš„ç†è§£ä¸ºç†æƒ³æƒ…å†µä¸‹100ä¸ªå·¥ä½œè¿›ç¨‹åŒä¸€æ—¶é—´åªèƒ½å¤„ç†100ä¸ªè¯·æ±‚ã€‚</p><p>é‚£ä¹ˆï¼Œ<code>1ç§’ / ç§’çº§å¹³å‡å“åº”æ—¶é—´</code>å°±æ˜¯æŒ‡æ¯ä¸ªå·¥ä½œè¿›ç¨‹1ç§’èƒ½å¤„ç†å¤šå°‘ä¸ªè¯·æ±‚ã€‚</p><p>æ‰€ä»¥ï¼Œæœ€ç»ˆå¾—åˆ° <code>QPS</code>å°±æ˜¯ç³»ç»Ÿæ¯ç§’å¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°ã€‚</p><p>å¦‚æœä½ æ—¥PVæ˜¯ 300Wï¼Œé‚£ä¹ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯å¤©80%çš„è¯·æ±‚é‡éƒ½é›†ä¸­åœ¨æ¯å¤©20%çš„æ—¶é—´é‡Œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºé«˜å³°æ—¶é—´çš„ç§’çº§è¯·æ±‚é‡æ˜¯ 3000000 * 0.8  / ï¼ˆ3600 * 24 * 0.2ï¼‰ = 139</p><p>å› æ­¤ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿæ ¹æ® <code>QPS = å·¥ä½œè¿›ç¨‹æ•° / å¹³å‡å“åº”æ—¶é—´</code> å¾—åˆ°çš„ QPS å¤§äº 139ï¼Œé‚£ä¹ˆä½ çš„ç³»ç»Ÿå°±å¯ä»¥é¡¶ä½ã€‚</p><p>å¦‚æœå°äºï¼Œé‚£ä¹ˆä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p><ol><li>éœ€è¦å¢åŠ å·¥ä½œè¿›ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯å¢åŠ æœåŠ¡å™¨æ•°é‡æˆ–è€…æœåŠ¡å™¨é‡Œçš„å·¥ä½œè¿›ç¨‹</li><li>ä¼˜åŒ–ç³»ç»Ÿï¼Œé™ä½å¹³å‡å“åº”æ—¶é—´</li></ol><blockquote><p>âš ï¸å¢åŠ æœåŠ¡å™¨çš„å·¥ä½œè¿›ç¨‹ï¼Œå¹¶ä¸ä¸€å®šä¼šäº§ç”Ÿæ­£å‘æ•ˆåº”ï¼Œå› ä¸ºå·¥ä½œè¿›ç¨‹è¶Šå¤šï¼Œé‚£ä¹ˆè¿›ç¨‹å°±å¯èƒ½é¢‘ç¹åˆ‡æ¢ï¼Œåè€Œå¯¼è‡´å·¥ä½œè¿›ç¨‹ä¸å¹²æ´»ã€‚</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> web </tag>
            
            <tag> æ‰¿è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜16kubeadmé›†ç¾¤å‡çº§</title>
      <link href="posts/7538d100/"/>
      <url>posts/7538d100/</url>
      
        <content type="html"><![CDATA[<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</a></p><h1>å‡çº§æ ¸å¿ƒèŠ‚ç‚¹</h1><h2 id="åˆ—å‡ºå½“å‰kubeadmç‰ˆæœ¬åˆ—è¡¨">åˆ—å‡ºå½“å‰kubeadmç‰ˆæœ¬åˆ—è¡¨</h2><pre><code class="language-bash">yum list --showduplicates kubeadm --disableexcludes=kubernetes</code></pre><p>â€“disableexcludes=kubernetes åªå…è®¸kubernetesåº“</p><h2 id="æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šæå‰ä¸‹è½½å¥½å‡çº§æ‰€éœ€çš„é•œåƒ">æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šæå‰ä¸‹è½½å¥½å‡çº§æ‰€éœ€çš„é•œåƒ</h2><p>è¿™é‡Œå‡è®¾ä» 1.18.6 =ã€‹ 1.19.3</p><pre><code class="language-bash">kubeadm config images list --kubernetes-version=1.19.3===k8s.gcr.io/kube-apiserver:v1.19.3k8s.gcr.io/kube-controller-manager:v1.19.3k8s.gcr.io/kube-scheduler:v1.19.3k8s.gcr.io/kube-proxy:v1.19.3k8s.gcr.io/pause:3.2k8s.gcr.io/etcd:3.4.3-0k8s.gcr.io/coredns:1.6.7</code></pre><pre><code class="language-bash">#!/bin/bash# kubeadm config images listimages=(kube-apiserver:v1.19.3kube-controller-manager:v1.19.3kube-scheduler:v1.19.3kube-proxy:v1.19.3pause:3.2etcd:3.4.3-0coredns:1.6.7)for imageName in $&#123;images[@]&#125;;do    docker pull registry.aliyuncs.com/google_containers/$&#123;imageName&#125;    docker tag registry.aliyuncs.com/google_containers/$&#123;imageName&#125; k8s.gcr.io/$&#123;imageName&#125;    docker rmi registry.aliyuncs.com/google_containers/$&#123;imageName&#125;done</code></pre><h2 id="ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå®‰è£…ç›®æ ‡ç‰ˆæœ¬çš„kubeadm">ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå®‰è£…ç›®æ ‡ç‰ˆæœ¬çš„kubeadm</h2><pre><code class="language-bash">yum install -y kubeadm-1.19.3-0 --disableexcludes=kubernetes</code></pre><p>å‡çº§è®¡åˆ’æ˜¯ä»¥kubeadmçš„ç‰ˆæœ¬ä¸ºåŸºå‡†çš„ï¼Œå¦‚æœä½ kubeadmçš„ç‰ˆæœ¬æ˜¯1.18ï¼Œé‚£ä¹ˆä¹‹åkubeadmåˆ—å‡ºçš„å‡çº§ä¿¡æ¯å°±æ˜¯å‡çº§åˆ°1.18çš„æœ€æ–°ç¨³å®šç‰ˆ</p><h2 id="ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šåœæ­¢è°ƒåº¦">ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šåœæ­¢è°ƒåº¦</h2><p>è¿™é‡Œä»¥k8s01èŠ‚ç‚¹ä¸ºä¾‹</p><pre><code class="language-bash:">kubectl drain k8s01 --ignore-daemonsets</code></pre><p>â€“ignore-daemonsets å¿½ç•¥ daemonsetsï¼Œå› ä¸º daemonsets ä¼šåœ¨é©±é€èŠ‚ç‚¹ä¸Šé‡å»º pod ä»è€Œå¯¼è‡´é©±é€å¤±è´¥ã€‚</p><pre><code class="language-bash">kubectl get node===NAME    STATUS                     ROLES    AGE   VERSIONk8s01   Ready,SchedulingDisabled   master   40h   v1.18.6</code></pre><h2 id="ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šåˆ—å‡ºå‡çº§è®¡åˆ’">ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šåˆ—å‡ºå‡çº§è®¡åˆ’</h2><p>åœ¨k8s01åˆ—å‡ºå‡çº§è®¡åˆ’</p><pre><code class="language-bash">kubeadm upgrade plan</code></pre><p>ä¼šè¾“å‡ºä¸‰éƒ¨åˆ†å†…å®¹ï¼Œç¬¬ä¸€æ­¥æ˜¯å½“å‰é›†ç¾¤ä¿¡æ¯</p><pre><code>[upgrade/config] Making sure the configuration is correct:[upgrade/config] Reading configuration from the cluster...[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'[preflight] Running pre-flight checks.[upgrade] Running cluster health checks[upgrade] Fetching available versions to upgrade to[upgrade/versions] Cluster version: v1.18.6[upgrade/versions] kubeadm version: v1.19.3[upgrade/versions] Latest stable version: v1.19.3[upgrade/versions] Latest stable version: v1.19.3[upgrade/versions] Latest version in the v1.18 series: v1.18.10[upgrade/versions] Latest version in the v1.18 series: v1.18.10</code></pre><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯å‡çº§ä¿¡æ¯ï¼Œå‡çº§ä¿¡æ¯åˆåˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚</p><ul><li>å‡çº§åˆ°å½“å‰ç‰ˆæœ¬çš„æœ€æ–°ç¨³å®š</li></ul><pre><code>Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':COMPONENT   CURRENT       AVAILABLEkubelet     3 x v1.18.6   v1.18.10Upgrade to the latest version in the v1.18 series:COMPONENT                 CURRENT   AVAILABLEkube-apiserver            v1.18.6   v1.18.10kube-controller-manager   v1.18.6   v1.18.10kube-scheduler            v1.18.6   v1.18.10kube-proxy                v1.18.6   v1.18.10CoreDNS                   1.6.7     1.7.0etcd                      3.4.3-0   3.4.3-0You can now apply the upgrade by executing the following command:        kubeadm upgrade apply v1.18.10</code></pre><ul><li>å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬</li></ul><pre><code>Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':COMPONENT   CURRENT       AVAILABLEkubelet     3 x v1.18.6   v1.19.3Upgrade to the latest stable version:COMPONENT                 CURRENT   AVAILABLEkube-apiserver            v1.18.6   v1.19.3kube-controller-manager   v1.18.6   v1.19.3kube-scheduler            v1.18.6   v1.19.3kube-proxy                v1.18.6   v1.19.3CoreDNS                   1.6.7     1.7.0etcd                      3.4.3-0   3.4.13-0You can now apply the upgrade by executing the following command:        kubeadm upgrade apply v1.19.3</code></pre><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯æ‰‹åŠ¨æ›´æ–°éƒ¨åˆ†</p><pre><code class="language-:">The table below shows the current state of component configs as understood by this version of kubeadm.Configs that have a &quot;yes&quot; mark in the &quot;MANUAL UPGRADE REQUIRED&quot; column require manual config upgrade orresetting to kubeadm defaults before a successful upgrade can be performed. The version to manuallyupgrade to is denoted in the &quot;PREFERRED VERSION&quot; column.API GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIREDkubeproxy.config.k8s.io   v1alpha1          v1alpha1            nokubelet.config.k8s.io     v1beta1           v1beta1             no</code></pre><p>â­ï¸å¦‚æœ<code>MANUAL UPGRADE REQUIRED</code>æ ‡è®°æ˜¯<code>yes</code>ï¼Œåˆ™ä½ éœ€è¦æ‰‹åŠ¨è¿›è¡Œå‡çº§ã€‚æ‰‹åŠ¨å‡çº§çš„å‰ææ˜¯éœ€è¦è‡ªè¡Œæä¾›é…ç½®æ–‡ä»¶</p><pre><code class="language-bash">kubeadm upgrade apply --config &lt;é…ç½®æ–‡ä»¶&gt;</code></pre><p>å¦å¤–ï¼Œkubeadm upgrade æ€»æ˜¯ä¼šåˆ·æ–°è¯ä¹¦ã€‚</p><h2 id="ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§">ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§</h2><pre><code class="language-bash">kubeadm upgrade apply v1.19.3</code></pre><h2 id="ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ç½‘ç»œæ’ä»¶">ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ç½‘ç»œæ’ä»¶</h2><p>è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ flannel. æ‰€ä»¥æˆ‘åªæ˜¯ç®€å•çš„é‡æ–°æ‰§è¡Œä¸€è¾¹</p><pre><code class="language-bash">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml# ä¿®æ”¹é‡Œé¢çš„ &quot;Network&quot;: &quot;10.244.0.0/16&quot;, å˜æ›´ä¸ºä½ è‡ªå·±çš„ pod ç½‘æ®µï¼Œå³kubeadmåˆå§‹åŒ–é˜¶æ®µçš„ --pod-network-cidrkubectl apply -f  kube-flannel.yml</code></pre><h2 id="ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šè§£é”ä½¿å…¶å¯ä»¥è°ƒåº¦">ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šè§£é”ä½¿å…¶å¯ä»¥è°ƒåº¦</h2><pre><code class="language-bash">kubectl uncordon k8s01kubectl get node===NAME    STATUS   ROLES    AGE   VERSIONk8s01   Ready    master   46h   v1.18.6k8s02   Ready    master   45h   v1.18.6k8s03   Ready    master   45h   v1.18.6</code></pre><p>ç¡®ä¿k8s01å¤„äºReadyçŠ¶æ€ï¼Œè¿™é‡Œæš‚æ—¶ç‰ˆæœ¬è¿˜æ˜¯æ—§ç‰ˆæœ¬ï¼Œå› ä¸ºä½ æœåŠ¡æ²¡æœ‰é‡å¯</p><h2 id="æ¬¡è¦æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§">æ¬¡è¦æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§</h2><pre><code class="language-bash">appVersion=1.19.3-0nodeHostname=yum install -y kubeadm-$&#123;appVersion&#125; --disableexcludes=kuberneteskubectl drain $&#123;nodeHostname&#125; --ignore-daemonsetskubeadm upgrade nodekubectl uncordon $&#123;nodeHostname&#125;</code></pre><p>ä½ åªéœ€æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œæ— éœ€æ‰§è¡Œå…¶å®ƒå‘½ä»¤</p><h2 id="æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§-kubelet-å’Œ-kubectl">æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šå‡çº§ kubelet å’Œ kubectl</h2><pre><code class="language-bash">appVersion=1.19.3-0yum install -y kubelet-$&#123;appVersion&#125; kubectl-$&#123;appVersion&#125; --disableexcludes=kubernetes</code></pre><p>é‡å¯ä¸¤ä¸ªç»„ä»¶</p><pre><code class="language-bash">systemctl daemon-reloadsystemctl restart kubelet</code></pre><h2 id="æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šå¼€å¯-kube-scheduler-å’Œ-kube-controller-manager-ç«¯å£">æ‰€æœ‰æ ¸å¿ƒèŠ‚ç‚¹ï¼šå¼€å¯ kube-scheduler å’Œ kube-controller-manager ç«¯å£</h2><p>è‹¥å‘ç°<code>kubectl get cs</code> ä¸¤ä¸ªæœåŠ¡æ— æ³•è¿æ¥ï¼Œåˆ™å¯ä»¥çœ‹ä¸‹é…ç½®ç«¯å£æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œä¸‹åˆ—å‘½ä»¤</p><pre><code class="language-bash">sed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-scheduler.yamlsed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-controller-manager.yaml</code></pre><p>ğŸŒŸä¸ä¸€å®šéœ€è¦æ‰§è¡Œï¼Œå…·ä½“ä»¥å®é™…ç¯å¢ƒä¸ºå‡†</p><h1>å‡çº§å·¥ä½œèŠ‚ç‚¹</h1><p>æˆ‘è¿™é‡Œæµ‹è¯•ç¯å¢ƒï¼Œæ ¸å¿ƒèŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹æ˜¯é‡å çš„ï¼Œæ‰€ä»¥æ— éœ€å†å‡çº§å·¥ä½œèŠ‚ç‚¹ã€‚</p><pre><code class="language-bash">appVersion=1.19.3-0nodeName=# å‡çº§kubeadmyum install -y kubeadm-$&#123;appVersion&#125; --disableexcludes=kubernetes# é”å®šnodekubectl drain $&#123;nodeName&#125; --ignore-daemonsets# å‡çº§nodekubeadm upgrade node# å‡çº§ kubelet å’Œ kubectlyum install -y kubelet-$&#123;appVersion&#125; kubectl-$&#123;appVersion&#125; --disableexcludes=kubernetes# é‡å¯systemctl daemon-reloadsystemctl restart kubelet# è§£é”nodekubectl uncordon $&#123;nodeName&#125;</code></pre><h1>ä¸»æ ¸å¿ƒèŠ‚ç‚¹å‡çº§å¤±è´¥ï¼Œä¸”è‡ªåŠ¨å›æ»šå¤±è´¥</h1><h2 id="ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå°è¯•å¼ºåˆ¶å‡çº§">ä¸»æ ¸å¿ƒèŠ‚ç‚¹ï¼šå°è¯•å¼ºåˆ¶å‡çº§</h2><pre><code class="language-bash">appVersion=1.19.3-0kubeadm upgrade apply --force $&#123;appVersion&#125;</code></pre><h2 id="æ— è®ºå¦‚ä½•éƒ½å¤±è´¥ï¼Œæ‰‹åŠ¨æ¢å¤">æ— è®ºå¦‚ä½•éƒ½å¤±è´¥ï¼Œæ‰‹åŠ¨æ¢å¤</h2><p>å‡çº§å‰ï¼Œkubernetes ä¼šå¤‡ä»½ etcd å’Œ é™æ€podçš„å†…å®¹</p><p>å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><p><code>/etc/kubernetes/tmp/kubeadm-backup-etcd-&lt;date&gt;-&lt;time&gt;/etcd</code>= <code>/var/lib/etcd/</code></p><p><code>/etc/kubernetes/tmp/kubeadm-backup-manifests-&lt;date&gt;-&lt;time&gt;</code>= <code> /etc/kubernetes/manifests/</code></p><p>å°†ç­‰å·å·¦è¾¹çš„è·¯å¾„å†…å®¹è¦†ç›–åˆ°ç­‰å·å³è¾¹ï¼Œä»¥ä¾¿äºé™æ€podé‡å»º</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> kubeadm </tag>
            
            <tag> å‡çº§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜15è¯ä¹¦ç®¡ç†</title>
      <link href="posts/55da993d/"/>
      <url>posts/55da993d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>k8sé»˜è®¤çš„CAè¯ä¹¦æœ‰æ•ˆæœŸæ˜¯10å¹´ã€‚é»˜è®¤ç­¾å‘çš„æœåŠ¡è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯1å¹´ã€‚</p><p>k8sæ”¯æŒè‡ªåŠ¨è½®æ¢è¯ä¹¦ã€‚</p><p>k8sæ”¯æŒè½®æ¢æ—¶å€™çš„è¯ä¹¦æœ‰æ•ˆæœŸã€‚ä¸è¿‡æœ€é•¿æ˜¯10å¹´ã€‚ï¼ˆæˆ‘è¿™è¾¹è®¾ç½®ä¸º100å¹´ï¼Œæ²¡æ•ˆæœï¼‰</p><p><a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/</a></p><h2 id="æ£€æŸ¥å½“å‰æ§åˆ¶é¢èŠ‚ç‚¹é‡Œè¯ä¹¦">æ£€æŸ¥å½“å‰æ§åˆ¶é¢èŠ‚ç‚¹é‡Œè¯ä¹¦</h2><pre><code class="language-bash">kubeadm alpha certs check-expiration</code></pre><p>ä½ å¯ä»¥é€šè¿‡æ­¤å‘½ä»¤æŸ¥çœ‹å„ç±»è¯ä¹¦çš„æœ‰æ•ˆæœŸ</p><h2 id="è§¦å‘è‡ªåŠ¨è½®æ¢è¯ä¹¦çš„è¡Œä¸º">è§¦å‘è‡ªåŠ¨è½®æ¢è¯ä¹¦çš„è¡Œä¸º</h2><p>å½“ä½ é€šè¿‡kubeadm upgrade nodeå‘½ä»¤è¿›è¡Œå‡çº§æˆ–è€…é€šè¿‡control planeè¿›è¡Œå‡çº§çš„æ—¶å€™ï¼Œk8sä¼šè‡ªåŠ¨è½®æ¢è¯ä¹¦ã€‚</p><h2 id="é€šè¿‡å‘½ä»¤æ‰‹åŠ¨è§¦å‘è¯ä¹¦è½®æ¢">é€šè¿‡å‘½ä»¤æ‰‹åŠ¨è§¦å‘è¯ä¹¦è½®æ¢</h2><p><code>kubeadm alpha certs renew all</code>ä½ å¯ä»¥é€šè¿‡æ­¤å‘½ä»¤è¿›è¡Œæ‰€æœ‰è¯ä¹¦è½®æ¢</p><p>â­ï¸è¯·æ³¨æ„ï¼Œå¦‚æœä½ è¿è¡Œäº†é«˜å¯ç”¨é›†ç¾¤ï¼Œåˆ™éœ€è¦åœ¨æ‰€æœ‰çš„control-planeèŠ‚ç‚¹ä¸Šè¿è¡Œæ­¤å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸»èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p><h2 id="ä¸ºkubeleté…ç½®è¯ä¹¦è‡ªåŠ¨è½®è½¬">ä¸ºkubeleté…ç½®è¯ä¹¦è‡ªåŠ¨è½®è½¬</h2><p><a href="https://kubernetes.io/docs/tasks/tls/certificate-rotation/">https://kubernetes.io/docs/tasks/tls/certificate-rotation/</a></p><p>â­ï¸1.18å’Œ1.19æœ‰å·®å¼‚ã€‚1.18æ˜¯å·²ç»é»˜è®¤å¼€å¯çš„ï¼Œä¸è¿‡é»˜è®¤çš„è½®è½¬çš„è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯1å¹´</p><p>ä½¿ç”¨è‡ªåŠ¨è½®è½¬ï¼Œéœ€è¦å¼€å¯ä¸¤ä¸ªæœåŠ¡çš„é…ç½®ï¼š</p><ul><li><p>å¼€å¯kubeletå¯åŠ¨æ ‡è®°ï¼š<code>--rotate-certificates=true</code></p><p>â­ï¸å¼€å¯ç¡®è®¤å‘½ä»¤ï¼š<code>kubectl describe cm/kubelet-config-1.18 -n kube-system | grep 'rotateCertificates'</code></p><p>â­ï¸åŠ¨æ€çš„ä¿®æ”¹kubelet <a href="https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/#reconfiguring-the-kubelet-on-a-running-node-in-your-cluster">https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/#reconfiguring-the-kubelet-on-a-running-node-in-your-cluster</a></p><pre><code class="language-bash"># è¯·å…ˆå®‰è£… jq å‘½ä»¤. ä»–æ˜¯ epel é‡Œçš„# å¼€å¯ä»£ç†ç›‘å¬kubectl proxy --port=8001 # å¯¼å‡ºkubeleté…ç½®NODE_NAME=&quot;èŠ‚ç‚¹å&quot;; curl -sSL &quot;http://localhost:8001/api/v1/nodes/$&#123;NODE_NAME&#125;/proxy/configz&quot; | jq '.kubeletconfig|.kind=&quot;KubeletConfiguration&quot;|.apiVersion=&quot;kubelet.config.k8s.io/v1beta1&quot;' &gt; kubelet_configz_$&#123;NODE_NAME&#125;# ç¼–è¾‘å®Œé…ç½®ï¼Œé‡æ–°å¯¼å…¥ï¼Œå¹¶ç¡®è®¤æ–°é…ç½®å¯¹è±¡åkubectl -n kube-system create configmap node-config-new --from-file=kubelet=kubelet_configz_$&#123;NODE_NAME&#125; --append-hash -o yaml# è°ƒæ•´æ¯ä¸€ä¸ªnodeå¯¹è±¡ï¼Œæ·»åŠ æ–°çš„é…ç½®å¯¹è±¡kubectl edit node $&#123;NODE_NAME&#125;===configSource:    configMap:        name: CONFIG_MAP_NAME # å°†è¿™ä¸ªåå­—æ›¿æ¢æˆæ–°çš„é…ç½®å¯¹è±¡å        namespace: kube-system        kubeletConfigKey: kubelet# æ£€æŸ¥é…ç½®ç”Ÿæ•ˆkubectl get node $&#123;NODE_NAME&#125; -o json | jq '.status.config'</code></pre></li><li><p>è°ƒæ•´é»˜è®¤è¯ä¹¦æœ‰æ•ˆæœŸ</p><p>å¼€å¯<code>kube-controller-manager</code>å¯åŠ¨æ ‡è®°ï¼š<code>--cluster-signing-duration</code>ï¼Œè¿™ä¸ªæ ‡è®°é»˜è®¤æ˜¯1å¹´ï¼Œä½ å¯ä»¥æ”¹æˆ10å¹´ <code>87600h0m0s</code></p><p>ä¿®æ”¹ä½ç½®ï¼š<code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code></p><p>ä¿®æ”¹ç”Ÿæ•ˆï¼škube-controller-manager pod å°†è‡ªåŠ¨é‡å»º</p><p>âš ï¸å¦‚æœæ˜¯1.18ï¼Œåˆ™å¯åŠ¨æ ‡è®°æ˜¯<code>--experimental-cluster-signing-duration</code></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> è¯ä¹¦ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜14è®¤è¯æˆæƒ</title>
      <link href="posts/a5ed67a6/"/>
      <url>posts/a5ed67a6/</url>
      
        <content type="html"><![CDATA[<p>è¿™é‡Œæ˜¯ä¸€ä¸ªè®¤è¯çš„ä¸€ä¸ªåŸºæœ¬æµç¨‹ï¼š</p><p><img src="/posts/a5ed67a6/image-20201016114248549.png" alt="image-20201016114248549"></p><p>å³ï¼š kubectl =&gt; ç”¨æˆ·è®¤è¯ =&gt; ç”¨æˆ·æˆæƒ =&gt; å…¥å£æ§åˆ¶ -&gt; èµ„æºå¯¹è±¡</p><p>ç”¨æˆ·è®¤è¯ï¼šæ£€æŸ¥é€’äº¤ä¿¡æ¯åŒ…å«çš„è¯ä¹¦ï¼Œç”¨æˆ·å</p><p>ç”¨æˆ·æˆæƒï¼šç»™ç”¨æˆ·æˆæƒæƒé™ç­–ç•¥ï¼Œæˆæƒæ–¹å¼æœ‰å¤šç§ï¼šABAC mode, RBAC Mode, and Webhook mode</p><p>å…¥å£æ§åˆ¶å™¨ï¼šå…·æœ‰ç‰¹æ®ŠåŠŸèƒ½çš„è¿‡æ»¤å™¨ï¼Œä»–ä»¬ä¼šæŠŠè¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œå¦‚æœè¯·æ±‚è¿åäº†è¿‡æ»¤å™¨çš„é…ç½®ï¼Œåˆ™è¯·æ±‚ä¼šè¢«æ‹’ç»ã€‚</p><p>å½“ä½ ä»ä½¿ç”¨è€…è§’åº¦æ¥çœ‹çš„æ—¶å€™ï¼Œk8sæŠŠç”¨æˆ·åˆ†ä¸ºæ™®é€šç”¨æˆ·å’ŒæœåŠ¡ç”¨æˆ·ã€‚æ™®é€šç”¨æˆ·å¯¹å¤–ï¼ˆä¹Ÿå°±æ˜¯ä¸Šå›¾é‡Œçš„Humanï¼‰ï¼ŒæœåŠ¡ç”¨æˆ·å¯¹å†…ï¼ˆä¹Ÿå°±æ˜¯ä¸Šå›¾é‡Œçš„Podï¼‰ã€‚</p><p>è¯·è®°ä½ï¼Œk8så¹¶æ²¡æœ‰æ™®é€šç”¨æˆ·çš„<strong>å®ä½“å¯¹è±¡</strong>ã€‚å› æ­¤ï¼Œåªè¦ä½ é€’äº¤çš„ç”¨æˆ·æ‹¥æœ‰k8sé›†ç¾¤å†…éƒ¨CAæ‰€ç­¾å‘çš„è¯ä¹¦ï¼Œé‚£ä¹ˆè¿™ä¸ªç”¨æˆ·å°±ä¼šè¢«rbacå­ç³»ç»Ÿè®¤ä¸ºæ˜¯æœ‰æ•ˆçš„ã€‚</p><h2 id="æ™®é€šç”¨æˆ·">æ™®é€šç”¨æˆ·</h2><h3 id="æ„å»ºæ™®é€šç”¨æˆ·ï¼Œç”¨äºç”¨æˆ·è®¤è¯é˜¶æ®µ">æ„å»ºæ™®é€šç”¨æˆ·ï¼Œç”¨äºç”¨æˆ·è®¤è¯é˜¶æ®µ</h3><p><a href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user">https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user</a></p><ol><li><p>åˆ›å»ºç§é’¥key, è¯ä¹¦è¯·æ±‚csr</p><p>åˆ›å»ºç§é’¥ä¼šè®©ä½ å¡«å†™ä¸€äº›å±æ€§ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå±æ€§ç‰¹åˆ«é‡è¦ï¼Œåˆ†åˆ«æ˜¯æŒ‡å®šç”¨æˆ·åçš„å±æ€§CNå’ŒæŒ‡å®šç”¨æˆ·ç»„çš„å±æ€§O</p><pre><code>openssl genrsa -out zyh.key 2048</code></pre></li></ol><p>openssl req -new -key zyh.key -out zyh.csr -subj â€œ/CN=zyh/O=itâ€</p><pre><code>2. æ„å»ºk8sçš„CertificateSigningRequestå¯¹è±¡ç¬¬ä¸€æ­¥ï¼šcsræ–‡ä»¶è¿›è¡Œbase64ç¼–ç ```bashRequestStr=`cat zyh.csr | base64 | tr -d &quot;\n&quot;`</code></pre><p>ç¬¬äºŒæ­¥ï¼šå°†ç¼–ç åçš„å†…å®¹å†™å…¥ request å­—æ®µ</p><pre><code class="language-yaml">cat &lt;&lt;EOF | kubectl apply -f -apiVersion: certificates.k8s.io/v1beta1kind: CertificateSigningRequestmetadata:  name: zyhspec:  groups:  - system:authenticated  request: $&#123;RequestStr&#125;  signerName: kubernetes.io/kube-apiserver-client  usages:  - client authEOF</code></pre><p>â­ï¸usageså­—æ®µå¿…é¡»æ˜¯<code>client auth</code></p><p>ğŸŒŸå¦‚æœä½ ç”¨çš„æ˜¯1.19ç‰ˆæœ¬ï¼Œé‚£ä¹ˆapiVersionæ˜¯<code>certificates.k8s.io/v1</code></p><p>â­ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯ä¹¦ç­¾å‘é»˜è®¤åªæœ‰1å¹´æœ‰æ•ˆæœŸ</p><p>ğŸŒŸç¡®ä¿å½“å‰ csr æ²¡æœ‰é‡åç”³è¯·</p><ol start="3"><li><p>æ‰¹å‡†è¯ä¹¦è¯·æ±‚ï¼Œå¹¶è·å–è¯ä¹¦</p><p>æ‰¹å‡†ï¼š</p><pre><code class="language-bash">kubectl get csrkubectl certificate approve zyh</code></pre><p>è·å–ï¼š</p><pre><code class="language-bash">kubectl get csr zyh -o jsonpath='&#123;.status.certificate&#125;' | base64 --decode &gt; zyh.crt</code></pre><p>â­ï¸æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸï¼šâ€‹<code>openssl x509 -in zyh.crt -noout -dates</code></p><p>è‡³æ­¤ï¼Œä¸€ä¸ªæ™®é€šç”¨æˆ·å°±åˆ›å»ºå®Œæ¯•äº†ã€‚ä½†æ˜¯å®ƒæ²¡æœ‰ä»»ä½•æƒé™ï¼Œè¿˜éœ€è¦è¿›è¡Œæˆæƒã€‚</p></li></ol><h3 id="åˆ›å»ºè§’è‰²å’Œç»‘å®šè§’è‰²ï¼Œç”¨äºç”¨æˆ·æˆæƒé˜¶æ®µ">åˆ›å»ºè§’è‰²å’Œç»‘å®šè§’è‰²ï¼Œç”¨äºç”¨æˆ·æˆæƒé˜¶æ®µ</h3><p>æˆæƒå°±æ˜¯ç»™è¿™ä¸ªç”¨æˆ·ç»‘å®šä¸€ä¸ªå…·ä½“çš„è§’è‰²ã€‚è§’è‰²ä»£è¡¨äº†ä¸€ç§æƒé™é›†åˆã€‚</p><ol><li><p>åˆ›å»ºè§’è‰²å¯¹è±¡èµ„æºï¼Œåˆ›å»ºä¸€ä¸ªdeveloperè§’è‰²ï¼Œæƒé™æ˜¯æ‹¥æœ‰podèµ„æºçš„å¢åˆ æ”¹æŸ¥ï¼Œä¸”<strong>å‘½åç©ºé—´æ˜¯developer</strong></p><pre><code class="language-bash">kubectl create role developer --verb=create --verb=get --verb=list --verb=update --verb=delete --resource=pods --namespace=developer</code></pre></li><li><p>åˆ›å»ºè§’è‰²ç»‘å®šå¯¹è±¡èµ„æºï¼Œä¸”<strong>å‘½åç©ºé—´æ˜¯developer</strong></p><pre><code class="language-bash">kubectl create rolebinding developer-binding-zyh --role=developer --user=zyh --namespace=developer</code></pre></li></ol><h3 id="æ·»åŠ æ™®é€šç”¨æˆ·åˆ°kubectlçš„é…ç½®æ–‡ä»¶">æ·»åŠ æ™®é€šç”¨æˆ·åˆ°kubectlçš„é…ç½®æ–‡ä»¶</h3><ol><li><p>æ·»åŠ ç”¨æˆ·è¯ä¹¦åˆ°kubectlé…ç½®</p><pre><code class="language-bash">kubectl config set-credentials zyh --client-key=zyh.key --client-certificate=zyh.crt --embed-certs=true</code></pre></li><li><p>è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œæ–¹ä¾¿è¿›è¡Œç”¨æˆ·åˆ‡æ¢</p><pre><code class="language-bash">kubectl config set-context zyh --cluster=kubernetes --user=zyh</code></pre></li><li><p>é€šè¿‡ç”¨æˆ·ä¸Šä¸‹æ–‡è¿›è¡Œç”¨æˆ·åˆ‡æ¢</p><pre><code class="language-bash">kubectl config use-context zyh</code></pre></li><li><p>æµ‹è¯•æƒé™</p><pre><code class="language-bash">kubectl get pod -n developer===No resources found in developer namespace.kubectl get svc -n developer===Error from server (Forbidden): services is forbidden: User &quot;zyh&quot; cannot list resource &quot;services&quot; in API group &quot;&quot; in the namespace &quot;developer&quot;</code></pre></li></ol><p>é€šè¿‡ä¸Šè¿°åˆ›å»ºè¿‡ç¨‹ï¼Œä½ å¯ä»¥å‘ç°ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µå…¶å®æ˜¯åˆ†ç¦»çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥åˆ›å»ºå¤šä¸ªç”¨æˆ·ï¼Œç„¶åç”¨åŒä¸€ä¸ªè§’è‰²ç»‘å®šå¤šä¸ªç”¨æˆ·ã€‚</p><p>è€Œç”¨æˆ·çš„æœ‰æ•ˆæœŸï¼Œå–å†³äºä½ è¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚</p><h2 id="æœåŠ¡ç”¨æˆ·">æœåŠ¡ç”¨æˆ·</h2><p>æœåŠ¡è´¦æˆ·é»˜è®¤æ˜¯è‡ªåŠ¨åŒ–åˆ›å»ºçš„ã€‚<a href="https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/#service-account-automation">https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/#service-account-automation</a></p><p>æš‚æ—¶è¿˜æ²¡å‘ç°æ‰‹åŠ¨åˆ›å»ºçš„åœºæ™¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> authorization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜09å­˜å‚¨èµ„æº</title>
      <link href="posts/1080c6b6/"/>
      <url>posts/1080c6b6/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨ä½¿ç”¨äº‘æœåŠ¡çš„æ—¶å€™,æˆ‘ä»¬åˆ›å»ºç£ç›˜,éœ€è¦åœ¨å­˜å‚¨æœåŠ¡ä¸­æäº¤ä¸€ä¸ªè¯·æ±‚,é‡Œé¢åŒ…å«äº†ç£ç›˜ç±»å‹,ç£ç›˜å¤§å°.ä¹‹å,æˆ‘ä»¬å†æŠŠè¿™ä¸ªç”³è¯·çš„ç£ç›˜æŒ‚è½½åˆ°æ‰€éœ€çš„è®¡ç®—èµ„æºä¸Šå³å¯.</p><p>è€Œåœ¨k8sä¸­. å½“ä½¿ç”¨å­˜å‚¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹ä¸»è¦æ¦‚å¿µ</p><p>æ„å»ºå­˜å‚¨çš„æ¦‚å¿µï¼š</p><ul><li><p>volume # è¿™ä¸ªæ¦‚å¿µæŒ‡çš„æ˜¯æä¾›çš„å­˜å‚¨æœåŠ¡ï¼Œä¾‹å¦‚äº‘å•†çš„äº‘ç›˜ï¼ˆaws-ebsï¼Œé˜¿é‡Œäº‘-äº‘ç›˜ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯nfs/cephfsã€‚</p></li><li><p>pv æˆ–è€… storageclass # è¿™ä¸ªæ¦‚å¿µä½ å¯ä»¥è®¤ä¸ºæ˜¯äº‘æœåŠ¡å•†çš„å­˜å‚¨æœåŠ¡çš„æ¥å£ï¼ˆä¾‹å¦‚webæ§åˆ¶å°æ“ä½œç•Œé¢ï¼‰ã€‚å½“ç„¶ï¼Œä½ éœ€è¦è‡ªå·±æä¾›æ¥å£æ‰€éœ€è¦çš„å­˜å‚¨ä¿¡æ¯ï¼Œå¦åˆ™ï¼Œk8så°±ä¸çŸ¥é“åº”è¯¥å¦‚ä½•ä½¿ç”¨ volumeã€‚</p></li><li><p>pvc # è¿™ä¸ªæ¦‚å¿µä½ å¯ä»¥è®¤ä¸ºæ˜¯ä½ å‘äº‘æœåŠ¡å•†å­˜å‚¨æ¥å£æäº¤çš„åˆ›å»ºè¯·æ±‚ã€‚é€šè¿‡ pvcï¼Œä½ å°±å¯ä»¥æ‹¿åˆ°ä¸€å—å¯ç”¨çš„å­˜å‚¨ç›˜äº†ã€‚</p></li></ul><p>ä½¿ç”¨å­˜å‚¨çš„æ¦‚å¿µï¼š</p><ul><li>podtemplate.spec.volumes  # è¿™ä¸ªæ¦‚å¿µä½ å¯ä»¥è®¤ä¸ºæ˜¯äº‘æœåŠ¡å•†ä¸­ä½ å°†ç£ç›˜ç»‘å®šåˆ°è®¡ç®—èµ„æº</li><li>podtemplate.spec.containers.volumeMounts  # è¿™ä¸ªæ¦‚å¿µä½ å¯ä»¥è®¤ä¸ºæ˜¯ä½ ç™»é™†åˆ°äº‘æœåŠ¡å•†ä¸­çš„è®¡ç®—èµ„æºä¸­,å¹¶ä½¿ç”¨mountå‘½ä»¤è¿›è¡Œå®é™…æŒ‚è½½.</li></ul><p>ä½ å¯èƒ½ä¼šå‘ç°ï¼Œä»ä¸€ä¸ªæ­£å¸¸é€»è¾‘æ¥è¯´ï¼Œä¸€ä¸ªvolumeå¦‚æœè¦åœ¨è®¡ç®—èµ„æºä¸­ä½¿ç”¨ï¼Œå®ƒæ˜¯éœ€è¦æ ¼å¼åŒ–ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ï¼Œä½†æ˜¯æˆ‘ä¸Šé¢çš„æ¦‚å¿µæ˜¯ç›´æ¥å°±æŒ‚è½½æˆäº†ä¸€ä¸ªç›®å½•ã€‚è¿™æ˜¯å› ä¸ºk8så·²ç»åœ¨ä½ é€šè¿‡pvèµ„æºå¸®ä½ åˆ›å»ºå¥½äº†æ–‡ä»¶ç³»ç»Ÿã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡å°†pvçš„æ¨¡å¼æ”¹ä¸ºå—è®¾å¤‡ï¼Œä¸è¿‡è¿™æ ·ä¸€æ¥ï¼Œç¨‹åºå°±éœ€è¦ç¡®è®¤æ˜¯å¦å¯ä»¥è¯†åˆ«å—è®¾å¤‡äº†ã€‚æˆ‘æƒ³ä¸€èˆ¬çš„åº”ç”¨ç¨‹åºæ˜¯ç”¨ä¸ä¸Šè¿™ä¸ªç±»å‹çš„ã€‚<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#volume-mode">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#volume-mode</a></p><h2 id="pv">pv</h2><p>pod ä¸ pv ä¸ pvc ä¹‹é—´æ˜¯å¼ºä¾èµ–å…³ç³»ã€‚åœ¨èµ„æºå¯¹è±¡è¢«è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªåˆ é™¤æ“ä½œéƒ½ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸä¹‹åæ‰ä¼šæ‰§è¡Œã€‚</p><p>åˆ†ä¸ºé™æ€å’ŒåŠ¨æ€</p><p>é™æ€pv: éœ€è¦å…ˆåˆ›å»ºä¸€å®šæ•°é‡çš„pv, æ‰èƒ½é€šè¿‡pvcç”³è¯·æˆåŠŸ.</p><p>åŠ¨æ€pv: éœ€è¦å…ˆæ„å»ºä¾›åº”å•†.ä¸»æµçš„äº‘å•†å­˜å‚¨åŸºæœ¬éƒ½æœ‰ä¾›åº”å•†, åŒºåˆ«åœ¨äºæ˜¯å†…ç½®äº†,è¿˜æ˜¯éœ€è¦è‡ªè¡Œå¤–éƒ¨åˆ›å»º.ç„¶åå†é€šè¿‡pvcå»ç”³è¯·.</p><p>å†…ç½®ä¾›åº”å•†åˆ—è¡¨: <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner">https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner</a></p><p>å¤–ç½®ä¾›åº”å•†éƒ¨ç½²: <a href="https://github.com/kubernetes-retired/external-storage">https://github.com/kubernetes-retired/external-storage</a></p><h3 id="é™æ€PV">é™æ€PV</h3><p>é™æ€PV, ç”¨æˆ·æ— æ³•è‡ªè¡Œé€šè¿‡pvcå»ç”³è¯·, å› ä¸ºå­˜å‚¨ç®¡ç†å‘˜éœ€è¦å…ˆåˆ›å»ºå¥½åŒ¹é…å®¹é‡çš„pvæ‰å¯ä»¥.å°±å¦‚åŒä½ æƒ³æ„å»ºä¸€ä¸ªäº‘æœåŠ¡å™¨ï¼Œä½†éœ€è¦å…ˆåˆ›å»ºå¥½ä¸€ä¸ªäº‘ç›˜ã€‚</p><p>ä¸€ä¸ªpvçš„ä¾‹å­, è¿™é‡Œä»¥ nfs ä¸ºä¾‹:</p><pre><code class="language-yaml">apiVersion: v1kind: PersistentVolumemetadata:  name:  nas-it-local-pv  # å®šä¹‰ pv åå­—, ä¼šè¢« pvc å¼•ç”¨  namespace: itspec:  claimRef:    name: nas-it-local-pvc    namespace: it  capacity:    storage: 100Gi  # å®šä¹‰å¤§å°  accessModes:  - ReadWriteMany   # å®šä¹‰è®¿é—®æ¨¡å¼  persistentVolumeReclaimPolicy: Retain   # å®šä¹‰pvcåˆ é™¤åçš„ç­–ç•¥  nfs:    path: /mnt/data001/nfs-k8s   # å®šä¹‰ nfs å…±äº«è·¯å¾„    server: 10.200.16.250        # å®šä¹‰ nfs æœåŠ¡å™¨åœ°å€</code></pre><ul><li><p>accessModes å†³å®šäº†podå¯ä»¥å¦‚ä½•ä½¿ç”¨pv. å®ƒæœ‰ä¸‰ç§æ¨¡å¼:</p><ol><li><p><strong>ReadWriteOnce</strong>(å•podè¯»å†™)</p></li><li><p><strong>ReadOnlyMany</strong>(å¤špodåªè¯»)</p></li><li><p><strong>ReadWriteMany</strong>(å¤špodè¯»å†™)</p><p>è¿™é‡Œæ˜¯å®˜æ–¹åˆ—ä¸¾çš„å„ç§å­˜å‚¨ç±»å‹æ”¯æŒçš„æ¨¡å¼: <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes</a></p></li></ol></li><li><p>persistentVolumeReclaimPolicy æœ‰ä¸‰ç§æ¨¡å¼:</p><ol><li><p><strong>Retain</strong>(åªåˆ pvc)</p></li><li><p><strong>Delete</strong>(åŒæ—¶åˆ é™¤pvå’Œpvc)</p></li><li><p><strong>Recycle</strong>(åŒæ—¶åˆ é™¤pvå’Œpvc,å¹¶æ¸…ç©ºpvå­˜å‚¨çš„èµ„æº).</p><p>è¯¦æƒ…è§ <a href="#persistentVolumeReclaimPolicy">persistentVolumeReclaimPolicy</a></p></li></ol></li></ul><h3 id="é™æ€PVå¯¹åº”çš„PVC">é™æ€PVå¯¹åº”çš„PVC</h3><pre><code class="language-yaml">kind: PersistentVolumeClaimapiVersion: v1metadata:  name: nas-it-local-pvc  namespace: itspec:  accessModes:    - ReadWriteMany  resources:    requests:      storage: 100Gi  volumeName: nas-it-local-pv</code></pre><h3 id="å¯èƒ½ä¼šç”¨åˆ°çš„å·ç±»å‹ï¼šæœ¬åœ°">å¯èƒ½ä¼šç”¨åˆ°çš„å·ç±»å‹ï¼šæœ¬åœ°</h3><p>æœ¬åœ°å·æ˜¯ä¸€ç§é™æ€å·ï¼Œå› ä¸ºå®ƒå¼ºä¾èµ–å…·ä½“çš„nodeï¼Œæ‰€ä»¥PODæ— éœ€è¿›è¡ŒèŠ‚ç‚¹äº²å’Œæ€§ç»‘å®šã€‚</p><pre><code class="language-yaml">apiVersion: v1kind: PersistentVolumemetadata:  name: k8s01-pv-localspec:  capacity:    storage: 100Gi  volumeMode: Filesystem  accessModes:  - ReadWriteOnce  persistentVolumeReclaimPolicy: Delete  storageClassName: local-storage  local:    path: /mnt/disks/ssd1  nodeAffinity:    required:      nodeSelectorTerms:      - matchExpressions:        - key: kubernetes.io/hostname          operator: In          values:  - å®¹å™¨          - k8s01</code></pre><h3 id="åŠ¨æ€PV">åŠ¨æ€PV</h3><p>åŠ¨æ€PV, ç”¨æˆ·å¯ä»¥è‡ªè¡Œé€šè¿‡PVCå‘StroageClassç”³è¯·èµ„æº. å°±å¦‚åŒä½ åœ¨æ„å»ºé˜¿é‡Œäº‘çš„ECSçš„æ—¶å€™ï¼Œåªéœ€è¦å‘ŠçŸ¥ä½¿ç”¨å¤šå¤§çš„ç£ç›˜ï¼Œäº‘æœåŠ¡å™¨åˆ›å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨ç”³è¯·ã€‚</p><p>åŠ¨æ€PVçš„æ„å»ºéœ€è¦ä¸€ä¸ªæ–°çš„èµ„æºå¯¹è±¡StroageClassæ’ä»¶ã€‚æ’ä»¶åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œéƒ½ä¼šæ ¹æ®volumeç±»å‹æ‹¥æœ‰è‡ªå·±çš„ä¸€äº›ç‰¹å®šå‚æ•°ã€‚ä¾‹å¦‚äº‘æœåŠ¡çš„äº‘ç›˜ä¸€èˆ¬éƒ½å¯ä»¥è®¾ç½®è¯·æ±‚çš„ç£ç›˜ç±»å‹ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å„ç§æ”¯æŒçš„volumeç±»å‹ä»¥åŠå®ƒä»¬çš„å±æ€§å­—æ®µï¼š<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner">https://kubernetes.io/docs/concepts/storage/storage-classes/#provisioner</a></p><p>ä¸è¿‡ï¼Œæœ‰äº›volumeç±»å‹çš„ä¾›åº”å•†å·²ç»æœ‰å¯¹åº”çš„å†…ç½®æ’ä»¶ï¼Œæœ‰äº›åˆ™æ²¡æœ‰ã€‚</p><p>è¿™é‡Œä»¥ç½‘ç»œå­˜å‚¨nfsä¸ºä¾‹. nfs å±äºå¤–ç½®ä¾›åº”å•†ï¼Œå› æ­¤æ²¡æœ‰å†…ç½®æ’ä»¶ã€‚æ‰€ä»¥éœ€è¦å…ˆæ„å»º<strong>nfs-client</strong>æ’ä»¶ã€‚</p><pre><code class="language-yaml">helm install nfs-client stable/nfs-client-provisioner --set storageClass.name=nfs-client --set nfs.server=10.200.16.250 --set nfs.path=/mnt/data001/nfs-k8s --set storageClass.reclaimPolicy=Delete --set storageClass.archiveOnDelete=true --set storageClass.allowVolumeExpansion=true</code></pre><blockquote><p>nfs.serveræ˜¯nfsæœåŠ¡å™¨åœ°å€</p><p>nfs.pathæ˜¯nfså…±äº«ç›®å½•</p><p>parameters.archiveOnDelete å½“å›æ”¶ç­–ç•¥åœ¨è¢«æ‰§è¡Œçš„æ—¶å€™ï¼ˆ<a href="#persistentVolumeReclaimPolicy">persistentVolumeReclaimPolicy</a>ï¼‰ï¼Œpvåˆ é™¤çš„åŒæ—¶ç”³è¯·çš„å­˜å‚¨èµ„æºæ˜¯å¦è¦å½’æ¡£ã€‚flaseå°±æ˜¯ä¸å½’æ¡£ç›´æ¥åˆ é™¤ã€‚è¿™é‡Œå½’æ¡£çš„æ„æ€å°±æ˜¯å°†ç”³è¯·çš„å­˜å‚¨èµ„æºçš„ç‰©ç†è·¯å¾„å‰åŠ ä¸€ä¸ªarchivedå‰ç¼€ï¼Œå³ï¼šarchived-${NS_NAME}-${PVC_NAME}-${PV_NAME}ã€‚</p><p>storageClass.allowVolumeExpansion å¼€å¯å·æ‰©å±•ã€‚è¿™ä¸ªé€‰é¡¹å¯ä»¥è®©ä½ åŠ¨æ€çš„è°ƒæ•´ pvc è¯·æ±‚çš„å¯¹è±¡å¤§å°ã€‚</p></blockquote><p>å…³äºnfs-clientçš„å„ç§é…ç½®å‚æ•°,å¯ä»¥æŸ¥çœ‹æ–‡æ¡£https://github.com/helm/charts/tree/master/stable/nfs-client-provisioner#configuration</p><p>nfs-clientä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»ºä¸€ä¸ª StroageClassã€‚</p><pre><code class="language-yaml">kubectl get StorageClass/nfs-client -o yamlallowVolumeExpansion: trueapiVersion: storage.k8s.io/v1kind: StorageClassmetadata:  annotations:    meta.helm.sh/release-name: nfs-client    meta.helm.sh/release-namespace: default  labels:    app: nfs-client-provisioner    app.kubernetes.io/managed-by: Helm    chart: nfs-client-provisioner-1.2.9    heritage: Helm    release: nfs-client  managedFields:  - apiVersion: storage.k8s.io/v1  ......  name: nfs-client  resourceVersion: &quot;9314040&quot;  selfLink: /apis/storage.k8s.io/v1/storageclasses/nfs-client  uid: 3d695640-0cba-4660-9c92-53d870649b2cparameters:  archiveOnDelete: &quot;flase&quot;provisioner: cluster.local/nfs-client-nfs-client-provisionerreclaimPolicy: DeletevolumeBindingMode: Immediate</code></pre><p>ä½ å¯ä»¥é€šè¿‡æ·»åŠ  <code>metadata.annotations.storageclass.kubernetes.io/is-default-class: true</code> æ¥å°†æ­¤å­˜å‚¨ç±»è®¾ç½®ä¸ºé›†ç¾¤é»˜è®¤å­˜å‚¨ç±»ã€‚è¿™æ ·ï¼Œå½“pvcä¸­æ²¡æœ‰æ˜¾å¼çš„æŒ‡å®šå­˜å‚¨ç±»çš„æ—¶å€™ï¼Œå°†ä¼šç”¨é»˜è®¤å­˜å‚¨ç±»ã€‚</p><p>åœ¨æ­¤ä¾‹å­ä¸­ï¼Œä½ æ— æ³•æ·»åŠ ï¼Œä¸è¿‡ä½ å¯ä»¥åœ¨åˆ›å»ºä¹‹å‰é€šè¿‡ storageClass.defaultClass é€‰é¡¹è®¾ç½®ã€‚å› ä¸ºä¸Šè¿°ä¾‹å­æ˜¯é€šè¿‡helmåˆ›å»ºçš„ï¼Œåˆ›å»ºå®Œåå­˜å‚¨ç±»é…ç½®ä¸å¯è¢«ä¿®æ”¹ã€‚</p><h3 id="åŠ¨æ€PVå¯¹åº”çš„PVC">åŠ¨æ€PVå¯¹åº”çš„PVC</h3><pre><code class="language-yaml">kind: PersistentVolumeClaimapiVersion: v1metadata:  name: nas-it-local-pvcspec:  storageClassName: nfs-client  accessModes:    - ReadWriteMany  resources:    requests:      storage: 100Gi</code></pre><p>åœ¨è¿™é‡Œ,æˆ‘ä»¬é€šè¿‡ <code>spec.storageClassName</code>å­—æ®µæ¥è°ƒç”¨åå­—å« nfs-client å­˜å‚¨ç±»ã€‚</p><h3 id="PVå›æ”¶ç­–ç•¥-persistentVolumeReclaimPolicy">PVå›æ”¶ç­–ç•¥ persistentVolumeReclaimPolicy</h3><p><strong>Retain</strong> åªåˆ é™¤ PVC, PVä¿ç•™, PVä¸èƒ½è¢«ç”¨äºå…¶å®ƒPod. å¦‚æœæƒ³å¤ç”¨å­˜å‚¨èµ„æº,åˆ™éœ€é‡æ–°æ„å»ºPVå’ŒPVCã€‚å‡è®¾ä»¥awsè§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯EC2åˆ äº†ï¼Œwebæ§åˆ¶å°è¿˜èƒ½çœ‹åˆ°EBSã€‚</p><ul><li>åœ¨é™æ€PVä¸‹,PVçš„åå­—æ˜¯å›ºå®šçš„,å› æ­¤åˆ é™¤PVCä¹‹å,å¯ä»¥é‡‡ç”¨åŸæœ‰çš„PVé…ç½®é‡å»ºPVç»§è€Œåˆ†é…åˆ°åŸæœ‰çš„èµ„æº.</li><li>åœ¨åŠ¨æ€PVä¸‹,PVçš„åå­—æ˜¯åŠ¨æ€ç”Ÿæˆçš„, å› æ­¤åˆ é™¤PVCä¹‹å, å½“PVCé‡æ–°ç”³è¯·èµ„æºçš„æ—¶å€™, PVé»˜è®¤å°†ä¼šåˆ†é…åˆ°ä¸€ä¸ªæ–°çš„èµ„æºè·¯å¾„.</li></ul><p>â­ï¸å¯¹äºRetainç­–ç•¥ï¼Œå¦‚æœä½ æƒ³ç²¾å‡†çš„å°†æ–°pvcç»‘å®šåˆ°æŸä¸ªæ®‹ç•™çš„pvï¼Œåˆ™å¯ä»¥å‚ç…§[ä¿ç•™ä¸€ä¸ªé™æ€PV, å¹¶å‘ŠçŸ¥pvcå¼ºåˆ¶è¯·æ±‚pv](#ä¿ç•™ä¸€ä¸ªé™æ€PV, å¹¶å‘ŠçŸ¥pvcå¼ºåˆ¶è¯·æ±‚pv)</p><p><strong>Delete</strong> åŒæ—¶åˆ é™¤PVå’ŒPVC. å­˜å‚¨èµ„æºæ˜¯å¦åˆ é™¤å–å†³äºæ¯ä¸€ä¸ªStorageClassä¸­parametersçš„å®šä¹‰ã€‚</p><ul><li>å½“StorageClassæ˜¯nfs-clientæ—¶ï¼Œå¼€å¯ <code>parameters.archiveOnDelete=true</code> ï¼Œå°±å¯ä»¥å®šä¹‰ä¸åˆ é™¤è€Œæ˜¯å°†å…¶å½’æ¡£ã€‚å‡è®¾ä»¥awsè§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯webæ§åˆ¶å°é‡Œçš„EC2å’ŒEBSéƒ½æ²¡äº†ï¼Œä½†æ˜¯awsåœ¨åå°è¿˜å·å·çš„å¸®ä½ å°†EBSçš„é‡Œçš„æ•°æ®å½’æ¡£ä¿å­˜äº†ã€‚</li><li>å½“StorageClassæ˜¯å¾®è½¯/aws/é˜¿é‡Œäº‘çš„äº‘ç›˜çš„æ—¶å€™ï¼Œä¸€èˆ¬é»˜è®¤æ˜¯åˆ é™¤äº‘ç›˜ã€‚ä»è€Œé¿å…äº§ç”Ÿå¤§é‡é—²ç½®äº‘ç›˜ã€‚</li></ul><p><strong>Recycle</strong> åˆ é™¤åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡å’Œå­˜å‚¨èµ„æº.</p><ul><li>å½“å‰åªæœ‰nfså’ŒhostPathæ”¯æŒ.</li></ul><h3 id="å­˜å‚¨èµ„æºç‰©ç†å±‚é¢å›æ”¶">å­˜å‚¨èµ„æºç‰©ç†å±‚é¢å›æ”¶</h3><p>k8så®˜æ–¹å»ºè®®ä¸è¦ä½¿ç”¨å›æ”¶ç­–ç•¥ <strong>Recycle</strong>, å› ä¸ºå®ƒæ— æ³•åæ‚”ã€‚k8så»ºè®®ç®¡ç†å‘˜è‡ªå·±å»åˆ é™¤. ä¾‹å¦‚é€šè¿‡ä¸€ä¸ªpodå»åˆ é™¤.podä¾‹å­å¦‚ä¸‹:</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: pv-recycler  namespace: defaultspec:  restartPolicy: Never  volumes:  - name: vol    hostPath:      path: /any/path/it/will/be/replaced   # è¿™é‡Œåº”è¯¥å¡«å†™éœ€è¦åˆ é™¤çš„å†…å®¹æ ¹è·¯å¾„. æ ¹è·¯å¾„åº”è¯¥æ˜¯nodeæœ¬åœ°å¯ä»¥è®¿é—®çš„ç‰©ç†èµ„æºåœ°å€.  containers:  - name: pv-recycler    image: &quot;k8s.gcr.io/busybox&quot;    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;test -e /scrub &amp;&amp; rm -rf /scrub/..?* /scrub/.[!.]* /scrub/*  &amp;&amp; test -z \&quot;$(ls -A /scrub)\&quot; || exit 1&quot;]    volumeMounts:    - name: vol      mountPath: /scrub</code></pre><p>ä¸Šè¿°ä¾‹å­ä¼šæ„å»ºä¸€ä¸ª podï¼Œpodä¼šå°†æœ¬åœ°çš„ /any/path/it/will/be/replaced è·¯å¾„é‡Œçš„å†…å®¹éƒ½åˆ é™¤æ‰ã€‚</p><h3 id="å¦‚ä½•ä¿ç•™ä¸€ä¸ªé™æ€PV-å¹¶å‘ŠçŸ¥pvcå¼ºåˆ¶è¯·æ±‚pv">å¦‚ä½•ä¿ç•™ä¸€ä¸ªé™æ€PV, å¹¶å‘ŠçŸ¥pvcå¼ºåˆ¶è¯·æ±‚pv</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œpvcæ‰¾é™æ€pvæ˜¯è‡ªåŠ¨çš„ï¼Œä¾‹å¦‚ä¼šè‡ªåŠ¨æ‰¾å¤§å°åŒ¹é…çš„pvã€‚è¿™å¯èƒ½æœ‰æ—¶å€™ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚ä¾‹å¦‚æˆ‘ä»¬æƒ³ç»™ä¸€ä¸ªæ•°æ®åº“æ„å»ºä¸€ä¸ªå›ºå®šå¼ºä¾èµ–çš„pvã€‚</p><p>æ­¤æ—¶éœ€è¦åœ¨æ„å»ºpvçš„æ—¶å€™ï¼Œæ·»åŠ  <code>spec.claimRef</code>ã€‚ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: PersistentVolumemetadata:  name: foo-pvspec:  claimRef:    name: foo-pvc    namespace: foo</code></pre><p>è¿™ä¸ªä¾‹å­æ˜¯å°† foo-pv å¼ºåˆ¶ä¿ç•™ç»™ foo-pvc. ä¹Ÿå°±æ˜¯è¯´å…¶å®ƒ pvc æ— æ³•ä½¿ç”¨ foo-pvã€‚</p><p>ä¹‹åï¼Œæˆ‘ä»¬åœ¨ pvc ä¸­æ·»åŠ  <code>spec: volumeName</code> ã€‚ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: PersistentVolumeClaimmetadata:  name: foo-pvc  namespace: foospec:  volumeName: foo-pv</code></pre><h3 id="åœ¨çº¿æ‰©ç¼©ï¼ˆä»…æ”¯æŒåŠ¨æ€pvï¼‰">åœ¨çº¿æ‰©ç¼©ï¼ˆä»…æ”¯æŒåŠ¨æ€pvï¼‰</h3><p>è¦å®ç°åœ¨çº¿è°ƒæ•´å¤§å°ï¼Œéœ€è¦æ»¡è¶³ä¸‹åˆ—æ¡ä»¶ï¼š</p><ol><li><p>feature-gatesçš„<code>ExpandInUsePersistentVolumes</code>è¢«å¼€å¯ã€‚å®ƒåœ¨1.15ç‰ˆæœ¬ä»¥åé»˜è®¤å¼€å¯ã€‚</p></li><li><p>StorageClassçš„<code>allowVolumeExpansion</code>è¢«å¼€å¯ã€‚è¿™æ„å‘³ç€å¿…é¡»æ˜¯åŠ¨æ€pvã€‚</p></li><li><p>æ–‡ä»¶ç³»ç»Ÿæ˜¯XFS, Ext3, or Ext4ã€‚è¿™ä¸ªéœ€è¦StorageClassçš„æ”¯æŒã€‚ä¸€èˆ¬æ¥è¯´volumeå±äºå—è®¾å¤‡ç±»å‹çš„èµ„æºæ‰æ”¯æŒï¼Œæ¯”å¦‚awsçš„ebsã€‚</p><blockquote><p>ä½ å¯ä»¥åœ¨è¿™é‡Œç¡®è®¤StorageClassæ˜¯å¦æ”¯æŒfstypeå±æ€§ã€‚<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#parameters">https://kubernetes.io/docs/concepts/storage/storage-classes/#parameters</a></p></blockquote></li></ol><p>æ»¡è¶³ä¸Šè¿°æ¡ä»¶åï¼Œä½ å°±å¯ä»¥é€šè¿‡ pvc ä¿®æ”¹å­˜å‚¨å¤§å°äº†ã€‚å³æ—¶ pvc æ­£åœ¨è¢«ä½¿ç”¨ã€‚</p><h3 id="å±€é™æ€§">å±€é™æ€§</h3><p>å½“ä¸€ä¸ª pod åŒæ—¶ç”³è¯·å¤šä¸ª volume çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç° volume-A ç”³è¯·æˆåŠŸï¼Œvolume-B å› ç‰©ç†å®¹é‡ä¸å¤Ÿç”³è¯·å¤±è´¥çš„é—®é¢˜ï¼Œæ­¤æ—¶ pod å°†å¡ä½ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦æ‰‹åŠ¨ä»‹å…¥å»æ¸…ç†ã€‚</p><h3 id="æ‰‹åŠ¨ä»‹å…¥">æ‰‹åŠ¨ä»‹å…¥</h3><p>éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨çš„æ—¶å€™ï¼Œéƒ½æ˜¯èµ„æºç”³è¯·å¤±è´¥æˆ–è€…ä¸å°å¿ƒåˆ é™¤äº†PVCä¹‹ç±»çš„ã€‚è€Œä¸ç®¡æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬ç¬¬ä¸€ç›®çš„æ˜¯æ•°æ®ä¸ä¸¢ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ¸…ç†æ•…éšœå¯¹è±¡èµ„æºçš„æ—¶å€™ï¼Œåº”è¯¥éµå¾ªä¸‹åˆ—æ­¥éª¤ï¼š</p><ol><li>å°†pvçš„å›æ”¶ç­–ç•¥<code>persistentVolumeReclaimPolicy</code>å®šä¹‰ä¸º<code>Retain</code></li><li>åˆ é™¤pvcï¼Œè¿™ä¸ªæ—¶å€™ pv å¯¹è±¡å°†ä¼šä¿ç•™ï¼Œä½†æ˜¯ pv çŠ¶æ€ä¼šå˜æˆ Releasedï¼Œè¿™ä¸ªçŠ¶æ€ä¸‹ pv æ— æ³•å†è¢«ä½¿ç”¨</li><li>åˆ é™¤pvå¯¹è±¡å­—æ®µ<code>spec.claimRef</code>ï¼Œä»è€Œå°†pvä¸pvcè§£ç»‘ï¼Œä»è€Œä½¿ pv çŠ¶æ€å˜ä¸º Available</li><li>é‡å»ºpvcï¼Œå¹¶å°†pvcå¯¹è±¡å­—æ®µ<code>volumeName</code>è®¾ç½®ä¸ºpvçš„åå­—</li><li>æ¢å¤pvçš„å›æ”¶ç­–ç•¥ã€‚</li></ol><h2 id="PVCå¦‚ä½•ä¸PODç»“åˆä½¿ç”¨">PVCå¦‚ä½•ä¸PODç»“åˆä½¿ç”¨</h2><p>è¿™é‡Œä»¥ä¸Šè¿°ä¾‹å­ä¸­çš„ nfs å·ç±»å‹ä¸ºä¾‹ã€‚</p><pre><code class="language-yaml">apiVersion: apps/v1kind: StatefulSetmetadata:  name: nas-it-local-dep  namespace: it  labels:    app: nas-it-localspec:  serviceName: nas-it-local-vsftpd  revisionHistoryLimit: 10  replicas: 1  selector:    matchLabels:      app: nas-it-local  template:    metadata:      labels:        app: nas-it-local    spec:      hostNetwork: true      affinity:        nodeAffinity:          requiredDuringSchedulingIgnoredDuringExecution:            nodeSelectorTerms:            - matchExpressions:              - key: kubernetes.io/hostname                operator: In                values:  - å®¹å™¨                - k8s01      containers:      - name: vsftp        image: fauria/vsftpd        ports:        - containerPort: 20        - containerPort: 21        env:        - name: LOG_STDOUT          value: STDOUT        resources:          requests:            memory: &quot;128Mi&quot;            cpu: &quot;125m&quot;          limits:            memory: &quot;512Mi&quot;            cpu: &quot;250m&quot;        volumeMounts:        - name: nas-it-local-vol          subPath: nas.it.local/data          mountPath: /home/vsftpd        - name: nas-it-local-vc          subPath: vsftpd.conf          mountPath: /etc/vsftpd/vsftpd.conf          readOnly: true        - name: nas-it-local-vc          subPath: virtual_users.txt          mountPath: /etc/vsftpd/virtual_users.txt          readOnly: true        - name: nas-it-local-vc          subPath: admin          mountPath: /etc/vsftpd/virtual/admin          readOnly: true        - name: nas-it-local-vc          subPath: yuangong          mountPath: /etc/vsftpd/virtual/yuangong          readOnly: true      volumes:      - name: nas-it-local-vol        persistentVolumeClaim:          claimName: nas-it-local-pvc      - name: nas-it-local-vc        configMap:          name: nas-it-local-cm</code></pre><ol><li><p>åˆ›å»º <code>volumesï¼šnas-it-local-vol</code>ï¼Œå¹¶ç»‘å®š <code>PVCï¼šnas-it-local-pvc</code></p><pre><code class="language-yaml">      volumes:      - name: nas-it-local-vol        persistentVolumeClaim:          claimName: nas-it-local-pvc</code></pre></li><li><p>åˆ›å»º <code>volumeMounts</code>æŒ‚è½½ <code>volumesï¼šnas-it-local-vol</code></p><p>è¿™é‡Œå°† nfs å…±äº«ç›®å½•ä¸­<code>nas.it.local/data</code>é‡Œçš„æ•°æ®æŒ‚è½½åˆ°å®¹å™¨é‡Œçš„ <code>/home/vsftpd</code>è·¯å¾„</p><pre><code class="language-yaml">        volumeMounts:        - name: nas-it-local-vol          subPath: nas.it.local/data          mountPath: /home/vsftpd</code></pre><p>â­ï¸subPathä¸å­˜åœ¨çš„æ—¶å€™ï¼Œnfs å…±äº«ç›®å½•ä¼šè‡ªåŠ¨åˆ›å»ºã€‚</p></li></ol><hr><h2 id="æŒä¹…å·ä¸ä¸´æ—¶å·">æŒä¹…å·ä¸ä¸´æ—¶å·</h2><p>ä»¥ä¸Šæ–¹å¼éƒ½æ˜¯æŒä¹…å·æ–¹å¼ï¼Œk8sè¿˜æœ‰ä¸€ç§ä¸´æ—¶å·ï¼Œç”¨æ¥è¿›è¡Œéå¿…é¡»çš„æ•°æ®å­˜å‚¨ã€‚ä¾‹å¦‚ç¼“å­˜/ä¼šè¯ä¸€ç±»çš„ã€‚ä¸´æ—¶å·æ•°æ®å°†éšç€PODç”Ÿå‘½å‘¨æœŸçš„ç»ˆæ­¢è€Œç»ˆæ­¢ã€‚</p><p>k8sæ”¯æŒçš„ä¸´æ—¶å·ä¸»è¦æ˜¯è¿™ä¸¤ç§ï¼š</p><ul><li><p>emptyDir</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: test-pdspec:  containers:  - image: k8s.gcr.io/test-webserver    name: test-container    volumeMounts:    - mountPath: /cache      name: cache-volume  volumes:  - name: cache-volume    emptyDir: &#123;&#125;</code></pre><p>emptyDirè¿˜æ”¯æŒæ„å»ºä¸€ä¸ªå†…å­˜å±‚ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ tmpfsã€‚ä½ å¯ä»¥é€šè¿‡<code>emptyDir.medium: &quot;Memory&quot;</code>æ¥å¼€å¯ã€‚</p></li><li><p>generic ephemeral volumes è¿™ä¸€ç§æ˜¯æ›´åŠ çµæ´»çš„emptyDirï¼Œå¯ä»¥æ˜¯ç½‘ç»œå­˜å‚¨ï¼Œå¦‚æœæ’ä»¶æ”¯æŒï¼Œåˆ™å„ç§æŒä¹…å·çš„ç‰¹æ€§å®ƒéƒ½æœ‰å¯èƒ½æ”¯æŒã€‚å½“å‰1.18ä¸æ”¯æŒï¼Œä»1.19å¼€å§‹æ”¯æŒï¼Œ1.19ä¹Ÿæ˜¯alphaï¼Œé»˜è®¤ä¸å¼€å¯ã€‚</p><p>å…·ä½“ä½¿ç”¨çœ‹https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/#generic-ephemeral-volumes</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> storage </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®‰è£…åº“â˜vsftpd</title>
      <link href="posts/894f9595/"/>
      <url>posts/894f9595/</url>
      
        <content type="html"><![CDATA[<h2 id="é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</h2><pre><code class="language-yaml">apiVersion: apps/v1kind: StatefulSetmetadata:  name: nas-it-local-dep  namespace: it  labels:    app: nas-it-localspec:  serviceName: nas-it-local-vsftpd  revisionHistoryLimit: 10  replicas: 1  selector:    matchLabels:      app: nas-it-local  template:    metadata:      labels:        app: nas-it-local    spec:      hostNetwork: true      affinity:        nodeAffinity:          requiredDuringSchedulingIgnoredDuringExecution:            nodeSelectorTerms:            - matchExpressions:              - key: kubernetes.io/hostname                operator: In                values:                - k8s01  # è¿™é‡Œç»‘å®š pod æ‰€åœ¨èŠ‚ç‚¹      containers:      - name: vsftp        image: fauria/vsftpd        ports:        - containerPort: 20        - containerPort: 21        env:        - name: LOG_STDOUT          value: STDOUT        resources:          requests:            memory: &quot;128Mi&quot;            cpu: &quot;125m&quot;          limits:            memory: &quot;512Mi&quot;            cpu: &quot;250m&quot;        volumeMounts:        - name: nas-it-local-vol          subPath: nas.it.local/data          mountPath: /home/vsftpd        - name: nas-it-local-vc          subPath: vsftpd.conf          mountPath: /etc/vsftpd/vsftpd.conf          readOnly: true        - name: nas-it-local-vc          subPath: virtual_users.txt          mountPath: /etc/vsftpd/virtual_users.txt          readOnly: true        - name: nas-it-local-vc          subPath: admin          mountPath: /etc/vsftpd/virtual/admin          readOnly: true        - name: nas-it-local-vc          subPath: yuangong          mountPath: /etc/vsftpd/virtual/yuangong          readOnly: true      volumes:      - name: nas-it-local-vol        persistentVolumeClaim:          claimName: nas-it-local-pvc      - name: nas-it-local-vc        configMap:          name: nas-it-local-cm---kind: ConfigMapapiVersion: v1metadata:  name: nas-it-local-cm  namespace: itdata:  vsftpd.conf: |    # Run in the foreground to keep the container running:    background=NO    # Allow anonymous FTP? (Beware - allowed by default if you comment this out).    anonymous_enable=NO    # Uncomment this to allow local users to log in.    local_enable=YES    ## Enable virtual users    guest_enable=YES    ## Virtual users will use the same permissions as anonymous    virtual_use_local_privs=YES    # Uncomment this to enable any form of FTP write command.    write_enable=YES    ## PAM file name    pam_service_name=vsftpd_virtual    ## Home Directory for virtual users    user_sub_token=$USER    local_root=/home/vsftpd/$USER    user_config_dir=/etc/vsftpd/virtual    # You may specify an explicit list of local users to chroot() to their home    # directory. If chroot_local_user is YES, then this list becomes a list of    # users to NOT chroot().    chroot_local_user=YES    # Workaround chroot check.    # See https://www.benscobie.com/fixing-500-oops-vsftpd-refusing-to-run-with-writable-root-inside-chroot/    # and http://serverfault.com/questions/362619/why-is-the-chroot-local-user-of-vsftpd-insecure    allow_writeable_chroot=YES    ## Hide ids from user    hide_ids=YES    ## Enable logging    xferlog_enable=YES    xferlog_file=/var/log/vsftpd/vsftpd.log    ## Enable active mode    port_enable=YES    connect_from_port_20=YES    ftp_data_port=20    ##Â Disable seccomp filter sanboxing    seccomp_sandbox=NO    ### Variables set at container runtime    pasv_address=10.200.16.10    pasv_max_port=21110    pasv_min_port=21100    pasv_addr_resolve=NO    pasv_enable=YES    file_open_mode=0666    local_umask=077    xferlog_std_format=NO    reverse_lookup_enable=YES    pasv_promiscuous=NO    port_promiscuous=NO  virtual_users.txt: |    admin    admin    yuangong    yuangong  admin: |    local_root=/home/vsftpd    anon_world_readable_only=NO    write_enable=YES    anon_mkdir_write_enable=YES    anon_upload_enable=YES    anon_other_write_enable=YES  yuangong: |    local_root=/home/vsftpd/yuangong    anon_world_readable_only=NO    write_enable=NO    anon_mkdir_write_enable=NO    anon_upload_enable=NO    anon_other_write_enable=NO---apiVersion: v1kind: PersistentVolumemetadata:  name:  nas-it-local-pv  # å®šä¹‰ pv åå­—, ä¼šè¢« pvc å¼•ç”¨  namespace: itspec:  claimRef:    name: nas-it-local-pvc    namespace: it  capacity:    storage: 100Gi  # å®šä¹‰å¤§å°  accessModes:  - ReadWriteMany   # å®šä¹‰è®¿é—®æ¨¡å¼  persistentVolumeReclaimPolicy: Retain   # å®šä¹‰pvcåˆ é™¤åçš„ç­–ç•¥  nfs:    path: /mnt/data001/nfs-k8s   # å®šä¹‰ nfs å…±äº«è·¯å¾„    server: 10.200.16.250        # å®šä¹‰ nfs æœåŠ¡å™¨åœ°å€---kind: PersistentVolumeClaimapiVersion: v1metadata:  name: nas-it-local-pvc  namespace: itspec:  accessModes:    - ReadWriteMany  resources:    requests:      storage: 100Gi  volumeName: nas-it-local-pv</code></pre><ul><li>è¿™æ˜¯ä¸€ä¸ª<strong>ä¸»åŠ¨æ¨¡å¼</strong>çš„ ftp. é‰´äº k8s ç‰¹æ®Šçš„ç½‘ç»œç¯å¢ƒ.ä»¥åŠç«¯å£çš„ç¹çé…ç½®. æ‰€ä»¥é‡‡ç”¨ä¸»åŠ¨æ¨¡å¼, å¯ä»¥è®©æˆ‘ä»¬æ›´èˆ’æœä¸€äº›.</li><li>pvå’Œpvcæ–¹é¢æ ¹æ®ä½ è‡ªå·±çš„ç¯å¢ƒè‡ªè¡Œè°ƒæ•´.</li><li>ä½ éœ€è¦è‡ªè¡Œå°†podå¼ºåˆ¶ç»‘å®šåˆ°æŸä¸ªç‰©ç†èŠ‚ç‚¹çš„ipä¸Š. é¿å…å› podé‡æ„æ—¶æ¼‚ç§»åˆ°å…¶å®ƒip. é…ç½®æ–‡ä»¶é‡Œç»‘å®šçš„æ˜¯k8s01</li></ul><h2 id="ç”¨æˆ·åˆ›å»º">ç”¨æˆ·åˆ›å»º</h2><p>ä¸Šè¿°é…ç½®ä¼šåˆ›å»ºadminå’Œyuangongä¸¤ä¸ªç”¨æˆ·ã€‚</p><p>adminç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰æƒã€‚æ ¹ç›®å½•æ˜¯/home/vsftpd</p><p>yuangongç”¨æˆ·åªæœ‰ä¸‹è½½æƒé™ã€‚æ ¹ç›®å½•æ˜¯/home/vsftpd/yuangong</p><h3 id="æ·»åŠ æ–°ç”¨æˆ·">æ·»åŠ æ–°ç”¨æˆ·</h3><ul><li><p>æ·»åŠ ç”¨æˆ·åå’Œå¯†ç åˆ° virtual_users.txt é…ç½®</p></li><li><p>æ·»åŠ ç”¨æˆ·é…ç½®åˆ°cmå¯¹è±¡ä¸­</p><pre><code class="language-yaml">  æˆ‘æ˜¯ç”¨æˆ·å: |    local_root=/home/vsftpd/&lt;æˆ‘æ˜¯ç”¨æˆ·å&gt;    anon_world_readable_only=NO    write_enable=YES    anon_mkdir_write_enable=YES    anon_upload_enable=YES    anon_other_write_enable=YES</code></pre></li><li><p>åˆ›å»ºç”¨æˆ·ç›®å½• /home/vsftpd/&lt;æˆ‘æ˜¯ç”¨æˆ·å&gt;</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vsftpd </tag>
            
            <tag> å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§â˜monit</title>
      <link href="posts/ae41ae33/"/>
      <url>posts/ae41ae33/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash">yum install monit -y</code></pre><h2 id="ä¸»é…ç½®">ä¸»é…ç½®</h2><pre><code class="language-bash"># vim /etc/monitrcset daemon  10 # è°ƒæ•´å‘¨æœŸ</code></pre><p>â­ï¸å®˜æ–¹é…ç½®æ–‡æ¡£: <a href="https://mmonit.com/monit/documentation/monit.html">https://mmonit.com/monit/documentation/monit.html</a></p><h2 id="ç¨‹åºä¿æ´»é…ç½®">ç¨‹åºä¿æ´»é…ç½®</h2><p>é»˜è®¤å­˜æ”¾ä½ç½®: /etc/monit.d/</p><p>è¿™é‡Œä»¥ pidfile æ£€æµ‹æ–¹å¼ä¸ºä¾‹</p><p>nginxçš„é…ç½®:</p><pre><code class="language-bash">check process nginx with pidfile /var/run/nginx.pid  start program = &quot;/usr/sbin/nginx&quot;  stop program = &quot;/usr/bin/killall nginx&quot;if changed pid then alert</code></pre><p>ä¸Šè¿°nginxé…ç½®çš„æ„æ€:</p><ol><li><p>æ£€æµ‹æ–¹å¼: pidfile</p></li><li><p>å¼€å…³ç¨‹åºè·¯å¾„</p></li><li><p>å‘ç°pidæ”¹å˜,åˆ™è§¦å‘åŠ¨ä½œ: é¢„è­¦</p></li></ol><p>tomcatçš„é…ç½®:</p><pre><code class="language-bash">check process tomcat-8080 with pidfile /opt/tomcat/tomcat-8080/bin/tomcat.pid  start program = &quot;/usr/bin/bash /opt/tomcat/tomcat-8080/bin/startup.sh&quot;    as uid &quot;root&quot; and gid &quot;root&quot;  stop program = &quot;/usr/bin/ps aux | /usr/bin/grep '/opt/tomcat/tomcat-8080/bin/bootstrap.jar' | /usr/bin/awk '&#123;print &quot;kill -9 &quot;$2&#125;' | /usr/bin/bash&quot;    as uid &quot;root&quot; and gid &quot;root&quot;if failed port 8080 then alert</code></pre><p>ä¸Šè¿°tomcaté…ç½®çš„æ„æ€:</p><ol><li>æ£€æµ‹æ–¹å¼: pidfile</li><li>å¼€å…³ç¨‹åºè·¯å¾„, å¹¶ä¸”æ‰§è¡Œçš„æ—¶å€™éœ€è¦ä»¥ root æƒé™æ‰§è¡Œ</li><li>å‘ç° 8080 ä¸é€š, åˆ™è§¦å‘åŠ¨ä½œ: é¢„è­¦</li></ol><p>ğŸŒŸéœ€è¦æ³¨æ„çš„æ˜¯, æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„éƒ½éœ€è¦æ˜¯ç»å¯¹è·¯å¾„, åŒ…æ‹¬å‘½ä»¤.</p><h2 id="å¯åŠ¨-å…³é—­">å¯åŠ¨/å…³é—­</h2><pre><code class="language-bash">systemctl start/stop/reload monit</code></pre><p>ğŸŒŸå½“monitå¯åŠ¨ä¹‹å, å®ƒå°±ä¼šåŠ è½½ä¿æ´»é…ç½®, å¹¶è¿›è¡Œæ£€æµ‹.</p><h2 id="æ—¥å¿—">æ—¥å¿—</h2><pre><code>/var/log/monit.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> monit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> monit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜13é«˜çº§ç‰ˆè´Ÿè½½å‡è¡¡ingress</title>
      <link href="posts/7627a41d/"/>
      <url>posts/7627a41d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ingress å¯ä»¥æä¾›è´Ÿè½½å‡è¡¡/SSLç®¡ç†/è™šæ‹Ÿå‘½åä¸»æœº/pathè·¯ç”±. å®ƒçš„ç›®çš„æ˜¯å¢åŠ 7å±‚è´Ÿè½½åŠŸèƒ½. ä½ å¯ä»¥é€šè¿‡ Ingress å°†è¯·æ±‚è½¬å‘åˆ°å„ä¸ª Service å¯¹è±¡.</p><p>ä½†æ˜¯ingressæœ¬èº«å¹¶ä¸æ˜¯è§„åˆ™çš„æ‰§è¡Œè€…. å®ƒåªæ˜¯è®°å½•è§„åˆ™, è§„åˆ™æ‰§è¡Œè€…ç”±ingress-controllerå®ç°.</p><blockquote><p>ingress è¯´å®è¯ï¼Œè¿˜æ˜¯ä¸æ€ä¹ˆå¥½ç”¨ï¼Œå¦‚æœä»…ä»…ç”¨æ¥è¿›è¡Œ path è½¬å‘è¿˜å¯ä»¥ã€‚ã€‚ã€‚</p></blockquote><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>ingress æä¾›è§„åˆ™, å®ƒéœ€è¦å’Œåç«¯ä¸šåŠ¡ä½äºåŒä¸€ä¸ªnsä¸­.</li><li>ingress controller å®ç°è§„åˆ™, å®ƒå¯ä»¥å•ç‹¬æ˜¯ä¸€ä¸ªns.å› ä¸ºå®ƒä¼šè‡ªåŠ¨å»æ‰¾é‚£äº›æ³¨è§£å«æœ‰è‡ªå·±çš„ingress.</li><li>ingress åªé’ˆå¯¹ http å’Œ https. è¿™äº›ä¹‹å¤–çš„ç«¯å£æš´æ¼ä½ åº”è¯¥ä½¿ç”¨ Service.Type=NodePort æˆ–è€… Service.Type=LoadBalancer</li></ul><h2 id="æµé‡è·¯å¾„">æµé‡è·¯å¾„</h2><p>internet =&gt; Ingress =&gt; Service</p><p><img src="/posts/7627a41d/image-20201023110559218.png" alt="image-20201023110559218"></p><h2 id="Ingress">Ingress</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">https://kubernetes.io/docs/concepts/services-networking/ingress/</a></p><h3 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h3><p>client =&gt; <a href="http://one.foo.com/one">http://one.foo.com/one</a> =&gt; Ingress = &gt; Service(one):8001 =&gt; pod</p><p>client =&gt; http://*.foo.com/other =&gt; Ingress  =&gt; Service(other):8002 =&gt; pod</p><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: minimal-ingress  annotations:    nginx.ingress.kubernetes.io/rewrite-target: /spec:  rules:  - host: one.foo.com    http:      paths:      - path: /one        pathType: Prefix        backend:          service:            name: one            port:              number: 8001  - host: &quot;*.foo.com&quot;    http:      paths:      - pathType: Prefix        path: &quot;/other&quot;        backend:          service:            name: other            port:              number: 8002</code></pre><p>ğŸŒŸè¯·æ³¨æ„, <code>networking.k8s.io/v1</code>å¿…é¡»æ˜¯v1.19+æ‰å¯ä»¥ä½¿ç”¨, å¦‚æœä½ ä¸æ˜¯,åˆ™åº”è¯¥ä½¿ç”¨<code>networking.k8s.io/v1beta1</code></p><p>æ—¢ç„¶Ingressæ˜¯å’Œnginxä¸€ä¸ªå±‚æ¬¡çš„æœåŠ¡,é‚£å¿…ç„¶ä¼šæœ‰ä¸€äº›ç›¸åŒçš„æ¦‚å¿µ.</p><p>nginx.servername:  è¿™é‡Œæ˜¯ spec.rules[].host</p><p>nginx.location: è¿™é‡Œæ˜¯ spec.rules.http.paths[].path</p><p>nginx.upstream: è¿™é‡Œæ˜¯ spec.rules.http.paths[].backend</p><h3 id="å…³äº-spec-rules-host">å…³äº spec.rules[].host</h3><p>è¿™é‡Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹. host æ”¯æŒç»Ÿé…åŒ¹é…. ä¸è¿‡ <code>*</code>ä¸èƒ½è·¨çº§åŒ¹é…. ä¾‹å¦‚,</p><p>*.abc.com å¯ä»¥åŒ¹é… <a href="http://one.abc.com">one.abc.com</a> ä½†æ˜¯ä¸èƒ½åŒ¹é… <a href="http://two.one.abc.com">two.one.abc.com</a>.</p><h3 id="å…³äº-spec-rules-http-paths-path">å…³äº spec.rules.http.paths[].path</h3><p>è¿™é‡Œæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹.å¦‚ä¸Šä¾‹å­æ‰€è¿°. pathType å®šä¹‰äº† path çš„ç±»å‹. å®ƒæœ‰ä¸‰ä¸ªç±»å‹:</p><ul><li><p>ImplementationSpecific: å·²ingress classä¸ºåŸºå‡†. å…·ä½“å¦‚ä½•åŒ¹é…,éœ€è¦çœ‹é€‰ç”¨çš„ingress class.è¿™æ˜¯é»˜è®¤çš„.</p></li><li><p>Exact: ä¸¥æ ¼åŒ¹é…. ä¸èƒ½æœ‰ä¸€ç‚¹ä¸åŒ.</p></li><li><p>Prefix: åŸºäº&quot;/&quot;åˆ†æ®µè¿›è¡Œå‰ç¼€åŒ¹é…. ä¾‹å¦‚,</p><ul><li>/aaa/bbb å¯ä»¥åŒ¹é…ä»»ä½• /aaa/bbb/ å¼€å¤´çš„, æˆ–è€… /aaa/bbb.  å› æ­¤ /aaa/bbbb æ˜¯ä¸èƒ½åŒ¹é…çš„.</li><li>/aaa å¯ä»¥åŒ¹é…ä»»ä½• /aaa/ å¼€å¤´çš„, æˆ–è€… /aaa. å› æ­¤, /aaaa æ˜¯ä¸èƒ½åŒ¹é…çš„.</li><li>/ å¯ä»¥åŒ¹é…ä»»ä½• / å¼€å¤´çš„. å› æ­¤, åŒ¹é…æ‰€æœ‰.</li></ul><p>â­ï¸è¯·æ³¨æ„, Prefix ç±»å‹ä¸‹.ä½ å†™çš„åŒ¹é…å­—ç¬¦ä¸²é¦–å°¾éƒ½éœ€è¦åŠ <code>/</code>, å¦‚æœä½ å°¾éƒ¨æ²¡æœ‰åŠ <code>/</code>, é‚£ä¹ˆ ingress åœ¨åŒ¹é…çš„æ—¶å€™, ä¹Ÿä¼šå¸®ä½ åŠ ä¸Š<code>/</code>.</p></li></ul><p>å½“Exactå’ŒPrefixæ··ç”¨çš„æ—¶å€™, å¦‚æœä¸€ä¸ªè¯·æ±‚åŒæ—¶åŒ¹é…äº†è¿™ä¸¤ä¸ªç±»å‹ä¸‹çš„path, é‚£ä¹ˆExact ä¼˜å…ˆçº§æ›´é«˜.</p><h3 id="æ„å»ºTLS">æ„å»ºTLS</h3><ol><li><h4 id="åˆ›å»º-Secret-å¯¹è±¡-å¯¼å…¥è¯ä¹¦æ–‡ä»¶">åˆ›å»º Secret å¯¹è±¡, å¯¼å…¥è¯ä¹¦æ–‡ä»¶</h4><pre><code class="language-yaml">apiVersion: v1kind: Secretmetadata:  name: foo-com-tls  namespace: defaultdata:  tls.crt: base64 encoded cert # è¿™é‡Œéœ€è¦å¡«å†™ base64 ç¼–ç åçš„ cert å†…å®¹. tls.crt ä¸å¯æ›´å  tls.key: base64 encoded key  # è¿™é‡Œéœ€è¦å¡«å†™ base64 ç¼–ç åçš„ key å†…å®¹. tls.key ä¸å¯æ›´åtype: kubernetes.io/tls</code></pre></li><li><h4 id="åœ¨Ingresså¯¹è±¡ä¸­è°ƒç”¨-Secret">åœ¨Ingresså¯¹è±¡ä¸­è°ƒç”¨ Secret</h4><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1kind: Ingressmetadata:  name: tls-example-ingressspec:  tls:  - hosts:      - https-example.foo.com    secretName: foo-com-tls  rules:  - host: https-example.foo.com    http:      paths:      - path: /        pathType: Prefix        backend:          service:            name: service1            port:              number: 80</code></pre></li></ol><p>é€šè¿‡é…ç½®æ–‡ä»¶, å¯ä»¥çœ‹å‡ºæ¥åŠ å¯†åˆ°Ingresså°±åœæ­¢äº†(åç«¯Serviceå¯¹è±¡service1çš„ç«¯å£æ˜¯80).è¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬åœ¨ék8sç¯å¢ƒä¸­çš„æµç¨‹.</p><p>å¦å¤–, ä¸åŒçš„Ingressæ§åˆ¶å™¨å¯¹äºTLSè¿™å—ä¹Ÿæœ‰ä¸€å®šå·®å¼‚.å…·ä½“ä»¥æ§åˆ¶å™¨æœ¬èº«è¯´æ˜ä¸ºå‡†.</p><h2 id="Ingress-controller">Ingress controller</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/</a></p><p>Ingress æƒ³è¦æ­£å¸¸è¿ä½œ, éœ€è¦Ingressæ§åˆ¶å™¨çš„æ”¯æŒ.</p><p>ä½ å¯ä»¥åœ¨k8sä¸­éƒ¨ç½²å¤šä¸ªIngressæ§åˆ¶å™¨, ä½†æ˜¯ä½ éœ€è¦é€šè¿‡åœ¨ annotations ä¸­ç”¨ ingress.class æ³¨è§£å¼ºè°ƒä½ æƒ³ç”¨å“ªä¸€æ¬¾.</p><p>å°±åƒä¸‹é¢è¿™æ ·</p><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1beta1kind: Ingressmetadata:  annotations:    kubernetes.io/ingress.class: nginx  name: example  namespace: foospec:  rules:    - host: www.example.com      http:        paths:          - backend:              serviceName: exampleService              servicePort: 80            path: /  # This section is only required if TLS is to be enabled for the Ingress  tls:      - hosts:          - www.example.com        secretName: example-tls---apiVersion: v1kind: Secretmetadata:  name: example-tls  namespace: foodata:  tls.crt: &lt;base64 encoded cert&gt;  tls.key: &lt;base64 encoded key&gt;type: kubernetes.io/tls</code></pre><p>è¿™é‡Œ<code>backend</code>æ˜¯æ—§å†™æ³•ï¼Œä½ åº”è¯¥ä½¿ç”¨æ–°çš„å†™æ³•ï¼š</p><pre><code class="language-yaml">  backend:    service:      name: exampleService      port:        number: 80</code></pre><p>è¿™é‡Œæˆ‘ä»¬é€‰ç”¨k8sç»´æŠ¤çš„nginxæ§åˆ¶å™¨.å®ƒçš„éƒ¨ç½²æ–‡æ¡£æ˜¯: <a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md">https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md</a> æˆ–è€… <a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a></p><p>æˆ‘ä»¬å°†é€šè¿‡helmæ¥å®‰è£…ingress-nginx. (ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å…¶å®ƒå®‰è£…æ–¹å¼. åœ¨ <a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a> ä¸­å¯ä»¥æ‰¾åˆ°å¾ˆå¤šä¸åŒç¯å¢ƒçš„å®‰è£…æ–¹å¼. )</p><p>è¿™é‡Œæ˜¯ helm çš„å®‰è£…æ–‡æ¡£: <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></p><p>å½“å‰å®ƒçš„å®‰è£…æ–¹å¼åº”è¯¥æ˜¯:</p><pre><code class="language-bash">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3chmod 700 get_helm.sh./get_helm.sh</code></pre><p>å½“å‰ingress-nginxçš„ä»“åº“åœ°å€æ˜¯: <a href="https://hub.helm.sh/charts/ingress-nginx/ingress-nginx">https://hub.helm.sh/charts/ingress-nginx/ingress-nginx</a> ä½ å¯ä»¥åœ¨è¿™é‡Œç›´æ¥æ‰¾åˆ°å®‰è£…å‘½ä»¤</p><pre><code class="language-bash">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginxhelm repo add stable https://kubernetes-charts.storage.googleapis.com/helm repo updatekubectl create namespace ingress-nginx## å®‰è£…helm install ingress-nginx ingress-nginx/ingress-nginx -n ingress-nginx## å‡çº§helm upgrade ingress-nginx ingress-nginx/ingress-nginx -n ingress-nginx --install## è‡ªå®šä¹‰é…ç½®å®‰è£…helm show values ingress-nginx/ingress-nginx &gt; ingress-nginx.yamlhelm install ingress-nginx ingress-nginx/ingress-nginx -f ingress-nginx.yaml -n ingress-nginx</code></pre><pre><code class="language-bash">kubectl get all -n ingress-nginx===NAME                                            READY   STATUS    RESTARTS   AGEpod/ingress-nginx-controller-5886685d54-hf6l6   1/1     Running   0          68mNAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGEservice/ingress-nginx-controller             LoadBalancer   10.96.210.139   &lt;pending&gt;     80:32489/TCP,443:30936/TCP   68mservice/ingress-nginx-controller-admission   ClusterIP      10.96.128.101   &lt;none&gt;        443/TCP                      68mNAME                                       READY   UP-TO-DATE   AVAILABLE   AGEdeployment.apps/ingress-nginx-controller   1/1     1            1           68mNAME                                                  DESIRED   CURRENT   READY   AGEreplicaset.apps/ingress-nginx-controller-5886685d54   1         1         1       68m</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ingress-nginx æ§åˆ¶å™¨åˆ›å»ºäº†ä¸€ä¸ª pod, è¿™ä¸ª pod å…¶å®å°±æ˜¯ä¸€ä¸ª nginx. å®ƒé€šè¿‡æ¥æ”¶ ingress å®šä¹‰çš„è§„åˆ™, æ¥åŠ¨æ€çš„å˜æ›´nginxé…ç½®,ä»è€Œæ­£ç¡®çš„å°†æµé‡è½¬å‘ç»™åç«¯åº”ç”¨çš„serviceå¯¹è±¡.</p><pre><code class="language-bash">kubectl describe pod/ingress-nginx exec -it pod/ingress-nginx-controller-5886685d54-hf6l6===    Requests:      cpu:      100m      memory:   90Mi</code></pre><p>å½“å‰é…ç½®é»˜è®¤æ²¡æœ‰åšlimité™åˆ¶. æ‰€ä»¥éœ€è¦å…³æ³¨ingress-nginxåˆ›å»ºçš„podæ‰€åœ¨ç‰©ç†èŠ‚ç‚¹çš„æ€§èƒ½æ˜¯å¦å¯ä»¥æ»¡è¶³. å»ºè®®å¼ºåˆ¶ç»‘å®šåˆ°å¤šä¸ªnodeèŠ‚ç‚¹, è¿™æ‰¹èŠ‚ç‚¹ä¸“é—¨è·‘ç”¨æ¥è¿›è¡Œingressæ§åˆ¶å™¨.</p><pre><code class="language-bash">kubectl --namespace ingress-nginx exec -it pod/ingress-nginx-controller-5886685d54-hf6l6 -- /bin/bash==cat /etc/nginx/nginx.conf</code></pre><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ingress-nginxä¼šåŠ¨æ€çš„åŠ è½½ingresså®šä¹‰çš„è·¯ç”±è§„åˆ™.</p><p>æœ€å, æˆ‘ä»¬å¯èƒ½æœ€éœ€è¦å…³æ³¨çš„æ˜¯ <code>service/ingress-nginx-controller</code> å¯¹è±¡. å› ä¸ºå®ƒçš„ç±»å‹å†³å®šäº†, æˆ‘ä»¬å¦‚ä½•è§£æå°†è¦æš´æ¼çš„æœåŠ¡åŸŸå.</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é€šè¿‡helmé»˜è®¤å®‰è£…çš„ ingress crotroller çš„ Service å¯¹è±¡æ˜¯LoadBalancerç±»å‹. è¿™ç§ç±»å‹æˆ‘ä»¬ä¸€èˆ¬æ˜¯ç”¨äºäº‘ç«¯ç¯å¢ƒçš„. è€Œæˆ‘è¿™é‡Œæµ‹è¯•ç¯å¢ƒæ˜¯è£¸æœº,å› æ­¤ä½ å¯ä»¥çœ‹åˆ°è¿™é‡Œå®ƒä¸€ç›´æ— æ³•è·å–åˆ°<code>EXTERNAL-IP</code>.</p><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜.k8så®˜æ–¹æ–‡æ¡£è¿™é‡Œæä¾›äº†å¤šç§è£¸æœºå®‰è£…ä¸‹çš„è§£å†³æ–¹æ¡ˆ. <a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/</a></p><p>æˆ‘ä»¬è¿™é‡Œé€šè¿‡ <a href="https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb">https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#a-pure-software-solution-metallb</a> æ–¹æ¡ˆæ¥è§£å†³ LB ç±»å‹çš„ <code>EXTERNAL-IP</code>è·å–é—®é¢˜. å…¶å®ƒæ–¹æ¡ˆå¹¶ä¸æ˜¯é‡‡ç”¨çš„ LB ç±»å‹, å› æ­¤è¿™é‡Œä¸å†å™è¯´.</p><p>âš ï¸metallb æ–¹æ¡ˆåœ¨å½“å‰å¹¶ä¸æ˜¯ä¸€ä¸ªæˆç†Ÿçš„æ–¹æ¡ˆ,å½“ç„¶å®ƒåº”è¯¥æ˜¯å¯ç”¨çš„ğŸ˜„ æ‰€ä»¥ç”¨äºæœ¬åœ°æµ‹è¯•ç¯å¢ƒæ˜¯å¯ä»¥çš„. çº¿ä¸Šç¯å¢ƒå»ºè®®ç›´æ¥ç”¨äº‘æœåŠ¡çš„LBå³å¯.</p><h2 id="metallb">metallb</h2><p><a href="https://metallb.universe.tf/installation/">https://metallb.universe.tf/installation/</a></p><p>metallb æ¨¡æ‹Ÿäº†äº‘ç¯å¢ƒä¸­çš„è´Ÿè½½å‡è¡¡å™¨åŠŸèƒ½.</p><p>ğŸŒŸIf youâ€™re using kube-proxy in IPVS mode, since Kubernetes v1.14.2 you have to enable strict ARP mode.</p><p>å¦‚æœä½ æ˜¯ipvs ä¸” k8s ç‰ˆæœ¬åœ¨1.14.2ä»¥ä¸Š, é‚£ä¹ˆä½ éœ€è¦å¯åŠ¨ä¸¥æ ¼arpæ¨¡å¼.</p><pre><code class="language-bash">kubectl edit configmap -n kube-system kube-proxy===ipvs:  strictARP: true</code></pre><p>å¼€å§‹å®‰è£…</p><pre><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/namespace.yamlkubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/metallb.yaml# ä¸‹é¢è¿™ä¸ªå‘½ä»¤ä»…åœ¨ä½ åˆå§‹å®‰è£…çš„æ—¶å€™éœ€è¦è¿è¡Œkubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=&quot;$(openssl rand -base64 128)&quot;</code></pre><p>metallbå°†ä¼šåœ¨ä¸€ä¸ªæ–°çš„<code>ns: metallb-system</code>ä¸‹åˆ›å»º.</p><p>å¼€å§‹é…ç½®åœ°å€æ± </p><p>metallbé€šè¿‡ä¸€ä¸ªåœ°å€æ± (cmå¯¹è±¡)æ¥ç»™LBåˆ†å‘ip. æˆ‘ä»¬å°†ä¸º metallb ä¸‹å‘ä¸€ä¸ªå†…ç½‘åœ°å€æ± . è¯·è®°ä½, è¿™äº›åœ°å€å¿…é¡»æ˜¯æ²¡æœ‰è¢«å…¶å®ƒèµ„æºå ç”¨çš„.</p><pre><code class="language-yaml"># metallb.cm.yamlapiVersion: v1kind: ConfigMapmetadata:  namespace: metallb-system  name: configdata:  config: |    address-pools:    - name: default      protocol: layer2      addresses:      - 10.200.16.11-10.200.16.29</code></pre><pre><code class="language-bash">kubectl apply -f metallb.cm.yaml</code></pre><p>ä¸‹é¢,è®©æˆ‘ä»¬å†çœ‹çœ‹ ingress crotroller çš„ svc å¯¹è±¡ä¿¡æ¯.</p><pre><code class="language-bash">kubectl get svc -n ingress-nginx===NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                      AGEingress-nginx-controller             LoadBalancer   10.96.210.139   10.200.16.11   80:32489/TCP,443:30936/TCP   88mingress-nginx-controller-admission   ClusterIP      10.96.128.101   &lt;none&gt;         443/TCP                      88m</code></pre><p>ç»ˆäº<code>svc/ingress-nginx-controller</code>æ‹¿åˆ°äº†ä¸€ä¸ª<code>EXTERNAL-IP</code>, ç°åœ¨ä½ å°±å¯ä»¥å°†åŸŸåè§£æåˆ°<code>EXTERNAL-IP</code>, å¹¶é€šè¿‡è¿™ä¸ªåŸŸåæ¥è®¿é—®ä½ çš„åº”ç”¨äº†.(è€Œä¸”å®ƒå¿…é¡»æ˜¯èƒ½é€šè¿‡80è®¿é—®çš„.)ğŸ˜„</p><p>åŒæ—¶, è®©æˆ‘ä»¬æ¥çœ‹çœ‹ ingress å¯¹è±¡ä¿¡æ¯.</p><p>â­ï¸æˆ‘æš´æ¼çš„åº”ç”¨åœ¨ns: itä¸­.</p><pre><code class="language-bash">kubectl get ingress -n it===NAME                   CLASS    HOSTS          ADDRESS        PORTS   AGE test-it-local-ingress   &lt;none&gt;   test.it.local   10.200.16.11   80      106m</code></pre><p>å¯ä»¥çœ‹åˆ°. ingress çš„ä¿¡æ¯ä¹Ÿæ›´æ–°äº†, å¹¶æ‹¿åˆ°äº† metallb çš„ä¸‹å‘çš„ip.</p><p>ä½ å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šé€šè¿‡ ipvs è§„åˆ™æ¥çœ‹åˆ°è½¬å‘æƒ…å†µ.</p><pre><code class="language-bash">ipvsadm -L -n===TCP  10.200.16.11:80 rr  -&gt; 10.97.2.57:80                Masq    1      0          0TCP  10.200.16.11:443 rr  -&gt; 10.97.2.57:443               Masq    1      0          0</code></pre><p>è¿™é‡Œ 10.97.2.57 æ˜¯ ingress æ§åˆ¶å™¨çš„ pod ip.</p><h2 id="ingress-nginx-æš´æ¼é80å’Œé443ç«¯å£">ingress-nginx æš´æ¼é80å’Œé443ç«¯å£</h2><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/">https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/</a></p><p>é»˜è®¤ä½ ä¼šå‘ç°ingressæ— æ³•æš´æ¼80å’Œ443ä¹‹å¤–çš„ç«¯å£.è¿™æ˜¯å› ä¸ºé»˜è®¤ingress-nginxå¹¶æ²¡æœ‰å¼€å¯4å±‚è½¬å‘.</p><h3 id="å¼€å¯ingress-nginxä¸­podçš„4å±‚è½¬å‘">å¼€å¯ingress-nginxä¸­podçš„4å±‚è½¬å‘</h3><p>æ£€æŸ¥ deployment: ingress-nginx ä¸­ pod æ¨¡æ¿æ˜¯å¦å¼€å¯äº†ä¸‹åˆ—å‚æ•°</p><pre><code class="language-bash">deploymentName=`kubectl get all -n ingress-nginx | grep deployment | awk '&#123;print $1&#125;'`kubectl edit $&#123;deploymentName&#125; -n ingress-nginx===- args:    - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services    - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</code></pre><h3 id="åˆ›å»ºæš´æ¼ç«¯å£çš„é…ç½®æ–‡ä»¶">åˆ›å»ºæš´æ¼ç«¯å£çš„é…ç½®æ–‡ä»¶</h3><pre><code class="language-yaml">apiVersion: v1kind: ConfigMapmetadata:  name: tcp-services  namespace: ingress-nginxdata:  8080: &quot;it/test-it-local-svc:8080&quot;</code></pre><p>è¿™é‡Œ8080: &quot;it/test-it-local-svc:8080&quot;<code>ç¬¬ä¸€ä¸ª8080æŒ‡çš„æ˜¯ingress-nginxçš„podå¯¹è±¡é‡Œéœ€è¦ç›‘å¬çš„ç«¯å£, </code>it/test-it-local-svc:8080` æŒ‡çš„æ˜¯ns:itä¸‹çš„svcå¯¹è±¡test-it-local-svcçš„8080ç«¯å£</p><h3 id="æ·»åŠ æš´æ¼ç«¯å£åˆ°ingress-nginxä¸­svcå¯¹è±¡">æ·»åŠ æš´æ¼ç«¯å£åˆ°ingress-nginxä¸­svcå¯¹è±¡</h3><pre><code class="language-bash">kubectl get all -n ingress-nginx | grep service | awk '&#123;print $1&#125;' kubectl edit service/ingress-nginx-controller -n ingress-nginx===  - name: test-8080    port: 8080    protocol: TCP    targetPort: 8080</code></pre><p>ä¸‰æ­¥è¿‡å, ä¸å‡ºæ„å¤–, ä½ å°†å¯ä»¥é€šè¿‡ingress-nginxçš„podå¯¹è±¡ä¸­çš„nginx.confæ–‡ä»¶çœ‹åˆ°tcpçš„è½¬å‘é…ç½®.</p><pre><code class="language-bash">        # TCP services        server &#123;                preread_by_lua_block &#123;                        ngx.var.proxy_upstream_name=&quot;tcp-it-test-it-local-svc-8080&quot;;                &#125;                listen                  8080;                proxy_timeout           600s;                proxy_pass              upstream_balancer;        &#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜12æœ‰çŠ¶æ€æœåŠ¡StatefulSet</title>
      <link href="posts/4bf29cf0/"/>
      <url>posts/4bf29cf0/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å½“æˆ‘ä»¬æ„å»ºä¸€ä¸ªæœ‰çŠ¶æ€çš„åº”ç”¨çš„æ—¶å€™, ä¾‹å¦‚ mysql / ftp / åŒ…å«sessionçš„ç®¡ç†ç•Œé¢ç­‰. æˆ‘ä»¬å¯èƒ½ä¼šæœ‰ä¸‹åˆ—é¢„æœŸ:</p><ul><li>ç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦ã€‚</li><li>ç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨ã€‚</li><li>æœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œç¼©æ”¾ã€‚</li><li>æœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–°ã€‚</li></ul><p>StatefulSet å°±æ˜¯å¹²è¿™ä¸ªçš„.</p><h2 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h2><pre><code class="language-yaml:">apiVersion: v1kind: Servicemetadata:  name: nginx  labels:    app: nginxspec:  ports:  - port: 80    name: web  clusterIP: None  selector:    app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata:  name: webspec:  serviceName: &quot;nginx&quot;  replicas: 2  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: k8s.gcr.io/nginx-slim:0.8        ports:        - containerPort: 80          name: web        volumeMounts:        - name: www          mountPath: /usr/share/nginx/html  volumeClaimTemplates:  - metadata:      name: www    spec:      accessModes: [ &quot;ReadWriteOnce&quot; ]      resources:        requests:          storage: 1Gi</code></pre><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>pod æ‹¥æœ‰å”¯ä¸€çš„é¡ºåºç´¢å¼•å’Œç¨³å®šçš„ç½‘ç»œèº«ä»½(ä¸ç®¡æ€ä¹ˆåˆ , åå­—éƒ½ä¸å˜, ip ä¼šå˜). pod è¢«éƒ¨ç½²çš„æ—¶å€™å…¶åå­—æ˜¯æŒ‰ç…§<code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>åˆ›å»ºçš„(web-0, web-1). è¿™ä¸ªåå­—å°±æ˜¯ä»–ä»¬çš„hostname.(è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>pod ä¸ç®¡æ€ä¹ˆåˆ , podä¸pvcä¹‹é—´çš„å…³ç³»éƒ½ä¸ä¼šæ··ä¹±.</li><li>pod ä¹‹é—´å¯ä»¥é€šè¿‡å›ºå®šçš„åŸŸåäº’ç›¸è®¿é—®.</li><li>å¯åŠ¨ pod çš„æ—¶å€™, æŒ‰ç…§ç´¢å¼•, ä» 0 å¼€å§‹. ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨. ä¸ä¼šåŒæ—¶å¯åŠ¨å¤šä¸ª. (è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>åˆ é™¤ pod çš„æ—¶å€™, æŒ‰ç…§ç´¢å¼•å€’åºåˆ é™¤, ä»æœ€åä¸€ä¸ªå¼€å§‹, ä¸€ä¸ªä¸€ä¸ªåˆ é™¤. ä¸ä¼šåŒæ—¶åˆ é™¤å¤šä¸ª. (è¿™æ˜¯é»˜è®¤è¡Œä¸º)</li><li>åˆ é™¤ pod çš„æ—¶å€™, pvc å’Œ pv å¹¶ä¸ä¼šåˆ é™¤.</li><li>Service å¿…é¡»æ˜¯ headless .</li></ul><blockquote><p>ä½ å¯ä»¥é€šè¿‡è®¾ç½®statefulsetç®¡ç†ç­–ç•¥, æ¥æ”¹å˜ä¸Šè¿°é»˜è®¤è¡Œä¸º</p><p><a href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy">https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy</a></p></blockquote><h2 id="æ‰©å±•-ç¼©æ”¾">æ‰©å±•/ç¼©æ”¾</h2><p>æ‰©å±•: <code>kubectl scale sts web --replicas=5</code></p><p>ç¼©æ”¾: <code>kubectl patch sts web -p '&#123;&quot;spec&quot;:&#123;&quot;replicas&quot;:3&#125;&#125;'</code></p><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œ replicas çš„å€¼æ¥è¿›è¡Œå˜æ›´.</p><h2 id="æ›´æ–°">æ›´æ–°</h2><p>æœ‰çŠ¶æ€åº”ç”¨çš„æ›´æ–°å’Œæ— çŠ¶æ€åº”ç”¨çš„æ›´æ–°æœ‰äº›å·®å¼‚.</p><p>æœ‰çŠ¶æ€åº”ç”¨çš„æ›´æ–°ç­–ç•¥(spec.updateStrategy)æ˜¯ RollingUpdate å’Œ OnDelete. å…¶ä¸­ RollingUpdate æ˜¯é»˜è®¤ç­–ç•¥, è¿™ä¸ªæ˜¯è‡ªåŠ¨æ»šåŠ¨æ›´æ–°. è€ŒOnDeleteçš„æ„æ€æ˜¯åªæœ‰ä½ æ‰‹åŠ¨åˆ é™¤äº†podæ‰ä¼šæ›´æ–°.</p><p>æ›´æ–°æ˜¯é’ˆå¯¹podæ¨¡æ¿çš„. ä¾‹å¦‚:</p><pre><code class="language-bash">kubectl patch statefulset web --type='json' -p='[&#123;&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/image&quot;, &quot;value&quot;:&quot;gcr.io/google_containers/nginx-slim:0.8&quot;&#125;]'</code></pre><blockquote><p>è¿™é‡Œæ›´æ–°äº†nginxçš„é•œåƒ.</p></blockquote><p>æ›´æ–°éµå¾ªä»¥ä¸‹åŸåˆ™:</p><ul><li><p>æ‰€æœ‰çš„ pod éœ€è¦æ˜¯å°±ç»ªçŠ¶æ€.</p></li><li><p>æ›´æ–°é‡‡ç”¨ç´¢å¼•å€’åºè¿›è¡Œ(å³ä»ç´¢å¼•æœ€åä¸€ä¸ªå·ç å¼€å§‹æ›´æ–°), å¹¶ä¸”æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ›´æ–°.</p></li><li><p>å½“æ›´æ–°å¤±è´¥çš„æ—¶å€™, å·²ç»æ”¶åˆ°æ›´æ–°çš„podå°†ä¿æŒæ›´æ–°åçš„ç‰ˆæœ¬, æ²¡æœ‰å¼€å§‹æ›´æ–°çš„podå°†æ¢å¤åˆ°æ›´æ–°å‰çš„ç‰ˆæœ¬.</p></li></ul><p>ğŸŒŸéœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœä½ çš„æ›´æ–°æ–‡ä»¶(äºŒè¿›åˆ¶æ–‡ä»¶æ•…éšœæˆ–è€…é…ç½®æ–‡ä»¶)æœ‰é—®é¢˜ä»è€Œå¯¼è‡´æ›´æ–°å¤±è´¥, ä½ å¯èƒ½éœ€è¦å¼ºåˆ¶å›æ»š. ä»¥ä¸‹æ˜¯è¯´æ˜ä¿¡æ¯:</p><p>å³ä½ æ¢å¤äº†æ›´æ–°å‰çš„æ¨¡æ¿,å´å‘ç°statefulsetä¾ç„¶ä¸æ­£å¸¸, åˆ™ä½ éœ€è¦<strong>æ‰‹åŠ¨åˆ é™¤</strong>æ‰€æœ‰ç”±é”™è¯¯æ¨¡æ¿äº§å‡ºçš„pod.</p><p>åœ¨è¿™ä¹‹å, statefulsetå°†ä¼šé‡‡ç”¨æ›´æ–°å‰çš„æ¨¡æ¿é‡å»ºpod.</p><p>(<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#forced-rollback">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#forced-rollback</a>)</p><h2 id="é˜¶æ®µæ›´æ–°-staging-an-update">é˜¶æ®µæ›´æ–°(staging an update)</h2><p>æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½å¹¶ä¸æƒ³ä¸€æ¬¡æ›´æ–°æ‰€æœ‰, æ­¤æ—¶å¯ä»¥è¿›è¡Œé˜¶æ®µæ›´æ–°.</p><p>é˜¶æ®µæ›´æ–°çš„æ„æ€å°±æ˜¯é€šè¿‡åœ¨ç´¢å¼•ä¸Šè®¾ç½®ä¸€ä¸ªç‚¹. å½“podçš„ç´¢å¼•å¤§äºç­‰äºè¿™ä¸ªç‚¹çš„æ—¶å€™, æ‰ä¼šæ›´æ–°. (é»˜è®¤ç‚¹æ˜¯ç´¢å¼•0)</p><pre><code class="language-bash">kubectl patch statefulset web -p '&#123;&quot;spec&quot;:&#123;&quot;updateStrategy&quot;:&#123;&quot;type&quot;:&quot;RollingUpdate&quot;,&quot;rollingUpdate&quot;:&#123;&quot;partition&quot;:3&#125;&#125;&#125;&#125;'</code></pre><p>è¿™ä¸ªæ„æ€æ˜¯è®¾ç½®ç´¢å¼•3ä¸ºé˜¶æ®µåˆ†å‰²ç‚¹.</p><p>å¦‚æœä½ æƒ³å›åˆ°é»˜è®¤æ›´æ–°, åˆ™åªéœ€è¦è°ƒæ•´åˆ†å‰²ç‚¹, é‡æ–°æ‰§è¡Œä¸Šè¿°å‘½ä»¤å³å¯.</p><h2 id="åˆ é™¤">åˆ é™¤</h2><p>åˆ é™¤åˆ†ä¸ºè”çº§åˆ é™¤å’Œéè”çº§åˆ é™¤.</p><p>è”çº§åˆ é™¤å°±æ˜¯ statefulset å’Œ pod éƒ½åˆ é™¤. è¿™æ˜¯é»˜è®¤è¡Œä¸º.</p><p>éè”çº§åˆ é™¤, åªä¼šåˆ é™¤ statefulset. ä½ å¯ä»¥é€šè¿‡åˆ é™¤çš„æ—¶å€™é™„åŠ <code>--cascade=false</code>å¼€å¯å®ƒ.</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> StatefulSet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜12å®ˆæŠ¤è¿›ç¨‹</title>
      <link href="posts/63d8d3d4/"/>
      <url>posts/63d8d3d4/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>DaemonSet ç¡®ä¿æŒ‡å®šçš„nodeä¸Šéƒ½å­˜åœ¨ä¸€ä»½ pod. å¸¸ç”¨æ¥æ„å»ºä¸€äº›æ‰¹é‡ä»£ç†æ€§è´¨çš„app. ä¾‹å¦‚ç›‘æ§èŠ‚ç‚¹app, æˆ–è€…æ—¥å¿—èŠ‚ç‚¹app</p><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>å½“ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°é›†ç¾¤, æˆ–ä»é›†ç¾¤ä¸­åˆ é™¤, åˆ™ pod ä¼šè¢«æ·»åŠ /åˆ é™¤</li><li>å½“DaemonSetè¢«åˆ é™¤, åˆ™ pod éƒ½ä¼šè¢«åˆ é™¤.</li><li>podæ¨¡æ¿ä¸­çš„ RestartPolicy å¿…é¡»æ˜¯é»˜è®¤å€¼, ä¹Ÿå°±æ˜¯ Always.</li><li>åˆ›å»ºå.spec.selector ä¸å¯ä¿®æ”¹.</li><li>é»˜è®¤è°ƒåº¦åœ¨æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„nodeä¸Š.</li></ul><h2 id="ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</h2><pre><code class="language-yaml">apiVersion: apps/v1kind: DaemonSetmetadata:  name: fluentd-elasticsearch  namespace: kube-system  labels:    k8s-app: fluentd-loggingspec:  selector:    matchLabels:      name: fluentd-elasticsearch  template:    metadata:      labels:        name: fluentd-elasticsearch    spec:      tolerations:      # this toleration is to have the daemonset runnable on master nodes      # remove it if your masters can't run pods      - key: node-role.kubernetes.io/master        effect: NoSchedule      containers:      - name: fluentd-elasticsearch        image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2        resources:          limits:            memory: 200Mi          requests:            cpu: 100m            memory: 200Mi        volumeMounts:        - name: varlog          mountPath: /var/log        - name: varlibdockercontainers          mountPath: /var/lib/docker/containers          readOnly: true      terminationGracePeriodSeconds: 30      volumes:      - name: varlog        hostPath:          path: /var/log      - name: varlibdockercontainers        hostPath:          path: /var/lib/docker/containers</code></pre><p>è¿™æ˜¯ä¸€ä¸ªæ—¥å¿—é‡‡é›†pod. å®ƒå°†k8sé›†ç¾¤èŠ‚ç‚¹çš„ /var/log å’Œ /var/lib/docker/containers æŒ‚è½½åˆ° pod ä¸­. è¿™æ ·, elasticsearch å°±å¯ä»¥è·å–åˆ°k8sé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯äº†.</p><h2 id="podè¿è¡Œåœ¨éƒ¨åˆ†nodeä¸Š">podè¿è¡Œåœ¨éƒ¨åˆ†nodeä¸Š</h2><p>ä½ æœ‰ä¸¤ç§æ–¹å¼å¤„ç†podçš„éƒ¨åˆ†è°ƒåº¦.</p><h3 id="é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾-nodeSelector-æ¥é€‰æ‹©">é€šè¿‡èŠ‚ç‚¹æ ‡ç­¾(nodeSelector)æ¥é€‰æ‹©.</h3><p><code>.spec.template.spec.nodeSelector</code>å¯ä»¥è®©ä½ ä»…åœ¨åŒ¹é…çš„nodeä¸Šåˆ›å»ºpod.</p><p>ä¾‹å¦‚: ä»…åœ¨æ‹¥æœ‰ssdç£ç›˜çš„èŠ‚ç‚¹ä¸Šæ„å»º</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: nginx  labels:    env: testspec:  containers:  - name: nginx    image: nginx    imagePullPolicy: IfNotPresent  nodeSelector:    disktype: ssd</code></pre><h3 id="é€šè¿‡èŠ‚ç‚¹äº²å’Œæ€§-nodeAffinity-æ¥é€‰æ‹©">é€šè¿‡èŠ‚ç‚¹äº²å’Œæ€§(nodeAffinity)æ¥é€‰æ‹©</h3><p><code>.spec.affinity.nodeAffinity</code> , å®ƒæœ‰ä»¥ä¸‹å±æ€§: (æ¯ä¸€ä¸ªå±æ€§ç”±ä¸¤éƒ¨åˆ†æ„æ€ç»„æˆ)</p><p>requiredDuringScheduling<strong>IgnoredDuringExecution</strong><br>è¡¨ç¤ºpodå¿…é¡»éƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p><p>requiredDuringScheduling<strong>RequiredDuringExecution</strong><br>è¡¨ç¤ºpodå¿…é¡»éƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±ä¸åœé‡è¯•ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œåˆ™é‡æ–°é€‰æ‹©ç¬¦åˆè¦æ±‚çš„èŠ‚ç‚¹ã€‚</p><p>preferredDuringScheduling<strong>IgnoredDuringExecution</strong><br>è¡¨ç¤ºä¼˜å…ˆéƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­IgnoreDuringExecutionè¡¨ç¤ºpodéƒ¨ç½²ä¹‹åè¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ»¡è¶³podæŒ‡å®šçš„æ¡ä»¶ï¼Œpodä¹Ÿä¼šç»§ç»­è¿è¡Œã€‚</p><p>preferredDuringScheduling<strong>RequiredDuringExecution</strong><br>è¡¨ç¤ºä¼˜å…ˆéƒ¨ç½²åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå°±å¿½ç•¥è¿™äº›æ¡ä»¶ï¼ŒæŒ‰ç…§æ­£å¸¸é€»è¾‘éƒ¨ç½²ã€‚å…¶ä¸­RequiredDuringExecutionè¡¨ç¤ºå¦‚æœåé¢èŠ‚ç‚¹æ ‡ç­¾å‘ç”Ÿäº†å˜åŒ–ï¼Œæ»¡è¶³äº†æ¡ä»¶ï¼Œåˆ™é‡æ–°è°ƒåº¦åˆ°æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ã€‚</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: with-node-affinityspec:  affinity:    nodeAffinity:      requiredDuringSchedulingIgnoredDuringExecution:        nodeSelectorTerms:        - matchExpressions:          - key: kubernetes.io/e2e-az-name            operator: In            values:            - e2e-az1            - e2e-az2      preferredDuringSchedulingIgnoredDuringExecution:      - weight: 1        preference:          matchExpressions:          - key: another-node-label-key            operator: In            values:            - another-node-label-value  containers:  - name: with-node-affinity    image: gcr.io/google_containers/pause:2.0</code></pre><p>è¿™ä¸ªé…ç½®çš„æ„æ€æ˜¯pod<strong>å¿…é¡»è¢«è°ƒåº¦</strong><a href="http://xn--kubernetes-m11qu01s34wc.io/e2e-az-name=e2e-az1%E6%88%96%E8%80%85kubernetes.io/e2e-az-name=e2e-az2">åˆ°æ ‡ç­¾kubernetes.io/e2e-az-name=e2e-az1æˆ–è€…kubernetes.io/e2e-az-name=e2e-az2</a> çš„èŠ‚ç‚¹ã€‚ä¸æ­¤åŒæ—¶, è¿˜å°†åœ¨ä¸Šè¿°æ¡ä»¶çš„åŸºç¡€ä¸Š, <strong>ä¼˜å…ˆè°ƒåº¦</strong>åˆ°é¢å¤–æ‹¥æœ‰æ ‡ç­¾ä¸ºanother-node-label-key=another-node-label-valueçš„èŠ‚ç‚¹ä¸Šã€‚</p><h2 id="æ±¡ç‚¹å’Œå®¹å¿åº¦Taint-and-toleration">æ±¡ç‚¹å’Œå®¹å¿åº¦Taint-and-toleration</h2><p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/</a></p><p>k8sé€šè¿‡æ±¡ç‚¹æ¥å‰”é™¤æŸäº›æ•…éšœèŠ‚ç‚¹, æˆ–æ„å»ºä¸€äº›ä¸“å±èŠ‚ç‚¹.</p><p>k8sé€šè¿‡å®¹å¿åº¦æ¥ç¡®ä¿æŸäº›podå¯ä»¥å¿½ç•¥æ±¡ç‚¹.</p><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹. æ²¡æœ‰ä»»ä½•å®¹å¿åº¦çš„podä¸ä¼šè¢«è°ƒåº¦åˆ°å­˜åœ¨æ±¡ç‚¹çš„nodeä¸Š. (å½“å‡ºç°èŠ‚ç‚¹æ•…éšœæ—¶å€™, é»˜è®¤ä¼šé™„åŠ ä¸€ä¸ªå®¹å¿åº¦, å®¹å¿åº¦å¤±æ•ˆ300ç§’)</p><p>ä½†DaemonSetå´éœ€è¦å¿½ç•¥è¿™äº›æ±¡ç‚¹, ä»¥ä¾¿äºpodé•¿å­˜. (ä¾‹å¦‚ä½ æ„å»ºçš„ç›‘æ§pod)</p><p>ä»¥ä¸‹æ˜¯DaemonSetè‡ªåŠ¨é™„åŠ çš„å®¹å¿åº¦, å®ƒå°†å¿½ç•¥è¿™äº›æ±¡ç‚¹. (æˆªè‡³åˆ°v1.19)</p><pre><code class="language-bash">node.kubernetes.io/not-readynode.kubernetes.io/unreachablenode.kubernetes.io/disk-pressurenode.kubernetes.io/memory-pressurenode.kubernetes.io/unschedulablenode.kubernetes.io/network-unavailable</code></pre><p>ä¸Šè¿°æƒ…å†µåŸºæœ¬ä¿è¯äº†DaemonSetçš„podä¸ä¼šå› å„ç§æ„å¤–æƒ…å†µå¯¼è‡´podè¢«é©±é€.</p><h2 id="è®¿é—®DaemonSet-pod">è®¿é—®DaemonSet pod</h2><p>ä½ å¯ä»¥é€šè¿‡æ„å»ºä¸€ä¸ª Headless Service å¹¶é€šè¿‡ endpoint  æ¥è®¿é—®å„ä¸ª pod.</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> DaemonSet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜11-2namespaceèµ„æºçº¦æŸ</title>
      <link href="posts/ed4c29d5/"/>
      <url>posts/ed4c29d5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://kubernetes.io/docs/concepts/policy/limit-range/">https://kubernetes.io/docs/concepts/policy/limit-range/</a></p><p>namespace èµ„æºçº¦æŸ(LimitRange)é˜²æ­¢podçš„é…ç½®è¶…å‡ºé¢„æœŸ.ä»è€Œè®©æˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿çš„ç®¡ç†èµ„æº.</p><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><ul><li>æä¾› pod çš„é»˜è®¤èµ„æºçº¦æŸ.</li><li>é™åˆ¶podçš„èµ„æºçº¦æŸ.</li><li>LimitRangeé…ç½®ç­–ç•¥çš„æ„å»ºå’Œå˜æ›´ä»…å½±å“ä¹‹åçš„pod</li></ul><h2 id="æµç¨‹">æµç¨‹</h2><h3 id="æ„å»ºLimitRange">æ„å»ºLimitRange</h3><pre><code class="language-yaml">apiVersion: v1kind: LimitRangemetadata:  name: cpu-mem-storage-min-max-defaultspec:  limits:  - type: Container    max:      cpu: &quot;1000m&quot;      memory: &quot;1G&quot;    min:      cpu: &quot;50m&quot;      memory: &quot;50M&quot;    default:      cpu: &quot;250m&quot;      memory: &quot;250M&quot;    defaultRequest:      cpu: &quot;50m&quot;      memory: &quot;50M&quot;  - type: PersistentVolumeClaim    max:      storage: 30G    min:      storage: 8G</code></pre><pre><code class="language-bash">kubectl apply -f limitrange-default.yaml --namespace=default</code></pre><p>ä¸Šè¿°ä¾‹å­ä¸º default å‘½åç©ºé—´åŠ äº†ä¸€ä¸ªèµ„æºç­–ç•¥.æ•ˆæœå¦‚ä¸‹:</p><ul><li><p>å½“podæ²¡æœ‰ä»»ä½•é™åˆ¶çš„æ—¶å€™, pod è§„åˆ™å¦‚ä¸‹éµå¾ª default å’Œ defaultRequest çš„å±æ€§</p><ul><li><p>limit: cpu=250m mem=250M</p></li><li><p>request: cpu=50m mem=50M</p></li><li><p>8G &lt; pvc &lt; 30G</p><p>ä¼šå…¨éƒ¨èµ°limitrangeçš„é»˜è®¤å€¼</p></li></ul></li><li><p>å½“podè®¾ç½®äº†limit: cpu=1000m mem=1Gçš„æ—¶å€™, podè§„åˆ™å¦‚ä¸‹</p><ul><li><p>limit: cpu=1000m mem=1G</p></li><li><p>request: cpu=1000m mem=1G</p></li><li><p>8G &lt; pvc &lt; 30G</p><p>è¿™é‡Œæ¯”è¾ƒå¥‡è‘©, å®˜æ–¹å°±æ˜¯è¿™ä¹ˆè®¾å®šçš„. è™½ç„¶ä½ æ²¡è®¾ç½®request, ä½†æ˜¯request ä¸ä¼šèµ°é»˜è®¤å€¼, ä¼šç»§æ‰¿ limit çš„è‡ªå®šä¹‰å€¼</p></li></ul></li><li><p>å½“podåªè®¾ç½®äº†request: cpu=100m mem=150Mçš„æ—¶å€™, podè§„åˆ™å¦‚ä¸‹</p><ul><li><p>limit: cpu=250m mem=250M</p></li><li><p>request: cpu=100m mem=150M</p></li><li><p>8G &lt; pvc &lt; 30G</p><p>è¿™é‡Œç¬¦åˆå¤§å®¶çš„é€»è¾‘â€¦æ²¡è®¾ç½®å°±æ˜¯èµ°é»˜è®¤.</p></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> namespace </tag>
            
            <tag> èµ„æºçº¦æŸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜11-1podèµ„æºçº¦æŸ</title>
      <link href="posts/64fa9c84/"/>
      <url>posts/64fa9c84/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</a></p><p>èµ„æºçº¦æŸåœ¨æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„æ—¶å€™ä¸»è¦æ˜¯cpuå’Œå†…å­˜å±‚é¢, ä»¥åŠæœ¬åœ°ä¸´æ—¶å­˜å‚¨(emptyDir)</p><p>k8sèµ„æºçº¦æŸåˆ†ä¸ºä¸¤ç§: request(è½¯çº¦æŸ) å’Œ limits(ç¡¬çº¦æŸ)</p><p>request(è½¯çº¦æŸ)ç¡®ä¿äº†podä¸­çš„å®¹å™¨è‡³å°‘å¯ä»¥ä½¿ç”¨è¿™ä¹ˆå¤šèµ„æº. ä¸è¿‡å½“èŠ‚ç‚¹å¦‚æœæ²¡æœ‰å…¶å®ƒå®¹å™¨,åˆ™æ­¤å®¹å™¨å¯ä»¥çªç ´requesté™åˆ¶.</p><p>limits(ç¡¬çº¦æŸ) åˆ™ä½¿ç¡¬æ€§çš„é™åˆ¶äº†å®¹å™¨èµ„æºä¸Šé™. å¦‚æœå®¹å™¨è¯·æ±‚çš„å†…å­˜å¤§äºäº†limits,åˆ™ä¼šæ”¶åˆ°oomé”™è¯¯. å¦‚æœå®¹å™¨è¯·æ±‚çš„cpuå¤§äºäº†limits, åˆ™ä¸ä¼šäº§å‡ºé”™è¯¯, å› ä¸ºcpuå¯¹äºç¨‹åºæ¥è¯´,å®ƒä¸æ˜¯ä¸€ä¸ªç¡¬æ€§æŒ‡æ ‡.å¦‚æœcpuèµ„æºä¸å¤Ÿ,åªä¼šå¯¼è‡´ç¨‹åºå¡é¡¿åˆ°æ­»â€¦</p><p>æœ€å,k8sä¼šä¸¥æ ¼æŒ‰ç…§podå®šä¹‰çš„èµ„æºé™åˆ¶è¿›è¡Œè°ƒåº¦,å³æ—¶æŸä¸ªèŠ‚ç‚¹ä¸Šæœ‰å¤§é‡ç©ºé—²èµ„æº,ä½†åªè¦ç©ºé—²èµ„æºä¸èƒ½æ»¡è¶³podçš„èµ„æºå®šä¹‰,å°±ä¸èƒ½è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Š.</p><h2 id="å†™æ³•">å†™æ³•</h2><ul><li><code>spec.containers[].resources.limits.cpu </code>cpué™åˆ¶</li><li><code>spec.containers[].resources.limits.memory</code> å†…å­˜é™åˆ¶</li><li><code>spec.containers[].resources.limits.hugepages-&lt;size&gt;</code>   ä¸å¸¸ç”¨, å¯ä»¥å¿½ç•¥</li><li><code>spec.containers[].resources.limits.ephemeral-storage</code> emptyä¸´æ—¶å­˜å‚¨é™åˆ¶</li><li><code>spec.containers[].resources.requests.cpu</code></li><li><code>spec.containers[].resources.requests.memory</code></li><li><code>spec.containers[].resources.requests.hugepages-&lt;size&gt; </code> ä¸å¸¸ç”¨, å¯ä»¥å¿½ç•¥</li><li><code>spec.containers[].resources.requests.ephemeral-storage</code></li></ul><h2 id="å•ä½">å•ä½</h2><p>k8så°†ä¸€ä¸ªè¶…çº¿ç¨‹ç§°ä¸ºä¸€ä¸ªvcpu. 1vcpu=1000m. æˆ‘ä»¬åœ¨å®šä¹‰èµ„æºé™åˆ¶æ—¶, åº”è¯¥å§‹ç»ˆç”¨ m ä½œä¸ºå•ä½.å‡è®¾ä½ é™åˆ¶0.5ä¸ªvcpu,åˆ™å¡«å†™500m.</p><p>k8sçš„å†…å­˜å’Œä¸´æ—¶å­˜å‚¨å•ä½å’Œå¹³æ—¶æˆ‘ä»¬æ‰€ç”¨çš„æ²¡ä»€ä¹ˆåŒºåˆ«. ä½ åªéœ€è¦è®°ä½ K/M/G/T/P/E è¿™äº›å³å¯. ä¾‹å¦‚, 100Må°±æ˜¯100å…†</p><p>ä¸€ä¸ªä¾‹å­:</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: frontendspec:  containers:  - name: app    image: images.my-company.example/app:v4    resources:      requests:        memory: &quot;64M&quot;        cpu: &quot;250m&quot;        ephemeral-storage: &quot;2Gi&quot;      limits:        memory: &quot;128M&quot;        cpu: &quot;500m&quot;        ephemeral-storage: &quot;4Gi&quot;  - name: log-aggregator    image: images.my-company.example/log-aggregator:v6    resources:      requests:        memory: &quot;64M&quot;        cpu: &quot;250m&quot;        ephemeral-storage: &quot;2Gi&quot;      limits:        memory: &quot;128M&quot;        cpu: &quot;500m&quot;        ephemeral-storage: &quot;4Gi&quot;</code></pre><h2 id="èµ„æºé™åˆ¶å¦‚ä½•è¿ä½œ">èµ„æºé™åˆ¶å¦‚ä½•è¿ä½œ</h2><p>k8sä¼šé€šè¿‡kubeletå°†podå®šä¹‰çš„èµ„æºé™åˆ¶ä¼ é€’ç»™å®¹å™¨.</p><p>å¦‚æœä½ å®¹å™¨ä½¿ç”¨çš„æ˜¯docker.</p><p>cpuè½¯é™åˆ¶å°†å¯¹æ ‡dockerçš„â€“cpu-shares. è€Œcpuç¡¬é™åˆ¶ä¼šå‘Šè¯‰å®¹å™¨æ¯100mså¯ä»¥ä½¿ç”¨çš„CPUæ—¶é—´æ€»é‡æ˜¯  limits.cpu * 100.</p><blockquote><p>å…³äºdockerçš„â€“cpu-shares, å¯ä»¥å‚è€ƒhttps://docs.docker.com/engine/reference/run/#cpu-share-constraint</p><p>æ€»çš„æ¥è¯´, --cpu-shares ä¼šè®©å®¹å™¨æŒ‰ç…§æ‰€è®¾å®šçš„åˆ†å€¼æ¯”ä¾‹å»ä½¿ç”¨cpu.ä¸è¿‡, åœ¨å¤šæ ¸å¿ƒèŠ‚ç‚¹ä¸Š, è¿™ä¸ªè§„åˆ™åˆä¸æ˜¯å¾ˆé€‚ç”¨. æŒ‰ç…§å®˜æ–¹çš„è¯´æ³•, å½“å¤šæ ¸å¿ƒcpuçš„æ—¶å€™,å®ƒçš„è§„åˆ™æ˜¯:</p><p>On a multi-core system, the shares of CPU time are distributed over all CPU cores. Even if a container is limited to less than 100% of CPU time, it can use 100% of each individual CPU core.</p><p>For example, consider a system with more than three cores. If you start one container <code>&#123;C0&#125;</code> with <code>-c=512</code> running one process, and another container <code>&#123;C1&#125;</code> with <code>-c=1024</code> running two processes, this can result in the following division of CPU shares:</p><pre><code>PID    containerCPUCPU share100    &#123;C0&#125;0100% of CPU0101    &#123;C1&#125;1100% of CPU1102    &#123;C1&#125;2100% of CPU2</code></pre><p>è¿™é‡Œä¸‰ä¸ªå®¹å™¨,éƒ½æ˜¯å•æ ¸å¿ƒç¨‹åº</p></blockquote><p>å†…å­˜çš„é™åˆ¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«éœ€è¦æ³¨æ„çš„.</p><h2 id="å®¹å™¨ä¸­çš„å¯è§èµ„æº">å®¹å™¨ä¸­çš„å¯è§èµ„æº</h2><p>é»˜è®¤æƒ…å†µä¸‹,ä¸ç®¡ä½ å¦‚ä½•è®¾ç½®èµ„æºé™åˆ¶,å®¹å™¨é‡Œçš„å¯è§èµ„æºéƒ½ç­‰äºèŠ‚ç‚¹èµ„æº.ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨å®¹å™¨é‡ŒæŸ¥çœ‹/proc/meminfoæ˜¾ç¤ºçš„èµ„æºå¹¶ä¸æ˜¯ä½ è®¾ç½®çš„.è¿™ä¸ªé—®é¢˜ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦.</p><p>å› ä¸ºå¾ˆå¤šç¨‹åºçš„å‚æ•°éƒ½æ˜¯æ ¹æ®å¯è§èµ„æºæ¥è®¾å®šçš„.ä¾‹å¦‚nginxçš„auto, æˆ–è€…jvmé‡Œçš„å†…å­˜å‚æ•°.</p><blockquote><p>ä» Java 8u191å¼€å§‹, jvm å·²ç»é»˜è®¤å®ç°äº†å®¹å™¨æ„ŸçŸ¥( -XX:+UseContainerSupport). å› æ­¤æ— éœ€å®‰è£…ä¸‹é¢çš„ lxcfs æ–¹æ¡ˆ.</p><p>å¹¶ä¸”, åœ¨å®¹å™¨ä¸­å»ºè®®åªè®¾ç½®å¦‚ä¸‹å†…å­˜å‚æ•°:</p><p>-XX:MaxRAMPercentage  æœ€å¤§å †å†…å­˜=ç‰©ç†å†…å­˜ç™¾åˆ†æ¯”, å»ºè®®ä¸ºå®¹å™¨é™åˆ¶çš„50%-75% . æ¯•ç«Ÿè¿˜éœ€è¦é¢„ç•™å…¶å®ƒå†…å­˜.</p></blockquote><p>è€Œç¤¾åŒºå¸¸è§çš„ä½œæ³•æ˜¯ç”¨<code>lxcfs</code> æ¥æå‡èµ„æºçš„å¯è§æ€§.<code>lxcfs</code> æ˜¯ä¸€ä¸ªå¼€æºçš„FUSEï¼ˆç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼‰å®ç°æ¥æ”¯æŒLXCå®¹å™¨, å®ƒä¹Ÿå¯ä»¥æ”¯æŒDockerå®¹å™¨.</p><p>LXCFSé€šè¿‡ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ, åœ¨å®¹å™¨ä¸­æä¾›ä¸‹åˆ— <code>procfs</code> çš„æ–‡ä»¶.</p><pre><code class="language-bash">/proc/cpuinfo/proc/diskstats/proc/meminfo/proc/stat/proc/swaps/proc/uptime</code></pre><p>ä¸æˆ‘ä»¬èµ„æºé™åˆ¶æœ‰å…³çš„, ä¸»è¦æ˜¯ cpuinfo å’Œ meminfo.</p><p>ç›®å‰ç¤¾åŒºçš„åšæ³•å¦‚ä¸‹:</p><ol><li><p>æ‰€æœ‰èŠ‚ç‚¹å®‰è£… fuse-libs åŒ….</p><pre><code class="language-bash">yum install -y fuse-libs</code></pre></li><li><p>å®‰è£…éƒ¨ç½²lxcfs</p><pre><code class="language-bash">git clone https://github.com/denverdino/lxcfs-admission-webhook.gitcd lxcfs-admission-webhookvim deployment/lxcfs-daemonset.yaml=== ä¿®æ­£é…ç½®é‡Œçš„ apiVersion=== å½“å‰gité‡Œçš„ä»£ç æ˜¯é™ˆæ—§çš„...ä»£ç é‡Œçš„ç‰ˆæœ¬åœ¨ 1.18 å·²ç»è¢«åºŸå¼ƒ). å…·ä½“å½’å±äºä»€ä¹ˆç‰ˆæœ¬, è¯·å‚è€ƒk8så®˜æ–¹apiæ–‡æ¡£ === https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#daemonset-v1-appsapiVersion:apps/v1  kubectl apply -f deployment/lxcfs-daemonset.yamlkubectl get pod#ç­‰å¾… lxcfs pod çŠ¶æ€æˆ running#å¦‚æœä½ å‘ç° pod å§‹ç»ˆå‡ºé”™ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼škubectl delete -f deployment/lxcfs-daemonset.yamlrm -rf /var/lib/lxcfskubectl apply -f deployment/lxcfs-daemonset.yamldeployment/install.shkubectl get secrets,pods,svc,mutatingwebhookconfigurations=== æŸ¥çœ‹å„ä¸ªå¯¹è±¡çŠ¶æ€</code></pre></li><li><p>ç»™ç›¸å…³namespaceæ³¨å…¥lxcfsï¼Œä¾‹å¦‚default</p><pre><code class="language-bash">kubectl label namespace default lxcfs-admission-webhook=enabled</code></pre></li><li><p>é‡å¯æ·»åŠ äº†èµ„æºé™åˆ¶çš„pod, æ­¤æ—¶ /proc/cpuinfo å’Œ /proc/meminfo å°†ä¼šæ­£ç¡®æ˜¾ç¤º.</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
            <tag> èµ„æºçº¦æŸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜09åº”ç”¨é…ç½®ä¸å¯†ç ä¸ä¿¡æ¯æä¾›</title>
      <link href="posts/4b0e4a5/"/>
      <url>posts/4b0e4a5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>kubernetes å¯ä»¥ä»¥ç¯å¢ƒå˜é‡æˆ–è€…ä»¥æ–‡ä»¶çš„æ–¹å¼æä¾›ä¿¡æ¯ç»™å®¹å™¨ã€‚è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨ secret å’Œ configmap å¯¹è±¡é‡Œã€‚</p><p>æ‰€ä»¥æ­¥éª¤ä¸€èˆ¬æ˜¯è¿™æ ·çš„ã€‚</p><ol><li>åˆ›å»ºsecret å’Œ configmap å¯¹è±¡</li></ol><h2 id="ä»¥æ–‡ä»¶æ–¹å¼æä¾›">ä»¥æ–‡ä»¶æ–¹å¼æä¾›</h2><p>kubernetes æä¾›äº†ä¸€ç§å·ç±»å‹ projected volumeã€‚</p><p>å†™æ³•ï¼š</p><pre><code class="language-yaml:">        volumeMounts:        - name: all-in-one          mountPath: /etc/allinfo          readonly: true  volumes:  - name: all-in-one    projected:      sources:      - secret:          name: user      - secret:          name: pass      - configmap:          name: content      - downwardAPI:          items:            - path: &quot;labels&quot;              fieldRef:                fieldPath: metadata.labels            - path: &quot;annotations&quot;              fieldRef:                fieldPath: metadata.annotations</code></pre><blockquote><p>user, pass, content, labels, annotations å°†ä¼šä»¥æ–‡ä»¶å½¢å¼å­˜åœ¨äºå®¹å™¨æŒ‚è½½ç‚¹ /etc/allinfo å†…ã€‚</p></blockquote><p>åˆ›å»º secret: user å’Œ secret: pass</p><pre><code class="language-bash">echo -n &quot;admin&quot; &gt; ./username.txtkubectl create secret generic user --from-file=./username.txtecho -n &quot;1f2d1e2e67df&quot; &gt; ./username.txtkubectl create secret generic pass --from-file=./password.txt</code></pre><p>åˆ›å»º configmap: content</p><pre><code class="language-bash">echo -n &quot;userinfo&quot; &gt; ./content.txtkubectl create configmap content --from-file=./content.txt</code></pre><p>downwardAPI å†…å®¹ç›´æ¥å†™å…¥</p><h2 id="é…ç½®ConfigMap">é…ç½®ConfigMap</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/configmap/">https://kubernetes.io/docs/concepts/configuration/configmap/</a></p><p>ConfigMap å¸¸ç”¨åœ¨ä¸¤ç§æƒ…å†µä¸­. ç¬¬ä¸€ç§æ˜¯æä¾›ç¯å¢ƒå˜é‡.ç¬¬äºŒç§æ˜¯æä¾›é…ç½®æ–‡ä»¶</p><p>ä¸€ä¸ªç®€å•é…ç½®ä¾‹å­å¦‚ä¸‹</p><pre><code class="language-yaml">kind: ConfigMapapiVersion: v1metadata:  name: cm-demo  namespace: defaultdata:  data.1: hello  data.2: world  nginx.conf: |    property.1=value-1    property.2=value-2    property.3=value-3</code></pre><p>ä¸Šè¿°ä¾‹å­ä¸­, åŒ…å«çš„å†…å®¹æœ‰</p><p>ç¯å¢ƒå˜é‡æ–¹å¼:</p><pre><code class="language-yaml">  data.1: hello  data.2: world</code></pre><p>é…ç½®æ–‡ä»¶æ–¹å¼:</p><pre><code class="language-yaml">  nginx.conf: |    property.1=value-1    property.2=value-2    property.3=value-3</code></pre><p>nginx.config æ˜¯æ–‡ä»¶å, ç®¡é“ç¬¦ | ä¸‹é¢æ˜¯æ–‡ä»¶å†…å®¹.</p><p>éœ€è¦æ³¨æ„çš„æ˜¯, å†…å®¹ä¾ç„¶è¦éµå¾ª yaml çš„ç¼©è¿›è§„åˆ™</p><p>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:</p><pre><code class="language-yaml">    spec:      containers:      - name: nginx        image: nginx        command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo $&#123;DATA.1&#125; $&#123;DATA.2&#125;&quot;]        ports:        - containerPort: 80        env:        - name: DATA1          valueFrom:            configMapKeyRef:              name: cm-demo-vc              key: data.1        - name: DATA2          valueFrom:            configMapKeyRef:              name: cm-demo-vc              key: data.2        volumeMounts:        - name: cm-demo-vc          subPath: nginx.conf          mountPath: /etc/nginx/nginx.conf      volumes:      - name: cm-demo-vc        configMap:          name: cm-demo</code></pre><p>é…ç½®æ–‡ä»¶æ•°æ®å·æ–¹å¼:</p><ul><li>é€šè¿‡åœ¨ spec.volumes ä¸­å®šä¹‰ä¸€ä¸ªå…³è”å£°æ˜(cm.demo-vc). å®ƒä¸€ç«¯è¢« spec.containers.volumeMounts è°ƒç”¨, å¦ä¸€ç«¯å…³è” configMap. ç„¶åé€šè¿‡ spec.containers.volumeMounts ç»‘å®š configMap å, å°±å¯ä»¥ä½¿ç”¨ subPath è°ƒç”¨é…ç½®æ–‡ä»¶, å¹¶ä½¿ç”¨ mountPath æŒ‚è½½åˆ°å®¹å™¨é‡Œçš„å…·ä½“è·¯å¾„ä¸Š.</li><li>è¿™ç§æ–¹å¼ä¸‹,configMapæ›´æ–°å,podå†…æŒ‚è½½çš„ä¹Ÿä¼šåŒæ—¶æ›´æ–°.</li></ul><p>ç¯å¢ƒå˜é‡æ–¹å¼:</p><ul><li>é€šè¿‡åœ¨ spec.containers.env ä¸­å®šä¹‰. ä¾‹å­ä¸­, DATA1 æ˜¯ç¯å¢ƒå˜é‡çš„é”®, DATA1çš„å€¼é€šè¿‡valueFromå®šä¹‰.æœ€ç»ˆ,ä½ å¯ä»¥åœ¨å®¹å™¨ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡DATA1å’ŒDATA2</li></ul><h2 id="å¯†ç Secret">å¯†ç Secret</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/secret/">https://kubernetes.io/docs/concepts/configuration/secret/</a></p><p>secretå¯¹è±¡é‡Œçš„å€¼éœ€è¦å†™å…¥åŠ å¯†åçš„.</p><p>secretå¯¹è±¡ä¹Ÿå¯ä»¥è¢«å½“ä½œæ–‡ä»¶æŒ‚è½½æˆ–ç¯å¢ƒå˜é‡æ³¨å…¥</p><p>ä¸€ä¸ªç®€å•ä¾‹å­:</p><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç”¨æˆ·å¯†ç å¯¹,åˆ†åˆ«æ—¶usernameå’Œpassword</p><p>secretå¯¹è±¡è¦æ±‚å€¼å¿…é¡»è¿›è¡Œbase64ç¼–ç åŠ å¯†(å½“typeä¸ºOpaqueçš„æ—¶å€™).</p><pre><code class="language-bash">[root@k8s00 test-yaml]# echo -n &quot;admin&quot; | base64YWRtaW4=[root@k8s00 test-yaml]# echo -n &quot;admin321&quot; | base64YWRtaW4zMjE=</code></pre><pre><code class="language-yaml"># åˆ›å»º secret å¯¹è±¡ mysecretapiVersion: v1kind: Secretmetadata:  name: mysecret  namespace: defaulttype: Opaquedata:  username: YWRtaW4=  password: MWYyZDFlMmU2N2Rm---apiVersion: v1kind: Podmetadata:  name: mypodspec:  containers:  - name: mypod    image: busybox    command:    - sleep    - &quot;3600&quot;    env:      - name: SECRET_USERNAME        valueFrom:          secretKeyRef:            name: mysecret            key: username      - name: SECRET_PASSWORD        valueFrom:          secretKeyRef:            name: mysecret            key: password    volumeMounts:    - name: foo      mountPath: &quot;/etc/foo&quot;      readOnly: true  volumes:  - name: foo    secret:      secretName: mysecret</code></pre><p>åœ¨é€šè¿‡ä¸Šè¿°é…ç½®åˆ›å»ºå¥½èµ„æºå,æˆ‘ä»¬è¿›å…¥pod,è¿›è¡Œæµ‹è¯•.</p><pre><code class="language-bash">[root@k8s00 test-yaml]# kubectl exec -it mypod -- /bin/sh===å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªåŠ å¯†ä¿¡æ¯ç”Ÿæˆäº†ä¸¤ä¸ªè½¯è¿æ¥,å¹¶æŒ‡å‘äº†éšè—æ–‡ä»¶/ # ls -l /etc/foototal 0lrwxrwxrwx    1 root     root            15 Sep 17 07:18 password -&gt; ..data/passwordlrwxrwxrwx    1 root     root            15 Sep 17 07:18 username -&gt; ..data/username===ç¯å¢ƒå˜é‡/ # echo $&#123;SECRET_USERNAME&#125;admin===æ–‡ä»¶æ–¹å¼/ # cat /etc/foo/usernameadmin/ # </code></pre><h2 id="é™åˆ¶">é™åˆ¶</h2><ul><li>æœºå¯†èµ„æºé™åˆ¶åœ¨åŒä¸€å‘½åç©ºé—´</li><li>æ•°æ®å¤§å°ä¸èƒ½è¶…è¿‡1MB</li><li>å½“podå¼•ç”¨ä¸å­˜åœ¨çš„æœºå¯†æ—¶,podæ— æ³•å¯åŠ¨</li></ul><h2 id="å…¶å®ƒ">å…¶å®ƒ</h2><ol><li><p>ä¸å¯å˜çš„æœºå¯†(k8s v1.19ä»¥ä¸Š)</p><pre><code class="language-yaml">secret.immutable: true</code></pre><p>è¿™ç§æ–¹å¼ç”¨æ¥æ„å»ºæ°¸ä¹…ä¸å¯å˜çš„å¯†ç ,ä¸”æ„å»ºåæ— æ³•æ›´æ”¹,ä¸”æ„å»ºåä½¿ç”¨å®ƒçš„podä¹Ÿæ— æ³•å¸è½½æ‰å®ƒ.</p><p>å› æ­¤,ä¸€æ—¦æ„å»ºåæƒ³æ›´æ”¹,åˆ™å®ƒå’Œå®ƒå…³è”çš„podéƒ½è¦åˆ é™¤é‡å»º.</p><p>ä¼˜ç‚¹:</p><ul><li>é¿å…é”™è¯¯çš„æ›´æ–°</li><li>æ˜¾è‘—æé«˜é›†ç¾¤æ€§èƒ½</li></ul></li><li><p>å‘½ä»¤æ–¹å¼åˆ›å»º</p><p>kubectl create configmap/secret <name> xxx</name></p><p>è¿™é‡Œxxxå¯ä»¥ç”¨ä¸¤ç§æ–¹å¼:</p><ul><li>â€“from-literal=<key>=<value> æŒ‡å®škv</value></key></li><li>â€“from-file=&lt;æ–‡ä»¶/ç›®å½•&gt; å½“ä¸ºç›®å½•çš„æ—¶å€™,ä¼šé€’å½’å°†ç›®å½•é‡Œçš„æ–‡ä»¶éƒ½å†™å…¥å¯¹è±¡ä¸­</li></ul></li><li><p>éšè—çš„å¯†ç ä¿¡æ¯æ–‡ä»¶</p><p>ä½ å¯ä»¥å°† secret.data.<key> å†™æˆ secret.data.&lt;.key&gt; æ¥éšè—å®ƒ.</key></p></li></ol><h2 id="ä¿¡æ¯æä¾›Downward-API">ä¿¡æ¯æä¾›Downward API</h2><p><a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/">https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/</a></p><p>ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨Downward APIä¼ é€’ä¿¡æ¯åˆ°å®¹å™¨. ç„¶åç¨‹åºæ ¹æ®ä¿¡æ¯æ¥è®¾ç½®.</p><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­: å°†èµ„æºé™åˆ¶æ•°æ®æŒ‚è½½åˆ°å®¹å™¨/etc/podinfo</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: kubernetes-downwardapi-volume-example-2spec:  containers:    - name: client-container      image: k8s.gcr.io/busybox:1.24      command: [&quot;sh&quot;, &quot;-c&quot;]      args:      - while true; do          echo -en '\n';          if [[ -e /etc/podinfo/cpu_limit ]]; then            echo -en '\n'; cat /etc/podinfo/cpu_limit; fi;          if [[ -e /etc/podinfo/cpu_request ]]; then            echo -en '\n'; cat /etc/podinfo/cpu_request; fi;          if [[ -e /etc/podinfo/mem_limit ]]; then            echo -en '\n'; cat /etc/podinfo/mem_limit; fi;          if [[ -e /etc/podinfo/mem_request ]]; then            echo -en '\n'; cat /etc/podinfo/mem_request; fi;          sleep 5;        done;      resources:        requests:          memory: &quot;32Mi&quot;          cpu: &quot;125m&quot;        limits:          memory: &quot;64Mi&quot;          cpu: &quot;250m&quot;      volumeMounts:        - name: podinfo          mountPath: /etc/podinfo  volumes:    - name: podinfo      downwardAPI:        items:          - path: &quot;cpu_limit&quot;            resourceFieldRef:              containerName: client-container              resource: limits.cpu              divisor: 1m          - path: &quot;cpu_request&quot;            resourceFieldRef:              containerName: client-container              resource: requests.cpu              divisor: 1m          - path: &quot;mem_limit&quot;            resourceFieldRef:              containerName: client-container              resource: limits.memory              divisor: 1Mi          - path: &quot;mem_request&quot;            resourceFieldRef:              containerName: client-container              resource: requests.memory              divisor: 1Mi</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> ConfigMap </tag>
            
            <tag> Secret </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜10åº”ç”¨é…ç½®ä¸å¯†ç ä¸ä¿¡æ¯æä¾›</title>
      <link href="posts/4b0e4a5/"/>
      <url>posts/4b0e4a5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>kubernetes å¯ä»¥ä»¥ç¯å¢ƒå˜é‡æˆ–è€…ä»¥æ–‡ä»¶çš„æ–¹å¼æä¾›ä¿¡æ¯ç»™å®¹å™¨ã€‚è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨ secret å’Œ configmap å¯¹è±¡é‡Œã€‚</p><p>æ‰€ä»¥æ­¥éª¤ä¸€èˆ¬æ˜¯è¿™æ ·çš„ã€‚</p><ol><li>åˆ›å»ºsecret å’Œ configmap å¯¹è±¡</li></ol><h2 id="ä»¥æ–‡ä»¶æ–¹å¼æä¾›">ä»¥æ–‡ä»¶æ–¹å¼æä¾›</h2><p>kubernetes æä¾›äº†ä¸€ç§å·ç±»å‹ projected volumeã€‚</p><p>å†™æ³•ï¼š</p><pre><code class="language-yaml:">        volumeMounts:        - name: all-in-one          mountPath: /etc/allinfo          readonly: true  volumes:  - name: all-in-one    projected:      sources:      - secret:          name: user      - secret:          name: pass      - configmap:          name: content      - downwardAPI:          items:            - path: &quot;labels&quot;              fieldRef:                fieldPath: metadata.labels            - path: &quot;annotations&quot;              fieldRef:                fieldPath: metadata.annotations</code></pre><blockquote><p>user, pass, content, labels, annotations å°†ä¼šä»¥æ–‡ä»¶å½¢å¼å­˜åœ¨äºå®¹å™¨æŒ‚è½½ç‚¹ /etc/allinfo å†…ã€‚</p></blockquote><p>åˆ›å»º secret: user å’Œ secret: pass</p><pre><code class="language-bash">echo -n &quot;admin&quot; &gt; ./username.txtkubectl create secret generic user --from-file=./username.txtecho -n &quot;1f2d1e2e67df&quot; &gt; ./username.txtkubectl create secret generic pass --from-file=./password.txt</code></pre><p>åˆ›å»º configmap: content</p><pre><code class="language-bash">echo -n &quot;userinfo&quot; &gt; ./content.txtkubectl create configmap content --from-file=./content.txt</code></pre><p>downwardAPI å†…å®¹ç›´æ¥å†™å…¥</p><h2 id="é…ç½®ConfigMap">é…ç½®ConfigMap</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/configmap/">https://kubernetes.io/docs/concepts/configuration/configmap/</a></p><p>ConfigMap å¸¸ç”¨åœ¨ä¸¤ç§æƒ…å†µä¸­. ç¬¬ä¸€ç§æ˜¯æä¾›ç¯å¢ƒå˜é‡.ç¬¬äºŒç§æ˜¯æä¾›é…ç½®æ–‡ä»¶</p><p>ä¸€ä¸ªç®€å•é…ç½®ä¾‹å­å¦‚ä¸‹</p><pre><code class="language-yaml">kind: ConfigMapapiVersion: v1metadata:  name: cm-demo  namespace: defaultdata:  data.1: hello  data.2: world  nginx.conf: |    property.1=value-1    property.2=value-2    property.3=value-3</code></pre><p>ä¸Šè¿°ä¾‹å­ä¸­, åŒ…å«çš„å†…å®¹æœ‰</p><p>ç¯å¢ƒå˜é‡æ–¹å¼:</p><pre><code class="language-yaml">  data.1: hello  data.2: world</code></pre><p>é…ç½®æ–‡ä»¶æ–¹å¼:</p><pre><code class="language-yaml">  nginx.conf: |    property.1=value-1    property.2=value-2    property.3=value-3</code></pre><p>nginx.config æ˜¯æ–‡ä»¶å, ç®¡é“ç¬¦ | ä¸‹é¢æ˜¯æ–‡ä»¶å†…å®¹.</p><p>éœ€è¦æ³¨æ„çš„æ˜¯, å†…å®¹ä¾ç„¶è¦éµå¾ª yaml çš„ç¼©è¿›è§„åˆ™</p><p>ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:</p><pre><code class="language-yaml">    spec:      containers:      - name: nginx        image: nginx        command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo $&#123;DATA.1&#125; $&#123;DATA.2&#125;&quot;]        ports:        - containerPort: 80        env:        - name: DATA1          valueFrom:            configMapKeyRef:              name: cm-demo-vc              key: data.1        - name: DATA2          valueFrom:            configMapKeyRef:              name: cm-demo-vc              key: data.2        volumeMounts:        - name: cm-demo-vc          subPath: nginx.conf          mountPath: /etc/nginx/nginx.conf      volumes:      - name: cm-demo-vc        configMap:          name: cm-demo</code></pre><p>é…ç½®æ–‡ä»¶æ•°æ®å·æ–¹å¼:</p><ul><li>é€šè¿‡åœ¨ spec.volumes ä¸­å®šä¹‰ä¸€ä¸ªå…³è”å£°æ˜(cm.demo-vc). å®ƒä¸€ç«¯è¢« spec.containers.volumeMounts è°ƒç”¨, å¦ä¸€ç«¯å…³è” configMap. ç„¶åé€šè¿‡ spec.containers.volumeMounts ç»‘å®š configMap å, å°±å¯ä»¥ä½¿ç”¨ subPath è°ƒç”¨é…ç½®æ–‡ä»¶, å¹¶ä½¿ç”¨ mountPath æŒ‚è½½åˆ°å®¹å™¨é‡Œçš„å…·ä½“è·¯å¾„ä¸Š.</li><li>è¿™ç§æ–¹å¼ä¸‹,configMapæ›´æ–°å,podå†…æŒ‚è½½çš„ä¹Ÿä¼šåŒæ—¶æ›´æ–°.</li></ul><p>ç¯å¢ƒå˜é‡æ–¹å¼:</p><ul><li>é€šè¿‡åœ¨ spec.containers.env ä¸­å®šä¹‰. ä¾‹å­ä¸­, DATA1 æ˜¯ç¯å¢ƒå˜é‡çš„é”®, DATA1çš„å€¼é€šè¿‡valueFromå®šä¹‰.æœ€ç»ˆ,ä½ å¯ä»¥åœ¨å®¹å™¨ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡DATA1å’ŒDATA2</li></ul><h2 id="å¯†ç Secret">å¯†ç Secret</h2><p><a href="https://kubernetes.io/docs/concepts/configuration/secret/">https://kubernetes.io/docs/concepts/configuration/secret/</a></p><p>secretå¯¹è±¡é‡Œçš„å€¼éœ€è¦å†™å…¥åŠ å¯†åçš„.</p><p>secretå¯¹è±¡ä¹Ÿå¯ä»¥è¢«å½“ä½œæ–‡ä»¶æŒ‚è½½æˆ–ç¯å¢ƒå˜é‡æ³¨å…¥</p><p>ä¸€ä¸ªç®€å•ä¾‹å­:</p><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç”¨æˆ·å¯†ç å¯¹,åˆ†åˆ«æ—¶usernameå’Œpassword</p><p>secretå¯¹è±¡è¦æ±‚å€¼å¿…é¡»è¿›è¡Œbase64ç¼–ç åŠ å¯†(å½“typeä¸ºOpaqueçš„æ—¶å€™).</p><pre><code class="language-bash">[root@k8s00 test-yaml]# echo -n &quot;admin&quot; | base64YWRtaW4=[root@k8s00 test-yaml]# echo -n &quot;admin321&quot; | base64YWRtaW4zMjE=</code></pre><pre><code class="language-yaml"># åˆ›å»º secret å¯¹è±¡ mysecretapiVersion: v1kind: Secretmetadata:  name: mysecret  namespace: defaulttype: Opaquedata:  username: YWRtaW4=  password: MWYyZDFlMmU2N2Rm---apiVersion: v1kind: Podmetadata:  name: mypodspec:  containers:  - name: mypod    image: busybox    command:    - sleep    - &quot;3600&quot;    env:      - name: SECRET_USERNAME        valueFrom:          secretKeyRef:            name: mysecret            key: username      - name: SECRET_PASSWORD        valueFrom:          secretKeyRef:            name: mysecret            key: password    volumeMounts:    - name: foo      mountPath: &quot;/etc/foo&quot;      readOnly: true  volumes:  - name: foo    secret:      secretName: mysecret</code></pre><p>åœ¨é€šè¿‡ä¸Šè¿°é…ç½®åˆ›å»ºå¥½èµ„æºå,æˆ‘ä»¬è¿›å…¥pod,è¿›è¡Œæµ‹è¯•.</p><pre><code class="language-bash">[root@k8s00 test-yaml]# kubectl exec -it mypod -- /bin/sh===å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªåŠ å¯†ä¿¡æ¯ç”Ÿæˆäº†ä¸¤ä¸ªè½¯è¿æ¥,å¹¶æŒ‡å‘äº†éšè—æ–‡ä»¶/ # ls -l /etc/foototal 0lrwxrwxrwx    1 root     root            15 Sep 17 07:18 password -&gt; ..data/passwordlrwxrwxrwx    1 root     root            15 Sep 17 07:18 username -&gt; ..data/username===ç¯å¢ƒå˜é‡/ # echo $&#123;SECRET_USERNAME&#125;admin===æ–‡ä»¶æ–¹å¼/ # cat /etc/foo/usernameadmin/ # </code></pre><h2 id="é™åˆ¶">é™åˆ¶</h2><ul><li>æœºå¯†èµ„æºé™åˆ¶åœ¨åŒä¸€å‘½åç©ºé—´</li><li>æ•°æ®å¤§å°ä¸èƒ½è¶…è¿‡1MB</li><li>å½“podå¼•ç”¨ä¸å­˜åœ¨çš„æœºå¯†æ—¶,podæ— æ³•å¯åŠ¨</li></ul><h2 id="å…¶å®ƒ">å…¶å®ƒ</h2><ol><li><p>ä¸å¯å˜çš„æœºå¯†(k8s v1.19ä»¥ä¸Š)</p><pre><code class="language-yaml">secret.immutable: true</code></pre><p>è¿™ç§æ–¹å¼ç”¨æ¥æ„å»ºæ°¸ä¹…ä¸å¯å˜çš„å¯†ç ,ä¸”æ„å»ºåæ— æ³•æ›´æ”¹,ä¸”æ„å»ºåä½¿ç”¨å®ƒçš„podä¹Ÿæ— æ³•å¸è½½æ‰å®ƒ.</p><p>å› æ­¤,ä¸€æ—¦æ„å»ºåæƒ³æ›´æ”¹,åˆ™å®ƒå’Œå®ƒå…³è”çš„podéƒ½è¦åˆ é™¤é‡å»º.</p><p>ä¼˜ç‚¹:</p><ul><li>é¿å…é”™è¯¯çš„æ›´æ–°</li><li>æ˜¾è‘—æé«˜é›†ç¾¤æ€§èƒ½</li></ul></li><li><p>å‘½ä»¤æ–¹å¼åˆ›å»º</p><p>kubectl create configmap/secret <name> xxx</name></p><p>è¿™é‡Œxxxå¯ä»¥ç”¨ä¸¤ç§æ–¹å¼:</p><ul><li>â€“from-literal=<key>=<value> æŒ‡å®škv</value></key></li><li>â€“from-file=&lt;æ–‡ä»¶/ç›®å½•&gt; å½“ä¸ºç›®å½•çš„æ—¶å€™,ä¼šé€’å½’å°†ç›®å½•é‡Œçš„æ–‡ä»¶éƒ½å†™å…¥å¯¹è±¡ä¸­</li></ul></li><li><p>éšè—çš„å¯†ç ä¿¡æ¯æ–‡ä»¶</p><p>ä½ å¯ä»¥å°† secret.data.<key> å†™æˆ secret.data.&lt;.key&gt; æ¥éšè—å®ƒ.</key></p></li></ol><h2 id="ä¿¡æ¯æä¾›Downward-API">ä¿¡æ¯æä¾›Downward API</h2><p><a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/">https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/</a></p><p>ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨Downward APIä¼ é€’ä¿¡æ¯åˆ°å®¹å™¨. ç„¶åç¨‹åºæ ¹æ®ä¿¡æ¯æ¥è®¾ç½®.</p><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­: å°†èµ„æºé™åˆ¶æ•°æ®æŒ‚è½½åˆ°å®¹å™¨/etc/podinfo</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: kubernetes-downwardapi-volume-example-2spec:  containers:    - name: client-container      image: k8s.gcr.io/busybox:1.24      command: [&quot;sh&quot;, &quot;-c&quot;]      args:      - while true; do          echo -en '\n';          if [[ -e /etc/podinfo/cpu_limit ]]; then            echo -en '\n'; cat /etc/podinfo/cpu_limit; fi;          if [[ -e /etc/podinfo/cpu_request ]]; then            echo -en '\n'; cat /etc/podinfo/cpu_request; fi;          if [[ -e /etc/podinfo/mem_limit ]]; then            echo -en '\n'; cat /etc/podinfo/mem_limit; fi;          if [[ -e /etc/podinfo/mem_request ]]; then            echo -en '\n'; cat /etc/podinfo/mem_request; fi;          sleep 5;        done;      resources:        requests:          memory: &quot;32Mi&quot;          cpu: &quot;125m&quot;        limits:          memory: &quot;64Mi&quot;          cpu: &quot;250m&quot;      volumeMounts:        - name: podinfo          mountPath: /etc/podinfo  volumes:    - name: podinfo      downwardAPI:        items:          - path: &quot;cpu_limit&quot;            resourceFieldRef:              containerName: client-container              resource: limits.cpu              divisor: 1m          - path: &quot;cpu_request&quot;            resourceFieldRef:              containerName: client-container              resource: requests.cpu              divisor: 1m          - path: &quot;mem_limit&quot;            resourceFieldRef:              containerName: client-container              resource: limits.memory              divisor: 1Mi          - path: &quot;mem_request&quot;            resourceFieldRef:              containerName: client-container              resource: requests.memory              divisor: 1Mi</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> ConfigMap </tag>
            
            <tag> Secret </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜08è´Ÿè½½å‡è¡¡service</title>
      <link href="posts/d3b80b5f/"/>
      <url>posts/d3b80b5f/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨å®é™…ä¸šåŠ¡ä¸­,å› ä¸šåŠ¡å‹åŠ›é—®é¢˜,ç»å¸¸ä¼šæœ‰å¤šä¸ªåç«¯æœåŠ¡å‰¯æœ¬,å®ƒä»¬å…±åŒæ‰¿æ‹…è¯·æ±‚.æˆ‘ä»¬ä½¿ç”¨äº‘æœåŠ¡çš„æ—¶å€™,å¯ä»¥è´­ä¹°é˜¿é‡Œäº‘çš„slbæˆ–è€…awsçš„elb/albç­‰è´Ÿè½½å‡è¡¡å™¨å‘è¿™äº›åç«¯å‰¯æœ¬åˆ†å‘æµé‡. å¹¶é€šè¿‡è¿™äº›è´Ÿè½½å‡è¡¡å‘å…¬ç½‘æš´æ¼å†…ç½‘è¿™äº›åç«¯ç¨‹åº.</p><p>k8sè®¾è®¡äº†ä¸€ä¸ªserviceå¯¹è±¡æ¥å®ç°è¿™ä¸€ç›®çš„.</p><h2 id="k8sIP">k8sIP</h2><p>åœ¨æServiceå¯¹è±¡ä¹‹å‰,éœ€è¦å…ˆçŸ¥é“k8sä¸­å­˜åœ¨çš„ä¸‰ç§IP.å³ NodeIP, ClusterIP, PodIP</p><p>NodeIP å°±æ˜¯ç‰©ç†èŠ‚ç‚¹ip, è¿™ä¸ªæ²¡å¾—è¯´, ç©å®¶è‡ªå·±å®šä¹‰</p><p>ClusterIP æ˜¯k8sçš„ä¸€ä¸ªè™šæ‹Ÿip, æœ¬èº«æ²¡æœ‰ä»»ä½•å®ä½“, ä¹Ÿå°±æ˜¯VIP</p><p>PodIP æ˜¯å®¹å™¨å…±äº«çš„ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´å¯¹åº”çš„ip, ä¸€ä¸ªpodé‡Œçš„å®¹å™¨å…±ç”¨.</p><h2 id="Service">Service</h2><p><a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">https://kubernetes.io/zh/docs/concepts/services-networking/service/</a></p><p>Serviceå¯¹è±¡é€šè¿‡servicespec.typeæ¥è®¾å®šç±»å‹, å…±è®¡4ä¸ªç±»å‹: ClusterIP, NodePort, LoadBalancer, ExternalName. è¿™å››ä¸ªç±»å‹å¯ä»¥åˆ†ä¸ºä¸¤ç±»</p><ul><li>åˆ›å»ºServiceå¯¹è±¡ä¾›é›†ç¾¤å†…éƒ¨è®¿é—®</li></ul><p>ClusterIP(é»˜è®¤ç±»å‹): åå‘ä»£ç†é›†ç¾¤å†…çš„pod. ä¾›é›†ç¾¤å†…å…¶å®ƒæœåŠ¡è®¿é—®. æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å†…éƒ¨å…¶å®ƒæœåŠ¡=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><pre><code class="language-yaml">apiVersion: v1kind: Servicemetadata:  name: myservicespec:  selector:    app: myapp  ports:  - protocol: TCP    port: 80    targetPort: 8080    name: myapp-http</code></pre><blockquote><p>ä¸Šè¿°ä¾‹å­ä¸­, é›†ç¾¤å†…éƒ¨è®¿é—®myservice.defaultçš„æ—¶å€™,æ­¤æ—¶ä¼šè®¿é—®åˆ°app=myappçš„pod</p><p>è¿™é‡Œportæ˜¯Serviceæš´éœ²ç«¯å£, targetPortæ˜¯podæš´éœ²ç«¯å£. é»˜è®¤æƒ…å†µä¸‹, targetPortå°†ç­‰äºport</p><p>spec.typeæ²¡æœ‰å®šä¹‰æ˜¯å› ä¸ºClusterIPæ˜¯Serviceå¯¹è±¡çš„é»˜è®¤ç±»å‹</p></blockquote><p>ExternalName: æ„å»ºä¸€ä¸ªCNAMEè§£æ(serviceå¯¹è±¡-CNAME-å…¶å®ƒåŸŸå).  æˆ‘èƒ½æƒ³åˆ°çš„ä¸»è¦æ˜¯è®©é›†ç¾¤å†…éƒ¨æœåŠ¡å¯ä»¥è®¿é—®åˆ°é›†ç¾¤å¤–éƒ¨æœåŠ¡.</p><p>ä¾‹å¦‚:</p><pre><code class="language-yaml">kind: ServiceapiVersion: v1metadata:  name: my-service  namespace: prodspec:  type: ExternalName  externalName: my.database.example.com</code></pre><blockquote><p>é›†ç¾¤å†…éƒ¨è®¿é—®my-service.prodçš„æ—¶å€™, <a href="http://xn--k8sdnsmy-vq8m536awioci6an95by58d3far6b.database.example.com">å°†é€šè¿‡k8sçš„dnsæœåŠ¡è¿”å›my.database.example.com</a></p></blockquote><ul><li>ä¾›é›†ç¾¤å¤–éƒ¨è®¿é—®</li></ul><p>NodePort: åå‘ä»£ç†é›†ç¾¤å†…çš„pod(ä½¿ç”¨NATåœ¨æ¯ä¸€ä¸ªé›†ç¾¤nodeä¸Šçš„ç›¸åŒç«¯å£ä¸Šå…¬å¼€Service, æ˜¯ClusterIPç±»å‹çš„è¶…é›†). ä¾›é›†ç¾¤å¤–æœåŠ¡è®¿é—®. æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å¤–=&gt;ä»»æ„èŠ‚ç‚¹ip:ç«¯å£=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><pre><code class="language-yaml">apiVersion: v1kind: Servicemetadata:  name: myservicespec:  selector:    app: myapp  type: NodePort  ports:  - protocol: TCP    nodePort: 31000    port: 80    targetPort: 80    name: myapp-http</code></pre><blockquote><p>é›†ç¾¤å¤–éƒ¨æ­¤æ—¶å¯ä»¥è®¿é—®ä»»æ„ç‰©ç†èŠ‚ç‚¹ip:31000, æ­¤æ—¶å¯ä»¥è®¿é—®åˆ°é›†ç¾¤å†…éƒ¨app=myappçš„pod.</p><p>è¿™é‡ŒnodePortæ˜¯ç‰©ç†èŠ‚ç‚¹æš´éœ²ç«¯å£, portæ˜¯Serviceæš´éœ²ç«¯å£, targetPortæ˜¯podæš´éœ²ç«¯å£.</p><p>nodePortå¯ä»¥ä¸å®šä¹‰, åˆ™æ­¤æ—¶ä¼šè‡ªåŠ¨ä»30000-32767éšæœºåˆ†é….</p></blockquote><p>LoadBalancer: å¯¹æ¥äº‘å•†çš„è´Ÿè½½å‡è¡¡æœåŠ¡, ç»™Serviceåˆ†é…ä¸€ä¸ªå›ºå®šIP. æ–¹ä¾¿äº‘æœåŠ¡å•†çš„LBæœåŠ¡ç»‘å®š. (æ˜¯NodePortç±»å‹çš„è¶…é›†). æµé‡è¿‡ç¨‹æ˜¯: é›†ç¾¤å¤–=&gt;äº‘æœåŠ¡LB=&gt;ä»»æ„ç‰©ç†èŠ‚ç‚¹ip:ç«¯å£=&gt;ClusterIP:ç«¯å£=&gt;Pod</p><p>è¿™ç§ç±»å‹å»ºè®®ç›´æ¥å‚è€ƒå®˜æ–¹æ–‡æ¡£: <a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer">https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer</a></p><h2 id="Headless-Service">Headless Service</h2><p>è¿™æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡, ä»é…ç½®ä¸Šæ¥çœ‹,å®ƒå’ŒClusterIPç±»å‹çš„åŒºåˆ«å°±æ˜¯<code>service.spec.clusterIP: None</code>.</p><p>å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹:</p><ul><li>ç»“åˆStatefulSetå¯¹è±¡ä½¿ç”¨, ä»è€Œåˆ›å»ºä¸€è¿ä¸²åç§°æœ‰åºçš„æœ‰çŠ¶æ€åº”ç”¨å‰¯æœ¬.</li><li>podæ‹¥æœ‰æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å”¯ä¸€ä¸”ä¸å˜çš„åŸŸå. å› æ­¤ pod ä¹‹é—´å¯ä»¥é€šè¿‡åŸŸåè®¿é—®.å®ƒçš„æ ¼å¼åº”è¯¥æ˜¯è¿™æ ·çš„:<code>&lt;podname&gt;-&lt;index&gt;.&lt;svcname&gt;.&lt;nsname&gt;.svc.cluster.local</code></li></ul><p>ä¸€ä¸ªå…³äºzké›†ç¾¤æ„å»ºçš„k8så®˜æ–¹ä¾‹å­: <a href="https://kubernetes.io/docs/tutorials/stateful-application/zookeeper/">https://kubernetes.io/docs/tutorials/stateful-application/zookeeper/</a></p><h2 id="ç²˜æ€§ä¼šè¯">ç²˜æ€§ä¼šè¯</h2><p>æœ‰äº›æ—¶å€™,æˆ‘ä»¬éœ€è¦ä¼šè¯é»æ€§,ä½ å¯ä»¥é€šè¿‡service.spec.sessionAffinity=ClientIPæ¥è®¾ç½®.å¹¶åŒæ—¶å¯ä»¥é€šè¿‡service.spec.sessionAffinityConfig.clientIP.timeoutSecondsæ¥è®¾ç½®ä¼šè¯ä¿æŒæ—¶é—´,å®ƒé»˜è®¤æ˜¯3å°æ—¶.</p><h2 id="å¤šç«¯å£">å¤šç«¯å£</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/#multi-port-services">https://kubernetes.io/docs/concepts/services-networking/service/#multi-port-services</a></p><p>æœ‰äº›æ—¶å€™,æŸä¸ªæœåŠ¡å¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªç«¯å£,ä¾‹å¦‚webæœåŠ¡,ä¼šåŒæ—¶æœ‰80å’Œ443.è¿™ç§æƒ…å†µä¸‹ä½ éœ€è¦é’ˆå¯¹ä¸¤ä¸ªç«¯å£åˆ†åˆ«è®¾å®šä¸€ä¸ªç«¯å£åç§°.å³ <a href="http://service.spec.ports.name">service.spec.ports.name</a></p><h2 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables">https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables</a></p><p>å½“serviceåˆ›å»ºçš„æ—¶å€™,kubeletä¼šç”Ÿæˆä¸€æ‰¹ç¯å¢ƒå˜é‡.ä½ å¯ä»¥åœ¨å…¶å®ƒpodä¸­ä½¿ç”¨è¿™äº›ç¯å¢ƒå˜é‡è®¿é—®service.ä¸è¿‡å‰ææ˜¯serviceå¯¹è±¡å¿…é¡»æå‰åˆ›å»º.</p><p>ä¸è¿‡,æˆ‘è§‰å¾—ä¸€èˆ¬æ¥è¯´,æœ‰dnsæ–¹å¼,éƒ½ä¼šé€šè¿‡dnså»è®¿é—®.è€Œä¸”dnsä¹Ÿæ²¡æœ‰å…ˆåˆ›å»ºserviceè¿™ä¸€ä¸ªé™åˆ¶.</p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> service </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜07æ— çŠ¶æ€æœåŠ¡deployment-podæ‰©ç¼©</title>
      <link href="posts/f6e328b5/"/>
      <url>posts/f6e328b5/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>k8sçš„podç¼©æ”¾åŠŸèƒ½,å’Œawsçš„auto scalingåŠŸèƒ½æ˜¯ä¸€å›äº‹.è™½ç„¶å¯èƒ½æ²¡æœ‰awsçš„auto scalingåŠŸèƒ½å¼ºå¤§.</p><p>k8sçš„podç¼©æ”¾åŠŸèƒ½ç§°ä¹‹ä¸ºHPA(Horizontal Pod Autoscaler),å®ƒå¯ä»¥åŸºäºè®¾å®šçš„cpué˜ˆå€¼,æ¥è‡ªåŠ¨è°ƒæ•´deploymentä¸­çš„podæ•°é‡.</p><h2 id="metrics-server">metrics-server</h2><p><a href="https://github.com/kubernetes-sigs/metrics-server">https://github.com/kubernetes-sigs/metrics-server</a></p><p>metrics æœåŠ¡å™¨å¯ä»¥é€šè¿‡èµ„æºåº¦é‡å€¼ API å¯¹å¤–æä¾›åº¦é‡æ•°æ®ï¼ŒHorizontal Pod Autoscaler æ­£æ˜¯æ ¹æ®æ­¤ API æ¥è·å–åº¦é‡æ•°æ®.å¦‚æœæ²¡æœ‰æ­¤æœåŠ¡,HPAå°†æ— æ³•å·¥ä½œ.</p><pre><code class="language-bash">wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.7/components.yaml</code></pre><p>é»˜è®¤ metrics-server çš„ deployment æ— æ³•ç›´æ¥ä½¿ç”¨, æˆ‘ä»¬éœ€è¦æ·»åŠ å‡ ä¸ªå‚æ•°,  æ¥ç¦æ­¢ ca è®¤è¯å’Œå¼€é€š dns</p><p>åœ¨ deployment.spec.template.spec.containers ä¸­æ–°åŠ å…¥ä¸‹åˆ—é…ç½®:</p><pre><code class="language-yaml">        command:          - /metrics-server          - --kubelet-insecure-tls          - --kubelet-preferred-address-types=InternalDNS,InternalIP,ExternalDNS,ExternalIP,Hostname</code></pre><pre><code class="language-bash">kubectl apply -f components.yaml</code></pre><h2 id="hpa">hpa</h2><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</a></p><p>åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„webæœåŠ¡, hpa-test.yaml</p><pre><code class="language-yaml">apiVersion: apps/v1kind: Deploymentmetadata:  name: php-apachespec:  selector:    matchLabels:      run: php-apache  replicas: 1  template:    metadata:      labels:        run: php-apache    spec:      containers:      - name: php-apache        image: k8s.gcr.io/hpa-example        ports:        - containerPort: 80        resources:          limits:            cpu: 500m          requests:            cpu: 200m---apiVersion: v1kind: Servicemetadata:  name: php-apache  labels:    run: php-apachespec:  ports:  - port: 80  selector:    run: php-apache</code></pre><p>ç»™webæœåŠ¡å¼€å¯hpa</p><p>å‘½ä»¤æ–¹å¼:</p><pre><code class="language-bash">kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=5</code></pre><p>å£°æ˜æ–¹å¼:</p><pre><code class="language-yaml">apiVersion: autoscaling/v1kind: HorizontalPodAutoscalermetadata:  name: php-apachespec:  scaleTargetRef:    apiVersion: apps/v1    kind: Deployment    name: php-apache  minReplicas: 1  maxReplicas: 5  targetCPUUtilizationPercentage: 50</code></pre><blockquote><p>è¿™é‡Œçš„æ„æ€æ˜¯, cpu é˜ˆå€¼50%, æœ€å°podæ•°1, æœ€å¤§podæ•°5. hpaä¼šå°†æ‰€æœ‰podçš„å¹³å‡cpuåˆ©ç”¨ç‡ç»´æŒåœ¨50%, å¹¶ä¸”podæ•°é‡åœ¨1~5çš„èŒƒå›´å†…æ³¢åŠ¨</p></blockquote><p>æŸ¥çœ‹å½“å‰cpuä½¿ç”¨ç‡</p><pre><code class="language-bash">kubectl get hpa===NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   0%/50%    1         5         1          57m</code></pre><p>æ·»åŠ æµ‹è¯•ç”¨çš„å®¢æˆ·ç«¯, è®¿é—®webæœåŠ¡, å¢åŠ webæœåŠ¡çš„cpuä½¿ç”¨ç‡</p><pre><code class="language-bash">kubectl run -it --rm load-generator --image=busybox /bin/shwhile true; do wget -q -O- http://php-apache; done=== ä¼šè¾“å‡ºå¤§é‡OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!OK!</code></pre><p>åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ç­‰å¾…å(ä¸ä¼šè¶…è¿‡1åˆ†é’Ÿ, é»˜è®¤ç›‘æ§æŠ“å–æ•°æ®é—´éš”æ—¶é—´æ˜¯1åˆ†é’Ÿ),æˆ‘ä»¬å¯ä»¥çœ‹åˆ° pod æ•°é‡å‘ç”Ÿå˜åŒ–</p><pre><code class="language-bash">[root@k8s00 test-yaml]# kubectl get hpaNAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   0%/50%    1         5         1          60m[root@k8s00 test-yaml]# kubectl get hpaNAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   0%/50%    1         5         1          60m[root@k8s00 test-yaml]# kubectl get hpaNAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   250%/50%   1         5         1          61m[root@k8s00 test-yaml]# kubectl get hpaNAME         REFERENCE               TARGETS    MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   250%/50%   1         5         1          61m[root@k8s00 test-yaml]# kubectl get deployment/php-apacheNAME         READY   UP-TO-DATE   AVAILABLE   AGEphp-apache   5/5     5            5           68m[root@k8s00 test-yaml]# </code></pre><p>ç°åœ¨,å…³é—­å®¢æˆ·ç«¯è¯·æ±‚,ç­‰å¾…1åˆ†é’Ÿä»¥ä¸Š.å†æ¬¡çœ‹hpa, è¿™æ—¶å€™cpuåˆ©ç”¨ç‡å·²ç»ä¸‹é™</p><pre><code class="language-bash">[root@k8s00 test-yaml]# kubectl get hpaNAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGEphp-apache   Deployment/php-apache   11%/50%   1         5         5          64m</code></pre><p>è¿™æ—¶å€™,å†çœ‹podæ•°é‡,å®ƒåº”è¯¥å·²ç»å¼€å§‹ç¼©å‡,ä½†æ˜¯è¿™ä¸ªç¼©å‡å¹¶ä¸æ˜¯åœ¨cpuä½¿ç”¨ç‡ä¸‹é™ä¹‹åå°±ç«‹å³æ‰§è¡Œ,è€Œæ˜¯å†…éƒ¨æœ‰ä¸€ä¸ªç®—æ³•.å®ƒé¿å…å› ç«‹å³æ‰§è¡Œä»è€Œå¯¼è‡´èµ„æºå‡ºç°åå¤æ³¢åŠ¨.</p><pre><code class="language-bash">[root@k8s00 test-yaml]# kubectl get deployment php-apacheNAME         READY   UP-TO-DATE   AVAILABLE   AGEphp-apache   5/5     5            5           70m[root@k8s00 test-yaml]# kubectl describe deployment/php-apacheName:                   php-apacheNamespace:              defaultCreationTimestamp:      Wed, 16 Sep 2020 10:22:32 +0800Labels:                 &lt;none&gt;Annotations:            deployment.kubernetes.io/revision: 1Selector:               run=php-apacheReplicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailableStrategyType:           RollingUpdateMinReadySeconds:        0RollingUpdateStrategy:  25% max unavailable, 25% max surgePod Template:  Labels:  run=php-apache  Containers:   php-apache:    Image:      k8s.gcr.io/hpa-example    Port:       80/TCP    Host Port:  0/TCP    Limits:      cpu:  500m    Requests:      cpu:        200m    Environment:  &lt;none&gt;    Mounts:       &lt;none&gt;  Volumes:        &lt;none&gt;Conditions:  Type           Status  Reason  ----           ------  ------  Progressing    True    NewReplicaSetAvailable  Available      True    MinimumReplicasAvailableOldReplicaSets:  &lt;none&gt;NewReplicaSet:   php-apache-5c4f475bf5 (1/1 replicas created)Events:  Type    Reason             Age    From                   Message  ----    ------             ----   ----                   -------  Normal  ScalingReplicaSet  14m    deployment-controller  Scaled up replica set php-apache-5c4f475bf5 to 4  Normal  ScalingReplicaSet  14m    deployment-controller  Scaled up replica set php-apache-5c4f475bf5 to 5  Normal  ScalingReplicaSet  6m50s  deployment-controller  Scaled down replica set php-apache-5c4f475bf5 to 4  Normal  ScalingReplicaSet  4m49s  deployment-controller  Scaled down replica set php-apache-5c4f475bf5 to 1</code></pre><h2 id="å…¶å®ƒ">å…¶å®ƒ</h2><p>å½“å‰hpaçš„apiç‰ˆæœ¬æ˜¯autoscaling/v1,å®ƒåªèƒ½æŠ“å–cpuæŒ‡æ ‡.å¦‚æœä½ æƒ³æŠ“å–å†…å­˜æŒ‡æ ‡(å½“å‰ä¹Ÿåªæ”¯æŒå†…å­˜)æˆ–è‡ªå®šä¹‰æŒ‡æ ‡,é‚£ä¹ˆéœ€è¦å°†ç‰ˆæœ¬å˜æ›´ä¸ºautoscaling/v2beta2</p><p>autoscaling/v2beta2ç‰ˆæœ¬çš„é…ç½®æœ‰äº†ä¸€äº›å˜åŒ–,ä¸”å¯èƒ½éšæ—¶ä¼šæœ‰æ–°çš„å˜åŒ–.ä½ å¯ä»¥åœ¨</p><p><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-multiple-metrics-and-custom-metrics</a></p><p>æ‰¾åˆ°å®ƒçš„ä¾‹å­.</p><pre><code class="language-yaml">apiVersion: autoscaling/v2beta2kind: HorizontalPodAutoscalermetadata:  name: php-apachespec:  scaleTargetRef:    apiVersion: apps/v1    kind: Deployment    name: php-apache  minReplicas: 1  maxReplicas: 10  metrics:  - type: Resource    resource:      name: cpu      target:        type: Utilization        averageUtilization: 50status:  observedGeneration: 1  lastScaleTime: &lt;some-time&gt;  currentReplicas: 1  desiredReplicas: 1  currentMetrics:  - type: Resource    resource:      name: cpu      current:        averageUtilization: 0        averageValue: 0</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> deployment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜06æ— çŠ¶æ€æœåŠ¡deployment-podæ›´æ–°</title>
      <link href="posts/18e4fa73/"/>
      <url>posts/18e4fa73/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å¯¹äºæ›´æ–°,æˆ‘ä»¬ä¸€èˆ¬ä¼šé‡‡ç”¨æ»šåŠ¨æ›´æ–°,å³:</p><ul><li>å…ˆæ‰©å±•ä¸€éƒ¨åˆ†æ–°ç‰ˆæœ¬</li><li>åˆ é™¤ä¸€éƒ¨åˆ†è€ç‰ˆæœ¬</li><li>é‡å¤ä¸Šè¿°è¡Œä¸º,ç›´è‡³æ‰€æœ‰è€ç‰ˆæœ¬è¢«æ›¿æ¢.</li></ul><p>å¯¹äºå›æ»š,æˆ‘ä»¬æƒ³å›æ»šåˆ°ä»»ä½•ä¸€ä¸ªä¹‹å‰çš„ç‰ˆæœ¬.</p><p>è€Œdeploymentå¯¹è±¡å¯ä»¥å¸®æˆ‘ä»¬å®ç°è¿™äº›.</p><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></p><h2 id="æ›´æ–°">æ›´æ–°</h2><p>ä¸€ä¸ªæ›´æ–°nginxç‰ˆæœ¬çš„ä¾‹å­. é¦–å…ˆ,æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªnginxçš„deployment</p><pre><code class="language-bash">kubectl apply -f nginx-dep.yaml===apiVersion: apps/v1kind: Deploymentmetadata:  name: nginx-dep  labels:    app: nginxspec:  replicas: 3  selector:    matchLabels:      app: nginx  template:    metadata:      labels:        app: nginx    spec:      containers:      - name: nginx        image: nginx        ports:        - containerPort: 80</code></pre><blockquote><p>è¿™é‡Œdepçš„é…ç½®ä¸­spec.template.spec.container.image=nginx, æˆ‘æ²¡æœ‰è®¾ç½®å…·ä½“ç‰ˆæœ¬</p></blockquote><p>æ­¤æ—¶,æŸ¥çœ‹ç‰ˆæœ¬å†å², è¿™é‡Œæ¶‰åŠåˆ° rollout æŒ‡ä»¤, å›æ»šçš„æ—¶å€™ä¹Ÿä¼šç”¨åˆ°.</p><pre><code class="language-bash">kubectl rollout history deployment/nginx-dep#---deployment.apps/nginx-dep REVISION  CHANGE-CAUSE1         &lt;none&gt;</code></pre><p>æ­¤æ—¶æˆ‘ä»¬å‘ç°æ²¡æœ‰å…³äºè¿™ä¸ªç‰ˆæœ¬1çš„ç›¸å…³æè¿°, æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œæ·»åŠ </p><pre><code class="language-bash">kubectl annotate deployment/nginx-dep kubernetes.io/change-cause=&quot;first&quot;kubectl rollout history deployment/nginx-dep#---deployment.apps/nginx-dep REVISION  CHANGE-CAUSE1         first</code></pre><blockquote><p>ä½ ä¹Ÿå¯ä»¥åœ¨æ‰§è¡Œå†™å…¥å‘½ä»¤çš„æ—¶å€™, è¿½åŠ  --record æ¥å°†æ‰§è¡Œçš„å‘½ä»¤å†™å…¥åˆ°å½“å‰change-cause</p></blockquote><p>ç°åœ¨, å°†æ‰€æœ‰deploymentä¸­æ‰€æœ‰nginxçš„imageç‰ˆæœ¬ä»é»˜è®¤å˜æ›´ä¸ºäº†1.19.2</p><pre><code class="language-bash">kubectl set image deployment/nginx-dep nginx=nginx:1.19.2 &amp;&amp; kubectl annotate deployment/nginx-dep kubernetes.io/change-cause=&quot;nginx image to 1.19.2&quot;kubectl rollout history deployment/nginx-dep#---deployment.apps/nginx-dep REVISION  CHANGE-CAUSE1         first2         nginx image to 1.19.2</code></pre><p>æˆ‘ä»¬å†ç”Ÿæˆä¸€ä¸ªç‰ˆæœ¬1.18</p><pre><code class="language-bash">kubectl set image deployment/nginx-dep nginx=nginx:1.18 &amp;&amp; kubectl annotate deployment/nginx-dep kubernetes.io/change-cause=&quot;nginx image to 1.18&quot;kubectl rollout history deployment/nginx-dep#---deployment.apps/nginx-dep REVISION  CHANGE-CAUSE1         first2         nginx image to 1.19.23         nginx image to 1.18</code></pre><p>è¿™æ ·,æˆ‘ä»¬æ€»å…±æœ‰ä¸‰ä¸ªç‰ˆæœ¬, ä½ å¯ä»¥é€šè¿‡è¿½åŠ ç‰ˆæœ¬å·æ¥çœ‹å…·ä½“çš„ç‰ˆæœ¬å†…å®¹</p><pre><code class="language-bash">kubectl rollout history deployment/nginx-dep --revision=&lt;num&gt;</code></pre><h2 id="å›æ»š">å›æ»š</h2><p>æˆ‘ä»¬é€‰æ‹©å°†nginxç‰ˆæœ¬å›æ»šåˆ°firstç¬¬ä¸€ä¸ªç‰ˆæœ¬.</p><pre><code class="language-bash">kubectl rollout undo deployment/nginx-dep --to-revision=1kubectl rollout history deployment/nginx-dep#---deployment.apps/nginx-dep REVISION  CHANGE-CAUSE2         nginx image to 1.19.23         nginx image to 1.184         first</code></pre><h2 id="ç­–ç•¥">ç­–ç•¥</h2><p>deployment çš„ .spec ä¸­å¯ä»¥æ·»åŠ ä¸€äº›ç­–ç•¥.</p><pre><code class="language-bash">spec:    minReadySeconds: 3  # pod å°±ç»ªæ—¶é—´, åœ¨æ­¤æ—¶é—´ä¹‹å‰, deploy è®¤ä¸º pod è¿˜æ²¡æœ‰å‡†å¤‡å¥½. é»˜è®¤0  revisionHistoryLimit: 10 # æœ€å¤§ç‰ˆæœ¬ä¿ç•™æ¬¡æ•°. é»˜è®¤10   strategy:    type: rollingUpdate # å®šä¹‰å˜æ›´ç­–ç•¥. é™¤äº† rollingUpdate, è¿˜å¯ä»¥æ˜¯Recreate.RecreateæŒ‡çš„æ˜¯å…ˆåˆ é™¤æ‰€æœ‰pod,å†åˆ›å»º.    rollingUpdate:      maxUnavailable: 30% # å˜æ›´æœŸé—´æœ€å¤šå­˜åœ¨å¤šå°‘ä¸ªä¸å¯ç”¨çš„pod      maxSurge: 30% # å˜æ›´æœŸé—´æœ€å¤šå­˜åœ¨å¤šå°‘ä¸ªè¶…å‡ºå·²å®šä¹‰å‰¯æœ¬çš„podæ•°é‡</code></pre><blockquote><p>maxUnavailable å’Œ maxSurge è®¾ç½®ç›¸ç­‰å³å¯. å³å¼€å¤šå°‘ä¸ªæ–°çš„, å°±å…³å¤šå°‘ä¸ªè€çš„</p></blockquote><h2 id="å°ç»“">å°ç»“</h2><pre><code class="language-bash">kubectl rollout history # æŸ¥çœ‹å¯¹è±¡å†å²kubectl rollout undo # å¯¹è±¡ç‰ˆæœ¬å›é€€kubectl rollout status # å±•ç¤ºæ‰§è¡ŒçŠ¶æ€kubectl rollout pause # æš‚åœæ­¤æ¬¡ç‰ˆæœ¬æ“ä½œè¡Œä¸ºkubectl rollout resume # æ¢å¤æ­¤æ¬¡ç‰ˆæœ¬æ“ä½œè¡Œä¸ºkubectl set image # ä¿®æ”¹é•œåƒé…ç½®kubectl annotate # æ·»åŠ ä¸€ä¸ªæ³¨é‡Š</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> deployment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜å¸¸ç”¨å‘½ä»¤</title>
      <link href="posts/e6ae9474/"/>
      <url>posts/e6ae9474/</url>
      
        <content type="html"><![CDATA[<h2 id="æŸ¥è¯¢åº“è¡¨å ç”¨ç©ºé—´">æŸ¥è¯¢åº“è¡¨å ç”¨ç©ºé—´</h2><pre><code class="language-mysql">SELECT    table_schema AS 'æ•°æ®åº“',    table_name AS 'è¡¨å',    table_rows AS 'è®°å½•æ•°',    TRUNCATE (data_length / 1024 / 1024 / 1024, 3) AS 'æ•°æ®å®¹é‡(GB)',    TRUNCATE (index_length / 1024 / 1024 / 1024 , 3) AS 'ç´¢å¼•å®¹é‡(GB)',TRUNCATE (DATA_FREE / 1024 / 1024 / 1024, 3) AS 'å·²å ç”¨ç©ºé—´ä½†æœªä½¿ç”¨(GB)'FROM    information_schema. TABLESWHERE    table_schema in ('new_data','megable_main','megable_active')ORDER BY    data_length DESC;</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜05podæ¢æµ‹å™¨</title>
      <link href="posts/9aa66899/"/>
      <url>posts/9aa66899/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¢æµ‹å™¨">æ¢æµ‹å™¨</h2><blockquote><p><a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes">https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes</a></p></blockquote><p>æ¢æµ‹å™¨æœ‰ä¸‰ç§ï¼šå­˜æ´»æ¢æµ‹å™¨ï¼Œå°±ç»ªæ¢æµ‹å™¨ï¼Œå¯åŠ¨æ¢æµ‹å™¨</p><p>kubelet ä½¿ç”¨å­˜æ´»æ¢æµ‹å™¨æ¥çŸ¥é“ä»€ä¹ˆæ—¶å€™è¦é‡å¯å®¹å™¨ã€‚ ä¾‹å¦‚ï¼Œå­˜æ´»æ¢æµ‹å™¨å¯ä»¥æ•æ‰åˆ°æ­»é”ç¨‹åºï¼ˆè¿›ç¨‹åœ¨ï¼Œä½†ç¨‹åºå·²æ— æ³•è¿›ä¸€æ­¥æ‰§è¡Œï¼‰ã€‚ è¿™æ ·çš„æƒ…å†µä¸‹é‡å¯å®¹å™¨æœ‰åŠ©äºè®©åº”ç”¨ç¨‹åºåœ¨æœ‰é—®é¢˜çš„æƒ…å†µä¸‹æ›´å¯ç”¨ã€‚</p><p>kubelet ä½¿ç”¨å°±ç»ªæ¢æµ‹å™¨å¯ä»¥çŸ¥é“å®¹å™¨ä»€ä¹ˆæ—¶å€™å‡†å¤‡å¥½äº†å¹¶å¯ä»¥å¼€å§‹æ¥å—è¯·æ±‚æµé‡ï¼Œ å½“ä¸€ä¸ª Pod å†…çš„æ‰€æœ‰å®¹å™¨éƒ½å‡†å¤‡å¥½äº†ï¼Œæ‰èƒ½æŠŠè¿™ä¸ª Pod çœ‹ä½œå°±ç»ªäº†ã€‚ è¿™ç§ä¿¡å·çš„ä¸€ä¸ªç”¨é€”å°±æ˜¯æ§åˆ¶å“ªä¸ª Pod ä½œä¸º Service çš„åç«¯ã€‚ åœ¨ Pod è¿˜æ²¡æœ‰å‡†å¤‡å¥½çš„æ—¶å€™ï¼Œä¼šä» Service çš„è´Ÿè½½å‡è¡¡å™¨ä¸­è¢«å‰”é™¤çš„ã€‚</p><p>kubelet ä½¿ç”¨å¯åŠ¨æ¢æµ‹å™¨å¯ä»¥çŸ¥é“åº”ç”¨ç¨‹åºå®¹å™¨ä»€ä¹ˆæ—¶å€™å¯åŠ¨äº†ã€‚ å¦‚æœé…ç½®äº†è¿™ç±»æ¢æµ‹å™¨ï¼Œå°±å¯ä»¥æ§åˆ¶å®¹å™¨åœ¨å¯åŠ¨æˆåŠŸåå†è¿›è¡Œå­˜æ´»æ€§å’Œå°±ç»ªæ£€æŸ¥ï¼Œ ç¡®ä¿è¿™äº›å­˜æ´»ã€å°±ç»ªæ¢æµ‹å™¨ä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„å¯åŠ¨ã€‚ è¿™å¯ä»¥ç”¨äºå¯¹æ…¢å¯åŠ¨å®¹å™¨è¿›è¡Œå­˜æ´»æ€§æ£€æµ‹ï¼Œé¿å…å®ƒä»¬åœ¨å¯åŠ¨è¿è¡Œä¹‹å‰å°±è¢«æ€æ‰ã€‚</p><h2 id="å­˜æ´»æ¢æµ‹å™¨-livenessProbe">å­˜æ´»æ¢æµ‹å™¨ livenessProbe</h2><p>ç›®çš„åœ¨äºç¡®è®¤å®¹å™¨æ˜¯å¦å¥åº·ï¼Œå¹¶åœ¨ä¸å¥åº·çš„æ—¶å€™é‡å¯å®¹å™¨ã€‚å®ƒå°†åœ¨å®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œã€‚</p><p>æ¢æµ‹å™¨æœ‰ä¸‰ç§æ¢æµ‹æ–¹å¼ï¼Œå‘½ä»¤æ–¹å¼ï¼Œhttpæ–¹å¼ï¼Œtcpæ–¹å¼ã€‚å…·ä½“å¯ä»¥ä¸Šè¿°å®˜æ–¹æ–‡æ¡£</p><p>å­˜æ´»æ¢æµ‹å™¨åŒ…å«ä¸¤ä¸ªæ—¶é—´æ®µï¼Œä¸€ä¸ªæ˜¯åˆå§‹å®½å®¹æœŸé˜¶æ®µ initialDelaySecondsï¼Œä¸€ä¸ªæ˜¯åˆå§‹é˜¶æ®µä¹‹åçš„æ¢æµ‹é—´éš”æ—¶é—´ periodSeconds</p><p>httpæ–¹å¼ä¾‹å­å¦‚ä¸‹ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  labels:    test: liveness  name: liveness-httpspec:  containers:  - name: liveness    image: k8s.gcr.io/liveness    args:    - /server    livenessProbe:      httpGet:        path: /healthz        port: 8080        httpHeaders:        - name: Custom-Header          value: Awesome      initialDelaySeconds: 3      periodSeconds: 3</code></pre><blockquote><p>æ¢æµ‹å™¨ä¼šè®¤ä¸º 200&lt;=x&lt;400 çš„çŠ¶æ€ç ä¸ºæ­£å¸¸ã€‚</p></blockquote><h2 id="å°±ç»ªæ¢æµ‹å™¨-readinessProbe">å°±ç»ªæ¢æµ‹å™¨ readinessProbe</h2><p>ç›®çš„åœ¨äºä»…ç¡®è®¤å®¹å™¨æ˜¯å¦å¥åº·ï¼Œä½†æ˜¯å¹¶ä¸åˆ é™¤å®¹å™¨ã€‚å®ƒå°†åœ¨å®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œã€‚</p><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml:">apiVersion: v1kind: Podmetadata:  name: goproxy  labels:    app: goproxyspec:  containers:  - name: goproxy    image: k8s.gcr.io/goproxy:0.1    ports:    - containerPort: 8080    readinessProbe:      tcpSocket:        port: 8080      initialDelaySeconds: 5      periodSeconds: 10    livenessProbe:      tcpSocket:        port: 8080      initialDelaySeconds: 15      periodSeconds: 20</code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å°±ç»ªæ¢é’ˆçš„æ—¶é—´å®šä¹‰æ˜¯è¦æ¯”å­˜æ´»æ¢é’ˆæå‰çš„ã€‚å³å®¹å™¨å¯åŠ¨5ç§’åå°±è¿›è¡Œå°±ç»ªæ¢æµ‹ï¼Œå®¹å™¨å¯åŠ¨15ç§’åè¿›è¡Œå­˜æ´»æ¢æµ‹ã€‚</p><h2 id="å¯åŠ¨æ¢æµ‹å™¨-startupProbe">å¯åŠ¨æ¢æµ‹å™¨ startupProbe</h2><p>ç›®çš„åœ¨äºè®¾ç½®ä¸€ä¸ªå®¹å™¨å¯åŠ¨å®½å®¹æœŸã€‚å½“å¯åŠ¨æ¢æµ‹å™¨ç¡®è®¤å®¹å™¨æ²¡é—®é¢˜åï¼Œåç»­çš„å¥åº·çŠ¶æ€å°†äº¤ç»™å­˜æ´»æ¢æµ‹å™¨ã€‚</p><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-yaml">ports:- name: liveness-port  containerPort: 8080  hostPort: 8080livenessProbe:  httpGet:    path: /healthz    port: liveness-port  failureThreshold: 1  periodSeconds: 10startupProbe:  httpGet:    path: /healthz    port: liveness-port  failureThreshold: 30  periodSeconds: 10</code></pre><h2 id="æœ€ä½³å®è·µ">æœ€ä½³å®è·µ</h2><ol><li>å­˜æ´»å’Œå°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æ˜¯ä¸¤ä¸ªäº’ç›¸ç‹¬ç«‹çš„æ¥å£</li><li>å­˜æ´»æ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æ˜¯ç›´æ¥è¿”å›çŠ¶æ€ç»“æœï¼Œä¸åº”è¯¥æœ‰ä»»ä½•é€»è¾‘</li><li>å°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£åº”è¯¥æä¾›å°±ç»ªæ‰€éœ€è¦çš„é€»è¾‘ã€‚ä½†æ˜¯ä¸åº”è¯¥æ·»åŠ é‡æ–°æ„å»ºå°±ç»ªçš„é€»è¾‘ã€‚ä¾‹å¦‚ï¼šå¤„ç†httpè¯·æ±‚çš„ç¨‹åºéœ€è¦ä¸€ä¸ªæ•°æ®åº“è¿æ¥çš„å°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨å°±ç»ªæ¢é’ˆçš„å¥åº·çŠ¶æ€æ¥å£é‡Œæ·»åŠ æ•°æ®åº“è¿æ¥çš„æ£€æŸ¥é€»è¾‘ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜é¢„è­¦</title>
      <link href="posts/4ebbd3a8/"/>
      <url>posts/4ebbd3a8/</url>
      
        <content type="html"><![CDATA[<p>å®šä¹‰é¢„è­¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤</p><ol><li>å®šä¹‰é¢„è­¦åª’ä»‹</li><li>å®šä¹‰é¢„è­¦ç”¨æˆ·</li><li>å®šä¹‰é¢„è­¦åŠ¨ä½œ</li></ol><p>è§¦å‘å™¨è¾¾åˆ°é˜ˆå€¼ï¼Œè°ƒç”¨é¢„è­¦åŠ¨ä½œï¼Œé¢„è­¦åŠ¨ä½œè°ƒç”¨é¢„è­¦ç”¨æˆ·ï¼Œé¢„è­¦ç”¨æˆ·è°ƒç”¨é¢„è­¦åª’ä»‹</p><h2 id="é¢„è­¦åª’ä»‹">é¢„è­¦åª’ä»‹</h2><p>é…ç½®-æŠ¥è­¦åª’ä»‹ç±»å‹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªè¦ç´ </p><h3 id="æŠ¥è­¦åª’ä»‹ç±»å‹">æŠ¥è­¦åª’ä»‹ç±»å‹</h3><p>ç±»å‹æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚é‚®ä»¶ï¼Œè‡ªå®šä¹‰è„šæœ¬ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰è‡ªå®šä¹‰è„šæœ¬ï¼Œæ¥å®šä¹‰ä¸€ä¸ªä¼ä¸šå¾®ä¿¡é¢„è­¦</p><p><img src="/posts/4ebbd3a8/image-20200902144015196.png" alt="image-20200902144015196"></p><p>è„šæœ¬éœ€è¦æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p><p>{ALERT.SENDTO}ï¼šæ”¶ä»¶äºº</p><p>{ALERT.SUBJECT}ï¼šä¸»é¢˜</p><p>{ALERT.MESSAGE}ï¼šå†…å®¹</p><p>æˆ‘ä»¬ä¸€èˆ¬åªç”¨{ALERT.SENDTO}å’Œ{ALERT.MESSAGE}å³å¯</p><h3 id="ä¿¡æ¯æ¨¡æ¿">ä¿¡æ¯æ¨¡æ¿</h3><p>å®šä¹‰ä¿¡æ¯æ¨¡æ¿ï¼Œä¸€èˆ¬æˆ‘ä»¬å®šä¹‰å‘Šè­¦æ¨¡æ¿/æ¢å¤æ¨¡æ¿/è‡ªåŠ¨æ³¨å†Œæ¨¡æ¿</p><p>å‘Šè­¦æ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144408513.png" alt="image-20200902144408513"></p><pre><code>ã€[éª·é«…]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ : &#123;EVENT.ID&#125;ã€é—®é¢˜æ—¶é—´ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125; ã€é—®é¢˜åå­—ã€‘: &#123;EVENT.NAME&#125;ã€é—®é¢˜ä¸»æœºã€‘: &#123;HOST.NAME&#125;ã€é—®é¢˜çº§åˆ«ã€‘: &#123;EVENT.SEVERITY&#125;ã€é˜ˆå€¼ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€é˜ˆå€¼é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;ã€Operational dataã€‘: &#123;EVENT.OPDATA&#125;&#123;TRIGGER.URL&#125;</code></pre><p>æ¢å¤æ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144504865.png" alt="image-20200902144504865"></p><pre><code>ã€[OK]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ : &#123;EVENT.ID&#125;ã€é—®é¢˜æ—¶é—´ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125; ã€é—®é¢˜æ¢å¤æ—¶é—´ã€‘: &#123;EVENT.RECOVERY.DATE&#125;  &#123;EVENT.RECOVERY.TIME&#125;ã€é—®é¢˜åå­—ã€‘: &#123;EVENT.NAME&#125;ã€é—®é¢˜ä¸»æœºã€‘: &#123;HOST.NAME&#125;ã€é—®é¢˜çº§åˆ«ã€‘: &#123;EVENT.SEVERITY&#125;ã€é˜ˆå€¼ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€é˜ˆå€¼é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;ã€Operational dataã€‘: &#123;EVENT.OPDATA&#125;&#123;TRIGGER.URL&#125;</code></pre><p>è‡ªåŠ¨æ³¨å†Œæ¨¡æ¿å¦‚å›¾ï¼š</p><p><img src="/posts/4ebbd3a8/image-20200902144535568.png" alt="image-20200902144535568"></p><pre><code>è‡ªåŠ¨æ³¨å†Œ: ä¸»æœºå: &#123;HOST.HOST&#125;ä¸»æœºip: &#123;HOST.IP&#125;ä»£ç†ç«¯å£: &#123;HOST.PORT&#125;</code></pre><h3 id="æ”¾ç½®å‘é€ä¿¡æ¯çš„è„šæœ¬">æ”¾ç½®å‘é€ä¿¡æ¯çš„è„šæœ¬</h3><p>å…·ä½“ä½ç½®ä»¥zb serverçš„å®‰è£…å’Œé…ç½®ä¸ºåŸºå‡†.</p><pre><code class="language-python">#!/usr/bin/env python3&quot;&quot;&quot;@author: zyh@contact: aaa103439@hotmail.com@software: vscode@file: sendchat.py@time: 2020/02/05@use: pip3 install requests configparser&quot;&quot;&quot;import sys, os, requests, pathlib, json, configparserimport loggingimport logging.handlersfrom datetime import datetimeclass PySendchat():    def __init__(self, corpid, agentid, secret, touser, content):        self.corpid=corpid        self.agentid=agentid        self.secret=secret        self.touser=touser        self.content=content        LOG_PATHDIR=os.path.dirname(os.path.abspath(__file__))        LOG_FILENAME = '&#123;0&#125;/sendchat.log'.format(LOG_PATHDIR)        self.my_logger = logging.getLogger('SendChat')        self.my_logger.setLevel(logging.INFO)        # Add the log message handler to the logger        handler = logging.handlers.RotatingFileHandler(LOG_FILENAME, maxBytes=102400000, backupCount=5)        # create formatter and add it to the handlers        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')        handler.setFormatter(formatter)        self.my_logger.addHandler(handler)    def gettoken(self):        self.my_logger.info('-----------------------------------------------------------------------------------------')        pwd=os.path.dirname(os.path.abspath(__file__))        tokenfile='&#123;0&#125;/wechat.&#123;1&#125;'.format(pwd,self.agentid)        if pathlib.Path(tokenfile).exists():            tokenfilectime=os.path.getctime(tokenfile)            currenttime=datetime.now().timestamp()            dtime=currenttime-tokenfilectime            self.my_logger.info('&#123;0&#125; lived &#123;1&#125;s.'.format(tokenfile, dtime))            if dtime &gt;= 7200:                try:                    os.remove(tokenfile)                    self.my_logger.info('Token file &#123;0&#125;: delete success'.format(tokenfile))                except Exception as e:                    self.my_logger.error('Token file:&#123;0&#125; delete error.Reason:&#123;1&#125;'.format(tokenfile,e))                    exit        # check token file        try:            tokensize = os.path.getsize(tokenfile)        except Exception as e:            self.my_logger.info('Token file is not exist.Reason:&#123;0&#125;'.format(e))            tokensize = 0        # get token from token file        if tokensize != 0:            with open(tokenfile, 'rb') as fd:                token = fd.read() # get token success                self.my_logger.info('Get token from token file.')            jsonObject = json.loads(token.decode(encoding='utf8'))            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token        # get token from weixin api        else:            try:                self.my_logger.info('New Token Create.')                f = requests.get('https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#123;0&#125;&amp;corpsecret=&#123;1&#125;'.format(self.corpid, self.secret))                token = f.content                self.my_logger.info('Get token from weixin api.')                jsonObject = json.loads(token.decode(encoding='utf8'))                errcode=int(jsonObject.get(&quot;errcode&quot;))                if errcode != 0:                    errmsg=jsonObject.get(&quot;errmsg&quot;)                    self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(errmsg))                    exit()            except Exception as e:                self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(e))                exit()            try:                self.my_logger.info('Write token to &#123;0&#125;.'.format(tokenfile))                with open(tokenfile, 'wb') as fd:                    fd.write(token)            except Exception as e:                self.my_logger.error('Write &#123;0&#125; error!Reason:&#123;1&#125;'.format(tokenfile,e))                exit()            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token    def sendmsg(self):        accessToken = self.gettoken()        self.my_logger.info('Token:&#123;0&#125;'.format(accessToken))        sendMapDirectroy = &#123;&#125;        sendMapDirectroy[&quot;agentid&quot;] = self.agentid        sendMapDirectroy[&quot;touser&quot;] = self.touser        sendMapDirectroy[&quot;msgtype&quot;] = &quot;text&quot;        sendMapDirectroy[&quot;safe&quot;] = &quot;0&quot;        contentDirectory = &#123;&#125;        sendMapDirectroy[&quot;text&quot;] = contentDirectory        contentDirectory[&quot;content&quot;] = self.content        bodyStr = json.dumps(sendMapDirectroy, ensure_ascii=False).encode(encoding=&quot;utf-8&quot;)        try:            f = requests.post(url=&quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % accessToken,                          data=bodyStr, timeout=5)            self.my_logger.info(f.content)        except Exception as e:            self.my_logger.error('Send chat network error!Reason:&#123;0&#125;'.format(e))if __name__ == '__main__':    appname = sys.argv[1]    content = sys.argv[3]    # read conf.ini    conf = configparser.ConfigParser()    conf_path = os.path.dirname(os.path.abspath(__file__))    conf_ini = &quot;&#123;0&#125;/conf.ini&quot;.format(conf_path)    if pathlib.Path(conf_ini).exists():        conf.read(conf_ini)        corpid = conf.get(&quot;wechat&quot;, &quot;corpid&quot;)        appinfo = conf.get(&quot;app&quot;, appname)        agentid = appinfo.split(':')[0]        secret = appinfo.split(':')[1]        groupname = conf.get(&quot;group&quot;, appname)        touser = groupname.split(':')[0]        chatobj = PySendchat(corpid, agentid, secret, touser, content)    else:        print('conf.ini error')        exit()    try:        chatobj.sendmsg()    except:        chatobj.my_logger.error(&quot;Send chat failure!&quot;)</code></pre><pre><code class="language-ini"># conf.ini[wechat]corpid = [app]it = &lt;app_agent_id&gt;:&lt;app_secret&gt;[group]it = usera|userb</code></pre><p>eg:</p><p>python3 <a href="http://wechat.py">wechat.py</a> it â€˜â€™ &lt;é¢„è­¦å†…å®¹&gt;</p><p>å›  zabbix è°ƒç”¨è„šæœ¬å¹¶é root ç”¨æˆ·ï¼Œæ‰€ä»¥ç»™è„šæœ¬é™„åŠ  x æƒé™ï¼Œé¿å…æƒé™é—®é¢˜ã€‚</p><pre><code class="language-bash">chmod a+x wechat.py# å› è„šæœ¬ä¼šç”Ÿæˆå…¶å®ƒæ–‡ä»¶# æ‰€ä»¥è¿˜éœ€è¦ç»™è„šæœ¬æ‰€åœ¨çš„ç›®å½•æ·»åŠ å…¶å®ƒç”¨æˆ·çš„å†™å…¥æƒé™chmod 757 alertscripts</code></pre><h2 id="é¢„è­¦ç”¨æˆ·">é¢„è­¦ç”¨æˆ·</h2><p>ç®¡ç†-ç”¨æˆ·-æ·»åŠ ç”¨æˆ·ï¼Œè¿™é‡Œæœ‰ä¸‰è¦ç´ </p><h3 id="ç”¨æˆ·">ç”¨æˆ·</h3><p>ä½ æ— éœ€ç™»é™†è¿™ä¸ªç”¨æˆ·ï¼Œæ‰€ä»¥å¯†ç å¯ä»¥å°½é‡çš„å¤æ‚</p><p><img src="/posts/4ebbd3a8/image-20200902150131147.png" alt="image-20200902150131147"></p><h3 id="æŠ¥è­¦åª’ä»‹">æŠ¥è­¦åª’ä»‹</h3><p><img src="/posts/4ebbd3a8/image-20200902150145022.png" alt="image-20200902150145022"></p><blockquote><p>æˆ‘ä»¬å®šä¹‰è¿™ä¸ªç”¨æˆ·è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°†ä¼šå‘é€ä¿¡æ¯ç»™itç»„ï¼Œè‡³äºitç»„åŒ…å«å“ªäº›äººå‘˜ï¼Œåˆ™ç”±è„šæœ¬å®šä¹‰ã€‚</p></blockquote><h3 id="æƒé™">æƒé™</h3><p><img src="/posts/4ebbd3a8/image-20200902150153011.png" alt="image-20200902150153011"></p><h2 id="é¢„è­¦åŠ¨ä½œ">é¢„è­¦åŠ¨ä½œ</h2><p>é…ç½®-åŠ¨ä½œ-å·¦ä¸Šè§’ï¼ˆè§¦å‘å™¨åŠ¨ä½œTrigger actionsï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªè¦ç´ </p><ol><li>ä»€ä¹ˆæ¡ä»¶ä¸‹æ‰§è¡ŒåŠ¨ä½œ</li><li>åŠ¨ä½œçš„å®é™…è¡Œä¸º</li></ol><h3 id="æ¡ä»¶">æ¡ä»¶</h3><p>éœ€è¦æ³¨æ„çš„æ˜¯è®¡ç®—æ–¹å¼</p><blockquote><p>é—®é¢˜æ²¡æœ‰è¢«åˆ¶æ­¢çš„æ„æ€ï¼šæ²¡æœ‰äººä¸ºçš„å…³é—­é¢„è­¦</p></blockquote><p><img src="/posts/4ebbd3a8/image-20200902150806009.png" alt="image-20200902150806009"></p><h3 id="æ“ä½œ">æ“ä½œ</h3><p><img src="/posts/4ebbd3a8/image-20200902151037597.png" alt="image-20200902151037597"></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> wechat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜å®¹å™¨æ­å»º</title>
      <link href="posts/25f36846/"/>
      <url>posts/25f36846/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆ›å»ºç½‘ç»œ">åˆ›å»ºç½‘ç»œ</h2><pre><code class="language-bash">docker network create -d bridge zbnet</code></pre><h2 id="mysql">mysql</h2><pre><code class="language-bash">mkdir -p /export/docker-data-mysql/&#123;config,logs,data&#125;docker run --name mysql57 \-p 3306:3306 \--network zbnet \--restart=always \--mount 'type=bind,src=/export/docker-data-mysql/config,dst=/etc/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/logs,dst=/var/log/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/data,dst=/var/lib/mysql' \-e MYSQL_ROOT_PASSWORD=123456 \-d mysql:5.7</code></pre><h2 id="zabbix-server">zabbix-server</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-server-mysql">https://hub.docker.com/r/zabbix/zabbix-server-mysql</a></p></blockquote><p>å®‰è£… centos + server + mysql ç‰ˆæœ¬</p><p>é»˜è®¤ï¼Œç¯å¢ƒå˜é‡ <code>MYSQL_USER</code> and <code>MYSQL_PASSWORD</code> are <code>zabbix</code>, <code>zabbix</code>.</p><pre><code>mkdir -p /export/docker-data-zbserver/alertscriptsdocker volume create zabbixServerEtcdocker run --name=zabbix_server \-p 10051:10051 \--network zbnet \--restart=always \--mount 'type=volume,src=zabbixServerEtc,dst=/etc/zabbix' \--mount 'type=bind,src=/export/docker-data-zbserver/alertscripts,dst=/usr/lib/zabbix/alertscripts' \-e DB_SERVER_HOST=&quot;mysql57&quot; \-e MYSQL_DATABASE=&quot;zabbixserver&quot; \-e MYSQL_USER=&quot;zabbix&quot; \-e MYSQL_PASSWORD=&quot;zabbix&quot; \-e MYSQL_ROOT_PASSWORD=&quot;123456&quot; \-d zabbix/zabbix-server-mysql:centos-latest</code></pre><ol><li><p>é»˜è®¤å®‰è£…å®Œä¹‹åï¼Œå®¹å™¨å†…ç¼ºå°‘ä¸€äº›å¼€å‘ç¯å¢ƒï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬çš„å‘Šè­¦è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œæ¯”å¦‚æˆ‘æ˜¯ç”¨ python3 å†™çš„å¾®ä¿¡å‘Šè­¦ï¼Œè€Œç¯å¢ƒé‡Œæ²¡æœ‰ã€‚å› æ­¤éœ€è¦é¢å¤–åŠ è£…ã€‚</p><pre><code class="language-bash">docker logs -f zabbix_server # å¯ä»¥çœ‹åˆ°å¦‚ä¸‹é”™è¯¯203:20200831:030724.713 Failed to execute command &quot;/usr/lib/zabbix/alertscripts/wechat.py 'it' 'è‡ªåŠ¨æ³¨å†Œ: xxx-use-001-10-240-128-100' 'ä¸»æœºå: xxx-use-001-10-240-128-100ä¸»æœºip: xxxä»£ç†ç«¯å£: 10050'&quot;: env: 'python3': No such file or directory</code></pre><pre><code class="language-bash"># å®‰è£… python3 å’Œæ¨¡å—docker exec -it -u root zabbix_server yum install python3docker exec -it -u root zabbix_server pip3 install requests configparser</code></pre></li><li><p>alertscripts ç›®å½•éœ€è¦æœ‰ other å¯æ‰§è¡Œæƒé™</p><pre><code class="language-bash">chmod o+w /export/docker-data-zbserver/alertscripts</code></pre><p>å› ä¸º zabbix_server åœ¨æ‰§è¡Œå‘Šè­¦è„šæœ¬çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯æ™®é€šç”¨æˆ·</p></li></ol><h2 id="zabbix-server-web">zabbix-server-web</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-web-nginx-mysql">https://hub.docker.com/r/zabbix/zabbix-web-nginx-mysql</a></p></blockquote><pre><code class="language-bash"># å®‰è£…å­—ä½“yum install google-noto-sans-simplified-chinese-fonts.noarch -ydocker run --name zabbix_web \-p 80:8080 \-p 443:8443 \--restart=always \--network zbnet \--mount 'type=bind,src=/usr/share/fonts/google-noto/NotoSansSC-Regular.otf,dst=/usr/share/zabbix/assets/fonts/DejaVuSans.ttf' \-e DB_SERVER_HOST=&quot;mysql57&quot; \-e MYSQL_DATABASE=&quot;zabbixserver&quot; \-e MYSQL_USER=&quot;zabbix&quot; \-e MYSQL_PASSWORD=&quot;zabbix&quot; \-e MYSQL_ROOT_PASSWORD=&quot;123456&quot; \-e ZBX_SERVER_HOST=&quot;zabbix_server&quot; \-e PHP_TZ=&quot;Asia/Shanghai&quot; \-d zabbix/zabbix-web-nginx-mysql:latest</code></pre><blockquote><p><a href="http://ip">http://ip</a> å³å¯</p><p>åˆå§‹è´¦æˆ·å¯†ç æ˜¯ Admin/zabbix</p></blockquote><p>åˆ°è¿™é‡Œï¼Œä½ å°±å¯ä»¥è®¿é—®zabbixäº†ï¼Œä¸è¿‡è¿™æ—¶å€™ä½ ä¼šå‘ç°zabbixæç¤ºagentä¸å¯è¾¾</p><p><img src="/posts/25f36846/image-20200901172913999.png" alt="image-20200901172913999"></p><p>å…¶åŸå› æ˜¯æˆ‘ä»¬è¿˜æ²¡åˆ›å»ºagent</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºé»˜è®¤zabbix serverçš„ä¸»æœºé…ç½®é¡¹ç›‘å¬çš„æ˜¯ 127.0.0.1:10050, å¹¶ä¸”ä¸»æœºåé…ç½®çš„æ˜¯</p><p><code>zabbix server</code>. è¿™å’Œæˆ‘ä»¬æœ¬æ–‡æ¡£æœ‰ä¸€äº›å†²çªï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€äº›é…ç½®ã€‚</p><ol start="2"><li>ä¿®æ”¹ä¸»æœºé…ç½®ä¸­çš„ hostname ä¸º agent å®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡ ZBX_HOSTNAMEã€‚è¿™é‡Œæˆ‘ä»¬ä¸º zabbix_server</li><li>ä¿®æ”¹ä¸»æœºé…ç½®ä¸­çš„ç›‘å¬åœ°å€ä¸º zabbix_serverï¼Œä¸”ç›‘å¬æ–¹å¼ä¸º dns</li></ol><p>æœ€ç»ˆä¿®æ”¹å®Œå¦‚ä¸‹ï¼š</p><p><img src="/posts/25f36846/image-20200901175159400.png" alt="image-20200901175159400"></p><h2 id="zabbix-agent">zabbix-agent</h2><blockquote><p><a href="https://hub.docker.com/r/zabbix/zabbix-agent">https://hub.docker.com/r/zabbix/zabbix-agent</a></p></blockquote><pre><code class="language-bash">docker volume create zbAgentEtcdocker run --name zabbix_agent \--network=container:zabbix_server \--mount 'type=volume,src=zbAgentEtc,dst=/etc/zabbix/zabbix_agentd.d' \-e ZBX_DEBUGLEVEL=&quot;3&quot; \-e ZBX_HOSTNAME=&quot;zabbix_server&quot; \-e ZBX_SERVER_HOST=&quot;zabbix_server&quot; \-d zabbix/zabbix-agent:latest</code></pre><p>è¿™é‡Œ zabbix_agent é‡‡ç”¨ç½‘ç»œæ¨¡å¼ä¸ºå®¹å™¨æ¨¡å¼ï¼Œå¹¶åŠ å…¥åˆ° zabbix_server å®¹å™¨ä¸­ï¼Œä»¥ä¾¿äº zabbix_server å¯ä»¥æ‰¾åˆ° zabbix_agent</p><p>å…¶å®ƒé…ç½®å˜é‡è¯¦è§ä¸Šé¢å®˜æ–¹æ–‡æ¡£</p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜ç¦»çº¿è¿ç§»è„šæœ¬</title>
      <link href="posts/c83ca575/"/>
      <url>posts/c83ca575/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash">databases=&quot;&quot;mysqltonew()&#123;    olddatabasehost=    olddatabaseport=    olddatabase=$1    oldUserName=    oldpassword=    newdatabasehost=    newolddatabaseport=    newdatabase=$&#123;olddatabase&#125;    newUserName=    newpassword=    # utf8 / utf8mb4    read -p &quot;character [utf8/utf8mb4/latin1]:&quot; Character    # å¯¼å‡ºè€åº“    mysqldump -u$&#123;oldUserName&#125; -p$&#123;oldpassword&#125; -h$&#123;olddatabasehost&#125; -P$&#123;olddatabaseport&#125; --default-character-set=$&#123;Character&#125; --single-transaction $&#123;olddatabase&#125; &gt; $&#123;olddatabase&#125;.sql    # åˆ›å»ºæ–°åº“    mysql -u$&#123;newUserName&#125; -p$&#123;newpassword&#125; -h$&#123;newdatabasehost&#125; -P$&#123;newolddatabaseport&#125; -e &quot;CREATE DATABASE $&#123;newdatabase&#125; DEFAULT CHARSET $&#123;Character&#125; COLLATE $&#123;Character&#125;_general_ci;&quot;    # å¯¼å…¥æ–°åº“    mysql -u$&#123;newUserName&#125; -p$&#123;newpassword&#125; -h$&#123;newdatabasehost&#125; -P$&#123;newolddatabaseport&#125; --default-character-set=$&#123;Character&#125; $&#123;newdatabase&#125; &lt; $&#123;olddatabase&#125;.sql&#125;for i in $&#123;databases&#125;;do        echo &quot;start $i&quot;        mysqltonew $idone</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> mysqldump </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜04podé’©å­å‡½æ•°</title>
      <link href="posts/3ec72f7e/"/>
      <url>posts/3ec72f7e/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æˆ‘ä»¬åœ¨å®é™…å·¥ä½œä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°å®¹å™¨ç¨‹åºçš„å‡†å¤‡å·¥ä½œï¼Œä»¥åŠå®¹å™¨ç»“æŸä¹‹å‰çš„å¤„ç†å·¥ä½œã€‚æ¯”å¦‚ï¼Œå®¹å™¨å¼€å§‹ä¹‹å‰ä¸‹è½½ä¸€äº›åŒ…ï¼Œæˆ–è€…å®¹å™¨ç»“æŸä¹‹å‰ä¸Šä¼ æ—¥å¿—ç­‰ã€‚</p><p>k8s ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªå‡½æ•°ç”¨äºå¤„ç†è¿™äº›å·¥ä½œï¼Œåˆ†åˆ«æ˜¯ postStartå’Œ preStop</p><h2 id="postStart">postStart</h2><ol><li>å®ƒå°†åœ¨å®¹å™¨åˆ›å»ºåç«‹å³è¿è¡Œï¼Œä½†ä¸ä¿è¯åœ¨ ENTRYPOINT ä¹‹å‰è¿è¡Œ</li><li>å®ƒæ˜¯åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå®ƒå¡ä½ï¼Œpod æ— æ³•è¾¾åˆ° running çŠ¶æ€</li><li>å®ƒä½äºå®¹å™¨ lifecycle ä¸­</li></ol><p>ç¤ºä¾‹ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: poststart-testspec:  containers:  - name: poststart-test    image: nginx    lifecycle:      postStart:        exec:          command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo This is postStart-test &gt; /usr/share/nginx/html/index.html&quot;]</code></pre><pre><code class="language-bash">[root@k8s00 ~]# kubectl apply -f poststart-test.yamlpod/poststart-test created[root@k8s00 ~]# kubectl get pod -o wideNAME             READY   STATUS              RESTARTS   AGE   IP       NODE    NOMINATED NODE   READINESS GATESpoststart-test   0/1     ContainerCreating   0          7s    &lt;none&gt;   k8s02   &lt;none&gt;           &lt;none&gt;[root@k8s00 ~]# kubectl get pod -o wideNAME             READY   STATUS    RESTARTS   AGE   IP          NODE    NOMINATED NODE   READINESS GATESpoststart-test   1/1     Running   0          10s   10.97.2.6   k8s02   &lt;none&gt;           &lt;none&gt;[root@k8s00 ~]# curl 10.97.2.6This is postStart-test</code></pre><h2 id="preStop">preStop</h2><ol><li>å®ƒå°†åœ¨å®¹å™¨ç»“æŸä¹‹å‰è¿è¡Œ</li><li>å®ƒæ˜¯åŒæ­¥çš„ï¼Œå¦‚æœå®ƒå¡ä½ï¼Œpod å°†åœç•™åœ¨ running çŠ¶æ€ï¼Œæ— æ³•è¾¾åˆ° failed çŠ¶æ€</li><li>å®ƒä½äºå®¹å™¨ lifecycle ä¸­</li></ol><p>ç¤ºä¾‹ï¼š</p><pre><code class="language-yaml">apiVersion: v1kind: Podmetadata:  name: prestop-testspec:  containers:  - name: prestop-test    image: nginx    volumeMounts:    - name: prestop-test-tmp      mountPath: /usr/share    lifecycle:      preStop:        exec:          command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;echo This is preStop &gt; /usr/share/message&quot;]  volumes:  - name: prestop-test-tmp    hostPath:      path: /tmp</code></pre><pre><code class="language-bash">[root@k8s00 ~]# kubectl delete pod prestop-test# è¿™é‡Œ prestop-test è¢«è°ƒåº¦åˆ° k8s02[root@k8s02 ~]# cat /tmp/messageThis is preStop</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜03pod</title>
      <link href="posts/94518966/"/>
      <url>posts/94518966/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>pod å¯ä»¥è¯´æ˜¯ k8s çš„åŸºç¡€å•å…ƒ. æˆ‘è§‰å¾—å¯ä»¥ç±»æ¯”äº‘ç¯å¢ƒçš„ecs/ec2è¿™ä¸€ç±»çš„åŸºæœ¬è®¡ç®—å•å…ƒ.è€Œ pod ä¸Šè¿è¡Œçš„å®¹å™¨, å¯ä»¥ç±»æ¯”ä¸ºecs/ec2ä¸Šçš„appç¨‹åº.</p><p>ä½ æ€»èƒ½åœ¨k8sçš„å„ç±»èµ„æºä¸­æ‰¾åˆ°äº‘ç¯å¢ƒå¯¹åº”çš„èµ„æºå½±å­. å¦‚æœä½ ç”¨è¿‡GCP,ä½ ä¼šæ›´æœ‰è¿™ç§æ„Ÿè§‰.</p><p><a href="https://kubernetes.io/docs/concepts/workloads/pods/">https://kubernetes.io/docs/concepts/workloads/pods/</a></p><h2 id="Pod-ä¸-æ§åˆ¶å™¨">Pod ä¸ æ§åˆ¶å™¨</h2><p>pod ä¸€èˆ¬ä¸å•ç‹¬ä½¿ç”¨, å› ä¸ºå•ç‹¬ä½¿ç”¨æ„å‘³ç€æ²¡æœ‰é«˜å¯ç”¨.k8så»ºè®® pod è¦å§‹ç»ˆå’Œæ§åˆ¶å™¨ä¸€èµ·ä½¿ç”¨. ä½ å¯ä»¥è®¤ä¸ºæ§åˆ¶å™¨å°±å¦‚åŒäº‘ç¯å¢ƒä¸­çš„èµ„æºç›®æ ‡ç»„.è¿™ä¸ªæ¦‚å¿µçš„å®é™…å¯¹è±¡ä¸€èˆ¬æ˜¯äºè´Ÿè½½å‡è¡¡æœåŠ¡çš„ç¼©æ”¾ç»„æ¦‚å¿µ. ä¾‹å¦‚awsçš„auto scaling.</p><p>k8så°†appæ§åˆ¶å™¨åˆ†ä¸ºä¸‰ç§:</p><ul><li>Deployment æ— çŠ¶æ€ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></li><li>StatefulSet æœ‰çŠ¶æ€ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/</a></li><li>DaemonSet å®ˆæŠ¤æ€ <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</a></li></ul><p>è¿˜æœ‰CronJobè¿™ç±»è®¡åˆ’ä»»åŠ¡ç±»å‹çš„.</p><p>è¿™é‡Œæˆ‘ä»¬ä¸è¯´æ§åˆ¶å™¨å¦‚ä½•ç”¨. ä½†æ˜¯ä½ å¯ä»¥è‡ªè¡Œäº†è§£.</p><p>æ§åˆ¶å™¨æ—¢ç„¶ç±»åŒäº‘æœåŠ¡çš„ç¼©æ”¾ç»„æ¦‚å¿µ. é‚£ä¹ˆå®ƒå¿…ç„¶éœ€è¦ä¾æ‰˜äºé•œåƒæ¨¡æ¿å’Œç¼©æ”¾è§„åˆ™.</p><p>é•œåƒæ¨¡æ¿åœ¨k8sä¸­å« pod æ¨¡æ¿(pod template).</p><h2 id="Pod-æ¨¡æ¿">Pod æ¨¡æ¿</h2><p>ç‰¹ç‚¹:</p><ul><li>æ¨¡æ¿ä¿®æ”¹ä¼šå¯¼è‡´é‡å»ºæ–°çš„pod, å¹¶ç»ˆæ­¢ç°æœ‰pod.</li></ul><p>ä¾‹å­:</p><pre><code class="language-yaml">apiVersion: batch/v1beta1kind: CronJobmetadata:  name: hellospec:  schedule: &quot;*/1 * * * *&quot;  jobTemplate:    spec:      template:   ## ä»è¿™é‡Œå¼€å§‹, ä»¥ä¸‹å†…å®¹å°±æ˜¯ Pod æ¨¡æ¿.        spec:          containers:          - name: hello            image: busybox            args:            - /bin/sh            - -c            - date; echo Hello from the Kubernetes cluster          restartPolicy: OnFailure</code></pre><h2 id="Pod-å­˜å‚¨-ç½‘ç»œ">Pod å­˜å‚¨/ç½‘ç»œ</h2><h3 id="pod-å­˜å‚¨">pod å­˜å‚¨</h3><p>è¿™æ˜¯ä¸€ä¸ªå¤§é—®é¢˜. å¦‚æœä½ æƒ³çœŸæ­£çš„ä½¿ç”¨k8sçš„podèµ„æº, é‚£ä¹ˆéœ€è¦å…ˆçœ‹è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹.</p><p>ç®€å•æ¥è¯´, å­˜å‚¨èµ„æºä¸»è¦åˆ†ç½‘ç»œå’Œæœ¬åœ°ä¸¤å¤§ç±».</p><p>æœ¬åœ°è¿™ä¸€ç±»ä¸€èˆ¬ç”¨äºä¸´æ—¶æˆ–è€…ç‰¹æ®Šç¯å¢ƒ. å°±å¦‚åŒäº‘æœåŠ¡ä¸­çš„å­˜å‚¨ç±»èŠ‚ç‚¹é‡Œçš„é‚£ç§æœ¬åœ°ç›˜, å®ƒä¸å¯é . å› ä¸ºpodæœ¬èº«é»˜è®¤æ˜¯ä¸å¼ºåˆ¶ç»‘å®šæŸä¸ªèŠ‚ç‚¹çš„,å› æ­¤å¦‚æœä½ podå¼‚å¸¸äº†,é‚£ä¹ˆå®ƒæœ‰å¯èƒ½é‡å»ºçš„æ—¶å€™æ¼‚ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹.</p><p>ç½‘ç»œè¿™ä¸€ç±»,å¯ä»¥å¯¹æ¥çš„æœ‰äº‘æœåŠ¡å‚å®¶çš„å­˜å‚¨èµ„æº,ä¹Ÿå¯ä»¥å¯¹æ¥è‡ªå»ºçš„nfsè¿™ä¸€ç±»ç½‘ç»œå­˜å‚¨.</p><p>ç»†è‡´çš„è¯´æ˜, å‚è€ƒå®˜æ–¹æ–‡æ¡£https://kubernetes.io/docs/concepts/storage/</p><h3 id="pod-ç½‘ç»œ">pod ç½‘ç»œ</h3><p>é‰´äºå‰é¢æåˆ°çš„podç±»åŒäºecs/ec2. å› æ­¤. podä¸­çš„å®¹å™¨éƒ½æ˜¯å…±äº«ç½‘ç»œçš„.æ‰€ä»¥è¿™äº›å®¹å™¨éƒ½æœ‰ç›¸åŒçš„ip, ç«¯å£èŒƒå›´, ä¸»æœºå.</p><p>k8sçš„ç½‘ç»œåŸºäºå„ç§æ’ä»¶.æ¯ä¸€ç§æ’ä»¶çš„å®ç°è¯¦æƒ…è§å®˜ç½‘. <a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model">https://kubernetes.io/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model</a></p><p>å¦‚æœä½ æ˜¯æœ¬åœ°æ­å»º, é‚£ä¹ˆå¸¸ç”¨çš„æ’ä»¶æ˜¯Flannel. å¦‚æœä½ æ˜¯åœ¨äº‘æœåŠ¡ä¸Šæ­å»º,é‚£ä¹ˆå»ºè®®ä½¿ç”¨äº‘æœåŠ¡å·²æœ‰çš„k8sæœåŠ¡.</p><p>å¦‚æœä½ å¿…é¡»åœ¨äº‘æœåŠ¡ä¸Šè‡ªå·±æ­å»º,é‚£ä¹ˆaws/azure/gcpéƒ½æœ‰å¯¹åº”çš„ç½‘ç»œæ’ä»¶.å®ƒå¯ä»¥è®©ä½ åœ¨k8sä¸­ç»“åˆä½¿ç”¨äº‘æœåŠ¡çš„ç½‘ç»œç»„ä»¶.</p><h2 id="é™æ€pod">é™æ€pod</h2><p>ç‰¹ç‚¹ï¼š</p><ol><li>æ°¸è¿œè¿è¡Œåœ¨å›ºå®šèŠ‚ç‚¹</li><li>ç”±æ‰€åœ¨èŠ‚ç‚¹çš„kubeletç®¡ç†ï¼Œä½†åªè´Ÿè´£ä¿æ´»ï¼Œå³podå´©æºƒé‡ç”Ÿ</li><li>kubeletä¼šè®©apiserveråˆ›å»ºä¸€ä¸ªé•œåƒpodï¼Œä¾¿äºå¯ä»¥é€šè¿‡kubectlæŸ¥è¯¢åˆ°é™æ€pod</li></ol><p>é…ç½®ï¼š</p><ol><li>å­˜æ”¾åœ¨ /etc/kubernetes/manifests å½“é‡‡ç”¨kubeadmå®‰è£…çš„æ—¶å€™ï¼Œä¸€èˆ¬ä½äºæ­¤ç›®å½•ã€‚å…·ä½“éœ€è¦å»çœ‹kubeleté…ç½®ã€‚</li><li>é…ç½®æœ¬èº«å¯ä»¥æŒ‰ç…§æ ‡å‡†podæ–¹å¼æ¥åˆ›å»º</li></ol><p>æ£€æµ‹ï¼š</p><ol><li>kubeletä¼šå®šæœŸæ£€æµ‹é…ç½®ç›®å½•åŠ è½½é…ç½®åˆ›å»º/é‡å»ºpod</li></ol><blockquote><p>å½“ä½ é€šè¿‡kubeadmåˆ›å»ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆk8sçš„å‡ ä¸ªé‡è¦ç»„ä»¶å‡ä¼šä»¥é™æ€podçš„æ–¹å¼åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œä½ å¯ä»¥åœ¨/etc/kubernetes/manifests/è¿™é‡Œæ‰¾åˆ°ä»–ä»¬çš„é…ç½®</p></blockquote><pre><code class="language-bash">[root@k8s00 ~]# ll /etc/kubernetes/manifests/total 16-rw------- 1 root root 1848 Aug 25 16:28 etcd.yaml-rw------- 1 root root 2709 Aug 25 16:28 kube-apiserver.yaml-rw------- 1 root root 2564 Aug 25 16:33 kube-controller-manager.yaml-rw------- 1 root root 1120 Aug 25 16:33 kube-scheduler.yaml</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜02v1.18.6å®‰è£…</title>
      <link href="posts/9602dad/"/>
      <url>posts/9602dad/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ï¼Œå®˜æ–¹å·²ç»åˆ°äº†1.18.8ï¼Œä½†æ˜¯é‰´äºå›½å†…ç¯å¢ƒï¼Œéå®˜æ–¹æºæ²¡æ‰¾åˆ°1.18.8ï¼Œæ‰€ä»¥æœ€åç”¨çš„1.18.6<br>å¦å¤–ï¼Œæ–‡ä¸­å‡ºç°çš„å®¿ä¸»æœºipï¼Œè¯·è‡ªè¡Œä¿®æ”¹ä¸ºè‡ªå·±çš„ç¯å¢ƒip</p><h2 id="æœºå™¨">æœºå™¨</h2><p>æœºå™¨ç³»ç»Ÿéƒ½æ˜¯ centos7,</p><p>ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå‡ä¸ºä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å·¥ä½œèŠ‚ç‚¹ï¼Œå¹¶åˆ©ç”¨ keepalived + haproxy è¿›è¡Œé«˜å¯ç”¨</p><table><thead><tr><th>hostname</th><th>ip</th><th>type</th></tr></thead><tbody><tr><td>k8sapi</td><td>10.200.16.100</td><td>vip</td></tr><tr><td>k8s01</td><td>10.200.16.101</td><td>master</td></tr><tr><td>k8s02</td><td>10.200.16.102</td><td>master backup</td></tr><tr><td>k8s03</td><td>10.200.16.103</td><td>master backup</td></tr></tbody></table><p>è¯·åŠ¡å¿…ç¡®ä¿å†…ç½‘å¯ä»¥é€šè¿‡è¡¨æ ¼é‡Œçš„ <code>hostname</code> è§£æåˆ°å¯¹åº”çš„ <code>ip</code></p><p>è¯·åŠ¡å¿…å°†ç³»ç»Ÿçš„ hostname æ”¹ä¸ºä¸Šè¿°è¡¨é‡Œçš„ hostname</p><h2 id="ä»¥ä¸‹å‘½ä»¤åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ">ä»¥ä¸‹å‘½ä»¤åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ</h2><ol><li><p>æ—¶é—´åŒæ­¥</p><pre><code class="language-bash">yum install chrony -ysed -i  '1a server cn.pool.ntp.org prefer iburst' /etc/chrony.confsystemctl restart chronydsystemctl enable chronydchronyc activity</code></pre></li><li><p>ç³»ç»Ÿé…ç½®</p><pre><code class="language-bash"># åŠ è½½æ¨¡å—modprobe overlaymodprobe br_netfilter# æ·»åŠ é…ç½®cat &gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-iptables  = 1net.ipv4.ip_forward                 = 1net.bridge.bridge-nf-call-ip6tables = 1EOF# é…ç½®ç”Ÿæ•ˆsysctl --system# æ¸…ç©ºé˜²ç«å¢™systemctl stop firewalld.service iptables.servicesystemctl disable firewalld.servicesystemctl disable iptables.service;iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X# å…³é—­selinuxsetenforce 0sed -i 's@^\(SELINUX=\).*@\1disabled@' /etc/sysconfig/selinuxsed -i 's@^\(SELINUX=\).*@\1disabled@' /etc/selinux/config# å…³é—­ swapï¼Œkubelet 1.18 è¦æ±‚.å¦‚æœä½ fstabä¹Ÿæœ‰ï¼Œè¯·ä¸€å¹¶æ³¨é‡Šswapoff -a# å®‰è£… ipvsyum install ipvsadm -yipvsadm --clearcat&gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt; 'EOF'ipvs_mods_dir=&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;for i in $(ls $ipvs_mods_dir | grep -o &quot;^[^.]*&quot;); do    /sbin/modinfo -F filename $i  &amp;&gt; /dev/null    if [ $? -eq 0 ]; then        /sbin/modprobe $i    fidoneEOFchmod +x /etc/sysconfig/modules/ipvs.modules/etc/sysconfig/modules/ipvs.modules</code></pre></li><li><p>å®‰è£… docker</p><blockquote><p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker</a></p></blockquote><pre><code class="language-bash">yum install -y yum-utils \  device-mapper-persistent-data \  lvm2yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repoyum list docker-ce --showduplicates | sort -r# å®‰è£…å…¼å®¹k8sçš„dockerç‰ˆæœ¬yum install -y \  containerd.io-1.2.13 \  docker-ce-19.03.11 \  docker-ce-cli-19.03.11#sed -i '/ExecStart=/a ExecStartPort=/usr/sbin/iptables -P FORWARD ACCEPT' /usr/lib/systemd/system/docker.service;mkdir -p /etc/docker;cat &gt; /etc/docker/daemon.json &lt;&lt;EOF&#123;  &quot;data-root&quot;: &quot;/export/docker-data-root&quot;,  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],  &quot;log-driver&quot;: &quot;json-file&quot;,  &quot;log-opts&quot;: &#123;    &quot;max-size&quot;: &quot;100m&quot;  &#125;,  &quot;storage-driver&quot;: &quot;overlay2&quot;,  &quot;storage-opts&quot;: [    &quot;overlay2.override_kernel_check=true&quot;  ]&#125;EOFmkdir -p /etc/systemd/system/docker.service.dsystemctl daemon-reloadsystemctl restart dockersystemctl enable docker</code></pre></li><li><p>å®‰è£… kubelet kubeadm kubectl</p><blockquote><p>é˜¿é‡Œå·´å·´é•œåƒç‚¹ï¼š</p><p><a href="https://developer.aliyun.com/mirror/kubernetes">https://developer.aliyun.com/mirror/kubernetes</a></p></blockquote></li></ol><blockquote><p>google å®˜æ–¹å®‰è£…æ–‡æ¡£ <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p></blockquote><pre><code class="language-bash">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearchenabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpgexclude=kubelet kubeadm kubectlEOF# ç¡®å®š kube* ç‰ˆæœ¬yum list kube* --showduplicates --disableexcludes=kubernetes# é€‰æ‹©è¦å®‰è£…çš„ç‰ˆæœ¬Version=1.18.6# å®‰è£… kube ç®¡ç†ç»„ä»¶å’Œ kubeletyum install -y kubelet-$&#123;Version&#125; kubeadm-$&#123;Version&#125; kubectl-$&#123;Version&#125; --disableexcludes=kubernetessystemctl enable --now kubelet</code></pre><blockquote><p>kubelet 1.18 çš„æ—¶å€™ï¼Œå½“ä½ ä½¿ç”¨ docker çš„æ—¶å€™ï¼Œkubeadm ä¼šé€šè¿‡ kubelet è‡ªåŠ¨è®¾ç½® cgroup å’Œ docker ä¸€è‡´ã€‚</p></blockquote><h2 id="masterèŠ‚ç‚¹">masterèŠ‚ç‚¹</h2><h3 id="å®‰è£…é«˜å¯ç”¨ç¯å¢ƒï¼ˆk8s01ï¼Œk8s02ï¼Œk8s03ï¼‰">å®‰è£…é«˜å¯ç”¨ç¯å¢ƒï¼ˆk8s01ï¼Œk8s02ï¼Œk8s03ï¼‰</h3><ul><li>å®‰è£…haproxyå’Œkeepalived</li></ul><pre><code class="language-bash">yum install haproxy keepalived -y</code></pre><ul><li>haproxyé…ç½®</li></ul><pre><code class="language-bash">cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.defaultvim /etc/haproxy/haproxy.cfg===global    log /dev/log local0    log /dev/log local1 notice    daemondefaults    mode                    http    log                     global    option                  httplog    option                  dontlognull    option http-server-close    option forwardfor       except 127.0.0.0/8    option                  redispatch    retries                 1    timeout http-request    10s    timeout queue           20s    timeout connect         5s    timeout client          20s    timeout server          20s    timeout http-keep-alive 10s    timeout check           10sfrontend apiserver    bind *:8443    mode tcp    option tcplog    default_backend apiserverbackend apiserver    option httpchk GET /healthz    http-check expect status 200    mode tcp    option ssl-hello-chk    balance     roundrobin        server k8sapivip 10.200.16.101:6443 check        server k8sapivip 10.200.16.102:6443 check        server k8sapivip 10.200.16.103:6443 check</code></pre><ul><li>keepalivedé…ç½®A ï¼ˆè¿™ä¸ªé…ç½®åœ¨ä¸‰ä¸ªmasterèŠ‚ç‚¹ä¸ä¸€æ ·ï¼‰</li></ul><pre><code class="language-bash">cp /etc/keepalived/keepalived.conf  /etc/keepalived/keepalived.conf.defaultvim /etc/keepalived/keepalived.conf===global_defs &#123;    router_id LVS_DEVEL&#125;vrrp_script check_apiserver &#123;  script &quot;/etc/keepalived/check_apiserver.sh&quot;  interval 3  weight -2  fall 10  rise 2&#125;vrrp_instance VI_1 &#123;    state MASTER  # æ”¹æˆ‘æ”¹æˆ‘ï¼šä¸€ä¸ªMASTERï¼Œä¸¤ä¸ªBACKUP    interface ens192  # ç‰©ç†ç½‘å¡å    virtual_router_id 51    priority 101  # æ”¹æˆ‘æ”¹æˆ‘ï¼šMASTER 101ï¼Œä¸¤ä¸ªBACKUP 100    authentication &#123;        auth_type PASS        auth_pass 42    &#125;    virtual_ipaddress &#123;        10.200.16.100    &#125;    track_script &#123;        check_apiserver    &#125;&#125;</code></pre><ul><li>keepalivedé…ç½®Bï¼šæ£€æµ‹è„šæœ¬</li></ul><pre><code class="language-bash">vim /etc/keepalived/check_apiserver.sh===#!/bin/sherrorExit() &#123;    echo &quot;*** $*&quot; 1&gt;&amp;2    exit 1&#125;APISERVER_VIP=10.200.16.100APISERVER_DEST_PORT=6443curl --silent --max-time 2 --insecure https://localhost:$&#123;APISERVER_DEST_PORT&#125;/ -o /dev/null || errorExit &quot;Error GET https://localhost:$&#123;APISERVER_DEST_PORT&#125;/&quot;if ip addr | grep -q $&#123;APISERVER_VIP&#125;; then    curl --silent --max-time 2 --insecure https://$&#123;APISERVER_VIP&#125;:$&#123;APISERVER_DEST_PORT&#125;/ -o /dev/null || errorExit &quot;Error GET https://$&#123;APISERVER_VIP&#125;:$&#123;APISERVER_DEST_PORT&#125;/&quot;fichmod a+x /etc/keepalived/check_apiserver.sh</code></pre><ul><li>å¯åŠ¨keepalivedå’Œhaproxy</li></ul><pre><code class="language-bash">systemctl start keepalived haproxysystemctl enable keepalived haproxy</code></pre><h3 id="æ‹‰å–å®¹å™¨é•œåƒï¼ˆk8s01ï¼Œk8s02ï¼Œk8s03ï¼‰">æ‹‰å–å®¹å™¨é•œåƒï¼ˆk8s01ï¼Œk8s02ï¼Œk8s03ï¼‰</h3><blockquote><p>é‰´äºç½‘ç»œé—®é¢˜ï¼Œæ‰€ä»¥å›½å†…ä¸€èˆ¬æ— æ³•ç›´æ¥è¿è¡Œåˆå§‹åŒ–å‘½ä»¤ï¼Œå› æ­¤æœ€å¥½å…ˆè‡ªè¡Œå®‰è£…å¥½åŒ…</p></blockquote><pre><code class="language-bash"># æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬ k8s æ‰€éœ€åŒ…kubeadm config images list --kubernetes-version=$&#123;Version&#125;# è¿è¡Œä¸‹åˆ—è„šæœ¬å®‰è£…æ‰€éœ€çš„åŒ…# ---------------------æˆ‘æ˜¯è„šæœ¬å¼€å¤´--------------------#!/bin/bash# kubeadm config images listimages=(kube-apiserver:v$&#123;Version&#125;kube-controller-manager:v$&#123;Version&#125;kube-scheduler:v$&#123;Version&#125;kube-proxy:v$&#123;Version&#125;pause:3.2etcd:3.4.3-0coredns:1.6.7)for imageName in $&#123;images[@]&#125;;do    docker pull registry.aliyuncs.com/google_containers/$&#123;imageName&#125;    docker tag registry.aliyuncs.com/google_containers/$&#123;imageName&#125; k8s.gcr.io/$&#123;imageName&#125;    docker rmi registry.aliyuncs.com/google_containers/$&#123;imageName&#125;done# ---------------------æˆ‘æ˜¯è„šæœ¬ç»“å°¾--------------------# å¦‚æœæŸäº›åŒ…æ— æ³•ä¸‹è½½ï¼Œåˆ™éœ€è‡ªè¡Œå» dockerhub ä¸Šæ‰¾ï¼Œå¹¶åœ¨ä¸‹è½½å®Œæ¯•åï¼Œæ·»åŠ  k8s è‡ªå·±çš„ tagsï¼Œä¾‹å¦‚ coredns# docker pull coredns/coredns:1.6.7 # docker tag coredns/coredns:1.6.7 k8s.gcr.io/coredns:1.6.7# docker rmi coredns/coredns:1.6.7</code></pre><h3 id="åˆå§‹åŒ–å®‰è£…ï¼ˆk8s01ï¼‰">åˆå§‹åŒ–å®‰è£…ï¼ˆk8s01ï¼‰</h3><p>(info: <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/%EF%BC%89">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/ï¼‰</a></p><p>é‡‡å–é…ç½®æ–‡ä»¶å®‰è£…æ¨¡å¼</p><pre><code class="language-bash">kubeadm config print init-defaults &gt; kubeadm.yaml.defaultcat &gt; kubeadm.yaml &lt;&lt; EOF# kubeadm.yaml å°†é»˜è®¤çš„é…ç½®è¿›è¡Œä¿®æ”¹apiVersion: kubeadm.k8s.io/v1beta2bootstrapTokens:- groups:  - system:bootstrappers:kubeadm:default-node-token  token: abcdef.8272827282sksksu   # æ”¹æˆ‘ï¼Œæ”¹æˆä½ è‡ªå·±éšæ„çš„å­—ç¬¦ä¸²  ttl: 24h0m0s  usages:  - signing  - authenticationkind: InitConfigurationlocalAPIEndpoint:  advertiseAddress: 10.200.16.101  # æ”¹æˆ‘ï¼Œæ”¹æˆé…ç½®æ‰€åœ¨èŠ‚ç‚¹çš„ç‰©ç†ip  bindPort: 6443nodeRegistration:  criSocket: /var/run/dockershim.sock  name: k8s01 # æ”¹æˆ‘ï¼Œç†è®ºä¸Šå®ƒä¼šè‡ªåŠ¨è·å–é…ç½®æ‰€åœ¨èŠ‚ç‚¹çš„ hostname  taints:  - effect: NoSchedule    key: node-role.kubernetes.io/master---apiServer:  timeoutForControlPlane: 4m0sapiVersion: kubeadm.k8s.io/v1beta2certificatesDir: /etc/kubernetes/pkiclusterName: kubernetescontrollerManager: &#123;&#125;controlPlaneEndpoint: &quot;k8sapi:8443&quot; # æ–°åŠ æˆ‘dns:  type: CoreDNSetcd:  local:    dataDir: /var/lib/etcdimageRepository: k8s.gcr.iokind: ClusterConfigurationkubernetesVersion: v1.19.3 # æ”¹æˆ‘ï¼Œæ”¹æˆä½ æ‰€éœ€å®‰è£…çš„ç‰ˆæœ¬networking:  dnsDomain: cluster.local  serviceSubnet: 10.96.0.0/16 # æ”¹æˆ‘ï¼Œå®šä¹‰ svc çš„ç½‘æ®µ  podSubnet: 10.97.0.0/16 # æ”¹æˆ‘ï¼Œå®šä¹‰ pod çš„ç½‘æ®µscheduler: &#123;&#125;--- # æ–°åŠ æˆ‘apiVersion: kubeproxy.config.k8s.io/v1alpha1 # æ–°åŠ æˆ‘kind: KubeProxyConfiguration # æ–°åŠ æˆ‘mode: ipvs  # æ–°åŠ æˆ‘EOF# è¿›è¡Œåˆå§‹åŒ–kubeadm init --config kubeadm.yaml# è®°å½•åˆå§‹åŒ–ç”Ÿæˆçš„å‘½ä»¤ï¼Œç‰¹åˆ«æ˜¯ kubeadm join</code></pre><p>é…ç½®é€šè¿‡kubectlè®¿é—®é›†ç¾¤</p><pre><code class="language-bash">mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config# kubectl å‘½ä»¤è¡¥å…¨source &lt;(kubectl completion bash)# You should now deploy a pod network to the cluster.# Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:# https://kubernetes.io/docs/concepts/cluster-administration/addons/</code></pre><pre><code class="language-bash"># æ·»åŠ ç”¨æˆ·ä¸Šä¸‹æ–‡åˆ°é…ç½®é‡Œï¼Œæ–¹ä¾¿åˆ‡æ¢ç”¨æˆ·kubectl config set-context admin --cluster=kubernetes --user=kubernetes-admin</code></pre><p>è°ƒæ•´ kube-controller-manager å’Œ scheduler çš„é…ç½®.</p><pre><code class="language-bash"># æ£€æŸ¥çŠ¶æ€kubectl get cs# ä½ å¯èƒ½ä¼šå‘ç°,å‡ºç°æœåŠ¡è¿æ¥æ‹’ç»é—®é¢˜controller-manager   Unhealthy   Get http://127.0.0.1:10252/healthz: dial tcp 127.0.0.1:10252: connect: connection refusedscheduler            Unhealthy   Get http://127.0.0.1:10251/healthz: dial tcp 127.0.0.1:10251: connect: connection refused# åŸå› æ˜¯è¿™ä¸¤ä¸ªæœåŠ¡é…ç½®é»˜è®¤ç«¯å£æ˜¯0ã€‚è‡³äºä¸ºå•¥å°±ä¸æ™“å¾—äº†# ä½ éœ€è¦æ³¨é‡Šæ‰ä¸¤ä¸ªé…ç½®é‡Œçš„ç«¯å£ï¼ˆ- --port=0ï¼‰ï¼Œæ¢å¤ä¸ºé»˜è®¤ç«¯å£sed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-scheduler.yamlsed -i '/- --port=0/d' /etc/kubernetes/manifests/kube-controller-manager.yaml# é‡å¯ kubeletsystemctl restart kubelet# å†æ¬¡æ£€æŸ¥kubectl get cs===NAME                 STATUS    MESSAGE             ERRORscheduler            Healthy   okcontroller-manager   Healthy   oketcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</code></pre><p>é…ç½®ç½‘ç»œæ’ä»¶ï¼Œç½‘ç»œæ’ä»¶å¸¸ç”¨çš„æœ‰ä¸¤ç§ï¼Œ</p><p>ç¬¬ä¸€ç§æ˜¯ flannelï¼Œæ¶‰åŠåˆ°æ›´å¤šçš„ iptables è§„åˆ™</p><p>ç¬¬äºŒç§æ˜¯ calicoï¼Œæ¶‰åŠåˆ°æ›´å¤šçš„è·¯ç”±è§„åˆ™</p><ul><li>flannel (æœ¬æ–‡æ¡£é€‰ç”¨çš„æ’ä»¶)</li></ul><blockquote><p><a href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a> ä»£ç æ‰˜ç®¡åœ°å€</p></blockquote><pre><code class="language-bash">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml# ä¿®æ”¹é‡Œé¢çš„ &quot;Network&quot;: &quot;10.244.0.0/16&quot;, å˜æ›´ä¸ºä½ è‡ªå·±çš„ pod ç½‘æ®µï¼Œå³kubeadmåˆå§‹åŒ–é˜¶æ®µçš„ --pod-network-cidrkubectl apply -f  kube-flannel.yml</code></pre><ul><li>calico</li></ul><blockquote><p><a href="https://docs.projectcalico.org/getting-started/kubernetes/quickstart">https://docs.projectcalico.org/getting-started/kubernetes/quickstart</a> å®‰è£…æ–‡æ¡£</p></blockquote><pre><code class="language-bash">kubectl apply -f https://docs.projectcalico.org/manifests/tigera-operator.yamlwget https://docs.projectcalico.org/manifests/custom-resources.yaml# custom-resources.yaml ä¿®æ”¹é‡Œé¢çš„ç½‘ç»œä¸º pod ç½‘æ®µkubectl apply -f custom-resources.yaml</code></pre><blockquote><p>æ³¨æ„ï¼Œå½“ä½ ä½¿ç”¨äº† calico åï¼Œ ä¼šç”Ÿæˆä¸€äº› cni çš„é…ç½®ï¼Œè¿™äº›é…ç½®ä¼šå¯¼è‡´ä½ è¿”å› flannel çš„æ—¶å€™å‡ºç°é—®é¢˜ã€‚ä¾‹å¦‚æ— æ³•åˆ›å»º cni</p><p>ä½ å¯ä»¥ä½¿ç”¨ find / -name â€˜*calico*â€™ æ‰¾åˆ°æ‰€æœ‰ä¿¡æ¯ï¼Œç„¶åéƒ½åˆ é™¤</p></blockquote><p>é»˜è®¤kubeadmå®‰è£…å®Œåï¼Œç¦æ­¢è°ƒåº¦podåˆ°masterä¸Šã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ï¼Œå…³é—­æ‰€æœ‰masterèŠ‚ç‚¹çš„ç¦æ­¢è°ƒåº¦</p><pre><code class="language-bash"> kubectl taint nodes --all node-role.kubernetes.io/master-</code></pre><p>é…ç½®webæ§åˆ¶å°</p><blockquote><p><a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a> ä»£ç æ‰˜ç®¡åœ°å€</p></blockquote><pre><code class="language-bash">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml &amp;&amp; mv recommended.yaml kubernetes-dashboard.yaml# è¿™é‡Œæˆ‘ä»¬è¦ä¿®æ”¹ä¸€äº›ä¸œè¥¿# é»˜è®¤æ§åˆ¶å°çš„ svc é…ç½®ç±»å‹ä¸æ˜¯ NodePortï¼Œè¿™ä¼šå¯¼è‡´æˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡å®¿ä¸»æœºipè®¿é—®ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ï¼Œå°† dashboard çš„ svc åŠ å…¥NodePortç±»å‹#---spec:  ports:    - port: 443      targetPort: 8443      nodePort: 30001  type: NodePort#---# è¿˜éœ€è¦ä¿®æ”¹ä¸€ä¸‹éƒ¨ç½²çš„ä½ç½®ï¼Œå¦‚æœä½ é›†ç¾¤ä¸­å·²ç»åŠ å…¥äº†å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ™ä¼šå¯¼è‡´ pod åˆ†å‘åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šã€‚è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶åˆ†å‘åˆ° master ä¸Š. æ‰¾åˆ° kind: Deployment é…ç½®ï¼Œå¹¶ä¿®æ”¹ä¸¤ä¸ª pod çš„åˆ†å‘ä½ç½®ä¸º nodeName: &lt;master èŠ‚ç‚¹ä¸»æœºå&gt;#---    spec:      nodeName: k8s00      containers:        - name: kubernetes-dashboard          image: kubernetesui/dashboard:v2.0.3              spec:      nodeName: k8s00      containers:        - name: dashboard-metrics-scraper          image: kubernetesui/metrics-scraper:v1.0.4          #---# ç„¶ååˆ›å»ºkubectl create -f kubernetes-dashboard.yaml# æ·»åŠ è®¿é—® token# å®˜æ–¹æ–‡æ¡£ï¼š https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md# é€šè¿‡ä¸‹é¢å†…å®¹åˆ›å»º kube-db-auth.yamlcat &gt; kube-db-auth.yaml &lt;&lt; EOFapiVersion: v1kind: ServiceAccountmetadata:  name: admin-user  namespace: kubernetes-dashboard---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:  name: admin-userroleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: cluster-adminsubjects:- kind: ServiceAccount  name: admin-user  namespace: kubernetes-dashboardEOFkubectl apply -f kube-db-auth.yaml# é€šè¿‡ä¸‹é¢å‘½ä»¤æ‹¿åˆ° tokenkubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '&#123;print $1&#125;')  # é€šè¿‡ https://&lt;masterip&gt;:30001 è®¿é—®</code></pre><h3 id="è·å–é›†ç¾¤åŠ å…¥å‘½ä»¤ï¼ˆk8s01ï¼‰">è·å–é›†ç¾¤åŠ å…¥å‘½ä»¤ï¼ˆk8s01ï¼‰</h3><pre><code class="language-bash"># å‘½ä»¤æ ¼å¼kubeadm join xxx:8443 \--token xxx \--discovery-token-ca-cert-hash xxx \--control-plane --certificate-key xxx</code></pre><p>æ‰¾å›å‘½ä»¤</p><pre><code class="language-bash"># æ‰¾å› tokenkubeadm token list# æ‰¾å› discovery-token-ca-cert-hashopenssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'</code></pre><p>å‘½ä»¤é‡å»º</p><pre><code class="language-bash"># åˆ›å»ºæ–°çš„ token å¹¶è¾“å‡º join å‘½ä»¤kubeadm token create --print-join-command===kubeadm join k8sapi:8443 --token h77qhb.cjj8ig4t2v15dncm     --discovery-token-ca-cert-hash sha256:b7138bb76d19d3d7baf832e46559c400f4fe544d8f0ee81a87f# åˆ›å»ºæ–°çš„ --certificate-keykubeadm init phase upload-certs --upload-certs===fd996c7c0c2047c9c10a377f25a332bf4b5b00ca</code></pre><h3 id="k8s02å’Œk8s03æ·»åŠ åˆ°é›†ç¾¤">k8s02å’Œk8s03æ·»åŠ åˆ°é›†ç¾¤</h3><pre><code class="language-bash">kubeadm join k8sapi:8443 \--token h77qhb.cjj8ig4t2v15dncm \--discovery-token-ca-cert-hash sha256:b7138bb76d19d3d7baf832e46559c400f4fe544d8f0ee81a87f \--control-plane --certificate-key fd996c7c0c2047c9c10a377f25a332bf4b5b00ca# æ ¹æ®æç¤ºï¼Œæ‰§è¡Œç›¸å…³å‘½ä»¤ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¸‹é¢çš„å‘½ä»¤mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config</code></pre><p>å¦‚æœetcdä¸­æ›¾ç»æœ‰k8s02å’Œk8s03çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œåˆ™ä½ éœ€è¦å…ˆä»etcdä¸­åˆ é™¤ï¼Œå¦åˆ™åŠ å…¥çš„æ—¶å€™ï¼Œä¼šå¡åœ¨æ£€æµ‹etcdå¤„ï¼Œå¹¶æœ€ç»ˆæŠ¥é”™.</p><p>åˆ é™¤etcdä¿¡æ¯æ–¹å¼ï¼š</p><pre><code class="language-bash"># è¾“å‡º etcd èŠ‚ç‚¹ idETCD=`docker ps|grep etcd|grep -v POD|awk '&#123;print $1&#125;'`docker exec \  -it $&#123;ETCD&#125; \  etcdctl \  --endpoints https://127.0.0.1:2379 \  --cacert /etc/kubernetes/pki/etcd/ca.crt \  --cert /etc/kubernetes/pki/etcd/peer.crt \  --key /etc/kubernetes/pki/etcd/peer.key \  member list===2f401672c9a538f1, started, k8s01, https://10.200.16.101:2380, https://10.200.16.101:2379, falsed6d9ca2a70f6638e, started, k8s02, https://10.200.16.102:2380, https://10.200.16.102:2379, falseee0e9340a5cfb4d7, started, k8s03, https://10.200.16.103:2380, https://10.200.16.103:2379, false# å‡è®¾è¿™é‡Œæˆ‘è¦åˆ é™¤ k8s03ETCD=`docker ps|grep etcd|grep -v POD|awk '&#123;print $1&#125;'`docker exec \  -it $&#123;ETCD&#125; \  etcdctl \  --endpoints https://127.0.0.1:2379 \  --cacert /etc/kubernetes/pki/etcd/ca.crt \  --cert /etc/kubernetes/pki/etcd/peer.crt \  --key /etc/kubernetes/pki/etcd/peer.key \  member remove ee0e9340a5cfb4d7</code></pre><h2 id="workerèŠ‚ç‚¹">workerèŠ‚ç‚¹</h2><blockquote><p>åŠ å…¥å‘½ä»¤ï¼Œä½äº k8s01åˆå§‹åŒ–å‘½ä»¤å°¾éƒ¨ï¼ŒworkeråŠ å…¥çš„æ—¶å€™ï¼Œä¸éœ€è¦æ·»åŠ  --control-plane --certificate-key</p></blockquote><pre><code class="language-bash">kubeadm join k8sapi:8443 \--token h77qhb.cjj8ig4t2v15dncm \--discovery-token-ca-cert-hash sha256:b7138bb76d19d3d7baf832e46559c400f4fe544d8f0ee81a87f</code></pre><h2 id="å…¶ä»–å†…å®¹">å…¶ä»–å†…å®¹</h2><h3 id="å®¹å™¨ä¸­æ˜¾ç¤ºæ­£ç¡®çš„å¯è§èµ„æº">å®¹å™¨ä¸­æ˜¾ç¤ºæ­£ç¡®çš„å¯è§èµ„æº</h3><p>é»˜è®¤æƒ…å†µä¸‹,ä¸ç®¡ä½ å¦‚ä½•è®¾ç½®èµ„æºé™åˆ¶,å®¹å™¨é‡Œçš„å¯è§èµ„æºéƒ½ç­‰äºèŠ‚ç‚¹èµ„æº.ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨å®¹å™¨é‡ŒæŸ¥çœ‹/proc/meminfoæ˜¾ç¤ºçš„èµ„æºå¹¶ä¸æ˜¯ä½ è®¾ç½®çš„.è¿™ä¸ªé—®é¢˜ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦.</p><p>å› ä¸ºå¾ˆå¤šç¨‹åºçš„å‚æ•°éƒ½æ˜¯æ ¹æ®å¯è§èµ„æºæ¥è®¾å®šçš„.ä¾‹å¦‚nginxçš„auto, æˆ–è€…jvmé‡Œçš„å†…å­˜å‚æ•°.</p><blockquote><p>ä» Java 8u191å¼€å§‹, jvm å·²ç»é»˜è®¤å®ç°äº†å®¹å™¨æ„ŸçŸ¥( -XX:+UseContainerSupport). å› æ­¤æ— éœ€å®‰è£…ä¸‹é¢çš„ lxcfs æ–¹æ¡ˆ.</p><p>å¹¶ä¸”, åœ¨å®¹å™¨ä¸­å»ºè®®åªè®¾ç½®å¦‚ä¸‹å†…å­˜å‚æ•°:</p><p>-XX:MaxRAMPercentage  æœ€å¤§å †å†…å­˜=ç‰©ç†å†…å­˜ç™¾åˆ†æ¯”, å»ºè®®ä¸ºå®¹å™¨é™åˆ¶çš„50%-75% . æ¯•ç«Ÿè¿˜éœ€è¦é¢„ç•™å…¶å®ƒå†…å­˜.</p></blockquote><p>è€Œç¤¾åŒºå¸¸è§çš„ä½œæ³•æ˜¯ç”¨<code>lxcfs</code> æ¥æå‡èµ„æºçš„å¯è§æ€§.<code>lxcfs</code> æ˜¯ä¸€ä¸ªå¼€æºçš„FUSEï¼ˆç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼‰å®ç°æ¥æ”¯æŒLXCå®¹å™¨, å®ƒä¹Ÿå¯ä»¥æ”¯æŒDockerå®¹å™¨.</p><p>LXCFSé€šè¿‡ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ, åœ¨å®¹å™¨ä¸­æä¾›ä¸‹åˆ— <code>procfs</code> çš„æ–‡ä»¶.</p><pre><code class="language-bash">/proc/cpuinfo/proc/diskstats/proc/meminfo/proc/stat/proc/swaps/proc/uptime</code></pre><p>ä¸æˆ‘ä»¬èµ„æºé™åˆ¶æœ‰å…³çš„, ä¸»è¦æ˜¯ cpuinfo å’Œ meminfo.</p><p>ç›®å‰ç¤¾åŒºçš„åšæ³•å¦‚ä¸‹:</p><ol><li><p>æ‰€æœ‰èŠ‚ç‚¹å®‰è£… fuse-libs åŒ….</p><pre><code class="language-bash">yum install -y fuse-libs</code></pre></li><li><p>é›†ç¾¤éƒ¨ç½²lxcfs deployment</p><pre><code class="language-bash">git clone https://github.com/denverdino/lxcfs-admission-webhook.gitcd lxcfs-admission-webhookvim deployment/lxcfs-daemonset.yaml=== ä¿®æ­£é…ç½®é‡Œçš„ apiVersion=== å½“å‰gité‡Œçš„ä»£ç æ˜¯é™ˆæ—§çš„...ä»£ç é‡Œçš„ç‰ˆæœ¬åœ¨ 1.18 å·²ç»è¢«åºŸå¼ƒ). å…·ä½“å½’å±äºä»€ä¹ˆç‰ˆæœ¬, è¯·å‚è€ƒk8så®˜æ–¹apiæ–‡æ¡£ === https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#daemonset-v1-appsapiVersion:apps/v1  kubectl apply -f deployment/lxcfs-daemonset.yamlkubectl get pod#ç­‰å¾… lxcfs pod çŠ¶æ€æˆ running#å¦‚æœä½ å‘ç° pod å§‹ç»ˆå‡ºé”™ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼škubectl delete -f deployment/lxcfs-daemonset.yamlrm -rf /var/lib/lxcfskubectl apply -f deployment/lxcfs-daemonset.yamldeployment/install.shkubectl get secrets,pods,svc,mutatingwebhookconfigurations</code></pre></li><li><p>ç»™ç›¸å…³namespaceæ³¨å…¥lxcfsï¼Œä¾‹å¦‚default</p><pre><code class="language-bash">kubectl label namespace default lxcfs-admission-webhook=enabled</code></pre></li><li><p>é‡å¯æ·»åŠ äº†èµ„æºé™åˆ¶çš„pod, æ­¤æ—¶ /proc/cpuinfo å’Œ /proc/meminfo å°†ä¼šæ­£ç¡®æ˜¾ç¤º.</p></li></ol><h3 id="é›†ç¾¤æŒ‡æ ‡ç›‘æ§æœåŠ¡">é›†ç¾¤æŒ‡æ ‡ç›‘æ§æœåŠ¡</h3><p>æ·»åŠ  metrics-server  <a href="https://github.com/kubernetes-sigs/metrics-server#configuration">https://github.com/kubernetes-sigs/metrics-server#configuration</a></p><pre><code class="language-bash">helm show values stable/metrics-server &gt; metrics-server.yaml# ä¿®æ”¹é…ç½®æ·»åŠ é¢å¤–çš„å¯åŠ¨å‚æ•°(arg)args:  - --kubelet-preferred-address-types=InternalIP  - --kubelet-insecure-tlshelm install metrics-server stable/metrics-server -f metrics-server.yamlkubectl get --raw &quot;/apis/metrics.k8s.io/v1beta1/nodes&quot;</code></pre><blockquote><p>kubectl top æŒ‡ä»¤éœ€è¦æŒ‡æ ‡æ‰èƒ½è¾“å‡º</p></blockquote><hr><h2 id="kubectl-å‘½ä»¤æ–‡æ¡£">kubectl å‘½ä»¤æ–‡æ¡£</h2><blockquote><p><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands</a></p></blockquote><pre><code class="language-bash"># æŸ¥è¯¢é›†ç¾¤ç½‘ç»œçš„appkubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools</code></pre><h2 id="åˆ é™¤ä¸æ¸…ç†">åˆ é™¤ä¸æ¸…ç†</h2><pre><code class="language-bash"># ä»é›†ç¾¤é‡Œåˆ é™¤æŸä¸ªèŠ‚ç‚¹# master execkubectl drain &lt;NODE_ID&gt; --delete-local-data --force --ignore-daemonsetskubectl delete node &lt;NODE_ID&gt;# worker execkubeadm resetiptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -Xipvsadm --clear;ip link set cni0 down &amp;&amp; ip link delete cni0;ip link set flannel.1 down &amp;&amp; ip link delete flannel.1;ip link set kube-ipvs0 down &amp;&amp; ip link delete kube-ipvs0;ip link set dummy0 down &amp;&amp; ip link delete dummy0;rm -rf /var/lib/cni/rm -rf $HOME/.kube;</code></pre><h2 id="èŠ‚ç‚¹ä¸€è‡´æ€§æµ‹è¯•">èŠ‚ç‚¹ä¸€è‡´æ€§æµ‹è¯•</h2><blockquote><p><a href="https://kubernetes.io/docs/setup/node-conformance/">https://kubernetes.io/docs/setup/node-conformance/</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜è®°å½•ç‚¹</title>
      <link href="posts/e1096625/"/>
      <url>posts/e1096625/</url>
      
        <content type="html"><![CDATA[<ol><li><p>pvå’Œpvcçš„ç»‘å®šå…³ç³»æ˜¯ç»ˆç”Ÿçš„. ä¹Ÿå°±æ˜¯è¯´ä½ åˆ é™¤äº†å½“å‰pvc, pvä¾ç„¶ä¸èƒ½è¢«å…¶å®ƒpvcæ‰€ç»‘å®š.</p><p>åˆ é™¤pvcå, pvçš„çŠ¶æ€å°†ä»boundè½¬ä¸ºReleased.</p><p>å¦‚æœä½ æƒ³è®©pvä»æ–°ç»‘å®šåˆ°åŸæ¥çš„pvcä¸Š, åˆ™éœ€è¦ä¸¤ä¸ªæ­¥éª¤:</p><ol><li>å…ˆåˆ›å»ºåŸæ¥çš„pvc.</li><li>åˆ é™¤å½“å‰pvå¹¶é‡æ–°åˆ›å»º, æˆ–è€…ä¿®æ”¹å½“å‰pvçš„é…ç½®, åˆ é™¤spec.claimRefä¿¡æ¯.</li></ol></li><li><p>podæ— æ³•æ­£å¸¸å¯åŠ¨ï¼ŒæŠ¥é”™ï¼šâ€œmounting \â€œ/var/lib/lxcfs/proc/loadavg\â€<br>to rootfs \&quot;/export/docker-data-root/overlay2/710d09a6715d88a01b417ba1a669dab69b67c3d57e576c1ae6d79aa03e1b294a/mergedâ€</p><p>æ ¹æ®ä¿¡æ¯å¯çŸ¥é—®é¢˜ç‚¹åº”è¯¥æ˜¯ lxcfs é—®é¢˜ã€‚</p><p>æŸ¥çœ‹æ•…éšœpodæ‰€åœ¨èŠ‚ç‚¹çš„ lxcfs pod æ—¥å¿—ï¼Œå¾—åˆ°ä¿¡æ¯</p><p>â€œfuse: mountpoint is not empty<br>fuse: if you are sure this is safe, use the â€˜nonemptyâ€™ mount optionâ€</p><p>å› æ­¤åˆ é™¤èŠ‚ç‚¹ lxcfs ç›®å½•ï¼Œå¹¶é‡å»º lxcfs pod</p><pre><code class="language-bash">rm -rf  /var/lib/lxcfs/ &amp;&amp; kubectl delete pod/lxcfs-hthgq</code></pre></li><li><p>å˜æ›´pvå›æ”¶ç­–ç•¥</p><pre><code class="language-bash">kubectl patch pv &lt;your-pv-name&gt; -p '&#123;&quot;spec&quot;:&#123;&quot;persistentVolumeReclaimPolicy&quot;:&quot;Retain&quot;&#125;&#125;'</code></pre></li><li><p>kubernetes qos</p><p>kubernetes æœ‰ä¸‰ç§ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯Guaranteedå’ŒBurstableå’ŒBestEffort</p><p>Guaranteedï¼šä»»ä½•å®¹å™¨çš„cpuè¯·æ±‚å€¼å’Œé™åˆ¶å€¼å¿…é¡»ä¸€æ ·ã€‚å†…å­˜åŒæ ·å¦‚æ­¤</p><p>Burstableï¼šæœ€å°‘æœ‰ä¸€ä¸ªå®¹å™¨çš„cpuè¯·æ±‚å€¼å’Œé™åˆ¶å€¼å¿…é¡»ä¸€æ ·ã€‚å†…å­˜åŒæ ·å¦‚æ­¤</p><p>BestEffortï¼š æ²¡æœ‰ä»»ä½•é™åˆ¶</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusâ˜æ­å»º</title>
      <link href="posts/65820315/"/>
      <url>posts/65820315/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>prometheus ç›‘æ§çš„æ„å»ºï¼Œç›¸æ¯” zabbix æ¥è¯´ï¼Œè¿˜æ˜¯è¦éº»çƒ¦ä¸€äº›ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœä½ å®Œå…¨ç†Ÿæ‚‰ä¹‹åï¼Œé…ç½®æ–‡ä»¶åŒ–ä¹Ÿæ›´å®¹æ˜“è¢«å…¶ä»–ç³»ç»Ÿæ‰€ä¿®æ”¹ã€‚</p><h1>ç›‘æ§ç«¯ç»„ä»¶</h1><p>æä¹‹å‰ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œ</p><p>docker network create promsnet</p><h2 id="grafana">grafana</h2><blockquote><p>æ•°æ®å±•ç¤ºï¼Œéƒ¨ç½²åœ¨ proms ç«¯</p></blockquote><pre><code class="language-bash">mkdir -p /export/docker-data-grafana/&#123;data,conf&#125;chmod 777 /export/docker-data-grafana/datadocker run --name grafana \--network promsnet \--mount 'type=bind,src=/export/docker-data-grafana/data,dst=/var/lib/grafana' \--mount 'type=bind,src=/export/docker-data-grafana/conf,dst=/usr/share/grafana/conf' \-p 3000:3000 -d grafana/grafana:7.3.5</code></pre><blockquote><p>é»˜è®¤è´¦æˆ·/åˆå§‹å¯†ç éƒ½æ˜¯admin</p><p>é»˜è®¤é…ç½®åº“æ˜¯sqlite 3</p></blockquote><h3 id="é…ç½®">é…ç½®</h3><blockquote><p>/export/docker-data-grafana/conf/default.ini</p></blockquote><pre><code class="language-ini">[server]domain = åŸŸåhttp_port = ç«¯å£[database]type = sqlite3host = 127.0.0.1:3306name = grafanauser = rootpassword =[smtp]enabled = truehost = smtp.feishu.cn:465user = password = skip_verify = truefrom_address = from_name = GrafanaAdmin</code></pre><h2 id="alertmanager-å‘Šè­¦ç®¡ç†">alertmanager å‘Šè­¦ç®¡ç†</h2><p>å‘Šè­¦ç®¡ç†å™¨ï¼Œæ¥æ”¶ proms å‘æ¥çš„å‘Šè­¦ï¼Œå¹¶åŠ ä»¥å¤„ç†åå‘å‡º</p><pre><code class="language-bash">docker volume create alertmanagerdocker run --name alertmanager -d \  --network promsnet \  -p 9093:9093 \  --mount 'type=volume,src=alertmanager,dst=/etc/alertmanager' \prom/alertmanager</code></pre><h3 id="é…ç½®-2">é…ç½®</h3><p>alertmanager.yml</p><pre><code class="language-bash">global:  resolve_timeout: 5mroute:  group_by: ['alertname']  group_wait: 10s  group_interval: 10s  repeat_interval: 1h  receiver: 'wechat'receivers:- name: 'wechat'  wechat_configs:  - corp_id: ''    to_user: ''    agent_id: ''    api_secret: ''    send_resolved: trueinhibit_rules:  - source_match:      severity: 'critical'    target_match:      severity: 'warning'    equal: ['alertname', 'dev', 'instance']</code></pre><p>ä¸Šé¢æ˜¯å¾®ä¿¡çš„ï¼Œä½ ä¹Ÿå¯ä»¥webhookæ–¹å¼ï¼Œæ¥èµ°å…¶å®ƒæ–¹å¼ï¼Œä¾‹å¦‚é£ä¹¦/é’‰é’‰</p><pre><code class="language-bash">global:  resolve_timeout: 5mroute:  group_by: ['instance']  group_wait: 10s  group_interval: 10s  repeat_interval: 1h  receiver: 'web.hook.prometheusalert'receivers:- name: 'web.hook.prometheusalert'  webhook_configs:  - url: ''   # è¿™é‡Œå¡«å†™ webhook è°ƒç”¨inhibit_rules:  - source_match:      severity: 'critical'    target_match:      severity: 'warning'    equal: ['alertname', 'dev', 'instance']</code></pre><p>ğŸ’é£ä¹¦/é’‰é’‰ï¼Œå¯ä»¥ç”¨éƒ¨ç½² <a href="https://gitee.com/feiyu563/PrometheusAlert">PrometheusAlert</a></p><h3 id="å‘Šè­¦åˆ†ç»„ã€æ”¶æ•›ã€é™é»˜">å‘Šè­¦åˆ†ç»„ã€æ”¶æ•›ã€é™é»˜</h3><p>åˆ†ç»„çš„æ„æ€ï¼Œå°±æ˜¯å°†æŸä¸€ä¸ªç»„å†…åŒä¸€æ—¶æœŸçš„å‘Šè­¦åˆå¹¶å‘é€ï¼Œä¾‹å¦‚æ ¹æ®å®ä¾‹æ¥åˆ†ç»„ã€‚</p><p>æ”¶æ•›çš„æ„æ€ï¼Œå°±æ˜¯å‘Šè­¦Aè§„åˆ™å’Œå‘Šè­¦Bè§„åˆ™åŒæ—¶è§¦å‘ï¼Œä½†æ˜¯å‘Šè­¦Aè§„åˆ™å‡ºç°çš„æ—¶å€™ï¼Œå¿…ç„¶ä¼šè§¦å‘å‘Šè­¦Bï¼Œæ­¤æ—¶åªå‘å‘Šè­¦Aï¼Œä¾‹å¦‚MYSQLæœºå™¨æŒ‚äº†ï¼Œé‚£ä¹ˆåªéœ€è¦å‘æœºå™¨æŒ‚æ‰çš„å‘Šè­¦ï¼ŒMYSQLçš„å‘Šè­¦å°±æ²¡å¿…è¦å‘é€äº†ã€‚</p><p>é™é»˜çš„æ„æ€ï¼Œå°±æ˜¯ç”¨æˆ·å·²çŸ¥è¿™ä¸ªæ—¶é—´ç‚¹ä¼šè§¦å‘å‘Šè­¦è§„åˆ™ï¼Œä½†æ˜¯æ— éœ€è§¦å‘ï¼Œä¾‹å¦‚é«˜å‹åŠ›å®šæ—¶ä»»åŠ¡å¼•èµ·ç£ç›˜IOå‘Šè­¦ï¼Œè™½ç„¶ä¼šè§¦å‘å¹³å‡æŒ‡æ ‡å‘Šè­¦ï¼Œä½†æ˜¯åœ¨ç”¨æˆ·è®¤å®šçš„å®‰å…¨èŒƒå›´å†…ï¼Œå› è€Œæ— éœ€è§¦å‘ã€‚</p><ul><li>åˆ†ç»„</li></ul><p>æ ¹æ® label è¿›è¡Œåˆ†ç»„ï¼ŒåŒç»„çš„é¢„è­¦å°½é‡ä¸€æ¬¡æ€§å‘å‡º</p><pre><code class="language-yaml">route:  group_by: ['alertname'] # å‘Šè­¦åˆ†ç»„  group_wait: 10s # åˆ†ç»„ç­‰å¾…æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€ä¸ªå‘Šè­¦ç­‰å¾…åŒç»„å†…å…¶å®ƒå‘Šè­¦æ¥ä¸´çš„æ—¶é—´  group_interval: 5m # åˆ†ç»„å‘é€ä¸åŒå‘Šè­¦è§„åˆ™çš„é™é»˜å‘¨æœŸï¼Œä»¥åŠå‘é€å¤±è´¥çš„é™é»˜å‘¨æœŸ  repeat_interval: 1h # åˆ†ç»„å‘é€ç›¸åŒå‘Šè­¦è§„åˆ™çš„é™é»˜å‘¨æœŸï¼Œå¦‚æœæ—¶é—´ç»“æŸï¼Œå‘Šè­¦çŠ¶æ€æœªå˜ï¼Œå°†å†æ¬¡å‘é€.</code></pre><ul><li>æ”¶æ•›</li></ul><p>ä¸¾ä¾‹è¯´æ˜ï¼šå½“ä¸»æœºæŒ‚äº†ï¼Œæ­¤æ—¶åªéœ€è¦å‘é€ä¸»æœºæŒ‚æ‰çš„é¢„è­¦ï¼Œæ— éœ€å†å‘é€å› ä¸»æœºæŒ‚æ‰è€Œäº§å‡ºçš„å…¶å®ƒé¢„è­¦ã€‚</p><pre><code class="language-yaml">inhibit_rules:  - source_match:   # åŒ¹é…æœ€åº•å±‚çš„é‚£ä¸ªå‘Šè­¦è§„åˆ™ï¼Œæ¯”å¦‚æœåŠ¡å™¨æŒ‚äº†      severity: 'critical'       target_match:   # åŒ¹é…å½“ source_match è§¦å‘çš„æ—¶å€™ï¼Œæ— éœ€å‘Šè­¦çš„è§„åˆ™ã€‚      severity: 'warn'    equal: ['instance']   # æ ¹æ®æ ‡ç­¾ç¡®å®šå“ªäº›åŒ¹é…åˆ° target_match çš„éœ€è¦å¿½ç•¥ã€‚ä¾‹å¦‚ï¼Œequal: instance é‚£ä¹ˆå½“ source_match å’Œ target_match çš„ instance å€¼ä¸€æ ·çš„æ—¶å€™ï¼Œtarget_match è¢«å¿½ç•¥ã€‚</code></pre><blockquote><p>æ ‡ç­¾çš„ key ï¼Œå¯ä»¥æ˜¯ä½ åœ¨ proms.rule ä¸­è‡ªå®šä¹‰ï¼Œä¹Ÿå¯ä»¥æ˜¯è¢«ç›‘æ§ç«¯ç»„ä»¶é‡‡é›†æ•°æ®åå‘ç»™ proms çš„ã€‚</p></blockquote><h2 id="Prometheus-ä¸»ç¨‹">Prometheus ä¸»ç¨‹</h2><pre><code class="language-bash">mkdir /export/docker-data-proms/&#123;data,conf&#125; -pchmod 777 /export/docker-data-proms/data</code></pre><h3 id="é…ç½®-3">é…ç½®</h3><h4 id="ä¸»é…ç½®">ä¸»é…ç½®</h4><p>/export/docker-data-proms/promethesu.yml</p><pre><code class="language-:"># my global configglobal:  scrape_interval:     15s # è®¾ç½®é‡‡é›†é—´éš”ä¸ºæ¯15ç§’ä¸€æ¬¡ã€‚é»˜è®¤å€¼ä¸ºæ¯1åˆ†é’Ÿä¸€æ¬¡ã€‚  evaluation_interval: 15s # æ¯15ç§’è¯„ä¼°ä¸€æ¬¡è§„åˆ™ã€‚é»˜è®¤ä¸ºæ¯1åˆ†é’Ÿä¸€æ¬¡ã€‚  # scrape_timeout is set to the global default (10s).# å‘Šè­¦ç®¡ç†å™¨é…ç½®alerting:  alertmanagers:  - static_configs:    - targets:      - alertmanager:9093# ä¸€æ¬¡åŠ è½½è§„åˆ™ï¼Œå¹¶æ ¹æ®å…¨å±€çš„'evaluation_interval'å®šæœŸè¯„ä¼°è§„åˆ™ã€‚rule_files:  - &quot;/etc/prometheus/conf/rules/*.yml&quot;# A scrape configuration containing exactly one endpoint to scrape:# Here it's Prometheus itself.scrape_configs:  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.#  - job_name: 'prometheus'#    static_configs:#    - targets: ['proms:9090']#  - job_name: &quot;grafana&quot;#    static_configs:#    - targets: ['grafana:3000']  - job_name: &quot;dockersInfo&quot;    static_configs:    - targets: ['192.168.1.1:10052','192.168.1.2:10052']  - job_name: &quot;node_exporter&quot;    static_configs:    - targets: ['192.168.1.1:9100','192.168.1.2:9100']</code></pre><h4 id="å®šä¹‰éœ€è¦å‘Šè­¦çš„æŒ‡æ ‡è§„åˆ™">å®šä¹‰éœ€è¦å‘Šè­¦çš„æŒ‡æ ‡è§„åˆ™</h4><p>å°†é‡‡é›†çš„æ•°æ®æŒ‡æ ‡é€šè¿‡ expr è¿›è¡Œè¿ç®—ï¼Œå¹¶é€šè¿‡ record è¿›è¡Œå‘½å</p><h5 id="ä¸»æœºç›‘æ§æŒ‡æ ‡è§„åˆ™">ä¸»æœºç›‘æ§æŒ‡æ ‡è§„åˆ™</h5><p>/export/docker-data-proms/conf/rules/node-exporter-record-rules.yml</p><pre><code class="language-bash"># node-exporter-record-rules.yml# æ ‡ç­¾ job å…³è”ä¸»é…ç½®å®šä¹‰çš„ä»»åŠ¡ node_exporterï¼Œè·å–ä»»åŠ¡ä¼ é€’çš„æ•°æ®ï¼Œä»è€ŒæŠ½å–ä¿¡æ¯å®šä¹‰ expr# ç»™ expr è¡¨è¾¾å¼è®¾ç½®ä¸€ä¸ªåˆ«å record, åˆ«åå¯ä»¥è¢«å…¶å®ƒ rules è°ƒç”¨groups:  - name: node_exporter-record    rules:    - expr: up&#123;job=~&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:up      labels:        desc: &quot;èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿, åœ¨çº¿1,ä¸åœ¨çº¿0&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;    - expr: time() - node_boot_time_seconds&#123;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:node_uptime      labels:        desc: &quot;èŠ‚ç‚¹çš„è¿è¡Œæ—¶é—´&quot;        unit: &quot;s&quot;        job: &quot;node_exporter&quot;###############################################################################################                              cpu                                                           #    - expr: (1 - avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:total:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpuæ€»æ¶ˆè€—ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:idle:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu idleç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;iowait&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:iowait:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu iowaitç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;system&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:system:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu systemç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;user&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:user:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu userç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=~&quot;softirq|nice|irq|steal&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:other:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu å…¶ä»–çš„ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;###############################################################################################                                    memory                                                  #    - expr: node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:total      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜æ€»é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_memory_MemFree_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:free      labels:        desc: &quot;èŠ‚ç‚¹çš„å‰©ä½™å†…å­˜é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125; - node_memory_MemFree_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:used      labels:        desc: &quot;èŠ‚ç‚¹çš„å·²ä½¿ç”¨å†…å­˜é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125; - node_memory_MemAvailable_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:actualused      labels:        desc: &quot;èŠ‚ç‚¹ç”¨æˆ·å®é™…ä½¿ç”¨çš„å†…å­˜é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: (1-(node_memory_MemAvailable_bytes&#123;job=&quot;node_exporter&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: ((node_memory_MemAvailable_bytes&#123;job=&quot;node_exporter&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:free:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜å‰©ä½™ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;###############################################################################################                                   load                                                     #    - expr: sum by (instance) (node_load1&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load1      labels:        desc: &quot;ç³»ç»Ÿ1åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;    - expr: sum by (instance) (node_load5&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load5      labels:        desc: &quot;ç³»ç»Ÿ5åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;    - expr: sum by (instance) (node_load15&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load15      labels:        desc: &quot;ç³»ç»Ÿ15åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;###############################################################################################                                 disk                                                       #    - expr: node_filesystem_size_bytes&#123;job=&quot;node_exporter&quot; ,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:total      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜æ€»é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_filesystem_avail_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:free      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜å‰©ä½™ç©ºé—´&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_filesystem_size_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125; - node_filesystem_avail_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:used      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜ä½¿ç”¨çš„ç©ºé—´&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr:  (1 - node_filesystem_avail_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜çš„ä½¿ç”¨ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: irate(node_disk_reads_completed_total&#123;job=&quot;node_exporter&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:read:count:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜è¯»å–é€Ÿç‡&quot;        unit: &quot;æ¬¡/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: irate(node_disk_writes_completed_total&#123;job=&quot;node_exporter&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:write:count:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜å†™å…¥é€Ÿç‡&quot;        unit: &quot;æ¬¡/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: (irate(node_disk_written_bytes_total&#123;job=&quot;node_exporter&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:read:mb:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„è®¾å¤‡è¯»å–MBé€Ÿç‡&quot;        unit: &quot;MB/s&quot;        job: &quot;node_exporter&quot;    - expr: (irate(node_disk_read_bytes_total&#123;job=&quot;node_exporter&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:write:mb:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„è®¾å¤‡å†™å…¥MBé€Ÿç‡&quot;        unit: &quot;MB/s&quot;        job: &quot;node_exporter&quot;###############################################################################################                                filesystem                                                  #    - expr:   (1 -node_filesystem_files_free&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_files&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filesystem:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„inodeçš„å‰©ä½™å¯ç”¨çš„ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;##############################################################################################                                filefd                                                     #    - expr: node_filefd_allocated&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filefd_allocated:count      labels:        desc: &quot;èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ä¸ªæ•°&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: node_filefd_allocated&#123;job=&quot;node_exporter&quot;&#125;/node_filefd_maximum&#123;job=&quot;node_exporter&quot;&#125; * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filefd_allocated:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;##############################################################################################                                network                                                    #    - expr: avg by (environment,instance,device) (irate(node_network_receive_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:bit:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡eth0æ¯ç§’æ¥æ”¶çš„æ¯”ç‰¹æ•°&quot;        unit: &quot;bit/s&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:bit:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡eth0æ¯ç§’å‘é€çš„æ¯”ç‰¹æ•°&quot;        unit: &quot;bit/s&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_receive_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:packet:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡æ¯ç§’æ¥æ”¶çš„æ•°æ®åŒ…ä¸ªæ•°&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:packet:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡å‘é€çš„æ•°æ®åŒ…ä¸ªæ•°&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_receive_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:error:rate      labels:        desc: &quot;èŠ‚ç‚¹è®¾å¤‡é©±åŠ¨å™¨æ£€æµ‹åˆ°çš„æ¥æ”¶é”™è¯¯åŒ…çš„æ•°é‡&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:error:rate      labels:        desc: &quot;èŠ‚ç‚¹è®¾å¤‡é©±åŠ¨å™¨æ£€æµ‹åˆ°çš„å‘é€é”™è¯¯åŒ…çš„æ•°é‡&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: node_tcp_connection_states&#123;job=&quot;node_exporter&quot;, state=&quot;established&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:established:count      labels:        desc: &quot;èŠ‚ç‚¹å½“å‰establishedçš„ä¸ªæ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;    - expr: node_tcp_connection_states&#123;job=&quot;node_exporter&quot;, state=&quot;time_wait&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:timewait:count      labels:        desc: &quot;èŠ‚ç‚¹timewaitçš„è¿æ¥æ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;    - expr: sum by (environment,instance) (node_tcp_connection_states&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:total:count      labels:        desc: &quot;èŠ‚ç‚¹tcpè¿æ¥æ€»æ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;##############################################################################################                                process                                                    #    - expr: node_processes_state&#123;state=&quot;Z&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:process:zoom:total:count      labels:        desc: &quot;èŠ‚ç‚¹å½“å‰çŠ¶æ€ä¸ºzoomçš„ä¸ªæ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;##############################################################################################                                other                                                    #    - expr: abs(node_timex_offset_seconds&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:time:offset      labels:        desc: &quot;èŠ‚ç‚¹çš„æ—¶é—´åå·®&quot;        unit: &quot;s&quot;        job: &quot;node_exporter&quot;##############################################################################################    - expr: count by (instance) ( count by (instance,cpu) (node_cpu_seconds_total&#123; mode='system'&#125;) ) * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:count</code></pre><h5 id="å®¹å™¨ç›‘æ§æŒ‡æ ‡è§„åˆ™">å®¹å™¨ç›‘æ§æŒ‡æ ‡è§„åˆ™</h5><p>/export/docker-data-proms/conf/rules/dockersInfo-record-rules.yml</p><pre><code class="language-yaml">groups:  - name: node_exporter-record    rules:    - expr: up&#123;job=~&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:up      labels:        desc: &quot;èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿, åœ¨çº¿1,ä¸åœ¨çº¿0&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;    - expr: time() - node_boot_time_seconds&#123;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:node_uptime      labels:        desc: &quot;èŠ‚ç‚¹çš„è¿è¡Œæ—¶é—´&quot;        unit: &quot;s&quot;        job: &quot;node_exporter&quot;###############################################################################################                              cpu                                                           #    - expr: (1 - avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:total:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpuæ€»æ¶ˆè€—ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;idle&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:idle:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu idleç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;iowait&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:iowait:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu iowaitç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;system&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:system:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu systemç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=&quot;user&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:user:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu userç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: (avg by (environment,instance) (irate(node_cpu_seconds_total&#123;job=&quot;node_exporter&quot;,mode=~&quot;softirq|nice|irq|steal&quot;&#125;[5m])))  * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:other:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„cpu å…¶ä»–çš„ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;###############################################################################################                                    memory                                                  #    - expr: node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:total      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜æ€»é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_memory_MemFree_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:free      labels:        desc: &quot;èŠ‚ç‚¹çš„å‰©ä½™å†…å­˜é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125; - node_memory_MemFree_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:used      labels:        desc: &quot;èŠ‚ç‚¹çš„å·²ä½¿ç”¨å†…å­˜é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125; - node_memory_MemAvailable_bytes&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:actualused      labels:        desc: &quot;èŠ‚ç‚¹ç”¨æˆ·å®é™…ä½¿ç”¨çš„å†…å­˜é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: (1-(node_memory_MemAvailable_bytes&#123;job=&quot;node_exporter&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: ((node_memory_MemAvailable_bytes&#123;job=&quot;node_exporter&quot;&#125; / (node_memory_MemTotal_bytes&#123;job=&quot;node_exporter&quot;&#125;)))* 100* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:memory:free:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„å†…å­˜å‰©ä½™ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;###############################################################################################                                   load                                                     #    - expr: sum by (instance) (node_load1&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load1      labels:        desc: &quot;ç³»ç»Ÿ1åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;    - expr: sum by (instance) (node_load5&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load5      labels:        desc: &quot;ç³»ç»Ÿ5åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;    - expr: sum by (instance) (node_load15&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:load:load15      labels:        desc: &quot;ç³»ç»Ÿ15åˆ†é’Ÿè´Ÿè½½&quot;        unit: &quot; &quot;        job: &quot;node_exporter&quot;###############################################################################################                                 disk                                                       #    - expr: node_filesystem_size_bytes&#123;job=&quot;node_exporter&quot; ,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:total      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜æ€»é‡&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_filesystem_avail_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:free      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜å‰©ä½™ç©ºé—´&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr: node_filesystem_size_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125; - node_filesystem_avail_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:usage:used      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜ä½¿ç”¨çš„ç©ºé—´&quot;        unit: byte        job: &quot;node_exporter&quot;    - expr:  (1 - node_filesystem_avail_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜çš„ä½¿ç”¨ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: irate(node_disk_reads_completed_total&#123;job=&quot;node_exporter&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:read:count:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜è¯»å–é€Ÿç‡&quot;        unit: &quot;æ¬¡/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: irate(node_disk_writes_completed_total&#123;job=&quot;node_exporter&quot;&#125;[1m])* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:write:count:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„ç£ç›˜å†™å…¥é€Ÿç‡&quot;        unit: &quot;æ¬¡/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: (irate(node_disk_written_bytes_total&#123;job=&quot;node_exporter&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:read:mb:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„è®¾å¤‡è¯»å–MBé€Ÿç‡&quot;        unit: &quot;MB/s&quot;        job: &quot;node_exporter&quot;    - expr: (irate(node_disk_read_bytes_total&#123;job=&quot;node_exporter&quot;&#125;[1m]))/1024/1024* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:disk:write:mb:rate      labels:        desc: &quot;èŠ‚ç‚¹çš„è®¾å¤‡å†™å…¥MBé€Ÿç‡&quot;        unit: &quot;MB/s&quot;        job: &quot;node_exporter&quot;###############################################################################################                                filesystem                                                  #    - expr:   (1 -node_filesystem_files_free&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125; / node_filesystem_files&#123;job=&quot;node_exporter&quot;,fstype=~&quot;ext4|xfs&quot;&#125;) * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filesystem:used:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„inodeçš„å‰©ä½™å¯ç”¨çš„ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;##############################################################################################                                filefd                                                     #    - expr: node_filefd_allocated&#123;job=&quot;node_exporter&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filefd_allocated:count      labels:        desc: &quot;èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ä¸ªæ•°&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;    - expr: node_filefd_allocated&#123;job=&quot;node_exporter&quot;&#125;/node_filefd_maximum&#123;job=&quot;node_exporter&quot;&#125; * 100 * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:filefd_allocated:percent      labels:        desc: &quot;èŠ‚ç‚¹çš„æ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ç™¾åˆ†æ¯”&quot;        unit: &quot;%&quot;        job: &quot;node_exporter&quot;##############################################################################################                                network                                                    #    - expr: avg by (environment,instance,device) (irate(node_network_receive_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:bit:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡eth0æ¯ç§’æ¥æ”¶çš„æ¯”ç‰¹æ•°&quot;        unit: &quot;bit/s&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_bytes_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:bit:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡eth0æ¯ç§’å‘é€çš„æ¯”ç‰¹æ•°&quot;        unit: &quot;bit/s&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_receive_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:packet:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡æ¯ç§’æ¥æ”¶çš„æ•°æ®åŒ…ä¸ªæ•°&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_packets_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:packet:rate      labels:        desc: &quot;èŠ‚ç‚¹ç½‘å¡å‘é€çš„æ•°æ®åŒ…ä¸ªæ•°&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_receive_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netin:error:rate      labels:        desc: &quot;èŠ‚ç‚¹è®¾å¤‡é©±åŠ¨å™¨æ£€æµ‹åˆ°çš„æ¥æ”¶é”™è¯¯åŒ…çš„æ•°é‡&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: avg by (environment,instance,device) (irate(node_network_transmit_errs_total&#123;device=~&quot;eth0|eth1|ens33|ens37&quot;&#125;[1m]))* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:netout:error:rate      labels:        desc: &quot;èŠ‚ç‚¹è®¾å¤‡é©±åŠ¨å™¨æ£€æµ‹åˆ°çš„å‘é€é”™è¯¯åŒ…çš„æ•°é‡&quot;        unit: &quot;ä¸ª/ç§’&quot;        job: &quot;node_exporter&quot;    - expr: node_tcp_connection_states&#123;job=&quot;node_exporter&quot;, state=&quot;established&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:established:count      labels:        desc: &quot;èŠ‚ç‚¹å½“å‰establishedçš„ä¸ªæ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;    - expr: node_tcp_connection_states&#123;job=&quot;node_exporter&quot;, state=&quot;time_wait&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:timewait:count      labels:        desc: &quot;èŠ‚ç‚¹timewaitçš„è¿æ¥æ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;    - expr: sum by (environment,instance) (node_tcp_connection_states&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:network:tcp:total:count      labels:        desc: &quot;èŠ‚ç‚¹tcpè¿æ¥æ€»æ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;##############################################################################################                                process                                                    #    - expr: node_processes_state&#123;state=&quot;Z&quot;&#125;* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:process:zoom:total:count      labels:        desc: &quot;èŠ‚ç‚¹å½“å‰çŠ¶æ€ä¸ºzoomçš„ä¸ªæ•°&quot;        unit: &quot;ä¸ª&quot;        job: &quot;node_exporter&quot;##############################################################################################                                other                                                    #    - expr: abs(node_timex_offset_seconds&#123;job=&quot;node_exporter&quot;&#125;)* on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:time:offset      labels:        desc: &quot;èŠ‚ç‚¹çš„æ—¶é—´åå·®&quot;        unit: &quot;s&quot;        job: &quot;node_exporter&quot;##############################################################################################    - expr: count by (instance) ( count by (instance,cpu) (node_cpu_seconds_total&#123; mode='system'&#125;) ) * on(instance) group_left(nodename) (node_uname_info)      record: node_exporter:cpu:count</code></pre><h4 id="å®šä¹‰ç›‘æ§æŒ‡æ ‡é˜ˆå€¼è§„åˆ™">å®šä¹‰ç›‘æ§æŒ‡æ ‡é˜ˆå€¼è§„åˆ™</h4><h5 id="ä¸»æœºç›‘æ§æŒ‡æ ‡é˜ˆå€¼">ä¸»æœºç›‘æ§æŒ‡æ ‡é˜ˆå€¼</h5><p>/export/docker-data-proms/conf/rules/node-exporter-alert-rules.yml</p><pre><code class="language-bash"># node-exporter-alert-rules.yml# å®šä¹‰å‘Šè­¦è§„åˆ™# é€šè¿‡å‰ä¸€ä¸ª rules æ–‡ä»¶æ‹¿åˆ°å®šä¹‰çš„ record åˆ«åæ¥ç¼–å†™ expr åˆ¤æ–­å¼# è¿™é‡Œå®šä¹‰çš„å‘Šè­¦è§„åˆ™ï¼Œåœ¨è§¦å‘çš„æ—¶å€™ï¼Œéƒ½ä¼šä¼ é€’åˆ° alertmanagerï¼Œæœ€åä»ä¼ é€’çš„ä¿¡æ¯ä¸­æŠ½å–æ‰€éœ€æ•°æ®å‘é€ç»™ç›®æ ‡äººã€‚groups:  - name: node-alert    rules:    - alert: node-down      expr: node_exporter:up == 0      for: 1m      labels:        severity: critical      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; å®•æœºäº†&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-cpu-high      expr:  node_exporter:cpu:total:percent &gt; 80      for: 3m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; cpu ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-cpu-iowait-high      expr:  node_exporter:cpu:iowait:percent &gt;= 12      for: 3m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; cpu iowait ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-load-load1-high      expr:  (node_exporter:load:load1) &gt; (node_exporter:cpu:count) * 1.2      for: 3m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; load1 ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-memory-high      expr:  node_exporter:memory:used:percent &gt; 85      for: 3m      labels:        severity: info      annotations:        summary: &quot;å†…å­˜ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-high      expr:  node_exporter:disk:used:percent &gt; 80      for: 3m      labels:        severity: info      annotations:        summary: &quot;&#123;&#123; $labels.device &#125;&#125;:&#123;&#123; $labels.mountpoint &#125;&#125; ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-read:count-high      expr:  node_exporter:disk:read:count:rate &gt; 3000      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; iops read ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-write-count-high      expr:  node_exporter:disk:write:count:rate &gt; 3000      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; iops write ä½¿ç”¨ç‡é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-read-mb-high      expr:  node_exporter:disk:read:mb:rate &gt; 60      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; è¯»å–å­—èŠ‚æ•° é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-disk-write-mb-high      expr:  node_exporter:disk:write:mb:rate &gt; 60      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; å†™å…¥å­—èŠ‚æ•° é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-filefd-allocated-percent-high      expr:  node_exporter:filefd_allocated:percent &gt; 80      for: 10m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-netin-error-rate-high      expr:  node_exporter:network:netin:error:rate &gt; 4      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åŒ…è¿›å…¥çš„é”™è¯¯é€Ÿç‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-netin-packet-rate-high      expr:  node_exporter:network:netin:packet:rate &gt; 35000      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åŒ…è¿›å…¥é€Ÿç‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-netout-packet-rate-high      expr:  node_exporter:network:netout:packet:rate &gt; 35000      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åŒ…æµå‡ºé€Ÿç‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-network-tcp-total-count-high      expr:  node_exporter:network:tcp:total:count &gt; 40000      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; tcpè¿æ¥æ•°é‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-process-zoom-total-count-high      expr:  node_exporter:process:zoom:total:count &gt; 10      for: 10m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; åƒµæ­»è¿›ç¨‹æ•°é‡ é«˜äº &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: node-time-offset-high      expr:  node_exporter:time:offset &gt; 0.03      for: 2m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; &#123;&#123; $labels.desc &#125;&#125;  &#123;&#123; $value &#125;&#125;&#123;&#123; $labels.unit &#125;&#125;&quot;        grafana: &quot;http://jksgg.pengwin.com:3000/d/9CWBz0bik/node-exporter?orgId=1&amp;var-instance=&#123;&#123; $labels.instance &#125;&#125; &quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;</code></pre><p>å…³äºè§„åˆ™é‡Œçš„è¡¨è¾¾å¼è¯­å¥çš„å†™æ³•æ¶‰åŠåˆ° PromQLï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æ–‡æ¡£</p><p><a href="https://fuckcloudnative.io/prometheus/3-prometheus/basics.html">https://fuckcloudnative.io/prometheus/3-prometheus/basics.html</a></p><pre><code class="language-bash"># æš‚æ—¶æ— ç”¨çš„è§„åˆ™groups:  - name: ap-southeast-1æœåŠ¡å™¨å‘Šè­¦    rules:    - alert: æœåŠ¡å™¨å®•æœºå‘Šè­¦      expr: up == 0      for: 3m      labels:        region: ap-southeast-1      annotations:        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;å®•æœºï¼&quot;        description: &quot;æœåŠ¡å™¨&#123;&#123;$labels.instance&#125;&#125;å·²å®•æœºï¼&quot;    - alert: cpuä½¿ç”¨ç‡è¿‡é«˜å‘Šè­¦      expr: (100 - (avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by(instance)* 100))* on(instance) group_left(nodename) (node_uname_info) &gt; 30      for: 5m      labels:        region: ap-southeast-1      annotations:        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰CPUä½¿ç”¨ç‡è¿‡é«˜ï¼&quot;        description: 'æœåŠ¡å™¨&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰CPUä½¿ç”¨ç‡è¶…è¿‡85%(ç›®å‰ä½¿ç”¨:&#123;&#123;printf "%.2f" $value&#125;&#125;%)'    - alert: ç³»ç»Ÿè´Ÿè½½è¿‡é«˜      expr: (node_load1/count without (cpu, mode) (node_cpu_seconds_total&#123;mode=&quot;system&quot;&#125;))* on(instance) group_left(nodename) (node_uname_info)&gt;1.1      for: 3m      labels:        region: ap-southeast-1      annotations:        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼&quot;        description: '&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰å½“å‰è´Ÿè½½è¶…æ ‡ç‡ &#123;&#123;printf "%.2f" $value&#125;&#125;'    - alert: å†…å­˜ä¸è¶³å‘Šè­¦      expr: (100 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100)* on(instance) group_left(nodename) (node_uname_info) &gt; 80      for: 3m      labels:        region: ap-southeast-1      annotations:        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼&quot;        description: 'æœåŠ¡å™¨&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%(ç›®å‰ä½¿ç”¨:&#123;&#123;printf "%.2f" $value&#125;&#125;%)'    - alert: ç¡¬ç›˜ç©ºé—´ä¸è¶³å‘Šè­¦      expr: (100-(node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125;/node_filesystem_size_bytes &#123;fstype=~&quot;ext4|xfs&quot;&#125;*100) )* on(instance) group_left(nodename) (node_uname_info)&gt; 80      for: 3m      labels:        region: ap-southeast-1      annotations:        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰ç¡¬ç›˜ä½¿ç”¨ç‡è¿‡é«˜ï¼&quot;        description: 'æœåŠ¡å™¨&#123;&#123;$labels.instance&#125;&#125;ï¼ˆ&#123;&#123;$labels.nodename&#125;&#125;ï¼‰ç¡¬ç›˜ä½¿ç”¨ç‡è¶…è¿‡80%(ç›®å‰ä½¿ç”¨:&#123;&#123;printf "%.2f" $value&#125;&#125;%)'</code></pre><h5 id="å®¹å™¨ç›‘æ§æŒ‡æ ‡é˜ˆå€¼">å®¹å™¨ç›‘æ§æŒ‡æ ‡é˜ˆå€¼</h5><p>/export/docker-data-proms/conf/rules/dockersInfo-alert-rules.yml</p><pre><code class="language-yaml">groups:  - name: container-alert    rules:    - alert: container-restart-times-high      expr: dockersInfo:container:restart &gt; 5      for: 1m      labels:        severity: warn      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; 15åˆ†é’Ÿå†…é‡å¯æ¬¡æ•°è¶…è¿‡5æ¬¡&quot;        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: container-cpu-usage-high      expr: dockersInfo:container:cpu:total:percent &gt; 90      for: 1m      labels:        severity: info      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; cpu ä½¿ç”¨ç‡æŒç»­è¶…è¿‡90%.&quot;        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;    - alert: container-cpu-iowait-high      expr: dockersInfo:cpu:iowait:percent &gt; 10      for: 1m      labels:        severity: warn      annotations:        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; cpu iowait æŒç»­è¶…è¿‡10%&quot;        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;        type: &quot;aliyun_meta_ecs_info&quot;#    - alert: container-mem-usage-high#      expr: dockersInfo:memory:used:percent &gt; 80#      for: 1m#      labels:#        severity: warn#      annotations:#        summary: &quot;instance: &#123;&#123; $labels.instance &#125;&#125; ä¸‹çš„ container: &#123;&#123; $labels.name &#125;&#125; å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%&quot;#        grafana: &quot;http://proms.pengwin.com:3000/d/Ss3q6hSZk/dockersinfo?orgId=1&amp;var-node=&#123;&#123; $labels.instance &#125;&#125;&quot;#        console: &quot;https://ecs.console.aliyun.com/#/server/&#123;&#123; $labels.instanceid &#125;&#125;/detail?regionId=cn-beijing&quot;#        cloudmonitor: &quot;https://cloudmonitor.console.aliyun.com/#/hostDetail/chart/instanceId=&#123;&#123; $labels.instanceid &#125;&#125;&amp;system=&amp;region=cn-beijing&amp;aliyunhost=true&quot;#        id: &quot;&#123;&#123; $labels.instanceid &#125;&#125;&quot;#        type: &quot;aliyun_meta_ecs_info&quot;</code></pre><h3 id="éƒ¨ç½²">éƒ¨ç½²</h3><h4 id="docker-æ–¹å¼">docker æ–¹å¼</h4><pre><code class="language-bash">docker run -d \--network promsnet \-p 9090:9090 \--name proms \--mount 'type=bind,src=/export/docker-data-proms/prometheus.yml,dst=/etc/prometheus/prometheus.yml'  \--mount 'type=bind,src=/export/docker-data-proms/data,dst=/prometheus' \--mount 'type=bind,src=/export/docker-data-proms/conf,dst=/etc/prometheus/conf' \prom/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/prometheus --storage.tsdb.retention=30d</code></pre><h4 id="äºŒè¿›åˆ¶æ–¹å¼">äºŒè¿›åˆ¶æ–¹å¼</h4><pre><code class="language-bash">wget https://github.com/prometheus/prometheus/releases/download/v2.20.0/prometheus-2.20.0.linux-amd64.tar.gzmkdir prometheustar xf prometheus-2.20.0.linux-amd64.tar.gz --strip-components 1 -C prometheusrm -rf prometheus-2.20.0.linux-amd64.tar.gzcd prometheus &amp;&amp; baseDir=`pwd`cp prometheus.yml&#123;,.bak&#125; #---cat &gt; /usr/lib/systemd/system/prometheus.service &lt;&lt;EOF[Unit]Description=prometheus server daemon[Service]Restart=on-failureExecStart=$&#123;baseDir&#125;/prometheus --config.file=$&#123;baseDir&#125;/prometheus.yml[Install]WantedBy=multi-user.targetEOF#---systemctl daemon-reloadsystemctl start prometheus</code></pre><h3 id="æŸ¥çœ‹">æŸ¥çœ‹</h3><p>è¢«ç›‘æ§ç«¯çŠ¶æ€ï¼š<a href="http://xxx:9090/targets">http://xxx:9090/targets</a></p><p>é€šè¿‡ä¸Šè¿°åœ°å€ï¼Œä½ å¯ä»¥çœ‹åˆ°é…ç½®ä¸­ job_name å®šä¹‰çš„è¢«ç›‘æ§ä»»åŠ¡çš„ç«¯ç‚¹çŠ¶æ€</p><p><img src="/posts/65820315/image-20201218112329166.png" alt="image-20201218112329166"></p><h2 id="pushgateway-åˆæœŸç”¨ä¸ä¸Šçš„ç»„ä»¶">pushgateway (åˆæœŸç”¨ä¸ä¸Šçš„ç»„ä»¶)</h2><blockquote><p>push æ¨¡å¼ä¸‹çš„ç½‘å…³</p><p>å½“å‰æ²¡æœ‰ç°æˆçš„æ¨é€æ¨¡å¼çš„ node-exporter</p></blockquote><pre><code class="language-bash"># dockerdocker run -d --name=pushgateway -p 9091:9091 prom/pushgateway</code></pre><pre><code class="language-bash"># ä¸€ä¸ªæ¨é€æ¨¡å¼çš„é‡‡é›†è„šæœ¬ç¤ºä¾‹# cat tcpestab.sh #!/bin/bash# æ·»åŠ è„šæœ¬åˆ°è®¡åˆ’ä»»åŠ¡ä¸­ï¼Œå®šæ—¶é‡‡é›†# pushgateway ippushgatewayIp=#è·å–ä¸»æœºåï¼Œå¸¸ä¼ è¾“åˆ°Prometheusæ ‡ç­¾ä»¥ä¸»æœºåinstance_name=`hostname -f | cut -d'.' -f1`#åˆ¤æ–­ä¸»æœºåä¸èƒ½æ˜¯localhostä¸ç„¶å‘é€è¿‡çš„æ•°æ®ä¸çŸ¥é“æ˜¯é‚£ä¸ªä¸»æœºçš„ if [ $instance_name == &quot;localhost&quot; ];thenecho &quot;Hostname must not localhost&quot;exit 1fi#è‡ªå®šä¹‰keyï¼Œåœ¨Prometheuså³å¯ä½¿ç”¨keyæŸ¥è¯¢label=&quot;count_estab_connections&quot; #è·å–TCP estab è¿æ¥æ•°count_estab_connections=`netstat -an | grep -i 'established' | wc -l`#å°†æ•°æ®å‘é€åˆ°pushgatewayå›ºå®šæ ¼å¼echo &quot;$label $count_estab_connections&quot;  | curl --data-binary @- http://$pushgatewayIp:9091/metrics/job/pushgateway/instance/$instance_name</code></pre><h1>è¢«ç›‘æ§ç«¯ç»„ä»¶</h1><h2 id="node-exporter-ç‰©ç†èŠ‚ç‚¹ç›‘æ§ç»„ä»¶">node-exporter ç‰©ç†èŠ‚ç‚¹ç›‘æ§ç»„ä»¶</h2><blockquote><p>å®¿ä¸»æ•°æ®é‡‡é›†ç«¯ï¼Œéƒ¨ç½²åœ¨è¢«ç›‘æ§ä¸»æœºçš„9100ç«¯å£</p></blockquote><pre><code class="language-bash">cd /usr/local/wget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gzmkdir node_exportertar xf node_exporter-1.0.1.linux-amd64.tar.gz --strip-components 1 -C node_exportermv node_exporter-1.0.1.linux-amd64.tar.gz srccd node_exporter &amp;&amp; baseDir=`pwd`#---cat &gt; /usr/lib/systemd/system/node_exporter.service &lt;&lt;EOF[Unit]Description=node_exporter server daemon[Service]Restart=on-failureExecStart=$&#123;baseDir&#125;/node_exporter[Install]WantedBy=multi-user.targetEOF#---systemctl daemon-reloadsystemctl start node_exportersystemctl status node_exportercurl http://localhost:9100/metrics # æŸ¥çœ‹è·å–çš„ç›‘æ§æ•°æ®systemctl enable node_exporter</code></pre><h2 id="cadvisor-å®¹å™¨ç›‘æ§ç»„ä»¶">cadvisor å®¹å™¨ç›‘æ§ç»„ä»¶</h2><blockquote><p>å®¹å™¨æ•°æ®é‡‡é›†ç«¯ï¼Œéƒ¨ç½²åœ¨è¢«ç›‘æ§å®¹å™¨æ‰€åœ¨å®¿ä¸»çš„10052ç«¯å£</p></blockquote><pre><code class="language-bash">dockerRoot=`docker info | awk -F':'  '/Docker Root Dir/&#123;print $2&#125;'|sed 's@^ *@@g'`echo $dockerRootdocker run \  --volume=/:/rootfs:ro \  --volume=/var/run:/var/run:rw \  --volume=/sys:/sys:ro \  --volume=$&#123;dockerRoot&#125;/:/var/lib/docker:ro \  --volume=/dev/disk/:/dev/disk:ro \  --publish=10052:8080 \  --privileged=true \  --detach=true \  --name=cadvisor \  google/cadvisor:latest</code></pre><h1>ä½¿ç”¨</h1><h2 id="æ·»åŠ -grafana-æ•°æ®æº-proms">æ·»åŠ  grafana æ•°æ®æº : proms</h2><p><img src="/posts/65820315/image-20201218135400147.png" alt="image-20201218135400147"></p><h2 id="æ·»åŠ -grafana-ç›‘æ§æ¨¡æ¿">æ·»åŠ  grafana ç›‘æ§æ¨¡æ¿</h2><p><img src="/posts/65820315/image-20201218135502105.png" alt="image-20201218135502105"></p><p>nodeæ¨¡æ¿ï¼š<a href="https://grafana.com/grafana/dashboards/8919">https://grafana.com/grafana/dashboards/8919</a></p><p>dockeræ¨¡æ¿ï¼š<a href="https://grafana.com/grafana/dashboards/10566">https://grafana.com/grafana/dashboards/10566</a></p>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜serverå®‰è£…æ³¨æ„äº‹é¡¹</title>
      <link href="posts/ed865d2f/"/>
      <url>posts/ed865d2f/</url>
      
        <content type="html"><![CDATA[<ol><li><p>æ•°æ®åº“ç¼–ç ä¸€å®šè¦å®‰è£…å®˜æ–¹æ¥å‘½ä»¤æ¥è®¾ç½®ï¼Œä¾‹å¦‚zabbix5ç¼–ç æ˜¯ utf8å’Œutf8_bin</p></li><li><p>æœ€åwebæ§åˆ¶å°å®‰è£…ç•Œé¢ï¼Œè¦ç¡®ä¿zabbix-serverå¯ä»¥è®¿é—®è®¾ç½®çš„ hostname çš„ 10051 ç«¯å£ã€‚å¦‚æœhostnameå†™çš„åŸŸåï¼Œé‚£ä¹ˆè¦ç¡®ä¿zabbix-serverå¯ä»¥é€šè¿‡ hostsæœ¬åœ°è§£ææˆ–è€…å¤–ç½‘è®¿é—®10051ç«¯å£</p></li><li><p>zabbix-server çš„ agent è¦ä½¿ç”¨æ‹‰å–æ¨¡å¼ï¼Œå› ä¸ºå®˜æ–¹ç»™çš„æ¨¡æ¿æ— æ³•ç›´æ¥ä¿®æ­£ä¸ºæ¨æµæ¨¡å¼</p></li><li><p>æŠ¥è­¦åª’ä»‹è®¾ç½®</p><p>è„šæœ¬è®¾ç½®</p><pre><code class="language-bash">è„šæœ¬å‚æ•°&#123;ALERT.SENDTO&#125;&#123;ALERT.SUBJECT&#125;&#123;ALERT.MESSAGE&#125;</code></pre><p>é—®é¢˜æ¨¡æ¿</p><pre><code class="language-bash">æ•…éšœ: &#123;TRIGGER.NAME&#125;ã€[éª·é«…]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ID : &#123;EVENT.ID&#125;ã€UTC+0ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;ã€å‘Šè­¦ç­‰çº§ã€‘: &#123;TRIGGER.SEVERITY&#125;ã€ä¸»æœºä¿¡æ¯1ã€‘: &#123;HOST.NAME&#125;ã€ä¸»æœºä¿¡æ¯2ã€‘: &#123;HOSTNAME1&#125;ã€å‘Šè­¦ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€å‘Šè­¦é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</code></pre><p>æ¢å¤æ¨¡æ¿</p><pre><code class="language-bash">æ¢å¤: &#123;TRIGGER.NAME&#125;ã€[OK]ã€‘=ã€‹&#123;TRIGGER.SEVERITY&#125; äº‹ä»¶ID : &#123;EVENT.ID&#125;ã€UTC+0ã€‘: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;ã€å‘Šè­¦ç­‰çº§ã€‘: &#123;TRIGGER.SEVERITY&#125;ã€ä¸»æœºä¿¡æ¯1ã€‘: &#123;HOST.NAME&#125;ã€ä¸»æœºä¿¡æ¯2ã€‘: &#123;HOSTNAME1&#125;ã€å‘Šè­¦ä¿¡æ¯ã€‘: &#123;TRIGGER.NAME&#125;ã€å‘Šè­¦é¡¹ç›®ã€‘: &#123;TRIGGER.KEY1&#125;ã€é—®é¢˜è¯¦æƒ…ã€‘: &#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;ã€å½“å‰çŠ¶æ€ã€‘: &#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125;</code></pre></li><li><p>é¢„è­¦ç”¨æˆ·æ·»åŠ è¶…ç®¡æƒé™</p></li><li><p>ä¸­æ–‡å­—ä½“</p><pre><code class="language-bash">yum install google-noto-sans-simplified-chinese-fonts.noarch -yrm -rf /etc/alternatives/zabbix-web-fontln -s /usr/share/fonts/google-noto/NotoSansSC-Regular.otf /etc/alternatives/zabbix-web-font</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜ä»å®¹å™¨ä¸­è®¿é—®å®¿ä¸»æœºdockerå‘½ä»¤</title>
      <link href="posts/3e0f2183/"/>
      <url>posts/3e0f2183/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æˆ‘çš„jenkinsæ˜¯è¿è¡Œåœ¨dockerä¸­ï¼Œä½†æ˜¯jenkinså®˜æ–¹çš„é•œåƒé‡Œå´æ²¡æœ‰dockerå‘½ä»¤ã€‚</p><p>ä»¥è‡³äºæ— æ³•åœ¨æµæ°´çº¿ä¸­æ‰“åŒ…dockeré•œåƒã€‚</p><h2 id="æ–¹æ³•">æ–¹æ³•</h2><p>é¦–å…ˆï¼Œéœ€è¦å°†dockerå‘½ä»¤ã€docker.sockæ–‡ä»¶ä»¥åŠç›¸å…³ä¾èµ–æ–‡ä»¶æ˜ å°„åˆ°å®¹å™¨å†…ã€‚</p><p>å…¶æ¬¡ï¼Œä»¥rootç”¨æˆ·è®¿é—®å®¹å™¨ï¼Œåœ¨å®¹å™¨ä¸­æ·»åŠ dockerç»„ï¼Œå¹¶ä¸”ç»„idéœ€è¦å’Œå®¿ä¸»æœºä¸­çš„dockerç»„idä¸€è‡´ã€‚</p><p>æœ€åï¼Œä»¥rootç”¨æˆ·è®¿é—®å®¹å™¨ï¼Œå¹¶å°†jenkinsç”¨æˆ·åŠ å…¥åˆ°å®¹å™¨ä¸­çš„dockerç»„ä¸­ã€‚</p><p>æœ€æœ€åï¼Œæœ€å…³é”®çš„æ¥äº†ï¼Œ ä¸€å®šè¦é‡å¯ä¸€ä¸‹ jenkins å®¹å™¨ã€‚ã€‚ã€‚</p><h2 id="ç›¸å…³å‘½ä»¤">ç›¸å…³å‘½ä»¤</h2><pre><code class="language-bash"># é¢å¤–çš„æ˜ å°„æ–‡ä»¶ï¼ˆå®¿ä¸»æœºæ–‡ä»¶å’Œå®¹å™¨å†…çš„æ˜ å°„è·¯å¾„ï¼Œä»¥å®é™…æƒ…å†µä¸ºå‡†ï¼‰-v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker -v /usr/lib64/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7# ä»¥ root ç”¨æˆ·è®¿é—® jenkins å®¹å™¨ï¼ˆå®¿ä¸»æœºçš„ç»„IDä»¥å®é™…æƒ…å†µä¸ºå‡†ï¼‰docker exec -it -u root jenkins /bin/bashgroupadd -g xxx dockerusermod -aG docker jenkins# é‡å¯ jenkins å®¹å™¨docker stop jenkins &amp;&amp; docker start jenkins</code></pre><h2 id="æ³¨æ„">æ³¨æ„</h2><p>åœ¨å®¹å™¨å†…æ‰§è¡Œçš„ groupadd å’Œ usermod å‘½ä»¤ï¼Œéœ€è¦åœ¨æ¯æ¬¡å˜æ›´å®¹å™¨é•œåƒåï¼Œé‡æ–°æ‰§è¡Œï¼Œå› ä¸ºå‘½ä»¤çš„ç›¸å…³ç»“æœéƒ½æ˜¯å®¹å™¨å†…æ•°æ®ï¼Œæ¸…ç†åä¸ä¼šä¿ç•™ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜ssh-MFAè‡ªåŠ¨ç™»é™†</title>
      <link href="posts/5db0cd07/"/>
      <url>posts/5db0cd07/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ssh å…³è”MFAå,å®‰å…¨åº¦å¢åŠ äº†å¾ˆå¤š,ä½†æ˜¯æ¯æ¬¡æ‰‹åŠ¨è¾“å…¥MFAåŠ¨æ€å£ä»¤æ¯”è¾ƒéº»çƒ¦.æ‰€ä»¥è®°å½•ä¸€ä¸‹è‡ªåŠ¨äº¤äº’è¾“å…¥MFAå£ä»¤</p><h2 id="å‘½ä»¤å®‰è£…">å‘½ä»¤å®‰è£…</h2><pre><code class="language-bash">sudo apt install oathtool gnupg2 expect</code></pre><blockquote><p>oathtool æ˜¯æˆ‘ä»¬ç”¨æ¥ç”ŸæˆMFAå£ä»¤çš„å·¥å…·.</p><p>expect ç”¨æ¥ç¼–å†™äº¤äº’ç¨‹åº</p></blockquote><h2 id="ç™»é™†äº¤äº’è„šæœ¬">ç™»é™†äº¤äº’è„šæœ¬</h2><pre><code class="language-bash">#!/usr/bin/expectset timeout 5set MFAToken &quot;æˆ‘æ˜¯MFAçš„TOKEN&quot;spawn æˆ‘æ˜¯sshå‘½ä»¤expect &quot;MFA auth&quot;send &quot;[exec oathtool -b --totp $MFAToken]\r&quot;;interact</code></pre><blockquote><p>å°†è„šæœ¬ä¸­çš„TOKENå’Œå‘½ä»¤æ›¿æ¢ä¸ºè‡ªå·±çš„.</p></blockquote><h2 id="æ³¨æ„">æ³¨æ„</h2><p>å¦‚æœä½ å‘ç°ä½ ç™»é™†ä¸äº†, æ¯æ¬¡éƒ½éªŒè¯é”™è¯¯, é‚£ä¹ˆä½ åº”è¯¥æ£€æŸ¥ä¸‹ä½ æœºå™¨çš„æ—¶é—´æ˜¯å¦æ­£å¸¸.</p>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> ssh </tag>
            
            <tag> mfa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jdkâ˜å®‰è£…å’Œé…ç½®</title>
      <link href="posts/ac6b3b36/"/>
      <url>posts/ac6b3b36/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>oracle jdk ç°åœ¨æ˜¯å•†ä¸šäº§å“äº†, æ‰€ä»¥çº¿ä¸Šæœ€å¥½è¿˜æ˜¯ç”¨ openjdk.</p><h2 id="å®‰è£…">å®‰è£…</h2><p><a href="https://adoptopenjdk.net/installation.html#linux-pkg">https://adoptopenjdk.net/installation.html#linux-pkg</a></p><h2 id="é…ç½®">é…ç½®</h2><pre><code class="language-bash">export JAVA_HOME=/usr/local/jdkexport PATH=$JAVA_HOME/bin:$PATHexport MANPATH=$JAVA_HOME/manexport CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/jre/lib/rt.jar</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jdk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜fcgiä¸­aliasçš„ä½¿ç”¨</title>
      <link href="posts/58a1c0c7/"/>
      <url>posts/58a1c0c7/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>ä¼—æ‰€å‘¨çŸ¥, nginx åœ¨é…ç½®é™æ€èµ„æºçš„æ—¶å€™, root å’Œ alias åˆ†åˆ«æ˜¯ä¸¤ç§æŒ‡å®šèµ„æºè·¯å¾„çš„æ–¹å¼.</p><p>å¦‚æœï¼š</p><p>â€‹url æ˜¯ <code>http://xxx.com/god/a.jpg</code>ï¼Œä¸” location åŒ¹é…çš„æ˜¯ <code>/god/</code>.</p><p>åˆ™ï¼š</p><p>â€‹å½“ç”¨ root å®šä½èµ„æºè·¯å¾„æ—¶, root é…ç½®çš„å€¼=åŸŸå<code>xxx.com</code> éƒ¨åˆ†æ‰€å¯¹åº”çš„è·¯å¾„, æ­¤æ—¶ a.jpg çš„ç‰©ç†è·¯å¾„å°±æ˜¯  $root/god/a.jpg</p><p>â€‹å½“ç”¨ alias å®šä½èµ„æºè·¯å¾„æ—¶, alias é…ç½®çš„å€¼=url<code>xxx.com/god/</code>éƒ¨åˆ†æ‰€å¯¹åº”çš„è·¯å¾„, æ­¤æ—¶ a.jpg çš„ç‰©ç†è·¯å¾„å°±æ˜¯ ${alias}a.jpg</p><p>å³</p><pre><code class="language-bash">location ^~ /god/ &#123;    root /export/webapps/xxx.com;&#125;# æˆ–è€…location ^~ /god/ &#123;    alias /export/webapps/xxx.com/god/;&#125;</code></pre><p>å½“æˆ‘é‡‡ç”¨ä¸Šè¿°è§„åˆ™, ä½¿ç”¨aliasé…ç½®fcgiçš„æ—¶å€™,ç°å®ç»™äº†æˆ‘æš´å‡»â€¦å¦¥å¦¥çš„404äº†.</p><h2 id="åœ¨fcgiç¯å¢ƒä¸‹-alias-çš„é…ç½®">åœ¨fcgiç¯å¢ƒä¸‹, alias çš„é…ç½®</h2><p>åºŸè¯ä¸å¤šè¯´, ç›´æ¥ä¸Šç»“æœ.</p><pre><code class="language-bash">location ^~ /god/ &#123;     index  index.php index.html index.htm;     root /export/webapps/xxx.com/;     location ~* &quot;\.php$&quot; &#123;         try_files      $uri =404;         fastcgi_pass   127.0.0.1:9000;         fastcgi_index  index.php;         include        fastcgi.conf;         fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;     &#125; &#125; location ^~ /god/ &#123;    index  index.php index.html index.htm;    alias /export/webapps/xxx.com/god/;    location ~* &quot;\.php$&quot; &#123;        try_files      $uri =404;        fastcgi_pass   127.0.0.1:9000;        include        fastcgi.conf;        fastcgi_param  SCRIPT_FILENAME  $request_filename;    &#125;&#125;</code></pre><blockquote><p>å®˜æ–¹çš„ä¾‹å­:</p><p><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#use-request-filename-for-script-filename">https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#use-request-filename-for-script-filename</a></p></blockquote><p>å…³é”®ç‚¹ï¼š</p><ol><li>å½“ä½ ç”¨ alias è€Œä¸æ˜¯ root çš„æ—¶å€™, ä½ éœ€è¦å°†$document_root$fastcgi_script_nameæ›¿æ¢æˆ$request_filename</li><li>å½“ä½ ä¸åœ¨ä½¿ç”¨$fastcgi_script_nameçš„æ—¶å€™ï¼Œä½ éœ€è¦æ˜¾æ€§çš„æ·»åŠ indexï¼Œè€Œä¸æ˜¯fastcgi_index ,å› ä¸º$request_filenameå¹¶ä¸èƒ½å…³è”fastcgi_indexã€‚</li></ol><p>åŸå› åœ¨äº$document_rootçš„å€¼ï¼Œæ¥è‡ªäºrootæˆ–è€…aliasï¼Œ$fastcgi_script_nameæ€»æ˜¯æ‹¿url_path</p><p>å‡è®¾ä½ è®¿é—® /god/api.php,  è€Œè¿™ä¸ªæ–‡ä»¶çš„ç‰©ç†è·¯å¾„æ˜¯/export/webapps/xxx.com/god/api.phpã€‚</p><p>æ­¤æ—¶ï¼Œ</p><p>å½“ä½ ç”¨ alias çš„æ—¶å€™</p><p>$document_root = alias = /export/webapps/xxx.com/god/</p><p>$fastcgi_script_name = /god/api.php</p><p>$document_root$fastcgi_script_name=/export/webapps/xxx.com/god//god/api.php</p><p>è€Œ$request_filenameå½“å‰æ–‡ä»¶çš„è¯·æ±‚è·¯å¾„ï¼Œç”±rootæˆ–è€…alias+uriç›¸å¯¹è·¯å¾„</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> fcgi </tag>
            
            <tag> php </tag>
            
            <tag> alias </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜è§’è‰²</title>
      <link href="posts/720afd15/"/>
      <url>posts/720afd15/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>è§’è‰²çš„ä½œç”¨å°±æ˜¯è§„èŒƒåŒ–ï¼Œå°†ä¸€ä¸ªplaybookå„éƒ¨åˆ†åˆ†é—¨åˆ«ç±»çš„æ”¾ç½®åœ¨è§„å®šå¥½çš„ç›®å½•ä¸­ã€‚å°±å¦‚åŒlinuxç³»ç»Ÿä¸€æ ·ï¼Œ/etc/å°±æ˜¯æ”¾é…ç½®çš„ï¼Œ/bin å°±æ˜¯æ”¾ç¨‹åºçš„ï¼Œ/tmp å°±æ˜¯æ”¾ä¸´æ—¶æ–‡ä»¶çš„ â€¦</p><p>ansible ä¼šåŸºäºå®˜æ–¹è§„å®šå¥½çš„ç›®å½•ç»“æ„, å»è‡ªåŠ¨åŠ è½½ç›®å½•ä¸­çš„æ–‡ä»¶. å½“ä¸€ä¸ªéœ€æ±‚å¾ˆå¤æ‚çš„æ—¶å€™, æˆ‘ä»¬å°±å¯ä»¥åŸºäºè§’è‰²å¯¹éœ€æ±‚è¿›è¡Œåˆ†ç»„.</p><p>æœ€å, å¦‚æœä½ ä¸æŒ‰ç…§è¿™ä¸ªè§„å®šæ¥èµ°, é‚£ä¹ˆansibleè§’è‰²æ¨¡å—å°±æ‰¾ä¸åˆ°ç›¸å…³ä¸œè¥¿.</p><h2 id="è§’è‰²ç»“æ„">è§’è‰²ç»“æ„</h2><p>è¿™æ˜¯ä¸€ä¸ªå®˜æ–¹é¡¹ç›®çš„ä¾‹å­</p><blockquote><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html#</a>  å®˜æ–¹æ–‡æ¡£</p></blockquote><pre><code class="language-bash">site.ymlwebservers.ymlfooservers.ymlroles/    common/        tasks/        handlers/        files/        templates/        vars/        defaults/        meta/    webservers/        tasks/        defaults/        meta/</code></pre><p>ä¾‹å­ä¸­ï¼Œcommon å’Œ webservers å°±æ˜¯ä¸¤ä¸ªè§’è‰²<br>å…³äºè§’è‰²çš„ç›®å½•ï¼Œå¿…é¡»åŒ…å«ä¸‹é¢åˆ—ä¸¾å‡ºæ¥çš„ç›®å½•ä¹‹ä¸€ï¼Œç›®å½•å¯ä»¥ä¸ºç©ºã€‚ä½†æ˜¯å¦‚æœä½ ä½¿ç”¨åˆ°äº†æŸä¸ªç›®å½•ï¼Œé‚£ä¹ˆéƒ¨åˆ†ç›®å½•éœ€è¦åŒ…å«main.ymlæ–‡ä»¶ã€‚</p><ul><li>tasks è§’è‰²ç”¨åˆ°çš„ä¸»è¦ä»»åŠ¡åˆ—è¡¨</li><li>handlers è§’è‰²æˆ–è€…è§’è‰²å¤–ç”¨åˆ°çš„ä»»åŠ¡åç»­å¤„ç†</li><li>defaults è§’è‰²é»˜è®¤å˜é‡</li><li>vars è§’è‰²å…¶ä½™å˜é‡ï¼Œä¼˜å…ˆçº§å¤§äº defaults ä¸­å®šä¹‰çš„å˜é‡</li><li>files è§’è‰²éƒ¨ç½²ä¸­ç‰µæ‰¯åˆ°çš„æ–‡ä»¶</li><li>templates è§’è‰²çš„jinja2æ¨¡æ¿</li><li>meta è§’è‰²çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚è§’è‰²çš„å±æ€§(ä½œè€…, è¯´æ˜, ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ç­‰)</li></ul><p>æœ€åï¼Œç›®å½•ä¸­main.ymlç”¨æ¥å­˜å‚¨ä¸»é…ç½®ä¿¡æ¯ã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥åŒ…å«å…¶å®ƒçš„å­ä»»åŠ¡ï¼Œåœ¨å­ä»»åŠ¡ä¸­è¯¦ç»†æè¿°ã€‚<br>ä¾‹å¦‚ï¼Œåœ¨ tasks/main.yml ä¸­ï¼Œé€šè¿‡ import_tasksï¼ŒåŒ…å«å…¶å®ƒå­ä»»åŠ¡ï¼Œå°±åƒä¸‹é¢è¿™æ ·</p><blockquote><p>main åŒ…å« redhat å’Œ debianã€‚å½“ç³»ç»Ÿæ˜¯ redhat æ—¶ï¼Œå®‰è£… httpd åŒ…ï¼Œå½“ç³»ç»Ÿæ˜¯ debian æ—¶ï¼Œå®‰è£… apache2 åŒ…</p></blockquote><pre><code class="language-yaml"># roles/xxx/tasks/main.yml- name: added in 2.4, previously you used 'include'  import_tasks: redhat.yml  when: ansible_facts['os_family']|lower == 'redhat'- import_tasks: debian.yml  when: ansible_facts['os_family']|lower == 'debian'# roles/xxx/tasks/redhat.yml- yum:    name: &quot;httpd&quot;    state: present# roles/xxx/tasks/debian.yml- apt:    name: &quot;apache2&quot;    state: present</code></pre><h2 id="ä½¿ç”¨è§’è‰²">ä½¿ç”¨è§’è‰²</h2><pre><code class="language-yaml">---# file: site.yml- include: webservers.yml- include: fooservers.yml</code></pre><pre><code class="language-yaml">---# file: webservers.yml- hosts: webservers  roles:    - common    - webservers</code></pre><p>åªè¿è¡Œ webservers è§’è‰²ï¼Œå¯ä»¥é€šè¿‡ site.yml æ·»åŠ  limit é™åˆ¶æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨</p><pre><code class="language-bash">ansible-playbook site.yml --limit webserversansible-playbook webservers.yml</code></pre><h2 id="è§’è‰²ä¼˜å…ˆçº§">è§’è‰²ä¼˜å…ˆçº§</h2><p>è§’è‰²ä¸­é’ˆå¯¹ tasks, handlers, vars æœ‰ä¸€ä¸ªä¼˜å…ˆçº§æ¦‚å¿µ. ä¼˜å…ˆçº§å¤§çš„ä¼šè¦†ç›–æ‰ä¼˜å…ˆçº§å°çš„é…ç½®.</p><p>ä¼˜å…ˆçº§ç”±å¤§åˆ°å°å¦‚ä¸‹:</p><p><code>cli å±‚é¢å‚æ•° &gt; role-xxx-dir &gt; playbook-xxx &gt; role-defaults-dir</code></p><p>è¿™é‡Œ cli å±‚é¢å‚æ•°æŒ‡çš„æ˜¯ ansible-playbook -e vara=â€˜aâ€™ test.play è¿™ç§å¤–éƒ¨ä¼ é€’å˜é‡çš„è¡Œä¸º</p><p>è¿™é‡Œ role-xxx-dir æŒ‡çš„æ˜¯ role ç‰¹å®šç›®å½•é‡Œçš„é…ç½®, ä¾‹å¦‚ tasks, handlers, vars</p><p>è¿™é‡Œ playbook-xxx æŒ‡çš„æ˜¯ç›´æ¥å†™å…¥ ploybook ä¸­çš„éƒ¨åˆ†</p><p>è¿™é‡Œ role-defaults-dir æŒ‡çš„æ˜¯è§’è‰²ç›®å½•ä¸­çš„ defaults é»˜è®¤å˜é‡ç›®å½•</p><h2 id="è§’è‰²å¤åˆ¶">è§’è‰²å¤åˆ¶</h2><p>å¦‚æœä½ æƒ³è®©ä¸€ä¸ªè§’è‰²å¤šæ¬¡æ‰§è¡Œï¼Œå°±å¦‚åŒä¸‹é¢è¿™æ ·</p><pre><code class="language-yaml">---- hosts: webservers  roles:    - moo    - moo</code></pre><p>æœ‰ä¸‹åˆ—ä¸¤ç§æ–¹å¼:</p><ol><li>mooï¼Œæ‹¥æœ‰ä¸åŒçš„å‚æ•°</li><li>å°†<code>allow_duplicates: true</code>å†™å…¥ moo/meta/main.yml</li></ol><h2 id="è§’è‰²æ ‡ç­¾">è§’è‰²æ ‡ç­¾</h2><p>æˆ‘ä»¬ä¸€å®šè¦é’ˆå¯¹è§’è‰²ä¸­çš„tasksæ·»åŠ æ ‡ç­¾(tags). åŸå› åœ¨äº, æœ‰äº›æ—¶å€™, å½“æˆ‘ä»¬åªæƒ³ä¿®æ”¹éƒ¨ç½²å¾ˆä¹…çš„ä¸€å †æœºå™¨çš„æŸä¸ªæœåŠ¡æ—¶, æˆ‘ä»¬åªéœ€è¦åœ¨æ‰§è¡Œè§’è‰²çš„ playbook çš„æ—¶å€™,è¿½åŠ  --tags å³å¯å¸®åŠ©æˆ‘ä»¬æ‰§è¡Œé¡¹ç›®ä¸­æŸä¸€ä¸ªä»»åŠ¡ï¼Œè€Œä¸å¿…æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡.</p><p>æ¯”å¦‚, æˆ‘ä»¬æœ‰ä¸ªéƒ¨ç½²é¡¹ç›®, å…¶ä¸­æœ‰ä¸€ä¸ªåˆå§‹åŒ–è§’è‰²( common ). common ä¸­æœ‰ä¼—å¤šçš„åˆå§‹åŒ–ä»»åŠ¡, å…¶ä¸­ä¸€ä¸ªä»»åŠ¡æ˜¯ ntp æœåŠ¡çš„ å®‰è£…/é…ç½®/å¯åŠ¨/é‡å¯ .</p><p>ntp æœåŠ¡é…ç½®å¦‚ä¸‹:</p><pre><code class="language-yaml">---# file: roles/common/tasks/main.yml- name: be sure ntp is installed  yum: pkg=ntp state=installed  tags: ntp- name: be sure ntp is configured  template: src=ntp.conf.j2 dest=/etc/ntp.conf  notify:    - restart ntpd  tags: ntp- name: be sure ntpd is running and enabled  service: name=ntpd state=running enabled=yes  tags: ntp  ---# file: roles/common/handlers/main.yml- name: restart ntpd  service: name=ntpd state=restarted</code></pre><p>ç°åœ¨, æˆ‘ä»¬åªæƒ³ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒçš„ ntp æœåŠ¡çš„é…ç½®, é‚£ä¹ˆåªéœ€è¦å°† ntp.conf.j2 æ¨¡æ¿é…ç½®å¥½ä¹‹å, é‡æ–°æ‰§è¡Œè¿™ä¸ªplaybookså³å¯. å°±æƒ³ä¸‹é¢è¿™æ ·:</p><pre><code class="language-bash">ansible-playbook -i production site.yml --tags ntp</code></pre><h2 id="å†™å¥½çš„playbook">å†™å¥½çš„playbook</h2><p><a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/</a></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜æ¨¡æ¿</title>
      <link href="posts/724fda19/"/>
      <url>posts/724fda19/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å½“ä½ ç”¨ansibleè¿›è¡Œå¤šæœºå™¨çš„é…ç½®è°ƒæ•´ï¼Œä¸”è°ƒæ•´çš„ä¸œè¥¿éƒ½ä¸€æ¨¡ä¸€æ ·ï¼Œæ­¤æ—¶ä½ ä¸ä¼šæ‹’ç»æ¨¡æ¿çš„è¯±æƒ‘ã€‚</p><p>ansibleçš„æ¨¡æ¿æ˜¯jinja2ï¼Œæ‰€ä»¥jinja2çš„ç‰¹æ€§ï¼Œåœ¨è¿™é‡Œéƒ½å¯ä»¥ç”¨ã€‚</p><blockquote><p>æ¨¡æ¿ä¸­ï¼Œä¸è¦å‡ºç°ä»»ä½•ä½ è§‰å¾—æ¨¡æ¿ä¼šå¿½ç•¥çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºç©ºæ ¼</p></blockquote><h2 id="æ¨¡å—-template">æ¨¡å— template</h2><p>å‚æ•°ï¼š</p><ul><li>src æ¨¡æ¿æ–‡ä»¶è·¯å¾„</li><li>dest ç›®çš„æ–‡ä»¶è·¯å¾„</li></ul><p>ç‰µæ‰¯åˆ°ç›®çš„è·¯å¾„ï¼Œå¿…ç„¶æœ‰æƒé™å‚æ•°</p><ul><li>owner ç›®çš„å±ä¸»</li><li>group ç›®çš„å±ç»„</li><li>mode ç›®çš„æƒé™</li></ul><p>è¦†ç›–ä¸å¤‡ä»½</p><ul><li>force è¦†ç›–ï¼Œyes / no</li><li>backup å¤‡ä»½ï¼Œ yes / no ï¼Œ è‹¥ä¸º yes ï¼Œåˆ™ç›®çš„é‡åæ–‡ä»¶ä¼šå…ˆæ”¹å</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - template:        src: ~/test.j2        dest: ~/test.info</code></pre><h2 id="æ¨¡æ¿åˆ†éš”ç¬¦">æ¨¡æ¿åˆ†éš”ç¬¦</h2><pre><code class="language-bash">&#123;&#123; &#125;&#125; ä¸€èˆ¬ç”¨æ¥å¡«å……å˜é‡ï¼Œå¯ä»¥æ˜¯è¿‡æ»¤å™¨ï¼Œä¹Ÿå¯ä»¥å¡«å……è¡¨è¾¾å¼ï¼Œä»è€Œè¿”å›ç›¸åº”çš„å€¼ï¼Œä¾‹å¦‚ &#123;&#123; 1==1 &#125;&#125; è¿”å› True&#123;% %&#125; ä¸€èˆ¬ç”¨æ¥å¡«å……æ§åˆ¶è¯­å¥&#123;# #&#125; æ¨¡æ¿æ³¨é‡Šè¯­å¥ï¼Œå¹¶éæ¸²æŸ“åä¼šå‡ºç°#  ... ## è¿™ä¸€ç§ ansible è²Œä¼¼ä¸æ”¯æŒï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥</code></pre><h3 id="åˆ†éš”ç¬¦1">åˆ†éš”ç¬¦1</h3><pre><code class="language-jinja2"># &#123;&#123; &#125;&#125;&#123;# æ™®é€šå˜é‡ #&#125;&#123;&#123; foo.bar &#125;&#125;&#123;&#123; foo['bar'] &#125;&#125;&#123;# ä»¥è¿‡æ»¤å™¨ lookup ä¸ºä¾‹ #&#125;&#123;&#123; lookup('file', '~/test.file') &#125;&#125;&#123;&#123; lookup('env', 'PATH' )&#125;&#125;</code></pre><p>æœ€ç»ˆç›®çš„æ–‡ä»¶ï¼Œä¼šè¾“å‡º<code>~/test.file</code> å†…å®¹å’Œ <code>$PATH</code> å†…å®¹</p><blockquote><p>å­—ç¬¦ä¸²æ‹¼æ¥éœ€è¦ä½¿ç”¨<code>~</code>ï¼Œä¾‹å¦‚ <code>&quot;name:&quot;~name</code></p></blockquote><h3 id="åˆ†éš”ç¬¦2">åˆ†éš”ç¬¦2</h3><pre><code class="language-bash"># &#123;% %&#125;# å®˜ç½‘æ‰€æœ‰çš„æ§åˆ¶åˆ—è¡¨https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures</code></pre><h4 id="æ¡ä»¶æ§åˆ¶è¯­å¥-if">æ¡ä»¶æ§åˆ¶è¯­å¥ if</h4><pre><code class="language-jinja2">&#123;% if æ¡ä»¶1 %&#125;  pass&#123;% elif æ¡ä»¶2 %&#125;  pass&#123;% else %&#125;  pass &#123;% endif %&#125;</code></pre><h4 id="å¾ªç¯è¯­å¥-for">å¾ªç¯è¯­å¥ for</h4><pre><code class="language-jinja2">&#123;% for i in å¯è¿­ä»£å¯¹è±¡ %&#125;  &#123;&#123; i &#125;&#125;&#123;% endfor %&#125;</code></pre><blockquote><p>é»˜è®¤å¾ªç¯åï¼Œæ¯ä¸€ä¸ªå¾ªç¯å•ä½“ç‹¬å ä¸€è¡Œï¼Œå¦‚æœéœ€è¦åˆ é™¤ç‹¬å ï¼Œåˆ™éœ€è¦ç»™ç¬¬äºŒä¸ª%}å’Œç¬¬ä¸‰ä¸ªæ§åˆ¶ç¬¦{%åŠ å‡å·ï¼Œæœ€ç»ˆå˜ä¸º-%}å’Œ{%-ã€‚</p></blockquote><p>å…³äºå­—å…¸ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ iteritems() å‡½æ•°ï¼Œä»è€Œæ–¹ä¾¿çš„è·å–åˆ°å­—å…¸çš„ k å’Œ vã€‚ä¾‹å¦‚</p><pre><code class="language-jinja2">&#123;% for k,v in &#123;'name':'zhangsan', 'gender':'male'&#125;.iteritems() %&#125;  &#123;&#123; k &#125;&#125;:&#123;&#123; v &#125;&#125;&#123;% endfor %&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“åname:zhangsangender:male</code></pre><h4 id="æ¡ä»¶å’Œå¾ªç¯ç»„åˆè¯­å¥">æ¡ä»¶å’Œå¾ªç¯ç»„åˆè¯­å¥</h4><pre><code class="language-jinja2">&#123;% for i in å¯è¿­ä»£å¯¹è±¡ if æ¡ä»¶ %&#125;  æ»¡è¶³æ¡ä»¶è¯­å¥&#123;% else %&#125;  ä¸æ»¡è¶³æ¡ä»¶è¯­å¥&#123;% endfor %&#125;</code></pre><p>ä¾‹å¦‚</p><pre><code class="language-jinja2">&#123;% for i in [1,2,3,4] if i>2 %&#125;&#123;&#123; i &#125;&#125;'s index is &#123;&#123; loop.index &#125;&#125;&#123;% endfor %&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“å3's index is 14's index is 2</code></pre><blockquote><p>loop.index æ˜¯å¾ªç¯ä½“ç´¢å¼•ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸ªç–‘é—®ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œ3å’Œ4çš„ç´¢å¼•åº”è¯¥å°±æ˜¯3å’Œ4ï¼Œä¹‹æ‰€ä»¥æ˜¯1å’Œ2ï¼ŒåŸå› åœ¨äºå½“æ¡ä»¶æ§åˆ¶å’Œå¾ªç¯æ§åˆ¶ä½äºåŒä¸€è¡Œçš„æ—¶å€™ï¼Œå…ˆè¡Œè¿ç®—çš„æ˜¯ <code>[1,2,3,4] if i&gt;2</code>ï¼Œä¹‹åæ‰å¼€å§‹èµ°<code>for</code>å¾ªç¯ã€‚</p><p>å¦‚æœä½ æƒ³è¾“å‡ºåŸå§‹å¾ªç¯ä½“ï¼Œåˆ™éœ€è¦å°†æ¡ä»¶æ§åˆ¶è¯­å¥å¦èµ·ä¸€è¡Œï¼Œæ”¾åœ¨<code>for</code>å¾ªç¯å†…éƒ¨</p></blockquote><pre><code class="language-jinja2">&#123;% for i in [1,2,3,4] %&#125;&#123;% if i>2 %&#125;&#123;&#123; i &#125;&#125;'s index is &#123;&#123; loop.index &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“å3's index is 34's index is 4</code></pre><blockquote><p>ä¸Šè¿°çš„ loop.index åªæ˜¯jinja2çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œå…¶å®ƒæ–¹å¼å…·ä½“å¯è§å®˜ç½‘æ–‡æ¡£</p><p><a href="https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures">https://jinja.palletsprojects.com/en/master/templates/#list-of-control-structures</a></p></blockquote><h4 id="å®-macro">å® macro</h4><p>å®å°±æ˜¯ç±»ä¼¼äºå‡½æ•°çš„ä¸€ä¸ªä¸œè¥¿ã€‚</p><pre><code class="language-jinja2">&#123;# ç¼–å†™å® #&#125;&#123;% macro func() %&#125;å‡½æ•°ä½“&#123;% endmacro %&#125;&#123;# è°ƒç”¨å® #&#125;&#123;&#123; func() &#125;&#125;</code></pre><p>ä¾‹å¦‚ï¼š</p><pre><code class="language-jinja2">&#123;% macro func(a,b,c=3,d=4) %&#125;&#123;# å®ç¼–å†™çš„æ—¶å€™ï¼Œå®å‚æ•°ï¼Œè¦éµå¾ªé»˜è®¤å‚æ•°åœ¨å&#123;&#123; a &#125;&#125;&#123;&#123; b &#125;&#125;&#123;&#123; c &#125;&#125;&#123;&#123; d &#125;&#125;&#123;% endmacro %&#125;&#123;&#123; func(1,2,5) &#125;&#125;</code></pre><pre><code class="language-bash"># æ¸²æŸ“å1254</code></pre><blockquote><p>å½“ç»™å‡ºå‚æ•°è¶…å‡ºäº†å®æ‰€å®šä¹‰çš„å‚æ•°æ—¶ï¼Œæ ¹æ®æƒ…å†µï¼Œå®ä¼šå°†å¤šä½™çš„å‚æ•°å­˜åœ¨å˜é‡ä¸­ï¼Œå³ï¼š</p><p>è¶…å‡ºçš„ä¸ºéå…³é”®å­—å‚æ•°ï¼Œåˆ™å­˜æ”¾åœ¨ä¸€ä¸ªå«<code>varargs</code>çš„å…ƒç»„ä¸­</p><p>è¶…å‡ºçš„ä¸ºå…³é”®å­—å‚æ•°ï¼Œåˆ™å­˜æ”¾åœ¨ä¸€ä¸ªå«<code>kwargs</code>çš„å­—å…¸ä¸­</p></blockquote><h4 id="call-æ–¹æ³•">call æ–¹æ³•</h4><p>å¦‚åŒå½“å‰å‡½æ•°çš„è£…é¥°å™¨ï¼Œå¯ä»¥æ‰©å±•å½“å‰å®çš„åŠŸèƒ½</p><pre><code class="language-jinja2">&#123;# ç¼–å†™å® funcï¼Œå¹¶è°ƒç”¨ caller #&#125;&#123;% macro func(a) %&#125;æˆ‘æœ‰ä¸€ä¸ª&#123;&#123; a &#125;&#125;ã€‚&#123;&#123; caller(a) &#125;&#125;&#123;% endmacro %&#125;&#123;# ç¼–å†™å® func_ext #&#125;&#123;% macro func_ext(a,b) %&#125;ä½†&#123;&#123; b &#125;&#125;æ¯”&#123;&#123; a &#125;&#125;å¥½åƒã€‚&#123;% endmacro %&#125;&#123;# é€šè¿‡ call å…³è” funcï¼ŒåŠ è½½ func_ext #&#125;&#123;% call(a) func('æ±‰å ¡') %&#125;&#123;&#123; func_ext(a,'ä¸‰æ˜æ²»') &#125;&#125;&#123;% endcall %&#125;</code></pre><blockquote><p>calleræ˜¯callçš„å¯¹è±¡ï¼Œå› æ­¤callerä¹Ÿæ˜¯å¯ä»¥ç»™callä¼ å‚</p></blockquote><pre><code class="language-bash"># æ¸²æŸ“åæˆ‘æœ‰ä¸€ä¸ªæ±‰å ¡ã€‚ä½†ä¸‰æ˜æ²»æ¯”æ±‰å ¡å¥½åƒ</code></pre><h2 id="æ‰©å±•">æ‰©å±•</h2><blockquote><p>æ‰©å±•å®˜æ–¹æ–‡æ¡£ï¼Œå¯è§ <a href="https://jinja.palletsprojects.com/en/master/extensions/">https://jinja.palletsprojects.com/en/master/extensions/</a></p></blockquote><p>è¿™é‡Œæˆ‘åªç®€å•çš„è¯´ä¸€ä¸‹å¦‚ä½•å¯åŠ¨ <code>for</code> å¾ªç¯ä¸­çš„ <code>break</code> å’Œ <code>continue</code>ã€‚</p><p><code>ansible</code> ä¸­æ·»åŠ  <code>jinja2</code> æ‰©å±•ï¼Œéœ€è¦ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶ <code>/etc/ansible/ansible.cfg</code>ï¼Œæ‰¾åˆ° <code>jinja2_extensions </code>ï¼Œåœ¨åé¢è¿½åŠ æ‰©å±•é…ç½®å³å¯ï¼Œæ¯ä¸€ä¸ªæ‰©å±•ç”¨é€—å·<code>,</code>åˆ†å‰²ã€‚</p><p><code>break</code>å’Œ<code>continue</code> çš„æ‰©å±•åå«ï¼š<code>jinja2.ext.loopcontrols</code></p>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-include</title>
      <link href="posts/6ce01f58/"/>
      <url>posts/6ce01f58/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•å…¥é¢å¤–ä»»åŠ¡">å¼•å…¥é¢å¤–ä»»åŠ¡</h2><pre><code class="language-yaml">tasks:  - include: add.yml</code></pre><h2 id="ç»‘å®š-kv-å¯¹ï¼Œä»è€Œæ”¹å˜é¢å¤–ä»»åŠ¡é‡Œçš„å˜é‡">ç»‘å®š kv å¯¹ï¼Œä»è€Œæ”¹å˜é¢å¤–ä»»åŠ¡é‡Œçš„å˜é‡</h2><pre><code class="language-yaml">tasks:  - include: add.yml    var1=hello    var2=world</code></pre><h2 id="ç»‘å®š-tags-æ ‡è®°">ç»‘å®š tags æ ‡è®°</h2><blockquote><p>å¯ä»¥é€šè¿‡tagsæ‰§è¡Œç›¸åº”çš„é¢å¤–ä»»åŠ¡</p></blockquote><pre><code class="language-yaml:">tasks:  - include: add1.yml    tags: add1  - include: add2.yml    tags: add2</code></pre><pre><code class="language-bash">ansible-playbook test.play --tags add1 # ä»…æ‰§è¡Œ add1.yml ä»»åŠ¡</code></pre><h2 id="ç»‘å®š-loop-å¾ªç¯">ç»‘å®š loop å¾ªç¯</h2><pre><code class="language-yaml">tasks:  - include: add.yml    loop:      - [1,2,3]# add.yml- debug:  msg: &quot;loop-item: &#123;&#123; item &#125;&#125; in add.yml &quot;</code></pre><h2 id="ç»‘å®š-when-æ¡ä»¶">ç»‘å®š when æ¡ä»¶</h2><pre><code class="language-yaml">tasks:  - include: add.yml    when: 1 &lt; 2</code></pre><hr><p>ansible åœ¨å½“å‰ç‰ˆæœ¬2.9ä¸­ï¼Œæ¨èä½¿ç”¨ import_tasks å’Œ include_tasks æ¥æ›¿æ¢ includeï¼Œinclude æœªæ¥æœ‰å¯èƒ½ä¸åœ¨æ”¯æŒã€‚ï¼ˆä¸ºå•¥æ€»æ„Ÿè§‰ ansible å„ç§å˜å‘¢ï¼‰</p><p>import_tasks é™æ€ä»»åŠ¡å¯¼å…¥ï¼Œé™æ€ä»»åŠ¡ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸èƒ½ä»ä»»åŠ¡å¤–ä¼ é€’å˜é‡åˆ°ä»»åŠ¡ä¸­ã€‚</p><p>include_tasks åŠ¨æ€ä»»åŠ¡å¯¼å…¥ã€‚æ”¯æŒå¾ªç¯ä¼ é€’å˜é‡</p><p>import_tasks ç»‘å®š when çš„æ—¶å€™ï¼Œä¼šå°† when çš„æ¡ä»¶ä¸€å¯¹ä¸€çš„åº”ç”¨åˆ°ä»»åŠ¡æ–‡ä»¶ä¸­åˆ—å‡ºçš„æ‰€æœ‰ä»»åŠ¡</p><p>include_tasks ç»‘å®š when çš„æ—¶å€™ï¼Œä¼šå°† when çš„æ¡ä»¶ä»…åº”ç”¨åˆ°ä»»åŠ¡æ–‡ä»¶ã€‚å³åªè¦æ¡ä»¶ä¸ºçœŸï¼Œä»»åŠ¡æ–‡ä»¶é‡Œçš„æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šæ‰§è¡Œã€‚</p><p>å…³äºæ–°ç‰ˆå†™æ³•ï¼Œç»‘å®š tags çš„æ–¹å¼ï¼Œå’Œæ—§ç‰ˆå·®å¼‚æ¯”è¾ƒå¤§ï¼Œä¾‹å¦‚</p><h4 id="include-tasks">include_tasks</h4><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: test      include_tasks:         file: add.yml        apply:          tags:            - add      tags:        - always        # add.yml- debug:    msg: &quot;&#123;&#123; item &#125;&#125; is ok&quot;  loop: [1,2,3]</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> include </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoâ˜æœ¬åœ°æœç´¢</title>
      <link href="posts/f5c218d/"/>
      <url>posts/f5c218d/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>å®‰è£…å®Œ hexo-generator-search åï¼Œå‘ç°æœç´¢ç»“æœå§‹ç»ˆæ˜¯æ‰€æœ‰æ–‡ç« .</p><p>å¦‚æœä½ ç”¨çš„ä¹Ÿæ˜¯ <a href="https://github.com/Molunerfinn/hexo-theme-melody">Melody</a> ä¸»é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥å‚è€ƒå¦‚ä¸‹ä¿¡æ¯ï¼Œæ¥ç¡®è®¤ã€‚</p><h2 id="æ•ˆæœå›¾">æ•ˆæœå›¾</h2><p><img src="/posts/f5c218d/image-20200518121421437.png" alt="image-20200518121421437"></p><h2 id="è½¯ä»¶åŒ…">è½¯ä»¶åŒ…</h2><blockquote><p>æˆªè‡³ï¼š2020.05.18ï¼Œè½¯ä»¶åŒ…å¦‚ä¸‹</p></blockquote><pre><code class="language-bash">  &quot;dependencies&quot;: &#123;    &quot;gitalk&quot;: &quot;^1.6.2&quot;,    &quot;hexo&quot;: &quot;^4.0.0&quot;,    &quot;hexo-asset-image&quot;: &quot;^1.0.0&quot;,    &quot;hexo-deployer-git&quot;: &quot;^2.1.0&quot;,    &quot;hexo-generator-archive&quot;: &quot;^1.0.0&quot;,    &quot;hexo-generator-category&quot;: &quot;^1.0.0&quot;,    &quot;hexo-generator-index&quot;: &quot;^1.0.0&quot;,    &quot;hexo-generator-search&quot;: &quot;^2.4.0&quot;,    &quot;hexo-generator-tag&quot;: &quot;^1.0.0&quot;,    &quot;hexo-renderer-ejs&quot;: &quot;^1.0.0&quot;,    &quot;hexo-renderer-marked&quot;: &quot;^2.0.0&quot;,    &quot;hexo-renderer-pug&quot;: &quot;^1.0.0&quot;,    &quot;hexo-renderer-stylus&quot;: &quot;^1.1.0&quot;,    &quot;hexo-server&quot;: &quot;^1.0.0&quot;,    &quot;react&quot;: &quot;^15.3.1&quot;,    &quot;react-dom&quot;: &quot;^15.3.1&quot;  &#125;</code></pre><h2 id="config-yml">_config.yml</h2><blockquote><p>è¿½åŠ å†…å®¹å¦‚ä¸‹</p></blockquote><pre><code class="language-yaml">search:  path: search.xml  field: post  content: true</code></pre><h2 id="ä¸»é¢˜é…ç½®">ä¸»é¢˜é…ç½®</h2><blockquote><p>ä¿®æ”¹å†…å®¹</p></blockquote><pre><code class="language-yaml">local_search:  enable: true</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜å®‰è£…</title>
      <link href="posts/6209085/"/>
      <url>posts/6209085/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æ­¤è„šæœ¬ç”¨äºå®‰è£… nginx;tengine;openresty. å®‰è£…ç‰ˆæœ¬ä¸ºï¼š</p><ul><li>nginx: 1.14</li><li>openresty: 1.15.8.3</li><li>tengine: 2.1.2 # è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„ç‰ˆæœ¬â€¦</li></ul><h4 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h4><p>å› ä¸ºæ˜¯ç¼–è¯‘å®‰è£…ï¼Œæ‰€ä»¥äº§å‡ºç›®å½•å‡åœ¨ /usr/local/&lt;nginx/openresty/tengine&gt;ï¼Œé™¤äº† logs åšäº†è½¯é“¾<code> /usr/local/xxx/logs -&gt; /export/logs/nginx</code></p><p><code>/usr/local/xxx/conf ç›®å½•ç»“æ„</code></p><p><img src="/posts/6209085/image-20200515120037239.png" alt="image-20200515120037239"></p><pre><code class="language-bash"># ä¸‹é¢ä¸¤ä¸ªä¸»é…ç½®æ–‡ä»¶ä¼šå‘Šè¯‰ä½ ï¼Œç›¸åº”çš„ä¸Šä¸‹æ–‡é…ç½®ï¼Œåº”è¯¥ä»¥ä»€ä¹ˆç»“å°¾ï¼ï¼ï¼include /usr/local/$&#123;NginxVer&#125;/nginx/conf/server/*.server;include /usr/local/$&#123;NginxVer&#125;/nginx/conf/upstream/*.upstream;</code></pre><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><pre><code class="language-bash">#!/bin/bashbasedir=/usr/local/srccd $basedirrunuser=`whoami`[[ $runuser == 'root' ]] || &#123;     echo &quot;ERROR:æ‰§è¡Œç”¨æˆ·ä¸æ˜¯$runuser&quot; &amp;&amp; exit &#125;[[ -d /export/logs/nginx ]] || &#123;     echo &quot;/export/logs/nginx/ç›®å½•ä¸å­˜åœ¨&quot; &amp;&amp; exit &#125;CpuNum=`cat /proc/cpuinfo | grep processor | wc -l`read -p &quot;è¾“å…¥å®‰è£…çš„Nginxç‰ˆæœ¬:(nginx;tengine;openresty):&quot; NginxVerread -p &quot;è¾“å…¥å¼€å‘æ—¥å¸¸æ“ä½œç”¨æˆ·:&quot; KaifaUserread -p &quot;è¾“å…¥nginx workerç”¨æˆ·:&quot; NginxWorkerUseruseradd -s /sbin/nologin $&#123;NginxWorkerUser&#125;usermod -a -G $&#123;KaifaUser&#125; $&#123;NginxWorkerUser&#125;cd /usr/local/srcrm -rf $&#123;NginxVer&#125; &amp;&amp; mkdir $&#123;NginxVer&#125;cat&gt;&gt;$basedir/test.com.server&lt;&lt;EOFserver &#123;    listen 80;    server_name test.com;    root /export/$&#123;NginxWorkerUser&#125;/test.com;    #charset koi8-r;    access_log logs/nginx-test.com.access.log main;    error_log logs/nginx-test.com.error.log;    # å…³é—­æ—¥å¿—    location = /favicon.ico &#123;        log_not_found off;        access_log off;    &#125;    # å…³é—­æ—¥å¿—    location = /robots.txt &#123;        auth_basic off;        allow all;        log_not_found off;        access_log off;    &#125;    # æ‹’ç»æ¢æµ‹ç½‘ç«™æ ¹ä¸‹çš„éšè—æ–‡ä»¶ Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store (Mac).    location ~ /\. &#123;        deny all;        access_log off;        log_not_found off;    &#125;    location / &#123;        #######è¿™ä¸ªæ˜¯ä¸€ä¸ªthinkphpæ¡†æ¶çš„ä¼ªé™æ€è§„åˆ™ï¼Œè¯·å¿½ç•¥        if (!-e \$request_filename) &#123;           rewrite ^(.*)\$ /index.php?s=\$1 last;           break;        &#125;        #######        index index.php;    &#125;    #å¼€å¯æµè§ˆå™¨é™æ€æ–‡ä»¶ç¼“å­˜    location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)\$ &#123;         expires 3h;     &#125;     # è‹¥php-fpm,è¯·ä¿ç•™è¿™é‡Œä¿®æ”¹    location ~ \.php &#123;        fastcgi_pass 127.0.0.1ï¼š9000;        fastcgi_index index.php;        include fastcgi.conf;        fastcgi_connect_timeout 10s;        fastcgi_send_timeout 10s;        fastcgi_read_timeout 10s;        fastcgi_buffers 8 256k;                                   fastcgi_buffer_size 256k;        fastcgi_busy_buffers_size 256k;        fastcgi_intercept_errors on;    &#125;    # è‹¥ httpï¼Œè¯·ä¿ç•™è¿™é‡Œä¿®æ”¹    location / &#123;        proxy_pass http://127.0.0.1:8080;        proxy_connect_timeout 300ms;        proxy_send_timeout 300ms;        proxy_read_timeout 300ms;        proxy_max_temp_file_size 1024m;        proxy_set_header   Host         $host;        proxy_set_header   X-Real-IP    $remote_addr;        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;        proxy_buffers 256 4k;        proxy_intercept_errors on;    &#125;&#125;EOFcat&gt;&gt;nginx_status.server&lt;&lt;EOFserver &#123;    listen 80;    server_name 127.0.0.1;   # charset koi8-r;    access_log off;    location /server_status &#123;        stub_status on;        access_log off;        allow 127.0.0.1;        deny all;    &#125;&#125;EOF###################if [[ $NginxVer == 'nginx' ]];then    [[ -d /usr/local/$NginxVer ]] &amp;&amp; echo '/usr/local/$NginxVer å·²å­˜åœ¨' &amp;&amp; exit    yum install readline-devel pcre-devel openssl-devel gcc    wget http://$&#123;NginxVer&#125;.org/download/$&#123;NginxVer&#125;-1.14.0.tar.gz -O $&#123;NginxVer&#125;.tar.gz    tar xf $&#123;NginxVer&#125;.tar.gz --strip-components 1 -C $&#123;NginxVer&#125;    cd $&#123;NginxVer&#125; &amp;&amp; ./configure --prefix=/usr/local/$&#123;NginxVer&#125; --user=$&#123;NginxWorkerUser&#125; --group=$&#123;NginxWorkerUser&#125; --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_v2_module || exit    make    make install    cd /usr/local/$&#123;NginxVer&#125; &amp;&amp; rm -rf logs    ln -s /export/logs/nginx logs    cd /usr/local/$&#123;NginxVer&#125;/conf    mkdir &#123;location,ssl,upstream,server&#125;    mv $basedir/&#123;test.com.server,nginx_status.server&#125; server/    rm -rf nginx.conf    cat &gt;&gt;nginx.conf&lt;&lt;EOFuser $&#123;NginxWorkerUser&#125;;worker_processes auto;worker_rlimit_nofile 65535;events &#123;    use epoll;    worker_connections 65535; &#125;error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;http &#123;    include mime.types;    default_type application/octet-stream;    log_format main '\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; '                      '\$status \$body_bytes_sent &quot;\$http_referer&quot; '                      '&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status';    access_log logs/access.log main;    sendfile on;    keepalive_timeout 65;    gzip on;    gzip_min_length 1k;    gzip_buffers 4 16k;    gzip_comp_level 2;    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;    gzip_vary off;    gzip_disable &quot;MSIE [1-6]\.&quot;;    #è·¨åŸŸè®¿é—®    #add_header Access-Control-Allow-Origin *;     #add_header Access-Control-Allow-Headers X-Requested-With;    #add_header Access-Control-Allow-Methods GET,POST,OPTIONS;    server &#123;        listen 80 backlog=8092;        location / &#123;        deny all;        &#125;        error_page 500 502 503 504 /50x.html;        location = /50x.html &#123;            root html;        &#125;    &#125;    include /usr/local/$&#123;NginxVer&#125;/conf/server/*.server;    include /usr/local/$&#123;NginxVer&#125;/conf/upstream/*.upstream;&#125;EOFelif [[ $NginxVer == 'openresty' ]];then    [[ -d /usr/local/$NginxVer ]] &amp;&amp; echo '/usr/local/$NginxVer å·²å­˜åœ¨' &amp;&amp; exit    yum install readline-devel pcre-devel openssl-devel gcc    wget https://openresty.org/download/openresty-1.15.8.3.tar.gz -O $&#123;NginxVer&#125;.tar.gz    tar xf $&#123;NginxVer&#125;.tar.gz --strip-components 1 -C $&#123;NginxVer&#125;    cd $&#123;NginxVer&#125; &amp;&amp; ./configure --prefix=/usr/local/$&#123;NginxVer&#125; --user=$&#123;NginxWorkerUser&#125; --group=$&#123;NginxWorkerUser&#125; --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_v2_module || exit    make    make install    cd /usr/local/$&#123;NginxVer&#125;/nginx &amp;&amp; rm -rf logs    ln -s /export/logs/nginx logs    cd /usr/local/$&#123;NginxVer&#125;/nginx/conf    mkdir &#123;location,ssl,upstream,server&#125;    mv $basedir/&#123;test.com.server,nginx_status.server&#125; server/    rm -rf nginx.conf    cat &gt;&gt;nginx.conf&lt;&lt;EOFuser $&#123;NginxWorkerUser&#125;;worker_processes auto;worker_rlimit_nofile 65535;events &#123;    use epoll;    worker_connections 65535; &#125;error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;http &#123;    include mime.types;    default_type application/octet-stream;    log_format main '\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; '                      '\$status \$body_bytes_sent &quot;\$http_referer&quot; '                      '&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status';    access_log logs/access.log main;    sendfile on;    keepalive_timeout 65;    gzip on;    gzip_min_length 1k;    gzip_buffers 4 16k;    gzip_comp_level 2;    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;    gzip_vary off;    gzip_disable &quot;MSIE [1-6]\.&quot;;    #è·¨åŸŸè®¿é—®    #add_header Access-Control-Allow-Origin *;     #add_header Access-Control-Allow-Headers X-Requested-With;    #add_header Access-Control-Allow-Methods GET,POST,OPTIONS;    server &#123;        listen 80 backlog=8092;        location / &#123;            return 444;        &#125;        error_page 500 502 503 504 /50x.html;        location = /50x.html &#123;            root html;        &#125;    &#125;    include /usr/local/$&#123;NginxVer&#125;/nginx/conf/server/*.server;    include /usr/local/$&#123;NginxVer&#125;/nginx/conf/upstream/*.upstream;&#125;EOFelif [[ $NginxVer == 'tengine' ]];then    [[ -d /usr/local/$NginxVer ]] &amp;&amp; echo '/usr/local/$NginxVer å·²å­˜åœ¨' &amp;&amp; exit    yum install readline-devel pcre-devel openssl-devel gcc jemalloc-devel    wget http://tengine.taobao.org/download/tengine-2.1.2.tar.gz -O $&#123;NginxVer&#125;.tar.gz    tar xf $&#123;NginxVer&#125;.tar.gz --strip-components 1 -C $&#123;NginxVer&#125;    cd $&#123;NginxVer&#125; &amp;&amp; ./configure --prefix=/usr/local/$&#123;NginxVer&#125; --user=$&#123;NginxWorkerUser&#125; --group=$&#123;NginxWorkerUser&#125; --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-jemalloc || exit    make    make install    cd /usr/local/$&#123;NginxVer&#125; &amp;&amp; rm -rf logs    ln -s /export/logs/nginx logs    cd /usr/local/$&#123;NginxVer&#125;/conf    mkdir &#123;location,ssl,upstream,server&#125;    mv $basedir/&#123;test.com.server,nginx_status.server&#125; server/    rm -rf nginx.conf    cat &gt;&gt;nginx.conf&lt;&lt;EOFuser $&#123;NginxWorkerUser&#125;;worker_processes auto;worker_rlimit_nofile 65535;events &#123;    use epoll;    worker_connections 65535; &#125;error_log logs/error.log;#error_log logs/error.log notice;#error_log logs/error.log info;http &#123;    include mime.types;    default_type application/octet-stream;    log_format main '\$remote_addr - \$remote_user [\$time_local] \$request_time \$host &quot;\$request&quot; '                      '\$status \$body_bytes_sent &quot;\$http_referer&quot; '                      '&quot;\$http_user_agent&quot; &quot;\$http_x_forwarded_for&quot; \$upstream_addr \$upstream_status';    access_log logs/access.log main;    sendfile on;    keepalive_timeout 65;    gzip on;    gzip_min_length 1k;    gzip_buffers 4 16k;    gzip_comp_level 2;    gzip_types text/plain application/x-javascript text/css text/javascript application/xml application/ms* application/vnd* application/postscript application/javascript application/json application/x-httpd-php application/x-httpd-fastphp;    gzip_vary off;    gzip_disable &quot;MSIE [1-6]\.&quot;;    #è·¨åŸŸè®¿é—®    #add_header Access-Control-Allow-Origin *;     #add_header Access-Control-Allow-Headers X-Requested-With;    #add_header Access-Control-Allow-Methods GET,POST,OPTIONS;    server &#123;        listen 80 backlog=8092;        location / &#123;            deny all;        &#125;        error_page 500 502 503 504 /50x.html;        location = /50x.html &#123;            root html;        &#125;    &#125;    include /usr/local/$&#123;NginxVer&#125;/conf/server/*.server;    include /usr/local/$&#123;NginxVer&#125;/conf/upstream/*.upstream;&#125;EOFfi</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoâ˜å›¾ç‰‡æ˜¾ç¤º404é”™è¯¯çš„è§£å†³åŠæ³•</title>
      <link href="posts/662e9d4d/"/>
      <url>posts/662e9d4d/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>å†™ä½œå·¥å…·ï¼štypora</p><p>éƒ¨ç½²ç«¯ï¼šgithub</p><p>éƒ¨ç½²åŒ…ï¼š</p><pre><code># ä½ å¯ä»¥é€šè¿‡hexoçš„æ ¹ç›®å½•ä¸‹çš„package.jsonæ¥ç¡®è®¤ç‰ˆæœ¬&quot;hexo&quot;: &quot;^4.0.0&quot;,&quot;hexo-asset-image&quot;: &quot;^1.0.0&quot;</code></pre><p>ç›®å‰ç½‘ä¸Šå¤§å¤šæ•°çš„åšæ–‡æè¿°çš„åœºæ™¯ï¼Œå‡ä¸æ˜¯å½“å‰åœºæ™¯ï¼ˆæˆªè‡³åˆ°2020.05.14ï¼‰ï¼Œæ‰€ä»¥åšæ–‡é‡Œè™½ç„¶å±•ç¤ºéƒ½æ­£å¸¸ï¼Œä½†æ˜¯æŒ‰ç…§åšæ–‡çš„æ“ä½œå´ä¼šæœ‰è·¯å¾„é—®é¢˜ï¼Œå…·ä½“è¡¨ç°æ˜¯å›¾ç‰‡å‰å¤šäº†ä¸€çº§è·¯å¾„ï¼ˆè·¯å¾„åº”è¯¥æ˜¯1çº§åŸŸåï¼Œ<a href="http://xn--bvs393b.com">æ¯”å¦‚.com</a>ï¼Œ.ioç­‰ï¼Œæ ¹æ®ä½ çš„åŸŸåæ¥å®šï¼‰</p><p>é‚£ä¹ˆï¼Œè¯·æŒ‰ç…§ä¸‹é¢æˆ‘çš„æ­¥éª¤æ¥æ“ä½œï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œé‚£å°±ä¸æ˜¯ä¸Šè¿°æˆ‘æ‰€è¯´çš„æƒ…å†µäº†ã€‚</p><h4 id="æµç¨‹">æµç¨‹</h4><ol><li><p>ä¿®æ”¹ hexo-asset-imageï¼Œä¿®æ”¹å†…å®¹å¦‚å›¾æ‰€ç¤º</p><p><img src="/posts/662e9d4d/image-20200901195338475.png" alt="image-20200901195338475">ä¿®æ”¹typoraçš„å›¾ç‰‡å­˜æ”¾è·¯å¾„ï¼Œä¿®æ”¹å†…å®¹å¦‚å›¾æ‰€ç¤º</p><p><img src="/posts/662e9d4d/image-20200514185631903.png" alt="image-20200514185631903"></p><blockquote><p>è¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯æˆ‘æƒ³æ²¡äººä¼šæ‹’ç»æ–¹ä¾¿çš„æ“ä½œã€‚ typora åœ¨è¿›è¡Œå¦‚ä¸Šæ“ä½œåï¼Œå°±å¯ä»¥åœ¨ä½ å¾€æ–‡ç« é‡Œç²˜è´´å›¾ç‰‡çš„æ—¶å€™ï¼Œè‡ªåŠ¨ç”Ÿæˆä»¥æ–‡ä»¶åå‰ç¼€å‘½åçš„ç›®å½•ï¼ˆæ•ˆæœå°±å¦‚åŒä½ å¼€å¯äº†hexoçš„post_asset_folder: trueå‚æ•°ï¼‰ï¼Œå¹¶å°†å›¾ç‰‡å­˜æ”¾åœ¨æ­¤ç›®å½•ä¸­ã€‚</p></blockquote></li><li><p>å¼€å¯ hexo çš„ _config.yml ä¸­ post_asset_folder: true å‚æ•°é…ç½®</p></li></ol><h4 id="ç»“è®º">ç»“è®º</h4><p>ç»è¿‡ä¸Šè¿°æ“ä½œï¼Œæˆ‘æƒ³ä½ å·²ç»å¯ä»¥åœ¨æœ¬åœ° md æ–‡ä»¶å’Œçº¿ä¸ŠåŒæ—¶çœ‹åˆ°å›¾ç‰‡äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxâ˜æ—¥å¿—åˆ‡å‰²è„šæœ¬</title>
      <link href="posts/445cf088/"/>
      <url>posts/445cf088/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æœ¬è„šæœ¬ç”¨äºå°† nginx æ—¥å¿—è¿›è¡Œæ—¶é—´å‘¨æœŸåˆ‡å‰²ï¼Œå¹¶ lzo å‹ç¼©ï¼Œæœ€ç»ˆä¸Šä¼ åˆ° s3ã€‚<br>è„šæœ¬åˆ†ä¸ºä¸‰ä¸ªå‡½æ•°ï¼Œåˆ‡å‰²å‡½æ•°ï¼Œå‹ç¼©ä¸Šä¼ å‡½æ•°ï¼Œåˆ é™¤å‡½æ•°ï¼Œéœ€è¦æ‰§è¡Œå“ªä¸ªï¼Œå°±å¡«å†™ç›¸å¯¹åº”å˜é‡ã€‚<br>è¯¦æƒ…å¯ä»¥çœ‹è„šæœ¬æ³¨é‡Šã€‚</p><blockquote><p>è¯·åŠ¡å¿…æ‰§è¡Œå‰ï¼Œç¡®è®¤å®‰è£…äº† lzop å’Œ jq å‘½ä»¤ ï¼Œä¸”æœºå™¨æ˜¯ aws EC2</p></blockquote><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><pre><code class="language-bash">#!/bin/bash# by zyh# time: 2019-12-13# warning: ä½¿ç”¨ä¹‹å‰ yum install -y lzop jq# crontab (æ‰§è¡Œæ—¶é—´å‘¨æœŸéœ€è¦å’Œåˆ‡å‰²æ—¶é—´å‘¨æœŸä¸€è‡´) é‡è¦!!!!!!!# */10 * * * * root bash /export/shell/nginxlog2s3/start.sh &gt; /export/shell/nginxlog2s3/start.log 2&gt;&amp;1# æ ‡è¯†æ—¥å¿—åå‰ç¼€localtag=`curl -sq http://169.254.169.254/latest/dynamic/instance-identity/document/ | jq -r .&quot;accountId&quot;,.&quot;availabilityZone&quot;,.&quot;privateIp&quot; | sed 'N;N;s@\n@_@g'`# ----------------------------------äººä¸ºå˜é‡å¡«å†™å¼€å§‹åŒºåŸŸ----------------------------------# åˆ‡å‰²æ—¶é—´å‘¨æœŸï¼Œå®šä½åˆ‡å‰²åæ—¥æœŸçš„åˆå§‹å†™å…¥æ—¶é—´ï¼ˆä»…é€‚ç”¨äºè¿ç»­åˆ‡å‰²ï¼Œä¸”ä¸é€‚ç”¨äºç¬¬ä¸€æ¬¡åˆ‡å‰²ï¼‰todaytime=$(date -d &quot;-10 mins&quot; +%Y%m%d)todayhour=$(date -d &quot;-10 mins&quot; +%H)todaytimestr=$(date  -d &quot;-10 mins&quot; +%s)# ä¼ä¸šå¾®ä¿¡æœºå™¨äººwx_api=''# nginx æ—¥å¿—ç›®å½• logs æ‰€åœ¨è·¯å¾„, å¤‡ä»½æ—¥å¿—ç›®å½•æ˜¯ logs/logsbak# ä¾‹å¦‚æ—¥å¿—ç›®å½•æ˜¯ /usr/local/nginx/logsï¼Œåˆ™å¡«å†™ /usr/loca/nginx, åˆ™åˆ‡å‰²åæœ¬åœ°å¤‡ä»½è·¯å¾„æ˜¯ /usr/local/nginx/logs/logsbaknginx_base=# æ—¥å¿—ä½äºS3çš„æ ¹è·¯å¾„ï¼Œä¾‹å¦‚ s3://xxx/logs/xxxdays/nginxS3Base=&quot;&quot;# MvLogList=&quot;a.log b.log c.log&quot;  éœ€è¦åˆ‡å‰²çš„æ—¥å¿—ï¼Œè¿™æ˜¯å¿…é¡»çš„MvLogList=&quot;&quot;# LzopS3LogList=&quot;a.log b.log c.log&quot; éœ€è¦å‹ç¼©å¹¶ä¸Šä¼ S3çš„æ—¥å¿—ï¼Œå¦‚æœä½ éœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤# S3ç›®å½•æ ¼å¼ï¼š$&#123;S3Base&#125;/$&#123;æ—¥å¿—å&#125;/$&#123;todaytime&#125;/$&#123;todayhour&#125;/ LzopS3LogList=&quot;&quot;# DeleteLocalLog=&quot;a.log b.log c.log&quot; éœ€è¦æœ¬åœ°è®¾ç½®ä¿ç•™æ—¶é—´çš„æ—¥å¿—ï¼Œå¦‚æœä½ éœ€è¦æ‰§è¡Œæ­¤æ­¥DeleteLocalLog=&quot;&quot;# æœ¬åœ°ä¿å­˜æ—¶é—´deletetime=$(date -d &quot;72 hours ago&quot; +%s)# ----------------------------------äººä¸ºå˜é‡å¡«å†™ç»“æŸåŒºåŸŸ----------------------------------# æ—¥å¿—åŸå§‹è·¯å¾„nginx_logs=&quot;$&#123;nginx_base&#125;/logs&quot;# æ—¥å¿—ä½äºæœ¬åœ°çš„åˆ‡å‰²åå¤‡ä»½è·¯å¾„backup_logs=&quot;$&#123;nginx_logs&#125;/logsbak&quot;[[ -d $&#123;backup_logs&#125; ]] || mkdir -p $&#123;backup_logs&#125;# nginx pid æ–‡ä»¶è·¯å¾„nginx_pid=&quot;$&#123;nginx_logs&#125;/nginx.pid&quot;[[ -f $&#123;nginx_pid&#125; ]] || &#123;  echo &quot;$&#123;nginx_pid&#125; is not exist!!!!&quot; &amp;&amp; exit&#125;mvlog()&#123;  [[ -z $1 ]] &amp;&amp; continue  NginxLogName=$1  [[ -d $&#123;backup_logs&#125;/$&#123;NginxLogName&#125; ]] || mkdir -p $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;  mv $&#123;nginx_logs&#125;/$&#123;NginxLogName&#125; $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;/$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125; &amp;&amp; echo &quot;MV: $&#123;nginx_logs&#125;/$&#123;NginxLogName&#125; to $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;/$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;&quot;&#125;lzops3log()&#123;  [[ -z $1 ]] &amp;&amp; continue  NginxLogName=$1  S3Path=$2  cd $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;  lzop $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125; &amp;&amp; aws s3 cp $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo $&#123;S3Path&#125;/$&#123;todaytime&#125;/$&#123;todayhour&#125;/ --quiet &amp;&amp; rm -rf $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo &amp;&amp; echo &quot;UPLOAD: $&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo to $&#123;S3Path&#125;/$&#123;todaytime&#125;/$&#123;todayhour&#125;/&quot; || curl &quot;$wx_api&quot; -H 'Content-Type: application/json' -d '&#123;&quot;msgtype&quot;: &quot;markdown&quot;,&quot;markdown&quot;: &#123;&quot;content&quot;: &quot;# `'&quot;$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;todaytime&#125;$&#123;todayhour&#125;_$&#123;todaytimestr&#125;.lzo&quot;'` æ—¥å¿—ä¸Šä¼ å¤±è´¥!!!!!!&quot;&#125;&#125;'&#125;deletelocallog()&#123;  [[ -z $1 ]] &amp;&amp; continue  NginxLogName=$1  cd $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;  for logname in `ls`;do    if [[ $&#123;deletetime&#125; -ge $&#123;logname##*_&#125; ]];then      rm -rf $&#123;logname&#125; &amp;&amp; echo &quot;DELETE: $&#123;backup_logs&#125;/$&#123;NginxLogName&#125;/$&#123;localtag&#125;_$&#123;NginxLogName&#125;_$&#123;deletetime&#125;&quot;    fi  done&#125;#MVfor i in $&#123;MvLogList&#125;;do  mvlog $&#123;i&#125;done#nginx log reloadkill -USR1 `cat $&#123;nginx_pid&#125;`#lzop and to s3for i in $&#123;LzopS3LogList&#125;;do  lzops3log $&#123;i&#125; $&#123;S3Base&#125;/$&#123;i&#125;done#Deletefor i in $&#123;DeleteLocalLog&#125;;do  deletelocallog $&#123;i&#125;done</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜å®‰è£…</title>
      <link href="posts/65ab632a/"/>
      <url>posts/65ab632a/</url>
      
        <content type="html"><![CDATA[<h4 id="docker-å®‰è£…">docker å®‰è£…</h4><pre><code class="language-bash">redisName=redisdocker volume create $&#123;redisName&#125;touch /export/docker-data-root/volumes/$&#123;redisName&#125;/_data/redis.confredis.conf è¯·å‚è€ƒå®˜æ–¹é»˜è®¤é…ç½®æ–‡æ¡£ï¼Œé»˜è®¤é…ç½®æ–‡æ¡£åœ°å€ï¼š https://redis.io/topics/configdocker run --name  $&#123;redisName&#125; -v  $&#123;redisName&#125;:/data -p 6379:6379 --restart always -d redis redis-server /data/redis.conf </code></pre><h4 id="ç¼–è¯‘å®‰è£…">ç¼–è¯‘å®‰è£…</h4><pre><code class="language-shell">#!/bin/bash# by zyh# 2018-06-21# DownUrl: redisæºç åŒ…# RedisBaseDirï¼š rediså®‰è£…è·¯å¾„# RedisPort: redisç«¯å£# RedisMaxMemï¼šrediså†…å­˜é™åˆ¶# ZabbixBase: zabbix æ ¹è·¯å¾„# å®‰è£…å®Œæ¯•åï¼Œä¼šè¾“å‡º# 1. redisä¿¡æ¯# 2. zabbixéœ€è¦é¢å¤–æ‰‹åŠ¨æ·»åŠ çš„å‘½ä»¤ï¼Œ å¹¶åœ¨zabbix_server_webé‡Œï¼Œç»™æœºå™¨å…³è”ä¸Š &lt;Template Redis Auto Discovert Active mode&gt; æ¨¡æ¿# 3. monitéœ€è¦é¢å¤–æ‰‹åŠ¨æ·»åŠ çš„é…ç½®BaseDir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`DownUrl=http://download.redis.io/releases/redis-stable.tar.gzRedisMaxMem=1gRedisPort=6379RedisBaseDir=/export/redis_$&#123;RedisPort&#125;ZabbixBase=/etc/zabbixif [[ $&#123;ZabbixBase&#125; == '/usr/local/zabbix' ]];then    ZabbixShell=$&#123;ZabbixBase&#125;/shell    ZabbixEtc=$&#123;ZabbixBase&#125;/etc/zabbix_agentd.conf.d/redis.confelse    ZabbixShell=/etc/zabbix/shell    ZabbixEtc=/etc/zabbix/zabbix_agentd.d/redis.conffiRedisBaseName=$&#123;RedisBaseDir##*/&#125;export TOP_PID=$$trap 'exit 1' TERMexit_script()&#123;    kill -s TERM $TOP_PID&#125;yum install gcc-c++ -y[[ -d $&#123;RedisBaseDir&#125; ]] &amp;&amp; echo &quot;$&#123;RedisBaseDir&#125;å·²å­˜åœ¨&quot; &amp;&amp; exit_scriptss -tnalp | grep redis | awk '&#123;print $4&#125;' | awk -F':' '&#123;print $2&#125;' | while read line;do    [[ $line -eq $&#123;RedisPort&#125; ]] &amp;&amp; echo &quot;$&#123;RedisPort&#125;å·²è¢«å ç”¨&quot; &amp;&amp; exit_scriptdonecd $&#123;BaseDir&#125; &amp;&amp; mkdir rediswget $&#123;DownUrl&#125; -O redis.tar.gztar xf redis.tar.gz --strip-components 1 -C rediscd redismake PREFIX=$&#123;RedisBaseDir&#125; installmkdir $&#123;RedisBaseDir&#125;/&#123;etc,data,logs&#125;cat&gt;$&#123;RedisBaseDir&#125;/etc/redis.conf &lt;&lt;EOFbind 0.0.0.0protected-mode yesport $&#123;RedisPort&#125;tcp-backlog 511timeout 0tcp-keepalive 300daemonize yessupervised nopidfile $&#123;RedisBaseDir&#125;/redis.pidloglevel warninglogfile &quot;$&#123;RedisBaseDir&#125;/logs/redis.log&quot;databases 16always-show-logo yessave 900 1save 300 10save 60 10000stop-writes-on-bgsave-error yesrdbcompression yesrdbchecksum yesdbfilename redis_$&#123;RedisPort&#125;.rdbdir $&#123;RedisBaseDir&#125;/data/slave-serve-stale-data yesslave-read-only yesrepl-diskless-sync norepl-diskless-sync-delay 5repl-disable-tcp-nodelay noslave-priority 100rename-command FLUSHDB GOD_FLUSHDBrename-command FLUSHALL GOD_FLUSHALLrename-command CONFIG GOD_CONFIGrename-command KEYS GOD_KEYSmaxmemory $&#123;RedisMaxMem&#125;maxmemory-policy allkeys-lrulazyfree-lazy-eviction nolazyfree-lazy-expire nolazyfree-lazy-server-del noslave-lazy-flush noappendonly noappendfilename &quot;appendonly.aof&quot;appendfsync everysecno-appendfsync-on-rewrite noauto-aof-rewrite-percentage 100auto-aof-rewrite-min-size 64mbaof-load-truncated yesaof-use-rdb-preamble nolua-time-limit 5000slowlog-log-slower-than 10000slowlog-max-len 128latency-monitor-threshold 0notify-keyspace-events &quot;&quot;hash-max-ziplist-entries 512hash-max-ziplist-value 64list-max-ziplist-size -2list-compress-depth 0set-max-intset-entries 512zset-max-ziplist-entries 128zset-max-ziplist-value 64hll-sparse-max-bytes 3000activerehashing yesclient-output-buffer-limit normal 0 0 0client-output-buffer-limit slave 256mb 64mb 60client-output-buffer-limit pubsub 32mb 8mb 60hz 10aof-rewrite-incremental-fsync yesEOFcat&gt;$&#123;RedisBaseDir&#125;/redis.sh &lt;&lt; EOF#!/bin/bash# Simple Redis init.d script conceived to work on Linux systems# as it does use of the /proc filesystem.BASEDIR=$&#123;RedisBaseDir&#125;REDISPORT=$&#123;RedisPort&#125;EXEC=\$BASEDIR/bin/redis-serverCLIEXEC=\$BASEDIR/bin/redis-cliPIDFILE=\$BASEDIR/redis.pidCONF=&quot;\$BASEDIR/etc/redis.conf&quot;case &quot;\$1&quot; in    start)        [[ -f \$PIDFILE ]] &amp;&amp; kill -0 \`cat \$PIDFILE\` 2&gt;&gt;\$BASEDIR/crash.log &amp;&amp; echo &quot;\$PIDFILE exists, process is already running or crashed&quot; || &#123;                echo &quot;Starting Redis server...&quot;                \$EXEC \$CONF        &#125;        ;;    stop)        if [ ! -f \$PIDFILE ]        then                echo &quot;\$PIDFILE does not exist, process is not running&quot;        else                PID=\$(cat \$PIDFILE)                echo &quot;Stopping ...&quot;                \$CLIEXEC -p \$REDISPORT shutdown                while [ -x /proc/\$&#123;PID&#125; ]                do                    echo &quot;Waiting for Redis to shutdown ...&quot;                    sleep 1                done                echo &quot;Redis stopped&quot;        fi        ;;    *)        echo &quot;Please use start or stop as first argument&quot;        ;;esacEOFchmod u+x $&#123;RedisBaseDir&#125;/redis.sh#ä¿®æ”¹å†…æ ¸å‚æ•°grep -q net.core.somaxconn /etc/sysctl.conf || echo &quot;net.core.somaxconn = 511&quot; &gt;&gt; /etc/sysctl.confgrep -q vm.overcommit_memory /etc/sysctl.conf || &#123;    echo &quot;vm.overcommit_memory = 1&quot; &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -p&#125;grep -q '/sys/kernel/mm/transparent_hugepage/enabled' /etc/rc.local || &#123;    echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled    echo 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' &gt;&gt; /etc/rc.local&#125;#ä¿®æ”¹zabbixç›‘æ§cat&gt;$&#123;ZabbixEtc&#125;&lt;&lt;EOF##redis monitorUserParameter=redis_info[*],$&#123;ZabbixShell&#125;/redis_info.sh \$1 \$2 \$3 \$4UserParameter=ip_port_discovery[*],$&#123;ZabbixShell&#125;/ip_port_discovery.sh \$1EOFmkdir $&#123;ZabbixShell&#125;cat&gt;$&#123;ZabbixShell&#125;/redis_info.sh&lt;&lt;&quot;EOF&quot;#!/bin/bashREDISPATH=&quot;/export/redis/bin/redis-cli&quot;HOST=$1PORT=$2REDIS_INFO=&quot;$REDISPATH -h $HOST -p $PORT info&quot;[[ $# -ne 3 ]] &amp;&amp; [[ $# -ne 4 ]] &amp;&amp; &#123; exit&#125;if [[ $# -eq 3 ]];thencase $3 inexist) result=`$REDISPATH -h $HOST -p $PORT ping 2&gt;/dev/null |grep -c PONG` echo $result;;cluster)        result=`$REDIS_INFO|/bin/grep cluster|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;uptime_in_seconds)        result=`$REDIS_INFO|/bin/grep uptime_in_seconds|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;connected_clients)        result=`$REDIS_INFO|/bin/grep connected_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_longest_output_list)        result=`$REDIS_INFO|/bin/grep client_longest_output_list|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_biggest_input_buf)        result=`$REDIS_INFO|/bin/grep client_biggest_input_buf|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;blocked_clients)        result=`$REDIS_INFO|/bin/grep blocked_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#å†…å­˜maxmemory)        result=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory)        result=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_rss)        result=`$REDIS_INFO|/bin/grep -w used_memory_rss|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk -F'k' '&#123;print $1&#125;'`        echo $result;;used_memory_pct) A=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` B=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` result=`echo $A $B | awk '&#123;printf&quot;%0.2f&quot;,$1/$2&#125;'`        echo $result;;used_memory_peak)        result=`$REDIS_INFO|/bin/grep used_memory_peak|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_lua)        result=`$REDIS_INFO|/bin/grep used_memory_lua|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;mem_fragmentation_ratio)        result=`$REDIS_INFO|/bin/grep mem_fragmentation_ratio|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#rdbrdb_changes_since_last_save)        result=`$REDIS_INFO|/bin/grep rdb_changes_since_last_save|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_bgsave_in_progress)        result=`$REDIS_INFO|/bin/grep rdb_bgsave_in_progress|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_save_time)        result=`$REDIS_INFO|/bin/grep rdb_last_save_time|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_bgsave_status)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_last_bgsave_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;rdb_current_bgsave_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_current_bgsave_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#rdbinfoaof_enabled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_enabled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_scheduled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_scheduled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_last_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_current_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_last_bgrewrite_status)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_bgrewrite_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;#aofinfoaof_current_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_base_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_base_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_rewrite)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_rewrite&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_bio_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_bio_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_delayed_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_delayed_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#statstotal_connections_received)        result=`$REDIS_INFO|/bin/grep -w &quot;total_connections_received&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;total_commands_processed)        result=`$REDIS_INFO|/bin/grep -w &quot;total_commands_processed&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;instantaneous_ops_per_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;instantaneous_ops_per_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;rejected_connections)        result=`$REDIS_INFO|/bin/grep -w &quot;rejected_connections&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;expired_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;expired_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;evicted_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;evicted_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_hits)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_hits&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_misses)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_misses&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_patterns)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_patterns&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;latest_fork_usec)        result=`$REDIS_INFO|/bin/grep -w &quot;latest_fork_usec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;connected_slaves)        result=`$REDIS_INFO|/bin/grep -w &quot;connected_slaves&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;master_link_status)        result=`$REDIS_INFO|/bin/grep -w &quot;master_link_status&quot;|awk -F':' '&#123;print $2&#125;'|/bin/grep -c up`        echo $result;;master_last_io_seconds_ago)        result=`$REDIS_INFO|/bin/grep -w &quot;master_last_io_seconds_ago&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;master_sync_in_progress)        result=`$REDIS_INFO|/bin/grep -w &quot;master_sync_in_progress&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;slave_priority)        result=`$REDIS_INFO|/bin/grep -w &quot;slave_priority&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;#cpuused_cpu_sys)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_sys_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;*) echo &quot;argu error&quot;;;esac#db0:key   elif [[ $# -eq 4 ]];thencase $4 inkeys)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;keys&quot; | awk -F'=|,' '&#123;print $2&#125;'`        echo $result;;expires)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;expires&quot; | awk -F'=|,' '&#123;print $4&#125;'`        echo $result;;avg_ttl)        result=`$REDIS_INFO|/bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;avg_ttl&quot; | awk -F'=|,' '&#123;print $6&#125;'`        echo $result;;*)     echo &quot;argu error&quot; ;;esacfiEOFcat&gt;$&#123;ZabbixShell&#125;/ip_port_discovery.sh&lt;&lt;&quot;EOF&quot;#!/bin/bash#$1æ˜¯è¦å‘ç°çš„è¿›ç¨‹éƒ¨åˆ†è¯æ±‡portarray=(`sudo ss -tnlp|egrep -i &quot;$1&quot;|awk &#123;'print $4'&#125;|awk -F':' '&#123;if ($NF~/^[0-9]*$/) print $NF&#125;'|sort|uniq`)iparray=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`length=$&#123;#portarray[@]&#125;printf &quot;&#123;\n&quot;printf '\t'&quot;\&quot;data\&quot;:[&quot;for ((i=0;i&lt;$length;i++))  do     printf '\n\t\t&#123;'     printf &quot;\&quot;&#123;#IP&#125;\&quot;:\&quot;$&#123;iparray&#125;\&quot;,\&quot;&#123;#TCP_PORT&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;     if [ $i -lt $[$length-1] ];then                printf ','     fi  doneprintf &quot;\n\t]\n&quot;printf &quot;&#125;\n&quot;EOFchmod a+x $&#123;ZabbixShell&#125;/redis_info.shchmod a+x $&#123;ZabbixShell&#125;/ip_port_discovery.shsed -i '2s#/export/redis#'&quot;$&#123;RedisBaseDir&#125;&quot;'#' $&#123;ZabbixShell&#125;/redis_info.shecho '--------------------------------------------------æˆ‘æ˜¯ redis ä¿¡æ¯-----------------------------------------------------------'echo 'redisç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š'echo &quot;æ ¹è·¯å¾„ï¼š$&#123;RedisBaseDir&#125;å¯åŠ¨è„šæœ¬ï¼š$&#123;RedisBaseDir&#125;/redis.sh&quot;echo '--------------------------------------------------æˆ‘æ˜¯ zabbix ç›‘æ§ä¿¡æ¯----------------------------------------------------------'echo 'è¯·å…ˆå®‰è£… zabbix.'echo 'zabbixç›‘æ§å› ä½¿ç”¨äº†sså‘½ä»¤ï¼Œæ•…è€Œéœ€è¦å¼€å¯sudoç›¸å…³ä¿¡æ¯'echo &quot;#zabbixç”¨æˆ·å¯ä»¥ä»¥sudoæ‰§è¡Œsszabbix ALL = NOPASSWD: /usr/sbin/ss#zabbixç”¨æˆ·ä½¿ç”¨sudoæ— éœ€ttyDefaults:zabbix    !requiretty&quot;echo '---------------------------------------------------æˆ‘æ˜¯ monit ç›‘æ§ä¿¡æ¯----------------------------------------------------------'echo 'è¯·å…ˆå®‰è£… monit.'echo 'monité…ç½®æ–‡ä»¶å¦‚ä¸‹:'echo &quot;check process $&#123;RedisBaseName&#125; with pidfile $&#123;RedisBaseDir&#125;/redis.pid  start program = \&quot;$&#123;RedisBaseDir&#125;/redis.sh start\&quot;  stop program = \&quot;$&#123;RedisBaseDir&#125;/redis.sh stop\&quot;if changed pid then alert&quot;</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜redis</title>
      <link href="posts/6c093771/"/>
      <url>posts/6c093771/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-æ¨¡æ¿">zabbix æ¨¡æ¿</h2><ol><li>è‡ªåŠ¨å‘ç°è§„åˆ™</li></ol><p><img src="/posts/6c093771/image-20200520152740815.png" alt="image-20200520152740815"></p><ol start="2"><li><p>è¿‡æ»¤å™¨</p><p><img src="/posts/6c093771/image-20200520152922570.png" alt="image-20200520152922570"></p></li><li><p>ç›‘æ§é¡¹åŸå‹</p><table><thead><tr><th>åç§°</th><th>é”®å€¼</th><th>é—´éš”</th><th>å†å²è®°å½•</th><th>è¶‹åŠ¿</th><th>ç±»å‹</th></tr></thead><tbody><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; connected_clients[å®¢æˆ·ç«¯è¿æ¥æ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,connected_clients]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; maxmemory[redisé…ç½®çš„å†…å­˜ä¸Šé™]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,maxmemory]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; mem_fragmentation_ratio[å†…å­˜ç¢ç‰‡ç‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; redis_instantaneous_ops_per_sec[æ¯ç§’æ‰§è¡Œçš„å‘½ä»¤ä¸ªæ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,instantaneous_ops_per_sec]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; redis å­˜æ´»çŠ¶æ€</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,exist]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; rejected_connections[è¢«æ‹’ç»çš„å®¢æˆ·ç«¯è¿æ¥æ•°]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,rejected_connections]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_sys[redis-master sys-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_sys]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_sys_children[redis-children sys-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_sys_children]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_user[redis-master user-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_user]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_cpu_user_children[redis-children user-cpuå ç”¨]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_cpu_user_children]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory[rediså±‚é¢å·²ä½¿ç”¨å†…å­˜-ä¸å«ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_pct[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜ç™¾åˆ†æ¯”]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_peak[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜å†å²å³°å€¼-å«å†…å­˜ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_peak]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125; used_memory_rss[æ“ä½œç³»ç»Ÿå±‚é¢å·²ä½¿ç”¨å†…å­˜-å«å†…å­˜ç¢ç‰‡]</code></td><td><code>redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_rss]</code></td><td>30s</td><td>30d</td><td>90d</td><td>Zabbixå®¢æˆ·ç«¯(ä¸»åŠ¨å¼)</td></tr></tbody></table></li><li><p>è§¦å‘å™¨åŸå‹</p><table><thead><tr><th>ä¸¥é‡æ€§</th><th>åç§°</th><th>è¡¨è¾¾å¼</th></tr></thead><tbody><tr><td>ä¸€èˆ¬ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  å†…å­˜ç¢ç‰‡åŒ–è¶…è¿‡50%, å‰©ä½™å¯ç”¨å†…å­˜ä½äº30%</code></td><td><code>&#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio].last()&#125;&gt;1.5  and &#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  å¯ç”¨å†…å­˜ä½, å­˜åœ¨ä½¿ç”¨äº¤æ¢åˆ†åŒº</code></td><td><code>&#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,mem_fragmentation_ratio].last()&#125;&lt;1  and &#123;Template Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ä¸€èˆ¬ä¸¥é‡</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis  æ“ä½œç³»ç»Ÿå±‚é¢å†…å­˜å ç”¨ç™¾åˆ†æ¯”è¿‡é«˜</code></td><td><code>&#123;Template  Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,used_memory_pct].last()&#125;&gt;0.7</code></td></tr><tr><td>ç¾éš¾</td><td><code>&#123;#IP&#125;:&#123;#TCP_PORT&#125; Redis ç«¯å£æ— æ³•è®¿é—®</code></td><td><code>&#123;Template  Redis Auto Discovert Active  mode:redis_info[&#123;#IP&#125;,&#123;#TCP_PORT&#125;,exist].last()&#125;&lt;&gt;1</code></td></tr></tbody></table></li><li><p>å›¾å½¢åŸå‹ï¼Œå°±ä¸è¯¦ç»†å†™äº†ï¼Œè¿™é‡Œåªåˆ—å‡ºæˆ‘è‡ªå·±çš„åˆ†ç±»</p><table><thead><tr><th>åç§°</th><th>å®½</th><th>é«˜</th><th>å›¾å½¢ç±»åˆ«</th></tr></thead><tbody><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis è¿æ¥æ•°ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis å…¶ä»–ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis qps ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis mem ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr><tr><td><code>&#123;#IP&#125;,&#123;#TCP_PORT&#125;  redis cpu ç›‘æ§</code></td><td>900</td><td>200</td><td>æ­£å¸¸</td></tr></tbody></table></li></ol><h2 id="è„šæœ¬">è„šæœ¬</h2><p>è„šæœ¬ä¼šç”Ÿæˆè‡ªåŠ¨å‘ç°è¿›ç¨‹è„šæœ¬å’Œredisæ£€æµ‹è„šæœ¬</p><p>zabbixçš„redisé…ç½®è·¯å¾„ï¼šZabbixEtc</p><p>zabbixçš„è„šæœ¬è·¯å¾„ï¼šZabbixShell</p><p>redisçš„cliå‘½ä»¤è·¯å¾„ï¼šRedisCli</p><p>è‡ªåŠ¨å‘ç°è„šæœ¬ï¼šip_port_discovery.sh</p><ul><li>bash ip_port_discovery.sh è¿›ç¨‹åæˆ–è€…ç«¯å£</li></ul><p>redisæ£€æµ‹è„šæœ¬ï¼šredis_info.sh</p><ul><li>bash redis_info.sh ip port item</li></ul><pre><code class="language-redis">ZabbixEtc=/etc/zabbix/zabbix_agentd.dZabbixShell=/etc/zabbix/shellRedisCli='docker exec -t redis redis-cli'[[ -d $&#123;ZabbixShell&#125; ]] || mkdir -p $&#123;ZabbixShell&#125;[[ -z $&#123;ZabbixEtc&#125; ]] &amp;&amp; [[ -z $&#123;ZabbixShell&#125; ]] || [[ -z $&#123;RedisCli&#125; ]] &amp;&amp; exitcat&gt;$&#123;ZabbixEtc&#125;/redis.conf&lt;&lt;EOF##redis monitorUserParameter=redis_info[*],$&#123;ZabbixShell&#125;/redis_info.sh \$1 \$2 \$3 \$4UserParameter=ip_port_discovery[*],$&#123;ZabbixShell&#125;/ip_port_discovery.sh \$1EOFcat&gt;$&#123;ZabbixShell&#125;/redis_info.sh&lt;&lt;&quot;EOF&quot;#!/bin/bashRedisCli=HOST=$1PORT=$2REDIS_INFO=&quot;$RedisCli -h $HOST -p $PORT info&quot;[[ $# -ne 3 ]] &amp;&amp; [[ $# -ne 4 ]] &amp;&amp; &#123; exit&#125;if [[ $# -eq 3 ]];thencase $3 inexist) result=`$RedisCli -h $HOST -p $PORT ping 2&gt;/dev/null |grep -c PONG` echo $result;;cluster)        result=`$REDIS_INFO|/bin/grep cluster|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;uptime_in_seconds)        result=`$REDIS_INFO|/bin/grep uptime_in_seconds|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;connected_clients)        result=`$REDIS_INFO|/bin/grep connected_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_longest_output_list)        result=`$REDIS_INFO|/bin/grep client_longest_output_list|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;client_biggest_input_buf)        result=`$REDIS_INFO|/bin/grep client_biggest_input_buf|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;blocked_clients)        result=`$REDIS_INFO|/bin/grep blocked_clients|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#å†…å­˜maxmemory)        result=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory)        result=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_rss)        result=`$REDIS_INFO|/bin/grep -w used_memory_rss|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk -F'k' '&#123;print $1&#125;'`        echo $result;;used_memory_pct) A=`$REDIS_INFO|/bin/grep used_memory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` B=`$REDIS_INFO|/bin/grep maxmemory|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'` result=`echo $A $B | awk '&#123;printf&quot;%0.2f&quot;,$1/$2&#125;'`        echo $result;;used_memory_peak)        result=`$REDIS_INFO|/bin/grep used_memory_peak|awk -F&quot;:&quot; '&#123;print $NF&#125;'|awk 'NR==1'`        echo $result;;used_memory_lua)        result=`$REDIS_INFO|/bin/grep used_memory_lua|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;mem_fragmentation_ratio)        result=`$REDIS_INFO|/bin/grep mem_fragmentation_ratio|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;#rdbrdb_changes_since_last_save)        result=`$REDIS_INFO|/bin/grep rdb_changes_since_last_save|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_bgsave_in_progress)        result=`$REDIS_INFO|/bin/grep rdb_bgsave_in_progress|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_save_time)        result=`$REDIS_INFO|/bin/grep rdb_last_save_time|awk -F&quot;:&quot; '&#123;print $NF&#125;'`        echo $result;;rdb_last_bgsave_status)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_last_bgsave_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;rdb_current_bgsave_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;rdb_current_bgsave_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#rdbinfoaof_enabled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_enabled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_scheduled)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_scheduled&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_last_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_current_rewrite_time_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_rewrite_time_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result            ;;aof_last_bgrewrite_status)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_last_bgrewrite_status&quot; | awk -F':' '&#123;print $2&#125;' | /bin/grep -c ok`        echo $result;;#aofinfoaof_current_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_current_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_base_size)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_base_size&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_rewrite)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_rewrite&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_rewrite_buffer_length)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_rewrite_buffer_length&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_pending_bio_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_pending_bio_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;aof_delayed_fsync)        result=`$REDIS_INFO|/bin/grep -w &quot;aof_delayed_fsync&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;#statstotal_connections_received)        result=`$REDIS_INFO|/bin/grep -w &quot;total_connections_received&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;total_commands_processed)        result=`$REDIS_INFO|/bin/grep -w &quot;total_commands_processed&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;instantaneous_ops_per_sec)        result=`$REDIS_INFO|/bin/grep -w &quot;instantaneous_ops_per_sec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;rejected_connections)        result=`$REDIS_INFO|/bin/grep -w &quot;rejected_connections&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;expired_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;expired_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;evicted_keys)        result=`$REDIS_INFO|/bin/grep -w &quot;evicted_keys&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_hits)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_hits&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;keyspace_misses)        result=`$REDIS_INFO|/bin/grep -w &quot;keyspace_misses&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_channels)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_channels&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;pubsub_patterns)        result=`$REDIS_INFO|/bin/grep -w &quot;pubsub_patterns&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;latest_fork_usec)        result=`$REDIS_INFO|/bin/grep -w &quot;latest_fork_usec&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;connected_slaves)        result=`$REDIS_INFO|/bin/grep -w &quot;connected_slaves&quot; | awk -F':' '&#123;print $2&#125;'`        echo $result;;master_link_status)        result=`$REDIS_INFO|/bin/grep -w &quot;master_link_status&quot;|awk -F':' '&#123;print $2&#125;'|/bin/grep -c up`        echo $result;;master_last_io_seconds_ago)        result=`$REDIS_INFO|/bin/grep -w &quot;master_last_io_seconds_ago&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;master_sync_in_progress)        result=`$REDIS_INFO|/bin/grep -w &quot;master_sync_in_progress&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;slave_priority)        result=`$REDIS_INFO|/bin/grep -w &quot;slave_priority&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;#cpuused_cpu_sys)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_sys_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_sys_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;used_cpu_user_children)        result=`$REDIS_INFO|/bin/grep -w &quot;used_cpu_user_children&quot;|awk -F':' '&#123;print $2&#125;'`        echo $result;;*) echo &quot;argu error&quot;;;esac#db0:key   elif [[ $# -eq 4 ]];thencase $4 inkeys)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;keys&quot; | awk -F'=|,' '&#123;print $2&#125;'`        echo $result;;expires)        result=`$REDIS_INFO| /bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;expires&quot; | awk -F'=|,' '&#123;print $4&#125;'`        echo $result;;avg_ttl)        result=`$REDIS_INFO|/bin/grep -w &quot;db0&quot;| /bin/grep -w &quot;$1&quot; | /bin/grep -w &quot;avg_ttl&quot; | awk -F'=|,' '&#123;print $6&#125;'`        echo $result;;*)     echo &quot;argu error&quot; ;;esacfiEOFcat&gt;$&#123;ZabbixShell&#125;/ip_port_discovery.sh&lt;&lt;&quot;EOF&quot;#!/bin/bash#$1æ˜¯è¦å‘ç°çš„è¿›ç¨‹éƒ¨åˆ†è¯æ±‡portarray=(`sudo ss -tnlp|egrep -i &quot;$1&quot;|awk &#123;'print $4'&#125;|awk -F':' '&#123;if ($NF~/^[0-9]*$/) print $NF&#125;'|sort|uniq`)iparray=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`length=$&#123;#portarray[@]&#125;printf &quot;&#123;\n&quot;printf '\t'&quot;\&quot;data\&quot;:[&quot;for ((i=0;i&lt;$length;i++))  do     printf '\n\t\t&#123;'     printf &quot;\&quot;&#123;#IP&#125;\&quot;:\&quot;$&#123;iparray&#125;\&quot;,\&quot;&#123;#TCP_PORT&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;     if [ $i -lt $[$length-1] ];then                printf ','     fi  doneprintf &quot;\n\t]\n&quot;printf &quot;&#125;\n&quot;EOFchmod a+x $&#123;ZabbixShell&#125;/redis_info.shchmod a+x $&#123;ZabbixShell&#125;/ip_port_discovery.shsed -i 's#RedisCli=#RedisCli=\&quot;'&quot;$&#123;RedisCli&#125;&quot;'\&quot;#' $&#123;ZabbixShell&#125;/redis_info.shecho '------------------------------------æˆ‘æ˜¯ zabbix ç›‘æ§ä¿¡æ¯----------------------------------'echo 'ç¼–è¾‘ visudoï¼Œæ·»åŠ å¦‚ä¸‹ä¿¡æ¯'echo &quot;#zabbixç”¨æˆ·å¯ä»¥ä»¥sudoæ‰§è¡Œsszabbix ALL = NOPASSWD: /usr/sbin/ss#zabbixç”¨æˆ·ä½¿ç”¨sudoæ— éœ€ttyDefaults:zabbix    !requiretty&quot;echo 'è‹¥redisè¿è¡Œåœ¨dockerä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤'echo 'usermod -a -G docker zabbix'</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜webç›‘æ§</title>
      <link href="posts/3d20f83e/"/>
      <url>posts/3d20f83e/</url>
      
        <content type="html"><![CDATA[<h2 id="1-æ„å»º-zabbix-agentd-ç«¯é…ç½®">1. æ„å»º zabbix_agentd ç«¯é…ç½®</h2><pre><code class="language-bash"># ç›®å½•ç»“æ„[root@ip-10-230-10-105 zabbix]# pwd/etc/zabbix[root@ip-10-230-10-105 zabbix]# tree &#123;etc,shell&#125;etcâ”œâ”€â”€ zabbix_agentd.confâ”œâ”€â”€ zabbix_agentd.conf.bakâ””â”€â”€ zabbix_agentd.conf.d    â””â”€â”€ http_status.conf # æˆ‘æ˜¯ zabbix_agentd æ•°æ®é¡¹é…ç½®shellâ””â”€â”€ web    â”œâ”€â”€ http_status.py # æˆ‘æ˜¯è‡ªåŠ¨å‘ç°è„šæœ¬ + æ•°æ®é‡‡é›†è„šæœ¬    â””â”€â”€ WEB.txt  # æˆ‘æ˜¯è‡ªåŠ¨å‘ç°çš„æ•°æ®æº2 directories, 5 files</code></pre><pre><code class="language-bash"># zabbix_agentd é…ç½® http_status.confUserParameter=web.site.code[*],/usr/bin/python /etc/zabbix/shell/web/http_status.py web_site_code $1UserParameter=web.site.discovery,/usr/bin/python /etc/zabbix/shell/web/http_status.py web_site_discovery</code></pre><pre><code class="language-bash"># è‡ªåŠ¨å‘ç°è§„åˆ™é…ç½®æ–‡ä»¶ WEB.txt# ä¸€è¡Œä¸€ä¸ªç›‘æ§åœ°å€# get åŸæ ·å†™å…¥# post æ¨¡ä»¿getå¤šåŠ ä¸€ä¸ª?https://abc.com??&lt;post_kv&gt;https://abc.com?&lt;get_kv&gt;</code></pre><pre><code class="language-python">#!/usr/bin/env python#encoding=utf-8# python2.7# è‡ªåŠ¨å‘ç°è„šæœ¬ + æ•°æ®é‡‡é›†è„šæœ¬ http_status.py# è¯·å°†æˆ‘æ·»åŠ  o+x æƒé™import urllib2, sys, json, ConfigParser, os a1 = sys.argv[1]def web_site_code(args):    response = None    WEB_TXT = &quot;%s/WEB.txt&quot; % (os.path.dirname(os.path.realpath(__file__)))    for line in open(WEB_TXT):        if args in line:            if &quot;??&quot; in line:                line = line.strip('\n').split(&quot;??&quot;)            elif &quot;?&quot; in line:                line = line.strip('\n').split(&quot;?&quot;)            else:                line = line.strip('\n')            try:                try:                    response = urllib2.urlopen(line[0], data=line[1], timeout=5)                    print response.code                except IndexError:                    response = urllib2.urlopen(line[0], timeout=5)                    print response.code                finally:                    response = urllib2.urlopen(line, timeout=5)                    print response.code            except urllib2.URLError,e:                if hasattr(e, 'code'):                    print e.code                elif hasattr(e, 'reason'):                    print 53            finally:                if response:                    response.close()                exit()def web_site_discovery():    Dict = &#123;&quot;data&quot;:[]&#125;    WEB_TXT = &quot;%s/WEB.txt&quot; % (os.path.dirname(os.path.realpath(__file__)))    for line in open(WEB_TXT):        if &quot;??&quot; in line:            line = line.strip('\n').split(&quot;??&quot;)            line = &#123;&quot;&#123;#SITENAME&#125;&quot;:line[0]&#125;        elif &quot;?&quot; in line:            line = line.strip('\n').split(&quot;?&quot;)            line = &#123;&quot;&#123;#SITENAME&#125;&quot;:line[0]&#125;        else:            line = line.strip('\n')            line = &#123;&quot;&#123;#SITENAME&#125;&quot;:line&#125;        Dict[&quot;data&quot;].append(line)    print json.dumps(Dict, indent=2)if a1 == 'web_site_code':    url = sys.argv[2]    web_site_code(url)elif a1 == 'web_site_discovery':    web_site_discovery()</code></pre><blockquote><p>{ #SITENAME} è‡ªåŠ¨å‘ç°è„šæœ¬è¾“å‡ºçš„é‡è¦å˜é‡ servername åœ°å€ï¼Œå°†ä¼šç”¨äº web æ§åˆ¶å°é…ç½®</p></blockquote><h2 id="2-æ„å»º-web-æ§åˆ¶å°é…ç½®">2. æ„å»º web æ§åˆ¶å°é…ç½®</h2><ul><li><p>æ„å»ºä¸€ä¸ªä¸»æœºé¡¹ï¼Œç›‘æ§ agentd</p></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºç›‘æ§é¡¹åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20200616182457232.png" alt="image-20200616182457232"></p></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºè§¦å‘å™¨åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20200616182509904.png" alt="image-20200616182509904"></p><blockquote><p>100ç§’ä»¥å†…ï¼Œæ”¶é›†åˆ°ä¸‰æ¬¡ä¸æ˜¯200çš„æ•°æ®ï¼Œå°±æŠ¥è­¦</p></blockquote></li><li><p>åœ¨è‡ªåŠ¨å‘ç°è§„åˆ™é‡Œï¼Œæ„å»ºå›¾å½¢åŸå‹ï¼Œå†…å®¹å¦‚å›¾ï¼š</p><p><img src="/posts/3d20f83e/image-20200616182538573.png" alt="image-20200616182538573"></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix â˜ nginx</title>
      <link href="posts/b35b5965/"/>
      <url>posts/b35b5965/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç¡®ä¿ç›¸å…³ç›®å½•åœ°å€å¦‚ä¸‹ï¼š</p><p>/etc/zabbix/shell</p><p>/etc/zabbix/zabbix_agentd.d</p><p>/usr/local/nginx/conf/server</p></blockquote><ul><li>1ï¼Œnginxå¢åŠ é…ç½® server_status.server</li></ul><pre><code class="language-bash:">cat &gt; /usr/local/nginx/conf/server/server_status.server &lt;&lt; 'EOF'server &#123;    listen       80;    server_name  127.0.0.1;    #charset koi8-r;    access_log  off;    location /server_status &#123;        stub_status on;        access_log off;        allow 127.0.0.1;        deny all;    &#125;&#125;EOF/usr/local/nginx/sbin/nginx -t &amp;&amp; /usr/local/nginx/sbin/nginx -s reload</code></pre><hr><ul><li>2ï¼Œ<a href="http://xn--nginx-e86hk14jmnl025b.sh">æ·»åŠ è„šæœ¬nginx.sh</a>  (ç¡®ä¿a+xæƒé™)</li></ul><pre><code class="language-bash:">mkdir /etc/zabbix/shell -p;cat &gt; /etc/zabbix/shell/nginx.sh &lt;&lt; 'EOF'#!/bin/bash  function active &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| grep 'Active' | awk '&#123;print $NF&#125;'&#125;function reading &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| grep 'Reading' | awk '&#123;print $2&#125;'&#125;function writing &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt;/dev/null| grep 'Writing' | awk '&#123;print $4&#125;'&#125;function waiting &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| grep 'Waiting' | awk '&#123;print $6&#125;'&#125;function accepts &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| awk NR==3 | awk '&#123;print $1&#125;'&#125;function handled &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| awk NR==3 | awk '&#123;print $2&#125;'&#125;function requests &#123;/usr/bin/curl &quot;http://127.0.0.1/server_status&quot; 2&gt; /dev/null| awk NR==3 | awk '&#123;print $3&#125;'&#125;function qps &#123;        NGINX_STATUS_URL=&quot;http://127.0.0.1/server_status&quot;        #è‹¥æ˜¯tnginxï¼Œåˆ™æœ€ååº”è¾“å‡ºd[length(d)-1]        requestold=`/usr/bin/curl -s $&#123;NGINX_STATUS_URL&#125; | /usr/bin/awk '/server accepts handled requests/&#123;getline a;split(a,d);print d[length(d)]&#125;'`        TimeWait=1        sleep $TimeWait        requestnew=`/usr/bin/curl -s $&#123;NGINX_STATUS_URL&#125; | /usr/bin/awk '/server accepts handled requests/&#123;getline a;split(a,d);print d[length(d)]&#125;'`        if [ $requestnew -gt 0 ];then                QPS=`echo &quot;( $requestnew - $requestold ) / $TimeWait&quot; | /usr/bin/bc`        fi        echo $QPS&#125;# Run the requested function  $1EOFchmod a+x /etc/zabbix/shell/nginx.sh</code></pre><hr><ul><li>3ï¼Œé…ç½®zabbixå®¢æˆ·ç«¯zabbix_agentd.conf</li></ul><pre><code class="language-bash:">cat &gt; /etc/zabbix/zabbix_agentd.d/nginx.conf &lt;&lt; 'EOF'#monitor nginx  UserParameter=nginx.accepts,/etc/zabbix/shell/nginx.sh acceptsUserParameter=nginx.handled,/etc/zabbix/shell/nginx.sh handledUserParameter=nginx.requests,/etc/zabbix/shell/nginx.sh requestsUserParameter=nginx.connections.active,/etc/zabbix/shell/nginx.sh activeUserParameter=nginx.connections.reading,/etc/zabbix/shell/nginx.sh readingUserParameter=nginx.connections.writing,/etc/zabbix/shell/nginx.sh writingUserParameter=nginx.connections.waiting,/etc/zabbix/shell/nginx.sh waitingUserParameter=nginx.connections.qps,/etc/zabbix/shell/nginx.sh qpsEOF</code></pre><hr><ul><li>4ï¼Œåœ¨æœåŠ¡çš„å¯¹åº”ä¸»æœºä¸Šæ·»åŠ æ¨¡æ¿</li></ul>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbixâ˜agentå’Œproxyï¼ˆyumï¼‰</title>
      <link href="posts/1587f6e8/"/>
      <url>posts/1587f6e8/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://repo.zabbix.com/zabbix/">https://repo.zabbix.com/zabbix/</a></p></blockquote><h2 id="å¯¼å…¥-zabbix-æº">å¯¼å…¥ zabbix æº</h2><pre><code class="language-bashï¼š">rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</code></pre><h2 id="agent-å®‰è£…">agent å®‰è£…</h2><pre><code class="language-shell">yum install zabbix-agent -ysystemctl enable zabbix-agent</code></pre><h2 id="agentä¸»åŠ¨æ¨¡å¼é…ç½®æ–‡ä»¶">agentä¸»åŠ¨æ¨¡å¼é…ç½®æ–‡ä»¶</h2><pre><code># ä¸»æœºåå‰ç¼€name_prefix=# è‡ªåŠ¨å‘ç°ç”¨çš„å…ƒæ•°æ®host_meta_data=''# serveræˆ–è€…proxyåœ°å€server_proxy_addr=local_ip=`curl -sq http://169.254.169.254/latest/meta-data/local-ipv4`mv /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak;cat &gt; /etc/zabbix/zabbix_agentd.conf &lt;&lt; EOFHostname=$&#123;name_prefix&#125;_$&#123;local_ip&#125;StartAgents=0ServerActive=$&#123;server_proxy_addr&#125;PidFile=/var/run/zabbix/zabbix_agentd.pidLogFile=/var/log/zabbix/zabbix_agentd.log#DebugLevel=4Include=/etc/zabbix/zabbix_agentd.d/*.conf#è¢«ç›‘æ§ç«¯åˆ°æœåŠ¡å™¨è·å–ç›‘æ§é¡¹çš„å‘¨æœŸRefreshActiveChecks=60#è¢«ç›‘æ§ç«¯å­˜å‚¨ç›‘æ§ä¿¡æ¯çš„ç©ºé—´å¤§å°BufferSize=1000MaxLinesPerSecond=200#è¶…æ—¶æ—¶é—´Timeout=10#è‡ªåŠ¨å‘ç°ç”¨çš„å…ƒä¿¡æ¯HostMetadata=$&#123;host_meta_data&#125;EOFvi  /etc/zabbix/zabbix_agentd.confsystemctl start zabbix-agent</code></pre><h2 id="proxy-å®‰è£…å‘½ä»¤">proxy å®‰è£…å‘½ä»¤</h2><pre><code class="language-bash:">yum install zabbix-proxy-mysql -y# è§£å‹æ•°æ®åº“æ–‡ä»¶, å¹¶è‡ªè¡Œå¯¼å…¥zcat /usr/share/doc/zabbix-proxy-mysql-*/schema.sql.gz &gt; schema.sql</code></pre><h2 id="proxy-é…ç½®">proxy é…ç½®</h2><pre><code class="language-bash">mv /etc/zabbix/zabbix_proxy.conf /etc/zabbix/zabbix_proxy.conf.bak;cat &gt; /etc/zabbix/zabbix_proxy.conf  &lt;&lt; 'EOF'Server=ServerPort=10051Hostname=LogFile=/var/log/zabbix/zabbix_proxy.logPidFile=/var/run/zabbix/zabbix_proxy.pidDBHost=DBPort=DBName=DBUser=DBPassword=Timeout=4LogSlowQueries=3000ConfigFrequency=60DataSenderFrequency=60StartDiscoverers=5CacheSize=128MStartDBSyncers=20HistoryCacheSize=256MHistoryIndexCacheSize=32MEOFvi /etc/zabbix/zabbix_proxy.conf</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
          <category> zabbix </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ å¾®ä¿¡é¢„è­¦</title>
      <link href="posts/f9b08c30/"/>
      <url>posts/f9b08c30/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># conf.ini[wechat]corpid = [app]it = &lt;app_agent_id&gt;:&lt;app_secret&gt;[group]it = usera|userb</code></pre><pre><code class="language-python">#!/usr/bin/env python3&quot;&quot;&quot;@author: zyh@contact: aaa103439@hotmail.com@software: vscode@file: sendchat.py@time: 2020/02/05&quot;&quot;&quot;import sys, os, requests, pathlib, json, configparserimport loggingimport logging.handlersfrom datetime import datetimeclass PySendchat():    def __init__(self, corpid, agentid, secret, touser, content):        self.corpid=corpid        self.agentid=agentid        self.secret=secret        self.touser=touser        self.content=content        LOG_PATHDIR=os.path.dirname(os.path.abspath(__file__))        LOG_FILENAME = '&#123;0&#125;/sendchat.log'.format(LOG_PATHDIR)        self.my_logger = logging.getLogger('SendChat')        self.my_logger.setLevel(logging.INFO)        # Add the log message handler to the logger        handler = logging.handlers.RotatingFileHandler(LOG_FILENAME, maxBytes=102400000, backupCount=5)        # create formatter and add it to the handlers        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')        handler.setFormatter(formatter)        self.my_logger.addHandler(handler)    def gettoken(self):        self.my_logger.info('-----------------------------------------------------------------------------------------')        pwd=os.path.dirname(os.path.abspath(__file__))        tokenfile='&#123;0&#125;/wechat.&#123;1&#125;'.format(pwd,self.agentid)        if pathlib.Path(tokenfile).exists():            tokenfilectime=os.path.getctime(tokenfile)            currenttime=datetime.now().timestamp()            dtime=currenttime-tokenfilectime            self.my_logger.info('&#123;0&#125; lived &#123;1&#125;s.'.format(tokenfile, dtime))            if dtime &gt;= 7200:                try:                    os.remove(tokenfile)                    self.my_logger.info('Token file &#123;0&#125;: delete success'.format(tokenfile))                except Exception as e:                    self.my_logger.error('Token file:&#123;0&#125; delete error.Reason:&#123;1&#125;'.format(tokenfile,e))                    exit        # check token file        try:            tokensize = os.path.getsize(tokenfile)        except Exception as e:            self.my_logger.info('Token file is not exist.Reason:&#123;0&#125;'.format(e))            tokensize = 0        # get token from token file        if tokensize != 0:            with open(tokenfile, 'rb') as fd:                token = fd.read() # get token success                self.my_logger.info('Get token from token file.')            jsonObject = json.loads(token.decode(encoding='utf8'))            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token        # get token from weixin api        else:            try:                self.my_logger.info('New Token Create.')                f = requests.get('https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#123;0&#125;&amp;corpsecret=&#123;1&#125;'.format(self.corpid, self.secret))                token = f.content                self.my_logger.info('Get token from weixin api.')                jsonObject = json.loads(token.decode(encoding='utf8'))                errcode=int(jsonObject.get(&quot;errcode&quot;))                if errcode != 0:                    errmsg=jsonObject.get(&quot;errmsg&quot;)                    self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(errmsg))                    exit()            except Exception as e:                self.my_logger.error('Get token error!Reason:&#123;0&#125;'.format(e))                exit()            try:                self.my_logger.info('Write token to &#123;0&#125;.'.format(tokenfile))                with open(tokenfile, 'wb') as fd:                    fd.write(token)            except Exception as e:                self.my_logger.error('Write &#123;0&#125; error!Reason:&#123;1&#125;'.format(tokenfile,e))                exit()            access_token = jsonObject.get(&quot;access_token&quot;)            return access_token    def sendmsg(self):        accessToken = self.gettoken()        self.my_logger.info('Token:&#123;0&#125;'.format(accessToken))        sendMapDirectroy = &#123;&#125;        sendMapDirectroy[&quot;agentid&quot;] = self.agentid        sendMapDirectroy[&quot;touser&quot;] = self.touser        sendMapDirectroy[&quot;msgtype&quot;] = &quot;text&quot;        sendMapDirectroy[&quot;safe&quot;] = &quot;0&quot;        contentDirectory = &#123;&#125;        sendMapDirectroy[&quot;text&quot;] = contentDirectory        contentDirectory[&quot;content&quot;] = self.content        bodyStr = json.dumps(sendMapDirectroy, ensure_ascii=False).encode(encoding=&quot;utf-8&quot;)        try:            f = requests.post(url=&quot;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s&quot; % accessToken,                          data=bodyStr, timeout=5)            self.my_logger.info(f.content)        except Exception as e:            self.my_logger.error('Send chat network error!Reason:&#123;0&#125;'.format(e))if __name__ == '__main__':    appname = sys.argv[1]    content = sys.argv[3]    # read conf.ini    conf = configparser.ConfigParser()    conf_path = os.path.dirname(os.path.abspath(__file__))    conf_ini = &quot;&#123;0&#125;/conf.ini&quot;.format(conf_path)    if pathlib.Path(conf_ini).exists():        conf.read(conf_ini)        corpid = conf.get(&quot;wechat&quot;, &quot;corpid&quot;)        appinfo = conf.get(&quot;app&quot;, appname)        agentid = appinfo.split(':')[0]        secret = appinfo.split(':')[1]        groupname = conf.get(&quot;group&quot;, appname)        touser = groupname.split(':')[0]        chatobj = PySendchat(corpid, agentid, secret, touser, content)    else:        print('conf.ini error')        exit()    try:        chatobj.sendmsg()    except:        chatobj.my_logger.error(&quot;Send chat failure!&quot;)</code></pre><p>eg:</p><p>python <a href="http://sendchat.py">sendchat.py</a> it â€˜â€™ &lt;é¢„è­¦å†…å®¹&gt;</p><blockquote><p>åˆ›å»ºå¥½appï¼Œå¹¶å…³è”ç”¨æˆ·åˆ°app</p><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œä¼šå°†é¢„è­¦å†…å®¹é€šè¿‡&lt;app_agent_id&gt; åº”ç”¨å‘é€ç»™ç”¨æˆ·useraå’Œuserb</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ä¼ä¸šå¾®ä¿¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ è¿œç¨‹ç£ç›˜æ£€æµ‹</title>
      <link href="posts/1fac36d/"/>
      <url>posts/1fac36d/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash">#!/bin/bash # æ–‡ä»¶åï¼šdisklog.sh # ç”¨é€”ï¼šç›‘è§†è¿œç¨‹ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ BaseDir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`cd $BaseDirlogfile=&quot;disk.log&quot; if [[ -n $1 ]];then     logfile=$1 fishellexecuser=`whoami`if [[ $shellexecuser == root ]];then    rm -rf /root/.ssh/known_hostselse    rm -rf /home/$shellexecuser/.ssh/known_hostsfiprintf &quot;%-8s %-14s %-9s %-8s %-6s %-6s %-6s %s\r\n&quot; &quot;Date&quot; &quot;IP ADDRESS&quot; &quot;Device&quot; &quot;Capacity&quot; &quot;Used&quot; &quot;Free&quot; &quot;Percent&quot; &quot;Status&quot; &gt; $logfile ##################### æ‰‹åŠ¨å¡«å†™åŒº# æä¾›è¿œç¨‹ä¸»æœºIPåœ°å€åˆ—è¡¨ 1.1.1.1 2.2.2.2 3.3.3.3IP_LIST=# ç›‘æ§é˜ˆå€¼(ç™¾åˆ†æ¯”) åªå¡«å†™æ•°å­— 1 åˆ° 100DiskPct=# æ‰§è¡Œç”¨æˆ·UserName=''# æ‰§è¡Œç”¨æˆ·æ‰€éœ€ç§é’¥, æ­¤æ–‡ä»¶éœ€è¦ä¸è„šæœ¬åŒçº§ç›®å½•PemName=''# ä¼ä¸šå¾®ä¿¡botæœºå™¨äººåœ°å€wx_api=''##################### æ‰‹åŠ¨å¡«å†™åŒºfor ip in $IP_LIST;do     ssh -i $PemName -o StrictHostKeyChecking=no $&#123;UserName&#125;@$ip 'df -H' | grep ^/dev/ &gt; /tmp/$$.df     while read line;do         cur_date=`date  &quot;+%F_%R&quot;`        printf &quot;%-8s %-14s &quot; $cur_date $ip         echo $line | awk '&#123; printf(&quot;%-9s %-8s %-6s %-6s %-8s&quot;, $1,$2,$3,$4,$5); &#125;'         pusg=$(echo $line | egrep -o &quot;[0-9]+%&quot;)         pusg=$&#123;pusg/\%/&#125;;         if [ $pusg -lt $DiskPct ];then             echo OK        else             echo ALERT         fi     done &lt; /tmp/$$.df     rm -rf /tmp/$$.dfdone &gt;&gt; $&#123;logfile&#125;sed -n '1p' $&#123;logfile&#125; &gt; alert.logawk '$NF == &quot;ALERT&quot;&#123;print $0&#125;' $&#123;logfile&#125; &gt;&gt; alert.log#sed -i '1i &quot;ç£ç›˜é˜ˆå€¼ï¼š'&quot;$DiskPct&quot;'&quot;' alert.logcontent=`cat alert.log`grep -q 'ALERT' alert.log &amp;&amp; &#123;curl &quot;$wx_api&quot;  -H 'Content-Type: application/json'  \-d '   &#123;        &quot;msgtype&quot;: &quot;text&quot;,        &quot;text&quot;: &#123;            &quot;content&quot;: &quot;'&quot;$content&quot;'&quot;        &#125;   &#125;'&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ç£ç›˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§ â˜ é‚®ä»¶é¢„è­¦</title>
      <link href="posts/f8f9b4d0/"/>
      <url>posts/f8f9b4d0/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># $1 æ”¶ä»¶äºº# $2 ä¸»é¢˜# $3 å†…å®¹smtpServer=  # smtp æœåŠ¡å™¨åœ°å€ï¼Œä¾‹å¦‚ smtp.gmail.com:xxxsendUserEmail='it@abc.com'sendUserPassword=  # ä¸€èˆ¬å‘ä»¶äººé‚®ç®±å¯†ç éƒ½æ˜¯ä¸“ç”¨å¯†ç ï¼Œå¹¶éwebå¯†ç /usr/local/bin/sendEmail -f $&#123;sendUserEmail&#125; -t $1 -u &quot;$2&quot; -m &quot;$3&quot; -s $&#123;smtpServer&#125; -xu $&#123;sendUserEmail&#125; -xp $&#123;sendUserPassword&#125; -o message-charset=utf-8</code></pre><pre><code class="language-python">#!/usr/bin/python#coding:utf-8# by zyh# python sendmail.py 'æ”¶ä»¶äººé‚®ç®±åœ°å€'  'ä¸»é¢˜' 'é‚®ä»¶å†…å®¹' 'æŠ„é€é‚®ç®±åœ°å€' 'é™„ä»¶ç»å¯¹è·¯å¾„'import smtplibfrom email.header import Headerfrom email.mime.text import MIMETextfrom email.mime.multipart import MIMEMultipartimport sysreload(sys)sys.setdefaultencoding('utf8')mail_host = 'smtpæœåŠ¡å™¨åœ°å€'  # ä¾‹å¦‚ smtp.gmail.com:587mail_user = 'å‘ä»¶äººé‚®ç®±'      # ä¾‹å¦‚ it@gmail.commail_pass = 'å‘ä»¶äººå¯†ç 'def send_mail(*args):    argsNum=len(args[0])    if argsNum == 4:        filename,to_list, subject, content=args[0]    elif argsNum == 5:        filename,to_list, subject, content, cc_list=args[0]    elif argsNum == 6:        filename,to_list, subject, content, cc_list, subfile=args[0]    me = mail_user+&quot;&lt;&quot;+mail_user+&quot;&gt;&quot;    #åˆå§‹åŒ–é‚®ä»¶å¯¹è±¡ msg    msg = MIMEMultipart()    msg['From'] = me    msg['to'] = to_list    emailList=to_list    # ä¸»é¢˜    msg['Subject'] = Header(subject, 'utf-8').encode()    # å†…å®¹    msg.attach(MIMEText(content, 'plain', 'utf-8'))    # æŠ„é€    if 'cc_list' in vars():        msg['Cc'] = cc_list        emailstring = to_list+','+cc_list        emailList=emailstring.split(&quot;,&quot;)    # é™„ä»¶    if 'subfile' in vars():        att1 = MIMEText(open((&quot;%s&quot;%subfile),'rb').read(), 'base64', 'utf8')        att1[&quot;Content-Type&quot;] = 'text/plain'        att1[&quot;Content-Disposition&quot;] = 'attachment; filename='+subfile.split('/')[-1] # è¿™é‡Œçš„filenameå¯ä»¥ä»»æ„å†™ï¼Œå†™ä»€ä¹ˆåå­—ï¼Œé‚®ä»¶ä¸­æ˜¾ç¤ºä»€ä¹ˆåå­—        msg.attach(att1)    # å‘é€    try:        print &quot;start sendmail&quot;        s = smtplib.SMTP(mail_host)        print &quot;connect mail server suesscc&quot;        s.starttls()        s.login(mail_user,mail_pass)        print &quot;login mail server suesscc&quot;        s.sendmail(me,emailList,msg.as_string())        s.close()        return True    except Exception,e:        print &quot;%s\t%s&quot;%(to_list,str(e))        return Falseif __name__ == &quot;__main__&quot;:    if len(sys.argv) &lt; 4:        exit()    send_mail(sys.argv)</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> é‚®ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç›‘æ§â˜ä¼ä¸šå¾®ä¿¡æœºå™¨äºº</title>
      <link href="posts/8c33f887/"/>
      <url>posts/8c33f887/</url>
      
        <content type="html"><![CDATA[<h4 id="shell">shell</h4><pre><code class="language-bash">wechatUrl=wechatData=curl $&#123;wechatUrl&#125; -H 'Content-Type: application/json' -d '&#123;&quot;msgtype&quot;: &quot;markdown&quot;,&quot;markdown&quot;: &#123;&quot;content&quot;: &quot;`'&quot;$wechatData&quot;'`&quot;&#125;&#125;'</code></pre><h4 id="python">python</h4><pre><code class="language-python">import json, requestswechatData=&#123;&quot;msgtype&quot;: &quot;text&quot;,&quot;text&quot;: &#123;&quot;content&quot;: &quot;&quot;&#125;&#125;wechatData['text']['content']='å¹¿å·ä»Šæ—¥å¤©æ°”ï¼š29åº¦ï¼Œå¤§éƒ¨åˆ†å¤šäº‘ï¼Œé™é›¨æ¦‚ç‡ï¼š60%'wechatData['text']['mentioned_list']=[&quot;zyh&quot;]  # all ä»£è¡¨ç¾¤ç»„æ‰€æœ‰äººwechatData=json.dumps(wechatData)wechatUrl=requests.post(url=wechatUrl, headers=&#123;&quot;Content-Type&quot;: &quot;application/json&quot;&#125;, data=wechatData, timeout=5)</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç›‘æ§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç›‘æ§ </tag>
            
            <tag> ä¼ä¸šå¾®ä¿¡ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜logrotateå®‰è£…</title>
      <link href="posts/421d605e/"/>
      <url>posts/421d605e/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>logrotate å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ—¥å¿—åˆ‡å‰²ï¼Œæ­é… cron æœåŠ¡ï¼Œå°±å¯ä»¥è‡ªåŠ¨çš„è¿›è¡Œè½®è½¬</p><h4 id="logrotate-ç‰ˆæœ¬æ›´æ–°">logrotate ç‰ˆæœ¬æ›´æ–°</h4><blockquote><p>ç¡®ä¿ logrotate æ”¯æŒå°æ—¶çº§åˆ«çš„ç®¡ç†ï¼Œæ›¿æ¢/usr/sbin/logrotate,å¹¶é™„åŠ xæƒé™ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸€ä¸ªäºŒè¿›åˆ¶ç‰ˆæœ¬<a href="D:%5Czyh.cool%5Csource_posts%5C%E6%97%A5%E5%BF%97%5C%E5%85%B6%E5%AE%83%5C%E6%97%A5%E5%BF%97%E2%98%9Elogrotate%E5%AE%89%E8%A3%85%5Clogrotate">logrotate</a></p><p>æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥å» github ä¸Šæ‹‰å–https://github.com/logrotate/logrotate</p></blockquote><h4 id="æ·»åŠ -logrotate-é…ç½®">æ·»åŠ  logrotate é…ç½®</h4><pre><code class="language-bash"># æ·»åŠ æ‰€éœ€åˆ‡å‰²çš„æ—¥å¿—é…ç½®cat &gt; /etc/logrotate.d/nginx &lt;&lt; 'EOF'/usr/local/nginx/logs/access.log &#123;  # å®šä¹‰æ—¥å¿—ä½ç½® hourly    # æŒ‰ç…§å°æ—¶åˆ‡å‰² rotate 2  # æœ€å¤šä¿ç•™ä¸¤ä»½åˆ‡å‰²æ—¥å¿— missingok nocompress sharedscripts postrotate  /bin/kill -USR1 `cat /usr/local/nginx/logs/nginx.pid 2&gt;/dev/null` 2&gt;/dev/null || true endscript&#125;EOF</code></pre><h4 id="æ·»åŠ -crontab-é…ç½®">æ·»åŠ  crontab é…ç½®</h4><pre><code class="language-bash"># æ·»åŠ logrotateæ‰§è¡Œè„šæœ¬cp /etc/cron.daily/logrotate /etc/cron.hourly/</code></pre><h4 id="é‡è½½-crond-æœåŠ¡">é‡è½½ crond æœåŠ¡</h4><pre><code class="language-bash">systemctl reload crond</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> logrotate </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-è¿‡æ»¤å™¨</title>
      <link href="posts/f43dca37/"/>
      <url>posts/f43dca37/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä¸ç®¡æ˜¯è¿‡æ»¤å™¨ï¼Œlookupï¼Œqueryï¼Œwith_xxxï¼Œå¾ˆå¤šéƒ½æ˜¯è·å–æˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ã€‚</p><h4 id="è¿‡æ»¤å™¨">è¿‡æ»¤å™¨</h4><blockquote><p><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</a></p></blockquote><blockquote><p>å¤„ç†å˜é‡å€¼ï¼Œä»è€Œè·å–æƒ³è¦çš„ä¿¡æ¯.</p><p>è¿‡æ»¤å™¨æœ¬èº«æ˜¯ jinja2 æˆ–è€… ansible å®˜æ–¹å®šä¹‰çš„</p></blockquote><h4 id="ç®€ä¾‹">ç®€ä¾‹</h4><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars:    vara: abcde    varb: [1,2,3,A,b,C,d]    varc: 123    vard: [ 1,2,3,[4,5,6],4,5 ]  tasks:    - name: show upper      debug:        msg: &quot;&#123;&#123; vara | upper&#125;&#125;&quot;</code></pre><blockquote><p>ç®€ä¾‹ä¸­çš„ upper å³æ˜¯è¿‡æ»¤å™¨ï¼Œå®ƒå¯ä»¥å°† vara ä¸­çš„æ‰€æœ‰å­—æ¯å…ƒç´ å¤§å†™ï¼Œæœ€ç»ˆè¾“å‡º ABCDE</p></blockquote><h4 id="å¸¸ç”¨çš„è¿‡æ»¤å™¨">å¸¸ç”¨çš„è¿‡æ»¤å™¨</h4><pre><code class="language-yaml">#å°†å­—ç¬¦ä¸²å¼€å¤´å’Œç»“å°¾çš„ç©ºæ ¼å»é™¤msg:Â &quot;&#123;&#123;Â varaÂ |Â trimÂ &#125;&#125;&quot;#è¿”å›å­—ç¬¦ä¸²æˆ–åˆ—è¡¨é•¿åº¦,lengthä¸countç­‰æ•ˆ,å¯ä»¥å†™ä¸ºcountmsg:Â &quot;&#123;&#123;Â varbÂ |Â lengthÂ &#125;&#125;&quot;# ç»å¯¹å€¼msg: &quot;&#123;&#123; varc | abs &#125;&#125;&quot;# æ’åº(é™åºæ’åº)msg: &quot;&#123;&#123; varb | sort(reverse=true) &#125;&#125;&quot;# å°†åˆ—è¡¨ä¸­ç¬¬ä¸€å±‚åµŒå¥—åˆ—è¡¨å…ƒç´ å±•å¼€å¹¶å…¥åˆ—è¡¨ä¸­,å¹¶å–å‡ºæ–°åˆ—è¡¨ä¸­çš„æœ€å¤§å…ƒç´ msg: &quot;&#123;&#123; vard | flatten(levels=1) | max &#125;&#125;&quot;# éšæœºè¿”å›ä¸€ä¸ªå…ƒç´ msg: &quot;&#123;&#123; varb | random &#125;&#125;&quot;# å»é‡msg: &quot;&#123;&#123; vard | unique &#125;&#125;&quot;# å¹¶é›†msg: &quot;&#123;&#123; varb | union(vard) &#125;&#125;&quot;# äº¤é›†msg: &quot;&#123;&#123; varb | intersect(vard) &#125;&#125;&quot;# è¡¥é›†ï¼Œå–å‡ºå­˜åœ¨äº varbï¼Œä½†ä¸å­˜åœ¨äº vard ä¸­çš„å…ƒç´ msg: &quot;&#123;&#123; varb | difference(vard) &#125;&#125;&quot;# å»é™¤ä¸¤ä¸ªåˆ—è¡¨äº¤é›†åçš„å…ƒç´ msg: &quot;&#123;&#123; varb | symmetric_difference(vard) &#125;&#125;&quot;# å˜é‡æœªå®šä¹‰ï¼Œè¿”å›é»˜è®¤å€¼ newmsg: &quot;&#123;&#123; vare | default('new')&#125;&#125;&quot;# å˜é‡æœªå®šä¹‰æˆ–è€…å®šä¹‰ä½†ä¸ºç©ºï¼Œè¿”å›é»˜è®¤å€¼ newmsg: &quot;&#123;&#123; vare | default('new', boolean=true)&#125;&#125;&quot;# å˜é‡æœªå®šä¹‰æ—¶ï¼Œå¿½ç•¥æŸä¸ªå‚æ•°file: xxxx  mode=&#123;&#123; vare | default(omit)&#125;&#125;&quot;  # è‹¥ vare ä¸å­˜åœ¨ï¼Œåˆ™å¿½ç•¥modeå‚æ•°</code></pre><h4 id="json-query">json_query</h4><blockquote><p>è·å–ç‰¹å®šæ•°æ®</p></blockquote><pre><code>1. æŸ¥è¯¢å­—ç¬¦ä¸²å¯ç”¨å˜é‡ä»£æ›¿ï¼Œå¢åŠ å¯è¯»æ€§ loop: &quot;&#123;&#123; domain_definition | json_query(server_name_cluster1_query) &#125;&#125;&quot; vars:    server_name_cluster1_query: &quot;domain.server[?cluster=='cluster1'].port&quot;</code></pre><ol start="2"><li>æŸ¥è¯¢æ¡ä»¶</li></ol><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars:    users:    - name: zhangsan      gender: male    - name: lisi      gender: female  tasks:    - name: test 1      debug:        msg: &quot;&#123;&#123; users | json_query('[?name==`zhangsan`].gender') &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        &quot;male&quot;    ]&#125;</code></pre><h4 id="map">map</h4><blockquote><p>æ˜ å°„</p></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars:    users:    - name: zhangsan      gender: male    - name: lisi      gender: female  tasks:    - name: test 1      debug:        msg: &quot;&#123;&#123; users|map(attribute='name') | list &#125;&#125;&quot;    - name: test 2      debug:        msg: &quot;&#123;&#123; users | json_query('[*].name') &#125;&#125;&quot;</code></pre><pre><code class="language-bash"># test 2 æ˜¯é‡‡ç”¨ json_query æ–¹å¼ï¼Œtest1å’Œtest2ç»“æœä¸€æ ·ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        &quot;zhangsan&quot;,         &quot;lisi&quot;    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-æ–‡æœ¬æ–‡ä»¶æ“ä½œ</title>
      <link href="posts/4235ddf4/"/>
      <url>posts/4235ddf4/</url>
      
        <content type="html"><![CDATA[<h4 id="var-å®šä¹‰">var å®šä¹‰</h4><blockquote><p>é€šè¿‡å˜é‡ï¼Œä¿®æ”¹playbook</p><p>å¯ç›´æ¥å†™å…¥ playbookï¼Œ ä¹Ÿå¯ä»¥å†™å…¥æ–‡ä»¶ï¼Œç„¶å playbook é€šè¿‡ vars_files å¼•ç”¨</p><p>å…³é”®è¯:</p><ul><li>vars</li><li>vars_files # ä¸€æ¬¡æ€§åŠ è½½æ–‡ä»¶å†…éƒ¨æ•°æ®ï¼Œä¸æ”¯æŒæ–‡ä»¶åŠ¨æ€ä¿®æ”¹æˆ–æ·»åŠ æ–°å˜é‡</li></ul></blockquote><h4 id="ç®€ä¾‹">ç®€ä¾‹</h4><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  vars_files: ~/vars.yml  vars:    father: Zhang San  tasks:    - name: test vars      shell: echo &quot;&#123;&#123; father &#125;&#125; - &#123;&#123; children.son_name &#125;&#125; success&quot; &gt;&gt; ~/son.log</code></pre><pre><code class="language-yaml">children:  son_name: Zhang Xiaosan</code></pre><pre><code class="language-bash"># son.log å†…å®¹Zhang San - Zhang Xiaosan success</code></pre><h4 id="var-æ³¨å†Œ">var æ³¨å†Œ</h4><blockquote><p>å½“æˆ‘ä»¬æƒ³å°†æŸä¸ªä»»åŠ¡çš„ç»“æœå†™å…¥ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨registeræ¥è¿›è¡Œæ³¨å†Œ</p><p>å…³é”®è¯:</p><ul><li>register</li><li>debug<ul><li>var è¾“å‡ºå˜é‡å€¼</li><li>msg è¾“å‡ºå­—ç¬¦ä¸²</li></ul></li></ul></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  tasks:    - name: test register      shell: echo &quot;register success&quot; &gt; ~/register.log      register: resultInfo    - name: show register result      debug:        msg: &quot;Oh my god&quot;        var: resultInfo</code></pre><h4 id="var-äº¤äº’">var äº¤äº’</h4><blockquote><p>æä¾›ä¸€ä¸ªç”¨æˆ·è¾“å…¥ä¿¡æ¯çš„æœºä¼šï¼Œå’Œ shell é‡Œé¢çš„ read -p ä¸€è‡´ã€‚</p><p>å…³é”®è¯ï¼š</p><ul><li>vars_prompt</li></ul></blockquote><pre><code class="language-bash">---- hosts: localhost  remote_user: zyh  vars_prompt:    - name: &quot;fatherName&quot;      prompt: &quot;What's your father name&quot;      default: ZhangSan      private: no  tasks:    - name: show father name      shell: echo &quot;&#123;&#123; fatherName &#125;&#125;&quot; &gt; ~/prompt.log</code></pre><blockquote><p>private yes=éšè—è¾“å…¥å†…å®¹ no=æ˜¾ç¤ºè¾“å…¥å†…å®¹</p><p>default é»˜è®¤å€¼</p><p>encrypt â€œsha512_cryptâ€ å°†å˜é‡å€¼åŠ å¯†ï¼Œä¸€èˆ¬ç”¨äºä¼ é€’å¯†ç ï¼Œæ¯”å¦‚ä¼ é€’ç»™ user æ¨¡å—çš„ password å‚æ•°</p></blockquote><h4 id="var-å‘½ä»¤è¡Œä¼ å…¥">var å‘½ä»¤è¡Œä¼ å…¥</h4><blockquote><p>ä¸€èˆ¬ç”¨äºä¸´æ—¶å¼ºåˆ¶è¦†ç›–playbookä¸­å®šä¹‰å¥½çš„å˜é‡</p><p>å…³é”®è¯ï¼š</p><ul><li>-e æˆ–è€… --extra-vars<ul><li>å‚æ•°åé¢ï¼Œå¯ä»¥è·Ÿéšå¤šä¸ªå˜é‡kvå¯¹ï¼Œæ¯ä¸€ä¸ªkvå¯¹ç”¨ç©ºæ ¼éš”å¼€</li><li>å‚æ•°åé¢ï¼Œ@filePath å¯ä»¥ä¼ å…¥å˜é‡æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­çš„å˜é‡å‡å¯ä»¥è¢«å¼•ç”¨</li></ul></li></ul></blockquote><pre><code class="language-bash">ansible-play test.play -e &quot;fatherName=Laowang&quot;</code></pre><h4 id="var-ä½œç”¨åŸŸ">var ä½œç”¨åŸŸ</h4><table><thead><tr><th>åˆ›å»ºæ–¹å¼</th><th>è°ƒç”¨ä½ç½®</th><th>ä½œç”¨åŸŸ</th></tr></thead><tbody><tr><td>vars</td><td>playå’Œtasks</td><td>å½“å‰playæˆ–è€…å½“å‰tasksï¼Œæ— æ³•è·¨ä¸»æœº</td></tr><tr><td>set_fact</td><td>tasks</td><td>è·¨playï¼Œé»˜è®¤æ— æ³•è·¨ä¸»æœº</td></tr><tr><td>register</td><td>tasks</td><td>è·¨playï¼Œé»˜è®¤æ— æ³•è·¨ä¸»æœº</td></tr></tbody></table><p>è‹¥è¦ä½¿å¾— set_fact å’Œ register è·¨ä¸»æœºä½¿ç”¨ï¼Œåˆ™éœ€è¦å¼•å…¥å†…ç½®å˜é‡ <code>hostvars</code> ä¾‹å¦‚ hostvars.&lt;ä¸»æœºå&gt;.&lt;å˜é‡å&gt;</p><blockquote><p>å…¶å®ƒå†…ç½®å˜é‡ï¼š</p><ul><li><p>ansible_version # ç‰ˆæœ¬</p></li><li><p>hostvars # å­˜å‚¨playä¸­çš„æ‰€æœ‰ä¸»æœºå˜é‡</p></li><li><p>play_hosts # å­˜å‚¨playä¸­çš„æ‰€æœ‰ä¸»æœºå</p></li><li><p>inventory_hostname  # å­˜å‚¨å½“å‰ä¸»æœºå</p></li><li><p>inventory_hostname_short  # å­˜å‚¨å½“å‰ä¸»æœºåç®€ç§°ï¼ˆå…¶å®å°±æ˜¯è·å–ä¸»æœºåç¬¬ä¸€çº§ï¼Œä¾‹å¦‚001.localhostï¼Œé‚£ä¹ˆè·å–çš„å°±æ˜¯001ï¼‰</p></li><li><p>groups # å­˜å‚¨æ‰€æœ‰åˆ†ç»„ä¿¡æ¯ï¼ŒåŒ…æ‹¬allå’Œungrouped</p></li><li><p>group_names # å­˜å‚¨å½“å‰playä¸­ä¸»æœºçš„æ‰€å±ç»„å</p></li><li><p>inventory_dir # å­˜å‚¨ä¸»æœºæ¸…å•æ–‡ä»¶æ‰€åœ¨è·¯å¾„</p></li></ul></blockquote><h4 id="var-åŠ¨æ€è·å–æ–°å˜é‡">var åŠ¨æ€è·å–æ–°å˜é‡</h4><blockquote><p>å…³é”®è¯ï¼šinclude_vars</p><p>ç”¨äºä»»åŠ¡é‡è½½å˜é‡æ–‡ä»¶ï¼Œä»è€Œè·å–ä»»åŠ¡æœŸé—´å˜é‡æ–‡ä»¶ä¿®æ”¹çš„æ•°æ®</p></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  vars_files: ~/test.yaml  tasks:    - name: get varb - max      debug:        msg: &quot;&#123;&#123; varb |  max &#125;&#125;&quot;    - name: lineinfile      lineinfile:        regexp: ^varb        line: &quot;varb: [1,2,3,4]&quot;        path: ~/test.yaml    - include_vars: ~/test.yaml    - name: get varb - max again      debug:        msg: &quot;&#123;&#123; varb |  max &#125;&#125;&quot;</code></pre><pre><code class="language-bash">#### test.yaml å˜é‡æ–‡ä»¶åˆå§‹å†…å®¹:vara: 123                                                                 varb: [1,2,3]  #### æœ€ç»ˆç»“æœï¼šç¬¬ä¸€æ¬¡ get varb ä»»åŠ¡è¾“å‡º 3, ç¬¬äºŒæ¬¡ get varb ä»»åŠ¡è¾“å‡º 4</code></pre><blockquote><p>include_vars æ¨¡å—å¸¸ç”¨å‚æ•°ï¼š</p><ul><li><p>file è¯»å–æŸä¸ªå˜é‡æ–‡ä»¶</p></li><li><p>dir è¯»å–æŸä¸ªç›®å½•çš„æ‰€æœ‰å˜é‡æ–‡ä»¶</p></li><li><p>depth é€’å½’å±‚æ·±ï¼Œä»…åœ¨ dir å¯ç”¨çš„æ—¶å€™æœ‰æ„ä¹‰</p></li><li><p>files_matching æ­£åˆ™åŒ¹é…æ–‡ä»¶åï¼Œä»…åœ¨ dir å¯ç”¨çš„æ—¶å€™æœ‰æ„ä¹‰</p></li><li><p>ignore_files å¿½ç•¥æŸä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„å…ƒç´ å¯ä»¥ä¸ºæ­£åˆ™è¡¨è¾¾å¼</p></li><li><p>name: å˜é‡ x  å°†è¯»å–çš„æ–‡ä»¶å†…å®¹é›†ä¸­å¤åˆ¶ç»™å˜é‡ xï¼Œä¾‹å¦‚ä¸Šä¾‹ä¸­å˜é‡ x ä¸º {vara: 123, varb: [1,2,3,4]}</p></li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜è¾“å‡ºä¸ªæ€§åŒ–å¼€æœºçŠ¶æ€</title>
      <link href="posts/3988a5f2/"/>
      <url>posts/3988a5f2/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰æ²¿">å‰æ²¿</h4><p>è§‰å¾—é»˜è®¤çš„ç™»é™†ä¸å¤Ÿç»™åŠ›ï¼Œæ— æ³•å¿½æ‚ æœºå™¨ï¼Œç”¨wowerçš„è¯æ¥è¯´ï¼Œå°±æ˜¯å…ˆç¥–å¿½æ‚ ç€ä½ </p><h4 id="æ•ˆæœå›¾åœ¨æ­¤">æ•ˆæœå›¾åœ¨æ­¤</h4><p><img src="/posts/3988a5f2/image-20200515110044304.png" alt="image-20200515110044304"></p><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><blockquote><p>å°†è„šæœ¬æ”¾ç½®åˆ° /etc/profile.d/status.sh</p></blockquote><pre><code class="language-bash">#!/bin/bash# Author: zyh# éœ€å…ˆå®‰è£… toilet å’Œ cowsay å‘½ä»¤# yum install epel-release -y# yum install https://rpmfind.net/linux/openmandriva/4.1/repository/x86_64/unsupported/release/toilet-0.2-3-omv4000.x86_64.rpm cowsay -yuser=$USERhome=$HOME## blue to echofunction blue()&#123;    echo -e &quot;\033[34m[Info] $1\033[0m&quot;    &#125;## green to echofunction green()&#123;    echo -e &quot;\033[32m[Success] $1\033[0m&quot;    &#125;## Errorfunction red()&#123;    echo -e &quot;\033[31m\033[01m[Error] $1\033[0m&quot;    &#125;# warningfunction yellow()&#123;    echo -e &quot;\033[33m\033[01m[Warn] $1\033[0m&quot;    &#125;## Error to warning with blinkfunction bred()&#123;    echo -e &quot;\033[31m\033[01m\033[05m[Error] $1\033[0m&quot;    &#125;# Error to warning with blinkfunction byellow()&#123;    echo -e &quot;\033[33m\033[01m\033[05m[Warn] $1\033[0m&quot;    &#125;publicip=`curl -s http://169.254.169.254/latest/meta-data/public-ipv4`localip=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4`echo -e &quot;$publicip $localip&quot; | cowsay -f tux | toilet -f term  --gay# * Check if we're somewhere in /homeif [ ! -d $&#123;home&#125; ];then    return 0fi# * Calculate last loginlastlog=`lastlog -u $&#123;user&#125; | grep $&#123;user&#125; | awk '&#123;for(i=3;i&lt;=NF;++i) printf(&quot;%s &quot;,$i)&#125;'`# * Print Outputecho &quot; ::::::::::::::::::::::::::::::::::-STATUS-::::::::::::::::::::::::::::::::::&quot;#  * Check RAM Usagesfree_mem_usages=$(awk '/MemTotal/&#123;total=$2&#125;/MemAvailable/&#123;free=$2&#125;END&#123;print free/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;' /proc/meminfo)app_mem_usages=$(awk '/MemTotal/&#123;total=$2&#125;/MemFree/&#123;free=$2&#125;/Buffers/&#123;buffers=$2&#125;/^Cached/&#123;cached=$2&#125;END&#123;print (total-free-buffers-cached)/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;'  /proc/meminfo)all_mem_usages=$(awk '/MemTotal/&#123;total=$2&#125;/MemFree/&#123;free=$2&#125;END&#123;print (total-free)/1024&quot;/&quot;total/1024&quot; MB&quot;&#125;'  /proc/meminfo)blue &quot; Free Memory : $&#123;free_mem_usages&#125;&quot;blue &quot; Application Memory Usages : $&#123;app_mem_usages&#125;&quot;blue &quot; System Memory Usages : $&#123;all_mem_usages&#125;&quot;# * Check Disk Usagesdiskusages=$(df -PH | awk '&#123;printf &quot;%-40s%-15s%-15s%-15s%-15s%-15s\n&quot;, $1,$2,$3,$4,$5,$6&#125;')blue &quot; Disk Usages :&quot;echo &quot;$&#123;diskusages&#125;&quot; | toilet -f term --metal -w 200# * Check Load Averageloadaverage=$(top -n 1 -b | grep &quot;load average:&quot; | awk '&#123;print $(NF-2) $(NF-1) $NF&#125;')blue &quot; Load Average: $loadaverage&quot;</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é—®é¢˜è®°å½•</title>
      <link href="posts/1ddb9d4e/"/>
      <url>posts/1ddb9d4e/</url>
      
        <content type="html"><![CDATA[<h3 id="Q-åŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶å‡ºç°">Q:åŒ…ç®¡ç†å™¨å®‰è£…è½¯ä»¶å‡ºç°</h3><pre><code class="language-bash">insserv:  loop involving service xxx at depth 2</code></pre><h4 id="A-åˆ é™¤-xxx-æœåŠ¡ï¼Œå¦‚æœ-xxx-æœåŠ¡å·²åˆ é™¤ï¼Œæ¸…ç†-xxx-æœåŠ¡çš„å¯åŠ¨è„šæœ¬-etc-init-d-xxx">A:åˆ é™¤ xxx æœåŠ¡ï¼Œå¦‚æœ xxx æœåŠ¡å·²åˆ é™¤ï¼Œæ¸…ç† xxx æœåŠ¡çš„å¯åŠ¨è„šæœ¬ /etc/init.d/xxx</h4><hr><h3 id="Q-crontab-å¦‚ä½•ä¿®æ”¹æ—¶åŒº">Q:crontab å¦‚ä½•ä¿®æ”¹æ—¶åŒº</h3><h4 id="A-åœ¨crontabæ–‡ä»¶æœ€ä¸Šæ–¹æ·»åŠ å‘½ä»¤ï¼Œä¾‹å¦‚èŠåŠ å“¥æ—¶åŒº">A:åœ¨crontabæ–‡ä»¶æœ€ä¸Šæ–¹æ·»åŠ å‘½ä»¤ï¼Œä¾‹å¦‚èŠåŠ å“¥æ—¶åŒº</h4><pre><code class="language-bash">TZ='America/Chicago'                                          CRON_TZ='America/Chicago'  `</code></pre><hr><h3 id="Q-su-user-c-â€œcommandâ€-å‘½ä»¤å‡ºé”™">Q:su - user -c â€œcommandâ€ å‘½ä»¤å‡ºé”™</h3><h4 id="A-éœ€è¦ç”¨æˆ·å¼€å¯ç™»é™†æƒé™ï¼Œå³-etc-passwd-ä¸­ä¸èƒ½ä½¿-sbin-nologin">A:éœ€è¦ç”¨æˆ·å¼€å¯ç™»é™†æƒé™ï¼Œå³ /etc/passwd ä¸­ä¸èƒ½ä½¿ /sbin/nologin</h4><hr><h3 id="Q-zabbix-è‡ªåŠ¨å‘ç°å¼‚å¸¸ï¼Œè¡¨é¢çœ‹ä¸å‡ºé—®é¢˜">Q:zabbix è‡ªåŠ¨å‘ç°å¼‚å¸¸ï¼Œè¡¨é¢çœ‹ä¸å‡ºé—®é¢˜</h3><h4 id="A-zabbix-agent-ç«¯å¼€å¯-debug-æ¨¡å¼ï¼Œé…ç½®åŠ å…¥å‚æ•°-DebugLevel-4">A:zabbix-agent ç«¯å¼€å¯ debug æ¨¡å¼ï¼Œé…ç½®åŠ å…¥å‚æ•° DebugLevel=4</h4><hr><h3 id="Q-adminer-æ— æ•ˆçš„CSRFä»¤ç‰Œ-Invalid-CSRF-token">Q:adminer: æ— æ•ˆçš„CSRFä»¤ç‰Œ(Invalid CSRF token)</h3><h4 id="A-nginx-worker-user-ç”¨æˆ·æ— æ³•è®¿é—®-php-session-ç›®å½•">A:nginx worker user ç”¨æˆ·æ— æ³•è®¿é—® php session ç›®å½•.</h4><pre><code class="language-bash">chgrp $&#123;nginxWorkerUser&#125; $&#123;phpSessionDir&#125;# å¦‚æœæ˜¯yumæˆ–è€…aptå®‰è£…,é‚£ä¹ˆphpçš„sessionä¸€èˆ¬æ˜¯ /var/lib/php/session</code></pre><hr><h3 id="Q-python3-No-module-named-â€˜PILâ€™">Q:python3 : No module named â€˜PILâ€™</h3><h4 id="A-pip3-install-pillow">A:pip3 install pillow</h4><hr><h3 id="Q-python-workon-å‘½ä»¤æ‰¾ä¸åˆ°">Q:python: workon å‘½ä»¤æ‰¾ä¸åˆ°</h3><h4 id="A">A:</h4><pre><code class="language-bash:">pip install virtualenvwrapperecho 'export PATH=~/.local/bin:$PATH' &gt;&gt; ~/.bashrc # æ ¹æ®æ‰€ç”¨shellæ¥å†³å®šæ–‡ä»¶è·¯å¾„</code></pre><hr><h3 id="Q-jiraé…ç½®163çš„smtpè¿æ¥è¶…æ—¶-ä½†æ˜¯æœåŠ¡å™¨ç»ˆç«¯telnetæ­£å¸¸">Q:jiraé…ç½®163çš„smtpè¿æ¥è¶…æ—¶,ä½†æ˜¯æœåŠ¡å™¨ç»ˆç«¯telnetæ­£å¸¸</h3><h4 id="A-2">A:</h4><p><img src="/posts/1ddb9d4e/image-20200917111208620.png" alt="image-20200917111208620"></p><h3 id="Q-tomcat-æ·»åŠ -pid-æ–‡ä»¶">Q: tomcat æ·»åŠ  pid æ–‡ä»¶</h3><h4 id="A-catalina-sh-æ–‡ä»¶çš„-PRGDIR-dirname-PRG-ä¸‹é¢æ·»åŠ æ–°è¡Œ-CATALINA-PID-PRGDIR-tomcat-pid-æ­¤æ—¶å°†åœ¨-bin-ç›®å½•ä¸‹åˆ›å»º-tomcat-pid">A:  <a href="http://catalina.sh">catalina.sh</a> æ–‡ä»¶çš„ <code>PRGDIR=dirname &quot;$PRG&quot;</code>ä¸‹é¢æ·»åŠ æ–°è¡Œ <code>CATALINA_PID=$PRGDIR/tomcat.pid</code> æ­¤æ—¶å°†åœ¨ bin/ ç›®å½•ä¸‹åˆ›å»º tomcat.pid</h4>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> é—®é¢˜è®°å½• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-tags</title>
      <link href="posts/960fc783/"/>
      <url>posts/960fc783/</url>
      
        <content type="html"><![CDATA[<h4 id="tagsçš„å®šä¹‰">tagsçš„å®šä¹‰</h4><blockquote><p>tags å¯ä»¥è®©ä½ åœ¨æ‰§è¡Œplaybookçš„æ—¶å€™ï¼Œæœ‰é€‰æ‹©åœ°æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œå› æ­¤ tags æ˜¯ tasks ä¸‹çš„å…³é”®è¯</p></blockquote><pre><code class="language-bash">ansible-playbook test.play &lt;--tags-args&gt;</code></pre><h4 id="tagsçš„å‚æ•°">tagsçš„å‚æ•°</h4><blockquote><ul><li>â€“tags=tag_name  æ‰§è¡Œå…·æœ‰ tag_name ä»»åŠ¡</li><li>â€“skip-tags=tag_name å¿½ç•¥å…·æœ‰ tag_name ä»»åŠ¡</li><li>â€“list-tags è¾“å‡ºæ‰€æœ‰</li></ul></blockquote><blockquote><p>tag_name å†…ç½®å€¼ ï¼š</p><ul><li>tagged æœ‰tagçš„taskï¼Œè¡¨ç¤ºæ‰§è¡Œå…·æœ‰æ ‡è®°çš„ä»»åŠ¡</li><li>untagged æ²¡æœ‰tagçš„taskï¼Œè¡¨ç¤ºæ‰§è¡Œä¸å…·æœ‰æ ‡è®°çš„ä»»åŠ¡</li><li>all æ‰€æœ‰taskï¼Œè¡¨ç¤ºæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡</li></ul></blockquote><h4 id="tagsçš„å†…ç½®æ ‡è®°">tagsçš„å†…ç½®æ ‡è®°</h4><blockquote><ul><li>always æ€»æ˜¯æ‰§è¡ŒæŸä¸ª task</li><li>never æ°¸è¿œä¸æ‰§è¡ŒæŸä¸ª task</li></ul></blockquote><h4 id="tags-çš„ä½ç½®">tags çš„ä½ç½®</h4><blockquote><p>ä½äºplayæˆ–è€…taskséƒ½å¯ä»¥ï¼Œæœ¬èº«å…·æœ‰ç»§æ‰¿å±æ€§ï¼Œä¹Ÿå°±æ˜¯tasksé‡Œçš„tagsä¼šç»§æ‰¿playçš„tags</p></blockquote><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  tags: father  tasks:    - name: test tag son      tags: son,children      shell: echo &quot;son is here!&quot; &gt; ~/son.log    - name: test tag daughter      tags: daughter,children      shell: echo &quot;daughter is here!&quot; &gt; ~/daughter.log</code></pre><pre><code class="language-bash">ansible-playbook test.play --tags=son # åªä¼šç”Ÿæˆ son.logansible-playbook test.play --tags=father  # å› ç»§æ‰¿æœºåˆ¶ï¼Œä¼šç”Ÿæˆ son.log å’Œ daughter.logansible-playbook test.play --tags=children # å› éƒ½å«æœ‰ï¼ŒåŒæ ·ä¼šç”Ÿæˆ son.log å’Œ daughter.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-é”™è¯¯æ•è·</title>
      <link href="posts/c4126d5a/"/>
      <url>posts/c4126d5a/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ç±»ä¼¼äº python ä¸­çš„ tryâ€¦exceptâ€¦finallyï¼Œansible å¯ä»¥ç”¨ blockâ€¦rescueâ€¦always</p><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - block:        - shell: mkdir /file      rescue:        - debug:            msg: &quot;No operation permission&quot;      always:        - debug:            msg: &quot;Task End!&quot;</code></pre><blockquote><p>åˆ›å»º file ç›®å½•å¤±è´¥ï¼Œåˆ™è¾“å‡º&quot;No operation permission&quot;, æœ€ç»ˆæ€»æ˜¯è¾“å‡ºâ€œTask End!â€</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-æ¡ä»¶åˆ¤æ–­</title>
      <link href="posts/29683589/"/>
      <url>posts/29683589/</url>
      
        <content type="html"><![CDATA[<h4 id="å…³é”®è¯">å…³é”®è¯</h4><ul><li>when</li></ul><h4 id="è¿ç®—ç¬¦">è¿ç®—ç¬¦</h4><ul><li>==  !=  &gt;  &lt;  &gt;=  &lt;=</li><li>and or not</li><li>( ) ç»„åˆï¼Œä¾‹å¦‚ ( a and b ) or c</li></ul><blockquote><p>ansible æŸä¸ª task æŠ¥é”™ï¼Œä¼šå¯¼è‡´ä»»åŠ¡ç»ˆæ­¢ï¼Œè€Œignore_errors: true å¯ä»¥å¿½ç•¥æŸä¸ªä»»åŠ¡çš„æ¡ä»¶ä¸æ»¡è¶³</p></blockquote><h4 id="is-è¯­å¥-æˆ–è€…-is-not-è¯­å¥">is è¯­å¥ æˆ–è€… is not è¯­å¥</h4><pre><code class="language-yaml">tasks:  - name: show is xxx    debug:      msg: &quot;xxx is ok&quot;    when: var is xxx</code></pre><blockquote><p>åˆ¤æ–­æ–‡ä»¶</p><ul><li>xxx æ˜¯ exists ï¼Œè¡¨ç¤ºè‹¥ var å­˜åœ¨ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ file, è¡¨ç¤ºè‹¥ var æ˜¯æ–‡ä»¶ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ directoryï¼Œ è¡¨ç¤ºè‹¥ var æ˜¯ç›®å½•ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ linkï¼Œè¡¨ç¤ºè‹¥ var æ˜¯è½¯è¿æ¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>xxx æ˜¯ mountï¼Œè¡¨ç¤ºè‹¥ var æ˜¯æŒ‚è½½ç‚¹ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­å˜é‡</p><ul><li>è‹¥ xxx æ˜¯ defined, è¡¨ç¤ºè‹¥ var å·²å®šä¹‰ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ undefinedï¼Œ è¡¨ç¤ºè‹¥ var æœªå®šä¹‰ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ noneï¼Œ è¡¨ç¤ºè‹¥ var æ˜¯ç©ºï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­ä»»åŠ¡çŠ¶æ€</p><ul><li>è‹¥ xxx æ˜¯ successï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€æˆåŠŸï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ failureï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ changeï¼Œè‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡çŠ¶æ€æ”¹å˜ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ skipï¼Œ è‹¥ var ä¸ºæŸä»»åŠ¡è¿”å›ç»“æœï¼Œåˆ™ä»»åŠ¡è¢«å¿½ç•¥ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote><blockquote><p>åˆ¤æ–­å­—ç¬¦ä¸²</p><ul><li><p>è‹¥ xxx æ˜¯ stringï¼Œè‹¥ var æ˜¯å­—ç¬¦ä¸²ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ lowerï¼Œè‹¥ var æ˜¯çº¯å°å†™ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ upperï¼Œè‹¥ var æ˜¯çº¯å¤§å†™ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li></ul></blockquote><blockquote><p>åˆ¤æ–­æ•°å­—</p><ul><li><p>è‹¥ xxx æ˜¯ numberï¼Œ è‹¥ var æ˜¯æ•°å­—ï¼Œæ¡ä»¶ä¸ºçœŸã€‚ var: â€œ123â€ ,è¿™é‡Œ var æ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯æ•°å­—</p></li><li><p>è‹¥ xxx æ˜¯ evenï¼Œè‹¥ var æ˜¯å¶æ•°ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ oddï¼Œ è‹¥ var æ˜¯å¥‡æ•°ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li><li><p>è‹¥ xxx æ˜¯ divisibleby(num), è‹¥ var å¯ä»¥è¢« num æ•´é™¤ï¼Œæ¡ä»¶ä¸ºçœŸ</p></li></ul></blockquote><blockquote><p>åˆ¤æ–­é›†åˆ</p><ul><li>è‹¥ xxx æ˜¯ subset(list)ï¼Œè‹¥ var æ˜¯ list çš„å­é›†ï¼Œæ¡ä»¶ä¸ºçœŸ</li><li>è‹¥ xxx æ˜¯ superset(list), è‹¥ var æ˜¯ list çš„çˆ¶é›†ï¼Œæ¡ä»¶ä¸ºçœŸ</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-å¾ªç¯</title>
      <link href="posts/14bc184e/"/>
      <url>posts/14bc184e/</url>
      
        <content type="html"><![CDATA[<h4 id="å¸¸è§çš„å¾ªç¯">å¸¸è§çš„å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show debug info      debug:        msg: &quot;&#123;&#123; item &#125;&#125;&quot;      with_items:        - [ a,b ]        - [ A,B, [ D,E,F ]]</code></pre><blockquote><ul><li><p>with_list è¾“å‡ºæœ€è¡¨å±‚å…ƒç´ ï¼Œåœ¨ç®€ä¾‹ä¸­ï¼Œä¼šè¾“å‡º [ a,b ] å’Œ [ A,B, [ D,E,F ] ]</p></li><li><p>with_item é€’å½’è¾“å‡ºæ‰€æœ‰å±‚å…ƒç´ </p></li><li><p>with_together åˆå¹¶ä¸¤ä¸ªåˆ—è¡¨ï¼Œå…ƒç´ æŒ‰ç…§å¯¹åº”ä¸‹æ ‡ç»“åˆï¼Œå¦‚æœæŸä¸€æ–¹åˆ—è¡¨å…ƒç´ ç¼ºå¤±ï¼Œåˆ™ç”¨nullä»£æ›¿</p></li><li><p>with_indexed_items æœ€è¡¨å±‚æ‰€æœ‰åˆ—è¡¨åˆå¹¶ä¸ºä¸€ä¸ªæ–°åˆ—è¡¨å¹¶å¾ªç¯ã€‚itemç”±{ list.index: list.value } æ„æˆã€‚åœ¨ç®€ä¾‹ä¸­ï¼Œæ–°åˆ—è¡¨æ˜¯[ a,b,A,B, [ D,E,F ]]</p><pre><code class="language-yaml"></code></pre></li></ul><p>msg: â€œIndex:&#123;&#123; item.0 &#125;&#125;, Value:&#123;&#123; item.1 &#125;&#125;â€</p><pre><code>```bashok: [localhost] =&gt; (item=[0, u'a']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:0, Vaule:a&quot;&#125;ok: [localhost] =&gt; (item=[1, u'b']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:1, Vaule:b&quot;&#125;ok: [localhost] =&gt; (item=[2, u'A']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:2, Vaule:A&quot;&#125;ok: [localhost] =&gt; (item=[3, u'B']) =&gt; &#123;    &quot;msg&quot;: &quot;Index:3, Vaule:B&quot;&#125;ok: [localhost] =&gt; (item=[4, [u'D', u'E', u'F']]) =&gt; &#123;    &quot;msg&quot;: &quot;Index:4, Vaule:[u'D', u'E', u'F']&quot;&#125;</code></pre><ul><li>with_random_choice éšæœºè¾“å‡ºä¸€ä¸ªæœ€è¡¨å±‚åˆ—è¡¨å…ƒç´ ï¼Œç®€ä¾‹ä¸­è¾“å‡º [a,b] æˆ–è€… [ A,B, [ D,E,F ]]</li></ul></blockquote><h4 id="dict-å­—å…¸å¾ªç¯">dict å­—å…¸å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show debug info      debug:        msg: &quot;Name:&#123;&#123; item.key &#125;&#125;, gender:&#123;&#123; item.value &#125;&#125;&quot;      with_dict:        Zhangsan: male        Lisi: female</code></pre><blockquote><p>è¾“å‡ºæ‰€æœ‰å­—å…¸</p></blockquote><h4 id="sequence-åºåˆ—å¾ªç¯">sequence åºåˆ—å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show sequence info      debug:        msg: &quot;&#123;&#123; item &#125;&#125;&quot;      with_sequence:        start=1        end=5        stride=2        format=&quot;I'm %0.4f&quot;</code></pre><blockquote><ul><li>with_sequence è·å–å¥‡å¶æ•°ï¼Œstartå’Œendæ˜¯èµ·æ­¢ç‚¹ï¼Œstride æ˜¯æ­¥é•¿ï¼ˆæ­¥é•¿å¯ä»¥ä¸ºè´Ÿå€¼ï¼‰ï¼Œformatæ˜¯æ ¼å¼åŒ–</li></ul></blockquote><h4 id="nested-åµŒå¥—å¾ªç¯">nested åµŒå¥—å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  remote_user: zyh  gather_facts: no  tasks:    - name: show nested info      debug:        msg: &quot;mkdir /mnt/&#123;&#123; item.0 &#125;&#125;/&#123;&#123; item.1 &#125;&#125;&quot;      with_nested:        - [ a,b ]        - [ A,B,C ]</code></pre><blockquote><p>ä¸¤ä¸ªåˆ—è¡¨åšç¬›å¡å°”ç§¯, ä¾‹å¦‚æ„å»ºç¯å¢ƒç›®å½•</p></blockquote><h4 id="subelements-å­å…ƒç´ å¾ªç¯">subelements å­å…ƒç´ å¾ªç¯</h4><ul><li>ç®€ä¾‹</li></ul><pre><code class="language-yaml">---- hosts: localhost  gather_facts: no  connection: local  vars:          users:                  - name: Bob                    gender: male                    age: 18                    content:                            - eating                            - sleeping                            - play ogre                  - name: Maris                    gender: female                    age: 20                    content:                            - eating                            - sleeping                            - shopping  tasks:          - name: test vars 2            debug:                    msg: &quot;&#123;&#123; item.0.name &#125;&#125; - &#123;&#123; item.0.gender &#125;&#125; - &#123;&#123; item.1 &#125;&#125;&quot;            with_subelements:              - &quot;&#123;&#123; users &#125;&#125;&quot;              - content</code></pre><blockquote><p>åˆ†è§£ , é€‰ä¸­åˆ—è¡¨å†…æŸä¸€ä¸ªåˆ—è¡¨å…ƒç´  content, ä¸ä½œä¸ºä¸€ä¸ªä¸´æ—¶æ•´ä½“çš„å‰©ä½™å…ƒç´ æ„å»ºç¬›å¡å°”ç§¯ï¼Œå½¢æˆ item</p></blockquote><h4 id="file-æ–‡ä»¶å¾ªç¯">file æ–‡ä»¶å¾ªç¯</h4><pre><code class="language-yaml">with_file:  /mnt/a.ini  /mnt/b.ini</code></pre><blockquote><p>å§‹ç»ˆå¾ªç¯è·å–ansibleä¸»æœºé‡Œæ–‡ä»¶çš„å†…å®¹ã€‚ï¼ˆä¸ç›®æ ‡ä¸»æœºæ— å…³ï¼‰</p></blockquote><h4 id="fileglob-å¯»æ‰¾é€šé…ç¬¦åŒ¹é…çš„æ–‡ä»¶">fileglob å¯»æ‰¾é€šé…ç¬¦åŒ¹é…çš„æ–‡ä»¶</h4><pre><code class="language-yaml">with_fileglob:  - /home/zyh/test/dirA/*  - /home/zyh/test/dirB/[0-9].ini</code></pre><blockquote><p>å§‹ç»ˆå¾ªç¯è·å–ansibleä¸»æœºæŒ‡å®šç›®å½•ä¸­åŒ¹é…çš„æ–‡ä»¶åå’Œè·¯å¾„ã€‚ï¼ˆä¸ç›®æ ‡ä¸»æœºæ— å…³ï¼‰</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-ç³»ç»Ÿç›¸å…³</title>
      <link href="posts/84eb900/"/>
      <url>posts/84eb900/</url>
      
        <content type="html"><![CDATA[<h4 id="cron">cron</h4><blockquote><p>crontab è®¡åˆ’ä»»åŠ¡</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>name è®¡åˆ’ä»»åŠ¡æ³¨é‡Šï¼Œå¤šæ¬¡æ“ä½œåŒåä»»åŠ¡ï¼Œåªä¼šä¿®æ”¹ï¼Œè€Œä¸ä¼šæ–°åŠ </p><p>æ—¶é—´å‚æ•°ï¼š</p><ul><li><p>minute hour day month weekday</p></li><li><p>special_time : @reboot @yearly @monthly @weekly @daily @hourly (æ¯xxxæ‰§è¡Œ)</p></li></ul><p>user æ·»åŠ åˆ°æŒ‡å®šç”¨æˆ·è®¡åˆ’ä»»åŠ¡ä¸­</p><p>job è®¡åˆ’ä»»åŠ¡æ‰§è¡Œå‘½ä»¤</p><p>state å½“å€¼ä¸ºabsentæ—¶ï¼ŒæŒ‡åˆ é™¤ä»»åŠ¡. åªéœ€æŒ‡å®š name.</p><p>disabled æ³¨é‡Šä»»åŠ¡ï¼Œè‹¥ä»»åŠ¡ä¿¡æ¯å’Œä¹‹å‰ä¸ä¸€è‡´ï¼Œä¼šåŒæ—¶ä¿®æ”¹ä»»åŠ¡</p><p>backup å…ˆå¤‡ä»½å†æ“ä½œ, å¤‡ä»½æ–‡ä»¶ä½äº /tmp/crontabxxxx</p></blockquote><pre><code class="language-bash">ansible localhost -m cron -a &quot;name='test cron module' user=zyh special_time=hourly job='ls /home/zyh &gt; /home/zyh/cron.log 2&gt;&amp;1'&quot;ansible localhost -m cron -a &quot;name='test cron module' state=absent&quot;</code></pre><h4 id="service">service</h4><blockquote><p>è°ƒç”¨è¿œç¨‹ç³»ç»Ÿè‡ªèº«çš„æœåŠ¡ç®¡ç†æ¨¡å—ï¼Œä¾‹å¦‚ centos6 çš„ service ï¼Œæˆ–è€… centos7 çš„ systemctl</p><p>å‚æ•°ä»‹ç»:</p><p>name æœåŠ¡å</p><p>state æ‰§è¡ŒåŠ¨ä½œ started, stopped, restarted, reloaded</p><p>enabled å¼€æœºè‡ªå¯åŠ¨</p></blockquote><h4 id="user">user</h4><blockquote><p>ç”¨æˆ·ç®¡ç†</p><p>å¸¸ç”¨å‚æ•°ä»‹ç»ï¼š</p><p>name ç”¨æˆ·å</p><p>group ç”¨æˆ·ç»„ groups ç”¨æˆ·é™„åŠ ç»„</p><ul><li>append é¢å¤–é™„åŠ ç”¨æˆ·é™„åŠ ç»„</li></ul><p>shell æŒ‡å®šé»˜è®¤shellï¼Œæ¯”å¦‚/usr/sbin/nologin</p><p>state å€¼ä¸º absent è¡¨ç¤ºåˆ é™¤ç”¨æˆ·ï¼Œå€¼ä¸º present è¡¨ç¤ºç”¨æˆ·å¿…é¡»å­˜åœ¨</p><ul><li>remove åˆ é™¤ç”¨æˆ·æ—¶ï¼ŒåŒæ—¶åˆ é™¤ç”¨æˆ·å®¶ç›®å½•</li></ul><p>password ç”¨æˆ·å¯†ç ã€‚ï¼ˆéœ€è¦ä¼ é€’åŠ å¯†å¯†ç ï¼Œä¸èƒ½æ˜¯æ˜æ–‡å¯†ç ï¼‰</p><pre><code class="language-python">import crypt:passwd=print(crypt.crypt(passwd))</code></pre><p>generate_ssh_key ç›¸å½“äºè¿œç¨‹æ‰§è¡Œ ssh-keygen å‘½ä»¤ï¼ˆä¸åŠ ä»»ä½•å‚æ•°ï¼Œä¸€è·¯å›è½¦ï¼‰ã€‚è‹¥å·²ç»å­˜åœ¨~/.ssh/{id_rsa, id_rsa.pub}, åˆ™ä¸æ‰§è¡Œ</p><ul><li>ssh_key_file è‡ªå®šä¹‰ç§é’¥åå’Œç§é’¥å­˜æ”¾è·¯å¾„, å…¬é’¥ä¹Ÿä¼šåœ¨è‡ªå®šä¹‰è·¯å¾„ä¸‹ç”Ÿæˆ</li></ul></blockquote><h4 id="group">group</h4><blockquote><p>ç®¡ç†ç”¨æˆ·ç»„</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>name ç»„å</p><p>state ç»„çŠ¶æ€, å€¼ä¸º absent æŒ‡åˆ é™¤(ç»„æœ¬èº«å¹¶éç”¨æˆ·ä¸»è¦ç»„)</p></blockquote><h4 id="setup">setup</h4><blockquote><p>è·å–æœºå™¨ä¿¡æ¯</p><p>å‚æ•°ä»‹ç»ï¼š</p><p>gather_subset è·å–æŸä¸ªå­é›†ï¼ˆall, min, hardware, network, virtual, ohai, facterï¼‰</p><p>filter è·å–æŸä¸ªé›†åˆçš„æŸä¸ªkey</p><p>fact_path è‡ªå®šä¹‰ä¿¡æ¯å­˜æ”¾ç›®å½•</p></blockquote><pre><code class="language-ini"># setup é»˜è®¤ä¼šæœç´¢ç›®æ ‡ä¸»æœº/etc/ansible/facts.d ä¸‹çš„è‡ªå®šä¹‰ä¿¡æ¯,ä¾‹å¦‚ family.ini[family]father=Zhangsanson=Zhangxiaosan</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-handle</title>
      <link href="posts/b0929188/"/>
      <url>posts/b0929188/</url>
      
        <content type="html"><![CDATA[<h4 id="åŠŸèƒ½">åŠŸèƒ½</h4><p>ç”¨ä¸€ä¸ªçŸ­è·¯åˆ¤æ–­æ¥è¯´ï¼Œå°±æ˜¯ä¸¤è€…æ˜¯ä¸²è”å…³ç³»ï¼Œhandlers ç”¨æ¥å¤„ç†ä»»åŠ¡åç»­</p><p>tasks &amp;&amp; handlers</p><p>tasks &amp;&amp; handlers - listen ï¼ˆhandlers ç»„ï¼‰</p><h4 id="handlers-çš„-playbook-æ ·æœ¬">handlers çš„ playbook æ ·æœ¬</h4><pre><code class="language-yaml">---- hosts: localhost  become: true  remote_user: root  tasks:  - name: check nginx    shell: /usr/sbin/nginx -t    notify:      log        - meta: flush_handlers     handlers:  - name: log    shell: echo &quot;nginx check success&quot; &gt; ~/playbook.log</code></pre><blockquote><p>å¤šä¸ªtasksçš„æ—¶å€™ï¼Œtasksåé¢çš„ <code>meta: flush_handlers</code> å¯ä»¥è®©tasksæ‰§è¡Œå®Œï¼Œç«‹é©¬æ‰§è¡Œå…³è”çš„handlersã€‚å¦åˆ™handlersä¼šåœ¨æ‰€æœ‰tasksæ‰§è¡Œå®Œåï¼Œæ‰å¼€å§‹æ‰§è¡Œ</p></blockquote><h4 id="handlers-listen-çš„-playbook-æ ·æœ¬">handlers-listen çš„ playbook æ ·æœ¬</h4><pre><code class="language-yaml">---- hosts: localhost  become: true  remote_user: root  tasks:  - name: check nginx    shell: /usr/sbin/nginx -t    notify:      log group    handlers:  - name: log1    listen: log group    shell: echo &quot;nginx check success 1&quot; &gt; ~/playbook.log  - name: log2    listen: log group    shell: echo &quot;nginx check success 2&quot; &gt;&gt; ~/playbook.log</code></pre><blockquote><p>handlers é€šè¿‡ listen ç»‘å®šåœ¨ä¸€èµ·ï¼Œ tasks å…³è” liasten ç»‘å®š handlers ç»„ï¼Œæœ€ç»ˆ playbook.log å°†ä¼šå†™å…¥ä¸¤è¡Œä¿¡æ¯</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> handle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜å¤‡ä»½</title>
      <link href="posts/2c2d50a0/"/>
      <url>posts/2c2d50a0/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>æœ¬æ–‡ä¸»è¦è®°å½• redis çš„ä¸¤ç§æ•°æ®ç£ç›˜å›ºåŒ–æ–¹å¼ã€‚<br>æ¶‰åŠåˆ°ç›¸å…³å‚æ•°ï¼Œç®€å•çš„å‘½ä»¤æ“ä½œç­‰ã€‚</p><h4 id="rdb">rdb</h4><blockquote><p>é€šè¿‡forkä¸€ä¸ªå­è¿›ç¨‹æ¥å­˜å‚¨æŸä¸€æ—¶åˆ»redisæ•°æ®(bgsaveæ–¹å¼)ã€‚rdbæŒä¹…åŒ–æ˜¯é»˜è®¤æ–¹å¼ã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><p>å°å¹…åº¦ä¸¢å¤±æ•°æ®(å–å†³äºsaveæˆ–è€…bgsaveå‘½ä»¤çš„æ‰§è¡Œå‘¨æœŸ)ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è¯´saveï¼Œåº”è¯¥ä¸ä¼šç”¨åˆ°è¿™ä¸ª</p></li><li><p>æ¢å¤é€Ÿåº¦å¿«</p></li></ul></blockquote><pre><code class="language-bash"># å‹ç¼©rdbæ–‡ä»¶rdbcompression yes# rdb æ–‡ä»¶åç§°dbfilename redis-6379.rdb# rdbæ–‡ä»¶ä¿å­˜ç›®å½•dir /redis/data/</code></pre><ul><li>æ•°æ®è‡ªåŠ¨å†™å…¥ç­–ç•¥ (æ»¡è¶³ä¸‹åˆ—è§„åˆ™ï¼Œå°±æ‰§è¡Œbgsave)</li></ul><pre><code class="language-bash"># 900så†…è‡³å°‘è¾¾åˆ°ä¸€æ¡å†™å‘½ä»¤save 900 1# 300så†…è‡³å°‘è¾¾è‡³10æ¡å†™å‘½ä»¤save 300 10# 60så†…è‡³å°‘è¾¾åˆ°10000æ¡å†™å‘½ä»¤save 60 10000</code></pre><ul><li>æ•°æ®äººå·¥å†™å…¥ç­–ç•¥ (æ¯10åˆ†é’Ÿè®¡åˆ’ä»»åŠ¡è°ƒç”¨ä¸€æ¬¡bgsave)</li></ul><pre><code class="language-bash">*/10 * * * * root /export/redis/bin/redis-cli -h 127.0.0.1 bgsave &gt;&gt; /export/redis/bgsave.log 2&gt;&amp;1  </code></pre><blockquote><p>bgsave å› éœ€è¦forkå­è¿›ç¨‹ï¼Œæ‰€ä»¥éœ€è¦é¢å¤–é¢„ç•™ç©ºé—²çš„ç‰©ç†å†…å­˜ï¼Œåœ¨overcommit_memory=1å¼€å¯çš„æƒ…å†µä¸‹ï¼Œé¢„ç•™å†…å­˜å¤§å° &gt; å‘¨æœŸå˜åŒ–æ•°æ®å¤§å°</p></blockquote><h4 id="aof">aof</h4><blockquote><p>è®°å½•çš„æ˜¯redisæ¯ä¸€æ¬¡çš„å†™å…¥æ“ä½œè®°å½•</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>æ¢å¤é€Ÿåº¦æ…¢</li><li>ä¸¢å¤±æ•°æ®å°</li></ul></blockquote><pre><code class="language-bash"># å¼€å¯aofæœºåˆ¶appendonly yes# aofæ–‡ä»¶åappendfilename &quot;appendonly.aof&quot;# å†™å…¥ç­–ç•¥,alwaysè¡¨ç¤ºæ¯ä¸ªå†™æ“ä½œéƒ½ä¿å­˜åˆ°aofæ–‡ä»¶ä¸­,ä¹Ÿå¯ä»¥æ˜¯everysecæˆ–noã€‚ everysec æ¯ç§’ä¸€æ¬¡appendfsync everysec# é»˜è®¤ä¸é‡å†™aofæ–‡ä»¶,æ„æ€å°±æ˜¯æ¯æ¬¡ appendfsync å°±å‹ç¼©æ•´åˆaofæ–‡ä»¶ï¼Œé¿å…aofè¿‡å¤§ï¼Œä¸æ¨èå¼€å¯ï¼Œå½±å“æ€§èƒ½no-appendfsync-on-rewrite no# ä¿å­˜ç›®å½•dir /redis/data/</code></pre><ul><li>äººå·¥è®¡åˆ’ä»»åŠ¡é‡å†™</li></ul><pre><code class="language-bash">*/10 * * * * root /export/redis/bin/redis-cli -h 127.0.0.1 bgrewriteaof &gt;&gt; /export/redis/bgrewriteaof.log 2&gt;&amp;1</code></pre><ul><li>aof å› æœåŠ¡å™¨æŒ‚æ‰æŸåå¯ä»¥ä¿®å¤</li></ul><pre><code class="language-bash">redis-check-aof -fix file.aof</code></pre><h4 id="ç»“è®º">ç»“è®º</h4><p>rdb æˆ–è€… aof æ ¹æ®ä¸šåŠ¡äºŒé€‰ä¸€å³å¯ï¼Œæ²¡å¿…è¦éƒ½å¼€å¯ï¼Œä½†æ˜¯ä¸ç®¡æ˜¯å“ªä¸€ç§ï¼Œéƒ½å¯ä»¥åœ¨äººå·¥è®¡åˆ’ä»»åŠ¡ä¹‹åï¼Œå¤åˆ»ä¸€ä»½å¤‡ä»½æ–‡ä»¶åˆ°äº‘ç«¯å¯¹è±¡å­˜å‚¨ä¸­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> å¤‡ä»½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-è½¯ä»¶åŒ…ç®¡ç†</title>
      <link href="posts/3d9b9ec1/"/>
      <url>posts/3d9b9ec1/</url>
      
        <content type="html"><![CDATA[<h4 id="apt-repository">apt_repository</h4><blockquote><p>ubuntu ä¸‹ï¼š</p><p>repo æŒ‡å®šåº“åœ°å€ï¼Œä¾‹å¦‚ nginx åœ°å€ ppa:nginx/stable</p><p>state å€¼ä¸º absent æ—¶ä¸ºåˆ é™¤</p></blockquote><pre><code class="language-bash">ansible localhost -m apt_repository -a &quot;repo=ppa:nginx/stable&quot; -b --ask-become-pass</code></pre><pre><code class="language-bash">localhost | CHANGED =&gt; &#123;    &quot;changed&quot;: true,     &quot;repo&quot;: &quot;ppa:nginx/stable&quot;,     &quot;state&quot;: &quot;present&quot;&#125;#( 04/24/20@ 3:10PM )( zyh@zyh ):~   cat  /etc/apt/sources.list.d/ppa_nginx_stable_bionic.listdeb http://ppa.launchpad.net/nginx/stable/ubuntu bionic main</code></pre><h4 id="apt">apt</h4><blockquote><p>å¸¸ç”¨å‚æ•°ï¼š</p><p>name åŒ…å</p><p>state åŒ…çŠ¶æ€ ï¼ˆabsent-åˆ é™¤ï¼Œlatest-æœ€æ–°åŒ…,  present-é»˜è®¤å®‰è£…ï¼‰ latest ç›¸å½“äºå‡çº§åŒ…</p><p>upgrade å‡çº§ ï¼ˆyesï¼Œdistï¼Œfullï¼Œno-é»˜è®¤ï¼‰</p><p><a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html#apt-module">https://docs.ansible.com/ansible/latest/modules/apt_module.html#apt-module</a></p></blockquote><pre><code class="language-bash">ansible localhost -m apt -a &quot;name=nginx state=present&quot; -b --ask-become-pass</code></pre><pre><code class="language-bash">localhost | CHANGED =&gt; &#123;    &quot;cache_update_time&quot;: 1587713114,     &quot;cache_updated&quot;: false,     &quot;changed&quot;: true,     &quot;stderr&quot;: &quot;&quot;,     &quot;stderr_lines&quot;: [],     &quot;stdout&quot;: &quot;Reading package lists...\nBuilding dependency tree.......</code></pre><h4 id="yum-repository">yum_repository</h4><blockquote><p>name ä»“åº“å</p><p>baseurl ä»“åº“åœ°å€</p><p>enabled ï¼ˆyes-é»˜è®¤ï¼Œno)</p><p>gpgcheck (yes, no)</p><p>gpgcakey æŒ‡å®š gpg ca å…¬é’¥</p><p>state (present-é»˜è®¤ï¼Œabsent-åˆ é™¤)</p></blockquote><pre><code class="language-bash">ansible localhost -m yum_repository -a &quot;name=epel baseurl=https://download.fedoraproject.org/pub/epel/$releasever/$basearch/&quot;</code></pre><h4 id="yum">yum</h4><blockquote><p>name åŒ…å</p><p>state (absent-åˆ é™¤ï¼Œpresent-å®‰è£…-é»˜è®¤å€¼ï¼Œlatest-æ›´æ–°)</p><p>disable_gpg_check å…³é—­gpgæ£€æŸ¥ï¼ˆç”¨äºæºgpgæ£€æŸ¥æ²¡æœ‰çš„æƒ…å†µï¼‰</p><p>enablerepo å®‰è£…åŒ…çš„æ—¶å€™ï¼Œå…ˆä¸´æ—¶å¯ç”¨æŸä¸ªæº</p><p>disablerepo å®‰è£…åŒ…çš„æ—¶å€™ï¼Œå…ˆä¸´æ—¶ç¦ç”¨æŸä¸ªæº</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-å‘½ä»¤è°ƒç”¨</title>
      <link href="posts/1e274151/"/>
      <url>posts/1e274151/</url>
      
        <content type="html"><![CDATA[<h4 id="shell">shell</h4><blockquote><p>è¿œç¨‹æ‰§è¡Œä¸€ä¸ªå‘½ä»¤</p><p>éƒ¨åˆ†å‚æ•°è§£æï¼š</p><p>chdir è¿œç¨‹å·¥ä½œç›®å½•</p><p>executable è¿œç¨‹æ‰§è¡Œshellï¼Œéœ€è¦ç»å¯¹è·¯å¾„</p></blockquote><pre><code class="language-bash">ansible localhost -m shell -a &quot;chdir=/ ls&quot;</code></pre><pre><code class="language-bash">localhost | CHANGED | rc=0 &gt;&gt;binbootdevetchome...</code></pre><h4 id="script">script</h4><blockquote><p>è¿œç¨‹æ‰§è¡Œä¸€ä¸ªansibleä¸»æœºç¯å¢ƒçš„è„šæœ¬</p><p>éƒ¨åˆ†å‚æ•°è§£æï¼š</p><p>chdir è¿œç¨‹å·¥ä½œç›®å½•</p></blockquote><pre><code class="language-bash">cat test.sh#!/bin/bashfor i in `ls /export`;do        echo $idone#-------------ansible -i hosts test -m script -a &quot;/home/zyh/test.sh&quot;</code></pre><pre><code class="language-bash">10.200.10.212 | CHANGED =&gt; &#123;    &quot;changed&quot;: true,     &quot;rc&quot;: 0,     &quot;stderr&quot;: &quot;Shared connection to 10.200.10.212 closed.\r\n&quot;,     &quot;stderr_lines&quot;: [        &quot;Shared connection to 10.200.10.212 closed.&quot;    ],     &quot;stdout&quot;: &quot;jdk1.8.0_191\r\njdk8\r\nsen\r\n&quot;,     &quot;stdout_lines&quot;: [        &quot;jdk1.8.0_191&quot;,         &quot;jdk8&quot;,         &quot;sen&quot;    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜å¸¸ç”¨æ¨¡å—-æ–‡æœ¬æ–‡ä»¶æ“ä½œ</title>
      <link href="posts/4235ddf4/"/>
      <url>posts/4235ddf4/</url>
      
        <content type="html"><![CDATA[<h2 id="æ–‡æœ¬æ“ä½œ">æ–‡æœ¬æ“ä½œ</h2><h4 id="file">file</h4><blockquote><p>path æ–‡ä»¶å¯¹è±¡åœ°å€<br>state æ–‡ä»¶ç±»å‹æˆ–è€…åŠ¨ä½œçŠ¶æ€ ï¼ˆtouch: é’ˆå¯¹æ–‡ä»¶, directoryï¼šé’ˆå¯¹ç›®å½•, linkï¼šé’ˆå¯¹è½¯è¿æ¥, hardï¼šé’ˆå¯¹ç¡¬é“¾æ¥)</p><p>src è½¯ç¡¬é“¾æ¥çš„æºæ–‡ä»¶</p><p>owner å±ä¸»</p><p>group å±ç»„</p><p>mode æ•°å­—æƒé™</p><p>recurse é€’å½’æ“ä½œ</p></blockquote><h4 id="blockinfile">blockinfile</h4><blockquote><p>åœ¨æŒ‡å®šä½ç½®ï¼Œæ’å…¥æ–‡æœ¬å—ï¼Œå¹¶åœ¨æ–‡æœ¬å—å¼€å¤´å’Œç»“å°¾æ·»åŠ æ ‡è®°. æ ‡è®°ç”¨æ¥ç¡®è®¤æ–‡æœ¬å—çš„ä½ç½®ï¼Œä¸€äº›å‚æ•°ä¼šé€šè¿‡æ ‡è®°ä½ç½®æ¥ä¿®æ”¹æ–‡æœ¬å—ã€‚</p><p>æ³¨é‡Šæ ¼å¼:</p><p># BEGIN xxx</p><p># END xxx</p><p>å‚æ•°ç®€ä»‹ï¼š</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€</p><p>block éœ€è¦æ·»åŠ çš„æ–‡æœ¬å—</p><p>marker è‡ªå®šä¹‰æ ‡è®° xxx éƒ¨åˆ†ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒæ ‡è®°ï¼Œåˆ™ä¼˜å…ˆå¤„ç†ç›¸åŒæ ‡è®°çš„æ–‡æœ¬å—ã€‚</p><p>state çŠ¶æ€ä¸ºabsentæ—¶ï¼Œåˆ é™¤æ ‡è®°åŒ…æ‹¬çš„æ–‡æœ¬å—</p><p>insertafter æ­£åˆ™æˆ–è€…EOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å</p><p>insertbefore æ­£åˆ™æˆ–è€…BOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å‰</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œï¼Œå¤‡ä»½æ–‡ä»¶åç¼€æ˜¯æ—¶é—´æˆ³</p><p>create æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</p></blockquote><pre><code class="language-bash"># è¿™æ¡å‘½ä»¤ä¸­ï¼Œå¦‚æœmarkeræ ‡è®°å·²ç»å­˜åœ¨ï¼Œåˆ™insertafterå°†æ— æ•ˆ-m blockinfile -a 'path= block=&quot; &quot; marker=&quot;#&#123;mark&#125; xxx&quot; insertafter=&quot;æ­£åˆ™&quot;'</code></pre><h4 id="lineinfile">lineinfile</h4><blockquote><p>æ ¹æ®æŒ‡å®šçš„å†…å®¹ï¼Œè¿›è¡Œæ›¿æ¢æˆ–åˆ é™¤</p><p>å‚æ•°ç®€ä»‹ï¼š</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€ã€‚</p><p>line æŒ‡å®šè¡Œå†…å®¹ï¼ˆåœ¨æ²¡æœ‰æ­£åˆ™çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å…¨åŒ¹é…ï¼‰ã€‚</p><p>regexp é€šè¿‡æ­£åˆ™åŒ¹é…è¡Œï¼Œå¹¶å°†æ­¤è¡Œæ›¿æ¢æˆ line æŒ‡å®šçš„å†…å®¹ï¼Œregexpæœ‰é¢å¤–æ‰©å±•å‚æ•°ï¼Œä¾‹å¦‚ backrefã€‚</p><ul><li><p>line  è‹¥lineåŒ¹é…åˆ°æŸè¡Œï¼Œåˆ™ä¸ä¿®æ”¹ï¼Œè‹¥æ— åŒ¹é…ï¼Œåˆ™æ·»åŠ lineè‡³æœ«å°¾ã€‚</p></li><li><p>regexp + line  è‹¥æœ‰regexpåŒ¹é…åˆ°æŸè¡Œï¼Œæ›¿æ¢åŒ¹é…è¡Œä¸ºlineï¼›å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™å°†lineè¿½åŠ åˆ°è¡Œå°¾ã€‚æ­¤æ—¶ï¼Œregexpä¸æ”¯æŒåˆ†ç»„ã€‚</p></li><li><p>regexp + backrefs ï¼ˆtrueï¼‰+ line  è‹¥æœ‰regexpåŒ¹é…åˆ°æŸè¡Œï¼Œæ›¿æ¢åŒ¹é…è¡Œä¸ºlineï¼›å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™ä¿æŒæºæ–‡ä»¶ä¸å˜ï¼›æ­¤æ—¶ï¼Œregexpæ”¯æŒåˆ†ç»„ã€‚</p></li></ul><p>state çŠ¶æ€ä¸ºabsentæ—¶ï¼Œåˆ é™¤åŒ¹é…è¡Œ</p><p>insertafter æ­£åˆ™æˆ–è€…EOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å</p><p>insertbefore æ­£åˆ™æˆ–è€…BOFï¼Œæ’å…¥åŒ¹é…çš„æŒ‡å®šè¡Œä¹‹å‰</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œ</p><p>create æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</p></blockquote><pre><code class="language-bash">-m lineinfile -a 'path= line=&quot; &quot; insertafter=&quot;æ­£åˆ™&quot;'</code></pre><h4 id="replace">replace</h4><blockquote><p>æ›¿æ¢æ–‡ä»¶å¯¹è±¡ä¸­ç¬¦åˆåŒ¹é…çš„å­—ç¬¦ä¸²</p><p>path æ–‡ä»¶å¯¹è±¡åœ°å€</p><p>regexp æ­£åˆ™åŒ¹é…</p><p>replace æ›¿æ¢åçš„å­—ç¬¦ä¸²</p><p>backup å…ˆå¤‡ä»½ï¼Œå†æ“ä½œ</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-aws</title>
      <link href="posts/15aa7d2e/"/>
      <url>posts/15aa7d2e/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://github.com/ansible/ansible/blob/stable-2.9/contrib/inventory/">https://github.com/ansible/ansible/blob/stable-2.9/contrib/inventory/</a></p><p><a href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html">https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html</a></p><p><a href="https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#inventory-script-example-aws-ec2">https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#inventory-script-example-aws-ec2</a> ï¼ˆæ·±å‘ï¼Œè„šæœ¬404ï¼Œæ‰¾åˆ°äº†è„šæœ¬ï¼Œå„ç§é”™è¯¯ï¼Œè¯·æ‰”ä¸€è¾¹ï¼‰</p></blockquote><h3 id="å‰è¨€">å‰è¨€</h3><p>é€šè¿‡ ansible è·å–å¤§åŒºä¸‹ ec2 èµ„æºä¿¡æ¯</p><h3 id="æˆæƒ">æˆæƒ</h3><pre><code class="language-shell">export AWS_ACCESS_KEY_ID='AK123'export AWS_SECRET_ACCESS_KEY='abc123'export EC2_INI_PATH=ec2.ini</code></pre><h3 id="åº“å­˜-inventory">åº“å­˜(inventory)</h3><pre><code class="language-ini">[local]localhost</code></pre><h3 id="Playbook">Playbook</h3><pre><code class="language-yaml">---  - name: test ec2    hosts: local    gather_facts: no   # æˆ‘ä»¬è¦è¿™ä¿¡æ¯å¹²ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æ˜¯æœ‰ç›®æ ‡çš„    connection: local # æœ¨æœ‰å®šä¹‰èµ„æº    tasks:      - name: get ec2 info        ec2_instance_info:          region: cn-north-1        register: data_output      - name: show ec2 info        debug:          msg: &quot;&#123;&#123; data_output|json_query('instances[*].network_interfaces[*].private_ip_address') &#125;&#125;&quot;</code></pre><h3 id="æ‰§è¡Œ">æ‰§è¡Œ</h3><pre><code class="language-shell">ansible-playbook -i hosts ec2.yml</code></pre><h3 id="è¾“å‡º">è¾“å‡º</h3><pre><code class="language-shell">TASK [show ec2 info] ******************************************************************************************************************************************************ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        [            &quot;10.100.10.250&quot;        ],         [            &quot;10.100.10.252&quot;        ],         [            &quot;10.100.10.210&quot;        ],         [            &quot;10.100.10.251&quot;        ]    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aws </tag>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows åŒ…ç®¡ç†å·¥å…· scoop</title>
      <link href="posts/22b82d75/"/>
      <url>posts/22b82d75/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-powershell">Set-ExecutionPolicy RemoteSigned -scope CurrentUseriwr -useb get.scoop.sh | iexscoop install aria2scoop config aria2-max-connection-per-server 16scoop config aria2-split 16scoop config aria2-min-split-size 1Mscoop bucket add extrasscoop install Terminus</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> windows </tag>
            
            <tag> scoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkinsâ˜å®‰è£…å’ŒåŸºæœ¬é…ç½®</title>
      <link href="posts/d9cdb70/"/>
      <url>posts/d9cdb70/</url>
      
        <content type="html"><![CDATA[<ul><li><p>jenkins</p><blockquote><p><a href="https://github.com/jenkinsci/docker/blob/master/README.md">https://github.com/jenkinsci/docker/blob/master/README.md</a></p></blockquote><pre><code class="language-bash">jenkinsDomain=gitlabDomain=gitlabWanIP=jenkinsDns=docker volume create jenkins_homedocker run --name jenkins --hostname $&#123;jenkinsDomain&#125; --add-host $&#123;gitlabDomain&#125;:$&#123;gitlabWanIP&#125; --restart always -d -v jenkins_home:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker -v /usr/lib64/libltdl.so.7:/usr/lib/x86_64-linux-gnu/libltdl.so.7 -p 8080:8080 -p 50000:50000 --dns $&#123;jenkinsDns&#125; jenkins/jenkins:lts</code></pre><pre><code class="language-bash">docker exec -it -u root jenkins /bin/bashcurl https://bootstrap.pypa.io/get-pip.py -o get-pip.pypython get-pip.pypip install awsclipip install ansiblegroupadd -g &lt;docker-group-id&gt; dockerusermod -aG docker jenkinsdocker stop jenkins &amp;&amp; docker start jenkins</code></pre></li><li><p>ç”¨æˆ·å’Œè§’è‰²ç®¡ç†</p><ol><li><p>å®‰è£…æ’ä»¶ Role-based Authorization Strategy</p></li><li><p>å¯ç”¨æ’ä»¶ Configure Global Security ä¸­å¯ç”¨ Role-Based Strategy ç­–ç•¥</p><p><img src="/posts/d9cdb70/image-20200515180703925.png" alt="image-20200515180703925"></p></li><li><p>é…ç½®å…¨å±€è§’è‰²å’Œé¡¹ç›®è§’è‰² Manage and Assign Roles - Manage Roles</p><p>å…¨å±€è§’è‰²<strong>Global roles</strong> è®¾ç½®ä¸¤ä¸ªï¼š admin å’Œ read</p><p><img src="/posts/d9cdb70/image-20200515181449965.png" alt="image-20200515181449965"></p><p>é¡¹ç›®è§’è‰²<strong>Project roles</strong>ï¼šæ¯ä¸€ä¸ªé¡¹ç›®è®¾ç½®ä¸€ä¸ª</p><p>Pattern: <code>.*\.&lt;é¡¹ç›®å&gt; </code></p><p>æƒé™: çœ‹å›¾</p><p><img src="/posts/d9cdb70/image-20200515181359533.png" alt="image-20200515181359533"></p></li><li><p>åˆ›å»ºé¡¹ç›®ç”¨æˆ·</p></li><li><p>åˆ†é…è§’è‰² Manage and Assign Roles - Assign Roles</p><p>ç»™ç®¡ç†å‘˜åˆ†é… adminï¼Œç»™é¡¹ç›®ç”¨æˆ·åˆ†é… read å’Œ cp (cpæ˜¯æˆ‘è®¾ç½®çš„é¡¹ç›®è§’è‰²)</p><p><img src="/posts/d9cdb70/image-20200515181740598.png" alt="image-20200515181740598"></p></li></ol></li><li><p>å®‰è£…é…ç½®æ–‡ä»¶æ’ä»¶ Config File Provider</p></li><li><p>è‡ªåŠ¨å®‰è£… git ï¼Œjdkï¼Œmaven ï¼ˆè¿™ç§æ–¹å¼åªæœ‰åœ¨è¿›è¡Œäº†ä¸€æ¬¡æ„å»ºåï¼Œæ‰ä¼šå®‰è£…ï¼‰</p></li><li><p>maven ç§æœé…ç½®æ–‡ä»¶</p><ol><li><p>é€šè¿‡ Config File Provider æ·»åŠ ä¸€ä¸ªé¡¹ç›®mavené…ç½®</p></li><li><pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;          xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;          xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt;  &lt;servers&gt;    &lt;server&gt;     &lt;id&gt;&lt;Repository Policyå&gt;&lt;/id&gt;     &lt;username&gt;&lt;/username&gt;     &lt;password&gt;&lt;/password&gt;    &lt;/server&gt;    &lt;server&gt;     &lt;id&gt;&lt;Repository Policyå&gt;&lt;/id&gt;      &lt;username&gt;&lt;/username&gt;      &lt;password&gt;&lt;/password&gt;    &lt;/server&gt;  &lt;/servers&gt;  &lt;profiles&gt;  &lt;profile&gt;&lt;id&gt;&lt; ä»“åº“å &gt;&lt;/id&gt;&lt;repositories&gt;  &lt;repository&gt;&lt;id&gt;&lt;maven ä»“åº“ç»„æˆ–ä»“åº“ID&gt;&lt;/id&gt;&lt;url&gt;&lt;maven ç§æœå…·ä½“ä»“åº“ç»„æˆ–ä»“åº“åœ°å€&gt;&lt;/url&gt;&lt;releases&gt;  &lt;enabled&gt;true&lt;/enabled&gt;&lt;/releases&gt;&lt;snapshots&gt;  &lt;enabled&gt;true&lt;/enabled&gt;&lt;/snapshots&gt;  &lt;/repository&gt;&lt;/repositories&gt;  &lt;/profile&gt;  &lt;/profiles&gt;  &lt;activeProfiles&gt; &lt;activeProfile&gt;é¡¹ç›®å&lt;/activeProfile&gt;  &lt;/activeProfiles&gt;&lt;/settings&gt;</code></pre></li><li><p>ç„¶åæ„å»ºé¡¹ç›®çš„æ—¶å€™ï¼Œæ„å»ºç¯å¢ƒ-Provide Configuration files-Filesï¼Œå¹¶ä¸”Build-é«˜çº§-Settings file-Provided settings.xml</p></li></ol></li></ul>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> jenkins </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fpmâ˜å®‰è£…-åŒ…ç®¡ç†æ–¹å¼</title>
      <link href="posts/b73a61bf/"/>
      <url>posts/b73a61bf/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä»‹ç»å¦‚ä½•é€šè¿‡yumæˆ–è€…apt-getå®‰è£…phpå’Œphp-fpm<br>é€‚åˆphp7.2</p><h4 id="centos">centos</h4><blockquote><p>å®‰è£…æº <a href="https://webtatic.com/">https://webtatic.com/</a></p></blockquote><pre><code class="language-bash">yum install epel-releaserpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpmyum install gcc-c++ geoip-devel -yyum install php72w-cli php72w-devel mod_php72w php72w-fpm php72w-opcache php72w-gd php72w-bcmath php72w-xml -y# php72w-lzo php72w-yaf æ²¡æœ‰ç›´æ¥çš„åŒ…mkdir /export/logs/php -pcd /etc/php-fpm.d/ &amp;&amp; mv www.conf www.conf.bakwebName=wwwcat &gt; www.conf &lt;&lt; EOF[$&#123;webName&#125;]user = webappsgroup = webappslisten = 0.0.0.0:9000pm = staticpm.max_children = 20pm.max_requests = 1024pm.status_path = /php-fpm_statusrequest_slowlog_timeout = 2sslowlog = /export/logs/php/php-slow.logphp_admin_value[error_log] = /export/logs/php/www-error.logphp_admin_flag[log_errors] = onphp_value[session.save_handler] = filesphp_value[session.save_path]    = /var/lib/php/sessionphp_value[soap.wsdl_cache_dir]  = /var/lib/php/wsdlcacheEOF# å®‰è£…æºä¸­æ²¡æœ‰çš„æ¨¡å—, å‡è®¾æ¨¡å—æ˜¯rediscd /usr/local/srcphpModule=yafwget https://pecl.php.net/get/$&#123;phpModule&#125; &amp;&amp; mkdir $&#123;phpModule&#125;-src &amp;&amp; tar xf $&#123;phpModule&#125; --strip-components 1 -C $&#123;phpModule&#125;-srccd $&#123;phpModule&#125;-src &amp;&amp; phpize &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make installcat &gt; /etc/php.d/$&#123;phpModule&#125;.ini &lt;&lt; EOF; Enable zip extension moduleextension=$&#123;phpModule&#125;.soEOF</code></pre><h4 id="ubuntu">ubuntu</h4><pre><code class="language-bash">add-apt-repository ppa:ondrej/phpapt-get install php7.2 php7.2-dev php7.2-fpm php7.2-mysql php7.2-curl php7.2-json php7.2-mbstring php7.2-xml  php7.2-intl php7.2-yac php7.2-yaf php7.2-redis php7.2-lzo php7.2-geoip php7.2-pecl php7.2-pear php7.2-dev php7.2-gd php7.2-zip php7.2-xml php7.2-bcmath</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> fpm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜åŸºç¡€ä¿¡æ¯</title>
      <link href="posts/d3e413b7/"/>
      <url>posts/d3e413b7/</url>
      
        <content type="html"><![CDATA[<h3 id="å®‰è£…">å®‰è£…</h3><pre><code class="language-shell">apt-get install python3-pippip3 install ansible --user -i https://pypi.tuna.tsinghua.edu.cn/simple</code></pre><blockquote><p>pip å®‰è£…æ–¹å¼ï¼Œä¸ä¼šç”Ÿæˆé»˜è®¤é…ç½®<br><a href="https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg">https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg</a></p></blockquote><h3 id="å…³é—­-known-hosts-æ£€æŸ¥">å…³é—­ known_hosts æ£€æŸ¥</h3><pre><code class="language-ini"># /etc/ansible/ansible.cfg or ~/.ansible.cfg[defaults]host_key_checking = False</code></pre><h3 id="åº“å­˜å’Œå˜é‡">åº“å­˜å’Œå˜é‡</h3><pre><code class="language-ini"># /etc/ansible/hosts é»˜è®¤ä½ç½®ï¼Œä½†å¯è‡ªå®šä¹‰ï¼Œå¹¶é€šè¿‡ -i æ¥è°ƒç”¨############################################################################# å•ä¸»æœºmail.example.com# http_port ä¸»æœºå˜é‡[webservers]www[01:50].example.comhttp_port=80[dbservers]db-[a:f].example.comansible_connection=ssh        ansible_ssh_user=mysql# ç»„å˜é‡ ==&gt; ç»„å:vers[dbservers:vars]mysql_port=3306# åµŒå¥—ç»„ ==&gt; çˆ¶ç»„:children[webproject:children]webserversdbservers</code></pre><blockquote><p>ä¸­æ‹¬å·è¡¨ç¤ºåˆ†ç»„ï¼Œå¯ä»¥ç”¨ç»„åä»£æ›¿ç»„èµ„æº ;</p></blockquote><h3 id="ç»“æ„åŒ–å˜é‡">ç»“æ„åŒ–å˜é‡</h3><blockquote><p>é‡‡ç”¨ yaml é…ç½®ï¼Œæ ¼å¼ï¼š</p><pre><code class="language-yaml">---  å˜é‡:å€¼</code></pre></blockquote><pre><code class="language-shell">/etc/ansible/group_vars/&lt;ç»„å&gt; # &lt;ç»„å&gt;æ–‡ä»¶æˆ–è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œå‡ä¼šè¢«è®¤ä¸ºæ˜¯&lt;ç»„å&gt;å˜é‡/etc/ansible/host_vars/&lt;ä¸»æœºå&gt; # &lt;ä¸»æœºå&gt;æ–‡ä»¶æˆ–è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œå‡ä¼šè¢«è®¤ä¸ºæ˜¯&lt;ç»„å&gt;å˜é‡</code></pre><h4 id="å¸¸ç”¨çš„å˜é‡">å¸¸ç”¨çš„å˜é‡</h4><pre><code class="language-shell">ansible_ssh_host      å°†è¦è¿æ¥çš„è¿œç¨‹ä¸»æœºå.ä¸ä½ æƒ³è¦è®¾å®šçš„ä¸»æœºçš„åˆ«åä¸åŒçš„è¯,å¯é€šè¿‡æ­¤å˜é‡è®¾ç½®.ansible_ssh_port      sshç«¯å£å·.å¦‚æœä¸æ˜¯é»˜è®¤çš„ç«¯å£å·,é€šè¿‡æ­¤å˜é‡è®¾ç½®.ansible_ssh_user      é»˜è®¤çš„ ssh ç”¨æˆ·åansible_ssh_pass      ssh å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨,æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨ --ask-pass æˆ– SSH å¯†é’¥)ansible_sudo_pass      sudo å¯†ç (è¿™ç§æ–¹å¼å¹¶ä¸å®‰å…¨,æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨ -b --ask-become-pass)ansible_sudo_exe (new in version 1.8)      sudo å‘½ä»¤è·¯å¾„(é€‚ç”¨äº1.8åŠä»¥ä¸Šç‰ˆæœ¬)ansible_connection      ä¸ä¸»æœºçš„è¿æ¥ç±»å‹.æ¯”å¦‚:local, ssh æˆ–è€… paramiko. Ansible 1.2 ä»¥å‰é»˜è®¤ä½¿ç”¨ paramiko.1.2 ä»¥åé»˜è®¤ä½¿ç”¨ 'smart','smart' æ–¹å¼ä¼šæ ¹æ®æ˜¯å¦æ”¯æŒ ControlPersist, æ¥åˆ¤æ–­'ssh' æ–¹å¼æ˜¯å¦å¯è¡Œ.ansible_ssh_private_key_file      ssh ä½¿ç”¨çš„ç§é’¥æ–‡ä»¶.é€‚ç”¨äºæœ‰å¤šä¸ªå¯†é’¥,è€Œä½ ä¸æƒ³ä½¿ç”¨ SSH ä»£ç†çš„æƒ…å†µ.ansible_shell_type      ç›®æ ‡ç³»ç»Ÿçš„shellç±»å‹.é»˜è®¤æƒ…å†µä¸‹,å‘½ä»¤çš„æ‰§è¡Œä½¿ç”¨ 'sh' è¯­æ³•,å¯è®¾ç½®ä¸º 'csh' æˆ– 'fish'.ansible_python_interpreter      ç›®æ ‡ä¸»æœºçš„ python è·¯å¾„.é€‚ç”¨äºçš„æƒ…å†µ: ç³»ç»Ÿä¸­æœ‰å¤šä¸ª Python, æˆ–è€…å‘½ä»¤è·¯å¾„ä¸æ˜¯&quot;/usr/bin/python&quot;,æ¯”å¦‚  \*BSD, æˆ–è€… /usr/bin/python      ä¸æ˜¯ 2.X ç‰ˆæœ¬çš„ Python.æˆ‘ä»¬ä¸ä½¿ç”¨ &quot;/usr/bin/env&quot; æœºåˆ¶,å› ä¸ºè¿™è¦æ±‚è¿œç¨‹ç”¨æˆ·çš„è·¯å¾„è®¾ç½®æ­£ç¡®,ä¸”è¦æ±‚ &quot;python&quot; å¯æ‰§è¡Œç¨‹åºåä¸å¯ä¸º pythonä»¥å¤–çš„åå­—(å®é™…æœ‰å¯èƒ½åä¸ºpython26).      ä¸ ansible_python_interpreter çš„å·¥ä½œæ–¹å¼ç›¸åŒ,å¯è®¾å®šå¦‚ ruby æˆ– perl çš„è·¯å¾„....</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å·¥å…·åº“</title>
      <link href="posts/3827a60a/"/>
      <url>posts/3827a60a/</url>
      
        <content type="html"><![CDATA[<p><a href="https://encycolorpedia.cn/323e4e">åå…­è¿›åˆ¶é¢œè‰²ä»£ç è¡¨ï¼Œå›¾è¡¨ï¼Œè°ƒè‰²æ¿ï¼Œç»˜å›¾&amp;æ²¹æ¼†</a></p><p><a href="http://gosspublic.alicdn.com/ram-policy-editor/index.html">é˜¿é‡Œäº‘ ram ç­–ç•¥ç”Ÿæˆå™¨</a></p><p><a href="https://develop.aliyun.com/tools/sdk?#/python">é˜¿é‡Œäº‘SDKé¢‘é“</a></p><p><a href="https://app.xuty.tk/static/app/index.html">è¡¨æƒ…é”…</a></p><p><a href="https://whoer.net/zh">æµ‹è¯•å›½å¤–å‡ºå£ip</a></p><p><a href="http://www.ip-api.com/">æµ‹è¯•å›½å¤–å‡ºå£ip</a></p><p><a href="https://www.wondercv.com/">è¶…çº§ç®€å†WonderCV - HRæ¨èç®€å†æ¨¡æ¿,æ™ºèƒ½ç®€å†åˆ¶ä½œå·¥å…·,ä¸“ä¸šä¸­è‹±æ–‡ç®€å†æ¨¡æ¿å…è´¹ä¸‹è½½</a></p><p><a href="https://help.aliyun.com/knowledge_detail/50270.html?spm=a2c4g.11186623.6.621.483534bfFo31Sm">å„åœ°åŒºç®¡å±€å¤‡æ¡ˆè§„åˆ™</a></p><p><a href="https://www.ipplus360.com/">æ›´ç²¾å‡†çš„å…¨çƒIPåœ°å€å®šä½å¹³å°_IPé—®é—® -åŸƒæ–‡ç§‘æŠ€(ipplus360.com)</a></p><p><a href="http://xn--eqrt2g.xn--vuq861b/">å·¥ä¿¡éƒ¨-åŸŸå.ä¿¡æ¯</a></p><p><a href="http://explainshell.com/">è§£æå‘½ä»¤ explainshell.com - match command-line arguments to their help text</a></p><p><a href="https://haveibeenpwned.com/Passwords">å¯†ç æ³„éœ²æ£€æµ‹</a></p><p><a href="https://tuna.moe/">æ¸…åå¤§å­¦ TUNA åä¼š - Home</a></p><p><a href="http://zh.thetimenow.com/time-zone-converter.php">æ—¶åŒºè½¬æ¢ç”Ÿæˆ</a></p><p><a href="https://help.aliyun.com/document_detail/116378.html?spm=a2c4g.11186623.2.17.6f36578flUOrcy#concept-188715">ä½¿ç”¨redis-shakeè¿ç§»RDBæ–‡ä»¶å†…çš„æ•°æ®</a></p><p><a href="https://www.17ce.com/">ç½‘ç«™æµ‹é€Ÿ|ç½‘ç«™é€Ÿåº¦æµ‹è¯•|ç½‘é€Ÿæµ‹è¯•|ç”µä¿¡|è”é€š|ç½‘é€š|å…¨å›½|ç›‘æ§|CDN|PING|DNS 17CE.COM</a></p><p><a href="https://devhints.io/">è¯­è¨€/å·¥å…·è¯­æ³•å¸¸ç”¨æ‘˜è¦</a></p><p><a href="https://ipchaxun.com/">åŸŸååæŸ¥ip</a></p><p><a href="https://www.whatsmydns.net/">åŸŸåè§£ææ£€æŸ¥</a></p><p><a href="https://intodns.com/">åŸŸåçŠ¶æ€æŠ¥å‘Š</a></p><p><a href="https://github.com/ireaderlab/alex">alex:webå‹åŠ›æµ‹è¯•å·¥å…·</a></p><p><a href="http://www.kammerl.de/ascii/AsciiSignature.php">Ascii Text / Signature Generator motdåŠ¨æ€å¼€æœºæé†’</a></p><p><a href="https://www.json2yaml.com/convert-yaml-to-json">Convert YAML to JSON</a></p><p><a href="https://csr.chinassl.net/generator-csr.html">CSRæ–‡ä»¶ç”Ÿæˆå·¥å…·-ä¸­å›½æ•°å­—è¯ä¹¦CHINASSL</a></p><p><a href="https://apps.evozi.com/apk-downloader/">gp apk ä¸‹è½½</a></p><p><a href="http://tool.520101.com/wangluo/ipjisuan/">ipåœ°å€åœ¨çº¿è®¡ç®—å™¨</a></p><p><a href="https://ipv6-test.com/validate.php">IPv6 ç«™ç‚¹æµ‹è¯•</a></p><p><a href="http://grokconstructor.appspot.com/do/match#result">logstash grok æµ‹è¯•</a></p><p><a href="https://github.com/DoubleLabyrinth/MobaXterm-keygen">MobaXterm-keygen å¯†é’¥</a></p><p><a href="http://msdn.itellyou.cn/">MSDN, æˆ‘å‘Šè¯‰ä½ </a></p><p><a href="https://api.aliyun.com/#/cli">OpenAPI Explorer</a></p><p><a href="https://www.pyman.com.cn/">pymanç½‘å€å¯¼èˆª</a></p><p><a href="http://rpm.pbone.net/">RPM Search</a></p><p><a href="https://www.cnblogs.com/zhaoruiqing/articles/12870209.html">Typoraçš„EmojiæŒ‡ä»¤</a></p><p><a href="https://paste.ubuntu.com/">Ubuntu Pastebin</a></p><p><a href="http://www.92csz.com/study/UnixToolbox-zh_CN.html">Unix Toolbox - ä¸­æ–‡ç‰ˆ</a></p><p><a href="https://www.dotcom-tools.com/">Website Performance Test Tools</a></p>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜æ—¶é—´</title>
      <link href="posts/cd32aa48/"/>
      <url>posts/cd32aa48/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬æ–‡ä¸­æè¿°çš„å¹¶ä¸èƒ½æ¶µç›–æ‰€æœ‰æ—¶é—´è®¾ç½®å‘½ä»¤ï¼Œåªæ˜¯è®°å½•äº†ç»å¸¸ç”¨åˆ°çš„ä¸€äº›ã€‚</p><h2 id="æ—¶é—´åŒæ­¥">æ—¶é—´åŒæ­¥</h2><pre><code>sudo yum erase ntp*sudo yum -y install chronysudo service chronyd startsed -i '1i server 10.200.16.101 prefer iburst' /etc/chrony.conf</code></pre><blockquote><p>10.200.16.101 æ›¿æ¢æˆntpæœåŠ¡å™¨</p></blockquote><h2 id="æ—¶åŒºä¿®æ”¹">æ—¶åŒºä¿®æ”¹</h2><p>å¦‚æœä½ ç”¨çš„æ˜¯7ä»¥ä¸Šçš„centosæˆ–è€…ubuntu</p><p>é‚£ä¹ˆå¯ä»¥ç”¨ timedatectl å‘½ä»¤æ¥è®¾ç½®æ—¶åŒº</p><p>timedatectl --list-timezones</p><p>timedatectl --set-timezone Asia/Shanghai</p><hr><h2 id="æ²¡æœ‰timedatectlå‘½ä»¤çš„è¯">æ²¡æœ‰timedatectlå‘½ä»¤çš„è¯</h2><h4 id="ä¿®æ”¹ä¼šè¯æ—¶åŒº">ä¿®æ”¹ä¼šè¯æ—¶åŒº</h4><pre><code class="language-bash">echo &quot;TZ='UTC+0'; export TZ&quot; &gt;&gt; ~/.bash_profile</code></pre><blockquote><p>éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>UTC8 è¡¨ç¤ºè¥¿8åŒº</li><li>tzselect å¯ä»¥å¸®ä½ æŸ¥çœ‹æ—¶åŒºæœ‰å“ªäº›</li><li>UTC æ–¹å¼ï¼Œæ— æ³•è¯†åˆ«å†¬ä»¤æ—¶å’Œå¤ä»¤æ—¶ï¼Œæ‰€ä»¥å»ºè®®ç”¨åœ°åŒºåç§°ï¼Œä¾‹å¦‚ asia/shanghai</li></ol></blockquote><h4 id="ä¿®æ”¹crontabæ—¶åŒº">ä¿®æ”¹crontabæ—¶åŒº</h4><p>åœ¨ crontab ç”¨æˆ·é…ç½®æœ€ä¸Šé¢åŠ å…¥ï¼Œä¾‹å¦‚æ·»åŠ èŠåŠ å“¥æ—¶åŒº</p><pre><code class="language-bash">TZ='America/Chicago'CRON_TZ='America/Chicago'</code></pre><blockquote><p>å…³äºæ—¶åŒºè®¾ç½®æ–¹é¢ï¼Œä¸å»ºè®®ä¿®æ”¹é…ç½®ï¼Œå› ä¸ºä¸å¤Ÿçµæ´»</p></blockquote><h4 id="ä¿®æ­£æ—¶é—´-å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ">ä¿®æ­£æ—¶é—´, å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</h4><pre><code class="language-bash">yum install ntp -yntpdate cn.ntp.org.cnhwclock -wecho '0 12 * * * /usr/sbin/ntpdate cn.ntp.org.cn &gt; /dev/null 2&gt;&amp;1' &gt;&gt; /etc/crontab</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> æ—¶åŒº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ—¥å¿—â˜ELKç®€å•éƒ¨ç½²-å®¹å™¨æ–¹å¼</title>
      <link href="posts/3475106c/"/>
      <url>posts/3475106c/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><ul><li>å„ç»„ä»¶æ€»ä¸‹è½½é¡µ: <a href="https://www.elastic.co/cn/downloads/">https://www.elastic.co/cn/downloads/</a></li><li>å®¹å™¨ä¸‹è½½é¡µ: <a href="https://www.docker.elastic.co">https://www.docker.elastic.co</a></li></ul><ol><li>Elasticsearch æœç´¢åˆ†æ <a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></li><li>Logstash è½¬æ¢è¾“å‡º <a href="https://www.elastic.co/cn/downloads/logstash">https://www.elastic.co/cn/downloads/logstash</a></li><li>Filebeat æ”¶é›† <a href="https://www.elastic.co/cn/downloads/beats/filebeat">https://www.elastic.co/cn/downloads/beats/filebeat</a></li><li>Kibana å±•ç¤º <a href="https://www.elastic.co/cn/downloads/kibana">https://www.elastic.co/cn/downloads/kibana</a></li></ol><h4 id="æ•°æ®è¿‡ç¨‹">æ•°æ®è¿‡ç¨‹:</h4><p>Filebeat â˜ Logstash â˜ Elasticsearch (master node) + data node â˜ Kibana</p><h4 id="å®‰è£…æ­¥éª¤">å®‰è£…æ­¥éª¤</h4><pre><code class="language-bash"># dockeryum install docker -y æˆ–è€… yum install docker-ce -yyum install python3-pip -ypip3 install docker-compose æˆ–è€… pip install docker-composesystemctl enable docker# ä¿®æ”¹ docker é»˜è®¤æ•°æ®ç›®å½•vi /etc/docker/daemon.json&#123;&quot;data-root&quot;: &quot;/export/docker-data-root&quot;&#125;systemctl start docker</code></pre><pre><code class="language-yml"># elasticsearch å…·ä½“å®‰è£…å‘½ä»¤å’Œç‰ˆæœ¬è¯·ä»¥ä¸‹è½½é¡µä¸­å¯¹åº”çš„dockerå®‰è£…æ–¹å¼é¡µé‡Œå‘½ä»¤ä¸ºåŸºå‡†sysctl -a | grep  vm.max_map_count  # æŸ¥çœ‹æ˜¯å¦è¿‡å°, å¦‚æœè¿‡å°æ‰§è¡Œä¸‹ä¸€æ¡echo 'vm.max_map_count=262144' &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -pmkdir -p /export/docker-compose-data/es;touch /export/docker-compose-data/docker-compose.yml;touch /export/docker-compose-data/es/es01.yml;touch /export/docker-compose-data/es/es02.yml;mkdir -p /export/docker-compose-data/kibana;touch /export/docker-compose-data/kibana/kibana.yml;mkdir -p /export/docker-compose-data/logstashtouch /export/docker-compose-data/logstash/logstash.yml;</code></pre><pre><code class="language-bash"># es01 master å’Œ data# es02 datacat &gt; /export/docker-compose-data/es/es01.yml &lt;&lt; EOFnode.master: truenode.data: truehttp.port: 9200network.host: 0.0.0.0http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; xpack.security.enabled: falseEOFcat &gt; /export/docker-compose-data/es/es02.yml &lt;&lt; EOFnode.master: falsenode.data: truehttp.port: 9200network.host: 0.0.0.0http.cors.enabled: truehttp.cors.allow-origin: &quot;*&quot; xpack.security.enabled: falseEOFcat &gt; /export/docker-compose-data/kibana/kibana.yml &lt;&lt; EOFxpack.monitoring.ui.container.elasticsearch.enabled: truei18n.locale: zh-CNEOFcat &gt; /export/docker-compose-data/logstash/logstash.yml &lt;&lt; EOFnode.name: logstashhttp.host: 0.0.0.0http.port: 9600log.level: infoconfig.reload.automatic: trueconfig.reload.interval: 10sconfig.support_escapes: falseEOF</code></pre><h4 id="ç¼–å†™-logstash-ç®¡é“æ–‡ä»¶">ç¼–å†™ logstash ç®¡é“æ–‡ä»¶</h4><pre><code class="language-yml"># ç¤ºä¾‹ /export/docker-compose-data/logstash/pipeline/es-curator.confinput &#123;file &#123;path =&gt; &quot;/mnt/info.log&quot;type =&gt; &quot;es-curator&quot;start_position =&gt; &quot;beginning&quot;&#125;&#125;output &#123;if [type] == &quot;es-curator&quot; &#123;elasticsearch &#123;hosts=&gt; [&quot;es01:9200&quot;]index=&gt; &quot;es-curator-%&#123;+YYYY-MM-dd&#125;&quot;&#125;&#125;&#125;</code></pre><h4 id="å¯åŠ¨æœåŠ¡docker-composeé…ç½®æ–‡ä»¶">å¯åŠ¨æœåŠ¡docker-composeé…ç½®æ–‡ä»¶</h4><blockquote><p><a href="https://docs.docker.com/compose/compose-file/compose-file-v2/">https://docs.docker.com/compose/compose-file/compose-file-v2/</a></p><p>æœ¬é…ç½®æ–‡ä»¶å‚è€ƒ 2.3 ç‰ˆæœ¬, è¯·å‹¿ä½¿ç”¨ 3.x ç‰ˆæœ¬, å› ä¸ºå®ƒçš„èµ„æºå±‚ deploy, docker-composeå‘½ä»¤ä¸æ”¯æŒ</p></blockquote><pre><code class="language-yml">cat &gt; /export/docker-compose-data/docker-compose.yml &lt;&lt; EOFversion: '2.3'services:  es01:    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.1    container_name: es01    environment:      - node.name=es01      - cluster.initial_master_nodes=es01      - cluster.name=es-sen      - bootstrap.memory_lock=true      - &quot;ES_JAVA_OPTS=-Xms1536m -Xmx1536m&quot;    ulimits:      memlock:        soft: -1        hard: -1      nofile:        soft: 65536        hard: 65536    volumes:      - esdata01:/usr/share/elasticsearch/data      - /export/docker-compose-data/es/es01.yml:/usr/share/elasticsearch/config/elasticsearch.yml    ports:      - 9200:9200    networks:      - esnet    cpus: 0.5    mem_limit: 3G    memswap_limit: 3G    mem_reservation: 3G    healthcheck:      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:9200&quot;]      interval: 1m30s      timeout: 10s      retries: 3      start_period: 120s    restart: on-failure  es02:    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.1    container_name: es02    environment:      - node.name=es02      - discovery.seed_hosts=es01      - cluster.initial_master_nodes=es01      - cluster.name=es-sen      - bootstrap.memory_lock=true      - &quot;ES_JAVA_OPTS=-Xms1536m-Xmx1536m&quot;    ulimits:      memlock:        soft: -1        hard: -1      nofile:        soft: 65536        hard: 65536    volumes:      - esdata02:/usr/share/elasticsearch/data      - /export/docker-compose-data/es/es02.yml:/usr/share/elasticsearch/config/elasticsearch.yml    networks:      - esnet    cpus: 1    mem_limit: 3G    memswap_limit: 3G    mem_reservation: 3G    healthcheck:      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:9200&quot;]      interval: 1m30s      timeout: 10s      retries: 3      start_period: 120s    restart: on-failure  kibana:    image: docker.elastic.co/kibana/kibana:7.4.1    container_name: kibana    environment:      SERVER_NAME: kibana.sen-sdk.com      SERVER_HOST: 0.0.0.0      ELASTICSEARCH_HOSTS: http://es01:9200    volumes:      - /export/docker-compose-data/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml    ports:      - 5601:5601    networks:      - esnet    cpus: 0.5    mem_limit: 512m    memswap_limit: 512m    mem_reservation: 512m    healthcheck:      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:5601&quot;]      interval: 1m30s      timeout: 10s      retries: 3      start_period: 120s    restart: on-failure  logstash:    image: docker.elastic.co/logstash/logstash:7.4.1    container_name: logstash    volumes:      - /export/docker-compose-data/logstash/pipeline/:/usr/share/logstash/pipeline/      - /export/docker-compose-data/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml      - logstash:/usr/share/logstash/data    ports:      - &quot;5044:5044&quot;      - &quot;9600:9600&quot;    networks:      - esnet    cpus: 0.5    mem_limit: 1g    memswap_limit: 1g    mem_reservation: 1g    healthcheck:      test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:9600&quot;]      interval: 1m30s      timeout: 10s      retries: 3      start_period: 120s    restart: on-failurevolumes:  esdata01:    driver: local  esdata02:    driver: local  logstash:    driver: localnetworks:  esnet:EOF</code></pre><h4 id="å¯åŠ¨-docker-compose">å¯åŠ¨ docker-compose</h4><pre><code class="language-bash">cd /export/docker-compose-data/docker-compose up -d# docker-compose up -d --no-recreate</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¿— </category>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> docker </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx â˜ åŸºæœ¬è®¤è¯</title>
      <link href="posts/18de0eed/"/>
      <url>posts/18de0eed/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># å®‰è£… htpasswd å·¥å…·yum install httpd-tools -y# ç”Ÿæˆå¯†ç æ–‡ä»¶htpasswd -bc /usr/local/nginx/conf/.passwd usera pwd # åˆ›å»ºç”¨æˆ·usera, å¹¶å†™å…¥ .passwdhtpasswd -b /usr/local/nginx/conf.passwd userb pwd  # è¿½åŠ ç”¨æˆ· userbhtpasswd -D /usr/local/nginx/conf/.passwd usera # åˆ é™¤ç”¨æˆ·# nginxé…ç½®server &#123;    listen       80;    server_name  xxx.com;    index index.html;    location /auth &#123;        auth_basic &quot;nginx auth&quot;;        auth_basic_user_file /usr/local/nginx/conf/.passwd;        alias /export/webapps/xxx.com;    &#125;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜è½¯raidåˆ›å»º</title>
      <link href="posts/a7611bc1/"/>
      <url>posts/a7611bc1/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-â˜-è½¯-raid-åˆ›å»º">linux â˜ è½¯ raid åˆ›å»º</h2><ul><li>åˆ›å»º</li></ul><pre><code class="language-bash"># ç£ç›˜åˆ†åŒºfdisk /dev/sdafdisk /dev/sdb# æ„å»ºraid0# --level raidçº§åˆ«# --raid-devices ç›˜æ•°# --chunk æ¡å¸¦æ·±åº¦ï¼Œå†³å®šäº†æ•°æ®åˆ†å‰²çš„æ ‡å‡†å•ä½å¤§å°ï¼Œæ•°å€¼è¶Šå°ï¼Œåˆ™æ•°æ®è¶Šåˆ†æ•£ï¼Œæ€§èƒ½è¶Šä½(å¦‚è‹¥æ²¡æœ‰ç‰¹æ®Šä¼˜åŒ–éœ€æ±‚ï¼Œå»ºè®®é€‰é»˜è®¤å€¼å³å¯)mdadm -Cv /dev/md0 --level=0 --raid-devices=2 /dev/sda1 /dev/sdb1# å·²ä¸Šé…ç½®ä¸­, ä¹Ÿå¯ä»¥ä¸åˆ†åŒº, ç›´æ¥è¿›è¡Œ raid æ„å»ºmdadm --create --verbose /dev/md0 --level=0 --name=MY_RAID --raid-devices=number_of_volumes device_name1 device_name2# è§‚å¯Ÿå’Œç­‰å¾…é˜µåˆ—åˆå§‹åŒ–cat /proc/mdstat# è§‚å¯Ÿåˆå§‹åŒ–åçš„é˜µåˆ—ä¿¡æ¯mdadm --detail /dev/md0# æ ¼å¼åŒ– ï¼ˆåŠ å·æ ‡ï¼‰mke2fs -t ext4 -L raid0 /dev/md0# å†™å…¥é…ç½®# ä¸åŒçš„æ“ä½œç³»ç»Ÿ mdadm.conf ä½ç½®ä¸åŒ, å…·ä½“ä»¥ man mdadm.conf ä¸ºå‡†mdadm --detail --scan | tee -a /etc/mdadm.conf# echo &quot;DEVICE /dev/sda1 /dev/sdb1 &quot; &gt;&gt; /etc/mdadm/mdadm.conf# mdadm -Ds &gt;&gt; /etc/mdadm/mdadm.conf# åˆ›å»ºæ–°çš„ Ramdisk Image ä»¥ä¸ºæ–°çš„ RAID é…ç½®æ­£ç¡®åœ°é¢„åŠ è½½å—å‚¨å­˜è®¾å¤‡æ¨¡å—sudo dracut -H -f /boot/initramfs-$(uname -r).img $(uname -r)# å†™å…¥æŒ‚è½½ ï¼ˆç”¨å·æ ‡æŒ‚è½½ï¼Œæœ‰äº›ç³»ç»Ÿé‡å¯åï¼Œè®¾å¤‡åä¼šä»md0å˜æˆmd127ï¼‰echo &quot;LABEL=raid0 /data ext4 defaults,nofail 0 2&quot; &gt;&gt; /etc/fstabmkdir /datamount -a# ç¡®è®¤æŒ‚è½½æˆåŠŸdf -h</code></pre><ul><li>åˆ é™¤</li></ul><pre><code class="language-bash"># åˆ é™¤/etc/fstabçš„æŒ‚è½½ä¿¡æ¯$ mdadm -S /dev/md0$ mdadm --misc --zero-superblock /dev/sda$ mdadm --misc --zero-superblock /dev/sdb# åˆ é™¤/etc/mdadm/mdadm.confæ–‡ä»¶ä¸­æ·»åŠ çš„DEVICEè¡Œå’ŒARRAYè¡Œ</code></pre><ul><li>é¢å¤–ä¿¡æ¯</li></ul><pre><code class="language-bash">#2Tä»¥ä¸Šå¤§å°åˆ†åŒºparted /dev/sda mklabel gpt mkpart primary1 0% 100%partprobe</code></pre><ul><li>å…³äºäº‘</li></ul><pre><code class="language-bash">å½“ä½¿ç”¨äº‘ç«¯ç£ç›˜æ„å»ºraidçš„æ—¶å€™,ä¸”åˆæƒ³è¿›è¡Œ raid å¤‡ä»½,åˆ™åŠ¡å¿…å…ˆåœæ­¢ioæ“ä½œ,åœæ­¢ioæ“ä½œçš„æ–¹æ³•æœ€å¥½æ˜¯ umount æˆ–è€…åœæœº. å¦åˆ™ä¼šå¯¼è‡´ raid æ•°æ®å®Œæ•´æ€§å‡ºç°é—®é¢˜.</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> raid </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜s3 åˆå§‹åŒ–å®‰è£…</title>
      <link href="posts/2c5a64ff/"/>
      <url>posts/2c5a64ff/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€">å‰è¨€</h3><p>è„šæœ¬çš„ç›®çš„ï¼š</p><ol><li>åˆ›å»ºS3</li><li>æ·»åŠ ç”Ÿå‘½å‘¨æœŸ</li><li>åˆ›å»ºiamè§„åˆ™</li></ol><blockquote><p>s3å®˜æ–¹æˆæƒç¤ºä¾‹ï¼š<a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/example-policies-s3.html">https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/example-policies-s3.html</a></p></blockquote><h3 id="ä¸»ä½“è„šæœ¬">ä¸»ä½“è„šæœ¬</h3><pre><code class="language-bash">#!/bin/bash# http://docs.amazonaws.cn/general/latest/gr/rande.html#s3_region# us-east-1 us-west-1 ç­‰# éœ€è¦s3æƒé™å’Œiamæƒé™# éœ€è¦å…ˆç¼–å†™ s3-lifecycle.json#æ¡¶åread -p &quot;è¾“å…¥s3æ¡¶å=&quot; S3BucketName#æ‰€å±é¡¹ç›®read -p &quot;è¾“å…¥é¡¹ç›®å=&quot; TeamNameread -p &quot;è¾“å…¥AWS_ACCESS_KEY_ID=&quot; AWS_ACCESS_KEY_IDread -p &quot;è¾“å…¥AWS_SECRET_ACCESS_KEY=&quot; AWS_SECRET_ACCESS_KEYread -p &quot;è¾“å…¥AWS_DEFAULT_REGION=&quot; AWS_DEFAULT_REGIONexport AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_IDexport AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEYexport AWS_DEFAULT_REGION=$AWS_DEFAULT_REGIONS3LocationConstraint=$&#123;AWS_DEFAULT_REGION&#125;[[ $&#123;S3LocationConstraint&#125; == 'us-east-1' ]] &amp;&amp; aws s3api create-bucket --bucket $&#123;S3BucketName&#125; --region $&#123;S3LocationConstraint&#125; || aws s3api create-bucket --bucket $&#123;S3BucketName&#125; --region $&#123;S3LocationConstraint&#125; --create-bucket-configuration LocationConstraint=$&#123;S3LocationConstraint&#125;aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'conf/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'data/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'backup/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/7days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/15days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/30days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/60days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/90days/'aws s3api put-object --bucket $&#123;S3BucketName&#125; --key 'logs/longlasting/'aws s3api put-bucket-tagging --bucket $&#123;S3BucketName&#125; --tagging &quot;TagSet=[&#123;Key=Team,Value=$&#123;TeamName&#125;&#125;]&quot;aws s3api put-bucket-lifecycle-configuration --bucket $&#123;S3BucketName&#125; --lifecycle-configuration file://s3-lifecycle.jsoncat &gt; s3-program.rule &lt;&lt; EOF&#123;    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Sid&quot;: &quot;VisualEditor0&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;s3:GetObject&quot;,                &quot;s3:PutObject&quot;,                &quot;s3:DeleteObject&quot;            ],            &quot;Resource&quot;: [                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/7days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/15days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/30days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/60days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/90days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/longlasting/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/conf/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/data/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/backup/*&quot;            ]        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor1&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:ListBucket&quot;,            &quot;Resource&quot;: &quot;arn:aws:s3:::$&#123;S3BucketName&#125;&quot;        &#125;    ]&#125;EOFcat &gt; s3-local.rule &lt;&lt; EOF&#123;    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Sid&quot;: &quot;VisualEditor0&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:ListBucket&quot;,            &quot;Resource&quot;: &quot;arn:aws:s3:::$&#123;S3BucketName&#125;&quot;,            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor1&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;s3:PutObject&quot;,                &quot;s3:GetObject&quot;,                &quot;s3:DeleteObject&quot;            ],            &quot;Resource&quot;: [                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/7days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/15days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/30days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/60days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/90days/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/logs/longlasting/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/conf/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/data/*&quot;,                &quot;arn:aws:s3:::$&#123;S3BucketName&#125;/backup/*&quot;            ],            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor2&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:GetBucketLocation&quot;,            &quot;Resource&quot;: &quot;arn:aws:s3:::$&#123;S3BucketName&#125;&quot;,            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;,        &#123;            &quot;Sid&quot;: &quot;VisualEditor3&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: &quot;s3:ListAllMyBuckets&quot;,            &quot;Resource&quot;: &quot;*&quot;,            &quot;Condition&quot;: &#123;                &quot;ForAnyValue:IpAddress&quot;: &#123;                    &quot;aws:SourceIp&quot;: [                        &quot;1.1.1.1/32&quot;                    ]                &#125;            &#125;        &#125;    ]&#125;EOFaws iam create-policy --policy-name s3-$&#123;S3BucketName&#125;-role --description &quot;For role use only!!!!!!!!!!!!&quot; --policy-document  file://s3-program.ruleaws iam create-policy --policy-name s3-$&#123;S3BucketName&#125;-local --description &quot;Limit the source IP!!!!!!!!!!!!&quot; --policy-document file://s3-local.ruleecho &quot;ç¨‹åºç”¨æˆ·è§„åˆ™: s3-$&#123;S3BucketName&#125;-role å·²ç”Ÿæˆ&quot;echo &quot;æœ¬åœ°ç”¨æˆ·è§„åˆ™ï¼šs3-$&#123;S3BucketName&#125;-local å·²ç”Ÿæˆ&quot;echo &quot;è¯·å°† local è§„åˆ™å…³è”åˆ°å¯¹åº”ä¸ªäººç”¨æˆ·æˆ–ç»„&quot;echo &quot;è¯·å°† role è§„åˆ™å…³è”åˆ°è§’è‰²&quot;</code></pre><h3 id="ç”Ÿå‘½å‘¨æœŸè§„åˆ™-s3-lifecycle-json">ç”Ÿå‘½å‘¨æœŸè§„åˆ™ s3-lifecycle.json</h3><blockquote><p>è§„åˆ™è¯´æ˜ï¼š</p><ol><li>æ‰€æœ‰å¯¹è±¡ï¼Œ30å¤©ä¹‹åè½¬ä¸ºONEZONE_IA;</li><li>logs å‰ç¼€å•ç‹¬å®šä¹‰ï¼š<ul><li>days è·¯å¾„ä¸‹çš„å¯¹è±¡ä¿å­˜å¯¹åº”çš„å¤©æ•°</li><li>longlasting è·¯å¾„ä¸‹çš„å¯¹è±¡æ°¸ä¹…ä¿å­˜ï¼Œä½†æ˜¯ 90 å¤©ä¹‹åçš„å¯¹è±¡è½¬æ¢ä¸º GLACIER</li></ul></li></ol></blockquote><pre><code class="language-shell">&#123;  &quot;Rules&quot;: [      &#123;          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;&quot;          &#125;,           &quot;Status&quot;: &quot;Enabled&quot;,           &quot;Transitions&quot;: [              &#123;                  &quot;Days&quot;: 30,                   &quot;StorageClass&quot;: &quot;ONEZONE_IA&quot;              &#125;          ],           &quot;NoncurrentVersionTransitions&quot;: [              &#123;                  &quot;NoncurrentDays&quot;: 30,                   &quot;StorageClass&quot;: &quot;ONEZONE_IA&quot;              &#125;          ],           &quot;ID&quot;: &quot;30days_onezone_ia&quot;      &#125;,      &#123;          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/longlasting/&quot;          &#125;,           &quot;Status&quot;: &quot;Enabled&quot;,           &quot;Transitions&quot;: [              &#123;                  &quot;Days&quot;: 90,                   &quot;StorageClass&quot;: &quot;GLACIER&quot;              &#125;          ],           &quot;ID&quot;: &quot;logs_90day_glacier&quot;      &#125;,       &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;: 1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/7days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 7          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_7days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;:  1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/15days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 15          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_15days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;:  1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/30days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 30          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_30days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;: 1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/60days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 60          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_60days_before&quot;      &#125;,      &#123;          &quot;Status&quot;: &quot;Enabled&quot;,          &quot;NoncurrentVersionExpiration&quot;: &#123;              &quot;NoncurrentDays&quot;: 1          &#125;,          &quot;Filter&quot;: &#123;              &quot;Prefix&quot;: &quot;logs/90days/&quot;          &#125;,          &quot;Expiration&quot;: &#123;              &quot;Days&quot;: 90          &#125;,          &quot;AbortIncompleteMultipartUpload&quot;: &#123;              &quot;DaysAfterInitiation&quot;: 7          &#125;,          &quot;ID&quot;: &quot;logs_delete_90days_before&quot;      &#125;  ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aws </tag>
            
            <tag> s3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerâ˜01å®‰è£…</title>
      <link href="posts/b7cf7b1f/"/>
      <url>posts/b7cf7b1f/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¾èµ–">ä¾èµ–</h3><pre><code class="language-bash">yum install -y yum-utils \  device-mapper-persistent-data \  lvm2</code></pre><h3 id="ä»“åº“">ä»“åº“</h3><pre><code class="language-bash:">yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repo</code></pre><p>ğŸ’å¦‚æœä½ ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„é•œåƒï¼Œé‚£ä¹ˆåˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ”¹repoæ–‡ä»¶åœ°å€ï¼Œä¾‹å¦‚ï¼š<a href="https://download.docker.com/linux/centos/7/x86_64/stable/">https://download.docker.com/linux/centos/7/x86_64/stable/</a></p><h3 id="å®‰è£…">å®‰è£…</h3><pre><code class="language-bash">yum install docker-ce -y### å®‰è£… compose ï¼Œ å¯é€‰yum install python3-pip -ypip3 install docker-compose æˆ–è€… pip install docker-compose### å¼€æœºè‡ªå¯åŠ¨systemctl enable docker</code></pre><h3 id="ä¿®æ”¹-docker-é»˜è®¤æ•°æ®ç›®å½•">ä¿®æ”¹ docker é»˜è®¤æ•°æ®ç›®å½•</h3><pre><code class="language-bash">[[ -f /etc/docker/daemon.json ]] &amp;&amp; mv /etc/docker/daemon.json /etc/docker/daemon.json.default || &#123; mkdir -p /etc/docker/ &amp;&amp;  touch /etc/docker/daemon.json &#125;cat &gt;  /etc/docker/daemon.json &lt;&lt; EOF&#123;  &quot;registry-mirrors&quot;: [&quot;http://hub-mirror.c.163.com&quot;],  &quot;data-root&quot;: &quot;/export/docker-data-root&quot;&#125;EOF</code></pre><h3 id="å¯åŠ¨">å¯åŠ¨</h3><pre><code class="language-bash">systemctl start docker</code></pre><h3 id="é•œåƒåº“">é•œåƒåº“</h3><pre><code class="language-bash">docker hubquay.io</code></pre>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sâ˜01å¸¸è§æœ¯è¯­æ¦‚å¿µ</title>
      <link href="posts/aaf9b7/"/>
      <url>posts/aaf9b7/</url>
      
        <content type="html"><![CDATA[<h2 id="ç‰©ç†">ç‰©ç†</h2><ol><li><p>master æ˜¯ k8s çš„ä¸»èŠ‚ç‚¹ï¼Œè´Ÿè´£åè°ƒé›†ç¾¤ä¸­çš„æ‰€æœ‰æ´»åŠ¨ï¼Œä¾‹å¦‚è°ƒåº¦åº”ç”¨ç¨‹åºã€ç»´æŠ¤åº”ç”¨ç¨‹åºçš„æ‰€éœ€çŠ¶æ€ã€æ‰©å±•åº”ç”¨ç¨‹åºå’Œæ»šåŠ¨æ›´æ–°ã€‚</p></li><li><p>node æ˜¯ k8s çš„å·¥ä½œèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å®é™…è·‘å®¹å™¨çš„èŠ‚ç‚¹ã€‚</p></li></ol><h2 id="æœåŠ¡">æœåŠ¡</h2><p>master èŠ‚ç‚¹æœåŠ¡</p><ol><li>kube-apiserver æ˜¯ master èŠ‚ç‚¹æœåŠ¡ï¼Œ æ˜¯k8s çš„ api æœåŠ¡ï¼Œæ˜¯é›†ç¾¤å…¥å£ï¼Œæä¾› http rset æœåŠ¡ã€‚</li><li>kube-controller-manager æ˜¯ master èŠ‚ç‚¹æœåŠ¡ï¼Œç»´æŠ¤é›†ç¾¤çŠ¶æ€ï¼ˆæ•…éšœæ£€æµ‹/æ»šåŠ¨å‡çº§/nodeæ‰©å±•ç­‰ï¼‰ï¼Œæ˜¯é›†ç¾¤æ‰€æœ‰èµ„æºå¯¹è±¡çš„è‡ªåŠ¨åŒ–ä¸­å¿ƒã€‚</li><li>kube-scheduler æ˜¯è´Ÿè´£ pod çš„è°ƒåº¦, å³å¦‚ä½•å°† pod åˆ†å‘åˆ° node</li><li>etcd æ³¨å†Œä¸­å¿ƒï¼Œä¿å­˜é›†ç¾¤çŠ¶æ€ã€‚</li></ol><p>node èŠ‚ç‚¹æœåŠ¡</p><ol><li><p>kubelet æ˜¯èŠ‚ç‚¹ä»£ç†ç¨‹åºï¼Œéƒ¨ç½²åœ¨ node ä¸Šã€‚å®ƒæ˜¯k8s masterå’Œk8s nodeä¹‹é—´çš„çº½å¸¦ã€‚å¤„ç† pod åˆ›å»º/å¯åŠ¨/ç›‘æ§/é‡å¯/é”€æ¯ç­‰å·¥ä½œã€‚</p><p>å¼€å¯ register-node = true çš„æƒ…å†µä¸‹ ä¼šè‡ªåŠ¨å‘ apiserver æœåŠ¡æ³¨å†Œè‡ªå·±ã€‚</p></li><li><p>kube-proxy æ˜¯å®ç°nodeèŠ‚ç‚¹ä¸Šå„èµ„æºçš„é€šä¿¡</p></li></ol><h2 id="èµ„æº">èµ„æº</h2><ol><li><p>Namespace</p><p>å‘½åç©ºé—´æ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œèµ·åˆ°äº†éš”ç¦»ä½œç”¨ã€‚é€šè¿‡å®ƒï¼Œä½ å¯ä»¥æ‰¾åˆ°å®ƒå†…éƒ¨çš„å…¶å®ƒèµ„æºå¯¹è±¡ï¼Œä¾‹å¦‚ podï¼Œsvcï¼Œdeploymentç­‰</p></li><li><p>Pod</p><p>pod å†…åŒ…å«å¤šä¸ªå®¹å™¨ï¼Œæ‰€ä»¥å¤šä¸ªå®¹å™¨å…±äº«ä»¥ä¸‹èµ„æºã€‚</p><ul><li>PIDå‘½åç©ºé—´: podå†…çš„è¿›ç¨‹èƒ½äº’ç›¸çœ‹åˆ°PID</li><li>ç½‘ç»œå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªip (å”¯ä¸€)</li><li>IPCå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡</li><li>UTSå‘½åç©ºé—´: podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªä¸»æœºå (å”¯ä¸€)</li><li>å­˜å‚¨å·: podå¤šä¸ªå®¹å™¨å¯ä»¥å…±åŒè®¿é—®podå®šä¹‰çš„å­˜å‚¨å·</li></ul></li><li><p>Label</p><p>labelç”¨äºè¡¨ç¤ºèµ„æºï¼Œä»è€Œæ–¹ä¾¿çš„è¢«å…¶å®ƒèµ„æºæ‰¾åˆ°ã€‚å®ƒå¾ˆé‡è¦ã€‚</p><p>æ ‡ç­¾å®šä¹‰ <code>key: value</code></p><p>é€‰æ‹©å™¨: <code>key &lt;= !=&gt; value</code>  <code>key &lt;not&gt; in (value1, value2)</code></p><p>RC å’Œ Service é€šè¿‡ selector é€‰æ‹©å™¨æ¥é€‰æ‹© Pod å¯¹è±¡èŒƒå›´, ä»è€Œç²¾ç»†åŒ–çš„å°† Pod è¿›è¡Œåˆ†ç»„ã€‚</p></li><li><p>Deployment</p><p>æ— çŠ¶æ€å‰¯æœ¬é›†ã€‚ç”¨æ¥éƒ¨ç½²ä¸€ä¸ª pod ç»„ï¼Œå®ƒé€šè¿‡ ReplicaSet æ¥è¿›è¡Œç¼©æ”¾ï¼Œ å¹¶éœ€è¦ pod æ¨¡æ¿åˆ›å»º podï¼Œ éœ€è¦ Label ç›‘æ§ podã€‚Deployment é€šè¿‡ RC ä¸¥æ ¼æ‰§è¡Œé…ç½®æ‰€å®šä¹‰çš„podå‰¯æœ¬æ•°é‡ã€‚å¯ä»¥æ¯”å–»ä¸º aws çš„ç›®æ ‡ç»„æˆ–è€…nginxçš„upstreamç»„ã€‚</p></li><li><p>Satefulset</p><p>æœ‰çŠ¶æ€å‰¯æœ¬é›†ã€‚</p></li><li><p>Service</p><p>svc ç”¨æ¥æ„å»ºä¸€ä¸ªè´Ÿè½½é…ç½®ã€‚å¯ä»¥æ¯”å–»ä¸ºawsçš„elbå†…ç½‘è´Ÿè½½å‡è¡¡å™¨æˆ–è€…nginxçš„service proxyé…ç½®ã€‚</p><p>svc é€šè¿‡ pod å®šä¹‰çš„ label å‘ç°ä¸€ç»„ podã€‚è¿™äº› pod æœ¬èº«æœ‰ endpoint åœ°å€ã€‚</p><p>svc åˆ›å»ºåï¼Œä¼šæ‹¿åˆ°ä¸€ä¸ªé›†ç¾¤å†…éƒ¨ipå’Œdnsã€‚kube-proxy æœåŠ¡ä¼šå°† svc çš„ ip å’Œ pod çš„ endpoint åœ°å€å…³è”èµ·æ¥ã€‚</p><p>æœ€ç»ˆï¼Œå…¶å®ƒå®¹å™¨å¯ä»¥é€šè¿‡è¿™ä¸ªipå’Œdnsæ¥è®¿é—®svcå…³è”çš„podèµ„æºã€‚</p></li><li><p>Ingress</p><p>æ˜ å°„ä¸€ä¸ªç«¯å£åˆ°å®¿ä¸»ipï¼Œæä¾›æœåŠ¡çš„å¤–éƒ¨è®¿é—®</p></li></ol><h2 id="æœåŠ¡ç»„ä»¶æµç¨‹å›¾">æœåŠ¡ç»„ä»¶æµç¨‹å›¾</h2><blockquote><ul><li>apiserver è´Ÿè´£ etcd å­˜å‚¨çš„æ‰€æœ‰æ“ä½œï¼Œä¸”åªæœ‰ apiserver æ‰ç›´æ¥æ“ä½œ etcd é›†ç¾¤</li><li>apiserver å¯¹å†…ï¼ˆé›†ç¾¤ä¸­çš„å…¶ä»–ç»„ä»¶ï¼‰å’Œå¯¹å¤–ï¼ˆç”¨æˆ·ï¼‰æä¾›ç»Ÿä¸€çš„ REST APIï¼Œå…¶ä»–ç»„ä»¶å‡é€šè¿‡ apiserver è¿›è¡Œé€šä¿¡<ul><li>controller managerã€schedulerã€kube-proxy å’Œ kubelet ç­‰å‡é€šè¿‡ apiserver watch API ç›‘æµ‹èµ„æºå˜åŒ–æƒ…å†µï¼Œå¹¶å¯¹èµ„æºä½œç›¸åº”çš„æ“ä½œ</li><li>æ‰€æœ‰éœ€è¦æ›´æ–°èµ„æºçŠ¶æ€çš„æ“ä½œå‡é€šè¿‡ apiserver çš„ REST API è¿›è¡Œ</li></ul></li><li>apiserver ä¹Ÿä¼šç›´æ¥è°ƒç”¨ kubelet APIï¼ˆå¦‚ logs, exec, attach ç­‰ï¼‰ï¼Œé»˜è®¤ä¸æ ¡éªŒ kubelet è¯ä¹¦ï¼Œä½†å¯ä»¥é€šè¿‡ <code>--kubelet-certificate-authority</code> å¼€å¯ï¼ˆè€Œ GKE é€šè¿‡ SSH éš§é“ä¿æŠ¤å®ƒä»¬ä¹‹é—´çš„é€šä¿¡ï¼‰</li></ul></blockquote><p><img src="/posts/aaf9b7/image-20200823102314477.png" alt="image-20200823102314477"></p><p><img src="/posts/aaf9b7/image-20200823103640732.png" alt="image-20200823103640732"></p><blockquote><p>ä»¥ä¸€ä¸ªpodçš„æ„å»ºä¸ºä¾‹:</p><ul><li>ç”¨æˆ·é€šè¿‡ REST API åˆ›å»ºä¸€ä¸ª Pod</li><li>apiserver å°†å…¶å†™å…¥ etcd</li><li>scheduluer æ£€æµ‹åˆ°æœªç»‘å®š Node çš„ Podï¼Œå¼€å§‹è°ƒåº¦å¹¶æ›´æ–° Pod çš„ Node ç»‘å®š</li><li>kubelet æ£€æµ‹åˆ°æœ‰æ–°çš„ Pod è°ƒåº¦è¿‡æ¥ï¼Œé€šè¿‡ container runtime è¿è¡Œè¯¥ Pod</li><li>kubelet é€šè¿‡ container runtime å–åˆ° Pod çŠ¶æ€ï¼Œå¹¶æ›´æ–°åˆ° apiserver ä¸­</li></ul></blockquote><p><img src="/posts/aaf9b7/image-20200823102430144.png" alt="image-20200823102430144"></p>]]></content>
      
      
      <categories>
          
          <category> å®¹å™¨ </category>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®¹å™¨ </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqlâ˜å®‰è£….</title>
      <link href="posts/b824edd8/"/>
      <url>posts/b824edd8/</url>
      
        <content type="html"><![CDATA[<p><a href="https://hub.docker.com/_/mysql?tab=description">https://hub.docker.com/_/mysql?tab=description</a></p><pre><code class="language-bash">mkdir -p /export/docker-data-mysql/&#123;config,logs,mysql,mysql-files&#125;docker run --name mysql8 \-p 3306:3306 \--restart=always \--mount 'type=bind,src=/export/docker-data-mysql/config,dst=/etc/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/logs,dst=/var/log/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/mysql,dst=/var/lib/mysql' \--mount 'type=bind,src=/export/docker-data-mysql/mysql-files,dst=/var/lib/mysql-files' \-e MYSQL_ROOT_PASSWORD=123456 \-d mysql:8 \--character-set-server=utf8mb4 \--collation-server=utf8mb4_general_ci</code></pre><blockquote><p>-d mysql:5.6</p></blockquote><p>å¼€å¯è¿œç¨‹è®¿é—®</p><pre><code class="language-sql">alter user 'root'@'%' identified with mysql_native_password by '123456';</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜rds-mysqlå‚æ•°</title>
      <link href="posts/438aa722/"/>
      <url>posts/438aa722/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># ä¸‹åˆ—æ˜¯éé»˜è®¤å€¼character_set_client: utf8character_set_connection: utf8character_set_database: utf8character_set_filesystem: utf8character_set_results: utf8character_set_server: utf8collation_connection: utf8_general_cislow_query_log: 1long_query_time: 10log_output: FILE# ä¸‹åˆ—æ˜¯é»˜è®¤å€¼explicit_defaults_for_timestamp: '1'innodb_buffer_pool_size: '&#123;DBInstanceClassMemory*3/4&#125;'innodb_file_per_table: '1'innodb_flush_method: O_DIRECTbinlog_cache_size: '32768'binlog_format: MIXED</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rds </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜EC2å›½å†…å¤–ä¹‹é—´è¿ç§»</title>
      <link href="posts/2e304ad6/"/>
      <url>posts/2e304ad6/</url>
      
        <content type="html"><![CDATA[<ul><li><p>aws å›½å†…å’Œå›½å¤–ä¹‹é—´æ— æ³•ç›´æ¥å¤åˆ¶ AMIï¼Œæ‰€ä»¥ç»å’¨è¯¢ aws æŠ€æœ¯äººå‘˜ï¼Œå°±æœ‰äº†è¿™ä¹ˆä¸€é“æ‰‹å·¥é¥­ã€‚ã€‚ã€‚</p></li><li><p>å‘½ä»¤æ­¥éª¤å¦‚ä¸‹ï¼š</p><pre><code class="language-shell">#æºæœºå™¨ä¸Šï¼šdd if=/dev/æºæ ¹ç›˜ of=/éæ ¹æŒ‚è½½ç‚¹/æ–‡ä»¶A bs=1M#aws ECæœåŠ¡å™¨ä¸Šï¼šdd if=/æ–‡ä»¶A of=/dev/ç›˜B bs=1M oflag=direct#ç›˜Bæ‰“å¿«ç…§ï¼Œå†æ ¹æ®ç›˜Bå¿«ç…§ç”ŸæˆAMI</code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ec2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜åˆ©ç”¨cfæœåŠ¡åˆå§‹åŒ–awsç¯å¢ƒ</title>
      <link href="posts/ddc4c969/"/>
      <url>posts/ddc4c969/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å› å…¬å¸å°é¡¹ç›®å¤šï¼Œè´¦æˆ·å¤šï¼Œæ¯æ¬¡æ„å»ºawsåˆå§‹åŒ–ç¯å¢ƒå‡å¾ˆéº»çƒ¦ï¼Œä¸”æ¯ä¸ªäººæ“ä½œçš„æ—¶å€™ï¼Œæƒ³æ³•éƒ½ä¸ä¸€æ ·ï¼Œè§„åˆ™ä¸ç»Ÿä¸€ï¼Œå¯¼è‡´ç¯å¢ƒä¿¡æ¯æ— æ³•é€šç”¨.</p><p>æ‰€ä»¥å‡†å¤‡ä½¿ç”¨ cf æ¥æ„å»ºä¸€ä¸ªé€šç”¨æ¨¡æ¿ï¼Œä¿æŒç¯å¢ƒä¸€è‡´æ€§.</p><p>ä¹‹å‰ä¸€ç›´æ²¡æœ‰ä½¿ç”¨ï¼Œæ˜¯å› ä¸º cf æœ¬èº«ç¼–å†™ä¸æ˜¯å¤ªæ–¹ä¾¿ï¼Œç„¶è€Œæˆ‘ä½ä¼°äº† aws çš„ç‰›é€¼ï¼Œä»”ç»†çœ‹äº†æ–‡æ¡£æ‰çŸ¥é“ï¼Œ æœ‰ä¸ª cf æœ¬èº«æœ‰ä¸ªå †æ ˆï¼Œå¯ä»¥ç›´æ¥å¤åˆ»å½“å‰ç¯å¢ƒ.</p><p>è¿™ä¸ªå·¥å…·å°±æ˜¯ <code>cloudformer</code></p><p>å®˜æ–¹æ–‡æ¡£æ˜¯: <a href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/cfn-using-cloudformer.html#launch-cloudformer">https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/cfn-using-cloudformer.html#launch-cloudformer</a></p></blockquote><h2 id="é‚£ä¹ˆæ­¥éª¤æ¥äº†">é‚£ä¹ˆæ­¥éª¤æ¥äº†~</h2><ul><li><p>å…ˆé€šè¿‡ web æ§åˆ¶å°ç”Ÿæˆä¸€ä¸ªé€‚åˆæœ¬åœ°åŒ–çš„é€šç”¨ç¯å¢ƒï¼Œæ¯”å¦‚ vpcï¼Œå­ç½‘ï¼Œå®‰å…¨ç»„ï¼Œæ•°æ®åº“å­ç½‘ç»„ï¼Œå‚æ•°ç»„ï¼Œs3ä»¥åŠç›¸åº”çš„s3ç”Ÿå‘½å‘¨æœŸè§„åˆ™ç­‰ç­‰</p></li><li><p>æ„å»º cloudformer å †æ ˆï¼Œå¹¶é€šè¿‡ cloudformer æœåŠ¡ç”Ÿæˆå½“å‰ç¯å¢ƒæ¨¡æ¿</p></li><li><p>å°†å½“å‰ç¯å¢ƒæ¨¡æ¿çš„ä¸€äº›éé€šç”¨å†…å®¹ï¼Œæ¢æˆå˜é‡ï¼Œå¹¶æ„å»ºæˆ cf å‚æ•°æˆ–è€…è„šæœ¬</p></li><li><p>æœ€åé€šè¿‡æ‰§è¡Œè„šæœ¬ï¼Œå¹¶è¾“å…¥å˜é‡å€¼ï¼Œæ¥ç”Ÿæˆæ–°æ¨¡æ¿</p></li><li><p>åœ¨æ–°ç¯å¢ƒé‡Œè°ƒç”¨æ–°æ¨¡æ¿æ¥åˆå§‹åŒ–ç¯å¢ƒ</p></li></ul><h2 id="ä¸‹é¢æ˜¯æˆ‘è´´å‡ºçš„ä¸€ä¸ªåŸºç¡€ç¯å¢ƒç”Ÿæˆè„šæœ¬">ä¸‹é¢æ˜¯æˆ‘è´´å‡ºçš„ä¸€ä¸ªåŸºç¡€ç¯å¢ƒç”Ÿæˆè„šæœ¬</h2><ul><li><p>vpc: x.x.0.0/16</p></li><li><p>prod: x.x.128.0/17</p><ul><li>prod å­ç½‘é»˜è®¤æœ‰å››ä¸ª, åˆ†åˆ«æ˜¯ EC2 ä¸¤ä¸ªå¯ç”¨åŒº, Database ä¸¤ä¸ªå¯ç”¨åŒº</li></ul></li><li><p>qa: x.x.0.0/19</p><ul><li>qa å­ç½‘é»˜è®¤æœ‰å››ä¸ª, åˆ†åˆ«æ˜¯ EC2 ä¸¤ä¸ªå¯ç”¨åŒº, Database ä¸¤ä¸ªå¯ç”¨åŒº</li></ul></li><li><p>prod å’Œ qa é€šè¿‡å®‰å…¨ç»„æ¥åˆ†å‰²</p><ul><li><p>prod è§„åˆ™ç¤ºä¾‹å¦‚ä¸‹(qaä¸€æ ·):</p></li><li><p>Prod-EC2-common:</p><table><thead><tr><th>è§„åˆ™å</th><th>åè®®</th><th>å¼€æ”¾ç«¯å£</th><th>æºipæˆ–è€…å…¶å®ƒå®‰å…¨ç»„ID</th><th></th></tr></thead><tbody><tr><td>æ‰€æœ‰æµé‡</td><td>å…¨éƒ¨</td><td>å…¨éƒ¨</td><td>10.130.128.0/17</td><td></td></tr></tbody></table></li></ul><p>| SSH      | TCP  | 22       | ${src_allow_ssh_ip}  |      |</p><ul><li><p>Prod-Database-common:</p><table><thead><tr><th>è§„åˆ™å</th><th>åè®®</th><th>å¼€æ”¾ç«¯å£</th><th>æºipæˆ–è€…å…¶å®ƒå®‰å…¨ç»„ID</th><th></th></tr></thead><tbody><tr><td>è‡ªå®šä¹‰ TCP è§„åˆ™</td><td>TCP</td><td>1025 - 65535</td><td>${src_allow_rds_ip}</td><td></td></tr><tr><td>è‡ªå®šä¹‰ TCP è§„åˆ™</td><td>TCP</td><td>1025 - 65535</td><td>Prod-EC2-common-Group-ID</td><td></td></tr></tbody></table></li></ul></li><li><p>SNS é»˜è®¤é¢„è­¦ä¸»é¢˜</p></li><li><p>mysql å­ç½‘ç»„</p></li><li><p>redis å­ç½‘ç»„</p></li><li><p>s3ä»¥åŠåˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸè§„åˆ™</p></li><li><p>vpc è·¯ç”±è¡¨ä¸ä¼šæ·»åŠ é»˜è®¤è·¯ç”±, è¿˜è¯·è‡ªè¡Œæ·»åŠ (Internet ç½‘å…³ä¼šè‡ªåŠ¨ç”Ÿæˆ)</p></li></ul><pre><code class="language-bash">#!/bin/bash# æœ¬è„šæœ¬ç”¨æ¥ç”Ÿæˆä¸€ä»½åŸºç¡€ç¯å¢ƒçš„ cf æ¨¡æ¿# ç½‘ç»œAå’ŒBæ®µï¼Œä¾‹å¦‚ 10.10 é‚£ä¹ˆ vpc å°±æ˜¯ 10.10.0.0/16VpcCidrBlockAB=# å¤§åŒºåŒºåŸŸ, ä¾‹å¦‚ æ–°åŠ å¡ é‚£ä¹ˆåŒºåŸŸå°±å†™ ap-southeast-1Region=# é¡¹ç›®åï¼Œç”¨äºåŒºåˆ†èµ„æºä»¥åŠæ·»åŠ  Team æ ‡ç­¾ (åªèƒ½æ˜¯å­—æ¯æ•°å­—ç»„åˆ)TagTeamValue=# å…è®¸è®¿é—®EC2çš„22å·ç«¯å£çš„ip (æŒ‡çš„æ˜¯évpcå†…ç½‘)ï¼Œé€šå¸¸åº”è¯¥æ˜¯å ¡å’æœºæˆ–è€…å…¬å¸å¤–ç½‘src_allow_ssh_ip=# å…è®¸è®¿é—®æ•°æ®åº“ç«¯å£çš„ip (æŒ‡çš„æ˜¯évpcå†…ç½‘)ï¼Œé€šå¸¸åº”è¯¥æ˜¯å ¡å’æœºæˆ–è€…å…¬å¸å¤–ç½‘src_allow_rds_ip=# é»˜è®¤ SNS æœåŠ¡ä¸»ä½“å SNSThemeNameSNSThemeName=$&#123;TagTeamValue&#125;# é»˜è®¤ SNS æœåŠ¡ä¿¡æ¯æ¥æ”¶ç”¨æˆ·é‚®ç®±, cf æ¨¡æ¿æ‰§è¡Œå®Œåï¼Œéœ€è¦ç”¨æˆ·é‚®ç®±è¯»å–é‚®ä»¶è‡ªè¡Œç¡®è®¤æ¶ˆæ¯SNSEmail=# è®¾ç½® vpc ä»»æ„ä¸¤ä¸ªå¯ç”¨åŒº å­—æ¯æ ‡è¯†, æ¯”å¦‚ a bAvailabilityZoneOne=aAvailabilityZoneTwo=b######## æœ¬æ¨¡æ¿, ä¸ä¼šæ·»åŠ  vpc é»˜è®¤è·¯ç”±, è¯·è‡ªè¡ŒåŠ   #########cat &gt; cf-common.yml &lt;&lt; EOFAWSTemplateFormatVersion: 2010-09-09Resources:  vpc12345:    Type: 'AWS::EC2::VPC'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.0.0/16      InstanceTenancy: default      EnableDnsSupport: 'true'      EnableDnsHostnames: 'true'      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 84f85642-9390-4126-b347-95ca2ebf1c15  subnet0qa0database0$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.3.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-database-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 864ecf93-1ce6-4b4d-9b29-c3d89f07141b  subnet0prod0database0$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.131.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-database-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 7ef6daea-3bcd-4913-ab55-ba4f7bced319  subnet0qa0ec20$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.2.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-ec2-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: bc2b5a08-f7b8-4699-a7ba-5c9c6c021bd8  subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.4.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-database-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: b4738f0a-11a6-4d75-b9f0-a24072e53228  subnet0prod0ec20$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.129.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-ec2-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 2ffb24f6-49fd-4d3a-bdfe-69e90e228517  subnet0prod0ec20$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.128.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-ec2-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 9a2789fc-b7d2-4532-811b-be3455ab7d7d  subnet0qa0ec20$&#123;AvailabilityZoneOne&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.1.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneOne&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-qa-ec2-$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 5c6c2638-a7b5-4185-a7a3-08d5901c252a  subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;:    Type: 'AWS::EC2::Subnet'    Properties:      CidrBlock: $&#123;VpcCidrBlockAB&#125;.132.0/24      AvailabilityZone: $&#123;Region&#125;$&#123;AvailabilityZoneTwo&#125;      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-prod-database-$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 00a78a8b-fd72-4613-bf09-8319b876ba2b  igw088b65cb430bc5ca0:    Type: 'AWS::EC2::InternetGateway'    Properties:      Tags:        - Key: Name          Value: $&#123;TagTeamValue&#125;-internet-gw    Metadata:      'AWS::CloudFormation::Designer':        id: e60ac13b-274d-46db-ac2a-5afaf975e1eb  dopt8128ece5:    Type: 'AWS::EC2::DHCPOptions'    Properties:      DomainName: $&#123;Region&#125;.compute.internal      DomainNameServers:        - AmazonProvidedDNS    Metadata:      'AWS::CloudFormation::Designer':        id: 909e6481-ccca-40fe-a1b1-4abe15a2ba18  acl03e81a4f65756520d:    Type: 'AWS::EC2::NetworkAcl'    Properties:      VpcId: !Ref vpc12345    Metadata:      'AWS::CloudFormation::Designer':        id: 93e06538-fe9e-49a7-8549-e2efb97dfab7  dbsubnet$&#123;TagTeamValue&#125;prod:    Type: 'AWS::RDS::DBSubnetGroup'    Properties:      DBSubnetGroupDescription: $&#123;TagTeamValue&#125;-prod      SubnetIds:        - !Ref subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;        - !Ref subnet0prod0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 16096ba6-c5de-4a73-a083-07b2c0573362  dbsubnet$&#123;TagTeamValue&#125;qa:    Type: 'AWS::RDS::DBSubnetGroup'    Properties:      DBSubnetGroupDescription: $&#123;TagTeamValue&#125;-qa      SubnetIds:        - !Ref subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;        - !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 186893f8-59ef-4d56-880f-d62294d25780  dbpg$&#123;TagTeamValue&#125;prod:    Type: 'AWS::RDS::DBParameterGroup'    Properties:      Description: $&#123;TagTeamValue&#125;-prod-mysql5.6      Family: mysql8.0      Parameters:        binlog_cache_size: '32768'        binlog_format: MIXED        character_set_client: utf8mb4        character_set_connection: utf8mb4        character_set_database: utf8mb4        character_set_filesystem: utf8mb4        character_set_results: utf8mb4        character_set_server: utf8mb4        collation_connection: utf8mb4_general_ci        explicit_defaults_for_timestamp: '1'        innodb_buffer_pool_size: '&#123;DBInstanceClassMemory*3/4&#125;'        innodb_file_per_table: '1'        innodb_flush_method: O_DIRECT    Metadata:      'AWS::CloudFormation::Designer':        id: 87a954ed-d1b2-4626-87fe-f2515f4479b4  dbpg$&#123;TagTeamValue&#125;qa:    Type: 'AWS::RDS::DBParameterGroup'    Properties:      Description: $&#123;TagTeamValue&#125;-qa-mysql5.6      Family: mysql8.0      Parameters:        binlog_cache_size: '32768'        binlog_format: MIXED        character_set_client: utf8        character_set_connection: utf8        character_set_database: utf8        character_set_filesystem: utf8        character_set_results: utf8        character_set_server: utf8        collation_connection: utf8_general_ci        explicit_defaults_for_timestamp: '1'        innodb_buffer_pool_size: '&#123;DBInstanceClassMemory*3/4&#125;'        innodb_file_per_table: '1'        innodb_flush_method: O_DIRECT    Metadata:      'AWS::CloudFormation::Designer':        id: 6c4c2e1e-ec99-4e7f-b254-0f09145a0d87  cachesubnet$&#123;TagTeamValue&#125;databaseprod:    Type: 'AWS::ElastiCache::SubnetGroup'    Properties:      Description: '$&#123;TagTeamValue&#125;_prod'      SubnetIds:        - !Ref subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;        - !Ref subnet0prod0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: bdfb3d49-78d8-40df-84b6-63bf65616f5c  cachesubnet$&#123;TagTeamValue&#125;databaseqa:    Type: 'AWS::ElastiCache::SubnetGroup'    Properties:      Description: '$&#123;TagTeamValue&#125;_qa'      SubnetIds:        - !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;        - !Ref subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 70367616-0a11-4bc9-9373-a23be1690a59  topicIT:    Type: 'AWS::SNS::Topic'    Properties:      DisplayName: $&#123;SNSThemeName&#125;      Subscription:        - Endpoint: $&#123;SNSEmail&#125;          Protocol: email    Metadata:      'AWS::CloudFormation::Designer':        id: 343cc3f4-4380-47e5-850e-cc3fb560f22a  $&#123;TagTeamValue&#125;qacommon:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-qa-common      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  QA-EC2-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: d31db020-e702-41e5-8ccc-d71a5a26f565  $&#123;TagTeamValue&#125;prodcommon:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-prod-common      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  Prod-EC2-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: f54456ef-e984-4b00-b04d-64b16a2057ea  ITLinshi:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: IT-Linshi      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  I'm god    Metadata:      'AWS::CloudFormation::Designer':        id: 182b7e60-f895-4519-8845-4d32a8591340  $&#123;TagTeamValue&#125;proddatabase:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-prod-database      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  Prod-database-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: 44f0485a-2575-4eab-82b3-bc7507cd5820  $&#123;TagTeamValue&#125;qadatabase:    Type: 'AWS::EC2::SecurityGroup'    Properties:      GroupDescription: $&#123;TagTeamValue&#125;-qa-database      VpcId: !Ref vpc12345      Tags:        - Key: Name          Value:  QA-database-common,Don't modify me    Metadata:      'AWS::CloudFormation::Designer':        id: f903102a-c394-4301-a08d-5625293ac23f  snspolicyIT:    Type: 'AWS::SNS::TopicPolicy'    Properties:      Topics:        - !Ref topicIT      PolicyDocument:        Version: 2008-10-17        Id: __default_policy_ID        Statement:          - Sid: __default_statement_ID            Effect: Allow            Principal:              AWS: '*'            Action:              - 'SNS:GetTopicAttributes'              - 'SNS:SetTopicAttributes'              - 'SNS:AddPermission'              - 'SNS:RemovePermission'              - 'SNS:DeleteTopic'              - 'SNS:Subscribe'              - 'SNS:ListSubscriptionsByTopic'              - 'SNS:Publish'              - 'SNS:Receive'            Resource: !Ref topicIT            Condition:              StringEquals:                'AWS:SourceOwner': '705452591009'    Metadata:      'AWS::CloudFormation::Designer':        id: 66a45d1a-3c99-4ef8-9c4e-db9ba717e17e  acl1:    Type: 'AWS::EC2::NetworkAclEntry'    Properties:      CidrBlock: 0.0.0.0/0      Egress: 'true'      Protocol: '-1'      RuleAction: allow      RuleNumber: '100'      NetworkAclId: !Ref acl03e81a4f65756520d    Metadata:      'AWS::CloudFormation::Designer':        id: de76822e-cddc-40d9-ba6f-4de20d1188ec  acl2:    Type: 'AWS::EC2::NetworkAclEntry'    Properties:      CidrBlock: 0.0.0.0/0      Protocol: '-1'      RuleAction: allow      RuleNumber: '100'      NetworkAclId: !Ref acl03e81a4f65756520d    Metadata:      'AWS::CloudFormation::Designer':        id: eb6e0bf9-3c84-4991-a037-64e2a368650b  subnetacl1:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0ec20$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 2801f8a7-901b-43b6-b4d9-9275d5639b86  subnetacl2:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0ec20$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 67641cac-39f6-4ee1-8410-60eaba963c27  subnetacl3:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0ec20$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 4b480f9d-e7b8-4034-b253-1c254fd83758  subnetacl4:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 1792de63-b1da-4c31-bab9-9925de98de6c  subnetacl5:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0database0$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: e62f3e81-63f0-4f5e-b3e0-aa733ba6f323  subnetacl6:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0ec20$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 28228fcf-5649-4e5e-bf03-d636ca28bffe  subnetacl8:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0database0$&#123;AvailabilityZoneTwo&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: 00ab0d37-3e37-427e-ac06-e94663719fcf  subnetacl9:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0qa0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: ee93485d-3df4-416d-ab61-4f77c46441f1  subnetacl10:    Type: 'AWS::EC2::SubnetNetworkAclAssociation'    Properties:      NetworkAclId: !Ref acl03e81a4f65756520d      SubnetId: !Ref subnet0prod0database0$&#123;AvailabilityZoneOne&#125;    Metadata:      'AWS::CloudFormation::Designer':        id: a4208016-e7cf-4acf-a718-104a25fef4c3  gw1:    Type: 'AWS::EC2::VPCGatewayAttachment'    Properties:      VpcId: !Ref vpc12345      InternetGatewayId: !Ref igw088b65cb430bc5ca0    Metadata:      'AWS::CloudFormation::Designer':        id: 3071b8a9-f4ab-4d61-83d8-d2792481e135  dchpassoc1:    Type: 'AWS::EC2::VPCDHCPOptionsAssociation'    Properties:      VpcId: !Ref vpc12345      DhcpOptionsId: !Ref dopt8128ece5    Metadata:      'AWS::CloudFormation::Designer':        id: 69a63971-39fa-45c9-8a17-cc730730083d  ingress1:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qacommon      IpProtocol: '-1'      CidrIp: $&#123;VpcCidrBlockAB&#125;.0.0/19  ingress2:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      IpProtocol: '-1'      CidrIp: $&#123;VpcCidrBlockAB&#125;.128.0/17  ingress3:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;proddatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      SourceSecurityGroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      SourceSecurityGroupOwnerId: '705452591009'    Metadata:      'AWS::CloudFormation::Designer':        id: 8972689f-9301-4538-b493-bd1956559ecd  ingress4:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qadatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      SourceSecurityGroupId: !Ref $&#123;TagTeamValue&#125;qacommon      SourceSecurityGroupOwnerId: '705452591009'    Metadata:      'AWS::CloudFormation::Designer':        id: 236a8060-da9c-4be7-af29-fb6758a764a9  ingress5:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref ITLinshi      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  ingress6:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qacommon      IpProtocol: tcp      FromPort: '22'      ToPort: '22'      CidrIp: $&#123;src_allow_ssh_ip&#125;  ingress8:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      IpProtocol: tcp      FromPort: '22'      ToPort: '22'      CidrIp: $&#123;src_allow_ssh_ip&#125;  ingress11:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;proddatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      CidrIp: $&#123;src_allow_rds_ip&#125;  ingress14:    Type: 'AWS::EC2::SecurityGroupIngress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qadatabase      IpProtocol: tcp      FromPort: '1025'      ToPort: '65535'      CidrIp: $&#123;src_allow_rds_ip&#125;  egress1:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qacommon      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress2:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;prodcommon      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress3:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref ITLinshi      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress4:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;proddatabase      IpProtocol: '-1'      CidrIp: 0.0.0.0/0  egress5:    Type: 'AWS::EC2::SecurityGroupEgress'    Properties:      GroupId: !Ref $&#123;TagTeamValue&#125;qadatabase      IpProtocol: '-1'      CidrIp: 0.0.0.0/0Description: ''EOF</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ec2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx â˜ æ³›åŸŸå_å˜é‡æˆªå–</title>
      <link href="posts/78ceb386/"/>
      <url>posts/78ceb386/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash">server &#123;    listen       80;    listen       [::]:80;    server_name ~^(?&lt;userName&gt;.*)\.apple\.com\.cn$;    root /export/webapps/apple.com/$userName;    access_log  /var/log/nginx/access.log  main;    #å¼€å¯æµè§ˆå™¨é™æ€æ–‡ä»¶ç¼“å­˜    location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)$ &#123;        expires      3h;    &#125;        # https://&lt;username&gt;.apple.com/api -&gt; /export/webapps/apple.com/api.php #####    location ~* ^/(api|event_api)$ &#123;        root /export/webapps/apple.com;        rewrite ^/(.*)$ /$1.php break;        fastcgi_pass     127.0.0.1:9001;        fastcgi_index    index.php;        include      fastcgi.conf;        fastcgi_connect_timeout    600s;        fastcgi_send_timeout       600s;        fastcgi_read_timeout       600s;        fastcgi_buffers 8 256k;        fastcgi_buffer_size 256k;        fastcgi_busy_buffers_size 256k;        fastcgi_intercept_errors on;    &#125;        # https://&lt;username&gt;.apple.com/&lt;uri&gt; -&gt; /export/webapps/apple.com/&lt;username&gt;/&lt;uri&gt;.php    location ~* ^/[0-9a-zA-Z]+$ &#123;        rewrite ^/(.*)$ /$1.php break;        fastcgi_pass     127.0.0.1:9001;        fastcgi_index    index.php;        include      fastcgi.conf;        fastcgi_connect_timeout    600s;        fastcgi_send_timeout       600s;        fastcgi_read_timeout       600s;        fastcgi_buffers 8 256k;        fastcgi_buffer_size 256k;        fastcgi_busy_buffers_size 256k;        fastcgi_intercept_errors on;    &#125;&#125;</code></pre><blockquote><p>location ä¼˜å…ˆçº§ä»ä¸Šå¾€ä¸‹ä¾æ¬¡é€’å‡ï¼š<br>location =      ä»…åŒ¹é…å­—ç¬¦ä¸²è‡ªèº«<br>location ^~    åŒ¹é…æŸä¸ªå­—ç¬¦ä¸²å¼€å¤´çš„uri<br>location ~      æ­£åˆ™åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™<br>location ~*    æ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™<br>location /      è¡¨ç¤ºåŒ¹é…â€œåŸŸå/ä¹‹åçš„uriâ€ï¼Œå†æ¯”å¦‚localtion /imagesï¼Œè¡¨ç¤ºåŒ¹é…â€œåŸŸå/imagesä¹‹åçš„uri</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fpmâ˜å®‰è£…-ç¼–è¯‘æ–¹å¼</title>
      <link href="posts/3321a2dc/"/>
      <url>posts/3321a2dc/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ç”¨äºç¼–è¯‘å®‰è£…php7.1</p><h4 id="ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</h4><p>æ ¹ç›®å½•ï¼š/usr/local/php<br>æ—¥å¿—ç›®å½•ï¼š/usr/local/php/var/log -&gt; /export/logs/php</p><h4 id="è„šæœ¬åœ¨æ­¤">è„šæœ¬åœ¨æ­¤</h4><pre><code class="language-bash">#!/bin/bash# è„šæœ¬, é€‚ç”¨äº php 7.1basedir=/usr/local/srccd $basedirrunuser=`whoami`[[ $runuser == 'root' ]] || &#123;        echo &quot;ERROR:æ‰§è¡Œç”¨æˆ·ä¸æ˜¯$runuser&quot; &amp;&amp; exit&#125;#åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒ[[ -d /export/logs/php ]] || &#123;        echo &quot;/export/logs/phpç›®å½•ä¸å­˜åœ¨&quot; &amp;&amp; exit&#125;yum install libmcrypt-devel ncurses-devel recode-devel aspell-devel curl-devel readline-devel openldap-devel enchant-devel pcre-devel net-snmp-devel libicu-devel libtool-ltdl-devel libjpeg-devel libpng-devel libxml2-devel bzip2-devel freetype-devel gcc-c++ mysql-develcp -p /usr/lib64/libldap* /usr/libln -s /usr/lib64/mysql /usr/lib/mysqlwget http://sg2.php.net/distributions/php-7.1.25.tar.gz -O php.tar.gzrm -rf php &amp;&amp; mkdir phptar xf php.tar.gz --strip-components 1 -C phpcd php &amp;&amp; ./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --with-config-file-scan-dir=/usr/local/php/etc/php.d --with-curl --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl --enable-mbstring --with-freetype-dir --with-jpeg-dir --with-png-dir --with-gd --with-libxml-dir --with-zlib --with-mcrypt --with-bz2 --enable-sysvshm --enable-sysvsem --enable-soap --with-recode --with-snmp --with-readline --enable-intl --enable-dba --enable-bcmath --with-enchant --with-pspell --enable-xml --enable-sockets --enable-exif --enable-inline-optimization --enable-fpm || exitmake &amp;&amp; make install || exitcp sapi/fpm/init.d.php-fpm /etc/rc.d/init.d/php-fpmchkconfig --add php-fpmchkconfig php-fpm offchmod u+x /etc/rc.d/init.d/php-fpmcp php.ini-production /usr/local/php/etc/php.inicd /usr/local/php/var &amp;&amp; rm -rf logln -s /export/logs/php logcat&gt;&gt;/usr/local/php/etc/php.ini&lt;&lt;EOF; å…³é—­phpæ— ç”¨æ—¥å¿—ä¿¡æ¯error_reporting = E_COMPILE_ERROR|E_RECOVERABLE_ERROR|E_ERROR|E_CORE_ERROR; å¼€å¯php opcache ç¼“å­˜åŠŸèƒ½[opcache]zend_extension=opcache.so; å¯åŠ¨æ“ä½œç ç¼“å­˜opcache.enable=1; é’ˆå¯¹æ”¯æŒCLIç‰ˆæœ¬PHPå¯åŠ¨æ“ä½œç ç¼“å­˜ ä¸€èˆ¬è¢«ç”¨æ¥æµ‹è¯•å’Œè°ƒè¯•opcache.enable_cli=0; å…±äº«å†…å­˜å¤§å°ï¼Œå•ä½ä¸ºMBopcache.memory_consumption=128; å­˜å‚¨ä¸´æ—¶å­—ç¬¦ä¸²ç¼“å­˜å¤§å°ï¼Œå•ä½ä¸ºMBï¼ŒPHP5.3.0ä»¥å‰ä¼šå¿½ç•¥æ­¤é¡¹é…ç½®opcache.interned_strings_buffer=8; ç¼“å­˜æ–‡ä»¶æ•°æœ€å¤§é™åˆ¶ï¼Œå‘½ä¸­ç‡ä¸åˆ°100%ï¼Œå¯ä»¥è¯•ç€æé«˜è¿™ä¸ªå€¼opcache.max_accelerated_files=4000; ä¸€å®šæ—¶é—´å†…æ£€æŸ¥æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´, è¿™é‡Œè®¾ç½®æ£€æŸ¥çš„æ—¶é—´å‘¨æœŸ, é»˜è®¤ä¸º 2, å•ä½ä¸ºç§’opcache.revalidate_freq=60; å¼€å¯å¿«é€Ÿåœæ­¢ç»­å‘äº‹ä»¶ï¼Œä¾èµ–äºZendå¼•æ“çš„å†…å­˜ç®¡ç†æ¨¡å—ï¼Œä¸€æ¬¡é‡Šæ”¾å…¨éƒ¨è¯·æ±‚å˜é‡çš„å†…å­˜ï¼Œè€Œä¸æ˜¯ä¾æ¬¡é‡Šæ”¾å†…å­˜å—opcache.fast_shutdown=1;å¯ç”¨æ£€æŸ¥ PHP è„šæœ¬å­˜åœ¨æ€§å’Œå¯è¯»æ€§çš„åŠŸèƒ½ï¼Œæ— è®ºæ–‡ä»¶æ˜¯å¦å·²ç»è¢«ç¼“å­˜ï¼Œéƒ½ä¼šæ£€æŸ¥æ“ä½œç ç¼“å­˜,å¯ä»¥æå‡æ€§èƒ½ã€‚ ä½†æ˜¯å¦‚æœç¦ç”¨äº† opcache.validate_timestampsé€‰é¡¹ï¼Œ å¯èƒ½å­˜åœ¨è¿”å›è¿‡æ—¶æ•°æ®çš„é£é™©ã€‚opcache.enable_file_override=1EOFcat&gt;&gt;/usr/local/php/etc/php-fpm.conf&lt;&lt;EOF[global]log_level =errordaemonize = yesevents.mechanism = epollrlimit_files = 10240emergency_restart_threshold = 60emergency_restart_interval = 60s[fcgi]user = webappsgroup = webappslisten = 0.0.0.0:9000pm = staticpm.max_children = 100pm.max_requests = 1024request_slowlog_timeout = 1sslowlog = /usr/local/php/var/log/php-slow.logpm.status_path = /php-fpm_statusEOF</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> fpm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlabâ˜å®‰è£…å’Œå¤‡ä»½</title>
      <link href="posts/d4de86f1/"/>
      <url>posts/d4de86f1/</url>
      
        <content type="html"><![CDATA[<blockquote><p><a href="https://docs.gitlab.com/omnibus/docker/">https://docs.gitlab.com/omnibus/docker/</a></p></blockquote><h2 id="å®‰è£…">å®‰è£…</h2><pre><code class="language-bash"># ç¡®ä¿ /export å­˜åœ¨# createdomainName=docker run --detach   --hostname $&#123;domainName&#125;   --publish 443:443 --publish 80:80 --publish 2222:22   --name gitlab   --restart always   --volume /export/gitlab/config:/etc/gitlab   --volume /export/gitlab/logs:/var/log/gitlab   --volume /export/gitlab/data:/var/opt/gitlab   gitlab/gitlab-ce:latest# startdocker start gitlab# stopdocker stop gitlab# update (å¤§ç‰ˆæœ¬å‡çº§å¯èƒ½å¤±è´¥ï¼Œç‰¹åˆ«æ˜¯æ•°æ®åº“ä¹Ÿå‡çº§çš„æƒ…å†µä¸‹)docker stop gitlabdocker rm gitlabdocker pull gitlab/gitlab-ce:latestdocker run --detach   --hostname $&#123;domainName&#125;  --publish 443:443 --publish 80:80 --publish 2222:22   --name gitlab   --restart always   --volume /export/gitlab/config:/etc/gitlab   --volume /export/gitlab/logs:/var/log/gitlab   --volume /export/gitlab/data:/var/opt/gitlab   gitlab/gitlab-ce:latest</code></pre><h2 id="åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</h2><pre><code class="language-bash"># configure# https://docs.gitlab.com/omnibus/settings/README.htmlcp /export/gitlab/config/gitlab.rb /export/gitlab/config/gitlab.rb.bak</code></pre><pre><code class="language-bash">## /export/gitlab/config/gitlab.rb# å†³å®šå„ä¸ªä½ç½® url é“¾æ¥å†…å®¹external_url 'http://$&#123;domainName&#125;'# å†³å®šå„ä¸ªä½ç½® ssh é“¾æ¥å†…å®¹gitlab_rails['gitlab_shell_ssh_port'] = 2222gitlab_rails['gitlab_email_enabled'] = truegitlab_rails['gitlab_email_from'] = 'ew@xxx.com'gitlab_rails['gitlab_email_display_name'] = 'GitLab Admin'gitlab_rails['gitlab_email_reply_to'] = 'ew@xxx.com'gitlab_rails['gitlab_email_subject_suffix'] = 'GitLab'gitlab_rails['smtp_enable'] = truegitlab_rails['smtp_address'] = &quot;smtp.gmail.com&quot;gitlab_rails['smtp_port'] = 587gitlab_rails['smtp_user_name'] = &quot;ew@xxx.com&quot;gitlab_rails['smtp_password'] = &quot;&quot;gitlab_rails['smtp_domain'] = &quot;smtp.gmail.com&quot;gitlab_rails['smtp_authentication'] = &quot;login&quot;gitlab_rails['smtp_enable_starttls_auto'] = truegitlab_rails['smtp_tls'] = falsegitlab_rails['smtp_openssl_verify_mode'] = 'peer'</code></pre><h2 id="å¤‡ä»½é…ç½®">å¤‡ä»½é…ç½®</h2><p>å¤‡ä»½åˆ°AWS-S3ï¼Œrole æˆæƒ</p><pre><code class="language-bash">## /export/gitlab/config/gitlab.rbgitlab_rails['backup_upload_connection'] = &#123;  'provider' =&gt; 'AWS',  'region' =&gt; '&lt;region-id&gt;',  #'aws_access_key_id' =&gt; 'AKIAKIAKI',  #'aws_secret_access_key' =&gt; 'secret123'  # If using an IAM Profile, don't configure aws_access_key_id &amp; aws_secret_access_key  'use_iam_profile' =&gt; true&#125;# å¤‡ä»½åˆ°S3ä¸Šçš„æ ¹è·¯å¾„ bucket/Path gitlab_rails['backup_upload_remote_directory'] = '&lt;æ¡¶å&gt;/backup/gitlab'</code></pre><p>å¤‡ä»½åˆ°é˜¿é‡Œäº‘-OSSï¼ŒAKæˆæƒï¼Œæš‚ä¸æ”¯æŒ role æˆæƒ</p><pre><code class="language-bash">## /export/gitlab/config/gitlab.rbgitlab_rails['backup_upload_connection'] = &#123;'provider' =&gt; 'aliyun','aliyun_accesskey_id' =&gt; 'AKIAKIAKI','aliyun_accesskey_secret' =&gt; 'secret123','aliyun_oss_bucket' =&gt; '&lt;æ¡¶å&gt;','aliyun_region_id' =&gt; '&lt;region-id&gt;','aliyun_oss_endpoint' =&gt; 'http://oss-cn-zhangjiakou-internal.aliyuncs.com'&#125;gitlab_rails['backup_upload_remote_directory'] = 'backup/gitlab'</code></pre><h2 id="å¤‡ä»½è®¡åˆ’ï¼Œè§¦å‘å¤‡ä»½">å¤‡ä»½è®¡åˆ’ï¼Œè§¦å‘å¤‡ä»½</h2><ol><li>é˜¿é‡Œäº‘ ï¼ˆroleæˆæƒï¼‰</li></ol><pre><code class="language-bash"># é…ç½® role åˆ°æœåŠ¡å™¨ä¸Šcat &gt; /etc/profile.d/ecs_role.sh &lt;&lt; EOFRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`ramRoleName=`curl -sq http://100.100.100.200/latest/meta-data/ram/security-credentials/`aliyun configure set --profile ecsRamRoleProfile  --mode EcsRamRole --ram-role-name $&#123;ramRoleName&#125; --region $&#123;Region&#125;EOF</code></pre><p>â€‹æ·»åŠ è„šæœ¬åˆ°crontab</p><pre><code class="language-bash">#!/bin/bashsource /etc/profile.d/ecs_role.shRegion=`curl -sq http://100.100.100.200/latest/meta-data/region-id`Endpoint=&quot;http://oss-$&#123;Region&#125;-internal.aliyuncs.com&quot;basedir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`cd $basedirTime=`date +%Y%m%d`docker exec -t gitlab gitlab-backup createtar zcf $&#123;Time&#125;.config.tar.gz /export/gitlab/configaliyun oss cp $&#123;Time&#125;.config.tar.gz oss://æ¡¶å/backup/gitlab/ -e $&#123;Endpoint&#125; --force</code></pre><ol start="2"><li><p>aws (roleæˆæƒ)</p><p>æ·»åŠ è„šæœ¬åˆ°crontab</p></li></ol><pre><code class="language-bash">#!/bin/bashbasedir=`cd &quot;$(dirname &quot;$0&quot;)&quot;; pwd`cd $basedirTime=`date +%Y%m%d`docker exec -t gitlab gitlab-backup createtar zcf $&#123;Time&#125;.config.tar.gz /export/gitlab/configaws s3 cp $&#123;Time&#125;.config.tar.gz s3://æ¡¶å/backup/gitlab/</code></pre><h2 id="é‡è½½é…ç½®æœåŠ¡">é‡è½½é…ç½®æœåŠ¡</h2><p>docker exec -it gitlab gitlab-ctl reconfigure</p>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜EC2-GPUå®ä¾‹å®‰è£…æ˜¾å¡é©±åŠ¨</title>
      <link href="posts/2e07203a/"/>
      <url>posts/2e07203a/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä»¥ä¸‹å‘½ä»¤å‡åœ¨ ubuntu ç”¨æˆ·ä¸­æ‰§è¡Œ</p></blockquote><h2 id="å®‰è£…-awscli-åˆ°-ubuntu-ç”¨æˆ·ä¸‹">å®‰è£… awscli åˆ° ubuntu ç”¨æˆ·ä¸‹</h2><pre><code class="language-bash:">sudo apt-get update -ysudo apt-get install python3-pip -ypip3 install awscli --upgrade --user</code></pre><h2 id="æ›´æ–°ç³»ç»Ÿå†…æ ¸å’Œgccï¼Œä»¥åŠç¦ç”¨å¼€æºé©±åŠ¨">æ›´æ–°ç³»ç»Ÿå†…æ ¸å’Œgccï¼Œä»¥åŠç¦ç”¨å¼€æºé©±åŠ¨</h2><pre><code class="language-bash:">sudo apt-get upgrade -y linux-awssudo rebootsudo apt-get install -y gcc make linux-headers-$(uname -r)cat &lt;&lt; EOF | sudo tee --append /etc/modprobe.d/blacklist.confblacklist vga16fbblacklist nouveaublacklist rivafbblacklist nvidiafbblacklist rivatvEOFsudo vi /etc/default/grub     GRUB_CMDLINE_LINUX=&quot;rdblacklist=nouveau&quot;sudo update-grubsudo reboot</code></pre><h2 id="é…ç½®-aws-key-æ‹‰å–-G3-ç³»åˆ—é©±åŠ¨">é…ç½® aws key æ‹‰å– G3 ç³»åˆ—é©±åŠ¨</h2><pre><code class="language-bash:">aws configure# æ ¹æ®æç¤ºè¾“å…¥ç›¸å…³æ•°æ®ï¼Œè¿™é‡Œ aws key å¯ä»¥ç”¨ä»»æ„ iam ç”¨æˆ·çš„</code></pre><h2 id="ä¸‹è½½-G3-é©±åŠ¨">ä¸‹è½½ G3 é©±åŠ¨</h2><pre><code class="language-bash:"># G3å®ä¾‹ç›´æ¥ä»awsåº“é‡Œä¸‹è½½ï¼Œå…¶å®ƒéœ€è¦è‡ªè¡Œå»å®˜ç½‘ä¸‹è½½https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/install-nvidia-driver.html#obtain-nvidia-GRID-driver-linuxaws s3 cp --recursive s3://ec2-linux-nvidia-drivers/latest/ .</code></pre><h2 id="å®‰è£…é©±åŠ¨">å®‰è£…é©±åŠ¨</h2><pre><code class="language-bash:">sudo /bin/sh ./NVIDIA-Linux-x86_64*.run# å¯èƒ½ä¼šå‡ºç° gcc ç‰ˆæœ¬æ£€æµ‹ï¼Œå¿½ç•¥æ‰ç‰ˆæœ¬æ£€æµ‹ï¼Œç›´æ¥å®‰è£…sudo reboot</code></pre><h2 id="å¯ç”¨-GRUD-è™šæ‹Ÿåº”ç”¨ç¨‹åºï¼Œé»˜è®¤å¯ç”¨-GRUD-è™šæ‹Ÿå·¥ä½œç«™">å¯ç”¨ GRUD è™šæ‹Ÿåº”ç”¨ç¨‹åºï¼Œé»˜è®¤å¯ç”¨ GRUD è™šæ‹Ÿå·¥ä½œç«™</h2><pre><code class="language-bash:"># å…·ä½“æ­¥éª¤çœ‹æ–‡æ¡£https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/activate_grid.html</code></pre><h2 id="ä¼˜åŒ–G3ï¼Œå¼€å¯å…¨åŠŸç‡ï¼Œå…³é—­autoboost-ï¼ˆP3-å®ä¾‹ä¸Šçš„-GPU-ä¸æ”¯æŒ-autoboost-åŠŸèƒ½ã€‚ï¼‰">ä¼˜åŒ–G3ï¼Œå¼€å¯å…¨åŠŸç‡ï¼Œå…³é—­autoboost ï¼ˆP3 å®ä¾‹ä¸Šçš„ GPU ä¸æ”¯æŒ autoboost åŠŸèƒ½ã€‚ï¼‰</h2><pre><code class="language-bash:">sudo nvidia-persistencedsudo nvidia-smi --auto-boost-default=0# P2 å®ä¾‹ï¼šsudo nvidia-smi -ac 2505,875# P3 å®ä¾‹ï¼šsudo nvidia-smi -ac 877,1530# G3 å®ä¾‹ï¼šsudo nvidia-smi -ac 2505,1177</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aws </tag>
            
            <tag> ubuntu </tag>
            
            <tag> gpu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fpmâ˜é™æ€é…ç½®</title>
      <link href="posts/d1d65c30/"/>
      <url>posts/d1d65c30/</url>
      
        <content type="html"><![CDATA[<blockquote><p>QPS 800-1000</p><p>2*4 æœºå™¨</p></blockquote><pre><code class="language-ini">[www01]user = webappsgroup = webappslisten = /usr/local/php/var/log/php-fpm-www01.socklisten.owner = webappslisten.group = webappslisten.backlog = 10240listen.mode = 0666listen.allowed_clients = 127.0.0.1pm = staticpm.max_children = 300pm.max_requests = 1024request_slowlog_timeout = 1request_terminate_timeout = 1slowlog = /usr/local/php/var/log/php-slow.logpm.status_path = /php-fpm_status</code></pre>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
          <category> fpm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php-fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openvpnâ˜å®‰è£…</title>
      <link href="posts/7c1abbe1/"/>
      <url>posts/7c1abbe1/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>openvpn ä¸€èˆ¬ç”¨äºå°å…¬å¸è¿œç¨‹è¿æ¥å…¬å¸åŠå…¬ç½‘ç»œç¯å¢ƒï¼Œæ­¤è„šæœ¬éœ€è¦ä¸€ä¸ªlinuxç³»ç»Ÿçš„ä¸»æœºã€‚<br>è‡³äºåœŸè±ªå…¬å¸ï¼Œå¯ä»¥æ— è§†ã€‚<br>æ–‡æ¡£åŒ…å«å®‰è£…è„šæœ¬ï¼Œåˆ›å»ºç”¨æˆ·è„šæœ¬ï¼Œåˆ é™¤ç”¨æˆ·è„šæœ¬ã€‚ä½¿ç”¨çš„æ—¶å€™ï¼Œå®‰è£…è„šæœ¬å’Œåˆ›å»ºç”¨æˆ·è„šæœ¬ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹ä¸€äº›å˜é‡ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‘ç°ç§»åŠ¨ç½‘ç»œè¿æ¥å…¶å®ƒè¿è¥å•†ç½‘ç»œçš„æ—¶å€™ï¼Œä¸ç¨³å®šã€‚<br>æ¯”å¦‚æˆ‘è¿™è¾¹ï¼Œç§»åŠ¨ç½‘ç»œè¿æ¥ç”µä¿¡ç½‘ç»œï¼ˆopenvpnæ‰€åœ¨ç½‘ç»œï¼‰ï¼Œå°±å®¹æ˜“ä¸¢åŒ…ã€‚</p></blockquote><h4 id="å®‰è£…è„šæœ¬">å®‰è£…è„šæœ¬</h4><pre><code class="language-bash:">yum install dockerdocker pull kylemanna/openvpnOVPN_DATA=&quot;/root/ovpn-data&quot;IP=&quot;æœºå™¨å¤–ç½‘ipæˆ–è€…natåçš„å†…ç½‘ip&quot;  # è‡ªè¡Œä¿®æ”¹mkdir $&#123;OVPN_DATA&#125;docker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u tcp://$&#123;IP&#125;docker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpkidocker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full CLIENTNAME nopassdocker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient CLIENTNAME &gt; $&#123;OVPN_DATA&#125;/CLIENTNAME.ovpndocker run --name openvpn -v $&#123;OVPN_DATA&#125;:/etc/openvpn -d -p 1194:1194 --privileged kylemanna/openvpn</code></pre><h4 id="åˆ›å»ºç”¨æˆ·è„šæœ¬">åˆ›å»ºç”¨æˆ·è„šæœ¬</h4><pre><code class="language-bash:">#!/bin/bash# å¦‚æœæ˜¯natåçš„å†…ç½‘ipï¼Œåˆ™éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶é‡Œçš„ipä¸ºå¤–ç½‘ip# bash xxx.sh &lt;ç”¨æˆ·å&gt;[[ -z $1 ]] &amp;&amp; exitCLIENTNAME=$1#read -p 'è¾“å…¥ç”¨æˆ·åï¼ˆå­—æ¯ç»„æˆï¼‰:' CLIENTNAMEOVPN_DATA=&quot;/root/ovpn-data&quot;docker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full $&#123;CLIENTNAME&#125; nopassdocker run -v $&#123;OVPN_DATA&#125;:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient $CLIENTNAME &gt; $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i '1a comp-lzo' $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i '2a tun-mtu 1500' $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i '3a auth-nocache' $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpnsed -i &quot;s/$&#123;æœ¬æœºip&#125;/$&#123;å¤–ç½‘ip&#125;/&quot; $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpn  # è‹¥ä¸ºnatç¯å¢ƒï¼Œè‡ªè¡Œä¿®æ”¹ï¼Œè‹¥ä¸æ˜¯natç¯å¢ƒï¼Œæ³¨é‡Šæ‰æœ¬è¡Œmkdir -pv $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;mv /root/ovpn-data/pki/private/$&#123;CLIENTNAME&#125;.key $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;mv /root/ovpn-data/pki/issued/$&#123;CLIENTNAME&#125;.crt $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;mv $&#123;OVPN_DATA&#125;/$&#123;CLIENTNAME&#125;.ovpn $&#123;OVPN_DATA&#125;/users/$&#123;CLIENTNAME&#125;cd $&#123;OVPN_DATA&#125;/users/tar zcf $&#123;CLIENTNAME&#125;.tar.gz $&#123;CLIENTNAME&#125;sz $&#123;CLIENTNAME&#125;.tar.gz</code></pre><h4 id="åˆ é™¤ç”¨æˆ·è„šæœ¬">åˆ é™¤ç”¨æˆ·è„šæœ¬</h4><pre><code class="language-bash:">#!/bin/bash# bash xxx.sh &lt;ç”¨æˆ·å&gt;[[ -z $1 ]] &amp;&amp; exitCLIENTNAME=$1#read -p 'è¾“å…¥ç”¨æˆ·åï¼ˆå­—æ¯ç»„æˆï¼‰:' CLIENTNAMEOVPN_DATA=&quot;/root/ovpn-data&quot;rm -rf /root/ovpn-data/pki/private/$&#123;CLIENTNAME&#125;.key*rm -rf /root/ovpn-data/pki/reqs/$&#123;CLIENTNAME&#125;.reqrm -rf /root/ovpn-data/pki/issued/$&#123;CLIENTNAME&#125;.crtsed -i &quot;/$&#123;CLIENTNAME&#125;/d&quot; /root/ovpn-data/pki/index.txtcd /root/ovpn-data/usersrm -rf $&#123;CLIENTNAME&#125;rm -f $&#123;CLIENTNAME&#125;.tar.gz</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¶å®ƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å®‰è£… </tag>
            
            <tag> openvpn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜è°ƒæ•´å†…æ ¸å‚æ•°</title>
      <link href="posts/28361833/"/>
      <url>posts/28361833/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>redis å†…å­˜å ç”¨çˆ†ç‚¸. æ‰€ä»¥ç½‘ä¸Šæ‰¾äº†ä¸€ä¸ª</p><pre><code class="language-python"># encoding: utf-8&quot;&quot;&quot;author: yangyi@youzan.comtime: 2018/4/26 ä¸‹åˆ4:34func: è·å–æ•°æ®åº“ä¸­æ²¡æœ‰è®¾ç½®ttlçš„ key&quot;&quot;&quot;import redisimport argparseimport timeimport sysclass ShowProcess:    &quot;&quot;&quot;    æ˜¾ç¤ºå¤„ç†è¿›åº¦çš„ç±»    è°ƒç”¨è¯¥ç±»ç›¸å…³å‡½æ•°å³å¯å®ç°å¤„ç†è¿›åº¦çš„æ˜¾ç¤º    &quot;&quot;&quot;    i = 0 # å½“å‰çš„å¤„ç†è¿›åº¦    max_steps = 0 # æ€»å…±éœ€è¦å¤„ç†çš„æ¬¡æ•°    max_arrow = 100 # è¿›åº¦æ¡çš„é•¿åº¦    # åˆå§‹åŒ–å‡½æ•°ï¼Œéœ€è¦çŸ¥é“æ€»å…±çš„å¤„ç†æ¬¡æ•°    def __init__(self, max_steps):        self.max_steps = max_steps        self.i = 0    # æ˜¾ç¤ºå‡½æ•°ï¼Œæ ¹æ®å½“å‰çš„å¤„ç†è¿›åº¦iæ˜¾ç¤ºè¿›åº¦    # æ•ˆæœä¸º[&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;]100.00%    def show_process(self, i = None):        if i is not None:            self.i = i        else:            self.i += 1        num_arrow = int(self.i * self.max_arrow / self.max_steps) # è®¡ç®—æ˜¾ç¤ºå¤šå°‘ä¸ª'&gt;'        num_line = self.max_arrow - num_arrow # è®¡ç®—æ˜¾ç¤ºå¤šå°‘ä¸ª'-'        percent = self.i * 100.0 / self.max_steps # è®¡ç®—å®Œæˆè¿›åº¦ï¼Œæ ¼å¼ä¸ºxx.xx%        process_bar = '[' + '&gt;' * num_arrow + ' ' * num_line + ']'\                      + '%.2f' % percent + '%' + '\r' # å¸¦è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼Œ'\r'è¡¨ç¤ºä¸æ¢è¡Œå›åˆ°æœ€å·¦è¾¹        sys.stdout.write(process_bar) # è¿™ä¸¤å¥æ‰“å°å­—ç¬¦åˆ°ç»ˆç«¯        sys.stdout.flush()    def close(self, words='done'):        print ''        print words        self.i = 0def check_ttl(redis_conn, no_ttl_file, dbindex):    start_time = time.time()    no_ttl_num = 0    keys_num = redis_conn.dbsize()    print &quot;there are &#123;num&#125; keys in db &#123;index&#125; &quot;.format(num=keys_num, index=dbindex)    process_bar = ShowProcess(keys_num)    with open(no_ttl_file, 'a') as f:        for key in redis_conn.scan_iter(count=1000):            process_bar.show_process()            if redis_conn.ttl(key) == -1:                no_ttl_num += 1    #            if no_ttl_num &lt; 1000:                f.write(key+'\n')            else:                continue    process_bar.close()    print &quot;cost time(s):&quot;, time.time() - start_time    print &quot;no ttl keys number:&quot;, no_ttl_num    print &quot;we write keys with no ttl to the file: %s&quot; % no_ttl_filedef main():    parser = argparse.ArgumentParser()    parser.add_argument('-p', type=int, dest='port', action='store', help='port of redis ')    parser.add_argument('-d', type=str, dest='db_list', action='store', default=0,                        help='ex : -d all / -d 1,2,3,4 ')    args = parser.parse_args()    port = args.port    if args.db_list == 'all':        db_list = [i for i in xrange(0, 16)]    else:        db_list = [int(i) for i in args.db_list.split(',')]    for index in db_list:        try:            pool = redis.ConnectionPool(host='127.0.0.1', port=port, db=index)            r = redis.StrictRedis(connection_pool=pool)        except redis.exceptions.ConnectionError as e:            print e        else:            no_ttl_keys_file = &quot;/tmp/&#123;port&#125;_&#123;db&#125;_no_ttl_keys.txt&quot;.format(port=port, db=index)            check_ttl(r, no_ttl_keys_file, index)if __name__ == '__main__':    main()</code></pre><ol><li>è¯·å‹¿åœ¨redisæœåŠ¡å™¨ä¸Šæ‰§è¡Œ</li><li>ä¿®æ”¹è„šæœ¬ä¸­ 127.0.0.1 ä¸º redis æœåŠ¡å™¨åœ°å€</li><li>è„šæœ¬æ‰§è¡Œå‘½ä»¤: <code>python nottlkey.py -d all -p 6379  </code></li><li>æ·»åŠ ttlå‘½ä»¤ï¼š<code>cat no_ttl_keys.txt  |  xargs -i -t ./redis-cli -h &lt;redis_ip&gt; -n &lt;database_num&gt; expire &lt;ttl_time&gt;</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisâ˜è°ƒæ•´å†…æ ¸å‚æ•°</title>
      <link href="posts/28361833/"/>
      <url>posts/28361833/</url>
      
        <content type="html"><![CDATA[<h4 id="å‰è¨€">å‰è¨€</h4><p>ä¹‹å‰å®‰è£…å®Œredisï¼Œå¯åŠ¨redisï¼Œæ€»ä¼šå‘Šè¯‰ä½ è®©ä½ é»˜è®¤ä¿®æ”¹ä¸€äº›å‚æ•°ï¼Œä¸çŸ¥å…¶åŸå› ï¼Œä½†æ¯æ¬¡éƒ½æ‹›åŠã€‚<br>åæ¥é‡åˆ°ä¸€äº›rediså†…å­˜ä½¿ç”¨ç´§å¼ çš„æ—¶å€™ï¼Œä»è€Œå¯¼è‡´ redis-bgsave å¤±è´¥ï¼Œå†ä¸€æ¬¡æƒ³åˆ°äº†è¿™ä¸ªé—®é¢˜ã€‚<br>ç»è¿‡æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°å®˜æ–¹æ–‡æ¡£é‡Œå‘Šè¯‰äº†åŸå› ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚å¦‚æœ‰ä¸å¯¹ä¹‹å¤„ï¼Œè¿˜è¯·æŒ‡å‡ºã€‚</p><h4 id="æˆ‘æ˜¯é—®é¢˜">æˆ‘æ˜¯é—®é¢˜</h4><p>redis-bgsaveä¸overcommit_memoryçš„å…³ç³»ã€‚<br>å½“å‰©ä½™ç‰©ç†å†…å­˜ä½äºå½“å‰redisæ‰€ç”¨å†…å­˜çš„æ—¶å€™ï¼Œovercommit_memory=1çš„æ„ä¹‰</p><h4 id="å®˜æ–¹è§£é‡Šåœ¨æ­¤">å®˜æ–¹è§£é‡Šåœ¨æ­¤</h4><blockquote><p><a href="https://redis.io/topics/faq">https://redis.io/topics/faq</a></p></blockquote><h2 id="Background-saving-fails-with-a-fork-error-under-Linux-even-if-I-have-a-lot-of-free-RAM">Background saving fails with a fork() error under Linux even if I have a lot of free RAM!</h2><p>Short answer: : <code>echo 1 &gt; /proc/sys/vm/overcommit_memory</code></p><p>And now the long one:</p><p>Redis background saving schema relies on the copy-on-write semantic of fork in modern operating systems: Redis forks (creates a child process) that is an exact copy of the parent. The child process dumps the DB on disk and finally exits. In theory the child should use as much memory as the parent being a copy, but actually thanks to the copy-on-write semantic implemented by most modern operating systems the parent and child process will <em>share</em> the common memory pages. A page will be duplicated only when it changes in the child or in the parent. Since in theory all the pages may change while the child process is saving, Linux canâ€™t tell in advance how much memory the child will take, so if the setting is set to zero fork will fail unless there is as much free RAM as required to really duplicate all the parent memory pages, with the result that if you have a Redis dataset of 3 GB and just 2 GB of free memory it will fail.<code>overcommit_memory</code></p><p>Setting to 1 tells Linux to relax and perform the fork in a more optimistic allocation fashion, and this is indeed what you want for Redis.<code>overcommit_memory</code></p><p>A good source to understand how Linux Virtual Memory works and other alternatives for and is this classic from Red Hat Magazine, <a href="https://people.redhat.com/nhorman/papers/rhel3_vm.pdf">â€œUnderstanding Virtual Memoryâ€</a>. You can also refer to the <a href="http://man7.org/linux/man-pages/man5/proc.5.html">proc(5)</a> man page for explanations of the available values.<code>overcommit_memory``overcommit_ratio</code></p><h4 id="ç¿»è¯‘åçš„å¤§è‡´æ„æ€">ç¿»è¯‘åçš„å¤§è‡´æ„æ€</h4><p>å®˜æ–¹çš„FAQï¼Œç»™äººä¸€ç§è¿™ä¹ˆä¸ªæ„æ€ã€‚ å¦‚æœä½ ä¸è®¾ç½®overcommit_memory=1ï¼Œé‚£ä¹ˆCOWæœºåˆ¶å°†æ— æ³•ä½¿ç”¨ï¼Œæ‰€ä»¥å½“ç©ºä½™å†…å­˜å°äºå½“å‰rediså ç”¨å†…å­˜æ—¶ï¼Œredis-bgsave å› ä¸ºæ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œå°†å¯¼è‡´åˆ†é…å†…å­˜å¤±è´¥ã€‚<br>è€ŒCOWæœºåˆ¶çš„æ„æ€å°±æ˜¯ï¼šçˆ¶å­è¿›ç¨‹å…¬ç”¨å†…å­˜é¡µï¼Œå› æ­¤åªä¼šcopyå˜åŒ–çš„æ•°æ®ã€‚å› æ­¤ï¼Œåœ¨COWæœºåˆ¶ä¸‹ï¼Œredis-bgsaveåªéœ€è¦ç”³è¯·åˆ°æ”¯æ’‘å˜åŒ–æ•°æ®çš„å†…å­˜å³å¯ã€‚<br>è‡³äºæ˜¯å¦æ˜¯å› ä¸ºå¯ç”¨ overcommit_memory=1 ä»è€Œä½¿å¾—COWæœºåˆ¶èµ·ä½œç”¨ï¼Œé™äºè¿™æ˜¯å†…æ ¸å±‚é¢çš„ä¸œè¥¿</p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®åº“ </category>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> ä¼˜åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜s3è·¨è´¦æˆ·è®¿é—®</title>
      <link href="posts/7cac5d21/"/>
      <url>posts/7cac5d21/</url>
      
        <content type="html"><![CDATA[<ul><li>è§„åˆ™å¦‚ä¸‹ï¼š</li></ul><pre><code class="language-:">å­˜å‚¨æ¡¶ç­–ç•¥,æˆæƒå…¶å®ƒè´¦æˆ·çš„æŸä¸ª iam èµ„æºè®¿é—®æ­¤å­˜å‚¨æ¡¶arn:aws:iam::&lt;aws_account_id&gt;:&lt;type&gt;/&lt;name&gt;</code></pre><ul><li>ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š</li></ul><pre><code class="language-json:">&#123;    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Id&quot;: &quot;Policy1564021125924&quot;,    &quot;Statement&quot;: [        &#123;            &quot;Sid&quot;: &quot;object1&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Principal&quot;: &#123;                &quot;AWS&quot;: &quot;arn:aws:iam::&lt;account-id&gt;:role/&lt;role-name&gt;&quot;            &#125;,            &quot;Action&quot;: [                &quot;s3:Get*&quot;,                &quot;s3:List*&quot;            ],            &quot;Resource&quot;: &quot;arn:aws:s3:::&lt;open-bucket&gt;/&lt;open-path&gt;/*&quot;        &#125;    ]&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cloudformer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>awsâ˜rds-mysqlæ—¥å¿—</title>
      <link href="posts/604c5952/"/>
      <url>posts/604c5952/</url>
      
        <content type="html"><![CDATA[<h2 id="å¸¸è§„-é”™è¯¯-æ…¢-æ—¥å¿—">å¸¸è§„/é”™è¯¯/æ…¢/æ—¥å¿—</h2><pre><code class="language-bash"># ä¿®æ”¹å‚æ•°ç»„slow_query_logï¼šè¦åˆ›å»ºæ…¢é€ŸæŸ¥è¯¢æ—¥å¿—ï¼Œè¯·è®¾ç½®ä¸º 1ã€‚é»˜è®¤å€¼ä¸º 0ã€‚general_log(ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—)ï¼šè¦åˆ›å»ºå¸¸è§„æ—¥å¿—ï¼Œè¯·è®¾ç½®ä¸º 1ã€‚é»˜è®¤å€¼ä¸º 0ã€‚</code></pre><p>long_query_timeï¼šè¦é˜²æ­¢åœ¨æ…¢é€ŸæŸ¥è¯¢æ—¥å¿—ä¸­è®°å½•å¿«é€Ÿè¿è¡Œçš„æŸ¥è¯¢ï¼Œè¯·æŒ‡å®šéœ€è¦è®°å½•çš„æœ€çŸ­æŸ¥è¯¢æ‰§è¡Œæ—¶é—´å€¼ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚é»˜è®¤å€¼ä¸º 10 ç§’ï¼›æœ€å°å€¼ä¸º 0ã€‚<br>å¦‚æœ log_output = FILEï¼Œåˆ™å¯ä»¥æŒ‡å®šç²¾ç¡®åˆ°å¾®ç§’çš„æµ®ç‚¹å€¼, å³å¯è®°å½• 0.1s<br>å¦‚æœ log_output = TABLEï¼Œåˆ™å¿…é¡»æŒ‡å®šç²¾ç¡®åˆ°ç§’çš„æ•´æ•°å€¼ã€‚<br>ç³»ç»Ÿåªè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ long_query_time å€¼çš„æŸ¥è¯¢ã€‚</p><p>log_queries_not_using_indexes(ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—)ï¼šè¦å°†æ‰€æœ‰ä¸ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢è®°å½•åˆ°æ…¢é€ŸæŸ¥è¯¢æ—¥å¿—ï¼Œè¯·è®¾ç½®ä¸º 1ã€‚é»˜è®¤å€¼ä¸º 0ã€‚å°†è®°å½•ä¸ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢ï¼Œå³ä½¿å®ƒä»¬çš„æ‰§è¡Œæ—¶é—´å°äº long_query_time å‚æ•°çš„å€¼ã€‚</p><p>log_output optionï¼šæ‚¨å¯ä¸º log_output å‚æ•°æŒ‡å®šä¸‹åˆ—é€‰é¡¹ä¹‹ä¸€ã€‚</p><p>TABLEï¼ˆé»˜è®¤, ä¸å»ºè®®, å½±å“æ•°æ®åº“æœ¬èº«æ€§èƒ½ï¼‰â€“ å°†ä¸€èˆ¬æŸ¥è¯¢å†™å…¥ mysql.general_log è¡¨ï¼Œå°†æ…¢é€ŸæŸ¥è¯¢å†™å…¥ mysql.slow_log è¡¨ã€‚</p><p>FILE(æ¨è,ä¹Ÿæ˜¯å¿…é¡»,å¦åˆ™æ— æ³•æ¨é€åˆ°cloudwatch)â€“ å°†ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—å’Œæ…¢é€ŸæŸ¥è¯¢æ—¥å¿—å†™å…¥æ–‡ä»¶ç³»ç»Ÿã€‚æ—¥å¿—æ–‡ä»¶æ¯å°æ—¶è½®æ¢ä¸€æ¬¡ã€‚é»˜è®¤è®°å½•24å°æ—¶.</p><p>NONEâ€“ ç¦ç”¨æ—¥å¿—è®°å½•</p><h2 id="å®¡è®¡æ—¥å¿—">å®¡è®¡æ—¥å¿—</h2><pre><code># ä¿®æ”¹é€‰é¡¹ç»„, æ·»åŠ é¢å¤–é€‰é¡¹MARIADB_AUDIT_PLUGIN </code></pre><h2 id="äºŒè¿›åˆ¶æ—¥å¿—">äºŒè¿›åˆ¶æ—¥å¿—</h2><blockquote><p>äºŒè¿›åˆ¶æ—¥å¿—ä¸€èˆ¬æˆ‘ä»¬ç”¨æ¥æ¢å¤æ•°æ®, é»˜è®¤ rds ä¼šå°½é‡é”€æ¯äºŒè¿›åˆ¶æ—¥å¿—, æ¥ä¿ç•™ç£ç›˜å¯ç”¨ç©ºé—´.</p><p>äºŒè¿›åˆ¶æ—¥å¿—é»˜è®¤æ ¼å¼æ˜¯   mixed</p></blockquote><p>é…ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„æ–¹æ³•:</p><pre><code class="language-bash"># å°†äºŒè¿›åˆ¶æ—¥å¿—ä¿ç•™24å°æ—¶call mysql.rds_set_configuration('binlog retention hours', 24);</code></pre><p>è®¿é—®äºŒè¿›åˆ¶æ—¥å¿—çš„æ–¹æ³•å¦‚ä¸‹:</p><pre><code class="language-bash">mysqlbinlog \    --read-from-remote-server \    --host=&lt;mysql_rds_instance_address&gt; \    --port=&lt;mysql_port&gt; \    --user ReplUser \    --password \    --raw \    --result-file=/tmp/ \    binlog.00098</code></pre><blockquote><ul><li><p>æŒ‡å®š  <code>--read-from-remote-server</code>  é€‰é¡¹ã€‚</p></li><li><p><code>--host</code>ï¼šæŒ‡å®šè¯¥å®ä¾‹æ‰€åœ¨çš„ç»ˆç«¯èŠ‚ç‚¹ä¸­çš„ DNS åç§°ã€‚</p></li><li><p><code>--port</code>ï¼šæŒ‡å®šè¯¥å®ä¾‹ä½¿ç”¨çš„ç«¯å£ã€‚</p></li><li><p><code>--user</code>ï¼šæŒ‡å®šå·²æˆäºˆäº†å¤åˆ¶ä»å±å®ä¾‹æƒé™çš„ MySQL ç”¨æˆ·ã€‚</p></li><li><p><code>--password</code>ï¼šæŒ‡å®šç”¨æˆ·çš„å¯†ç ï¼Œæˆ–å¿½ç•¥å¯†ç å€¼ä»¥è®©å®ç”¨ç¨‹åºæç¤ºæ‚¨è¾“å…¥å¯†ç ã€‚</p></li><li><p>è¦æŒ‰äºŒè¿›åˆ¶æ ¼å¼ä¸‹è½½æ–‡ä»¶ï¼Œè¯·æŒ‡å®š  <code>--raw</code>  é€‰é¡¹ã€‚</p></li><li><p><code>--result-file</code>ï¼šæŒ‡å®šç”¨äºæ¥æ”¶åŸå§‹è¾“å‡ºçš„æœ¬åœ°æ–‡ä»¶ã€‚</p></li><li><p>æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„åç§°ã€‚è¦è·å–å¯ç”¨æ—¥å¿—çš„åˆ—è¡¨ï¼Œè¯·ä½¿ç”¨ SQL å‘½ä»¤ SHOW BINARY LOGSã€‚</p></li><li><p>è¦æµå¼ä¼ è¾“äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œè¯·æŒ‡å®š  <code>--stop-never</code>  é€‰é¡¹ã€‚</p></li></ul></blockquote><hr><h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£:</h2><ol><li><a href="https://docs.aws.amazon.com/zh_cn/AmazonRDS/latest/UserGuide/USER_LogAccess.Concepts.MySQL.html#Appendix.MySQL.CommonDBATasks.Logs">https://docs.aws.amazon.com/zh_cn/AmazonRDS/latest/UserGuide/USER_LogAccess.Concepts.MySQL.html#Appendix.MySQL.CommonDBATasks.Logs</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å…¬æœ‰äº‘ </category>
          
          <category> aws </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rds </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>web â˜ ç³»ç»ŸåŸºæœ¬ä¼˜åŒ–</title>
      <link href="posts/f41d0763/"/>
      <url>posts/f41d0763/</url>
      
        <content type="html"><![CDATA[<pre><code class="language-bash"># å†…æ ¸å‚æ•°# ç³»ç»Ÿçº§åˆ«ä¸Šé™ï¼Œ å³æ•´ä¸ªç³»ç»Ÿæ‰€æœ‰è¿›ç¨‹å•ä½æ—¶é—´å¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡fs.file-max = 6553500# ä¸‰æ¬¡æ¡æ‰‹è¯·æ±‚é¢‘æ¬¡net.ipv4.tcp_syn_retries = 5# æ”¾å¼ƒå›åº”ä¸€ä¸ªTCPè¯·æ±‚ä¹‹å‰ï¼Œéœ€è¦å°è¯•å¤šå°‘æ¬¡net.ipv4.tcp_retries1 = 3# ä¸‰æ¬¡æ¡æ‰‹åº”ç­”é¢‘æ¬¡net.ipv4.tcp_synack_retries = 2# ä¸‰æ¬¡æ¡æ‰‹å®Œæ¯•ï¼Œ æ²¡æœ‰æ•°æ®æ²Ÿé€šçš„æƒ…å†µä¸‹ï¼Œ ç©ºè¿æ¥å­˜æ´»æ—¶é—´net.ipv4.tcp_keepalive_time = 60# æ¢æµ‹æ¶ˆæ¯å‘é€æ¬¡æ•°net.ipv4.tcp_keepalive_probes = 3# æ¢æµ‹æ¶ˆæ¯å‘é€é—´éš”æ—¶é—´net.ipv4.tcp_keepalive_intvl = 15net.ipv4.tcp_retries2 = 5net.ipv4.tcp_fin_timeout = 5# ç³»ç»Ÿå¤„ç†ä¸å±äºä»»ä½•è¿›ç¨‹çš„TCPé“¾æ¥net.ipv4.tcp_orphan_retries = 3net.ipv4.tcp_max_orphans = 35000# åœ¨æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚net.core.netdev_max_backlog = 10240# å¯¹äºè¿˜æœªè·å¾—å¯¹æ–¹ç¡®è®¤çš„è¿æ¥è¯·æ±‚ï¼Œå¯ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­çš„æœ€å¤§æ•°ç›®net.ipv4.tcp_max_syn_backlog = 10240# å®šä¹‰äº†ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç«¯å£æœ€å¤§çš„ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦ net.core.somaxconn=10240#æœ€å¤§timewaitæ•°net.ipv4.tcp_max_tw_buckets = 20000net.ipv4.ip_local_port_range=1024 65500# å¼€å¯æ—¶é—´æˆ³net.ipv4.tcp_timestamps=1# é’ˆå¯¹å®¢æˆ·ç«¯æœ‰æ•ˆï¼Œå¿…é¡»åœ¨å¼€å¯æ—¶é—´æˆ³çš„å‰æä¸‹net.ipv4.tcp_tw_reuse = 1# å¼€å¯ iptables åï¼Œ é“¾è·¯è¿½è¸ªä¸Šé™å’Œè¶…æ—¶æ—¶é—´, è‹¥æ²¡æœ‰ä½¿ç”¨ iptablesï¼Œåˆ™æ— æ•ˆnet.netfilter.nf_conntrack_max = 6553500net.netfilter.nf_conntrack_tcp_timeout_established = 150## tcpæ ˆå†…å­˜ä½¿ç”¨ï¼Œ å•ä½æ˜¯å†…å­˜é¡µï¼Œ ä¸€é¡µ=4KB#net.ipv4.tcp_mem = 524288 786432 1310720## socketè¯»å†™ç¼“å†²åŒºå¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚#net.ipv4.tcp_rmem = 4096 4096 16777216#net.ipv4.tcp_wmem = 4096 4096 16777216##æœ€ä½å†…å­˜å’Œç¼“å†²åŒºå›æ”¶å€¾å‘ï¼ˆæ­¤å‚æ•°æœ‰ä¸€å®šé£é™©ï¼‰#vm.min_free_kbytes=409600#vm.vfs_cache_pressure=200</code></pre><pre><code class="language-bash">#ä¿®æ”¹/etc/security/limits.conf# å•ä¼šè¯çº§åˆ«ï¼Œå¯æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸Šé™* soft nofile 655350* hard nofile 655350# å•ä¼šè¯çº§åˆ«ï¼Œ å¯æ‰“å¼€çš„æ‰€æœ‰è¿›ç¨‹ä¸Šé™* soft nproc 10240* hard nproc 10240</code></pre><blockquote><h5 id="å¼€å¯iptableså-æŸ¥çœ‹å½“å‰é“¾è·¯è¡¨æ•°é‡å‘½ä»¤">å¼€å¯iptableså, æŸ¥çœ‹å½“å‰é“¾è·¯è¡¨æ•°é‡å‘½ä»¤</h5><p>$ sysctl net.netfilter.nf_conntrack_count</p><p>net.netfilter.nf_conntrack_count = 601032</p><h5 id="æŸ¥çœ‹è¿æ¥æ•°æœ€é«˜çš„10ä¸ªIPï¼šå¯ä»¥æŸ¥å°æŸä¸ªip-æˆ–è€…åˆ¤æ–­æ˜¯è°å¯¼è‡´çš„">æŸ¥çœ‹è¿æ¥æ•°æœ€é«˜çš„10ä¸ªIPï¼šå¯ä»¥æŸ¥å°æŸä¸ªip, æˆ–è€…åˆ¤æ–­æ˜¯è°å¯¼è‡´çš„</h5><p>$ awk -Fâ€™=â€™ â€˜{c[$2]++}END{for ( i in c) print i,c[i]}â€™ /proc/net/nf_conntrack | head -10</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shellâ˜ifåˆ¤å®š</title>
      <link href="posts/241ce96c/"/>
      <url>posts/241ce96c/</url>
      
        <content type="html"><![CDATA[<pre><code>-a FILEï¼šå­˜åœ¨åˆ™ä¸ºçœŸï¼›å¦åˆ™åˆ™ä¸ºå‡ï¼›-e FILE: å­˜åœ¨åˆ™ä¸ºçœŸï¼›å¦åˆ™åˆ™ä¸ºå‡ï¼›-f FILE: å­˜åœ¨å¹¶ä¸”ä¸ºæ™®é€šæ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-d DIR: å­˜åœ¨å¹¶ä¸”ä¸ºç›®å½•ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-L/-h FILE: å­˜åœ¨å¹¶ä¸”ä¸ºç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-b: å­˜åœ¨å¹¶ä¸”ä¸ºå—è®¾å¤‡ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡ï¼›-c: å­˜åœ¨å¹¶ä¸”ä¸ºå­—ç¬¦è®¾å¤‡ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡-S: å­˜åœ¨å¹¶ä¸”ä¸ºå¥—æ¥å­—æ–‡ä»¶ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡-p: å­˜åœ¨å¹¶ä¸”ä¸ºå‘½åç®¡é“ï¼Œåˆ™ä¸ºçœŸï¼›å¦åˆ™ä¸ºå‡-s FILE: å­˜åœ¨å¹¶ä¸”ä¸ºéç©ºæ–‡ä»¶åˆ™ä¸ºå€¼ï¼Œå¦åˆ™ä¸ºå‡ï¼›-r FILEï¼šæ–‡ä»¶å¯è¯»ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡-w FILEï¼šæ–‡ä»¶å¯å†™ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡</code></pre>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxâ˜dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› </title>
      <link href="posts/a3dfc0e8/"/>
      <url>posts/a3dfc0e8/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-â˜-dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› ">linux â˜ dfä¸duæ•°æ®ä¸ä¸€è‡´çš„åŸå› </h2><ul><li><h3 id="é—®é¢˜è¡¨ç°ï¼š">é—®é¢˜è¡¨ç°ï¼š</h3></li></ul><p>df æ•°æ®æ¯” du æ•°æ®å°ï¼Œè€Œä¸”æ˜¯å‘ç”Ÿåœ¨åˆ é™¤æ–‡ä»¶ä¹‹åã€‚</p><hr><p>è¿™ä¸ªé—®é¢˜ç‰µæ‰¯åˆ° linux ç³»ç»Ÿæ˜¯å°†å¦‚ä½•ç¡®è®¤å’Œå›æ”¶æ•°æ®çš„.</p><ul><li><h3 id="ç©ºé—´æ˜¯å¦‚ä½•è¢«åˆ¤å®šå ç”¨çš„">ç©ºé—´æ˜¯å¦‚ä½•è¢«åˆ¤å®šå ç”¨çš„</h3></li></ul><p>linuxæ–‡ä»¶ç³»ç»Ÿåˆ¤å®šç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œæ˜¯æŸ¥çœ‹ç©ºé—´çš„ imap æ˜¯å¦ä¸º1ï¼Œè€Œ imap æ˜¯å¦ä¸º1ï¼Œåˆ™å–å†³äºå ç”¨ç©ºé—´çš„æ–‡ä»¶çš„ inode èŠ‚ç‚¹çš„ Links æ˜¯å¦ä¸º0ã€‚è€Œæ¯å½“ç¨‹åºè°ƒç”¨æ–‡ä»¶ä¸”æ²¡æœ‰å…³é—­ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶çš„ inode çš„ Links å°±ä¼šåŠ  1ã€‚</p><p>å¦‚æœ Links ä¸ä¸º0ï¼Œåˆ™ imap å°±ä¸ä¼šæ˜¯ 0 ï¼Œåˆ™è¿™ä»½ç©ºé—´å°±æ— æ³•è¢«å†æ¬¡è°ƒç”¨.<br>å¦å¤–ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé»˜è®¤ inode  Links æ˜¯1</p><ul><li><h3 id="ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„">ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„</h3></li></ul><p>æ–‡ä»¶ç³»ç»Ÿé¦–å…ˆåœ¨çˆ¶ç›®å½•æ–‡ä»¶é‡Œæ‰¾åˆ°æ‰€è¦åˆ é™¤çš„æ–‡ä»¶åï¼Œå°†æ­¤æ–‡ä»¶ä¿¡æ¯ä»çˆ¶ç›®å½•é‡Œæ¸…é™¤æ‰ï¼Œå¦‚è‹¥æ¸…é™¤åï¼ŒLinks ä¸º0 ï¼Œåˆ™åˆ é™¤ inode èŠ‚ç‚¹ï¼Œå°† imap å°±ç½®ä¸º0ï¼Œç©ºé—´å¯ä»¥å†æ¬¡è¢«åˆ©ç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœçˆ¶ç›®å½•æ–‡ä»¶ä¿¡æ¯æ¸…é™¤åï¼Œæœ‰ç¨‹åºåœ¨è°ƒç”¨æ–‡ä»¶ï¼Œåˆ™ Links ä¸ä¸º0ï¼Œé‚£ä¹ˆ inode æ— æ³•è¢«åˆ é™¤ï¼Œ imap ä¹Ÿæ— æ³•ç½®ä¸º0ï¼Œç»“æœå°±æ˜¯æ–‡ä»¶çœ‹ç€æ²¡äº†ï¼Œä½†æ˜¯ç©ºé—´è¿˜æ˜¯æ²¡æœ‰é‡Šæ”¾ã€‚</p><hr><p>df å’Œ du çš„æœ€å¤§åŒºåˆ«å°±æ˜¯ï¼š</p><p>df æ˜¯æ ¹æ® inode çš„ Links æ¥ç¡®è®¤ç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œå¹¶è¿›è€Œç»Ÿè®¡</p><p>du æ˜¯æ ¹æ®ç›®å½•çš„æ–‡ä»¶ä¿¡æ¯æ¥ç¡®è®¤ç©ºé—´æ˜¯å¦è¢«å ç”¨ï¼Œå¹¶è¿›è€Œç»Ÿè®¡</p><ul><li><h3 id="å¦‚ä½•é‡Šæ”¾è¢«å ç”¨çš„ç©ºé—´">å¦‚ä½•é‡Šæ”¾è¢«å ç”¨çš„ç©ºé—´</h3></li></ul><p>ä»ä¸Šé¢å¯çŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¢«åˆ é™¤æ–‡ä»¶çš„ inode Links é™æˆ 0 å³å¯ï¼Œä¹Ÿå°±æ˜¯å…³é—­æ­¤æ–‡ä»¶çš„è°ƒç”¨ç¨‹åº.</p><p>å¦‚ä½•æŸ¥æ‰¾è°ƒç”¨ç¨‹åºï¼Ÿ</p><pre><code class="language-bash">lsof -n | grep rm_file_name # è·å–åˆ°ç¨‹åº pidï¼Œå¹¶å°†å…¶æ€æ­»å³å¯</code></pre>]]></content>
      
      
      <categories>
          
          <category> ç³»ç»Ÿ </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansibleâ˜playbook-lookupæ’ä»¶</title>
      <link href="posts/25732c33/"/>
      <url>posts/25732c33/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>lookup æ’ä»¶å¯ä»¥é…åˆ loop å¾ªç¯å®ç° with_x å¾ªç¯</p><h2 id="lookup-æŸ¥è¯¢æ’ä»¶">lookup æŸ¥è¯¢æ’ä»¶</h2><blockquote><p>query æ’ä»¶ä¸ lookup æ’ä»¶ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äº query é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ç”¨äº†wantlist=trueã€‚<br>wantlist çš„æ„æ€æ˜¯å°†è¿”å›çš„å­—ç¬¦ä¸²æ„æˆä¸€ä¸ªåˆ—è¡¨<br>å¦å¤–ï¼Œquery å¯ä»¥ç®€å†™ä¸ºq</p></blockquote><h5 id="loop-å…³é”®è¯">loop å…³é”®è¯</h5><p>ç”¨äºå°†ä¸€ä¸ªåˆ—è¡¨è¿›è¡Œå¾ªç¯ï¼Œé»˜è®¤å¾ªç¯å•ä½“å˜é‡æ˜¯ item. å®˜æ–¹ç”¨æ¥æ›¿ä»£ with_xxx</p><p>ç”¨æ¥éå† lookup ç»“æœé›†</p><blockquote><p>è‡ªå®šä¹‰loopå¾ªç¯å•ä½“å˜é‡ä¸º xxx</p><pre><code class="language-yaml">loop_control:  loop_var: xxx</code></pre><p>loop_control è¿˜æœ‰å…¶å®ƒæ§åˆ¶ï¼Œæ¯”å¦‚</p><ul><li>index_var: var_name å¾ªç¯ç´¢å¼•.</li><li>pause: time å¾ªç¯é—´éš”æ—¶é—´</li><li>label: var_name å»æ‰ var_name ä¹‹å¤–çš„ä¸ç›¸å¹²ä¿¡æ¯è¾“å‡º</li></ul></blockquote><h2 id="å¸¸ç”¨å‚æ•°ç¤ºä¾‹">å¸¸ç”¨å‚æ•°ç¤ºä¾‹</h2><h4 id="file-å‚æ•°">file å‚æ•°</h4><blockquote><p>å¤šä¸ªæ–‡ä»¶å†…å®¹åˆå¹¶åœ¨ä¸€èµ·ï¼Œæˆ–ä»¥å­—ç¬¦ä¸²é€—å·åˆ†éš”è¾“å‡ºï¼Œæˆ–ä»¥åˆ—è¡¨å½¢å¼è¾“å‡º</p></blockquote><h4 id="ini-å‚æ•°">ini å‚æ•°</h4><blockquote><p>è·å– ini é…ç½®ä¿¡æ¯</p></blockquote><pre><code class="language-ini"># ~/test.ini[testA]a1=zhangsana2=lisi[testB]b1=wangwu</code></pre><pre><code class="language-yaml">---- hosts: localhost  gather_facts: no  remote_user: zyh  tasks:    - name: get ini      debug:        msg: &quot;&#123;&#123; q('ini', 'a1 section=testA file=~/test.ini') &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; &#123;    &quot;msg&quot;: [        &quot;zhangsan&quot;    ]&#125;</code></pre><blockquote><p>å½“é…ç½®æ˜¯ propertiesï¼Œå¯ä»¥è¿½åŠ  type=properties</p></blockquote><h4 id="dictå‚æ•°">dictå‚æ•°</h4><pre><code class="language-bash"># ç»“æœé›† [&#123;key: xxx, value: xxx&#125;, &#123;key: xxx, value: xxx&#125;]</code></pre><pre><code class="language-yaml">---- hosts: local  gather_facts: no  connection: local  vars:    users:      male: Bob      female: Maris  tasks:    - name: test vars 1      debug:        msg: &quot;&#123;&#123; item.key &#125;&#125;: &#123;&#123; item.value &#125;&#125;&quot;      loop: &quot;&#123;&#123; lookup('dict', users) &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; (item=&#123;'key': u'male', 'value': u'Bob'&#125;) =&gt; &#123;    &quot;msg&quot;: &quot;male: Bob&quot;&#125;ok: [localhost] =&gt; (item=&#123;'key': u'female', 'value': u'Maris'&#125;) =&gt; &#123;    &quot;msg&quot;: &quot;female: Maris&quot;&#125;</code></pre><h4 id="subelementså‚æ•°">subelementså‚æ•°</h4><pre><code class="language-bash"># å†™æ³•ï¼š&#123;&#123; lookup('subelements',list,'content') &#125;&#125;# ä¸€ä¸ªç”±ç›¸åŒç»“æ„å­—å…¸ç»„æˆçš„åˆ—è¡¨listï¼Œå°†å­—å…¸ä¸­æŸä¸€ä¸ªå…ƒç´ keyï¼ˆå€¼å¿…é¡»æ˜¯åˆ—è¡¨ï¼‰ä¸å­—å…¸å‰©ä½™çš„å…ƒç´ ï¼ˆå‰©ä½™çš„å…ƒç´ ä½œä¸ºä¸€ä¸ªæ•´ä½“æ–°å­—å…¸ï¼‰ï¼Œæ„å»ºç¬›å¡å°”ç§¯ã€‚ä»è€Œå½¢æˆ itemã€‚æ¯ä¸€ä¸ªå­—å…¸æ‹†åˆ†ç»„åˆåçš„ item æ„å»ºç»“æœé›† items# ç»“æœé›†items=[[&#123;list.0.å‰©ä½™kv&#125;,  list.0.key.0], [&#123;list.0.å‰©ä½™kv&#125;,  list.0.key.1], [&#123;list.1.å‰©ä½™kv&#125;,  list.1.key.0], [&#123;list.1.å‰©ä½™kv&#125;,  list.1.key.1], ]</code></pre><pre><code class="language-yaml">---- hosts: local  gather_facts: no  connection: local  vars:          users:                  - name: Bob                    gender: male                    age: 18                    content:                            - eating                            - sleeping                            - play ogre                  - name: Maris                    gender: female                    age: 20                    content:                            - eating                            - sleeping                            - shopping  tasks:          - name: test vars 2            debug:                    msg: &quot;&#123;&#123; item.0.name &#125;&#125; - &#123;&#123; item.0.gender &#125;&#125; - &#123;&#123; item.1 &#125;&#125;&quot;            loop: &quot;&#123;&#123; lookup('subelements',users,'content') &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; (item=[&#123;u'gender': u'male', u'age': 18, u'name': u'Bob'&#125;, u'eating']) =&gt; &#123;    &quot;msg&quot;: &quot;Bob - male - eating&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'male', u'age': 18, u'name': u'Bob'&#125;, u'sleeping']) =&gt; &#123;    &quot;msg&quot;: &quot;Bob - male - sleeping&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'male', u'age': 18, u'name': u'Bob'&#125;, u'play ogre']) =&gt; &#123;    &quot;msg&quot;: &quot;Bob - male - play ogre&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'female', u'age': 20, u'name': u'Maris'&#125;, u'eating']) =&gt; &#123;    &quot;msg&quot;: &quot;Maris - female - eating&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'female', u'age': 20, u'name': u'Maris'&#125;, u'sleeping']) =&gt; &#123;    &quot;msg&quot;: &quot;Maris - female - sleeping&quot;&#125;ok: [localhost] =&gt; (item=[&#123;u'gender': u'female', u'age': 20, u'name': u'Maris'&#125;, u'shopping']) =&gt; &#123;    &quot;msg&quot;: &quot;Maris - female - shopping&quot;&#125;</code></pre><blockquote><p>è‹¥æœ‰å¤šä¸ªkeyéœ€è¦é™„åŠ ï¼Œéœ€è¦ nested ä¸  include_tasks çš„ç»„åˆå®ç°</p></blockquote><h4 id="nestedå‚æ•°">nestedå‚æ•°</h4><blockquote><p>å°†å¤šä¸ªåˆ—è¡¨è¿›è¡Œç¬›å¡å°”ç§¯è¿ç®—</p><ol><li>test3.yml ä¸­æ‹¿åˆ° userså¾ªç¯å•ä½“ user</li><li>é’ˆå¯¹å¾ªç¯å•ä½“ userå¼•å…¥é™„åŠ ä»»åŠ¡ test3_1.yml</li><li>é€šè¿‡lookupæ’ä»¶nestedï¼Œå°† userå­—å…¸ä¸­å„keyçš„valueç›¸äº’éå†ï¼Œæ„å»ºæ–°åˆ—è¡¨ item</li></ol></blockquote><pre><code class="language-yaml">################ test3.yml---- hosts: local  gather_facts: no  connection: local  vars:          users:                  - name: Bob                    gender: male                           age: 18                    content:                            - eating                               - sleeping                             - play ogre                    specialty:                            - english                              - game                       - name: Maris                            gender: female                         age: 20                    content:                            - eating                               - sleeping                             - shopping                     specialty:                            - history                              - cooking    tasks:          - include_tasks: test3_1.yml             loop: &quot;&#123;&#123; users &#125;&#125;&quot;            loop_control:                    loop_var: user ################ test3_1.yml- loop: &quot;&#123;&#123; lookup('nested',user.name, user.age, user.content, user.specialty) &#125;&#125;&quot;  debug:    msg: &quot;name:&#123;&#123; item.0 &#125;&#125;, age:&#123;&#123; item.1 &#125;&#125;, &#123;&#123; item.2 &#125;&#125;, &#123;&#123; item.3 &#125;&#125;&quot;</code></pre><pre><code class="language-bash">ok: [localhost] =&gt; (item=[u'Bob', 18, u'eating', u'english']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, eating, english&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'eating', u'game']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, eating, game&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'sleeping', u'english']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, sleeping, english&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'sleeping', u'game']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, sleeping, game&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'play ogre', u'english']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, play ogre, english&quot;&#125;ok: [localhost] =&gt; (item=[u'Bob', 18, u'play ogre', u'game']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Bob, age:18, play ogre, game&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'eating', u'history']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, eating, history&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'eating', u'cooking']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, eating, cooking&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'sleeping', u'history']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, sleeping, history&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'sleeping', u'cooking']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, sleeping, cooking&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'shopping', u'history']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, shopping, history&quot;&#125;ok: [localhost] =&gt; (item=[u'Maris', 20, u'shopping', u'cooking']) =&gt; &#123;    &quot;msg&quot;: &quot;name:Maris, age:20, shopping, cooking&quot;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> è‡ªåŠ¨åŒ– </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
            <tag> lookup </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
