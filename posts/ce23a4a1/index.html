<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	
	<!-- title -->
	
	<title>
	
		k8s☞19日志系统EFK | 
	 
	zyh
	</title>
	
	<!-- keywords,description -->
	 

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.ico">
	


	<!-- search -->
	<script>
		var searchEngine = "https://www.google.com/search?q=";
		if(typeof searchEngine == "undefined" || searchEngine == null || searchEngine == ""){
			searchEngine = "https://www.google.com/search?q=";
		}
		var homeHost = "zyh.cool";
		if(typeof homeHost == "undefined" || homeHost == null || homeHost == ""){
			homeHost = window.location.host;
		}
	</script>


	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">


	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>

	
		
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

		
<script src="https://cdn.jsdelivr.net/npm/valine@v1.4.14/dist/Valine.min.js"></script>

	
	
		<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
	<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d8eaf4579517c8bea955331f62e2b380";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


<header id="header">
    <a id="title" href="/" class="logo">zyh</a>

	<ul id="menu">
		<li class="menu-item">
			<a href="/about" class="menu-item-link">ABOUT</a>
		</li>
	
		<li class="menu-item">
			<a href="/tags" class="menu-item-link">标签</a>
		</li>
	

	
		<li class="menu-item">
			<a href="/categories" class="menu-item-link">分类</a>
		</li>
	
		<li class="menu-item">
			<a href="https://github.com/Spinestars" class="menu-item-link" target="_blank">
				<i class="fa fa-github fa-2x"></i>
			</a>
		</li>
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="search" placeholder="按回车全站搜索">
		<div id="tree">
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										web
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										fpm
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/b73a61bf/">
                     
										    fpm☞安装-包管理方式
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3321a2dc/">
                     
										    fpm☞安装-编译方式
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d1d65c30/">
                     
										    fpm☞静态配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										nginx
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/2722921e/">
                     
										    nginx-常用变量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/58a1c0c7/">
                     
										    nginx☞fcgi中alias的使用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4c513678/">
                     
										    nginx☞location
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/18de0eed/">
                     
										    nginx☞基本认证
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6209085/">
                     
										    nginx☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9fb0f3a1/">
                     
										    nginx☞日志切割
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/78ceb386/">
                     
										    nginx☞泛域名_变量截取
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6332ca50/">
                     
										    nginx☞问题集
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/7c44c2e8/">
                     
										    web☞服务器承载能力计算
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										公有云
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										aws
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/2e07203a/">
                     
										    aws☞EC2-GPU实例安装显卡驱动
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/438aa722/">
                     
										    aws☞rds-mysql参数
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/604c5952/">
                     
										    aws☞rds-mysql日志
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2c5a64ff/">
                     
										    aws☞s3初始化创建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7cac5d21/">
                     
										    aws☞s3跨账户访问
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ddc4c969/">
                     
										    aws☞利用cf服务初始化aws环境
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2e304ad6/">
                     
										    aws☞国内外之间迁移-AMI
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										阿里云
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/bd60be5f/">
                     
										    aliyun-ack_ingress
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6723fbb4/">
                     
										    aliyun-k8s_svc绑定固定ELB
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6df9bb76/">
                     
										    aliyun☞cli安装和基本调用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b5d7d6ee/">
                     
										    aliyun☞oss
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4cc38acc/">
                     
										    aliyun☞常见问题
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										git
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/a38d0013/">
                     
										    gitlab☞大版本迁移
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3f38f454/">
                     
										    gitlab☞安装及备份
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5edc3545/">
                     
										    gitlab☞批量修改用户密码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f0c6f6c3/">
                     
										    git☞常用命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										hexo
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/662e9d4d/">
                     
										    hexo☞图片显示404错误的解决办法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f5c218d/">
                     
										    hexo☞本地搜索
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a4903823/">
                     
										    jira-备份文档
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7c1abbe1/">
                     
										    openvpn☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/894f9595/">
                     
										    vsftpd☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3827a60a/">
                     
										    工具库
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/248f8ccf/">
                     
										    开发-认证机制[转载]
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/40d986c3/">
                     
										    网络-SNAT和DNAT
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f68976bc/">
                     
										    网络-华为路由器vlan划分
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5290b79d/">
                     
										    网络☞S5700配置攻击朔源
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6f53a6b8/">
                     
										    网络☞链路聚合
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1ddb9d4e/">
                     
										    问题记录
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										容器
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										docker
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/cdd230fc/">
                     
										    docker-多阶段构建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/634b48fb/">
                     
										    docker-常用的指令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b7cf7b1f/">
                     
										    docker☞01安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/604e367f/">
                     
										    docker☞非root用户执行程序
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										harbor
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/9573a87d/">
                     
										    harbor☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										helm
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/51015304/">
                     
										    helm☞01入门
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/710e3e49/">
                     
										    helm☞02chart
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										k8s
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/74e7acf4/">
                     
										    k8s-22自定义hpa
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/87e37b21/">
                     
										    k8s-安全上下文
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/aaf9b7/">
                     
										    k8s☞01常见术语概念
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c3c9f0f8/">
                     
										    k8s☞02-1切换使用runtime-containerd
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9602dad/">
                     
										    k8s☞02安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/94518966/">
                     
										    k8s☞03Pod
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3ec72f7e/">
                     
										    k8s☞04Pod-init容器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9aa66899/">
                     
										    k8s☞05容器生命周期-回调和探针
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/18e4fa73/">
                     
										    k8s☞06无状态服务deployment
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f6e328b5/">
                     
										    k8s☞07自动扩缩
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d3b80b5f/">
                     
										    k8s☞08负载均衡service
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1080c6b6/">
                     
										    k8s☞09存储资源
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4b0e4a5/">
                     
										    k8s☞10应用配置与密码与信息提供
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/64fa9c84/">
                     
										    k8s☞11-1pod资源约束
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ed4c29d5/">
                     
										    k8s☞11-2namespace资源约束
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/63d8d3d4/">
                     
										    k8s☞12-1DaemonSet
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4bf29cf0/">
                     
										    k8s☞12-2有状态服务StatefulSet
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5d39569c/">
                     
										    k8s☞13-1 ingress-nginx的各种用法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7627a41d/">
                     
										    k8s☞13高级版负载均衡ingress控制器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a5ed67a6/">
                     
										    k8s☞14认证授权
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/55da993d/">
                     
										    k8s☞15证书管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7538d100/">
                     
										    k8s☞16kubeadm集群升级
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/932d1f08/">
                     
										    k8s☞17-1调度之node污染和pod容忍
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4d69fc4a/">
                     
										    k8s☞17-2调度之亲和性和反亲和性
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/451721ed/">
                     
										    k8s☞18日志收集系统
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/posts/ce23a4a1/">
                     
										    k8s☞19日志系统EFK
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/68c615a7/">
                     
										    k8s☞20网络cni
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e902d670/">
                     
										    k8s☞21证书管理器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c15432fa/">
                     
										    k8s☞kubectl多集群管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/9a7bc037/">
                     
										    k8s☞showdoc部署
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/106410b0/">
                     
										    k8s☞常用命令记录
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e1096625/">
                     
										    k8s☞记录点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										数据库
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										mysql
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/a1d2702d/">
                     
										    mysql-主从同步
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d73c1236/">
                     
										    mysql-联合索引
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b824edd8/">
                     
										    mysql☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e6ae9474/">
                     
										    mysql☞常用命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c83ca575/">
                     
										    mysql☞离线迁移脚本
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										pgsql
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/684ab210/">
                     
										    pgsql-基础命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										redis
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/65ab632a/">
                     
										    redis-001安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2c2d50a0/">
                     
										    redis-002备份
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/28361833/">
                     
										    redis-003内存紧张bgsave失败
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/783b242a/">
                     
										    redis-004主从复制知识
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/847734cb/">
                     
										    redis-005主从复制和哨兵配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5067cdc/">
                     
										    redis-006获取没有设置TTL的key
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										日志
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										ELK
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/13e95dda/">
                     
										    日志-06Elasticsearch索引生命周期
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f8ca35d2/">
                     
										    日志☞00ELK基本使用-简介
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3475106c/">
                     
										    日志☞01ELK基本使用-beats组件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f73d84da/">
                     
										    日志☞02ELK基本使用-logstash组件01-安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/56da51f2/">
                     
										    日志☞03ELK基本使用-logstash组件02-插件介绍
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/41bf4066/">
                     
										    日志☞04ELK基本使用-elasticsearch
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d8390732/">
                     
										    日志☞05ELK基本使用-kibana
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/421d605e/">
                     
										    日志☞logrotate安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										消息
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										kafka
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/9bd7430f/">
                     
										    001-kafka基本信息
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/bd4c8d1c/">
                     
										    002-kafka基本安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2fb0e26c/">
                     
										    003-kafka基本认证
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/14fdb3fd/">
                     
										    004-kafka用户配额
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/124a3d6d/">
                     
										    005-kafka基本维护
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1a545f72/">
                     
										    006-kafka基本监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/41d19ce/">
                     
										    007-kafka基本保活
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										rabbitmq
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/188d54be/">
                     
										    rabbitmq-集群相关概念
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b43013ef/">
                     
										    rabbitmq☞安装
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										监控
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										prometheus
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/e55f0a09/">
                     
										    prometheus-07k8s-coredns
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1bafff65/">
                     
										    prometheus-08k8s-node
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c6df585d/">
                     
										    prometheus-09windows_exporter
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/65820315/">
                     
										    prometheus☞01搭建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e172b6e2/">
                     
										    prometheus☞02外置prometheus监控k8s
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/bced4977/">
                     
										    prometheus☞03k8s内置部署
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/978d0c1d/">
                     
										    prometheus☞04redis监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6178b477/">
                     
										    prometheus☞05mysql监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7fd13722/">
                     
										    prometheus☞06rabbitmq监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										zabbix
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/3d20f83e/">
                     
										    zabbix☞WEB监控
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1587f6e8/">
                     
										    zabbix☞agent和proxy(yum)
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b35b5965/">
                     
										    zabbix☞nginx
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6c093771/">
                     
										    zabbix☞redis
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ed865d2f/">
                     
										    zabbix☞server安装注意事项
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/25f36846/">
                     
										    zabbix☞容器搭建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4ebbd3a8/">
                     
										    zabbix☞预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/ae41ae33/">
                     
										    监控☞monit
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/ab1247fb/">
                     
										    监控☞mysql慢sql预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8c33f887/">
                     
										    监控☞企业微信机器人
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f9b08c30/">
                     
										    监控☞微信预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1fac36d/">
                     
										    监控☞远程磁盘检测
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f8f9b4d0/">
                     
										    监控☞邮件预警
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										系统
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										linux
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/3dd05018/">
                     
										    linux-vim中文乱码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c3b69c28/">
                     
										    linux-添加ssh登陆限制
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/13364d65/">
                     
										    linux☞centos7重置root密码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a3dfc0e8/">
                     
										    linux☞df与du数据不一致的原因
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5db0cd07/">
                     
										    linux☞ssh-MFA自动登陆
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e4f7ce4c/">
                     
										    linux☞ubuntu20-04纯命令行网卡配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/7b3cf3d8/">
                     
										    linux☞使用expect自动登录ssh后远程会话不会跟随本地会话缩放的问题
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d2fed0bf/">
                     
										    linux☞利用acme-sh管理免费的ssl证书申请
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/cd32aa48/">
                     
										    linux☞时间
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f41d0763/">
                     
										    linux☞系统内核优化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a7611bc1/">
                     
										    linux☞软raid创建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3988a5f2/">
                     
										    linux☞输出个性化开机状态
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										windows
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/348cba53/">
                     
										    windows-wsl问题点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/22b82d75/">
                     
										    windows-包管理工具-scoop
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/88eb7b6/">
                     
										    windows☞win10迁移数据
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										自动化
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										ansible
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/15aa7d2e/">
                     
										    ansible☞playbook-aws
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b0929188/">
                     
										    ansible☞playbook-handle
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6ce01f58/">
                     
										    ansible☞playbook-include
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/25732c33/">
                     
										    ansible☞playbook-lookup插件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/960fc783/">
                     
										    ansible☞playbook-tags
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4235ddf4/">
                     
										    ansible☞playbook-变量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/14bc184e/">
                     
										    ansible☞playbook-循环
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/29683589/">
                     
										    ansible☞playbook-条件判断
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f43dca37/">
                     
										    ansible☞playbook-过滤器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/c4126d5a/">
                     
										    ansible☞playbook-错误捕获
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d3e413b7/">
                     
										    ansible☞基础信息
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1e274151/">
                     
										    ansible☞常用模块-命令调用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/4235ddf4/">
                     
										    ansible☞常用模块-文本文件操作
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/84eb900/">
                     
										    ansible☞常用模块-系统相关
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3d9b9ec1/">
                     
										    ansible☞常用模块-软件包管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/724fda19/">
                     
										    ansible☞模板
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/720afd15/">
                     
										    ansible☞角色
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										jenkins
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/9011aa7a/">
                     
										    jenkins-gitops-cd
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/eea0d6c7/">
                     
										    jenkins-gitops-ci
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e804084e/">
                     
										    jenkins-groovy基础
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/57e9683e/">
                     
										    jenkins-pipeline dsl 常用方法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/75dc22a9/">
                     
										    jenkins-常用插件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/67a8b607/">
                     
										    jenkins-构建工具集成
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/192a4f4c/">
                     
										    jenkins-示例1
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b7391a97/">
                     
										    jenkins-集成SonarQube
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2a5275e1/">
                     
										    jenkins-集成gitlab
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d9cdb70/">
                     
										    jenkins☞001安装和基本配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8a33e212/">
                     
										    jenkins☞002Pipelines
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/e4df8a4f/">
                     
										    jenkins☞003共享库
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3e0f2183/">
                     
										    jenkins☞从容器中访问宿主机docker命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3b5cd3e1/">
                     
										    jenkins☞基于k8s生成动态的Jenkins agent
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										虚拟化
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										vmware
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/eab024cf/">
                     
										    vcsa☞存储设备有vmfs分区，但数据存储丢失
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										语言
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										css
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/fa5680b3/">
                     
										    css☞背景图居中拉伸平铺
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										go
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/38c126f9/">
                     
										    go-013文件先读再覆盖写
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/0/">
                     
										    go-014并发和管道
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/83a93e23/">
                     
										    go-015自定义包
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/5086e20/">
                     
										    go-016并发
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/786ba9af/">
                     
										    go-017测试
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/717b7a86/">
                     
										    go-100遇到的点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/759b68d8/">
                     
										    go☞001变量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8c3e952e/">
                     
										    go☞002常量
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/1a034363/">
                     
										    go☞003运算符
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/8a6b5455/">
                     
										    go☞004控制流
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/98f86e16/">
                     
										    go☞005函数
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/318675c1/">
                     
										    go☞006函数-闭包
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/a705a91a/">
                     
										    go☞007结构
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/f8eb4b1b/">
                     
										    go☞008方法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/77a46e91/">
                     
										    go☞009接口
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/2dab3d00/">
                     
										    go☞010特殊控制流(defer panic recover)
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/336ec0ac/">
                     
										    go☞011错误处理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d1503f4a/">
                     
										    go☞012常用模块
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										java
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/ac6b3b36/">
                     
										    jdk☞安装和配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										jquery
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/5d527900/">
                     
										    jquery☞伪进度条
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										python
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/86059ffb/">
                     
										    django☞admin管理视图
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/dd4c9efa/">
                     
										    django☞restful简单使用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/26bd5165/">
                     
										    django☞日志
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/6a4df400/">
                     
										    django☞管理静态文件
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/3f8b5448/">
                     
										    django☞记忆点
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/d60c38c/">
                     
										    django☞验证码
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/58609f2b/">
                     
										    python-虚拟环境
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/876c5852/">
                     
										    python☞json
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										shell
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/f2de1fb/">
                     
										    shell-[[ ]]
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/241ce96c/">
                     
										    shell☞if判定
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/posts/b06f599c/">
                     
										    shell☞read嵌套
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										其它
									</a>
									
							<ul>
								<li class="file">
									<a href="/posts/1a0d1bbd/">
                     
										    正则表达式-修饰符
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
		</div>
	</div>
</div>

	<!-- 引入正文 -->
	<div id="content">
		<h1 id="article-title">
	k8s☞19日志系统EFK
</h1>
<div class="article-meta">
	
		<span>
			阅读量:<span id="/posts/ce23a4a1/" class="leancloud_visitors" data-flag-title="k8s☞19日志系统EFK"></span>
		</span>
	
	<span>zyh</span>
	<span>2021-08-13 10:50:20</span>
		<div id="article-categories">
    
		<span>Categories：</span>
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true">
                        <a href="/categories/容器/">容器</a>
                        </i>
                      
                        >
                      
                    </span>
                
            
                
                    <span>
                        <i class="fa fa-folder" aria-hidden="true">
                        <a href="/categories/容器/k8s/">k8s</a>
                        </i>
                      
                    </span>
                
            
    

    
		<span>Tags：</span>
            
                
                    <span>
                        <i class="fa fa-tag" aria-hidden="true">
                        <a href="/tags/安装/">安装</a>
                        </i>
                    </span>
                
            
                
                    <span>
                        <i class="fa fa-tag" aria-hidden="true">
                        <a href="/tags/k8s/">k8s</a>
                        </i>
                    </span>
                
            
                
                    <span>
                        <i class="fa fa-tag" aria-hidden="true">
                        <a href="/tags/EFK/">EFK</a>
                        </i>
                    </span>
                
            
    
		</div>

</div>

<div id="article-content">
	<h2 id="前言">前言</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch#running-efk-stack-in-production">kubernetes/cluster/addons/fluentd-elasticsearch at master · kubernetes/kubernetes (github.com)</a></p>
<p>EFK包含三个组件：</p>
<ol>
<li>fluentd 采集器。采集日志</li>
<li>elasticsearch 搜索引擎。处理日志</li>
<li>kibana 展示。展示日志</li>
</ol>
<h2 id="数据过程">数据过程:</h2>
<p>Pod日志 ☞ fluentd ☞ Elasticsearch ☞ Kibana</p>
<p>👙如果pod的日志是stdout和stderr，则日志的生命周期和pod的生命周期是一致的。fluentd无法采集到已经删除的pod的日志。</p>
<p>更加复杂和优化的数据流：</p>
<p>Fluentd+Kafka+Logstash+Elasticsearch+Kibana</p>
<h2 id="结构">结构</h2>
<p>集群模式，节点级收集器收集日志。</p>
<p>其结构图如下：</p>
<p><img src="/posts/ce23a4a1/image-20210813111558385.png" alt="image-20210813111558385"></p>
<h2 id="ES集群要求">ES集群要求</h2>
<p><img src="/posts/ce23a4a1/image-20220501214746600.png" alt="image-20220501214746600"></p>
<h2 id="安装步骤">安装步骤</h2>
<p>我们通过 helm 包管理器进行安装。其地址为：<a target="_blank" rel="noopener" href="https://artifacthub.io/">Artifact Hub</a></p>
<p>⚠️需要注意的是，elasticsearch和kibana版本要保持一致</p>
<h3 id="elasticsearch">elasticsearch</h3>
<h4 id="部署">部署</h4>
<h4 id="证书和授权密码">证书和授权密码</h4>
<p>ES 7以上默认启用X-PACK，而X-PACK的启用，需要证书授权</p>
<ol>
<li>生成证书文件</li>
</ol>
<pre><code class="language-bash">docker run --name elastic-certs -i -w /app elasticsearch:7.12.0 /bin/sh -c &quot;elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass '' \
&amp;&amp; elasticsearch-certutil cert --name security-master --dns security-master --ca /app/elastic-stack-ca.p12 --ca-pass '' --pass '' --out /app/elastic-certificates.p12&quot;
docker cp elastic-certs:/app/elastic-certificates.p12 . &amp;&amp; docker rm -f elastic-certs
openssl pkcs12 -nodes -passin pass:'' -in elastic-certificates.p12 -out elastic-certificate.pem
</code></pre>
<ol start="2">
<li>创建证书对象和集群密码</li>
</ol>
<pre><code class="language-bash">kubectl create secret -n logging generic elastic-certs --from-file=elastic-certificates.p12
kubectl create secret -n logging generic elastic-auth --from-literal=username=elastic --from-literal=password=ydzsio321
</code></pre>
<h4 id="安装ES集群">安装ES集群</h4>
<p><a target="_blank" rel="noopener" href="https://artifacthub.io/packages/helm/elastic/elasticsearch">https://artifacthub.io/packages/helm/elastic/elasticsearch</a></p>
<p>添加repo到本地，下载chart包到本地，并解压</p>
<pre><code class="language-bash">helm repo add elastic https://helm.elastic.co
helm repo update
helm fetch elastic/elasticsearch --version 7.12.0
tar xf elasticsearch*.tgz &amp;&amp; cd elasticsearch
</code></pre>
<p>这里安装ES的三个角色，分别是：</p>
<ul>
<li>master 负责集群间的管理工作</li>
<li>data 负责存储数据</li>
<li>client 负责代理 ElasticSearch Cluster 集群，负载均衡</li>
</ul>
<blockquote>
<p>关于角色的介绍：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#node-roles">Node | Elasticsearch Guide | Elastic</a></p>
</blockquote>
<p>自定义配置：<a target="_blank" rel="noopener" href="https://artifacthub.io/packages/helm/elastic/elasticsearch#configuration">https://artifacthub.io/packages/helm/elastic/elasticsearch#configuration</a></p>
<p>👙需要先配置 storageclass，假设这里的 storageclass 是 nfs-storage</p>
<ol>
<li>master 节点配置</li>
</ol>
<p>在 Chart 目录下面创建用于 Master 节点安装配置的 values 文件</p>
<pre><code class="language-yaml"># values-master.yaml
## 设置集群名称
clusterName: &quot;elasticsearch&quot;
## 设置节点名称
nodeGroup: &quot;master&quot;

## 设置角色
roles:
  master: &quot;true&quot;
  ingest: &quot;false&quot;
  data: &quot;false&quot;

# ============镜像配置============
## 指定镜像与镜像版本
image: &quot;elasticsearch&quot;
imageTag: &quot;7.12.0&quot;
## 副本数
replicas: 3

# ============资源配置============
## JVM 配置参数
esJavaOpts: &quot;-Xmx1g -Xms1g&quot;
## 部署资源配置(生成环境一定要设置大些)
resources:
  requests:
    cpu: &quot;2000m&quot;
    memory: &quot;2Gi&quot;
  limits:
    cpu: &quot;2000m&quot;
    memory: &quot;2Gi&quot;
## 数据持久卷配置
persistence:
  enabled: true
## 存储数据大小配置
volumeClaimTemplate:
  storageClassName: nfs-storage
  accessModes: [&quot;ReadWriteOnce&quot;]
  resources:
    requests:
      storage: 5Gi

# ============安全配置============
## 设置协议，可配置为 http、https
protocol: http
## 证书挂载配置，这里我们挂入上面创建的证书
secretMounts:
  - name: elastic-certs
    secretName: elastic-certs
    path: /usr/share/elasticsearch/config/certs

## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml
## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下
## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https
esConfig:
  elasticsearch.yml: |
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    xpack.security.transport.ssl.verification_mode: certificate
    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.enabled: true
    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件
extraEnvs:
  - name: ELASTIC_USERNAME
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: ELASTIC_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

# ============调度配置============
## 设置调度策略
## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上
## - soft：尽最大努力调度
antiAffinity: &quot;soft&quot;
tolerations:
  - operator: &quot;Exists&quot; ##容忍全部污点
</code></pre>
<ol start="2">
<li>data 节点配置</li>
</ol>
<pre><code class="language-yaml"># values-data.yaml
# ============设置集群名称============
## 设置集群名称
clusterName: &quot;elasticsearch&quot;
## 设置节点名称
nodeGroup: &quot;data&quot;
## 设置角色
roles:
  master: &quot;false&quot;
  ingest: &quot;true&quot;
  data: &quot;true&quot;

# ============镜像配置============
## 指定镜像与镜像版本
image: &quot;elasticsearch&quot;
imageTag: &quot;7.12.0&quot;
## 副本数(建议设置为3，我这里资源不足只用了1个副本)
replicas: 1

# ============资源配置============
## JVM 配置参数
esJavaOpts: &quot;-Xmx1g -Xms1g&quot;
## 部署资源配置(生成环境一定要设置大些)
resources:
  requests:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
  limits:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
## 数据持久卷配置
persistence:
  enabled: true
## 存储数据大小配置
volumeClaimTemplate:
  storageClassName: nfs-storage
  accessModes: [&quot;ReadWriteOnce&quot;]
  resources:
    requests:
      storage: 10Gi

# ============安全配置============
## 设置协议，可配置为 http、https
protocol: http
## 证书挂载配置，这里我们挂入上面创建的证书
secretMounts:
  - name: elastic-certs
    secretName: elastic-certs
    path: /usr/share/elasticsearch/config/certs
## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml
## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下
## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https
esConfig:
  elasticsearch.yml: |
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    xpack.security.transport.ssl.verification_mode: certificate
    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.enabled: true
    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件
extraEnvs:
  - name: ELASTIC_USERNAME
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: ELASTIC_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

# ============调度配置============
## 设置调度策略
## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上
## - soft：尽最大努力调度
antiAffinity: &quot;soft&quot;
## 容忍配置
tolerations:
  - operator: &quot;Exists&quot; ##容忍全部污点
</code></pre>
<ol start="3">
<li>client 节点配置</li>
</ol>
<pre><code class="language-yaml"># values-client.yaml
# ============设置集群名称============
## 设置集群名称
clusterName: &quot;elasticsearch&quot;
## 设置节点名称
nodeGroup: &quot;client&quot;
## 设置角色
roles:
  master: &quot;false&quot;
  ingest: &quot;false&quot;
  data: &quot;false&quot;

# ============镜像配置============
## 指定镜像与镜像版本
image: &quot;elasticsearch&quot;
imageTag: &quot;7.12.0&quot;
## 副本数
replicas: 1

# ============资源配置============
## JVM 配置参数
esJavaOpts: &quot;-Xmx1g -Xms1g&quot;
## 部署资源配置(生成环境一定要设置大些)
resources:
  requests:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
  limits:
    cpu: &quot;1000m&quot;
    memory: &quot;2Gi&quot;
## 数据持久卷配置
persistence:
  enabled: false

# ============安全配置============
## 设置协议，可配置为 http、https
protocol: http
## 证书挂载配置，这里我们挂入上面创建的证书
secretMounts:
  - name: elastic-certs
    secretName: elastic-certs
    path: /usr/share/elasticsearch/config/certs
## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml
## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下
## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https
esConfig:
  elasticsearch.yml: |
    xpack.security.enabled: true
    xpack.security.transport.ssl.enabled: true
    xpack.security.transport.ssl.verification_mode: certificate
    xpack.security.transport.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    xpack.security.transport.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.enabled: true
    # xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
    # xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12
## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件
extraEnvs:
  - name: ELASTIC_USERNAME
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: ELASTIC_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

# ============Service 配置============
service:
  type: NodePort
  nodePort: &quot;30200&quot;
</code></pre>
<ul>
<li>添加污点容忍，允许调度到master节点上。</li>
</ul>
<blockquote>
<p>正常情况下，你不应该让其调度到master节点上。</p>
</blockquote>
<pre><code class="language-yaml">tolerations:
  - key: &quot;role.kubernetes.io/master&quot;
    operator: &quot;Exists&quot;
    effect: &quot;NoSchedule&quot;
</code></pre>
<ul>
<li>开始安装</li>
</ul>
<pre><code class="language-bash">kubectl create ns logging
helm upgrade --install es-master -f values-master.yaml --namespace logging .
helm upgrade --install es-data -f values-data.yaml --namespace logging .
helm upgrade --install es-client -f values-client.yaml --namespace logging .
</code></pre>
<ul>
<li>校验</li>
</ul>
<pre><code class="language-bash">kubectl run cirros-$RANDOM  -it --rm --restart=Never --image=cirros -- curl --user elastic:ydzsio321 -H 'Content-Type: application/x-ndjson' http://10.96.105.164:9200/

&#123;
  &quot;name&quot; : &quot;elasticsearch-master-2&quot;,
  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,
  &quot;cluster_uuid&quot; : &quot;pihlND64SqKGge_RneVeFg&quot;,
  &quot;version&quot; : &#123;
    &quot;number&quot; : &quot;7.12.0&quot;,
    &quot;build_flavor&quot; : &quot;default&quot;,
    &quot;build_type&quot; : &quot;docker&quot;,
    &quot;build_hash&quot; : &quot;78722783c38caa25a70982b5b042074cde5d3b3a&quot;,
    &quot;build_date&quot; : &quot;2021-03-18T06:17:15.410153305Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;8.8.0&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;
  &#125;,
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
&#125;
</code></pre>
<h4 id="可能出现的问题">可能出现的问题</h4>
<pre><code class="language-bash"># kubectl describe pod elasticsearch-master-0 -n logging
Q: pod has unbound immediate PersistentVolumeClaims
A: 检查 pvc 状态。

Q: Insufficient cpu
A: cpu 资源不足，无法调度, 调低 cpu 资源的 request。
</code></pre>
<p>👙statefulset 资源在更新的时候，是倒叙更新，例如这里有三个es-master，则先更新 elasticsearch-master-2，所以在修正配置之后，应该优先观察 elasticsearch-master-2 的状态。</p>
<h3 id="kibana"><a target="_blank" rel="noopener" href="https://artifacthub.io/packages/helm/elastic/kibana/7.14.0">kibana</a></h3>
<h4 id="部署-2">部署</h4>
<p>下载chart包到本地，并解压</p>
<pre><code class="language-bash">helm pull elastic/kibana --untar --version 7.12.0
cd kibana
</code></pre>
<p>修改 values.yaml</p>
<pre><code class="language-yaml">---
elasticsearchHosts: &quot;http://elasticsearch-client:9200&quot;

replicas: 1

extraEnvs:
  - name: &quot;ELASTICSEARCH_USERNAME&quot;
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: username
  - name: &quot;ELASTICSEARCH_PASSWORD&quot;
    valueFrom:
      secretKeyRef:
        name: elastic-auth
        key: password

image: &quot;docker.elastic.co/kibana/kibana&quot;
imageTag: &quot;7.12.0&quot;
imagePullPolicy: &quot;IfNotPresent&quot;

resources:
  requests:
    cpu: &quot;256m&quot;
    memory: &quot;1Gi&quot;
  limits:
    cpu: &quot;500m&quot;
    memory: &quot;1Gi&quot;

protocol: http

serverHost: &quot;0.0.0.0&quot;

healthCheckPath: &quot;/app/kibana&quot;

podSecurityContext:
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
    - ALL
  # readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

httpPort: 5601

updateStrategy:
  type: &quot;Recreate&quot;

kibanaConfig:
  kibana.yml: |
    i18n.locale: &quot;zh-CN&quot;

service:
  type: NodePort
  port: 5601
  nodePort: &quot;30601&quot;
  httpPortName: http

ingress:
  enabled: false

readinessProbe:
  failureThreshold: 3
  initialDelaySeconds: 10
  periodSeconds: 10
  successThreshold: 3
  timeoutSeconds: 5
</code></pre>
<p>👙也可以将 svc 改为 LB 模式。</p>
<pre><code class="language-yaml">service:
  type: LoadBalancer
  loadBalancerIP: &quot;&quot;
  port: 5601
  nodePort: &quot;&quot;
  labels: &#123;&#125;
  annotations:
    &#123;&#125;
    # cloud.google.com/load-balancer-type: &quot;Internal&quot;
    # service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0
    #service.beta.kubernetes.io/azure-load-balancer-internal: &quot;true&quot;
    # service.beta.kubernetes.io/openstack-internal-load-balancer: &quot;true&quot;
    # service.beta.kubernetes.io/cce-load-balancer-internal-vpc: &quot;true&quot;
</code></pre>
<blockquote>
<p>根据你的环境修改，我这里环境用了metallb组件，用来模拟LB，所以annotations不需要添加任何注释</p>
</blockquote>
<p>启动</p>
<pre><code class="language-bash">helm upgrade --install kibana -f values.yaml --namespace logging .
</code></pre>
<h4 id="kibana-webui配置">kibana webui配置</h4>
<p>访问：<a target="_blank" rel="noopener" href="http://10.200.16.101:30601/">http://10.200.16.101:30601/</a></p>
<p>添加模式分区</p>
<p>路径：Stack Management-&gt;Index patterns</p>
<p>Index pattern name: <code>logstash*</code></p>
<p>Time field: <code>@timestamp</code></p>
<h3 id="fluentd"><a target="_blank" rel="noopener" href="https://artifacthub.io/packages/helm/kokuwa/fluentd-elasticsearch">fluentd</a></h3>
<p>官方文档：<a target="_blank" rel="noopener" href="http://docs.fluentd.org">docs.fluentd.org</a></p>
<p>👙td-agent 软件是一个官方RPM发行版</p>
<p>fluentd 主要运行步骤如下：</p>
<ul>
<li>首先 Fluentd 从多个日志源获取数据</li>
<li>结构化并且标记这些数据</li>
<li>然后根据匹配的标签将数据发送到多个目标服务去</li>
</ul>
<p><img src="/posts/ce23a4a1/image-20220501214725265.png" alt="image-20220501214725265"></p>
<h4 id="日志源配置¶">日志源配置<a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain2/logging/efk/#%E6%97%A5%E5%BF%97%E6%BA%90%E9%85%8D%E7%BD%AE">¶</a></h4>
<p>官方文档：<a target="_blank" rel="noopener" href="http://docs.fluentd.org/input">docs.fluentd.org/input</a></p>
<p>比如我们这里为了收集 Kubernetes 节点上的所有容器日志，就需要做如下的日志源配置：</p>
<pre><code>&lt;source&gt;
  @id fluentd-containers.log             # 日志源ID
  @type tail                             # Fluentd 内置的输入方式，通过 tail 插件不停地从源文件中获取新的日志。
  path /var/log/containers/*.log         # 挂载的服务器Docker容器日志地址
  pos_file /var/log/es-containers.log.pos # position 位置文件，记录fluent的读取位置
  tag raw.kubernetes.*                   # 设置日志标签, 在 fluent 的 filter 过滤配置中根据标签过滤日志
  read_from_head true                    # 从日志文件开头读取
  &lt;parse&gt;                                # 多行格式化成JSON
    @type multi_format                   # 使用 multi-format-parser 解析器插件
    &lt;pattern&gt;                            # 匹配配置段
      format json                        # JSON 解析器
      time_key time                      # 指定事件时间的时间字段
      time_format %Y-%m-%dT%H:%M:%S.%NZ  # 时间格式
    &lt;/pattern&gt;
    &lt;pattern&gt;                            # 多行日志匹配模式
      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
    &lt;/pattern&gt;
  &lt;/parse&gt;
&lt;/source&gt;
</code></pre>
<p>上面配置部分参数说明如下：</p>
<ul>
<li>id：表示引用该日志源的唯一标识符，该标识可用于进一步过滤和路由结构化日志数据</li>
<li>type：Fluentd 内置的指令，<code>tail</code> 表示 Fluentd 从上次读取的位置通过 tail 不断获取数据，另外一个是 <code>http</code> 表示通过一个 GET 请求来收集数据。</li>
<li>path：<code>tail</code> 类型下的特定参数，告诉 Fluentd 采集 <code>/var/log/containers</code> 目录下的所有日志，这是 docker 在 Kubernetes 节点上用来存储运行容器 stdout 输出日志数据的目录。</li>
<li>pos_file：检查点，如果 Fluentd 程序重新启动了，它将使用此文件中的位置来恢复日志数据收集。</li>
<li>tag：用来将日志源与目标或者过滤器匹配的自定义字符串，Fluentd 匹配源/目标标签来路由日志数据。</li>
</ul>
<h4 id="路由配置¶">路由配置<a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain2/logging/efk/#%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE">¶</a></h4>
<p>上面是日志源的配置，接下来看看如何将日志数据发送到 Elasticsearch：</p>
<pre><code>&lt;match **&gt;
  @id elasticsearch
  @type elasticsearch
  @log_level info
  include_tag_key true
  type_name fluentd
  host &quot;#&#123;ENV['OUTPUT_HOST']&#125;&quot;
  port &quot;#&#123;ENV['OUTPUT_PORT']&#125;&quot;
  logstash_format true
  &lt;buffer&gt;
    @type file
    path /var/log/fluentd-buffers/kubernetes.system.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size &quot;#&#123;ENV['OUTPUT_BUFFER_CHUNK_LIMIT']&#125;&quot;
    queue_limit_length &quot;#&#123;ENV['OUTPUT_BUFFER_QUEUE_LIMIT']&#125;&quot;
    overflow_action block
  &lt;/buffer&gt;
&lt;/match&gt;
</code></pre>
<ul>
<li>match：标识一个目标标签，后面是一个匹配日志源的正则表达式，我们这里想要捕获所有的日志并将它们发送给 Elasticsearch，所以需要配置成<code>**</code>。</li>
<li>id：目标的一个唯一标识符。</li>
<li>type：支持的输出插件标识符，我们这里要输出到 Elasticsearch，所以配置成 elasticsearch，这是 Fluentd 的一个内置插件。</li>
<li>log_level：指定要捕获的日志级别，我们这里配置成 <code>info</code>，表示任何该级别或者该级别以上（INFO、WARNING、ERROR）的日志都将被路由到 Elsasticsearch。</li>
<li>host/port：定义 Elasticsearch 的地址，也可以配置认证信息，我们的 Elasticsearch 不需要认证，所以这里直接指定 host 和 port 即可。</li>
<li>logstash_format：Elasticsearch 服务对日志数据构建反向索引进行搜索，将 logstash_format 设置为 <code>true</code>，Fluentd 将会以 logstash 格式来转发结构化的日志数据。</li>
<li>Buffer： Fluentd 允许在目标不可用时进行缓存，比如，如果网络出现故障或者 Elasticsearch 不可用的时候。缓冲区配置也有助于降低磁盘的 IO。</li>
</ul>
<h4 id="过滤¶">过滤<a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain2/logging/efk/#%E8%BF%87%E6%BB%A4">¶</a></h4>
<p>由于 Kubernetes 集群中应用太多，也还有很多历史数据，所以我们可以只将某些应用的日志进行收集，比如我们只采集具有 <code>logging=true</code> 这个 Label 标签的 Pod 日志，这个时候就需要使用 filter，如下所示：</p>
<pre><code># 删除无用的属性，将 remove_keys 指定的 key 从包含 raw.kubernetes.* 标签的日志中移除。
&lt;filter raw.kubernetes.**&gt;
  @type record_transformer
  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
&lt;/filter&gt;
# 只保留具有logging=true标签的Pod日志
&lt;filter raw.kubernetes.**&gt;
  @id filter_log
  @type grep
  &lt;regexp&gt;
    key $.kubernetes.labels.logging
    pattern ^true$
  &lt;/regexp&gt;
&lt;/filter&gt;
</code></pre>
<h4 id="部署-3">部署</h4>
<p>👙fluentd 输出到 es，需要 es 插件，因此应该选用包含 es 插件的 fluentd 镜像。</p>
<p>下载chart包到本地，并解压</p>
<pre><code class="language-bash">helm repo add kokuwa https://kokuwaio.github.io/helm-charts
helm search repo kokuwa/fluentd-elasticsearch -l
helm pull --untar kokuwa/fluentd-elasticsearch --version 11.14.0
cd fluentd-elasticsearch
</code></pre>
<ul>
<li>编辑 values.yaml</li>
</ul>
<ol>
<li>挂载日志文件到容器</li>
</ol>
<pre><code class="language-yaml">hostLogDir:
  varLog: /var/log
  #dockerContainers: /var/lib/docker/containers
  #dockerContainers: /export/docker-data-root/containers
  #dockerContainers: /var/log/containers
  libSystemdDir: /usr/lib64
</code></pre>
<p>👙 默认 fluentd 会在容器里访问 /var/log/containers/*.log ，但这个目录下其实是软连接，指向了 /var/log/pods/。</p>
<p>通过 varLog: /var/log 挂载后：</p>
<p>如果 cri 是 docker，则 /var/log/pods 会进一步软连接到  /var/lib/docker/containers 下，因为 /var/lib/docker/containers 并不在 /var/log 下。因此，需要额外挂载 dockerContainers: /var/lib/docker/containers 到容器里。</p>
<p>如果 cri 是 containerd，则 /var/log/pods 会直接写入实际文件。因此，这时候 dockerContainers: 无需挂载。但考虑到 helm charts 目前模板没有适配 containerd，因此依然填入 dockerContainers: /var/log/pods</p>
<ol start="2">
<li>修改 flentd 的输出配置，这里是 elasticsearch</li>
</ol>
<p>👙这里的配置，会在ES里创建 k8s-%Y.%M.%d 的索引，并存储所有收集的日志。</p>
<pre><code class="language-yaml">elasticsearch:
  auth:
    enabled: true
    user: elastic
    password: null
    existingSecret:
      name: elastic-auth
      key: password
  includeTagKey: true
  setOutputHostEnvVar: true
  # If setOutputHostEnvVar is false this value is ignored
  hosts: [&quot;elasticsearch-client:9200&quot;]
  indexName: &quot;fluentd&quot;
  # 索引前缀
  logstash:
    enabled: true
    prefix: &quot;k8s&quot;
    prefixSeparator: &quot;-&quot;
    dateformat: &quot;%Y.%m.%d&quot;
  # 自动创建生命周期策略, 默认是关闭
  ilm:
    enabled: false
    policy_id: logstash-policy
    policy: &#123;&#125;
      # example for ilm policy config
      # phases:
      #   hot:
      #     min_age: 0ms
      #     actions:
      #       rollover:
      #         max_age: 30d
      #         max_size: 20gb
      #       set_priority:
      #           priority: 100
      #   delete:
      #     min_age: 60d
      #     actions:
      #       delete:
    policies: &#123;&#125;
      # example for ilm policies config
      # ilm_policy_id1: &#123;&#125;
      # ilm_policy_id2: &#123;&#125;
    policy_overwrite: false
  # 自动创建索引模板, 默认是关闭
  template:
    enabled: false
    overwrite: false
    useLegacy: true
    name: fluentd-template
    file: fluentd-template.json
    content: |-
      &#123;
        &quot;index_patterns&quot;: [
            &quot;k8s-*&quot;
        ],
        &quot;settings&quot;: &#123;
            &quot;index&quot;: &#123;
                &quot;number_of_replicas&quot;: &quot;3&quot;
            &#125;
        &#125;
      &#125;
</code></pre>
<p>添加master节点的容忍，允许 fluentd 部署到 master 节点上</p>
<pre><code class="language-yaml">tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule
</code></pre>
<p>添加节点选择器，仅部署到需要搜集日志的节点上</p>
<pre><code class="language-yaml">nodeSelector:
  beta.kubernetes.io/fluentd-ds-ready: &quot;true&quot;
</code></pre>
<p>👙如果节点需要收集日志，则给节点打标签</p>
<pre><code class="language-bash">kubectl label nodes &lt;node_name&gt; beta.kubernetes.io/fluentd-ds-ready=true
</code></pre>
<p>开始安装，或者更新</p>
<pre><code class="language-bash">helm upgrade --install fluentd --namespace logging -f values.yaml .
</code></pre>
<h4 id="测试">测试</h4>
<p>👙默认情况下，这个 helm chart 的 template/configmap.yaml 里并没有过滤日志，可以在 configmap.yaml 中   <code>containers.input.conf: |-</code>  部分的最后加入下面的配置，从而通过给容器添加标签来决定是否收集容器日志。</p>
<p>这里的两段，分别是删除日志事件里的无用标签和只保留包含 <code>logging=&quot;true&quot;</code> 标签的pod日志。</p>
<pre><code class="language-yaml">    # 删除一些多余的属性
    &lt;filter kubernetes.**&gt;
      @type record_transformer
      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
    &lt;/filter&gt;

    # 只保留具有logging=true标签的Pod日志
    &lt;filter kubernetes.**&gt;
      @id filter_log
      @type grep
      &lt;regexp&gt;
        key $.kubernetes.labels.logging
        pattern ^true$
      &lt;/regexp&gt;
    &lt;/filter&gt;
    
    # 忽略 default 命名空间下的日志
    # 这里的 kubernetes.var.log.containers.*_default_* 依然是匹配日志事件中的 tag 字段标签
    &lt;match kubernetes.var.log.containers.*_default_*&gt;
      @type null
    &lt;/match&gt;
</code></pre>
<p>测试pod demo</p>
<p>👙这个demo会自动输出时间到 stdout</p>
<pre><code class="language-bash">2022-05-01T11:17:25.355158001+08:00 stdout F 131: Sun May  1 03:17:25 UTC 2022
2022-05-01T11:17:26.355906645+08:00 stdout F 132: Sun May  1 03:17:26 UTC 2022
2022-05-01T11:17:27.356902598+08:00 stdout F 133: Sun May  1 03:17:27 UTC 2022
2022-05-01T11:17:28.357654227+08:00 stdout F 134: Sun May  1 03:17:28 UTC 2022
2022-05-01T11:17:29.35856036+08:00 stdout F 135: Sun May  1 03:17:29 UTC 2022
2022-05-01T11:17:30.359381367+08:00 stdout F 136: Sun May  1 03:17:30 UTC 2022
</code></pre>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: counter
  labels:
    logging: &quot;true&quot; # 一定要具有该标签才会被采集
spec:
  containers:
    - name: count
      image: busybox
      args:
        [
          /bin/sh,
          -c,
          'i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 1; done',
        ]
</code></pre>
<h4 id="校验-elasticsearch">校验 elasticsearch</h4>
<p>确认 elasticsearch 是否接收到来自 fluentd 发送的数据</p>
<pre><code class="language-bash">kubectl run cirros-$RANDOM  -it --rm --restart=Never --image=cirros -- curl --user elastic:ydzsio321 -H 'Content-Type: application/x-ndjson' http://10.96.105.164:9200/_cat/indices | grep k8s
===
yellow open k8s-2022.05.01                  APoJ5ABzRn67xl72_x4zdQ 1 1     86     0 178.1kb 178.1kb
</code></pre>
<p><img src="/posts/ce23a4a1/image-20220501214656032.png" alt="image-20220501214656032"></p>
<h4 id="问题">问题</h4>
<pre><code class="language-bash">Q: fluentd 不停重启，Elasticsearch buffers found stuck longer than 300 seconds.
A: 
</code></pre>
<h2 id="其他-kibana-配置">其他 kibana 配置</h2>
<p>配置一个展示k8s error错误的图标</p>
<p><img src="/posts/ce23a4a1/image-20210814122316905.png" alt="image-20210814122316905"></p>
<p><img src="/posts/ce23a4a1/image-20210814122130824.png" alt="image-20210814122130824"></p>
<h2 id="加入kafka">加入kafka</h2>
<h3 id="部署-4">部署</h3>
<pre><code class="language-bash">helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

helm pull bitnami/kafka --untar --version 12.17.5
cd kafka
</code></pre>
<p>配置文件 values-prod.yaml</p>
<pre><code class="language-yaml"># values-prod.yaml
## Persistence parameters
##
persistence:
  enabled: true
  storageClass: &quot;nfs-client&quot;
  accessModes:
    - ReadWriteOnce
  size: 5Gi
  ## Mount point for persistence
  mountPath: /bitnami/kafka

# 配置zk volumes
zookeeper:
  enabled: true
  persistence:
    enabled: true
    storageClass: &quot;nfs-client&quot;
    accessModes:
      - ReadWriteOnce
    size: 8Gi
</code></pre>
<p>启动</p>
<pre><code class="language-bash">helm upgrade --install kafka -f values-prod.yaml --namespace logging .
</code></pre>
<h3 id="校验kafka">校验kafka</h3>
<pre><code class="language-bash">kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:2.8.0-debian-10-r0 --namespace logging --command -- sleep infinity
pod/kafka-client created

# 生产者
$ kubectl exec --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-producer.sh --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 --topic test
&gt;hello kafka on k8s

# 消费者
$ kubectl exec --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic test --from-beginning
hello kafka on k8s
</code></pre>
<h2 id="fluentd添加kafka插件">fluentd添加kafka插件</h2>
<pre><code class="language-dockerfile">FROM quay.io/fluentd_elasticsearch/fluentd:v3.2.0
RUN echo &quot;source 'https://mirrors.tuna.tsinghua.edu.cn/rubygems/'&quot; &gt; Gemfile &amp;&amp; gem install bundler
RUN gem install fluent-plugin-kafka -v 0.16.1 --no-document
</code></pre>
<h3 id="配置fluentd，将output指向kafka">配置fluentd，将output指向kafka</h3>
<pre><code class="language-yaml"># fluentd-configmap.yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: fluentd-conf
  namespace: logging
data:
  ......
  output.conf: |-
    &lt;match **&gt;
      @id kafka
      @type kafka2
      @log_level info

      # list of seed brokers
      brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092
      use_event_time true

      # topic settings
      topic_key k8slog
      default_topic messages  # 注意，kafka中消费使用的是这个topic
      # buffer settings
      &lt;buffer k8slog&gt;
        @type file
        path /var/log/td-agent/buffer/td
        flush_interval 3s
      &lt;/buffer&gt;

      # data type settings
      &lt;format&gt;
        @type json
      &lt;/format&gt;

      # producer settings
      required_acks -1
      compression_codec gzip

    &lt;/match&gt;
</code></pre>
<h3 id="校验kafka是否有数据">校验kafka是否有数据</h3>
<pre><code class="language-bash">$ kubectl exec --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic messages --from-beginning
&#123;&quot;stream&quot;:&quot;stdout&quot;,&quot;docker&quot;:&#123;&#125;,&quot;kubernetes&quot;:&#123;&quot;container_name&quot;:&quot;count&quot;,&quot;namespace_name&quot;:&quot;default&quot;,&quot;pod_name&quot;:&quot;counter&quot;,&quot;container_image&quot;:&quot;busybox:latest&quot;,&quot;host&quot;:&quot;node1&quot;,&quot;labels&quot;:&#123;&quot;logging&quot;:&quot;true&quot;&#125;&#125;,&quot;message&quot;:&quot;43883: Tue Apr 27 12:16:30 UTC 2021\n&quot;&#125;
......
</code></pre>
<h2 id="加入logstash">加入logstash</h2>
<h3 id="部署-5">部署</h3>
<pre><code class="language-bash">helm pull elastic/logstash --untar --version 7.12.0
cd logstash
</code></pre>
<h3 id="配置">配置</h3>
<pre><code class="language-yaml"># values-prod.yaml
fullnameOverride: logstash

persistence:
  enabled: true

logstashConfig:
  logstash.yml: |
    http.host: 0.0.0.0
    # 如果启用了xpack，需要做如下配置
    xpack.monitoring.enabled: true
    xpack.monitoring.elasticsearch.hosts: [&quot;http://elasticsearch-client:9200&quot;]
    xpack.monitoring.elasticsearch.username: &quot;elastic&quot;
    xpack.monitoring.elasticsearch.password: &quot;ydzsio321&quot;

# 要注意下格式
logstashPipeline:
  logstash.conf: |
    input &#123; kafka &#123; bootstrap_servers =&gt; &quot;kafka-0.kafka-headless.logging.svc.cluster.local:9092&quot; codec =&gt; json consumer_threads =&gt; 3 topics =&gt; [&quot;messages&quot;] &#125; &#125;
    filter &#123;&#125;  # 过滤配置（比如可以删除key、添加geoip等等）
    output &#123; elasticsearch &#123; hosts =&gt; [ &quot;elasticsearch-client:9200&quot; ] user =&gt; &quot;elastic&quot; password =&gt; &quot;ydzsio321&quot; index =&gt; &quot;logstash-k8s-%&#123;+YYYY.MM.dd&#125;&quot; &#125; stdout &#123; codec =&gt; rubydebug &#125; &#125;

volumeClaimTemplate:
  accessModes: [&quot;ReadWriteOnce&quot;]
  storageClassName: nfs-storage
  resources:
    requests:
      storage: 1Gi
</code></pre>
<p>👙stdout { codec =&gt; rubydebug } 仅当测试中添加</p>
<p>启动</p>
<pre><code class="language-bash">$ helm upgrade --install logstash -f values-prod.yaml --namespace logging .
</code></pre>
<h3 id="校验">校验</h3>
<pre><code class="language-bash">kubectl logs -f logstash-0 -n logging
......
&#123;
&quot;docker&quot; =&gt; &#123;&#125;,
&quot;stream&quot; =&gt; &quot;stdout&quot;,
&quot;message&quot; =&gt; &quot;46921: Tue Apr 27 13:07:15 UTC 2021\n&quot;,
&quot;kubernetes&quot; =&gt; &#123;
            &quot;host&quot; =&gt; &quot;node1&quot;,
          &quot;labels&quot; =&gt; &#123;
    &quot;logging&quot; =&gt; &quot;true&quot;
&#125;,
        &quot;pod_name&quot; =&gt; &quot;counter&quot;,
&quot;container_image&quot; =&gt; &quot;busybox:latest&quot;,
  &quot;container_name&quot; =&gt; &quot;count&quot;,
  &quot;namespace_name&quot; =&gt; &quot;default&quot;
&#125;,
&quot;@timestamp&quot; =&gt; 2021-04-27T13:07:15.761Z,
&quot;@version&quot; =&gt; &quot;1&quot;
&#125;
</code></pre>
<h2 id="最终的工具栈">最终的工具栈</h2>
<p>Fluentd+Kafka+Logstash+Elasticsearch+Kibana</p>
<pre><code class="language-bash">$ kubectl get pods -n logging
NAME                            READY   STATUS    RESTARTS   AGE
elasticsearch-client-0          1/1     Running   0          128m
elasticsearch-data-0            1/1     Running   0          128m
elasticsearch-master-0          1/1     Running   0          128m
fluentd-6k52h                   1/1     Running   0          61m
fluentd-cw72c                   1/1     Running   0          61m
fluentd-dn4hs                   1/1     Running   0          61m
kafka-0                         1/1     Running   3          134m
kafka-client                    1/1     Running   0          125m
kafka-zookeeper-0               1/1     Running   0          134m
kibana-kibana-66f97964b-qqjgg   1/1     Running   0          128m
logstash-0                      1/1     Running   0          13m
</code></pre>

</div>


    <div class="post-guide">
        <div class="item left">
            
              <a href="/posts/68c615a7/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  k8s☞20网络cni
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/posts/634b48fb/">
                docker-常用的指令
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>



	<div id="vcomments"></div>


<script>
	
		// 评论
		new Valine({
			el: '#vcomments',
			appId: 'Sq2igagqhmGqvs3eHHtcNKiB-gzGzoHsz',
			appKey: 'cDTpqcpogeQq55SOuBHEXv9W',
			placeholder: '写点东西吧',
			path: window.location.pathname,
			avatar: 'retro',
			highlight: false,
      recordIP: true,
      enableQQ: true,
			requiredFields: ['nick','mail']
		})
	
	
    // 显示次数
		function showTime(Counter) {
			var query = new AV.Query("Counter");
			if($(".leancloud_visitors").length > 0){
				var url = $(".leancloud_visitors").attr('id').trim();
				// where field
				query.equalTo("words", url);
				// count
				query.count().then(function (number) {
					// There are number instances of MyClass where words equals url.
					$(document.getElementById(url)).text(number?  number : '--');
				}, function (error) {
					// error is an instance of AVError.
				});
			}
		}
		// 追加pv
		function addCount(Counter) {
			var url = $(".leancloud_visitors").length > 0 ? $(".leancloud_visitors").attr('id').trim() : 'wujun234.github.io';
			var Counter = AV.Object.extend("Counter");
			var query = new Counter;
			query.save({
				words: url
			}).then(function (object) {
			})
		}
		$(function () {
			var Counter = AV.Object.extend("Counter");
			addCount(Counter);
			showTime(Counter);
		});
	
</script>
	</div>
	<div id="footer">
	<p>
	©2016-<span id="footerYear"></span> 
	<a href="/">zyh</a> 
	
	
		|
		<span id="busuanzi_container_site_pv">
			pv
			<span id="busuanzi_value_site_pv"></span>
		</span>
		|
		<span id="busuanzi_container_site_uv"> 
			uv
			<span id="busuanzi_value_site_uv"></span>
		</span>
	
	<br>
	Theme <a href="//github.com/wujun234/hexo-theme-tree" target="_blank">Tree</a>
	by <a href="//github.com/wujun234" target="_blank">WuJun</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>
<script type="text/javascript"> 
	document.getElementById('footerYear').innerHTML = new Date().getFullYear() + '';
</script>
	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>